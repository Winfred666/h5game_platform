System.register([],(function(e,t){"use strict";return{execute:function(){function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function s(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function u(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach((function(t){a(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function h(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function f(e,t,i){return(f=_()?Reflect.construct:function(e,t,i){var n=[null];n.push.apply(n,t);var r=new(Function.bind.apply(e,n));return i&&c(r,i.prototype),r}).apply(null,arguments)}function d(e){var t="function"==typeof Map?new Map:void 0;return(d=function(e){if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return f(e,arguments,l(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),c(n,e)})(e)}function m(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?m(e):t}function v(e){var t=_();return function(){var i,n=l(e);if(t){var r=l(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return p(this,i)}}function y(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}function g(e,t,i){return(g="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=y(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function S(e,t,i,n){return(S="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,n){var r,s=y(e,t);if(s){if((r=Object.getOwnPropertyDescriptor(s,t)).set)return r.set.call(n,i),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(n,t)){if(!r.writable)return!1;r.value=i,Object.defineProperty(n,t,r)}else a(n,t,i);return!0})(e,t,i,n)}function A(e,t,i,n,r){if(!S(e,t,i,n||e)&&r)throw new Error("failed to set property");return i}function T(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var i=[],n=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);n=!0);}catch(e){r=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw s}}return i}}(e,t)||b(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(e){return function(e){if(Array.isArray(e))return C(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||b(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function b(e,t){if(e){if("string"==typeof e)return C(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?C(e,t):void 0}}function C(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function R(e,t){var i;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(i=b(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(i=e[Symbol.iterator]()).next.bind(i)}function x(e,t,i,n,r){var s={};return Object.keys(n).forEach((function(e){s[e]=n[e]})),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),s),r&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(r):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(e,t,s),s=null),s}function w(e,t){const i="undefined"==typeof window?global:window;return void 0===i[e]?i[e]=t:i[e]}e({BitMask:Rt,CCClass:Ci,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,EasingMethod:void 0,Enum:wt,Eventify:Uh,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,NodeEventType:void 0,NodeSpace:void 0,Overflow:void 0,Physics2DManifoldType:void 0,PhysicsGroup:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,TransformBit:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:cl,WorldNode3DToWorldNodeUI:_l,__checkObsoleteInNamespace__:function(e){return Ce||(Ce="undefined"==typeof Proxy?{}:new Proxy(e,{get:function(e,t,i){return we(t),Reflect.get(e,t,i)}})),Ce},__checkObsolete__:function(e){for(var t,i=R(e);!(t=i()).done;)we(t.value)},_resetDebugSetting:ee,absMax:Zi,absMaxComponent:Ji,applyMixins:function(e,t){t.forEach((function(t){Object.getOwnPropertyNames(t.prototype).forEach((function(i){"constructor"!==i&&Object.defineProperty(e.prototype,i,Object.getOwnPropertyDescriptor(t.prototype,i))}))}))},approx:Di,assert:Z,assertID:ce,assertIsNonNullable:function(){},assertIsTrue:function(){},assertsArrayIndex:xt,bezier:vu,bezierByTime:Ou,binarySearch:function(e,t){return xs(e,t,0)},binarySearchBy:function(e,t,i){for(var n=0,r=e.length-1,s=r>>>1;n<=r;s=n+r>>>1){var a=e[s];if(i(a,t)<0)r=s-1;else{if(!(i(a,t)>0))return s;n=s+1}}return~n},binarySearchEpsilon:xs,ccenum:Bt,clamp:Li,clamp01:Ni,color:_n,computeRatioByType:IQ,createDefaultPipeline:yN,debug:$,deprecateModuleExportedName:xe,deserialize:Bm,enumerableProps:$i,equals:Oi,error:J,errorID:ue,find:uD,flattenCodeArray:Il,formerlySerializedAs:Zs,fragmentText:HF,getBaselineOffset:function(){return 0},getEnglishWordPartAtFirst:VF,getEnglishWordPartAtLast:UF,getError:_e,getPathFromRoot:function(e,t){for(var i=e,n="";null!==i&&i!==t;)n="".concat(i.name,"/").concat(n),i=i.parent;return n.slice(0,-1)},getSerializationMetadata:function(e){return e[Qs]},getWorldTransformUntilRoot:function(e,t,i){for(Cn.identity(i);e!==t;)Cn.fromRTS(a$,e.rotation,e.position,e.scale),Cn.multiply(i,a$,i),e=e.parent;return i},instantiate:$$,inverseLerp:Qi,isCCClassOrFastDefined:Ri,isCCObject:Ua,isDisplayStats:fe,isEnglishWordPartAtFirst:function(e){return DF.test(e)},isEnglishWordPartAtLast:function(e){return OF.test(e)},isUnicodeCJK:LF,isUnicodeSpace:NF,isValid:Ha,lerp:Fi,log:K,logID:re,markAsWarning:void 0,mat4:wn,murmurhash2_32_gc:bl,nextPow2:qi,pingPong:Ki,pseudoRandom:Wi,pseudoRandomRange:Xi,pseudoRandomRangeInt:ji,quat:En,randomRange:Hi,randomRangeInt:zi,rect:Ln,removeProperty:void 0,repeat:Yi,replaceProperty:void 0,safeMeasureText:FF,sampleAnimationCurve:kQ,setDefaultLogTimes:function(e){e>0&&(Te=e)},setDisplayStats:de,shift:function(e,t,i){if(xt(e,t),xt(e,i),t===i)return e;var n=e[t];if(t<i)for(var r=t+1;r<=i;++r)e[r-1]=e[r];else for(var s=t;s!==i;--s)e[s]=e[s-1];return e[i]=n,e},size:On,toDegree:Vi,toRadian:Gi,tween:dee,tweenUtil:mee,v2:Bn,v3:on,v4:tn,warn:Q,warnID:ae}),w("CC_WECHAT",!1),w("CC_BAIDU",!1),w("CC_XIAOMI",!1),w("CC_ALIPAY",!1),w("CC_BYTEDANCE",!1),w("CC_OPPO",!1),w("CC_VIVO",!1),w("CC_HUAWEI",!1),w("CC_COCOSPLAY",!1),w("CC_QTT",!1),w("CC_LINKSURE",!1);const k=!1;w("CC_EDITOR",!1),w("CC_PREVIEW",!1),w("CC_BUILD",!0),w("CC_TEST",!1),w("CC_DEBUG",!1),w("CC_DEV",!1),w("CC_MINIGAME",!1),w("CC_RUNTIME_BASED",!1),w("CC_SUPPORT_JIT",!0),w("CC_JSB",!1);var I="undefined"==typeof window?global:window,B=e("cclegacy",{_global:I});B.internal={};var P=e("VERSION","3.7.2");I.CocosEngine=B.ENGINE_VERSION=P,I.cc=B;var M=void 0!==globalThis.jsb&&void 0!==jsb.window?jsb.window:globalThis;function O(e){var t,i;return t=(e>65535)<<4,t|=i=((e>>>=t)>255)<<3,t|=i=((e>>>=i)>15)<<2,(t|=i=((e>>>=i)>3)<<1)|(e>>>=i)>>1}function D(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24}function L(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function N(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}I.ccwindow=M;var F=new Array(256);!function(e){for(var t=0;t<256;++t){var i=t,n=t,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;e[t]=n<<r&255}}(F);var G=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(e){return(e>0)-(e<0)},abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:O,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:D,countTrailingZeros:L,nextPow2:N,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return F[255&e]<<24|F[e>>>8&255]<<16|F[e>>>16&255]<<8|F[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>L(e)+1}});e("bits",G);var V=M.document,U="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",H=null,z=console.log.bind(console),W=z,X=z,j=function(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: ".concat(Y.apply(void 0,[t].concat(n))))}},q=z;function Y(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return B.js.formatStr.apply(null,[e].concat(i))}function K(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return z.apply(void 0,[e].concat(i))}function Q(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return W.apply(void 0,[e].concat(i))}function J(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return X.apply(void 0,[e].concat(i))}function Z(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return j.apply(void 0,[e,t].concat(n))}function $(){return q.apply(void 0,arguments)}function ee(e){if(z=W=X=j=q=function(){},e!==he.NONE){if(e>he.ERROR){var t=function(e){if(B.game.canvas){if(!H){var t=V.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",B.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(H=V.createElement("textarea")).setAttribute("rows","20"),H.setAttribute("cols","30"),H.setAttribute("disabled","true");var n=H.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(H),B.game.canvas.parentNode.appendChild(t)}H.value="".concat(H.value+e,"\r\n"),H.scrollTop=H.scrollHeight}};X=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t("ERROR :  ".concat(Y.apply(void 0,[e].concat(n))))},j=function(e,i){if(!e){for(var n=arguments.length,r=new Array(n>2?n-2:0),s=2;s<n;s++)r[s-2]=arguments[s];t("ASSERT: ".concat(Y.apply(void 0,[i].concat(r))))}},e!==he.ERROR_FOR_WEB_PAGE&&(W=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t("WARN :  ".concat(Y.apply(void 0,[e].concat(n))))}),e===he.INFO_FOR_WEB_PAGE&&(z=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t(Y.apply(void 0,[e].concat(n)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),X=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},j=function(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var s=Y.apply(void 0,[t].concat(n));throw new Error(s)}});if(e!==he.ERROR&&(W=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e<=he.INFO&&(z=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))}),e<=he.VERBOSE&&"function"==typeof console.debug){var i=console.debug.bind(console);q=function(){return i.apply(void 0,arguments)}}}}function te(e){J(e.stack||e)}function ie(e){return function(t){for(var i="".concat(e," ").concat(t,", please go to ").concat(U,"#").concat(t," to see details."),n=arguments.length,r=new Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];return 0===r.length?i:"".concat(i," Arguments: ").concat(r.join(", "))}}var ne=ie("Log");function re(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];K(ne.apply(void 0,[e].concat(i)))}var se=ie("Warning");function ae(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];Q(se.apply(void 0,[e].concat(i)))}var oe=ie("Error");function ue(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];J(oe.apply(void 0,[e].concat(i)))}var he,le=ie("Assert");function ce(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];Z(!1,le.apply(void 0,[t].concat(n)))}}function _e(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return oe.apply(void 0,[e].concat(i))}function fe(){return!!B.profiler&&B.profiler.isShowingStats()}function de(e){B.profiler&&(e?B.profiler.showStats():B.profiler.hideStats())}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(he||(he=e("DebugMode",{})));var me,pe,ve,ye,ge,Se,Ae=Object.freeze({__proto__:null,log:K,warn:Q,error:J,assert:Z,debug:$,_resetDebugSetting:ee,_throw:te,logID:re,warnID:ae,errorID:ue,assertID:ce,get DebugMode(){return he},getError:_e,isDisplayStats:fe,setDisplayStats:de}),Te=10,Ee=0,be=new Map;ye=function(e,t,i,n,r,s,a){var o=be.get(s);o&&o.logTimes>o.count&&(r("'%s' is deprecated, please use '%s' instead. ".concat(a),"".concat(e,".").concat(t),"".concat(i,".").concat(n)),o.count++)},me=e("replaceProperty",(function(e,t,i){null!=e&&i.forEach((function(i){var n=Ee++;be.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:Te});var r=null!=i.target?i.target:e,s=null!=i.newName?i.newName:i.name,a=null!=i.targetName?i.targetName:t,o=r===e,u=i.suggest?"(".concat(i.suggest,")"):"";if(null!=i.customFunction)e[i.name]=function(){var e;return ye(t,i.name,a,s,Q,n,u),(e=i.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=i.customSetter||null!=i.customGetter){var h=null!=i.customSetter,l=null!=i.customGetter;h&&l?Object.defineProperty(e,i.name,{get:function(){return ye(t,i.name,a,s,Q,n,u),i.customGetter.call(this)},set:function(e){ye(t,i.name,a,s,Q,n,u),i.customSetter.call(this,e)},enumerable:!1}):h?Object.defineProperty(e,i.name,{set:function(e){ye(t,i.name,a,s,Q,n,u),i.customSetter.call(this,e)},enumerable:!1}):l&&Object.defineProperty(e,i.name,{get:function(){return ye(t,i.name,a,s,Q,n,u),i.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,i.name,{get:function(){return ye(t,i.name,a,s,Q,n,u),o?this[s]:r[s]},set:function(e){ye(t,i.name,a,s,Q,n,u),o?this[s]=e:r[s]=e},enumerable:!1})}))})),Se=function(e,t,i,n,r){var s=be.get(n);s&&s.logTimes>s.count&&(i("'%s' has been removed. ".concat(r),"".concat(e,".").concat(t)),s.count++)},pe=e("removeProperty",(function(e,t,i){null!=e&&i.forEach((function(i){var n=Ee++;be.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:Te});var r=i.suggest?"(".concat(i.suggest,")"):"";Object.defineProperty(e,i.name,{get:function(){return Se(t,i.name,J,n,r)},set:function(){Se(t,i.name,J,n,r)},enumerable:!1})}))})),ge=function(e,t,i,n,r){var s=be.get(n);s&&s.logTimes>s.count&&(i("'%s' is deprecated. ".concat(r),"".concat(e,".").concat(t)),s.count++)},ve=e("markAsWarning",(function(e,t,i){null!=e&&i.forEach((function(i){var n=i.name,r=Object.getOwnPropertyDescriptor(e,n);if(r&&r.configurable){var s=Ee++;be.set(s,{id:s,count:0,logTimes:void 0!==i.logTimes?i.logTimes:Te});var a=i.suggest?"(".concat(i.suggest,")"):"";if(void 0!==r.value)if("function"==typeof r.value){var o=r.value;e[n]=function(){return ge(t,n,Q,s,a),o.call.apply(o,[this].concat(Array.prototype.slice.call(arguments)))}}else{var u=r.value;Object.defineProperty(e,n,{configurable:!0,get:function(){return ge(t,n,Q,s,a),u}}),r.writable&&Object.defineProperty(e,n,{set:function(e){ge(t,n,Q,s,a),u=e}})}else!function(t,i,n,r,s,a){if(t.get){var o=t.get;t.get=function(){return ge(i,n,r,s,a),o.call(this)}}if(t.set){var u=t.set;t.set=function(e){ge(i,n,r,s,a),u.call(this,e)}}Object.defineProperty(e,n,t)}(r,t,n,Q,s,a);Object.defineProperty(e,n,{enumerable:!1})}}))}));var Ce,Re={};function xe(e){for(var t in e){var i=e[t];Re[t]=i}}function we(e){var t=Re[e];if(t){var i=t.newName,n=t.since;t.removed?i?ue(16003,e,n,i):ue(16002,e,n):i?ae(16001,e,n,i):ae(16e3,e,n)}}var ke=function(){function e(t){n(this,e),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return s(e,[{key:"getNewId",value:function(){return this.prefix+(++this.id).toString()}}]),e}();ke.global=new ke("global");var Ie=new ke("TmpCId."),Be="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),Pe="__cid__";function Me(e){return"number"==typeof e||e instanceof Number}function Oe(e){return"string"==typeof e||e instanceof String}function De(e){for(var t in e)return!1;return!0}var Le,Ne=(Le={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,i,n,r){Le.value=i,Le.writable=n,Le.enumerable=r,Object.defineProperty(e,t,Le),Le.value=void 0}),Fe=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,i,n,r){var s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof r&&(console.log("Set `setter` to boolean is deprecated. Please don not use like this again."),s=r,r=void 0),e.get=n,e.set=r,e.enumerable=s,e.configurable=a,Object.defineProperty(t,i,e),e.get=void 0,e.set=void 0}}(),Ge=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,i,n,r,s){e.get=n,e.enumerable=r,e.configurable=s,Object.defineProperty(t,i,e),e.get=void 0}}(),Ve=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,i,n,r,s){e.set=n,e.enumerable=r,e.configurable=s,Object.defineProperty(t,i,e),e.set=void 0}}();function Ue(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function He(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var n,r=e.toString();(n="["===r.charAt(0)?/\[\w+\s*(\w+)\]/.exec(r):/function\s*(\w+)/.exec(r))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}return e&&e.constructor?He(e.constructor):""}function ze(e,t,i,n){var r=/([^.]+)$/,s=r.exec(t)[0],a=r.exec(i)[0];function o(){return this[a]}n?Fe(e,s,o,(function(e){this[a]=e})):Ge(e,s,o)}function We(e,t,i,n){for(var r in i){var s=i[r];ze(e,"".concat(t,".").concat(r),s,n)}}var Xe=/(%d)|(%s)/,je=/%s/;function qe(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return"".concat(e);var r="string"==typeof e&&Xe.test(e);if(r)for(var s,a=R(i);!(s=a()).done;){var o=s.value,u="number"==typeof o?Xe:je;if(u.test(e)){var h="".concat(o);e=e.replace(u,h)}else e+=" ".concat(o)}else for(var l,c=R(i);!(l=c()).done;){var _=l.value;e+=" ".concat(_)}return e}function Ye(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function Ke(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function Qe(e,t,i){var n=Ke(t,e);n&&Object.defineProperty(i,e,n)}function Je(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var s=0,a=n;s<a.length;s++){var o=a[s];if(o){if("object"!==i(o)){ue(5402,o);continue}for(var u in o)u in e||Qe(u,o,e)}}return e}function Ze(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var s=0,a=n;s<a.length;s++){var o=a[s];if(o){if("object"!==i(o)){ue(5403,o);continue}for(var u in o)Qe(u,o,e)}}return e}function $e(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function et(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function tt(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=et(e)))return!1;if(e===t)return!0}}return!1}function it(e){for(var t=0,i=Object.keys(e);t<i.length;t++)delete e[i[t]]}var nt=Ue(!0),rt=Ue(!0);function st(e,t,i){return function(n,r){if(r.prototype.hasOwnProperty(e)&&delete t[r.prototype[e]],Ne(r.prototype,e,n),n){var s=t[n];!i&&s&&s!==r?J("A Class already exists with the same ".concat(e,' : "').concat(n,'".')):t[n]=r}}}var at=st("__cid__",nt,!1),ot=st("__classname__",rt,!0);function ut(e,t){if(ot(e,t),!t.prototype.hasOwnProperty(Pe)){var i=e||Ie.getNewId();i&&at(i,t)}}function ht(e,t){var i=rt[t],n=nt[t],r=!0;if(i&&i!==e&&(J('"'.concat(t,'" has already been set as name or alias of another class.')),r=!1),n&&n!==e&&(J('"'.concat(t,'" has already been set as id or alias of another class.')),r=!1),r){var s=e[Be];s||(s=[],e[Be]=s),s.push(t),rt[t]=e,nt[t]=e}}function lt(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var s=r[n],a=s.prototype,o=a.__cid__;o&&delete nt[o];var u=a.__classname__;u&&delete rt[u];var h=a[Be];if(h)for(var l=0;l<h.length;++l){var c=h[l];delete rt[c],delete nt[c]}}}function ct(e){return _t(e)}function _t(e){return nt[e]}function ft(e){return rt[e]}function dt(e,t){return mt(e,t)}function mt(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(Pe))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty(Pe))return e.__cid__}return""}var pt=function(){function e(t,i){n(this,e),this.count=void 0,this._pool=void 0,this._cleanup=void 0;var r=void 0===i?t:i,s=void 0===i?null:t;this.count=0,this._pool=new Array(r),this._cleanup=s}return s(e,[{key:"get",value:function(){return this._get()}},{key:"_get",value:function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),e}(),vt=function(){function e(t){n(this,e),this.i=0,this.array=t}return s(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}},{key:"remove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}}]),e}();function yt(e,t){e.splice(t,1)}function gt(e,t){var i=e.length;t<0||t>=i||(e[t]=e[i-1],e.length=i-1)}function St(e,t){var i=e.indexOf(t);return i>=0&&(yt(e,i),!0)}function At(e,t){var i=e.indexOf(t);i>=0&&(e[i]=e[e.length-1],--e.length)}function Tt(e,t){return e.indexOf(t)>=0}var Et=Object.freeze({__proto__:null,removeAt:yt,fastRemoveAt:gt,remove:St,fastRemove:At,removeIf:function(e,t){var i=e.findIndex(t);if(i>=0){var n=e[i];return yt(e,i),n}},verifyType:function(e,t){if(e&&e.length>0)for(var i,n=R(e);!(i=n()).done;)if(!(i.value instanceof t))return re(1300),!1;return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)St(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(E(t))),e},contains:Tt,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:vt}),bt={IDGenerator:ke,Pool:pt,array:Et,isNumber:Me,isString:Oe,isEmptyObject:De,getPropertyDescriptor:Ke,addon:Je,mixin:Ze,extend:$e,getSuper:et,isChildClassOf:tt,clear:it,value:Ne,getset:Fe,get:Ge,set:Ve,unregisterClass:lt,getClassName:He,setClassName:ut,setClassAlias:ht,getClassByName:ft,getClassById:_t,get _registeredClassNames(){return u({},rt)},set _registeredClassNames(e){it(rt),Object.assign(rt,e)},get _registeredClassIds(){return u({},nt)},set _registeredClassIds(e){it(nt),Object.assign(nt,e)},_getClassId:dt,getClassId:mt,_setClassId:at,_getClassById:ct,obsolete:ze,obsoletes:We,formatStr:qe,shiftArguments:Ye,createMap:Ue};B.js=bt;var Ct=Object.freeze({__proto__:null,array:Et,js:bt,IDGenerator:ke,Pool:pt,isNumber:Me,isString:Oe,isEmptyObject:De,value:Ne,getset:Fe,get:Ge,set:Ve,createMap:Ue,getClassName:He,obsolete:ze,obsoletes:We,formatStr:qe,shiftArguments:Ye,getPropertyDescriptor:Ke,copyAllProperties:function(e,t,i){for(var n=Object.getOwnPropertyNames(e),r=0,s=n.length;r<s;++r){var a=n[r];-1===i.indexOf(a)&&Qe(a,e,t)}},addon:Je,mixin:Ze,extend:$e,getSuper:et,isChildClassOf:tt,clear:it,_idToClass:nt,_nameToClass:rt,_setClassId:at,setClassName:ut,setClassAlias:ht,unregisterClass:lt,_getClassById:ct,getClassById:_t,getClassByName:ft,_getClassId:dt,getClassId:mt});function Rt(e){if("__bitmask__"in e)return e;Ne(e,"__bitmask__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],s=e[r];if(-1===s)s=++t,e[r]=s;else if("number"==typeof s)t=s;else if("string"==typeof s&&Number.isInteger(parseFloat(r)))continue;var a="".concat(s);r!==a&&Ne(e,a,r)}return e}function xt(e,t){t>=0&&e.length,"Array index ".concat(t," out of bounds: [0, ").concat(e.length,")")}function wt(e){return"__enums__"in e?e:(Ne(e,"__enums__",null,!0),wt.update(e))}function kt(e){e.hasOwnProperty("__enums__")}function It(e){kt(e);var t=e.__enums__||[];for(var i in t.length=0,e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function Bt(e){"__enums__"in e||Ne(e,"__enums__",null,!0)}e("js",Ct),Rt.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},Rt.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((function(e,t){return e.value-t.value})),t},B.BitMask=Rt,wt.update=function(e){for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],s=e[r];if(-1===s)s=++t,e[r]=s;else if("number"==typeof s)t=s;else if("string"==typeof s&&Number.isInteger(parseFloat(r)))continue;var a="".concat(s);r!==a&&Ne(e,a,r)}return Array.isArray(e.__enums__)&&It(e),e},wt||(wt=e("Enum",{})),wt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},wt.getList=function(e){return kt(e),e.__enums__?e.__enums__:It(e)},wt.sortList=function(e,t){kt(e),Array.isArray(e.__enums__)&&e.__enums__.sort(t)},B.Enum=wt;var Pt,Mt=e("ValueType",function(){function e(){n(this,e)}return s(e,[{key:"clone",value:function(){return ue(100,"".concat(He(this),".clone")),this}},{key:"equals",value:function(){return!1}},{key:"set",value:function(){ue(100,"".concat(He(this),".set"))}},{key:"toString",value:function(){return""}}]),e}());ut("cc.ValueType",Mt),B.ValueType=Mt,function(e){e.PATH="path",e.ENGINE="engine",e.ASSETS="assets",e.SCRIPTING="scripting",e.PHYSICS="physics",e.RENDERING="rendering",e.LAUNCH="launch",e.SCREEN="screen",e.SPLASH_SCREEN="splashScreen",e.ANIMATION="animation",e.PROFILING="profiling",e.PLUGINS="plugins",e.XR="xr"}(Pt||(Pt={}));var Ot=e("Settings",function(){function e(){n(this,e),this._settings={},this._override={}}return s(e,[{key:"init",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(var n in i){var r=i[n];if(r)for(var s in r)this.overrideSettings(n,s,r[s])}return t?new Promise((function(i,n){var r=new XMLHttpRequest;r.open("GET",t),r.responseType="text",r.onload=function(){e._settings=JSON.parse(r.response),i()},r.onerror=function(){n(new Error("request settings failed!"))},r.send(null)})):Promise.resolve()}},{key:"overrideSettings",value:function(e,t,i){e in this._override||(this._override[e]={}),this._override[e][t]=i}},{key:"querySettings",value:function(e,t){if(e in this._override){var i=this._override[e];if(i&&t in i)return i[t]}if(e in this._settings){var n=this._settings[e];if(n&&t in n)return n[t]}return null}}]),e}());Ot.Category=Pt;var Dt=e("settings",new Ot);B.settings=Dt;var Lt=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144,CUSTOM_PIPELINE_NAME:"",init:function(){var e=Dt.querySettings(Ot.Category.ENGINE,"macros");if(e)for(var t in e)Lt[t]=e[t]}});B.macro=Lt;for(var Nt=/^(?:cc|dragonBones|sp|ccsg)\..+/,Ft=new Array(123),Gt=0;Gt<123;++Gt)Ft[Gt]=64;for(var Vt=0;Vt<64;++Vt)Ft["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(Vt)]=Vt;var Ut=Ft;function Ht(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set);else{var s=e[i];Fe(e,t,s,e[n])}}for(var r,s=e.prototype,a=0;a<t.length;a++){var o=(r=t[a])[0].toUpperCase()+r.slice(1);n(s,r,"get".concat(o),"set".concat(o))}for(r in i){var u=i[r];n(s,r,u[0],u[1])}}function zt(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function Wt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function Xt(e){return"object"===("undefined"==typeof window?"undefined":i(window))&&"function"==typeof Node?e instanceof Node:!!e&&"object"===i(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function jt(e,t,i){e&&setTimeout((function(){e(t,i)}),0)}function qt(e){return!(!e||e.constructor!==Object)&&De(e)}function Yt(e,t,i){if(t>i){var n=t;t=i,i=n}return e<t?t:e<i?e:i}function Kt(e){return e*Lt.RAD}function Qt(e){return e*Lt.DEG}B.misc={BUILTIN_CLASSID_RE:Nt,BASE64_VALUES:Ut,propertyDefine:Ht,pushToMap:zt,contains:Wt,isDomNode:Xt,callInNextTick:jt,isPlainEmptyObj_DEV:qt,clampf:Yt,degreesToRadians:Kt,radiansToDegrees:Qt},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:Nt,BASE64_VALUES:Ut,propertyDefine:Ht,pushToMap:zt,contains:Wt,isDomNode:Xt,callInNextTick:jt,tryCatchFunctor_EDITOR:function(e){return Function("target","".concat("try {\n  target.").concat(e,"();\n")+"}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:qt,clampf:Yt,degreesToRadians:Kt,radiansToDegrees:Qt}));var Jt="$_$";function Zt(e,t){var i=t?Object.create(t):{};return Ne(e,"__attrs__",i),i}function $t(e){if("function"!=typeof e)return Zt(e,ti(e.constructor));for(var t,i=B.Class.getInheritanceChain(e),n=i.length-1;n>=0;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||Zt(r,(t=i[n+1])&&t.__attrs__)}return Zt(e,(t=i[0])&&t.__attrs__),e.__attrs__}function ei(e,t){var i=ti(e),n=t+Jt,r={};for(var s in i)s.startsWith(n)&&(r[s.slice(n.length)]=i[s]);return r}function ti(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||$t(e)}function ii(e,t,i,n){ti(e)[t+Jt+i]=n}var ni=function(){function e(t,i){n(this,e),this.name=void 0,this.default=void 0,this.name=t,this.default=i}return s(e,[{key:"toString",value:function(){return this.name}}]),e}(),ri=e("CCInteger",new ni("Integer",0));B.Integer=ri,B.CCInteger=ri;var si=e("CCFloat",new ni("Float",0));B.Float=si,B.CCFloat=si;var ai=e("CCBoolean",new ni("Boolean",!1));B.Boolean=ai,B.CCBoolean=ai;var oi=e("CCString",new ni("String",""));function ui(e,t){return function(n,r){var s='"'.concat(He(n),".").concat(r,'"'),a=ei(n,r),o=a.type;if(o===ri||o===si?o="Number":o!==oi&&o!==ai||(o="".concat(o)),o===e){if(a.hasOwnProperty("default")){var u=a.default;if(void 0!==u&&!Array.isArray(u)&&!qt(u)){var h=i(u),l=e.toLowerCase();if(h===l)if("object"===l){if(!u||u instanceof a.ctor)return;ae(3605,s,He(a.ctor))}else"Number"!==e&&ae(3606,t,s,e);else{if("function"===h)return;e===oi.default&&null==u?ae(3607,s):ae(3611,t,s,h)}delete a.type}}}else ae(3604,s)}}B.String=oi,B.CCString=oi;var hi=Object.freeze({__proto__:null,DELIMETER:Jt,createAttrsSingle:Zt,createAttrs:$t,attr:ei,getClassAttrs:ti,setClassAttr:ii,PrimitiveType:ni,CCInteger:ri,CCFloat:si,CCBoolean:ai,CCString:oi,getTypeChecker_ET:ui,getObjTypeChecker_ET:function(e){return function(t,i){ui("Object","type")(t,i);var n=ti(t)["".concat(i+Jt,"default")],r=B.Class.getDefault(n);if(!Array.isArray(r)&&tt(e,B.ValueType)){var s=He(e),a=qe('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',He(t),i,s);n?K(a):ae(3612,a,s,He(t),i,s)}}}}),li={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function ci(e,t,i,n){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$".concat(t);e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,i.call(this,t)};var s={};for(var a in n[r]=s,li){var o=li[a];e.hasOwnProperty(a)&&(s[a]=e[a],o.canUsedInGet||delete e[a])}}}function _i(e,t,i,n){if(Array.isArray(t)){if(!(t.length>0))return ue(5508,i,n);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=B.String:t===Boolean?e.type=B.Boolean:t===Number&&(e.type=B.Float))}function fi(e,t,i){var n=e?{_short:!0}:{_short:!0,default:t};return i&&(n.type=i),n}function di(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return fi(t,[],e);if("function"==typeof e){var i=e;return fi(t,tt(i,B.ValueType)?new i:null,i)}return fi(t,e instanceof ni?e.default:e)}return null}var mi,pi=[];function vi(){return pi[pi.length-1]}B._RF={push:function(e,t,i,n){void 0===i&&(i=t,t=""),pi.push({uuid:t,script:i,module:e,exports:e.exports,beh:null,importMeta:n})},pop:function(){var e=pi.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=i=e.cls}},peek:vi},function(e){e[e.STANDALONE=1]="STANDALONE",e[e.IMPLICIT_VISIBLE=2]="IMPLICIT_VISIBLE",e[e.IMPLICIT_SERIALIZABLE=4]="IMPLICIT_SERIALIZABLE"}(mi||(mi={}));var yi=Jt,gi="__ctors__",Si=e("ENUM_TAG","Enum"),Ai=e("BITMASK_TAG","BitMask");function Ti(e,t,i,n){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,i),wi(e,n,t,i)}function Ei(e,t,i,n){var r=n.get;n.set,r&&(wi(e,n,t,i),ii(e,i,"serializable",!1))}function bi(e){return"function"==typeof e?e():e}function Ci(e){var t=e.name,i=e.extends,n=function(e,t,i){var n=B.Component,r=vi();if(r&&tt(t,n)){if(tt(r.cls,n))return ue(3615),null;e=e||r.script}var s=function(e,t,i){var n=i.ctor;return Ne(n,gi,!0,!0),n.prototype,t&&(n.$super=t),ut(e,n),n}(e,t,i);if(r)if(tt(t,n)){var a=r.uuid;a&&at(a,s),r.cls=s}else tt(r.cls,n)||(r.cls=s);return s}(t,i,e);t||(t=B.js.getClassName(n)),n._sealed=!0,i&&(i._sealed=!1),function(e,t,i,n){if(e.__props__=[],n&&n.__props__&&(e.__props__=n.__props__.slice()),i)for(var r in function(e,t){for(var i in e){var n=e[i],r=di(n,!1);if(r&&(n=e[i]=r),n){var s=n.notify;s&&ci(n,i,s,e),"type"in n&&_i(n,n.type,t,i)}}}(i,t),i){var s=i[r];s.get||s.set?Ei(e,t,r,s):Ti(e,t,r,s)}var a=ti(e);e.__values__=e.__props__.filter((function(e){return!1!==a["".concat(e+yi,"serializable")]}))}(n,t,e.properties,i);var r=e.editor;return r&&tt(i,B.Component)&&B.Component._registerEditorProps(n,r),n}function Ri(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__values__")}Ci._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,gi)},Ci.fastDefine=function(e,t,i){ut(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=ti(t),s=0;s<n.length;s++){var a=n[s];r["".concat(a+yi,"visible")]=!1,r["".concat(a+yi,"default")]=i[a]}},Ci.Attr=hi,Ci.attr=ei,Ci.isCCClassOrFastDefined=Ri,Ci.getInheritanceChain=function(e){for(var t=[];e=et(e);)e!==Object&&t.push(e);return t};var xi={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function wi(e,t,n,r){var s=null,a="";function o(){return a=r+yi,s=ti(e)}"type"in t&&void 0===t.type&&ae(3660,r,n);var u=t.type;u&&(xi[u]?(s||o())["".concat(a,"type")]=u:"Object"===u||("object"===i(u)?wt.isEnum(u)?((s||o())["".concat(a,"type")]=Si,s["".concat(a,"enumList")]=wt.getList(u)):Rt.isBitMask(u)&&((s||o())["".concat(a,"type")]=Ai,s["".concat(a,"bitmaskList")]=Rt.getList(u)):"function"==typeof u&&((s||o())["".concat(a,"type")]="Object",s["".concat(a,"ctor")]=u))),"default"in t&&((s||o())["".concat(a,"default")]=t.default);var h,l=function(e,n){if(e in t){var r=t[e];i(r)===n&&((s||o())[a+e]=r)}};t.editorOnly&&((s||o())["".concat(a,"editorOnly")]=!0),t.__internalFlags&mi.STANDALONE?h=!0===t.serializable||0!=(t.__internalFlags&mi.IMPLICIT_SERIALIZABLE):!1===t.serializable&&(h=!1),void 0!==h&&((s||o())["".concat(a,"serializable")]=h),l("formerlySerializedAs","string");var c=t.range;c&&Array.isArray(c)&&c.length>=2&&((s||o())["".concat(a,"min")]=c[0],s["".concat(a,"max")]=c[1],c.length>2&&(s["".concat(a,"step")]=c[2])),l("min","number"),l("max","number"),l("step","number")}Ci.isArray=function(e){return e=bi(e),Array.isArray(e)},Ci.getDefault=bi,Ci.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Ci.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Ci.getNewValueTypeCode=function(e){for(var t=He(e),i=e.constructor,n="new ".concat(t,"("),r=0;r<i.__props__.length;r++)n+=e[i.__props__[r]],r<i.__props__.length-1&&(n+=",");return"".concat(n,")")},B.Class=Ci;var ki=Math.PI/180,Ii=180/Math.PI,Bi=e("HALF_PI",.5*Math.PI),Pi=e("TWO_PI",2*Math.PI),Mi=e("EPSILON",1e-6);function Oi(e,t){return Math.abs(e-t)<=Mi*Math.max(1,Math.abs(e),Math.abs(t))}function Di(e,t,i){return i=i||Mi,Math.abs(e-t)<=i}function Li(e,t,i){if(t>i){var n=t;t=i,i=n}return e<t?t:e>i?i:e}function Ni(e){return e<0?0:e>1?1:e}function Fi(e,t,i){return e+(t-e)*i}function Gi(e){return e*ki}function Vi(e){return e*Ii}var Ui=e("random",Math.random);function Hi(e,t){return Math.random()*(t-e)+e}function zi(e,t){return Math.floor(Hi(e,t))}function Wi(e){return(e=(9301*e+49297)%233280)/233280}function Xi(e,t,i){return Wi(e)*(i-t)+t}function ji(e,t,i){return Math.floor(Xi(e,t,i))}function qi(e){return N(e)}function Yi(e,t){return e-Math.floor(e/t)*t}function Ki(e,t){return e=Yi(e,2*t),t-Math.abs(e-t)}function Qi(e,t,i){return(i-e)/(t-e)}function Ji(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function Zi(e,t){return Math.abs(e)>Math.abs(t)?e:t}function $i(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var en=e("Vec4",function(e){h(r,e);var t=v(r);function r(e,s,a,o){var u;return n(this,r),u=t.call(this),e&&"object"===i(e)?(u.x=e.x,u.y=e.y,u.z=e.z,u.w=e.w):(u.x=e||0,u.y=s||0,u.z=a||0,u.w=o||0),u}return s(r,[{key:"clone",value:function(){return new r(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,n,r){return e&&"object"===i(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=r||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Mi;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Mi;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=r*Math.max(1,Math.abs(this.w),Math.abs(n))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}},{key:"lerp",value:function(e,t){var i=this.x,n=this.y,r=this.z,s=this.w;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this.z=r+t*(e.z-r),this.w=s+t*(e.w-s),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=Li(this.x,e.x,t.x),this.y=Li(this.y,e.y,t.y),this.z=Li(this.z,e.z,t.z),this.w=Li(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}},{key:"add4f",value:function(e,t,i,n){return this.x+=e,this.y+=t,this.z+=i,this.w+=n,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}},{key:"subtract4f",value:function(e,t,i,n){return this.x-=e,this.y-=t,this.z-=i,this.w-=n,this}},{key:"multiplyScalar",value:function(e){return"object"===i(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}},{key:"multiply",value:function(e){return"object"!==i(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}},{key:"multiply4f",value:function(e,t,i,n){return this.x*=e,this.y*=t,this.z*=i,this.w*=n,this}},{key:"divide",value:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}},{key:"divide4f",value:function(e,t,i,n){return this.x/=e,this.y/=t,this.z/=i,this.w/=n,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,s=e.y,a=e.z;return this.x=i*a-n*s,this.y=n*r-t*a,this.z=t*s-i*r,this}},{key:"length",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w;return Math.sqrt(e*e+t*t+i*i+n*n)}},{key:"lengthSqr",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w;return e*e+t*t+i*i+n*n}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w,r=e*e+t*t+i*i+n*n;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=i*r,this.w=n*r),this}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=this.z,r=this.w;return this.x=e.m00*t+e.m04*i+e.m08*n+e.m12*r,this.y=e.m01*t+e.m05*i+e.m09*n+e.m13*r,this.z=e.m02*t+e.m06*i+e.m10*n+e.m14*r,this.w=e.m03*t+e.m07*i+e.m11*n+e.m15*r,this}}],[{key:"clone",value:function(e){return new r(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,s=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+s*s)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,s=t.w-e.w;return i*i+n*n+r*r+s*s}},{key:"len",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return Math.sqrt(t*t+i*i+n*n+r*r)}},{key:"lengthSqr",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return t*t+i*i+n*n+r*r}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){var i=t.x,n=t.y,r=t.z,s=t.w;return Math.abs(i)<Mi?e.x=0:e.x=1/i,Math.abs(n)<Mi?e.y=0:e.y=1/n,Math.abs(r)<Mi?e.z=0:e.z=1/r,Math.abs(s)<Mi?e.w=0:e.w=1/s,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=t.z,s=t.w,a=i*i+n*n+r*r+s*s;return a>0?(a=1/Math.sqrt(a),e.x=i*a,e.y=n*a,e.z=r*a,e.w=s*a):(e.x=0,e.y=0,e.z=0,e.w=0),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var i=2*Ui()*Math.PI,n=2*Ui()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y,s=t.z,a=t.w;return e.x=i.m00*n+i.m04*r+i.m08*s+i.m12*a,e.y=i.m01*n+i.m05*r+i.m09*s+i.m13*a,e.z=i.m02*n+i.m06*r+i.m10*s+i.m14*a,e.w=i.m03*n+i.m07*r+i.m11*s+i.m15*a,e}},{key:"transformAffine",value:function(e,t,i){var n=t.x,r=t.y,s=t.z,a=t.w;return e.x=i.m00*n+i.m04*r+i.m08*s+i.m12*a,e.y=i.m01*n+i.m05*r+i.m09*s+i.m13*a,e.z=i.m02*n+i.m06*r+i.m10*s+i.m14*a,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,s=t.z,a=i.x,o=i.y,u=i.z,h=i.w,l=h*n+o*s-u*r,c=h*r+u*n-a*s,_=h*s+a*r-o*n,f=-a*n-o*r-u*s;return e.x=l*h+f*-a+c*-u-_*-o,e.y=c*h+f*-o+_*-a-l*-u,e.z=_*h+f*-u+l*-o-c*-a,e.w=t.w,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mi;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),r}(Mt));function tn(e,t,i,n){return new en(e,t,i,n)}en.ZERO=Object.freeze(new en(0,0,0,0)),en.ONE=Object.freeze(new en(1,1,1,1)),en.NEG_ONE=Object.freeze(new en(-1,-1,-1,-1)),Ci.fastDefine("cc.Vec4",en,{x:0,y:0,z:0,w:0}),B.Vec4=en,B.v4=tn;var nn,rn,sn,an=e("Vec3",function(e){h(r,e);var t=v(r);function r(e,s,a){var o;return n(this,r),o=t.call(this),e&&"object"===i(e)?(o.x=e.x,o.y=e.y,o.z=e.z):(o.x=e||0,o.y=s||0,o.z=a||0),o}return s(r,[{key:"clone",value:function(){return new r(this.x,this.y,this.z)}},{key:"set",value:function(e,t,n){return e&&"object"===i(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Mi;return Math.abs(this.x-e.x)<=t&&Math.abs(this.y-e.y)<=t&&Math.abs(this.z-e.z)<=t}},{key:"equals3f",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Mi;return Math.abs(this.x-e)<=n&&Math.abs(this.y-t)<=n&&Math.abs(this.z-i)<=n}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,i){return this.x===e&&this.y===t&&this.z===i}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}},{key:"add3f",value:function(e,t,i){return this.x+=e,this.y+=t,this.z+=i,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}},{key:"subtract3f",value:function(e,t,i){return this.x-=e,this.y-=t,this.z-=i,this}},{key:"multiplyScalar",value:function(e){return"object"===i(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this}},{key:"multiply",value:function(e){return"object"!==i(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this}},{key:"multiply3f",value:function(e,t,i){return this.x*=e,this.y*=t,this.z*=i,this}},{key:"divide",value:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}},{key:"divide3f",value:function(e,t,i){return this.x/=e,this.y/=t,this.z/=i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=Li(this.x,e.x,t.x),this.y=Li(this.y,e.y,t.y),this.z=Li(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,s=e.y,a=e.z;return this.x=i*a-n*s,this.y=n*r-t*a,this.z=t*s-i*r,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=this.z,n=e*e+t*t+i*i;return n>0&&(n=1/Math.sqrt(n),this.x=e*n,this.y=t*n,this.z=i*n),this}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.m03*t+e.m07*i+e.m11*n+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*i+e.m08*n+e.m12)*r,this.y=(e.m01*t+e.m05*i+e.m09*n+e.m13)*r,this.z=(e.m02*t+e.m06*i+e.m10*n+e.m14)*r,this}}],[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new r(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+n*n+r*r)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z;return i*i+n*n+r*r}},{key:"len",value:function(e){var t=e.x,i=e.y,n=e.z;return Math.sqrt(t*t+i*i+n*n)}},{key:"lengthSqr",value:function(e){var t=e.x,i=e.y,n=e.z;return t*t+i*i+n*n}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){var i=t.x,n=t.y,r=t.z;return Math.abs(i)<Mi?e.x=0:e.x=1/i,Math.abs(n)<Mi?e.y=0:e.y=1/n,Math.abs(r)<Mi?e.z=0:e.z=1/r,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=t.z,s=i*i+n*n+r*r;return s>0?(s=1/Math.sqrt(s),e.x=i*s,e.y=n*s,e.z=r*s):(e.x=0,e.y=0,e.z=0),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){var n=t.x,r=t.y,s=t.z,a=i.x,o=i.y,u=i.z;return e.x=r*u-s*o,e.y=s*a-n*u,e.z=n*o-r*a,e}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var i=2*Ui()*Math.PI,n=2*Ui()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y,s=t.z,a=i.m03*n+i.m07*r+i.m11*s+i.m15;return a=a?Math.abs(1/a):1,e.x=(i.m00*n+i.m04*r+i.m08*s+i.m12)*a,e.y=(i.m01*n+i.m05*r+i.m09*s+i.m13)*a,e.z=(i.m02*n+i.m06*r+i.m10*s+i.m14)*a,e}},{key:"transformMat4Normal",value:function(e,t,i){var n=t.x,r=t.y,s=t.z,a=i.m03*n+i.m07*r+i.m11*s;return a=a?Math.abs(1/a):1,e.x=(i.m00*n+i.m04*r+i.m08*s)*a,e.y=(i.m01*n+i.m05*r+i.m09*s)*a,e.z=(i.m02*n+i.m06*r+i.m10*s)*a,e}},{key:"transformMat3",value:function(e,t,i){var n=t.x,r=t.y,s=t.z;return e.x=n*i.m00+r*i.m03+s*i.m06,e.y=n*i.m01+r*i.m04+s*i.m07,e.z=n*i.m02+r*i.m05+s*i.m08,e}},{key:"transformAffine",value:function(e,t,i){var n=t.x,r=t.y,s=t.z;return e.x=i.m00*n+i.m04*r+i.m08*s+i.m12,e.y=i.m01*n+i.m05*r+i.m09*s+i.m13,e.z=i.m02*n+i.m06*r+i.m10*s+i.m14,e}},{key:"transformQuat",value:function(e,t,i){var n=i.w*t.x+i.y*t.z-i.z*t.y,r=i.w*t.y+i.z*t.x-i.x*t.z,s=i.w*t.z+i.x*t.y-i.y*t.x,a=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+a*-i.x+r*-i.z-s*-i.y,e.y=r*i.w+a*-i.y+s*-i.x-n*-i.z,e.z=s*i.w+a*-i.z+n*-i.y-r*-i.x,e}},{key:"transformRTS",value:function(e,t,i,n,r){var s=t.x*r.x,a=t.y*r.y,o=t.z*r.z,u=i.w*s+i.y*o-i.z*a,h=i.w*a+i.z*s-i.x*o,l=i.w*o+i.x*a-i.y*s,c=-i.x*s-i.y*a-i.z*o;return e.x=u*i.w+c*-i.x+h*-i.z-l*-i.y+n.x,e.y=h*i.w+c*-i.y+l*-i.x-u*-i.z+n.y,e.z=l*i.w+c*-i.z+u*-i.y-h*-i.x+n.z,e}},{key:"transformInverseRTS",value:function(e,t,i,n,r){var s=t.x-n.x,a=t.y-n.y,o=t.z-n.z,u=i.w*s-i.y*o+i.z*a,h=i.w*a-i.z*s+i.x*o,l=i.w*o-i.x*a+i.y*s,c=i.x*s+i.y*a+i.z*o;return e.x=(u*i.w+c*i.x+h*i.z-l*i.y)/r.x,e.y=(h*i.w+c*i.y+l*i.x-u*i.z)/r.y,e.z=(l*i.w+c*i.z+u*i.y-h*i.x)/r.z,e}},{key:"rotateX",value:function(e,t,i,n){var r=t.x-i.x,s=t.y-i.y,a=t.z-i.z,o=Math.cos(n),u=Math.sin(n),h=r,l=s*o-a*u,c=s*u+a*o;return e.x=h+i.x,e.y=l+i.y,e.z=c+i.z,e}},{key:"rotateY",value:function(e,t,i,n){var r=t.x-i.x,s=t.y-i.y,a=t.z-i.z,o=Math.cos(n),u=Math.sin(n),h=a*u+r*o,l=s,c=a*o-r*u;return e.x=h+i.x,e.y=l+i.y,e.z=c+i.z,e}},{key:"rotateZ",value:function(e,t,i,n){var r=t.x-i.x,s=t.y-i.y,a=t.z-i.z,o=Math.cos(n),u=Math.sin(n),h=r*o-s*u,l=r*u+s*o,c=a;return e.x=h+i.x,e.y=l+i.y,e.z=c+i.z,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mi,n=e.x,r=e.y,s=e.z,a=t.x,o=t.y,u=t.z;return Math.abs(n-a)<=i*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-o)<=i*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-u)<=i*Math.max(1,Math.abs(s),Math.abs(u))}},{key:"angle",value:function(e,t){var i=e.x*e.x+e.y*e.y+e.z*e.z,n=t.x*t.x+t.y*t.y+t.z*t.z;if(0===i||0===n)return 0;var r=(e.x*t.x+e.y*t.y+e.z*t.z)/Math.sqrt(i*n);return r=Li(r,-1,1),Math.acos(r)}},{key:"projectOnPlane",value:function(e,t,i){return r.subtract(e,t,r.project(e,t,i))}},{key:"project",value:function(e,t,i){var n=r.lengthSqr(i);return n<1e-6?r.set(e,0,0,0):r.multiplyScalar(e,i,r.dot(t,i)/n)}}]),r}(Mt));function on(e,t,i){return new an(e,t,i)}an.UNIT_X=Object.freeze(new an(1,0,0)),an.UNIT_Y=Object.freeze(new an(0,1,0)),an.UNIT_Z=Object.freeze(new an(0,0,1)),an.RIGHT=Object.freeze(new an(1,0,0)),an.UP=Object.freeze(new an(0,1,0)),an.FORWARD=Object.freeze(new an(0,0,-1)),an.ZERO=Object.freeze(new an(0,0,0)),an.ONE=Object.freeze(new an(1,1,1)),an.NEG_ONE=Object.freeze(new an(-1,-1,-1)),an.slerp=(nn=new an,rn=new an,sn=new an,function(e,t,i,n){var r=1e-5,s=an.len(t),a=an.len(i);if(s<r||a<r)return an.lerp(e,t,i,n);var o=Fi(s,a,n),u=an.dot(t,i)/(s*a);if(u>.99999)return an.lerp(e,t,i,n);if(u<-.99999){var h=an.multiplyScalar(nn,t,1/s),l=function(e,t){var i=t.x,n=t.y,r=t.z,s=Math.abs(i),a=Math.abs(n),o=Math.abs(r);return s<a&&s<o?an.set(e,0,r,-n):a<o?an.set(e,r,0,-i):an.set(e,n,-i,0),an.normalize(e,e)}(rn,h),c=Math.PI*n;return hn(sn,h,l,c),an.multiplyScalar(e,sn,o),e}var _=u,f=Math.acos(_)*n,d=an.multiplyScalar(nn,t,1/s),m=an.multiplyScalar(rn,i,1/a);return an.scaleAndAdd(sn,m,d,-_),an.normalize(sn,sn),an.multiplyScalar(sn,sn,Math.sin(f)),an.scaleAndAdd(sn,sn,d,Math.cos(f)),an.multiplyScalar(e,sn,o),e}),Ci.fastDefine("cc.Vec3",an,{x:0,y:0,z:0}),B.Vec3=an;var un,hn=(un={x:0,y:0,z:0,w:0},function(e,t,i,n){var r=.5*n,s=Math.sin(r);return un.x=s*i.x,un.y=s*i.y,un.z=s*i.z,un.w=Math.cos(r),an.transformQuat(e,t,un),e});B.v3=on;var ln=1/255,cn=e("Color",function(e){h(r,e);var t=v(r);function r(e,i,s,a){var o;return n(this,r),(o=t.call(this))._val=0,"string"==typeof e?o.fromHEX(e):void 0!==i?o.set(e,i,s,a):o.set(e),o}return s(r,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~Li(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~Li(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~Li(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~Li(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*ln},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*ln},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*ln},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*ln},set:function(e){this.a=255*e}},{key:"clone",value:function(){var e=new r;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){var i=this.r,n=this.g,r=this.b,s=this.a;return i+=(e.r-i)*t,n+=(e.g-n)*t,r+=(e.b-r)*t,s+=(e.a-s)*t,this._val=Math.floor((s<<24>>>0)+(r<<16)+(n<<8)+i),this}},{key:"toString",value:function(){return"rgba(".concat(this.r.toFixed(),", ").concat(this.g.toFixed(),", ").concat(this.b.toFixed(),", ").concat(this.a.toFixed(),")")}},{key:"toCSS",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"rgba";return"rgba"===e?"rgba(".concat(this.r,",").concat(this.g,",").concat(this.b,",").concat((this.a*ln).toFixed(2),")"):"rgb"===e?"rgb(".concat(this.r,",").concat(this.g,",").concat(this.b,")"):"#".concat(this.toHEX(e))}},{key:"fromHEX",value:function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,i=parseInt(e.substr(2,2),16)||0,n=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(n<<16)+(i<<8)+(0|t),this}},{key:"toHEX",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"#rrggbb",t="0",i=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(i[0]=i[0][0],i[1]=i[1][0],i[2]=i[2][0]):"#rrggbbaa"===e&&i.push((this.a<16?t:"")+this.a.toString(16)),i.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){var n=0,r=0,s=0;if(0===t)n=r=s=i;else if(0===i)n=r=s=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),o=e-a,u=i*(1-t),h=i*(1-t*o),l=i*(1-t*(1-o));switch(a){default:case 0:n=i,r=l,s=u;break;case 1:n=h,r=i,s=u;break;case 2:n=u,r=i,s=l;break;case 3:n=u,r=h,s=i;break;case 4:n=l,r=u,s=i;break;case 5:n=i,r=u,s=h}}return n*=255,r*=255,s*=255,this._val=(this.a<<24>>>0)+(s<<16)+(r<<8)+(0|n),this}},{key:"toHSV",value:function(){var e=this.r*ln,t=this.g*ln,i=this.b*ln,n={h:0,s:0,v:0},r=Math.max(e,t,i),s=Math.min(e,t,i),a=0;return n.v=r,n.s=r?(r-s)/r:0,n.s?(a=r-s,n.h=e===r?(t-i)/a:t===r?2+(i-e)/a:4+(e-t)/a,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n}},{key:"set",value:function(e,t,n,r){return"object"===i(e)?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,r="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(r<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,r="number"==typeof r?r:255,this._val=(r<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this}},{key:"multiply",value:function(e){var t=(255&this._val)*e.r>>8,i=(65280&this._val)*e.g>>8,n=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&n|65280&i|255&t,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24)>>>0,this}}],[{key:"clone",value:function(e){var t=new r;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e}},{key:"toVec4",value:function(e,t){return(t=void 0!==t?t:new en).x=e.r*ln,t.y=e.g*ln,t.z=e.b*ln,t.w=e.a*ln,t}},{key:"fromVec4",value:function(e,t){return(t=void 0===t?new r:t).r=Math.floor(e.x/ln),t.g=Math.floor(e.y/ln),t.b=Math.floor(e.z/ln),t.a=Math.floor(e.w/ln),t}},{key:"fromHEX",value:function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;var i=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(i)?255:i,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,n){var r=t.r,s=t.g,a=t.b,o=t.a;return r+=(i.r-r)*n,s+=(i.g-s)*n,a+=(i.b-a)*n,o+=(i.a-o)*n,e._val=Math.floor((o<<24>>>0)+(a<<16)+(s<<8)+r),e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=t instanceof r||t.a>1?1/255:1;return e[i+0]=t.r*n,e[i+1]=t.g*n,e[i+2]=t.b*n,e[i+3]=t.a*n,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return t.r=255*e[i+0],t.g=255*e[i+1],t.b=255*e[i+2],t.a=255*e[i+3],t}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mi;return Math.abs(e.r-t.r)<=i*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=i*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=i*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=i*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),r}(Mt));function _n(e,t,i,n){return new cn(e,t,i,n)}function fn(e){var t=e.clone();return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t}cn.WHITE=Object.freeze(new cn(255,255,255,255)),cn.GRAY=Object.freeze(new cn(127,127,127,255)),cn.BLACK=Object.freeze(new cn(0,0,0,255)),cn.TRANSPARENT=Object.freeze(new cn(0,0,0,0)),cn.RED=Object.freeze(new cn(255,0,0,255)),cn.GREEN=Object.freeze(new cn(0,255,0,255)),cn.BLUE=Object.freeze(new cn(0,0,255,255)),cn.CYAN=Object.freeze(new cn(0,255,255,255)),cn.MAGENTA=Object.freeze(new cn(255,0,255,255)),cn.YELLOW=Object.freeze(new cn(255,255,0,255)),Ci.fastDefine("cc.Color",cn,{r:0,g:0,b:0,a:255}),B.Color=cn,B.color=_n;var dn=e("Mat3",function(e){h(r,e);var t=v(r);function r(){var e,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,_=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,f=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return n(this,r),e=t.call(this),"object"===i(s)?(e.m00=s.m00,e.m01=s.m01,e.m02=s.m02,e.m03=s.m03,e.m04=s.m04,e.m05=s.m05,e.m06=s.m06,e.m07=s.m07,e.m08=s.m08):(e.m00=s,e.m01=a,e.m02=o,e.m03=u,e.m04=h,e.m05=l,e.m06=c,e.m07=_,e.m08=f),e}return s(r,[{key:"clone",value:function(){var e=this;return new r(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return"object"===i(e)?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=r,this.m04=s,this.m05=a,this.m06=o,this.m07=u,this.m08=h),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Mi;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){var e=this;return"[\n".concat(e.m00,", ").concat(e.m01,", ").concat(e.m02,",\n").concat(e.m03,",\n").concat(e.m04,", ").concat(e.m05,",\n").concat(e.m06,", ").concat(e.m07,",\n").concat(e.m08,"\n")+"]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}},{key:"invert",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,s=this.m05,a=this.m06,o=this.m07,u=this.m08,h=u*r-s*o,l=-u*n+s*a,c=o*n-r*a,_=e*h+t*l+i*c;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=h*_,this.m01=(-u*t+i*o)*_,this.m02=(s*t-i*r)*_,this.m03=l*_,this.m04=(u*e-i*a)*_,this.m05=(-s*e+i*n)*_,this.m06=c*_,this.m07=(-o*e+t*a)*_,this.m08=(r*e-t*n)*_,this)}},{key:"determinant",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,s=this.m05,a=this.m06,o=this.m07,u=this.m08;return e*(u*r-s*o)+t*(-u*n+s*a)+i*(o*n-r*a)}},{key:"add",value:function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this}},{key:"subtract",value:function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,s=this.m04,a=this.m05,o=this.m06,u=this.m07,h=this.m08,l=e.m00,c=e.m01,_=e.m02,f=e.m03,d=e.m04,m=e.m05,p=e.m06,v=e.m07,y=e.m08;return this.m00=l*t+c*r+_*o,this.m01=l*i+c*s+_*u,this.m02=l*n+c*a+_*h,this.m03=f*t+d*r+m*o,this.m04=f*i+d*s+m*u,this.m05=f*n+d*a+m*h,this.m06=p*t+v*r+y*o,this.m07=p*i+v*s+y*u,this.m08=p*n+v*a+y*h,this}},{key:"multiplyScalar",value:function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this}},{key:"scale",value:function(e){var t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,s=this.m04,a=this.m05,o=this.m06,u=this.m07,h=this.m08,l=Math.sin(e),c=Math.cos(e);return this.m00=c*t+l*r,this.m01=c*i+l*s,this.m02=c*n+l*a,this.m03=c*r-l*t,this.m04=c*s-l*i,this.m05=c*a-l*n,this.m06=o,this.m07=u,this.m08=h,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,s=t+t,a=i+i,o=n+n,u=t*s,h=i*s,l=i*a,c=n*s,_=n*a,f=n*o,d=r*s,m=r*a,p=r*o;return this.m00=1-l-f,this.m03=h-p,this.m06=c+m,this.m01=h+p,this.m04=1-u-f,this.m07=_-d,this.m02=c-m,this.m05=_+d,this.m08=1-u-l,this}}],[{key:"clone",value:function(e){return new r(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,n,r,s,a,o,u,h){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=s,e.m05=a,e.m06=o,e.m07=u,e.m08=h,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=i,e.m05=t.m07,e.m06=n,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e}},{key:"invert",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,s=t.m03,a=t.m04,o=t.m05,u=t.m06,h=t.m07,l=t.m08,c=l*a-o*h,_=-l*s+o*u,f=h*s-a*u,d=i*c+n*_+r*f;return 0===d?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(d=1/d,e.m00=c*d,e.m01=(-l*n+r*h)*d,e.m02=(o*n-r*a)*d,e.m03=_*d,e.m04=(l*i-r*u)*d,e.m05=(-o*i+r*s)*d,e.m06=f*d,e.m07=(-h*i+n*u)*d,e.m08=(a*i-n*s)*d,e)}},{key:"determinant",value:function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,s=e.m04,a=e.m05,o=e.m06,u=e.m07,h=e.m08;return t*(h*s-a*u)+i*(-h*r+a*o)+n*(u*r-s*o)}},{key:"multiply",value:function(e,t,i){var n=t.m00,r=t.m01,s=t.m02,a=t.m03,o=t.m04,u=t.m05,h=t.m06,l=t.m07,c=t.m08,_=i.m00,f=i.m01,d=i.m02,m=i.m03,p=i.m04,v=i.m05,y=i.m06,g=i.m07,S=i.m08;return e.m00=_*n+f*a+d*h,e.m01=_*r+f*o+d*l,e.m02=_*s+f*u+d*c,e.m03=m*n+p*a+v*h,e.m04=m*r+p*o+v*l,e.m05=m*s+p*u+v*c,e.m06=y*n+g*a+S*h,e.m07=y*r+g*o+S*l,e.m08=y*s+g*u+S*c,e}},{key:"multiplyMat4",value:function(e,t,i){var n=t.m00,r=t.m01,s=t.m02,a=t.m03,o=t.m04,u=t.m05,h=t.m06,l=t.m07,c=t.m08,_=i.m00,f=i.m01,d=i.m02,m=i.m04,p=i.m05,v=i.m06,y=i.m08,g=i.m09,S=i.m10;return e.m00=_*n+f*a+d*h,e.m01=_*r+f*o+d*l,e.m02=_*s+f*u+d*c,e.m03=m*n+p*a+v*h,e.m04=m*r+p*o+v*l,e.m05=m*s+p*u+v*c,e.m06=y*n+g*a+S*h,e.m07=y*r+g*o+S*l,e.m08=y*s+g*u+S*c,e}},{key:"transform",value:function(e,t,i){var n=t.m00,r=t.m01,s=t.m02,a=t.m03,o=t.m04,u=t.m05,h=t.m06,l=t.m07,c=t.m08,_=i.x,f=i.y;return e.m00=n,e.m01=r,e.m02=s,e.m03=a,e.m04=o,e.m05=u,e.m06=_*n+f*a+h,e.m07=_*r+f*o+l,e.m08=_*s+f*u+c,e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){var n=t.m00,r=t.m01,s=t.m02,a=t.m03,o=t.m04,u=t.m05,h=t.m06,l=t.m07,c=t.m08,_=Math.sin(i),f=Math.cos(i);return e.m00=f*n+_*a,e.m01=f*r+_*o,e.m02=f*s+_*u,e.m03=f*a-_*n,e.m04=f*o-_*r,e.m05=f*u-_*s,e.m06=h,e.m07=l,e.m08=c,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return an.lengthSqr(t)<Mi*Mi?(r.identity(e),e):(i=i||an.UNIT_Y,an.normalize(mn,an.cross(mn,i,t)),an.lengthSqr(mn)<Mi*Mi?(r.identity(e),e):(an.cross(pn,t,mn),r.set(e,mn.x,mn.y,mn.z,pn.x,pn.y,pn.z,t.x,t.y,t.z),e))}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,s=t.w,a=i+i,o=n+n,u=r+r,h=i*a,l=n*a,c=n*o,_=r*a,f=r*o,d=r*u,m=s*a,p=s*o,v=s*u;return e.m00=1-c-d,e.m03=l-v,e.m06=_+p,e.m01=l+v,e.m04=1-h-d,e.m07=f-m,e.m02=_-p,e.m05=f+m,e.m08=1-h-c,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,s=t.m03,a=t.m04,o=t.m05,u=t.m06,h=t.m07,l=t.m08,c=t.m09,_=t.m10,f=t.m11,d=t.m12,m=t.m13,p=t.m14,v=t.m15,y=i*o-n*a,g=i*u-r*a,S=i*h-s*a,A=n*u-r*o,T=n*h-s*o,E=r*h-s*u,b=l*m-c*d,C=l*p-_*d,R=l*v-f*d,x=c*p-_*m,w=c*v-f*m,k=_*v-f*p,I=y*k-g*w+S*x+A*R-T*C+E*b;return I?(I=1/I,e.m00=(o*k-u*w+h*x)*I,e.m01=(u*R-a*k-h*C)*I,e.m02=(a*w-o*R+h*b)*I,e.m03=(r*w-n*k-s*x)*I,e.m04=(i*k-r*R+s*C)*I,e.m05=(n*R-i*w-s*b)*I,e.m06=(m*E-p*T+v*A)*I,e.m07=(p*S-d*E-v*g)*I,e.m08=(d*T-m*S+v*y)*I,e):null}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mi;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}},{key:"toEuler",value:function(e,t){var i=e.m00,n=e.m01,r=(e.m02,e.m03),s=e.m04,a=(e.m05,e.m06),o=e.m07,u=e.m08;return o<.999?o>-.999?(t.x=Math.asin(-o),t.y=Math.atan2(a,u),t.z=Math.atan2(n,s),!0):(t.x=Bi,t.y=Math.atan2(r,i),t.z=0,!1):(t.x=-Bi,t.y=Math.atan2(-r,i),t.z=0,!1)}}]),r}(Mt));dn.IDENTITY=Object.freeze(new dn);var mn=new an,pn=new an;Ci.fastDefine("cc.Mat3",dn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),B.Mat3=dn;var vn=e("Quat",function(e){h(r,e);var t=v(r);function r(e,s,a,o){var u;return n(this,r),u=t.call(this),e&&"object"===i(e)?(u.x=e.x,u.y=e.y,u.z=e.z,u.w=e.w):(u.x=e||0,u.y=s||0,u.z=a||0,u.w=null!=o?o:1),u}return s(r,[{key:"clone",value:function(){return new r(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,n,r){return e&&"object"===i(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=r?r:1),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Mi;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return r.toEuler(e,this)}},{key:"lerp",value:function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this}},{key:"slerp",value:function(e,t){return r.slerp(this,this,e,t)}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}],[{key:"clone",value:function(e){return new r(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var n=an.dot(t,i);return n<-.999999?(an.cross(Sn,an.UNIT_X,t),Sn.length()<1e-6&&an.cross(Sn,an.UNIT_Y,t),an.normalize(Sn,Sn),r.fromAxisAngle(e,Sn,Math.PI),e):n>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(an.cross(Sn,t,i),e.x=Sn.x,e.y=Sn.y,e.z=Sn.z,e.w=1+n,r.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}},{key:"multiply",value:function(e,t,i){var n=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,r=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,s=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,a=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z;return e.x=n,e.y=r,e.z=s,e.w=a,e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),s=t.x,a=t.y,o=t.z,u=t.w;return e.x=s*r+u*n,e.y=a*r+o*n,e.z=o*r-a*n,e.w=u*r-s*n,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),s=t.x,a=t.y,o=t.z,u=t.w;return e.x=s*r-o*n,e.y=a*r+u*n,e.z=o*r+s*n,e.w=u*r-a*n,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),s=t.x,a=t.y,o=t.z,u=t.w;return e.x=s*r+a*n,e.y=a*r-s*n,e.z=o*r+u*n,e.w=u*r-o*n,e}},{key:"rotateAround",value:function(e,t,i,n){return r.invert(yn,t),an.transformQuat(Sn,i,yn),r.fromAxisAngle(yn,Sn,n),r.multiply(e,t,yn),e}},{key:"rotateAroundLocal",value:function(e,t,i,n){return r.fromAxisAngle(yn,i,n),r.multiply(e,t,yn),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"slerp",value:function(e,t,i,n){var r=0,s=0,a=i.x,o=i.y,u=i.z,h=i.w,l=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(l<0&&(l=-l,a=-a,o=-o,u=-u,h=-h),1-l>1e-6){var c=Math.acos(l),_=Math.sin(c);r=Math.sin((1-n)*c)/_,s=Math.sin(n*c)/_}else r=1-n,s=n;return e.x=r*t.x+s*a,e.y=r*t.y+s*o,e.z=r*t.z+s*u,e.w=r*t.w+s*h,e}},{key:"sqlerp",value:function(e,t,i,n,s,a){return r.slerp(yn,t,s,a),r.slerp(gn,i,n,a),r.slerp(e,yn,gn,2*a*(1-a)),e}},{key:"invert",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return i>0?(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i):(e.x=0,e.y=0,e.z=0,e.w=0),e}},{key:"fromAxes",value:function(e,t,i,n){return dn.set(An,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z),r.normalize(e,r.fromMat3(e,An))}},{key:"fromViewUp",value:function(e,t,i){return dn.fromViewUp(An,t,i),r.normalize(e,r.fromMat3(e,An))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,n=t.m03,r=t.m06,s=t.m01,a=t.m04,o=t.m07,u=t.m02,h=t.m05,l=t.m08,c=i+a+l;if(c>0){var _=.5/Math.sqrt(c+1);e.w=.25/_,e.x=(h-o)*_,e.y=(r-u)*_,e.z=(s-n)*_}else if(i>a&&i>l){var f=.5/Math.sqrt(1+i-a-l);e.w=(h-o)*f,e.x=.25/f,e.y=(n+s)*f,e.z=(r+u)*f}else if(a>l){var d=.5/Math.sqrt(1+a-i-l);e.w=(r-u)*d,e.x=(n+s)*d,e.y=.25/d,e.z=(o+h)*d}else{var m=.5/Math.sqrt(1+l-i-a);e.w=(s-n)*m,e.x=(r+u)*m,e.y=(o+h)*m,e.z=.25/m}return e}},{key:"fromEuler",value:function(e,t,i,n){t*=Tn,i*=Tn,n*=Tn;var r=Math.sin(t),s=Math.cos(t),a=Math.sin(i),o=Math.cos(i),u=Math.sin(n),h=Math.cos(n);return e.x=r*o*h+s*a*u,e.y=s*a*h+r*o*u,e.z=s*o*u-r*a*h,e.w=s*o*h-r*a*u,e}},{key:"fromAngleZ",value:function(e,t){return t*=Tn,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}},{key:"toAxisY",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w,e}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}},{key:"toEuler",value:function(e,t,i){var n=t.x,r=t.y,s=t.z,a=t.w,o=0,u=0,h=0,l=n*r+s*a;if(l>.499999)o=0,u=Vi(2*Math.atan2(n,a)),h=90;else if(l<-.499999)o=0,u=-Vi(2*Math.atan2(n,a)),h=-90;else{var c=n*n,_=r*r,f=s*s;o=Vi(Math.atan2(2*n*a-2*r*s,1-2*c-2*f)),u=Vi(Math.atan2(2*r*a-2*n*s,1-2*_-2*f)),h=Vi(Math.asin(2*l)),i&&(o=-180*Math.sign(o+1e-6)+o,u=-180*Math.sign(u+1e-6)+u,h=180*Math.sign(h+1e-6)-h)}return e.x=o,e.y=u,e.z=h,e}},{key:"toEulerInYXZOrder",value:function(e,t){dn.fromQuat(An,t),dn.toEuler(An,e),e.x=Vi(e.x),e.y=Vi(e.y),e.z=Vi(e.z)}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mi;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),r}(Mt));vn.IDENTITY=Object.freeze(new vn);var yn=new vn,gn=new vn,Sn=new an,An=new dn,Tn=.5*Math.PI/180;function En(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new vn(e,t,i,n)}Ci.fastDefine("cc.Quat",vn,{x:0,y:0,z:0,w:1}),B.Quat=vn,B.quat=En;var bn=e("preTransforms",Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])])),Cn=e("Mat4",function(e){h(r,e);var t=v(r);function r(){var e,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,_=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,f=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,d=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,m=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,p=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,v=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,y=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,g=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,S=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return n(this,r),e=t.call(this),"object"===i(s)?(e.m00=s.m00,e.m01=s.m01,e.m02=s.m02,e.m03=s.m03,e.m04=s.m04,e.m05=s.m05,e.m06=s.m06,e.m07=s.m07,e.m08=s.m08,e.m09=s.m09,e.m10=s.m10,e.m11=s.m11,e.m12=s.m12,e.m13=s.m13,e.m14=s.m14,e.m15=s.m15):(e.m00=s,e.m01=a,e.m02=o,e.m03=u,e.m04=h,e.m05=l,e.m06=c,e.m07=_,e.m08=f,e.m09=d,e.m10=m,e.m11=p,e.m12=v,e.m13=y,e.m14=g,e.m15=S),e}return s(r,[{key:"clone",value:function(){return new r(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,l=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,_=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,f=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,m=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,p=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return"object"===i(e)?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=r,this.m04=s,this.m05=a,this.m06=o,this.m07=u,this.m08=h,this.m09=l,this.m10=c,this.m11=_,this.m12=f,this.m13=d,this.m14=m,this.m15=p,this.m00=e),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Mi;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n".concat(this.m00,", ").concat(this.m01,", ").concat(this.m02,", ").concat(this.m03,",\n").concat(this.m04,", ").concat(this.m05,", ").concat(this.m06,", ").concat(this.m07,",\n").concat(this.m08,", ").concat(this.m09,", ").concat(this.m10,", ").concat(this.m11,",\n").concat(this.m12,", ").concat(this.m13,", ").concat(this.m14,", ").concat(this.m15,"\n")+"]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"zero",value:function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m03,n=this.m06,r=this.m07,s=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=s,this}},{key:"invert",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,s=this.m05,a=this.m06,o=this.m07,u=this.m08,h=this.m09,l=this.m10,c=this.m11,_=this.m12,f=this.m13,d=this.m14,m=this.m15,p=e*s-t*r,v=e*a-i*r,y=e*o-n*r,g=t*a-i*s,S=t*o-n*s,A=i*o-n*a,T=u*f-h*_,E=u*d-l*_,b=u*m-c*_,C=h*d-l*f,R=h*m-c*f,x=l*m-c*d,w=p*x-v*R+y*C+g*b-S*E+A*T;return 0===w?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(w=1/w,this.m00=(s*x-a*R+o*C)*w,this.m01=(i*R-t*x-n*C)*w,this.m02=(f*A-d*S+m*g)*w,this.m03=(l*S-h*A-c*g)*w,this.m04=(a*b-r*x-o*E)*w,this.m05=(e*x-i*b+n*E)*w,this.m06=(d*y-_*A-m*v)*w,this.m07=(u*A-l*y+c*v)*w,this.m08=(r*R-s*b+o*T)*w,this.m09=(t*b-e*R-n*T)*w,this.m10=(_*S-f*y+m*p)*w,this.m11=(h*y-u*S-c*p)*w,this.m12=(s*E-r*C-a*T)*w,this.m13=(e*C-t*E+i*T)*w,this.m14=(f*v-_*g-d*p)*w,this.m15=(u*g-h*v+l*p)*w,this)}},{key:"determinant",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,s=this.m05,a=this.m06,o=this.m07,u=this.m08,h=this.m09,l=this.m10,c=this.m11,_=this.m12,f=this.m13,d=this.m14,m=this.m15;return(e*s-t*r)*(l*m-c*d)-(e*a-i*r)*(h*m-c*f)+(e*o-n*r)*(h*d-l*f)+(t*a-i*s)*(u*m-c*_)-(t*o-n*s)*(u*d-l*_)+(i*o-n*a)*(u*f-h*_)}},{key:"add",value:function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this}},{key:"subtract",value:function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,s=this.m04,a=this.m05,o=this.m06,u=this.m07,h=this.m08,l=this.m09,c=this.m10,_=this.m11,f=this.m12,d=this.m13,m=this.m14,p=this.m15,v=e.m00,y=e.m01,g=e.m02,S=e.m03;return this.m00=v*t+y*s+g*h+S*f,this.m01=v*i+y*a+g*l+S*d,this.m02=v*n+y*o+g*c+S*m,this.m03=v*r+y*u+g*_+S*p,v=e.m04,y=e.m05,g=e.m06,S=e.m07,this.m04=v*t+y*s+g*h+S*f,this.m05=v*i+y*a+g*l+S*d,this.m06=v*n+y*o+g*c+S*m,this.m07=v*r+y*u+g*_+S*p,v=e.m08,y=e.m09,g=e.m10,S=e.m11,this.m08=v*t+y*s+g*h+S*f,this.m09=v*i+y*a+g*l+S*d,this.m10=v*n+y*o+g*c+S*m,this.m11=v*r+y*u+g*_+S*p,v=e.m12,y=e.m13,g=e.m14,S=e.m15,this.m12=v*t+y*s+g*h+S*f,this.m13=v*i+y*a+g*l+S*d,this.m14=v*n+y*o+g*c+S*m,this.m15=v*r+y*u+g*_+S*p,this}},{key:"multiplyScalar",value:function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this}},{key:"translate",value:function(e){return this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this}},{key:"scale",value:function(e){var t=e.x,i=e.y,n=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=i,this.m05*=i,this.m06*=i,this.m07*=i,this.m08*=n,this.m09*=n,this.m10*=n,this.m11*=n,this}},{key:"rotate",value:function(e,t){var i=t.x,n=t.y,r=t.z,s=Math.sqrt(i*i+n*n+r*r);if(Math.abs(s)<Mi)return null;i*=s=1/s,n*=s,r*=s;var a=Math.sin(e),o=Math.cos(e),u=1-o,h=this.m00,l=this.m01,c=this.m02,_=this.m03,f=this.m04,d=this.m05,m=this.m06,p=this.m07,v=this.m08,y=this.m09,g=this.m10,S=this.m11,A=i*i*u+o,T=n*i*u+r*a,E=r*i*u-n*a,b=i*n*u-r*a,C=n*n*u+o,R=r*n*u+i*a,x=i*r*u+n*a,w=n*r*u-i*a,k=r*r*u+o;return this.m00=h*A+f*T+v*E,this.m01=l*A+d*T+y*E,this.m02=c*A+m*T+g*E,this.m03=_*A+p*T+S*E,this.m04=h*b+f*C+v*R,this.m05=l*b+d*C+y*R,this.m06=c*b+m*C+g*R,this.m07=_*b+p*C+S*R,this.m08=h*x+f*w+v*k,this.m09=l*x+d*w+y*k,this.m10=c*x+m*w+g*k,this.m11=_*x+p*w+S*k,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=xn.m00=this.m00,i=xn.m01=this.m01,n=xn.m02=this.m02,r=xn.m03=this.m04,s=xn.m04=this.m05,a=xn.m05=this.m06,o=xn.m06=this.m08,u=xn.m07=this.m09,h=xn.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(r*r+s*s+a*a),e.z=Math.sqrt(o*o+u*u+h*h),dn.determinant(xn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=an.set(Rn,this.m00,this.m01,this.m02).length(),i=an.set(Rn,this.m04,this.m05,this.m06).length(),n=an.set(Rn,this.m08,this.m09,this.m10).length();return xn.m00=this.m00/t,xn.m01=this.m01/t,xn.m02=this.m02/t,xn.m03=this.m04/i,xn.m04=this.m05/i,xn.m05=this.m06/i,xn.m06=this.m08/n,xn.m07=this.m09/n,xn.m08=this.m10/n,dn.determinant(xn)<0&&(xn.m00*=-1,xn.m01*=-1,xn.m02*=-1),vn.fromMat3(e,xn)}},{key:"fromRTS",value:function(e,t,i){var n=e.x,r=e.y,s=e.z,a=e.w,o=n+n,u=r+r,h=s+s,l=n*o,c=n*u,_=n*h,f=r*u,d=r*h,m=s*h,p=a*o,v=a*u,y=a*h,g=i.x,S=i.y,A=i.z;return this.m00=(1-(f+m))*g,this.m01=(c+y)*g,this.m02=(_-v)*g,this.m03=0,this.m04=(c-y)*S,this.m05=(1-(l+m))*S,this.m06=(d+p)*S,this.m07=0,this.m08=(_+v)*A,this.m09=(d-p)*A,this.m10=(1-(l+f))*A,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,s=t+t,a=i+i,o=n+n,u=t*s,h=i*s,l=i*a,c=n*s,_=n*a,f=n*o,d=r*s,m=r*a,p=r*o;return this.m00=1-l-f,this.m01=h+p,this.m02=c-m,this.m03=0,this.m04=h-p,this.m05=1-u-f,this.m06=_+d,this.m07=0,this.m08=c+m,this.m09=_-d,this.m10=1-u-l,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}],[{key:"clone",value:function(e){return new r(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,n,r,s,a,o,u,h,l,c,_,f,d,m,p){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=s,e.m05=a,e.m06=o,e.m07=u,e.m08=h,e.m09=l,e.m10=c,e.m11=_,e.m12=f,e.m13=d,e.m14=m,e.m15=p,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m03,s=t.m06,a=t.m07,o=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=s,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=o}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,s=t.m03,a=t.m04,o=t.m05,u=t.m06,h=t.m07,l=t.m08,c=t.m09,_=t.m10,f=t.m11,d=t.m12,m=t.m13,p=t.m14,v=t.m15,y=i*o-n*a,g=i*u-r*a,S=i*h-s*a,A=n*u-r*o,T=n*h-s*o,E=r*h-s*u,b=l*m-c*d,C=l*p-_*d,R=l*v-f*d,x=c*p-_*m,w=c*v-f*m,k=_*v-f*p,I=y*k-g*w+S*x+A*R-T*C+E*b;return 0===I?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(I=1/I,e.m00=(o*k-u*w+h*x)*I,e.m01=(r*w-n*k-s*x)*I,e.m02=(m*E-p*T+v*A)*I,e.m03=(_*T-c*E-f*A)*I,e.m04=(u*R-a*k-h*C)*I,e.m05=(i*k-r*R+s*C)*I,e.m06=(p*S-d*E-v*g)*I,e.m07=(l*E-_*S+f*g)*I,e.m08=(a*w-o*R+h*b)*I,e.m09=(n*R-i*w-s*b)*I,e.m10=(d*T-m*S+v*y)*I,e.m11=(c*S-l*T-f*y)*I,e.m12=(o*C-a*x-u*b)*I,e.m13=(i*x-n*C+r*b)*I,e.m14=(m*g-d*A-p*y)*I,e.m15=(l*A-c*g+_*y)*I,e)}},{key:"determinant",value:function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,s=e.m04,a=e.m05,o=e.m06,u=e.m07,h=e.m08,l=e.m09,c=e.m10,_=e.m11,f=e.m12,d=e.m13,m=e.m14,p=e.m15;return(t*a-i*s)*(c*p-_*m)-(t*o-n*s)*(l*p-_*d)+(t*u-r*s)*(l*m-c*d)+(i*o-n*a)*(h*p-_*f)-(i*u-r*a)*(h*m-c*f)+(n*u-r*o)*(h*d-l*f)}},{key:"multiply",value:function(e,t,i){var n=t.m00,r=t.m01,s=t.m02,a=t.m03,o=t.m04,u=t.m05,h=t.m06,l=t.m07,c=t.m08,_=t.m09,f=t.m10,d=t.m11,m=t.m12,p=t.m13,v=t.m14,y=t.m15,g=i.m00,S=i.m01,A=i.m02,T=i.m03;return e.m00=g*n+S*o+A*c+T*m,e.m01=g*r+S*u+A*_+T*p,e.m02=g*s+S*h+A*f+T*v,e.m03=g*a+S*l+A*d+T*y,g=i.m04,S=i.m05,A=i.m06,T=i.m07,e.m04=g*n+S*o+A*c+T*m,e.m05=g*r+S*u+A*_+T*p,e.m06=g*s+S*h+A*f+T*v,e.m07=g*a+S*l+A*d+T*y,g=i.m08,S=i.m09,A=i.m10,T=i.m11,e.m08=g*n+S*o+A*c+T*m,e.m09=g*r+S*u+A*_+T*p,e.m10=g*s+S*h+A*f+T*v,e.m11=g*a+S*l+A*d+T*y,g=i.m12,S=i.m13,A=i.m14,T=i.m15,e.m12=g*n+S*o+A*c+T*m,e.m13=g*r+S*u+A*_+T*p,e.m14=g*s+S*h+A*f+T*v,e.m15=g*a+S*l+A*d+T*y,e}},{key:"transform",value:function(e,t,i){var n=i.x,r=i.y,s=i.z;if(t===e)e.m12=t.m00*n+t.m04*r+t.m08*s+t.m12,e.m13=t.m01*n+t.m05*r+t.m09*s+t.m13,e.m14=t.m02*n+t.m06*r+t.m10*s+t.m14,e.m15=t.m03*n+t.m07*r+t.m11*s+t.m15;else{var a=t.m00,o=t.m01,u=t.m02,h=t.m03,l=t.m04,c=t.m05,_=t.m06,f=t.m07,d=t.m08,m=t.m09,p=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=o,e.m02=u,e.m03=h,e.m04=l,e.m05=c,e.m06=_,e.m07=f,e.m08=d,e.m09=m,e.m10=p,e.m11=v,e.m12=a*n+l*r+d*s+t.m12,e.m13=o*n+c*r+m*s+t.m13,e.m14=u*n+_*r+p*s+t.m14,e.m15=h*n+f*r+v*s+t.m15}return e}},{key:"translate",value:function(e,t,i){return t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y,s=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*s,e.m09=t.m09*s,e.m10=t.m10*s,e.m11=t.m11*s,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,n){var r=n.x,s=n.y,a=n.z,o=Math.sqrt(r*r+s*s+a*a);if(Math.abs(o)<Mi)return null;r*=o=1/o,s*=o,a*=o;var u=Math.sin(i),h=Math.cos(i),l=1-h,c=t.m00,_=t.m01,f=t.m02,d=t.m03,m=t.m04,p=t.m05,v=t.m06,y=t.m07,g=t.m08,S=t.m09,A=t.m10,T=t.m11,E=r*r*l+h,b=s*r*l+a*u,C=a*r*l-s*u,R=r*s*l-a*u,x=s*s*l+h,w=a*s*l+r*u,k=r*a*l+s*u,I=s*a*l-r*u,B=a*a*l+h;return e.m00=c*E+m*b+g*C,e.m01=_*E+p*b+S*C,e.m02=f*E+v*b+A*C,e.m03=d*E+y*b+T*C,e.m04=c*R+m*x+g*w,e.m05=_*R+p*x+S*w,e.m06=f*R+v*x+A*w,e.m07=d*R+y*x+T*w,e.m08=c*k+m*I+g*B,e.m09=_*k+p*I+S*B,e.m10=f*k+v*I+A*B,e.m11=d*k+y*I+T*B,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),s=t.m04,a=t.m05,o=t.m06,u=t.m07,h=t.m08,l=t.m09,c=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=s*r+h*n,e.m05=a*r+l*n,e.m06=o*r+c*n,e.m07=u*r+_*n,e.m08=h*r-s*n,e.m09=l*r-a*n,e.m10=c*r-o*n,e.m11=_*r-u*n,e}},{key:"rotateY",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),s=t.m00,a=t.m01,o=t.m02,u=t.m03,h=t.m08,l=t.m09,c=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=s*r-h*n,e.m01=a*r-l*n,e.m02=o*r-c*n,e.m03=u*r-_*n,e.m08=s*n+h*r,e.m09=a*n+l*r,e.m10=o*n+c*r,e.m11=u*n+_*r,e}},{key:"rotateZ",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),s=t.m00,a=t.m01,o=t.m02,u=t.m03,h=t.m04,l=t.m05,c=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=s*r+h*n,e.m01=a*r+l*n,e.m02=o*r+c*n,e.m03=u*r+_*n,e.m04=h*r-s*n,e.m05=l*r-a*n,e.m06=c*r-o*n,e.m07=_*r-u*n,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var n=i.x,r=i.y,s=i.z,a=Math.sqrt(n*n+r*r+s*s);if(Math.abs(a)<Mi)return null;n*=a=1/a,r*=a,s*=a;var o=Math.sin(t),u=Math.cos(t),h=1-u;return e.m00=n*n*h+u,e.m01=r*n*h+s*o,e.m02=s*n*h-r*o,e.m03=0,e.m04=n*r*h-s*o,e.m05=r*r*h+u,e.m06=s*r*h+n*o,e.m07=0,e.m08=n*s*h+r*o,e.m09=r*s*h-n*o,e.m10=s*s*h+u,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var n=t.x,r=t.y,s=t.z,a=t.w,o=n+n,u=r+r,h=s+s,l=n*o,c=n*u,_=n*h,f=r*u,d=r*h,m=s*h,p=a*o,v=a*u,y=a*h;return e.m00=1-(f+m),e.m01=c+y,e.m02=_-v,e.m03=0,e.m04=c-y,e.m05=1-(l+m),e.m06=d+p,e.m07=0,e.m08=_+v,e.m09=d-p,e.m10=1-(l+f),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=xn.m00=t.m00,n=xn.m01=t.m01,r=xn.m02=t.m02,s=xn.m03=t.m04,a=xn.m04=t.m05,o=xn.m05=t.m06,u=xn.m06=t.m08,h=xn.m07=t.m09,l=xn.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(s*s+a*a+o*o),e.z=Math.sqrt(u*u+h*h+l*l),dn.determinant(xn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,n=0;return i>0?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}},{key:"toRTS",value:function(e,t,i,n){var r=an.set(Rn,e.m00,e.m01,e.m02).length(),s=an.set(Rn,e.m04,e.m05,e.m06).length(),a=an.set(Rn,e.m08,e.m09,e.m10).length();n&&(n.x=r,n.y=s,n.z=a),i&&an.set(i,e.m12,e.m13,e.m14),t&&(xn.m00=e.m00/r,xn.m01=e.m01/r,xn.m02=e.m02/r,xn.m03=e.m04/s,xn.m04=e.m05/s,xn.m05=e.m06/s,xn.m06=e.m08/a,xn.m07=e.m09/a,xn.m08=e.m10/a,dn.determinant(xn)<0&&(n&&(n.x*=-1),xn.m00*=-1,xn.m01*=-1,xn.m02*=-1),vn.fromMat3(t,xn))}},{key:"fromRTS",value:function(e,t,i,n){var r=t.x,s=t.y,a=t.z,o=t.w,u=r+r,h=s+s,l=a+a,c=r*u,_=r*h,f=r*l,d=s*h,m=s*l,p=a*l,v=o*u,y=o*h,g=o*l,S=n.x,A=n.y,T=n.z;return e.m00=(1-(d+p))*S,e.m01=(_+g)*S,e.m02=(f-y)*S,e.m03=0,e.m04=(_-g)*A,e.m05=(1-(c+p))*A,e.m06=(m+v)*A,e.m07=0,e.m08=(f+y)*T,e.m09=(m-v)*T,e.m10=(1-(c+d))*T,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,n,r){var s=t.x,a=t.y,o=t.z,u=t.w,h=s+s,l=a+a,c=o+o,_=s*h,f=s*l,d=s*c,m=a*l,p=a*c,v=o*c,y=u*h,g=u*l,S=u*c,A=n.x,T=n.y,E=n.z,b=r.x,C=r.y,R=r.z;return e.m00=(1-(m+v))*A,e.m01=(f+S)*A,e.m02=(d-g)*A,e.m03=0,e.m04=(f-S)*T,e.m05=(1-(_+v))*T,e.m06=(p+y)*T,e.m07=0,e.m08=(d+g)*E,e.m09=(p-y)*E,e.m10=(1-(_+m))*E,e.m11=0,e.m12=i.x+b-(e.m00*b+e.m04*C+e.m08*R),e.m13=i.y+C-(e.m01*b+e.m05*C+e.m09*R),e.m14=i.z+R-(e.m02*b+e.m06*C+e.m10*R),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,s=t.w,a=i+i,o=n+n,u=r+r,h=i*a,l=n*a,c=n*o,_=r*a,f=r*o,d=r*u,m=s*a,p=s*o,v=s*u;return e.m00=1-c-d,e.m01=l+v,e.m02=_-p,e.m03=0,e.m04=l-v,e.m05=1-h-d,e.m06=f+m,e.m07=0,e.m08=_+p,e.m09=f-m,e.m10=1-h-c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,n,r,s,a){var o=1/(i-t),u=1/(r-n),h=1/(s-a);return e.m00=2*s*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*s*u,e.m06=0,e.m07=0,e.m08=(i+t)*o,e.m09=(r+n)*u,e.m10=(a+s)*h,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*s*2*h,e.m15=0,e}},{key:"perspective",value:function(e,t,i,n,r){var s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:-1,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,h=1/Math.tan(t/2),l=1/(n-r),c=s?h/i:h,_=(s?h:h*i)*o,f=bn[u];return e.m00=c*f[0],e.m01=c*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*n)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*n*l*(1-a),e.m15=0,e}},{key:"ortho",value:function(e,t,i,n,r,s,a){var o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:-1,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,l=1/(t-i),c=1/(n-r)*u,_=1/(s-a),f=-2*l,d=-2*c,m=(t+i)*l,p=(r+n)*c,v=bn[h];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=d*v[2],e.m05=d*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-o),e.m11=0,e.m12=m*v[0]+p*v[2],e.m13=m*v[1]+p*v[3],e.m14=(s-o*a)*_,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,n){var r=t.x,s=t.y,a=t.z,o=n.x,u=n.y,h=n.z,l=r-i.x,c=s-i.y,_=a-i.z,f=1/Math.sqrt(l*l+c*c+_*_),d=u*(_*=f)-h*(c*=f),m=h*(l*=f)-o*_,p=o*c-u*l,v=c*(p*=f=1/Math.sqrt(d*d+m*m+p*p))-_*(m*=f),y=_*(d*=f)-l*p,g=l*m-c*d;return e.m00=d,e.m01=v,e.m02=l,e.m03=0,e.m04=m,e.m05=y,e.m06=c,e.m07=0,e.m08=p,e.m09=g,e.m10=_,e.m11=0,e.m12=-(d*r+m*s+p*a),e.m13=-(v*r+y*s+g*a),e.m14=-(l*r+c*s+_*a),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,s=t.m03,a=t.m04,o=t.m05,u=t.m06,h=t.m07,l=t.m08,c=t.m09,_=t.m10,f=t.m11,d=t.m12,m=t.m13,p=t.m14,v=t.m15,y=i*o-n*a,g=i*u-r*a,S=i*h-s*a,A=n*u-r*o,T=n*h-s*o,E=r*h-s*u,b=l*m-c*d,C=l*p-_*d,R=l*v-f*d,x=c*p-_*m,w=c*v-f*m,k=_*v-f*p,I=y*k-g*w+S*x+A*R-T*C+E*b;return I?(I=1/I,e.m00=(o*k-u*w+h*x)*I,e.m01=(u*R-a*k-h*C)*I,e.m02=(a*w-o*R+h*b)*I,e.m03=0,e.m04=(r*w-n*k-s*x)*I,e.m05=(i*k-r*R+s*C)*I,e.m06=(n*R-i*w-s*b)*I,e.m07=0,e.m08=(m*E-p*T+v*A)*I,e.m09=(p*S-d*E-v*g)*I,e.m10=(d*T-m*S+v*y)*I,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e[i+9]=t.m09,e[i+10]=t.m10,e[i+11]=t.m11,e[i+12]=t.m12,e[i+13]=t.m13,e[i+14]=t.m14,e[i+15]=t.m15,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e.m09=t[i+9],e.m10=t[i+10],e.m11=t[i+11],e.m12=t[i+12],e.m13=t[i+13],e.m14=t[i+14],e.m15=t[i+15],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mi;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=i*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=i*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=i*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=i*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=i*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=i*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=i*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),r}(Mt));Cn.IDENTITY=Object.freeze(new Cn);var Rn=new an,xn=new dn;function wn(e,t,i,n,r,s,a,o,u,h,l,c,_,f,d,m){return new Cn(e,t,i,n,r,s,a,o,u,h,l,c,_,f,d,m)}Ci.fastDefine("cc.Mat4",Cn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),B.Mat4=Cn,B.mat4=wn;var kn,In=e("Vec2",function(e){h(r,e);var t=v(r);function r(e,s){var a;return n(this,r),a=t.call(this),e&&"object"===i(e)?(a.x=e.x,a.y=e.y):(a.x=e||0,a.y=s||0),a}return s(r,[{key:"clone",value:function(){return new r(this.x,this.y)}},{key:"set",value:function(e,t){return e&&"object"===i(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Mi;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mi;return Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){var i=this.x,n=this.y;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this}},{key:"clampf",value:function(e,t){return this.x=Li(this.x,e.x,t.x),this.y=Li(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"add2f",value:function(e,t){return this.x+=e,this.y+=t,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"subtract2f",value:function(e,t){return this.x-=e,this.y-=t,this}},{key:"multiplyScalar",value:function(e){return"object"===i(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this}},{key:"multiply",value:function(e){return"object"!==i(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this}},{key:"multiply2f",value:function(e,t){return this.x*=e,this.y*=t,this}},{key:"divide",value:function(e){return this.x/=e.x,this.y/=e.y,this}},{key:"divide2f",value:function(e,t){return this.x/=e,this.y/=t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=e*e+t*t;return i>0&&(i=1/Math.sqrt(i),this.x*=i,this.y*=i),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return 0;var n=this.dot(e)/Math.sqrt(t*i);return n=Li(n,-1,1),Math.acos(n)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){var t=this.x,i=this.y,n=Math.sin(e),r=Math.cos(e);return this.x=r*t-n*i,this.y=n*t+r*i,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y;return this.x=e.m00*t+e.m04*i+e.m12,this.y=e.m01*t+e.m05*i+e.m13,this}}],[{key:"clone",value:function(e){return new r(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n}},{key:"len",value:function(e){var t=e.x,i=e.y;return Math.sqrt(t*t+i*i)}},{key:"lengthSqr",value:function(e){var t=e.x,i=e.y;return t*t+i*i}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){var i=t.x,n=t.y;return Math.abs(i)<Mi?e.x=0:e.x=1/i,Math.abs(n)<Mi?e.y=0:e.y=1/n,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=i*i+n*n;return r>0?(r=1/Math.sqrt(r),e.x=i*r,e.y=n*r):(e.x=0,e.y=0),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e instanceof an?(e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e):e.x*t.y-e.y*t.x}},{key:"lerp",value:function(e,t,i,n){var r=t.x,s=t.y;return e.x=r+n*(i.x-r),e.y=s+n*(i.y-s),e}},{key:"random",value:function(e,t){t=t||1;var i=2*Ui()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){var n=t.x,r=t.y;return e.x=i.m00*n+i.m03*r+i.m06,e.y=i.m01*n+i.m04*r+i.m07,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y;return e.x=i.m00*n+i.m04*r+i.m12,e.y=i.m01*n+i.m05*r+i.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mi;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,t){var i=e.x*e.x+e.y*e.y,n=t.x*t.x+t.y*t.y;if(0===i||0===n)return 0;var r=(e.x*t.x+e.y*t.y)/Math.sqrt(i*n);return r=Li(r,-1,1),Math.acos(r)}}]),r}(Mt));function Bn(e,t){return new In(e,t)}In.ZERO=Object.freeze(new In(0,0)),In.ONE=Object.freeze(new In(1,1)),In.NEG_ONE=Object.freeze(new In(-1,-1)),In.UNIT_X=Object.freeze(new In(1,0)),In.UNIT_Y=Object.freeze(new In(0,1)),new In,new In,Ci.fastDefine("cc.Vec2",In,{x:0,y:0}),B.Vec2=In,B.v2=Bn,me(In,"Vec2",[{name:"sub",newName:"subtract",target:In,targetName:"Vec2"},{name:"mul",newName:"multiply",target:In,targetName:"Vec2"},{name:"div",newName:"divide",target:In,targetName:"Vec2"},{name:"dist",newName:"distance",target:In,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:In,targetName:"Vec2"},{name:"mag",newName:"len",target:In,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:In,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:In,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:In,targetName:"Vec2"}]),me(In.prototype,"Vec2",[{name:"mag",newName:"length",target:In.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:In.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:In.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:In.prototype,targetName:"Vec2"}]),me(an,"Vec3",[{name:"sub",newName:"subtract",target:an,targetName:"Vec3"},{name:"mul",newName:"multiply",target:an,targetName:"Vec3"},{name:"div",newName:"divide",target:an,targetName:"Vec3"},{name:"dist",newName:"distance",target:an,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:an,targetName:"Vec3"},{name:"mag",newName:"len",target:an,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:an,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:an,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:an,targetName:"Vec3"}]),me(an.prototype,"Vec3",[{name:"mag",newName:"length",target:an.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:an.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:an.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:an.prototype,targetName:"Vec3"}]),me(en,"Vec4",[{name:"sub",newName:"subtract",target:en,targetName:"Vec4"},{name:"mul",newName:"multiply",target:en,targetName:"Vec4"},{name:"div",newName:"divide",target:en,targetName:"Vec4"},{name:"dist",newName:"distance",target:en,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:en,targetName:"Vec4"},{name:"mag",newName:"len",target:en,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:en,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:en,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:en,targetName:"Vec4"}]),me(en.prototype,"Vec4",[{name:"mag",newName:"length",target:en.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:en.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:en.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:en.prototype,targetName:"Vec4"}]),me(vn,"Quat",[{name:"mag",newName:"len",target:vn,targetName:"Quat"},{name:"mul",newName:"multiply",target:vn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:vn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:vn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:vn,targetName:"Quat"}]),me(vn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:vn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:vn.prototype,targetName:"Quat"}]),me(cn,"Color",[{name:"sub",newName:"subtract",target:cn,targetName:"Color"},{name:"mul",newName:"multiply",target:cn,targetName:"Color"},{name:"div",newName:"divide",target:cn,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:cn,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[1].toString(16);return B.Color.fromHEX(t[0],n)}}]),me(dn,"Mat3",[{name:"sub",newName:"subtract",target:dn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:dn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:dn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:dn,targetName:"Mat3"}]),me(dn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:dn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:dn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:dn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:dn.prototype,targetName:"Mat3"}]),me(Cn,"Mat4",[{name:"sub",newName:"subtract",target:Cn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Cn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Cn,targetName:"Mat4"}]),me(Cn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Cn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Cn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Cn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Cn.prototype,targetName:"Mat4"}]),function(e){e[e.VEC2=0]="VEC2",e[e.VEC3=1]="VEC3",e[e.VEC4=2]="VEC4",e[e.QUATERNION=3]="QUATERNION",e[e.MAT3=4]="MAT3",e[e.MAT4=5]="MAT4",e[e.SIZE=6]="SIZE",e[e.RECT=7]="RECT",e[e.COLOR=8]="COLOR"}(kn||(kn={}));var Pn=e("AffineTransform",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;n(this,e),this.a=t,this.b=i,this.c=r,this.d=s,this.tx=a,this.ty=o}return s(e,null,[{key:"identity",value:function(){return new e}},{key:"clone",value:function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)}},{key:"concat",value:function(e,t,i){var n=t.a,r=t.b,s=t.c,a=t.d,o=t.tx,u=t.ty;e.a=n*i.a+r*i.c,e.b=n*i.b+r*i.d,e.c=s*i.a+a*i.c,e.d=s*i.b+a*i.d,e.tx=o*i.a+u*i.c+i.tx,e.ty=o*i.b+u*i.d+i.ty}},{key:"invert",value:function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,i,n){var r,s;n?(r=t,s=i):(n=i,r=t.x,s=t.y),e.x=n.a*r+n.c*s+n.tx,e.y=n.b*r+n.d*s+n.ty}},{key:"transformSize",value:function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}},{key:"transformRect",value:function(e,t,i){var n=t.x+t.width,r=t.y+t.height,s=i.a*t.x+i.c*t.y+i.tx,a=i.b*t.x+i.d*t.y+i.ty,o=i.a*n+i.c*t.y+i.tx,u=i.b*n+i.d*t.y+i.ty,h=i.a*t.x+i.c*r+i.tx,l=i.b*t.x+i.d*r+i.ty,c=i.a*n+i.c*r+i.tx,_=i.b*n+i.d*r+i.ty,f=Math.min(s,o,h,c),d=Math.max(s,o,h,c),m=Math.min(a,u,l,_),p=Math.max(a,u,l,_);e.x=f,e.y=m,e.width=d-f,e.height=p-m}},{key:"transformObb",value:function(e,t,i,n,r,s){var a=s.a*r.x+s.c*r.y+s.tx,o=s.b*r.x+s.d*r.y+s.ty,u=s.a*r.width,h=s.b*r.width,l=s.c*r.height,c=s.d*r.height;t.x=a,t.y=o,i.x=u+a,i.y=h+o,e.x=l+a,e.y=c+o,n.x=u+l+a,n.y=h+c+o}}]),e}());B.AffineTransform=Pn;var Mn=e("Size",function(e){h(r,e);var t=v(r);function r(e,s){var a;return n(this,r),a=t.call(this),e&&"object"===i(e)?(a.width=e.width,a.height=e.height):(a.width=e||0,a.height=s||0),a}return s(r,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}},{key:"clone",value:function(){return new r(this.width,this.height)}},{key:"set",value:function(e,t){return e&&"object"===i(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}],[{key:"lerp",value:function(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}}]),r}(Mt));function On(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new Mn(e,t)}Mn.ZERO=Object.freeze(new Mn(0,0)),Mn.ONE=Object.freeze(new Mn(1,1)),Ci.fastDefine("cc.Size",Mn,{width:0,height:0}),B.size=On,B.Size=Mn;var Dn=e("Rect",function(e){h(r,e);var t=v(r);function r(e,s,a,o){var u;return n(this,r),u=t.call(this),e&&"object"===i(e)?(u.y=e.y,u.width=e.width,u.height=e.height,u.x=e.x):(u.x=e||0,u.y=s||0,u.width=a||0,u.height=o||0),u}return s(r,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new In(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new In(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new Mn(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}},{key:"clone",value:function(){return new r(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,t,n,r){return e&&"object"===i(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=r||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){var i=this.x,n=this.y,r=this.width,s=this.height;return this.x=i+(e.x-i)*t,this.y=n+(e.y-n)*t,this.width=r+(e.width-r)*t,this.height=s+(e.height-s)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=t+this.width,r=i+this.height,s=e.m00*t+e.m04*i+e.m12,a=e.m01*t+e.m05*i+e.m13,o=e.m00*n+e.m04*i+e.m12,u=e.m01*n+e.m05*i+e.m13,h=e.m00*t+e.m04*r+e.m12,l=e.m01*t+e.m05*r+e.m13,c=e.m00*n+e.m04*r+e.m12,_=e.m01*n+e.m05*r+e.m13,f=Math.min(s,o,h,c),d=Math.max(s,o,h,c),m=Math.min(a,u,l,_),p=Math.max(a,u,l,_);return this.x=f,this.y=m,this.width=d-f,this.height=p-m,this}},{key:"transformMat4ToPoints",value:function(e,t,i,n,r){var s=this.x,a=this.y,o=s+this.width,u=a+this.height;t.x=e.m00*s+e.m04*a+e.m12,t.y=e.m01*s+e.m05*a+e.m13,r.x=e.m00*o+e.m04*a+e.m12,r.y=e.m01*o+e.m05*a+e.m13,i.x=e.m00*s+e.m04*u+e.m12,i.y=e.m01*s+e.m05*u+e.m13,n.x=e.m00*o+e.m04*u+e.m12,n.y=e.m01*o+e.m05*u+e.m13}}],[{key:"fromMinMax",value:function(e,t,i){var n=Math.min(t.x,i.x),r=Math.min(t.y,i.y),s=Math.max(t.x,i.x),a=Math.max(t.y,i.y);return e.x=n,e.y=r,e.width=s-n,e.height=a-r,e}},{key:"lerp",value:function(e,t,i,n){var r=t.x,s=t.y,a=t.width,o=t.height;return e.x=r+(i.x-r)*n,e.y=s+(i.y-s)*n,e.width=a+(i.width-a)*n,e.height=o+(i.height-o)*n,e}},{key:"intersection",value:function(e,t,i){var n=t.x,r=t.y,s=t.x+t.width,a=t.y+t.height,o=i.x,u=i.y,h=i.x+i.width,l=i.y+i.height;return e.x=Math.max(n,o),e.y=Math.max(r,u),e.width=Math.min(s,h)-e.x,e.height=Math.min(a,l)-e.y,e}},{key:"union",value:function(e,t,i){var n=t.x,r=t.y,s=t.width,a=t.height,o=i.x,u=i.y,h=i.width,l=i.height;return e.x=Math.min(n,o),e.y=Math.min(r,u),e.width=Math.max(n+s,o+h)-e.x,e.height=Math.max(r+a,u+l)-e.y,e}}]),r}(Mt));function Ln(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return new Dn(e,t,i,n)}Ci.fastDefine("cc.Rect",Dn,{x:0,y:0,width:0,height:0}),B.Rect=Dn,B.rect=Ln;var Nn=e("MATH_FLOAT_ARRAY",Float64Array),Fn=e("MathBase",function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"array",get:function(){return this._array}}],[{key:"createFloatArray",value:function(e){return new Nn(e)}}]),i}(Mt)),Gn=Object.freeze({__proto__:null,bits:G,Vec2:In,v2:Bn,Vec3:an,v3:on,Vec4:en,v4:tn,Quat:vn,quat:En,Mat3:dn,Mat4:Cn,mat4:wn,AffineTransform:Pn,Size:Mn,size:On,Rect:Dn,rect:Ln,Color:cn,color:_n,preTransforms:bn,HALF_PI:Bi,TWO_PI:Pi,EPSILON:Mi,equals:Oi,approx:Di,clamp:Li,clamp01:Ni,lerp:Fi,toRadian:Gi,toDegree:Vi,random:Ui,randomRange:Hi,randomRangeInt:zi,pseudoRandom:Wi,pseudoRandomRange:Xi,pseudoRandomRangeInt:ji,nextPow2:qi,repeat:Yi,pingPong:Ki,inverseLerp:Qi,absMaxComponent:Ji,absMax:Zi,enumerableProps:$i,MATH_FLOAT_ARRAY:Nn,MathBase:Fn});e("math",Gn);var Vn=new an,Un=new an,Hn=new an,zn=new an,Wn=new an,Xn=new an,jn=new Array(3),qn=new Array(3);function Yn(e,t){return an.dot(t.n,e)-t.d}function Kn(e,t,i){return an.copy(e,t),an.subtract(Wn,i.center,i.halfExtents),an.add(Xn,i.center,i.halfExtents),e.x=e.x<Wn.x?Wn.x:e.x,e.y=e.y<Wn.y?Wn.y:e.y,e.z=e.z<Wn.z?Wn.z:e.z,e.x=e.x>Xn.x?Xn.x:e.x,e.y=e.y>Xn.y?Xn.y:e.y,e.z=e.z>Xn.z?Xn.z:e.z,e}function Qn(e,t,i){an.set(Vn,i.orientation.m00,i.orientation.m01,i.orientation.m02),an.set(Un,i.orientation.m03,i.orientation.m04,i.orientation.m05),an.set(Hn,i.orientation.m06,i.orientation.m07,i.orientation.m08),jn[0]=Vn,jn[1]=Un,jn[2]=Hn,qn[0]=i.halfExtents.x,qn[1]=i.halfExtents.y,qn[2]=i.halfExtents.z,an.subtract(zn,t,i.center),an.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=an.dot(zn,jn[n]);r>qn[n]&&(r=qn[n]),r<-qn[n]&&(r=-qn[n]),e.x+=r*jn[n].x,e.y+=r*jn[n].y,e.z+=r*jn[n].z}return e}var Jn=Object.freeze({__proto__:null,point_plane:Yn,pt_point_plane:function(e,t,i){var n=Yn(t,i);return an.subtract(e,t,an.multiplyScalar(e,i.n,n))},pt_point_aabb:Kn,pt_point_obb:Qn,pt_point_line:function(e,t,i,n){an.subtract(Vn,i,n);var r=Vn,s=an.lengthSqr(r);if(0===s)an.copy(e,i);else{an.subtract(Vn,t,i);var a=an.dot(Vn,r)/s;a<0?an.copy(e,i):a>1?an.copy(e,n):an.scaleAndAdd(e,i,r,a)}}}),Zn={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512,SHAPE_SPLINE:1024},$n=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;n(this,e),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Zn.SHAPE_LINE,this.s=new an(t,i,r),this.e=new an(s,a,o)}return s(e,[{key:"type",get:function(){return this._type}},{key:"length",value:function(){return an.distance(this.s,this.e)}}],[{key:"create",value:function(t,i,n,r,s,a){return new e(t,i,n,r,s,a)}},{key:"clone",value:function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}},{key:"copy",value:function(e,t){return an.copy(e.s,t.s),an.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return an.copy(e.s,t),an.copy(e.e,i),e}},{key:"set",value:function(e,t,i,n,r,s,a){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=s,e.e.z=a,e}},{key:"len",value:function(e){return an.distance(e.s,e.e)}}]),e}(),er=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;n(this,e),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Zn.SHAPE_RAY,this.o=new an(t,i,r),this.d=new an(s,a,o)}return s(e,[{key:"type",get:function(){return this._type}},{key:"computeHit",value:function(e,t){an.normalize(e,this.d),an.scaleAndAdd(e,this.o,e,t)}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;return new e(t,i,n,r,s,a)}},{key:"clone",value:function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}},{key:"copy",value:function(e,t){return an.copy(e.o,t.o),an.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return an.copy(e.o,t),an.normalize(e.d,an.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,n,r,s,a){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=s,e.d.z=a,e}}]),e}(),tr=new an,ir=new an,nr=new an,rr=new an;function sr(e){return Math.max(Math.max(e.x,e.y),e.z)}var ar,or,ur,hr,lr,cr,_r,fr,dr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;n(this,e),this._center=new an(0,0,0),this._radius=0,this._type=void 0,this._type=Zn.SHAPE_SPHERE,this._center=new an(t,i,r),this._radius=s}return s(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}},{key:"destroy",value:function(){}},{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}},{key:"getBoundary",value:function(e,t){an.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),an.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,n,r){an.transformMat4(r.center,this.center,e),r.radius=this.radius*sr(n)}},{key:"translateAndRotate",value:function(e,t,i){an.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*sr(e)}},{key:"mergePoint",value:function(e){this.radius<0&&(this.center.set(e),this.radius=0),an.subtract(ir,e,this.center);var t=ir.length();if(t>this.radius){var i=.5*(t-this.radius);this.radius+=i,an.multiplyScalar(ir,ir,i/t),an.add(this.center,this.center,ir)}}},{key:"mergePoints",value:function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var i=0;i<t;i++)this.mergePoint(e[i])}}},{key:"mergeAABB",value:function(e){e.getBoundary(nr,rr),this.mergePoint(nr),this.mergePoint(rr)}}],[{key:"create",value:function(t,i,n,r){return new e(t,i,n,r)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)}},{key:"copy",value:function(e,t){return an.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return an.multiplyScalar(e.center,an.add(tr,t,i),.5),e.radius=.5*an.subtract(tr,i,t).length(),e}},{key:"set",value:function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e}}]),e}(),mr=(ar=new an(0,0,0),function(e,t){var i=an.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;an.multiplyScalar(ar,t.n,t.d);var n=an.dot(an.subtract(ar,ar,e.o),t.n)/i;return n<0?0:n}),pr=(or=new an(0,0,0),ur=new an(0,0,0),hr=new an(0,0,0),lr=new an(0,0,0),cr=new an(0,0,0),function(e,t,i){an.subtract(or,t.b,t.a),an.subtract(ur,t.c,t.a),an.cross(hr,e.d,ur);var n=an.dot(or,hr);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;an.subtract(lr,e.o,t.a);var s=an.dot(lr,hr)*r;if(s<0||s>1)return 0;an.cross(cr,lr,or);var a=an.dot(e.d,cr)*r;if(a<0||s+a>1)return 0;var o=an.dot(ur,cr)*r;return o<0?0:o}),vr=function(){var e=new an(0,0,0);return function(t,i){var n=i.radius,r=i.center,s=t.o,a=t.d,o=n*n;an.subtract(e,r,s);var u=e.lengthSqr(),h=an.dot(e,a),l=o-(u-h*h);if(l<0)return 0;var c=Math.sqrt(l),_=u<o?h+c:h-c;return _<0?0:_}}(),yr=(_r=new an,fr=new an,function(e,t){return an.subtract(_r,t.center,t.halfExtents),an.add(fr,t.center,t.halfExtents),function(e,t,i){var n=e.o,r=e.d,s=1/r.x,a=1/r.y,o=1/r.z,u=(t.x-n.x)*s,h=(i.x-n.x)*s,l=(t.y-n.y)*a,c=(i.y-n.y)*a,_=(t.z-n.z)*o,f=(i.z-n.z)*o,d=Math.max(Math.max(Math.min(u,h),Math.min(l,c)),Math.min(_,f)),m=Math.min(Math.min(Math.max(u,h),Math.max(l,c)),Math.max(_,f));return m<0||d>m?0:d>0?d:m}(e,_r,fr)}),gr=function(){var e=new an,t=new an,i=new an,n=new an,r=new an,s=new an,a=new an,o=new Array(3),u=new Array(3),h=new Array(3),l=new Array(6);return function(c,_){o[0]=_.halfExtents.x,o[1]=_.halfExtents.y,o[2]=_.halfExtents.z,e=_.center,t=c.o,i=c.d,an.set(n,_.orientation.m00,_.orientation.m01,_.orientation.m02),an.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),an.set(s,_.orientation.m06,_.orientation.m07,_.orientation.m08),an.subtract(a,e,t),u[0]=an.dot(n,i),u[1]=an.dot(r,i),u[2]=an.dot(s,i),h[0]=an.dot(n,a),h[1]=an.dot(r,a),h[2]=an.dot(s,a);for(var f=0;f<3;++f){if(0===u[f]){if(-h[f]-o[f]>0||-h[f]+o[f]<0)return 0;u[f]=1e-7}l[2*f+0]=(h[f]+o[f])/u[f],l[2*f+1]=(h[f]-o[f])/u[f]}var d=Math.max(Math.max(Math.min(l[0],l[1]),Math.min(l[2],l[3])),Math.min(l[4],l[5])),m=Math.min(Math.min(Math.max(l[0],l[1]),Math.max(l[2],l[3])),Math.max(l[4],l[5]));return m<0||d>m?0:d>0?d:m}}(),Sr=function(){var e=new an,t=new an,i=new an,n=new an,r=new an,s=new an,a=new an,o=new dr;return function(u,h){var l=h.radius*h.radius,c=an.normalize(e,u.d),_=h.ellipseCenter0,f=h.ellipseCenter1,d=an.subtract(t,f,_);if(d.equals(an.ZERO))return o.radius=h.radius,o.center.set(h.ellipseCenter0),is.raySphere(u,o);var m=u.o,p=an.subtract(i,m,_),v=an.cross(n,c,d),y=v.lengthSqr();if(0===y){o.radius=h.radius;var g=an.subtract(r,f,m);return p.lengthSqr()<g.lengthSqr()?o.center.set(h.ellipseCenter0):o.center.set(h.ellipseCenter1),is.raySphere(u,o)}var S=an.cross(r,p,d),A=d.lengthSqr(),T=2*an.dot(v,S),E=T*T-4*y*(S.lengthSqr()-l*A);if(E<0)return 0;var b=(-T-Math.sqrt(E))/(2*y);if(b<0){o.radius=h.radius;var C=an.subtract(s,f,m);return p.lengthSqr()<C.lengthSqr()?o.center.set(h.ellipseCenter0):o.center.set(h.ellipseCenter1),is.raySphere(u,o)}var R=an.scaleAndAdd(s,u.o,c,b),x=an.subtract(a,R,_),w=an.dot(x,d)/A;return w>=0&&w<=1?b:w<0?(o.radius=h.radius,o.center.set(h.ellipseCenter0),is.raySphere(u,o)):w>1?(o.radius=h.radius,o.center.set(h.ellipseCenter1),is.raySphere(u,o)):0}}(),Ar=function(){var e=new an(0,0,0);return function(t,i){an.subtract(e,t.e,t.s);var n=(i.d-an.dot(t.s,i.n))/an.dot(e,i.n);return n<0||n>1?0:n}}(),Tr=function(){var e=new an(0,0,0),t=new an(0,0,0),i=new an(0,0,0),n=new an(0,0,0),r=new an(0,0,0),s=new an(0,0,0);return function(a,o,u){an.subtract(e,o.b,o.a),an.subtract(t,o.c,o.a),an.subtract(i,a.s,a.e),an.cross(r,e,t);var h=an.dot(i,r);if(h<=0)return 0;an.subtract(n,a.s,o.a);var l=an.dot(n,r);if(l<0||l>h)return 0;an.cross(s,i,n);var c=an.dot(t,s);if(c<0||c>h)return 0;var _=-an.dot(e,s);if(_<0||c+_>h)return 0;if(u){var f=1/h,d=1-(c*=f)-(_*=f);an.set(u,o.a.x*d+o.b.x*c+o.c.x*_,o.a.y*d+o.b.y*c+o.c.y*_,o.a.z*d+o.b.z*c+o.c.z*_)}return 1}}(),Er=new er;function br(e,t){Er.o.set(e.s),an.subtract(Er.d,e.e,e.s),Er.d.normalize();var i=yr(Er,t);return i<=e.length()?i:0}function Cr(e,t){Er.o.set(e.s),an.subtract(Er.d,e.e,e.s),Er.d.normalize();var i=gr(Er,t);return i<=e.length()?i:0}function Rr(e,t){Er.o.set(e.s),an.subtract(Er.d,e.e,e.s),Er.d.normalize();var i=vr(Er,t);return i<=e.length()?i:0}var wr,kr,Ir,Br,Pr=(wr=new an,kr=new an,Ir=new an,Br=new an,function(e,t){return an.subtract(wr,e.center,e.halfExtents),an.add(kr,e.center,e.halfExtents),an.subtract(Ir,t.center,t.halfExtents),an.add(Br,t.center,t.halfExtents),wr.x<=Br.x&&kr.x>=Ir.x&&wr.y<=Br.y&&kr.y>=Ir.y&&wr.z<=Br.z&&kr.z>=Ir.z});function Mr(e,t,i,n,r,s){an.set(s[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),an.set(s[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),an.set(s[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),an.set(s[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),an.set(s[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),an.set(s[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),an.set(s[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),an.set(s[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function Or(e,t){for(var i=an.dot(t,e[0]),n=i,r=1;r<8;++r){var s=an.dot(t,e[r]);i=s<i?s:i,n=s>n?s:n}return[i,n]}var Dr,Lr,Nr,Fr=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new an(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new an(0,0,0),n[r]=new an(0,0,0);var s=new an,a=new an;return function(t,r){an.set(e[0],1,0,0),an.set(e[1],0,1,0),an.set(e[2],0,0,1),an.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),an.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),an.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)an.cross(e[6+3*o],e[o],e[3]),an.cross(e[7+3*o],e[o],e[4]),an.cross(e[7+3*o],e[o],e[5]);an.subtract(s,t.center,t.halfExtents),an.add(a,t.center,t.halfExtents),function(e,t,i){an.set(i[0],e.x,t.y,t.z),an.set(i[1],e.x,t.y,e.z),an.set(i[2],e.x,e.y,t.z),an.set(i[3],e.x,e.y,e.z),an.set(i[4],t.x,t.y,t.z),an.set(i[5],t.x,t.y,e.z),an.set(i[6],t.x,e.y,t.z),an.set(i[7],t.x,e.y,e.z)}(s,a,i),Mr(r.center,r.halfExtents,e[3],e[4],e[5],n);for(var u=0;u<15;++u){var h=Or(i,e[u]),l=Or(n,e[u]);if(l[0]>h[1]||h[0]>l[1])return 0}return 1}}(),Gr=function(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=an.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1},Vr=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Gr(e,t.planes[i]))return 0;return 1},Ur=function(){for(var e=new Array(8),t=0,i=0,n=0;n<e.length;n++)e[n]=new an(0,0,0);return function(n,r){for(var s=0,a=!1,o=0;o<r.planes.length;o++){if(-1===(s=Gr(n,r.planes[o])))return 0;1===s&&(a=!0)}if(!a)return 1;for(var u=0;u<r.vertices.length;u++)an.subtract(e[u],r.vertices[u],n.center);t=0,i=0;for(var h=0;h<r.vertices.length;h++)e[h].x>n.halfExtents.x?t++:e[h].x<-n.halfExtents.x&&i++;if(t===r.vertices.length||i===r.vertices.length)return 0;t=0,i=0;for(var l=0;l<r.vertices.length;l++)e[l].y>n.halfExtents.y?t++:e[l].y<-n.halfExtents.y&&i++;if(t===r.vertices.length||i===r.vertices.length)return 0;t=0,i=0;for(var c=0;c<r.vertices.length;c++)e[c].z>n.halfExtents.z?t++:e[c].z<-n.halfExtents.z&&i++;return t===r.vertices.length||i===r.vertices.length?0:1}}(),Hr=(Dr=new an(0,0,0),Lr=new dn,function(e,t){return an.subtract(Dr,t,e.center),an.transformMat3(Dr,Dr,dn.transpose(Lr,e.orientation)),i=Dr,n=e.halfExtents,Math.abs(i.x)<n.x&&Math.abs(i.y)<n.y&&Math.abs(i.z)<n.z;var i,n}),zr=(Nr=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)},function(e,t){var i=e.halfExtents.x*Nr(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Nr(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Nr(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=an.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}),Wr=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===zr(e,t.planes[i]))return 0;return 1},Xr=function(){for(var e=new Array(8),t=0,i=0,n=0,r=0;r<e.length;r++)e[r]=new an(0,0,0);var s=function(e,t,i,n){return e.x*t+e.y*i+e.z*n};return function(r,a){for(var o=0,u=!1,h=0;h<a.planes.length;h++){if(-1===(o=zr(r,a.planes[h])))return 0;1===o&&(u=!0)}if(!u)return 1;for(var l=0;l<a.vertices.length;l++)an.subtract(e[l],a.vertices[l],r.center);i=0,n=0;for(var c=0;c<a.vertices.length;c++)(t=s(e[c],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?i++:t<-r.halfExtents.x&&n++;if(i===a.vertices.length||n===a.vertices.length)return 0;i=0,n=0;for(var _=0;_<a.vertices.length;_++)(t=s(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?i++:t<-r.halfExtents.y&&n++;if(i===a.vertices.length||n===a.vertices.length)return 0;i=0,n=0;for(var f=0;f<a.vertices.length;f++)(t=s(e[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?i++:t<-r.halfExtents.z&&n++;return i===a.vertices.length||n===a.vertices.length?0:1}}(),jr=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new an(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new an(0,0,0),n[r]=new an(0,0,0);return function(t,r){an.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),an.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),an.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),an.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),an.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),an.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)an.cross(e[6+3*s],e[s],e[3]),an.cross(e[7+3*s],e[s],e[4]),an.cross(e[8+3*s],e[s],e[5]);Mr(t.center,t.halfExtents,e[0],e[1],e[2],i),Mr(r.center,r.halfExtents,e[3],e[4],e[5],n);for(var a=0;a<15;++a){var o=Or(i,e[a]),u=Or(n,e[a]);if(u[0]>o[1]||o[0]>u[1])return 0}return 1}}(),qr=function(){for(var e=new dr,t=new an,i=new an,n=new an,r=new Array(8),s=0;s<8;s++)r[s]=new an;for(var a=new Array(8),o=0;o<8;o++)a[o]=new an;return function(s,o){if(0===an.squaredDistance(o.ellipseCenter0,o.ellipseCenter1))return e.radius=o.radius,e.center.set(o.ellipseCenter0),is.sphereOBB(e,s);t.x=s.orientation.m00,t.y=s.orientation.m01,t.z=s.orientation.m02,i.x=s.orientation.m03,i.y=s.orientation.m04,i.z=s.orientation.m05,n.x=s.orientation.m06,n.y=s.orientation.m07,n.z=s.orientation.m08,Mr(s.center,s.halfExtents,t,i,n,r);var u=a,h=an.copy(u[0],t),l=an.copy(u[1],i),c=an.copy(u[2],n);an.subtract(u[3],o.center,s.center).normalize();var _=an.subtract(u[4],o.ellipseCenter0,o.ellipseCenter1);_.normalize(),an.cross(u[5],h,_),an.cross(u[6],l,_),an.cross(u[7],c,_);for(var f=0;f<8;++f){var d=Or(r,u[f]),m=an.dot(u[f],o.ellipseCenter0),p=an.dot(u[f],o.ellipseCenter1),v=Math.max(m,p),y=Math.min(m,p)-o.radius,g=v+o.radius;if(y>d[1]||d[0]>g)return 0}return 1}}(),Yr=function(e,t){var i=an.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1},Kr=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Yr(e,t.planes[i]))return 0;return 1},Qr=function(){var e=new an(0,0,0),t=[1,-1,1,-1,1,-1];return function(i,n){for(var r=0;r<6;r++){var s=n.planes[r],a=i.radius,o=i.center,u=s.n,h=s.d,l=an.dot(u,o);if(l+a<h)return 0;if(!(l-a>h)){an.add(e,o,an.multiplyScalar(e,u,a));for(var c=0;c<6;c++)if(c!==r&&c!==r+t[r]){var _=n.planes[c];if(an.dot(_.n,e)<_.d)return 0}}}return 1}}(),Jr=function(e,t){var i=e.radius+t.radius;return an.squaredDistance(e.center,t.center)<i*i},Zr=function(){var e=new an;return function(t,i){return Kn(e,t.center,i),an.squaredDistance(t.center,e)<t.radius*t.radius}}(),$r=function(){var e=new an;return function(t,i){return Qn(e,t.center,i),an.squaredDistance(t.center,e)<t.radius*t.radius}}(),es=function(){var e=new an,t=new an;return function(i,n){var r=i.radius+n.radius,s=r*r,a=an.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===a)return an.squaredDistance(i.center,n.center)<s;an.subtract(e,i.center,n.ellipseCenter0),an.subtract(t,n.ellipseCenter1,n.ellipseCenter0);var o=an.dot(e,t)/a;return o<0?an.squaredDistance(i.center,n.ellipseCenter0)<s:o>1?an.squaredDistance(i.center,n.ellipseCenter1)<s:(an.scaleAndAdd(e,n.ellipseCenter0,t,o),an.squaredDistance(i.center,e)<s)}}(),ts=function(){var e=new an,t=new an,i=new an,n=new an,r=new an,s=new an;return function(a,o){var u,h,l=an.subtract(e,a.ellipseCenter1,a.ellipseCenter0),c=an.subtract(t,o.ellipseCenter1,o.ellipseCenter0),_=an.subtract(i,a.ellipseCenter0,o.ellipseCenter0),f=an.dot(l,l),d=an.dot(l,c),m=an.dot(c,c),p=an.dot(l,_),v=an.dot(c,_),y=f*m-d*d,g=y,S=y;y<Mi?(u=0,g=1,h=v,S=m):(h=f*v-d*p,(u=d*v-m*p)<0?(u=0,h=v,S=m):u>g&&(u=g,h=v+d,S=m)),h<0?(h=0,-p<0?u=0:-p>f?u=g:(u=-p,g=f)):h>S&&(h=S,-p+d<0?u=0:-p+d>f?u=g:(u=-p+d,g=f));var A=Math.abs(u)<Mi?0:u/g,T=Math.abs(h)<Mi?0:h/S,E=n;E.set(_),E.add(an.multiplyScalar(r,l,A)),E.subtract(an.multiplyScalar(s,c,T));var b=a.radius+o.radius;return E.lengthSqr()<b*b}}(),is={raySphere:vr,rayAABB:yr,rayOBB:gr,rayPlane:mr,rayTriangle:pr,rayCapsule:Sr,raySubMesh:null,rayMesh:null,rayModel:null,lineSphere:Rr,lineAABB:br,lineOBB:Cr,linePlane:Ar,lineTriangle:Tr,sphereWithSphere:Jr,sphereAABB:Zr,sphereOBB:$r,spherePlane:Yr,sphereFrustum:Kr,sphereFrustumAccurate:Qr,sphereCapsule:es,aabbWithAABB:Pr,aabbWithOBB:Fr,aabbPlane:Gr,aabbFrustum:Vr,aabbFrustumAccurate:Ur,obbWithOBB:jr,obbPlane:zr,obbFrustum:Wr,obbFrustumAccurate:Xr,obbPoint:Hr,obbCapsule:qr,aabbFrustumCompletelyInside:function(e,t){for(var i=0;i<t.planes.length;i++)if(0!==Gr(e,t.planes[i]))return 0;return 1},capsuleWithCapsule:ts,resolve:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=e._type,r=t._type,s=this[n|r];return n<r?s(e,t,i):s(t,e,i)}};is[Zn.SHAPE_RAY|Zn.SHAPE_SPHERE]=vr,is[Zn.SHAPE_RAY|Zn.SHAPE_AABB]=yr,is[Zn.SHAPE_RAY|Zn.SHAPE_OBB]=gr,is[Zn.SHAPE_RAY|Zn.SHAPE_PLANE]=mr,is[Zn.SHAPE_RAY|Zn.SHAPE_TRIANGLE]=pr,is[Zn.SHAPE_RAY|Zn.SHAPE_CAPSULE]=Sr,is[Zn.SHAPE_LINE|Zn.SHAPE_SPHERE]=Rr,is[Zn.SHAPE_LINE|Zn.SHAPE_AABB]=br,is[Zn.SHAPE_LINE|Zn.SHAPE_OBB]=Cr,is[Zn.SHAPE_LINE|Zn.SHAPE_PLANE]=Ar,is[Zn.SHAPE_LINE|Zn.SHAPE_TRIANGLE]=Tr,is[Zn.SHAPE_SPHERE]=Jr,is[Zn.SHAPE_SPHERE|Zn.SHAPE_AABB]=Zr,is[Zn.SHAPE_SPHERE|Zn.SHAPE_OBB]=$r,is[Zn.SHAPE_SPHERE|Zn.SHAPE_PLANE]=Yr,is[Zn.SHAPE_SPHERE|Zn.SHAPE_FRUSTUM]=Kr,is[Zn.SHAPE_SPHERE|Zn.SHAPE_FRUSTUM_ACCURATE]=Qr,is[Zn.SHAPE_SPHERE|Zn.SHAPE_CAPSULE]=es,is[Zn.SHAPE_AABB]=Pr,is[Zn.SHAPE_AABB|Zn.SHAPE_OBB]=Fr,is[Zn.SHAPE_AABB|Zn.SHAPE_PLANE]=Gr,is[Zn.SHAPE_AABB|Zn.SHAPE_FRUSTUM]=Vr,is[Zn.SHAPE_AABB|Zn.SHAPE_FRUSTUM_ACCURATE]=Ur,is[Zn.SHAPE_OBB]=jr,is[Zn.SHAPE_OBB|Zn.SHAPE_PLANE]=zr,is[Zn.SHAPE_OBB|Zn.SHAPE_FRUSTUM]=Wr,is[Zn.SHAPE_OBB|Zn.SHAPE_FRUSTUM_ACCURATE]=Xr,is[Zn.SHAPE_OBB|Zn.SHAPE_CAPSULE]=qr,is[Zn.SHAPE_CAPSULE]=ts,me($n.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),pe(is,"intersect",[{name:"line_quad"}]);var ns=new an(0,0,0),rs=new an(0,0,0),ss=B.mat4(),as=B.v4(),os=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;n(this,e),this.n=void 0,this._type=Zn.SHAPE_PLANE,this.n=new an(t,i,r),this.d=s}return s(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}},{key:"transform",value:function(e){Cn.invert(ss,e),Cn.transpose(ss,ss),en.set(as,this.n.x,this.n.y,this.n.z,this.d),en.transformMat4(as,as,ss),an.set(this.n,as.x,as.y,as.z),this.d=as.w}}],[{key:"create",value:function(t,i,n,r){return new e(t,i,n,r)}},{key:"clone",value:function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)}},{key:"copy",value:function(e,t){return an.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,n){return an.subtract(ns,i,t),an.subtract(rs,n,t),an.normalize(e.n,an.cross(e.n,ns,rs)),e.d=an.dot(e.n,t),e}},{key:"set",value:function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return an.copy(e.n,t),e.d=an.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=t.n.length();return an.normalize(e.n,t.n),i>0&&(e.d=t.d/i),e}}]),e}(),us=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;n(this,e),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Zn.SHAPE_TRIANGLE,this.a=new an(t,i,r),this.b=new an(s,a,o),this.c=new an(u,h,l)}return s(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return new e(t,i,n,r,s,a,o,u,h)}},{key:"clone",value:function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}},{key:"copy",value:function(e,t){return an.copy(e.a,t.a),an.copy(e.b,t.b),an.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,n){return an.copy(e.a,t),an.copy(e.b,i),an.copy(e.c,n),e}},{key:"set",value:function(e,t,i,n,r,s,a,o,u,h){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=s,e.b.z=a,e.c.x=o,e.c.y=u,e.c.z=h,e}}]),e}(),hs=new an,ls=new an,cs=new an,_s=new an,fs=new dn,ds=function(e,t,i){fs.m00=Math.abs(i.m00),fs.m01=Math.abs(i.m01),fs.m02=Math.abs(i.m02),fs.m03=Math.abs(i.m04),fs.m04=Math.abs(i.m05),fs.m05=Math.abs(i.m06),fs.m06=Math.abs(i.m08),fs.m07=Math.abs(i.m09),fs.m08=Math.abs(i.m10),an.transformMat3(e,t,fs)},ms=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;n(this,e),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=Zn.SHAPE_AABB,this.center=new an(t,i,r),this.halfExtents=new an(s,a,o)}return s(e,[{key:"type",get:function(){return this._type}},{key:"getBoundary",value:function(e,t){an.subtract(e,this.center,this.halfExtents),an.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,n,r){an.transformMat4(r.center,this.center,e),ds(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}},{key:"mergePoint",value:function(e){this.getBoundary(hs,ls),e.x<hs.x&&(hs.x=e.x),e.y<hs.y&&(hs.y=e.y),e.z<hs.z&&(hs.z=e.z),e.x>ls.x&&(ls.x=e.x),e.y>ls.y&&(ls.y=e.y),e.z>ls.z&&(ls.z=e.z),an.add(cs,hs,ls),this.center.set(an.multiplyScalar(cs,cs,.5)),this.halfExtents.set(ls.x-cs.x,ls.y-cs.y,ls.z-cs.z)}},{key:"mergePoints",value:function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])}},{key:"mergeFrustum",value:function(e){this.mergePoints(e.vertices)}}],[{key:"create",value:function(t,i,n,r,s,a){return new e(t,i,n,r,s,a)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}},{key:"copy",value:function(e,t){return an.copy(e.center,t.center),an.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return an.add(hs,i,t),an.subtract(ls,i,t),an.multiplyScalar(e.center,hs,.5),an.multiplyScalar(e.halfExtents,ls,.5),e}},{key:"set",value:function(e,t,i,n,r,s,a){return e.center.set(t,i,n),e.halfExtents.set(r,s,a),e}},{key:"merge",value:function(t,i,n){return an.subtract(hs,i.center,i.halfExtents),an.subtract(ls,n.center,n.halfExtents),an.add(cs,i.center,i.halfExtents),an.add(_s,n.center,n.halfExtents),an.max(_s,cs,_s),an.min(cs,hs,ls),e.fromPoints(t,cs,_s)}},{key:"toBoundingSphere",value:function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e}},{key:"transform",value:function(e,t,i){return an.transformMat4(e.center,t.center,i),ds(e.halfExtents,t.halfExtents,i),e}}]),e}(),ps=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;n(this,e),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Zn.SHAPE_CAPSULE,this.radius=t,this.halfHeight=i,this.axis=r,this.center=new an,this.rotation=new vn,this.ellipseCenter0=new an(0,i,0),this.ellipseCenter1=new an(0,-i,0),this.updateCache()}return s(e,[{key:"type",get:function(){return this._type}},{key:"transform",value:function(e,t,i,n,r){var s=n,a=Ji(s);r.radius=this.radius*Math.abs(a);var o=(this.halfHeight+this.radius)*Math.abs(s.y)-r.radius;o<0&&(o=0),r.halfHeight=o,an.transformMat4(r.center,this.center,e),vn.multiply(r.rotation,this.rotation,i),r.updateCache()}},{key:"updateCache",value:function(){this.updateLocalCenter(),an.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),an.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}},{key:"updateLocalCenter",value:function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}}}]),e}(),vs=new Array(8);vs[0]=new an(1,1,1),vs[1]=new an(-1,1,1),vs[2]=new an(-1,-1,1),vs[3]=new an(1,-1,1),vs[4]=new an(1,1,-1),vs[5]=new an(-1,1,-1),vs[6]=new an(-1,-1,-1),vs[7]=new an(1,-1,-1);var ys,gs=new an,Ss=new an,As=new an,Ts=function(){function e(){n(this,e),this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=Zn.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=os.create(0,0,0,0);this.vertices=new Array(8);for(var i=0;i<8;++i)this.vertices[i]=new an}return s(e,[{key:"split",value:function(e,t,i,n,r){var s=Math.tan(.5*n),a=s*i;gs.set(e*a,e*s,e),Ss.set(t*a,t*s,t);var o=this.vertices;As.set(gs.x,gs.y,gs.z),an.transformMat4(o[0],As,r),As.set(-gs.x,gs.y,gs.z),an.transformMat4(o[1],As,r),As.set(-gs.x,-gs.y,gs.z),an.transformMat4(o[2],As,r),As.set(gs.x,-gs.y,gs.z),an.transformMat4(o[3],As,r),As.set(Ss.x,Ss.y,Ss.z),an.transformMat4(o[4],As,r),As.set(-Ss.x,Ss.y,Ss.z),an.transformMat4(o[5],As,r),As.set(-Ss.x,-Ss.y,Ss.z),an.transformMat4(o[6],As,r),As.set(Ss.x,-Ss.y,Ss.z),an.transformMat4(o[7],As,r),this.updatePlanes()}},{key:"accurate",set:function(e){this._type=e?Zn.SHAPE_FRUSTUM_ACCURATE:Zn.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}},{key:"update",value:function(e,t){if(an.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),an.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),an.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),an.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),an.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),an.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===Zn.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();an.multiplyScalar(n.n,n.n,r),n.d*=r}for(var s=0;s<8;s++)an.transformMat4(this.vertices[s],vs[s],t)}}},{key:"transform",value:function(e){if(this._type===Zn.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)an.transformMat4(this.vertices[t],this.vertices[t],e);this.updatePlanes()}}},{key:"zero",value:function(){for(var e=0;e<8;e++)this.vertices[e].set(0,0,0);this.updatePlanes()}},{key:"updatePlanes",value:function(){os.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),os.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),os.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),os.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),os.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),os.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}}],[{key:"createOrtho",value:function(e,t,i,n,r,s){var a=t/2,o=i/2;an.set(As,a,o,-n),an.transformMat4(e.vertices[0],As,s),an.set(As,-a,o,-n),an.transformMat4(e.vertices[1],As,s),an.set(As,-a,-o,-n),an.transformMat4(e.vertices[2],As,s),an.set(As,a,-o,-n),an.transformMat4(e.vertices[3],As,s),an.set(As,a,o,-r),an.transformMat4(e.vertices[4],As,s),an.set(As,-a,o,-r),an.transformMat4(e.vertices[5],As,s),an.set(As,-a,-o,-r),an.transformMat4(e.vertices[6],As,s),an.set(As,a,-o,-r),an.transformMat4(e.vertices[7],As,s),os.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),os.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),os.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),os.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),os.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),os.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])}},{key:"createFromAABB",value:function(e,t){var i=new an,n=new an;return an.subtract(i,t.center,t.halfExtents),an.add(n,t.center,t.halfExtents),e.vertices[0].set(i.x,n.y,i.z),e.vertices[1].set(n.x,n.y,i.z),e.vertices[2].set(n.x,i.y,i.z),e.vertices[3].set(i.x,i.y,i.z),e.vertices[4].set(i.x,n.y,n.z),e.vertices[5].set(n.x,n.y,n.z),e.vertices[6].set(n.x,i.y,n.z),e.vertices[7].set(i.x,i.y,n.z),e._type!==Zn.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e}},{key:"create",value:function(){return new e}},{key:"clone",value:function(t){return e.copy(new e,t)}},{key:"copy",value:function(e,t){e._type=t.type;for(var i=0;i<6;++i)os.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)an.copy(e.vertices[n],t.vertices[n]);return e}}]),e}(),Es=new an,bs=new an,Cs=new dn,Rs=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,f=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,d=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,m=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,p=arguments.length>14&&void 0!==arguments[14]?arguments[14]:1;n(this,e),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Zn.SHAPE_OBB,this.center=new an(t,i,r),this.halfExtents=new an(s,a,o),this.orientation=new dn(u,h,l,c,_,f,d,m,p)}return s(e,[{key:"type",get:function(){return this._type}},{key:"getBoundary",value:function(e,t){!function(e,t,i){Cs.m00=Math.abs(i.m00),Cs.m01=Math.abs(i.m01),Cs.m02=Math.abs(i.m02),Cs.m03=Math.abs(i.m03),Cs.m04=Math.abs(i.m04),Cs.m05=Math.abs(i.m05),Cs.m06=Math.abs(i.m06),Cs.m07=Math.abs(i.m07),Cs.m08=Math.abs(i.m08),an.transformMat3(e,t,Cs)}(Es,this.halfExtents,this.orientation),an.subtract(e,this.center,Es),an.add(t,this.center,Es)}},{key:"transform",value:function(e,t,i,n,r){an.transformMat4(r.center,this.center,e),dn.fromQuat(r.orientation,i),an.multiply(r.halfExtents,this.halfExtents,n)}},{key:"translateAndRotate",value:function(e,t,i){an.transformMat4(i.center,this.center,e),dn.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){an.multiply(t.halfExtents,this.halfExtents,e)}}],[{key:"create",value:function(t,i,n,r,s,a,o,u,h,l,c,_,f,d,m){return new e(t,i,n,r,s,a,o,u,h,l,c,_,f,d,m)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}},{key:"copy",value:function(e,t){return an.copy(e.center,t.center),an.copy(e.halfExtents,t.halfExtents),dn.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return an.multiplyScalar(e.center,an.add(Es,t,i),.5),an.multiplyScalar(e.halfExtents,an.subtract(bs,i,t),.5),dn.identity(e.orientation),e}},{key:"set",value:function(e,t,i,n,r,s,a,o,u,h,l,c,_,f,d,m){return an.set(e.center,t,i,n),an.set(e.halfExtents,r,s,a),dn.set(e.orientation,o,u,h,l,c,_,f,d,m),e}}]),e}();function xs(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-6,n=0,r=e.length-1,s=r>>>1;n<=r;s=n+r>>>1){var a=e[s];if(a>t+i)r=s-1;else{if(!(a<t-i))return s;n=s+1}}return~n}ys=Symbol.iterator;var ws,ks,Is,Bs=function(){function e(){n(this,e),this._times=[],this._values=[]}return s(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}},{key:ys,value:function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var i=[e._times[t],e._values[t]];return++t,{done:!1,value:i}}}}},{key:"keyframes",value:function(){return this}},{key:"times",value:function(){return this._times}},{key:"values",value:function(){return this._values}},{key:"getKeyframeTime",value:function(e){return this._times[e]}},{key:"getKeyframeValue",value:function(e){return this._values[e]}},{key:"addKeyFrame",value:function(e,t){return this._insertNewKeyframe(e,t)}},{key:"removeKeyframe",value:function(e){this._times.splice(e,1),this._values.splice(e,1)}},{key:"indexOfKeyframe",value:function(e){return xs(this._times,e)}},{key:"updateTime",value:function(e,t){var i=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,i)}},{key:"assignSorted",value:function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var i=Array.from(e);this.setKeyframes(i.map((function(e){return T(e,1)[0]})),i.map((function(e){return T(e,2)[1]})))}}},{key:"clear",value:function(){this._times.length=0,this._values.length=0}},{key:"searchKeyframe",value:function(e){return xs(this._times,e)}},{key:"setKeyframes",value:function(e,t){e.length,t.length,function(e){e.every((function(e,t,i){return 0===t||e>i[t-1]||Di(e,i[t-1],1e-6)}))}(e),this._times=e,this._values=t}},{key:"_insertNewKeyframe",value:function(e,t){var i=this._times,n=this._values,r=i.length,s=xs(i,e);if(s>=0)return s;var a=~s;return 0===a?(i.unshift(e),n.unshift(t)):a===r?(i.push(e),n.push(t)):(i.splice(a-1,0,e),n.splice(a-1,0,t)),a}}]),e}();function Ps(e){return e>-1e-9&&e<1e-9}function Ms(e,t,i,n){return i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),n)}Ci.fastDefine("cc.KeyframeCurve",Bs,{_times:[],_values:[]}),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(ws||(ws=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(ks||(ks=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(Is||(Is=e("TangentWeightMode",{})));var Os=function(){},Ds=function(){return Os},Ls=Ns((function(){}));function Ns(e){return function(t){return"function"==typeof t?e(t):function(i){return e(i,t)}}}function Fs(e){return function(t){return function(i){!function(e,t,i){var n=Vs(e);if(n){var r=Us(n,"proto");Us(r,"editor")[t]=i}}(i,e,t)}}}var Gs="__ccclassCache__";function Vs(e){return Us(e,Gs)}function Us(e,t){return e[t]||(e[t]={})}var Hs=Ns((function(e,t){var i=et(e);i===Object&&(i=null);var n={name:t,extends:i,ctor:e},r=e[Gs];if(r){var s=r.proto;s&&Ze(n,s),e[Gs]=void 0}return Ci(n)})),zs=Fs("requireComponent"),Ws=Fs("executionOrder"),Xs=Ls;function js(e,t,i){var n=null;function r(e,t,i){!function(e,t,i,n,r,s){var a,o=s&&"function"!=typeof s&&(s.get||s.set);r&&(a=di(r,o));var u=Ze(t,a||r||{});o?(s.get&&(u.get=s.get),s.set&&(u.set=s.set)):Ks(e,u,i,n,s)}(function(e){return Vs(e.constructor)}(e),function(e,t){var i,n,r=Us(Vs(e.constructor),"proto"),s=Us(r,"properties");return null!==(n=s[i=t])&&void 0!==n?n:s[i]={}}(e,t),e.constructor,t,n,i)}return void 0===e?js({type:void 0}):void 0===t?(n=e,r):void r(e,t,i)}function qs(e){var t;try{t=e()}catch(t){return e}return"object"!==i(t)||null===t?t:e}function Ys(e,t,i){var n,r,s=Vs(e.constructor),a=Us(s,"proto"),o=Us(a,"properties"),u=null!==(r=o[n=t])&&void 0!==r?r:o[n]={};return u.__internalFlags|=mi.STANDALONE,i&&"function"!=typeof i&&(i.get||i.set)?(i.get&&(u.get=i.get),i.set&&(u.set=i.set)):Ks(s,u,e.constructor,t,i),u}function Ks(e,t,i,n,r){if(void 0!==r)"function"==typeof r?t.default=qs(r):null===r||r.initializer&&(t.default=qs(r.initializer));else{var s=e.default||(e.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(i));s.hasOwnProperty(n)&&(t.default=s[n])}}var Qs=Symbol("cc:SerializationMetadata"),Js=e("serializable",(function(e,t,i){ea(Ys(e,t,i))}));function Zs(e){return function(t,i,n){var r=Ys(t,i,n);r.formerlySerializedAs=e,ea(r)}}var $s=function(e,t,i){var n=Ys(e,t,i);n.editorOnly=!0,ea(n)};function ea(e){e.__internalFlags|=mi.IMPLICIT_SERIALIZABLE}var ta=Os,ia=Ls,na=Ds,ra=Ls,sa=Ds,aa=Ds,oa=Ds,ua=e("editable",Os),ha=e("visible",Ds),la=e("displayName",Ds),ca=e("tooltip",Ds),_a=e("range",Ds),fa=e("rangeStep",Ds),da=e("slide",Os),ma=e("displayOrder",Ds),pa=e("disallowAnimation",Os),va=Aa(ri),ya=Aa(si),ga=Aa(ai),Sa=Aa(oi);function Aa(e){return js({type:e})}var Ta=e("override",(function(e,t,i){Ys(e,t,i).override=!0})),Ea=e("editorExtrasTag","__editorExtras__"),ba=e("EditorExtendable",(function e(){n(this,e)})),Ca=Object.freeze({__proto__:null,uniquelyReferenced:ta,ccclass:Hs,property:js,requireComponent:zs,executionOrder:Ws,disallowMultiple:Xs,allowReplicated:function(e){Ci.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:ia,menu:na,playOnFocus:ra,inspector:sa,icon:aa,help:oa,type:Aa,integer:va,float:ya,boolean:ga,string:Sa,editable:ua,tooltip:ca,visible:ha,displayName:la,displayOrder:ma,range:_a,rangeStep:fa,slide:da,disallowAnimation:pa,override:Ta,formerlySerializedAs:Zs,serializable:Js});e("_decorator",Ca);var Ra,xa,wa,ka,Ia,Ba,Pa,Ma,Oa,Da,La,Na=1<<22,Fa=[],Ga=e("CCObject",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";n(this,e),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}return s(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var i=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|i}},{key:"replicated",get:function(){return!!(this._objFlags&Na)},set:function(e){e?this._objFlags|=Na:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}},{key:"destroy",value:function(){return 1&this._objFlags?(ae(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Fa.push(this),0))}},{key:"_destruct",value:function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,r=e instanceof B.Node||e instanceof B.Component,s=r?"_id":null,a={};for(n in e)if(e.hasOwnProperty(n)){if(n===s)continue;switch(i(e[n])){case"string":a[n]="";break;case"object":case"function":a[n]=null}}if(Ci._isCCClass(t))for(var o=B.Class.Attr.getClassAttrs(t),u=t.__props__,h=0;h<u.length;h++){n=u[h];var l="".concat(n);if(l in o){if(r&&"_id"===n)continue;switch(i(o[l])){case"string":a[n]="";break;case"object":case"function":a[n]=null;break;case"undefined":a[n]=void 0}}}var c="";for(n in a){var _;_=Ci.IDENTIFIER_RE.test(n)?"o.".concat(n,"="):"o[".concat(Ci.escapeForJS(n),"]=");var f=a[n];""===f&&(f='""'),c+="".concat(_+f,";\n")}return Function("o",c)}(this,e),Ne(e,"__destruct__",t,!0)),t(this)}},{key:"_destroyImmediate",value:function(){1&this._objFlags?ue(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}}],[{key:"_deferredDestroy",value:function(){for(var e=Fa.length,t=0;t<e;++t){var i=Fa[t];1&i._objFlags||i._destroyImmediate()}e===Fa.length?Fa.length=0:Fa.splice(0,e)}}]),e}()),Va=Ga.prototype;function Ua(e){return e instanceof Ga}function Ha(e,t){return"object"===i(e)?!(!e||e._objFlags&(t?5:1)):void 0!==e}function za(e,t){return(t<<3)+e}function Wa(e){return ja[e]}function Xa(e){switch(e){case Da.Uint8:return Uint8Array;case Da.Uint16:return Uint16Array;case Da.Uint32:return Uint32Array;case Da.Int8:return Int8Array;case Da.Int16:return Int16Array;case Da.Int32:return Int32Array;case Da.Float32:return Float32Array;case Da.Float64:return Float64Array}}Va._deserialize=null,Va._onPreDestroy=null,Ci.fastDefine("cc.Object",Ga,a({_name:"",_objFlags:0},Ea,{})),Ci.Attr.setClassAttr(Ga,Ea,"editorOnly",!0),Ci.Attr.setClassAttr(Ga,"replicated","visible",!1),Ne(Ga,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),B.isValid=Ha,B.Object=Ga,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(Da||(Da={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(La||(La={})),e("CompactValueTypeArray",Hs("cc.CompactValueTypeArray")((Ma=Pa=function(){function e(){n(this,e),this._byteOffset=wa&&wa(),this._unitCount=ka&&ka(),this._unitElement=Ia&&Ia(),this._length=Ba&&Ba()}return s(e,[{key:"decompress",value:function(e){for(var t,i={storageUnit:7&(t=this._unitElement),elementType:t>>3},n=i.storageUnit,r=Wa(i.elementType),s=new(Xa(n))(e,this._byteOffset,this._unitCount),a=new Array(this._length),o=0;o<this._length;++o)a[o]=r.decompress(s,o);return a}}],[{key:"lengthFor",value:function(e,t,i){return Wa(t).requiredUnits*e.length*Xa(i).BYTES_PER_ELEMENT}},{key:"compress",value:function(t,i,n,r,s,a){for(var o=Wa(i),u=Xa(n),h=o.requiredUnits*t.length,l=new u(r,s,h),c=0;c<t.length;++c)o.compress(l,c,t[c]);var _=new e;return _._unitElement=za(n,i),_._byteOffset=a,_._unitCount=h,_._length=t.length,_}}]),e}(),Pa.StorageUnit=Da,Pa.ElementType=La,wa=Ms((xa=Ma).prototype,"_byteOffset",[Js],(function(){return 0})),ka=Ms(xa.prototype,"_unitCount",[Js],(function(){return 0})),Ia=Ms(xa.prototype,"_unitElement",[Js],(function(){return za(Da.Uint8,La.Scalar)})),Ba=Ms(xa.prototype,"_length",[Js],(function(){return 0})),Ra=xa))||Ra);var ja=(a(Oa={},La.Scalar,{requiredUnits:1,compress:function(e,t,i){e[t]=i},decompress:function(e,t){return e[t]}}),a(Oa,La.Vec2,{requiredUnits:2,compress:function(e,t,i){e[2*t]=i.x,e[2*t+1]=i.y},decompress:function(e,t){return new an(e[2*t],e[2*t+1])}}),a(Oa,La.Vec3,{requiredUnits:3,compress:function(e,t,i){e[3*t]=i.x,e[3*t+1]=i.y,e[3*t+2]=i.z},decompress:function(e,t){return new an(e[3*t],e[3*t+1],e[3*t+2])}}),a(Oa,La.Vec4,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new en(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),a(Oa,La.Quat,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new vn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),a(Oa,La.Mat4,{requiredUnits:16,compress:function(e,t,i){Cn.toArray(e,i,16*t)},decompress:function(e,t){return Cn.fromArray(new Cn,e,16*t)}}),Oa),qa=e("serializeTag",Symbol("[[Serialize]]")),Ya=e("deserializeTag",Symbol("[[Deserialize]]"));function Ka(){return 0}function Qa(e){return e}function Ja(e){return e*e}function Za(e){return e*(2-e)}function $a(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function eo(e){return e*e*e}function to(e){return--e*e*e+1}function io(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function no(e){return e*e*e*e}function ro(e){return 1- --e*e*e*e}function so(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function ao(e){return e*e*e*e*e}function oo(e){return--e*e*e*e*e+1}function uo(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function ho(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function lo(e){return Math.sin(e*Math.PI/2)}function co(e){return.5*(1-Math.cos(Math.PI*e))}function _o(e){return 0===e?0:Math.pow(1024,e-1)}function fo(e){return 1===e?1:1-Math.pow(2,-10*e)}function mo(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function po(e){return 1-Math.sqrt(1-e*e)}function vo(e){return Math.sqrt(1- --e*e)}function yo(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function go(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function So(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function Ao(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function To(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function Eo(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function bo(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function Co(e){return 1-Ro(1-e)}function Ro(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function xo(e){return e<.5?.5*Co(2*e):.5*Ro(2*e-1)+.5}function wo(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function ko(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}B._decorator=Ca;var Io=Vo(Ja,Za),Bo=Vo(eo,to),Po=Vo(no,ro),Mo=Vo(ao,oo),Oo=Vo(ho,lo),Do=Vo(_o,fo),Lo=Vo(po,vo),No=Vo(go,So),Fo=Vo(To,Eo),Go=Vo(Co,Ro);function Vo(e,t){return function(i){return i<.5?t(2*i)/2:e(2*i-1)/2+.5}}var Uo,Ho,zo=Object.freeze({__proto__:null,constant:Ka,linear:Qa,quadIn:Ja,quadOut:Za,quadInOut:$a,cubicIn:eo,cubicOut:to,cubicInOut:io,quartIn:no,quartOut:ro,quartInOut:so,quintIn:ao,quintOut:oo,quintInOut:uo,sineIn:ho,sineOut:lo,sineInOut:co,expoIn:_o,expoOut:fo,expoInOut:mo,circIn:po,circOut:vo,circInOut:yo,elasticIn:go,elasticOut:So,elasticInOut:Ao,backIn:To,backOut:Eo,backInOut:bo,bounceIn:Co,bounceOut:Ro,bounceInOut:xo,smooth:wo,fade:ko,quadOutIn:Io,cubicOutIn:Bo,quartOutIn:Po,quintOutIn:Mo,sineOutIn:Oo,expoOutIn:Do,circOutIn:Lo,elasticOutIn:No,backOutIn:Fo,bounceOutIn:Go});e("easing",zo),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(Ho||(Ho=e("EasingMethod",{})));var Wo=(a(Uo={},Ho.CONSTANT,Ka),a(Uo,Ho.LINEAR,Qa),a(Uo,Ho.QUAD_IN,Ja),a(Uo,Ho.QUAD_OUT,Za),a(Uo,Ho.QUAD_IN_OUT,$a),a(Uo,Ho.QUAD_OUT_IN,Io),a(Uo,Ho.CUBIC_IN,eo),a(Uo,Ho.CUBIC_OUT,to),a(Uo,Ho.CUBIC_IN_OUT,io),a(Uo,Ho.CUBIC_OUT_IN,Bo),a(Uo,Ho.QUART_IN,no),a(Uo,Ho.QUART_OUT,ro),a(Uo,Ho.QUART_IN_OUT,so),a(Uo,Ho.QUART_OUT_IN,Po),a(Uo,Ho.QUINT_IN,ao),a(Uo,Ho.QUINT_OUT,oo),a(Uo,Ho.QUINT_IN_OUT,uo),a(Uo,Ho.QUINT_OUT_IN,Mo),a(Uo,Ho.SINE_IN,ho),a(Uo,Ho.SINE_OUT,lo),a(Uo,Ho.SINE_IN_OUT,co),a(Uo,Ho.SINE_OUT_IN,Oo),a(Uo,Ho.EXPO_IN,_o),a(Uo,Ho.EXPO_OUT,fo),a(Uo,Ho.EXPO_IN_OUT,mo),a(Uo,Ho.EXPO_OUT_IN,Do),a(Uo,Ho.CIRC_IN,po),a(Uo,Ho.CIRC_OUT,vo),a(Uo,Ho.CIRC_IN_OUT,yo),a(Uo,Ho.CIRC_OUT_IN,Lo),a(Uo,Ho.ELASTIC_IN,go),a(Uo,Ho.ELASTIC_OUT,So),a(Uo,Ho.ELASTIC_IN_OUT,Ao),a(Uo,Ho.ELASTIC_OUT_IN,No),a(Uo,Ho.BACK_IN,To),a(Uo,Ho.BACK_OUT,Eo),a(Uo,Ho.BACK_IN_OUT,bo),a(Uo,Ho.BACK_OUT_IN,Fo),a(Uo,Ho.BOUNCE_IN,Co),a(Uo,Ho.BOUNCE_OUT,Ro),a(Uo,Ho.BOUNCE_IN_OUT,xo),a(Uo,Ho.BOUNCE_OUT_IN,Go),a(Uo,Ho.SMOOTH,wo),a(Uo,Ho.FADE,ko),Uo);function Xo(e){return Wo[e]}D(255),D(65280);var jo,qo,Yo,Ko=ws.LINEAR<<0|Is.NONE<<8|Ho.LINEAR<<16,Qo=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e._flags=Ko,e}return s(i,[{key:"interpolationMode",get:function(){return(255&this._flags)>>0},set:function(e){this._flags&=-256,this._flags|=e<<0}},{key:"tangentWeightMode",get:function(){return(65280&this._flags)>>8},set:function(e){this._flags&=-65281,this._flags|=e<<8}},{key:"easingMethod",get:function(){return(16711680&this._flags)>>16},set:function(e){this._flags&=-16711681,this._flags|=e<<16}}]),i}(ba);function Jo(e){var t=new Qo;if("number"==typeof e)t.value=e;else{var i=e.interpolationMode,n=e.tangentWeightMode,r=e.value,s=e.rightTangent,a=e.rightTangentWeight,o=e.leftTangent,u=e.leftTangentWeight,h=e.easingMethod,l=e[Ea];t.value=null!=r?r:t.value,t.rightTangent=null!=s?s:t.rightTangent,t.rightTangentWeight=null!=a?a:t.rightTangentWeight,t.leftTangent=null!=o?o:t.leftTangent,t.leftTangentWeight=null!=u?u:t.leftTangentWeight,t.interpolationMode=null!=i?i:t.interpolationMode,t.tangentWeightMode=null!=n?n:t.tangentWeightMode,t.easingMethod=null!=h?h:t.easingMethod,l&&(t[Ea]=l)}return t}Ci.fastDefine("cc.RealKeyframeValue",Qo,a({interpolationMode:ws.LINEAR,tangentWeightMode:Is.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:Ho.LINEAR},Ea,void 0)),Ci.Attr.setClassAttr(Qo,Ea,"editorOnly",!0),(jo=Qo,null!==(Yo=(qo=jo)[Qs])&&void 0!==Yo?Yo:qo[Qs]={}).uniquelyReferenced=!0;var Zo,$o=e("RealCurve",function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).preExtrapolation=ks.CLAMP,e.postExtrapolation=ks.CLAMP,e}return s(i,[{key:"evaluate",value:function(e){var t=this._times,i=this._values,n=t.length;if(0===n)return 0;var r=t[0],s=t[n-1];if(e<r){var a=this.preExtrapolation,o=i[0];if(a===ks.CLAMP||n<2)return o.value;switch(a){case ks.LINEAR:return mu(r,i[0].value,t[1],i[1].value,e);case ks.LOOP:e=fu(e,r,s);break;case ks.PING_PONG:e=du(e,r,s);break;default:return o.value}}else if(e>s){var u=this.postExtrapolation,h=i[n-1];if(u===ks.CLAMP||n<2)return h.value;switch(u){case ks.LINEAR:return mu(s,h.value,t[n-2],i[n-2].value,e);case ks.LOOP:e=fu(e,r,s);break;case ks.PING_PONG:e=du(e,r,s);break;default:return h.value}}var l=xs(t,e);if(l>=0)return i[l].value;var c=~l,_=c-1,f=t[_],d=i[_],m=t[c];return function(e,t,i,n,r){var s=i-e;switch(t.interpolationMode){default:case ws.CONSTANT:return t.value;case ws.LINEAR:var a=t.easingMethod===Ho.LINEAR?r:Xo(t.easingMethod)(r);return Fi(t.value,n.value,a);case ws.CUBIC:var o=1/3,u=t.rightTangent,h=t.rightTangentWeight,l=0!=(t.tangentWeightMode&Is.RIGHT),c=n.leftTangent,_=n.leftTangentWeight,f=0!=(n.tangentWeightMode&Is.LEFT);if(l||f){var d=0;if(l)d=h;else{var m=s,p=s*u;d=Math.sqrt(m*m+p*p)*o}var v=Math.atan(u),y=Math.cos(v)*d+e,g=Math.sin(v)*d+t.value,S=0;if(f)S=_;else{var A=s,T=s*c;S=Math.sqrt(A*A+T*T)*o}var E=Math.atan(c),b=(y-e)/s,C=(-Math.cos(E)*S+i-e)/s,R=g,x=-Math.sin(E)*S+n.value,w=[0,0,0],k=function(e,t,i,n,r){var s=i/n,a=t/n,o=s*s,u=1/3*(-1/3*o+a),h=.5*(2/27*s*o-1/3*s*a+e/n),l=u*u*u,c=h*h+l,_=0;if(Ps(c)){if(Ps(h))return r[0]=0,1;var f=Math.cbrt(-h);return r[0]=2*f,r[1]=-f,2}if(c<0){var d=1/3*Math.acos(-h/Math.sqrt(-l)),m=2*Math.sqrt(-u);r[0]=m*Math.cos(d),r[1]=-m*Math.cos(d+Math.PI/3),r[2]=-m*Math.cos(d-Math.PI/3),_=3}else{var p=Math.sqrt(c),v=Math.cbrt(p-h),y=-Math.cbrt(p+h);r[0]=v+y,_=1}for(var g=1/3*s,S=0;S<_;++S)r[S]-=g;return _}(0-r,3*b,3*C-6*b,3*(b-C)+1,w),I=function(e,t,i){var n=i;if(1===t)n=e[0];else{n=-1/0;for(var r=0;r<t;++r){var s=e[r];s>=0&&s<=1&&s>n&&(n=s)}n===-1/0&&(n=0)}return n}(w,k,r);return pu(t.value,R,x,n.value,I)}var B=t.value+o*u*s,P=n.value-o*c*s;return pu(t.value,B,P,n.value,r)}}(f,d,m,i[c],(e-f)/(m-f))}},{key:"addKeyFrame",value:function(e,t){return g(l(i.prototype),"addKeyFrame",this).call(this,e,Jo(t))}},{key:"assignSorted",value:function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return Jo(e)})));else{var i=Array.from(e);this.setKeyframes(i.map((function(e){return T(e,1)[0]})),i.map((function(e){return Jo(T(e,2)[1])})))}}},{key:"isConstant",value:function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(i){return Di(i.value,t,e)}))}},{key:qa,value:function(e,t){if(t.toCCON){var i=this._times,n=this._values,r=i.length,s=new DataView(new ArrayBuffer(0+eu+eu+tu+iu*r+lu*r)),a=0;s.setUint8(a,this.preExtrapolation),a+=eu,s.setUint8(a,this.postExtrapolation),a+=eu,s.setUint32(a,r,!0),a+=tu,i.forEach((function(e,t){return s.setFloat32(a+iu*t,e,!0)})),a+=iu*r;for(var o,u=R(n);!(o=u()).done;){var h=o.value;a=cu(s,h,a)}var l=new Uint8Array(s.buffer,0,a);e.writeProperty("bytes",l);var c=n.map((function(e){return e[Ea]}));c.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",c)}else e.writeThis()}},{key:Ya,value:function(e,t){if(t.fromCCON){var i=e.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength),r=0;this.preExtrapolation=n.getUint8(r),r+=eu,this.postExtrapolation=n.getUint8(r),r+=eu;var s=n.getUint32(r,!0);r+=tu;var a=Array.from({length:s},(function(e,t){return n.getFloat32(r+iu*t,!0)}));r+=iu*s;for(var o=new Array(s),u=0;u<s;++u){var h=Jo({});r=_u(n,h,r),o[u]=h}i.byteLength;var l=e.readProperty("keyframeValueEditorExtras");l&&(l.length,l.forEach((function(e,t){return o[t][Ea]=e}))),this._times=a,this._values=o}else e.readThis()}}]),i}(Bs));Ci.fastDefine("cc.RealCurve",$o,{_times:[],_values:[],preExtrapolation:ks.CLAMP,postExtrapolation:ks.CLAMP}),function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(Zo||(Zo={}));var eu=1,tu=4,iu=4,nu=Jo({}),ru=nu.interpolationMode,su=nu.tangentWeightMode,au=nu.leftTangent,ou=nu.leftTangentWeight,uu=nu.rightTangent,hu=nu.rightTangentWeight,lu=26;function cu(e,t,i){var n=0,r=i,s=r;r+=4;var a=t.value,o=t.interpolationMode,u=t.tangentWeightMode,h=t.rightTangent,l=t.rightTangentWeight,c=t.leftTangent,_=t.leftTangentWeight,f=t.easingMethod;return e.setFloat32(r,a,!0),r+=4,o!==ru&&(n|=Zo.INTERPOLATION_MODE,e.setUint8(r,o),r+=1),u!==su&&(n|=Zo.TANGENT_WEIGHT_MODE,e.setUint8(r,u),r+=1),c!==au&&(n|=Zo.LEFT_TANGENT,e.setFloat32(r,c,!0),r+=4),_!==ou&&(n|=Zo.LEFT_TANGENT_WEIGHT,e.setFloat32(r,_,!0),r+=4),h!==uu&&(n|=Zo.RIGHT_TANGENT,e.setFloat32(r,h,!0),r+=4),l!==hu&&(n|=Zo.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,l,!0),r+=4),n|=f<<8,e.setUint32(s,n,!0),r}function _u(e,t,i){var n=i,r=e.getUint32(n,!0);n+=4,t.value=e.getFloat32(n,!0),n+=4,r&Zo.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(n),n+=1),r&Zo.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(n),n+=1),r&Zo.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(n,!0),n+=4),r&Zo.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(n,!0),n+=4),r&Zo.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(n,!0),n+=4),r&Zo.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(n,!0),n+=4);var s=(65280&r)>>8;return t.easingMethod=s,n}function fu(e,t,i){return t+Yi(e-t,i-t)}function du(e,t,i){return t+Ki(e-t,i-t)}function mu(e,t,i,n,r){return t+(n-t)/(i-e)*(r-e)}function pu(e,t,i,n,r){var s=1-r;return s*s*s*e+3*s*s*r*t+3*s*r*r*i+r*r*r*n}function vu(e,t,i,n,r){var s=1-r;return s*(s*(e+(3*t-e)*r)+3*i*r*r)+n*r*r*r}B.bezier=vu;var yu,gu,Su,Au,Tu,Eu,bu,Cu,Ru,xu,wu=Math.cos,ku=Math.acos,Iu=Math.max,Bu=2*Math.PI,Pu=Math.sqrt;function Mu(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Ou(e,t){var i=function(e,t){var i,n,r,s,a=t-0,o=t-e[0],u=3*a,h=3*o,l=3*(t-e[2]),c=1/(-a+h-l+(t-1)),_=1/3,f=(u-6*o+l)*c,d=f*_,m=(-u+h)*c,p=(3*m-f*f)*_,v=p*_,y=(2*f*f*f-9*f*m+a*c*27)/27,g=y/2,S=g*g+v*v*v;if(S<0){var A=-p*_,T=Pu(A*A*A),E=-y/(2*T),b=ku(E<-1?-1:E>1?1:E),C=2*Mu(T);return n=C*wu(b*_)-d,r=C*wu((b+Bu)*_)-d,s=C*wu((b+2*Bu)*_)-d,n>=0&&n<=1?r>=0&&r<=1?s>=0&&s<=1?Iu(n,r,s):Iu(n,r):s>=0&&s<=1?Iu(n,s):n:r>=0&&r<=1?s>=0&&s<=1?Iu(r,s):r:s}if(0===S)return r=-(i=g<0?Mu(-g):-Mu(g))-d,(n=2*i-d)>=0&&n<=1?r>=0&&r<=1?Iu(n,r):n:r;var R=Pu(S);return(i=Mu(-g+R))-Mu(g+R)-d}(e,t),n=e[1];return((1-i)*(n+(e[3]-n)*i)*3+i*i)*i}B.bezierByTime=Ou,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(xu||(xu=e("QuatInterpolationMode",{})));var Du=Hs("cc.QuatKeyframeValue")(yu=ta((gu=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=t.value,r=t.interpolationMode,s=t.easingMethod;n(this,e),this.interpolationMode=Su&&Su(),this.value=Au&&Au(),this.easingMethod=Tu&&Tu(),this.value=i?vn.clone(i):this.value,this.interpolationMode=null!=r?r:this.interpolationMode,this.easingMethod=null!=s?s:this.easingMethod},Su=Ms(gu.prototype,"interpolationMode",[Js],(function(){return xu.SLERP})),Au=Ms(gu.prototype,"value",[Js],(function(){return vn.clone(vn.IDENTITY)})),Tu=Ms(gu.prototype,"easingMethod",[Js],(function(){return Ho.LINEAR})),yu=gu))||yu)||yu;function Lu(e){return new Du(e)}var Nu,Fu=e("QuatCurve",Hs("cc.QuatCurve")((bu=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).preExtrapolation=Cu&&Cu(),e.postExtrapolation=Ru&&Ru(),e}return s(i,[{key:"evaluate",value:function(e,t){var i;null!==(i=t)&&void 0!==i||(t=new vn);var n=this._times,r=this._values,s=this.postExtrapolation,a=this.preExtrapolation,o=n.length;if(0===o)return t;var u=n[0],h=n[o-1];if(e<u){var l=r[0];switch(a){case ks.LOOP:e=u+Yi(e-u,h-u);break;case ks.PING_PONG:e=u+Ki(e-u,h-u);break;case ks.CLAMP:default:return vn.copy(t,l.value)}}else if(e>h){var c=r[o-1];switch(s){case ks.LOOP:e=u+Yi(e-u,h-u);break;case ks.PING_PONG:e=u+Ki(e-u,h-u);break;case ks.CLAMP:default:return vn.copy(t,c.value)}}var _=xs(n,e);if(_>=0)return vn.copy(t,r[_].value);var f=~_,d=f-1,m=n[d],p=r[d],v=n[f],y=r[f],g=(e-m)/(v-m);switch(p.interpolationMode){default:case xu.CONSTANT:return vn.copy(t,p.value);case xu.SLERP:var S=p.easingMethod,A=S===Ho.LINEAR?g:Array.isArray(S)?Ou(S,g):Xo(S)(g);return vn.slerp(t,p.value,y.value,A)}}},{key:"addKeyFrame",value:function(e,t){var n=new Du(t);return g(l(i.prototype),"addKeyFrame",this).call(this,e,n)}},{key:"assignSorted",value:function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return Lu(e)})));else{var i=Array.from(e);this.setKeyframes(i.map((function(e){return T(e,1)[0]})),i.map((function(e){return Lu(T(e,2)[1])})))}}},{key:qa,value:function(e,t){if(t.toCCON){var i=this._times,n=this._values,r=!0;n.forEach((function(e,t,i){var n=T(i,1)[0];r&&e.interpolationMode!==n.interpolationMode&&(r=!1)}));var s=i.length,a=Wu*(r?1:s),o=n.reduce((function(e,t){var i=t.easingMethod;return e+(Array.isArray(i)?Xu+4*qu:Xu)}),0),u=0,h=new DataView(new ArrayBuffer(u+=Vu+Uu+Hu*s+4*zu*s+o+a+0)),l=0,c=0;r&&(c|=Nu.INTERPOLATION_MODE),h.setUint32(l,c,!0),l+=Vu,h.setUint32(l,s,!0),l+=Uu,i.forEach((function(e,t){return h.setFloat32(l+Hu*t,e,!0)})),l+=Hu*s,n.forEach((function(e,t){var i=e.value,n=i.x,r=i.y,s=i.z,a=i.w,o=l+4*zu*t;h.setFloat32(o+0*zu,n,!0),h.setFloat32(o+1*zu,r,!0),h.setFloat32(o+2*zu,s,!0),h.setFloat32(o+3*zu,a,!0)})),l+=4*zu*s,n.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(h.setUint8(l,ju),++l,h.setFloat32(l+0*qu,t[0],!0),h.setFloat32(l+1*qu,t[1],!0),h.setFloat32(l+2*qu,t[2],!0),h.setFloat32(l+3*qu,t[3],!0),l+=4*qu):(h.setUint8(l,t),++l)}));var _=l;l+=a;var f=_;n.forEach((function(e){var t=e.interpolationMode;h.setUint8(f,t),r||(f+=Wu)}));var d=new Uint8Array(h.buffer);e.writeProperty("bytes",d)}else e.writeThis()}},{key:Ya,value:function(e,t){if(t.fromCCON){var i=e.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength),r=0,s=n.getUint32(r,!0);r+=Vu;var a=s&Nu.INTERPOLATION_MODE,o=n.getUint32(r,!0);r+=Uu;var u=Array.from({length:o},(function(e,t){return n.getFloat32(r+Hu*t,!0)})),h=r+=Hu*o;r+=4*zu*o;var l=Array.from({length:o},(function(e,t){var i=h+4*zu*t,s=n.getFloat32(i+0*zu,!0),a=n.getFloat32(i+1*zu,!0),o=n.getFloat32(i+2*zu,!0),u=n.getFloat32(i+3*zu,!0),l=n.getUint8(r);++r;var c=Lu({value:{x:s,y:a,z:o,w:u}});return l!==ju?c.easingMethod=l:(c.easingMethod=[n.getFloat32(r+0*qu,!0),n.getFloat32(r+1*qu,!0),n.getFloat32(r+2*qu,!0),n.getFloat32(r+3*qu,!0)],r+=4*qu),c}));if(a){var c=n.getUint8(r);++r;for(var _=0;_<o;++_)l[_].interpolationMode=c}else{for(var f=0;f<o;++f){var d=n.getUint8(r+f);l[f].interpolationMode=d}r+=o}this._times=u,this._values=l}else e.readThis()}}]),i}(Bs),Cu=Ms(bu.prototype,"preExtrapolation",[Js],(function(){return ks.CLAMP})),Ru=Ms(bu.prototype,"postExtrapolation",[Js],(function(){return ks.CLAMP})),Eu=bu))||Eu);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(Nu||(Nu={}));var Gu,Vu=1,Uu=4,Hu=4,zu=4,Wu=1,Xu=1,ju=255,qu=4,Yu=e("ObjectCurve",Hs("cc.ObjectCurve")(Gu=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"evaluate",value:function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var i=Li(~t-1,0,this._values.length-1);return this._values[i]}}]),i}(Bs))||Gu),Ku=function e(){n(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Ci.fastDefine("cc.Keyframe",Ku,{time:0,value:0,inTangent:0,outTangent:0});var Qu=function(){function e(){n(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return s(e,[{key:"evaluate",value:function(e){return Ju(e-this.time,this.coefficient)}}]),e}();function Ju(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}var Zu,$u,eh=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(n(this,e),this.cachedKey=void 0,t instanceof $o)this._curve=t;else{var i=new $o;this._curve=i,i.preExtrapolation=ks.LOOP,i.postExtrapolation=ks.CLAMP,t?i.assignSorted(t.map((function(e){return[e.time,{interpolationMode:ws.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):i.assignSorted([[0,{interpolationMode:ws.CUBIC,value:1}],[1,{interpolationMode:ws.CUBIC,value:1}]])}this.cachedKey=new Qu}return s(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=T(e,2),i=t[0],n=t[1],r=new Ku;return r.time=i,r.value=n.value,r.inTangent=n.leftTangent,r.outTangent=n.rightTangent,r}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:ws.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return ih(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=th(e)}},{key:"postWrapMode",get:function(){return ih(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=th(e)}},{key:"addKey",value:function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:ws.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()}},{key:"evaluate_slow",value:function(e){return this._curve.evaluate(e)}},{key:"evaluate",value:function(e){var t=this.cachedKey,i=this._curve,n=i.keyFramesCount-1,r=e,s=e<0?i.preExtrapolation:i.postExtrapolation,a=i.getKeyframeTime(0),o=i.getKeyframeTime(n);switch(s){case ks.LOOP:r=Yi(e-a,o-a)+a;break;case ks.PING_PONG:r=Ki(e-a,o-a)+a;break;case ks.CLAMP:default:r=Li(e,a,o)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var u=this.findIndex(t,r),h=Math.min(u+1,n);return this.calcOptimizedKey(t,u,h),t.evaluate(r)}},{key:"calcOptimizedKey",value:function(e,t,i){var n=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(i),s=this._curve.getKeyframeValue(t),a=s.value,o=s.leftTangent,u=this._curve.getKeyframeValue(i),h=u.value,l=u.rightTangent;e.index=t,e.time=n,e.endTime=r;var c=r-n,_=h-a,f=1/(c*c),d=o*c,m=l*c;e.coefficient[0]=(d+m-_-_)*f/c,e.coefficient[1]=(_+_+_-d-d-m)*f,e.coefficient[2]=o,e.coefficient[3]=a}},{key:"findIndex",value:function(e,t){var i=this._curve,n=i.keyFramesCount,r=e.index;if(-1!==r)if(t>i.getKeyframeTime(r))for(var s=0;s<3;s++){var a=r+s;if(a+1<n&&i.getKeyframeTime(a+1)>t)return a}else for(var o=0;o<3;o++){var u=r-o;if(u>=0&&i.getKeyframeTime(u-1)<=t)return u-1}for(var h,l=0,c=n;c-l>1;)h=Math.floor((l+c)/2),i.getKeyframeTime(h)>=t?c=h:l=h;return l}}]),e}();function th(e){switch(e){default:case Zu.Default:case Zu.Normal:case Zu.Clamp:return ks.CLAMP;case Zu.PingPong:return ks.PING_PONG;case Zu.Loop:return ks.LOOP}}function ih(e){switch(e){default:case ks.LINEAR:case ks.CLAMP:return Zu.Clamp;case ks.PING_PONG:return Zu.PingPong;case ks.LOOP:return Zu.Loop}}eh.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Ci.fastDefine("cc.AnimationCurve",eh,{_curve:null}),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(Zu||(Zu={})),function(e){e[e.LINEAR=0]="LINEAR",e[e.BEZIER=1]="BEZIER",e[e.CATMULL_ROM=2]="CATMULL_ROM"}($u||($u={}));var nh,rh=4294967295,sh=new an,ah=new an,oh=new an,uh=new an,hh=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$u.CATMULL_ROM,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];n(this,e),this._type=void 0,this._mode=$u.CATMULL_ROM,this._knots=[],this._type=Zn.SHAPE_SPLINE,this._mode=t;for(var r=0;r<i.length;r++)this._knots[r]=new an(i[r])}return s(e,[{key:"type",get:function(){return this._type}},{key:"mode",get:function(){return this._mode}},{key:"knots",get:function(){return this._knots}},{key:"setModeAndKnots",value:function(e,t){this._mode=e,this._knots.length=0;for(var i=0;i<t.length;i++)this._knots[i]=new an(t[i])}},{key:"clearKnots",value:function(){this._knots.length=0}},{key:"getKnotCount",value:function(){return this._knots.length}},{key:"addKnot",value:function(e){this._knots.push(new an(e))}},{key:"insertKnot",value:function(e,t){var i=new an(t);e>=this._knots.length?this._knots.push(i):this._knots.splice(e,0,i)}},{key:"removeKnot",value:function(e){e>=0&&this._knots.length,this._knots.splice(e,1)}},{key:"setKnot",value:function(e,t){e>=0&&this._knots.length,this._knots[e].set(t)}},{key:"getKnot",value:function(e){return e>=0&&this._knots.length,this._knots[e]}},{key:"getPoint",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:rh;t=Li(t,0,1);var n=this.getSegments();if(0===n)return new an(0,0,0);if(i===rh){var r=1/n;i=Math.floor(t/r),t=t%r/r}if(i>=n)return new an(this._knots[this._knots.length-1]);switch(this._mode){case $u.LINEAR:return e.calcLinear(this._knots[i],this._knots[i+1],t);case $u.BEZIER:return e.calcBezier(this._knots[4*i],this._knots[4*i+1],this._knots[4*i+2],this._knots[4*i+3],t);case $u.CATMULL_ROM:var s=i>0?this._knots[i-1]:this._knots[i],a=i+2<this._knots.length?this._knots[i+2]:this._knots[i+1];return e.calcCatmullRom(s,this._knots[i],this._knots[i+1],a,t);default:return new an(0,0,0)}}},{key:"getPoints",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:rh;if(0===e)return[];if(1===e){var i=this.getPoint(0,t);return[i]}for(var n=[],r=1/(e-1),s=0;s<e;s++){var a=s*r,o=this.getPoint(a,t);n.push(o)}return n}},{key:"getSegments",value:function(){var e=this._knots.length;switch(this._mode){case $u.LINEAR:case $u.CATMULL_ROM:return e<2?(ae(14300),0):e-1;case $u.BEZIER:return e<4||e%4!=0?(ae(14301),0):e/4}}}],[{key:"create",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return new e(t,i)}},{key:"clone",value:function(t){return new e(t.mode,t.knots)}},{key:"copy",value:function(e,t){e._mode=t.mode,e._knots.length=0;for(var i=t.knots,n=i.length,r=0;r<n;r++)e._knots[r]=new an(i[r]);return e}},{key:"calcLinear",value:function(e,t,i){var n=new an;return an.multiplyScalar(sh,e,1-i),an.multiplyScalar(ah,t,i),an.add(n,sh,ah),n}},{key:"calcBezier",value:function(e,t,i,n,r){var s=new an,a=1-r;return an.multiplyScalar(sh,e,a*a*a),an.multiplyScalar(ah,t,3*r*a*a),an.multiplyScalar(oh,i,3*r*r*a),an.multiplyScalar(uh,n,r*r*r),an.add(sh,sh,ah),an.add(oh,oh,uh),an.add(s,sh,oh),s}},{key:"calcCatmullRom",value:function(e,t,i,n,r){var s=new an,a=r*r,o=a*r;return an.multiplyScalar(sh,e,-.5*o+a-.5*r),an.multiplyScalar(ah,t,1.5*o-2.5*a+1),an.multiplyScalar(oh,i,-1.5*o+2*a+.5*r),an.multiplyScalar(uh,n,.5*o-.5*a),an.add(sh,sh,ah),an.add(oh,oh,uh),an.add(s,sh,oh),s}}]),e}();function lh(e,t){console.warn("".concat(e," is deprecated, please use ").concat(t," instead."))}!function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(nh||(nh={})),me(is,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var ch=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),lh("line","Line"),e}return i}($n),_h=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),lh("plane","Plane"),e}return i}(os),fh=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),lh("ray","Ray"),e}return i}(er),dh=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),lh("triangle","Triangle"),e}return i}(us),mh=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),lh("sphere","Sphere"),e}return i}(dr),ph=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),lh("aabb","AABB"),e}return i}(ms),vh=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),lh("obb","OBB"),e}return i}(Rs),yh=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),lh("capsule","Capsule"),e}return i}(ps),gh=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),lh("frustum","Frustum"),e}return i}(Ts),Sh=Object.freeze({__proto__:null,distance:Jn,enums:Zn,intersect:is,Line:$n,Plane:os,Ray:er,Triangle:us,Sphere:dr,AABB:ms,OBB:Rs,Capsule:ps,Frustum:Ts,Keyframe:Ku,AnimationCurve:eh,get WrapModeMask(){return Zu},get SplineMode(){return $u},Spline:hh,constructLegacyCurveAndConvert:function(){var e=new $o;return e.assignSorted([[0,{interpolationMode:ws.CUBIC,value:1}],[1,{interpolationMode:ws.CUBIC,value:1}]]),e},OptimizedKey:Qu,evalOptCurve:Ju,get ERaycastMode(){return nh},line:ch,plane:_h,ray:fh,triangle:dh,sphere:mh,aabb:ph,obb:vh,capsule:yh,frustum:gh});e("geometry",Sh);var Ah=function(){function e(){n(this,e),this._poolHandle=-1,Th.addContainer(this)}return s(e,[{key:"destroy",value:function(){Th.removeContainer(this)}}]),e}(),Th=new(function(){function e(){n(this,e),this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}return s(e,[{key:"addContainer",value:function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))}},{key:"removeContainer",value:function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,gt(this._pools,e._poolHandle),e._poolHandle=-1)}},{key:"tryShrink",value:function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()}},{key:"update",value:function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)}}]),e}()),Eh=e("Pool",function(e){h(i,e);var t=v(i);function i(e,r,s){var a;n(this,i),(a=t.call(this))._ctor=void 0,a._elementsPerBatch=void 0,a._nextAvail=void 0,a._freePool=[],a._dtor=void 0,a._ctor=e,a._dtor=s||null,a._elementsPerBatch=Math.max(r,1),a._nextAvail=a._elementsPerBatch-1;for(var o=0;o<a._elementsPerBatch;++o)a._freePool.push(e());return a}return s(i,[{key:"alloc",value:function(){if(this._nextAvail<0){this._freePool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freePool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freePool[this._nextAvail--]}},{key:"free",value:function(e){this._freePool[++this._nextAvail]=e}},{key:"freeArray",value:function(e){this._freePool.length=this._nextAvail+1,Array.prototype.push.apply(this._freePool,e),this._nextAvail+=e.length}},{key:"tryShrink",value:function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freePool[e]);this._freePool.length=this._nextAvail>>1,this._nextAvail=this._freePool.length-1}}},{key:"destroy",value:function(){var e=arguments.length>0?arguments[0]:null;e&&ae(14100);var t=e||this._dtor;if(t)for(var n=0;n<=this._nextAvail;n++)t(this._freePool[n]);this._freePool.length=0,this._nextAvail=-1,g(l(i.prototype),"destroy",this).call(this)}}]),i}(Ah)),bh=e("RecyclePool",function(e){h(i,e);var t=v(i);function i(e,r,s){var a;n(this,i),(a=t.call(this))._fn=void 0,a._dtor=null,a._count=0,a._data=void 0,a._initSize=0,a._fn=e,a._dtor=s||null,a._data=new Array(r),a._initSize=r;for(var o=0;o<r;++o)a._data[o]=e();return a}return s(i,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}},{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]}},{key:"destroy",value:function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,g(l(i.prototype),"destroy",this).call(this)}},{key:"tryShrink",value:function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}}]),i}(Ah)),Ch=e("CachedArray",function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this)).array=void 0,s.length=0,s._compareFn=void 0,s._initSize=0,s.array=new Array(e),s._initSize=e,s.length=0,s._compareFn=r,s}return s(i,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[--this.length]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.length=0}},{key:"destroy",value:function(){this.length=0,this.array.length=0,g(l(i.prototype),"destroy",this).call(this)}},{key:"tryShrink",value:function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]}},{key:"fastRemove",value:function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}}},{key:"indexOf",value:function(e){for(var t=0,i=this.length;t<i;++t)if(this.array[t]===e)return t;return-1}}]),i}(Ah));e("memop",Object.freeze({__proto__:null,Pool:Eh,RecyclePool:bh,CachedArray:Ch}));var Rh=e("System",function(){function e(){n(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return s(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}},{key:"init",value:function(){}},{key:"update",value:function(){}},{key:"postUpdate",value:function(){}},{key:"destroy",value:function(){}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}());Rh.Priority=wt({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var xh=new ke("Scheduler"),wh=function e(t,i,r,s){n(this,e),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=i,this.paused=r,this.markedForDeletion=s};wh.get=function(e,t,i,n){var r=wh._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new wh(e,t,i,n),r},wh.put=function(e){wh._listEntries.length<20&&(e.target=null,wh._listEntries.push(e))},wh._listEntries=[];var kh=function e(t,i,r,s){n(this,e),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=i,this.target=r,this.callback=s};kh.get=function(e,t,i,n){var r=kh._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new kh(e,t,i,n),r},kh.put=function(e){kh._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,kh._hashUpdateEntries.push(e))},kh._hashUpdateEntries=[];var Ih=function e(t,i,r,s,a,o){n(this,e),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=i,this.timerIndex=r,this.currentTimer=s,this.currentTimerSalvaged=a,this.paused=o};Ih.get=function(e,t,i,n,r,s){var a=Ih._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=i,a.currentTimer=n,a.currentTimerSalvaged=r,a.paused=s):a=new Ih(e,t,i,n,r,s),a},Ih.put=function(e){Ih._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,Ih._hashTimerEntries.push(e))},Ih._hashTimerEntries=[];var Bh=function(){function e(){n(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return s(e,[{key:"initWithCallback",value:function(e,t,i,n,r,s){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=s,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===B.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();Bh._timers=[],Bh.get=function(){return Bh._timers.pop()||new Bh},Bh.put=function(e){Bh._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,Bh._timers.push(e))};var Ph=e("Scheduler",function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=Ue(!0),e._hashForTimers=Ue(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return s(i,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,n,r,s;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,n=(i=this._updatesNegList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updates0List).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updatesPosList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(s=a[t],this._currentTarget=s,this._currentTargetSalvaged=!1,!s.paused)for(s.timerIndex=0;s.timerIndex<s.timers.length;++s.timerIndex)s.currentTimer=s.timers[s.timerIndex],s.currentTimerSalvaged=!1,s.currentTimer.update(e),s.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,n,r,s){if("function"!=typeof e){var a=e;e=t,t=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(s=!!n,n=B.macro.REPEAT_FOREVER,r=0),ce(t,1502);var o=t.uuid||t.id;if(o){var u,h,l=this._hashForTimers[o];if(l?l.paused!==s&&ae(1511):(l=Ih.get(null,t,0,null,null,s),this._arrayForTimers.push(l),this._hashForTimers[o]=l),null==l.timers)l.timers=[];else for(h=0;h<l.timers.length;++h)if((u=l.timers[h])&&e===u._callback)return re(1507,u.getInterval(),i),void(u._interval=i);(u=Bh.get()).initWithCallback(this,e,t,i,n,r),l.timers.push(u),this._currentTarget===l&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else ue(1510)}},{key:"scheduleUpdate",value:function(e,t,i){var n=e.uuid||e.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return re(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var s,a=wh.get(e,t,i,!1);0===t?(s=this._updates0List,this._appendIn(s,a)):(s=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(s,a,t)),this._hashForUpdates[n]=kh.get(s,a,e,null)}else ue(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(n)for(var r=n.timers,s=0,a=r.length;s<a;s++){var o=r[s];if(e===o._callback)return o!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(s,1),Bh.put(o),n.timerIndex>=s&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}else ue(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else ue(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var n=i.timers;n.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,s=n.length;r<s;r++)Bh.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else ue(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(Rh.Priority.SCHEDULER)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,n,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)i=r[t],this.unscheduleAllForTarget(i.target);var s=0;if(e<0)for(t=0;t<this._updatesNegList.length;)s=this._updatesNegList.length,(n=this._updatesNegList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),s===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)s=this._updates0List.length,(n=this._updates0List[t])&&this.unscheduleUpdate(n.target),s===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)s=this._updatesPosList.length,(n=this._updatesPosList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),s===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){ce(e,1508),ce(t,1509);var i=t.uuid||t.id;if(!i)return ue(1510),!1;var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,s=0;s<r.length;++s)if(e===r[s]._callback)return!0;return!1}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(Rh.Priority.SCHEDULER)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,n,r,s=[],a=this._arrayForTimers;for(i=0,n=a.length;i<n;i++)(t=a[i])&&(t.paused=!0,s.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,s.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,s.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,s.push(r.target));return s}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){ce(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}else ue(1510)}},{key:"resumeTarget",value:function(e){ce(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}else ue(1510)}},{key:"isTargetPaused",value:function(e){ce(e,1505);var t=e.uuid||e.id;if(!t)return ue(1510),!1;var i=this._hashForTimers[t];if(i)return i.paused;var n=this._hashForUpdates[t];return!!n&&n.entry.paused}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}Ih.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var n=i.list,r=i.entry,s=0,a=n.length;s<a;s++)if(n[s]===r){n.splice(s,1);break}delete this._hashForUpdates[t],wh.put(r),kh.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}],[{key:"enableForTarget",value:function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?ae(1513):e.id=xh.getNewId())}}]),i}(Rh));Ph.ID="scheduler",B.Scheduler=Ph;var Mh={};me(Mh,"vmath",[{name:"vec2",newName:"Vec2",target:Gn,targetName:"math"},{name:"vec3",newName:"Vec3",target:Gn,targetName:"math"},{name:"vec4",newName:"Vec4",target:Gn,targetName:"math"},{name:"quat",newName:"Quat",target:Gn,targetName:"math"},{name:"mat3",newName:"Mat3",target:Gn,targetName:"math"},{name:"mat4",newName:"Mat4",target:Gn,targetName:"math"},{name:"color4",newName:"Color",target:Gn,targetName:"math"},{name:"rect",newName:"Rect",target:Gn,targetName:"math"},{name:"approx",newName:"approx",target:Gn,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:Gn,targetName:"math"},{name:"equals",newName:"equals",target:Gn,targetName:"math"},{name:"clamp",newName:"clamp",target:Gn,targetName:"math"},{name:"clamp01",newName:"clamp01",target:Gn,targetName:"math"},{name:"lerp",newName:"lerp",target:Gn,targetName:"math"},{name:"toRadian",newName:"toRadian",target:Gn,targetName:"math"},{name:"toDegree",newName:"toDegree",target:Gn,targetName:"math"},{name:"random",newName:"random",target:Gn,targetName:"math"},{name:"randomRange",newName:"randomRange",target:Gn,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:Gn,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:Gn,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:Gn,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:Gn,targetName:"math"},{name:"repeat",newName:"repeat",target:Gn,targetName:"math"},{name:"pingPong",newName:"pingPong",target:Gn,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:Gn,targetName:"math"}]),B.vmath=Mh,me(Ph.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:Ph,targetName:"Scheduler"}]),me(Ph,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return Rh.Priority.SCHEDULER}}]),pe(Ph,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),xe({replaceProperty:{since:"3.6.0",removed:!1},removeProperty:{since:"3.6.0",removed:!1},markAsWarning:{since:"3.6.0",removed:!1},setDefaultLogTimes:{since:"3.6.0",removed:!1}});var Oh=gt;function Dh(){}var Lh=function(){function e(){n(this,e),this.callback=Dh,this.target=void 0,this.once=!1}return s(e,[{key:"set",value:function(e,t,i){this.callback=e||Dh,this.target=t,this.once=!!i}},{key:"reset",value:function(){this.target=void 0,this.callback=Dh,this.once=!1}},{key:"check",value:function(){return!(Ua(this.target)&&!Ha(this.target,!0))}}]),e}(),Nh=new Eh((function(){return new Lh}),32),Fh=function(){function e(){n(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return s(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(i.reset(),Nh.free(i),Oh(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(i.reset(),Nh.free(i),Oh(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Oh(this.callbackInfos,e),Nh.free(t)),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),Nh.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||Oh(this.callbackInfos,e);this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),Gh=new Eh((function(){return new Fh}),16),Vh=e("CallbacksInvoker",function(){function e(){n(this,e),this._callbackTable=Ue(!0),this._offCallback=void 0}return s(e,[{key:"on",value:function(e,t,i,n){if(!this.hasEventListener(e,t,i)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=Gh.alloc());var s=Nh.alloc();s.set(t,i,n),r.callbackInfos.push(s)}return t}},{key:"hasEventListener",value:function(e,t,i){var n=this._callbackTable&&this._callbackTable[e];if(!n)return!1;var r=n.callbackInfos;if(!t){if(n.isInvoking){for(var s=0;s<r.length;++s)if(r[s])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var o=r[a];if(o&&o.check()&&o.callback===t&&o.target===i)return!0}return!1}},{key:"removeAll",value:function(e){var t=i(e);if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),Gh.free(n),delete this._callbackTable[e]))}else if(e)for(var r in this._callbackTable){var s=this._callbackTable[r];if(s.isInvoking)for(var a=s.callbackInfos,o=0;o<a.length;++o){var u=a[o];u&&u.target===e&&s.cancel(o)}else s.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var n,r=this._callbackTable&&this._callbackTable[e];if(r){var s=r.callbackInfos;if(t)for(var a=0;a<s.length;++a){var o=s[a];if(o&&o.callback===t&&o.target===i){r.cancel(a);break}}else this.removeAll(e)}null===(n=this._offCallback)||void 0===n||n.call(this)}},{key:"emit",value:function(e,t,i,n,r,s){var a=this._callbackTable&&this._callbackTable[e];if(a){var o=!a.isInvoking;a.isInvoking=!0;for(var u=a.callbackInfos,h=0,l=u.length;h<l;++h){var c=u[h];if(c){var _=c.callback,f=c.target;c.once&&this.off(e,_,f),c.check()?f?_.call(f,t,i,n,r,s):_(t,i,n,r,s):this.off(e,_,f)}}o&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}}},{key:"clear",value:function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),Gh.free(t),delete this._callbackTable[e])}}},{key:"_registerOffCallback",value:function(e){this._offCallback=e}}]),e}());function Uh(e){for(var t=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._callbackTable=Ue(!0),e}return s(i,[{key:"once",value:function(e,t,i){return this.on(e,t,i,!0)}},{key:"targetOff",value:function(e){this.removeAll(e)}}]),i}(e),i=Vh.prototype,r=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i)),a=0;a<r.length;++a){var o=r[a];if(!(o in t.prototype)){var u=Object.getOwnPropertyDescriptor(i,o);u&&Object.defineProperty(t.prototype,o,u)}}return t}var Hh=e("EventTarget",Uh((function e(){n(this,e)})));B.EventTarget=Hh;var zh,Wh,Xh,jh,qh,Yh,Kh=e("AsyncDelegate",function(){function e(){n(this,e),this._delegates=[]}return s(e,[{key:"add",value:function(e){this._delegates.includes(e)||this._delegates.push(e)}},{key:"hasListener",value:function(e){return this._delegates.includes(e)}},{key:"remove",value:function(e){At(this._delegates,e)}},{key:"dispatch",value:function(){for(var e=arguments,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return Promise.all(this._delegates.map((function(t){return t.apply(void 0,E(e))})).filter(Boolean))}}]),e}());!function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(zh||(zh={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg",e.HINDI="hi"}(Wh||(Wh={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(Xh||(Xh={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(jh||(jh={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.TAOBAO_CREATIVE_APP="TAOBAO_CREATIVE_APP",e.TAOBAO_MINI_GAME="TAOBAO_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(qh||(qh={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER",e.EVENT_GAMEPAD="EVENT_GAMEPAD",e.EVENT_HANDLE="EVENT_HANDLE",e.EVENT_HMD="EVENT_HMD",e.EVENT_HANDHELD="EVENT_HANDHELD"}(Yh||(Yh={}));var Qh=new(function(e){h(i,e);var t=v(i);function i(){var e,r,s;n(this,i),(s=t.call(this)).networkType=void 0,s.isNative=void 0,s.isBrowser=void 0,s.isMobile=void 0,s.isLittleEndian=void 0,s.platform=void 0,s.language=void 0,s.nativeLanguage=void 0,s.os=void 0,s.osVersion=void 0,s.osMainVersion=void 0,s.browserType=void 0,s.browserVersion=void 0,s.isXR=void 0,s._battery=void 0,s._featureMap=void 0,s._initPromise=void 0;var o,u=window.navigator,h=u.userAgent.toLowerCase();null===(e=u.getBattery)||void 0===e||e.call(u).then((function(e){s._battery=e})),s.networkType=Xh.LAN,s.isNative=!1,s.isBrowser=!0,s.isMobile=/mobile|android|iphone|ipad/.test(h),s.platform=s.isMobile?qh.MOBILE_BROWSER:qh.DESKTOP_BROWSER,s.isLittleEndian=(o=new ArrayBuffer(2),new DataView(o).setInt16(0,256,!0),256===new Int16Array(o)[0]);var l=u.language;s.nativeLanguage=l.toLowerCase(),l=(l=l||u.browserLanguage)?l.split("-")[0]:Wh.ENGLISH,s.language=l;var c=!1,_=!1,f="",d=0,m=/android\s*(\d+(?:\.\d+)*)/i.exec(h)||/android\s*(\d+(?:\.\d+)*)/i.exec(u.platform);m&&(c=!0,f=m[1]||"",d=parseInt(f)||0),(m=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(h))?(_=!0,f=m[2]||"",d=parseInt(f)||0):(/(iPhone|iPad|iPod)/.exec(u.platform)||"MacIntel"===u.platform&&u.maxTouchPoints&&u.maxTouchPoints>1)&&(_=!0,f="",d=0);var p=jh.UNKNOWN;-1!==u.appVersion.indexOf("Win")?p=jh.WINDOWS:_?p=jh.IOS:-1!==u.appVersion.indexOf("Mac")?p=jh.OSX:-1!==u.appVersion.indexOf("X11")&&-1===u.appVersion.indexOf("Linux")?p=jh.LINUX:c?p=jh.ANDROID:-1===u.appVersion.indexOf("Linux")&&-1===h.indexOf("ubuntu")||(p=jh.LINUX),s.os=p,s.osVersion=f,s.osMainVersion=d,s.browserType=zh.UNKNOWN;var v=/wechat|weixin|micromessenger/i.exec(h)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(h)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(h)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(h),y=v?v[0].toLowerCase():jh.UNKNOWN;("safari"===y&&c||"qq"===y&&/android.*applewebkit/i.test(h))&&(y=zh.ANDROID);var g={micromessenger:zh.WECHAT,wechat:zh.WECHAT,weixin:zh.WECHAT,trident:zh.IE,edge:zh.EDGE,"360 aphone":zh.BROWSER_360,mxbrowser:zh.MAXTHON,"opr/":zh.OPERA,ubrowser:zh.UC,huaweibrowser:zh.HUAWEI};s.browserType=g[y]||y,s.browserVersion="";var S=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(h);S||(S=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(h)),s.browserVersion=S?S[4]:"",s.isXR=!1;var A,T=document.createElement("canvas");T.getContext("2d");try{A=T.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){A=!1}if(s.browserType===zh.SAFARI){var E,b=null===(E=/ version\/(\d+)/.exec(h))||void 0===E?void 0:E[1];"string"==typeof b&&Number.parseInt(b)>=14&&(A=!0)}var C=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart||k,R=void 0!==document.documentElement.onmouseup||k;return s._featureMap=(a(r={},Yh.WEBP,A),a(r,Yh.IMAGE_BITMAP,!1),a(r,Yh.WEB_VIEW,!0),a(r,Yh.VIDEO_PLAYER,!0),a(r,Yh.SAFE_AREA,!1),a(r,Yh.INPUT_TOUCH,C),a(r,Yh.EVENT_KEYBOARD,void 0!==document.documentElement.onkeyup||k),a(r,Yh.EVENT_MOUSE,R),a(r,Yh.EVENT_TOUCH,C||R),a(r,Yh.EVENT_ACCELEROMETER,void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent),a(r,Yh.EVENT_GAMEPAD,void 0!==navigator.getGamepads||void 0!==navigator.webkitGetGamepads),a(r,Yh.EVENT_HANDLE,!1),a(r,Yh.EVENT_HMD,s.isXR),a(r,Yh.EVENT_HANDHELD,void 0!==navigator.xr),r),s._initPromise=[],s._initPromise.push(s._supportsImageBitmapPromise()),s._registerEvent(),s}return s(i,[{key:"_supportsImageBitmapPromise",value:function(){var e=this;if("undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob){var t=document.createElement("canvas");t.width=t.height=2;var i=createImageBitmap(t,{});if(i instanceof Promise)return i.then((function(t){e._setFeature(Yh.IMAGE_BITMAP,!0),null==t||t.close()}))}return Promise.resolve()}},{key:"_registerEvent",value:function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var i=!1,n=function(){i||(i=!0,t.emit("hide"))},r=function(e,n,r,s,a){i&&(i=!1,t.emit("show",e,n,r,s,a))};if(e)for(var s=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<s.length;a++)document.addEventListener(s[a],(function(t){var i=document[e];(i=i||t.hidden)?n():r()}));else window.addEventListener("blur",n),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",n),window.addEventListener("pageshow",r),document.addEventListener("pagehide",n),document.addEventListener("pageshow",r))}},{key:"_setFeature",value:function(e,t){return this._featureMap[e]=t}},{key:"init",value:function(){return Promise.all(this._initPromise)}},{key:"hasFeature",value:function(e){return this._featureMap[e]}},{key:"getBatteryLevel",value:function(){return this._battery?this._battery.level:1}},{key:"triggerGC",value:function(){}},{key:"openURL",value:function(e){window.open(e)}},{key:"now",value:function(){return Date.now?Date.now():+new Date}},{key:"restartJSVM",value:function(){}},{key:"close",value:function(){this.emit("close"),window.close()}}]),i}(Hh)),Jh=/(\.[^\.\/\?\\]*)(\?.*)?$/,Zh=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,$h=/[^\.\/]+\/\.\.\//;function el(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,s=i;r<s.length;r++){var a=s[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function tl(e){var t=Jh.exec(e);return t?t[1]:""}function il(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function nl(e,t){var i=e.indexOf("?");i>0&&(e=e.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return e;var r=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function rl(e){var t=Zh.exec(e);return t?t[2]:""}function sl(e,t){t=t||"";var i=e.indexOf("?"),n="";return i>0&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function al(e,t,i){if(0===t.indexOf("."))return sl(e,t);var n=e.indexOf("?"),r="",s=i?tl(e):"";return n>0&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+s+r}function ol(e){var t=e=String(e);do{t=e,e=e.replace($h,"")}while(t.length!==e.length);return e}function ul(e){return e.replace(/[\/\\]$/,"")}function hl(){return Qh.os===jh.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:el,extname:tl,mainFileName:il,basename:nl,dirname:rl,changeExtname:sl,changeBasename:al,_normalize:ol,stripSep:ul,getSeperator:hl}));var ll=new an;function cl(e,t,i,n){n||(n=new an),e.convertToUINode(t,i,n);var r=i.position;return n.add(r),n}function _l(e,t,i){return i||(i=new an),e.worldToScreen(t,i),i.x/=B.view.getScaleX(),i.y/=B.view.getScaleY(),i}var fl,dl=e("convertUtils",{WorldNode3DToLocalNodeUI:cl,WorldNode3DToWorldNodeUI:_l});B.pipelineUtils=dl,me(B.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0],r=t[3]||ll;return n.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),ve(Ct,"js",[{name:"js",suggest:"'js.js' is deprecated since v3.7.0, please access 'js' directly instead."}]),function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(fl||(fl={}));var ml,pl={auto:fl.AUTO,landscape:fl.LANDSCAPE,portrait:fl.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(ml||(ml={}));var vl=new(function(e){h(i,e);var t=v(i);function i(){var e,r,s,a,o,u;n(this,i),(e=t.call(this)).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new Mn(0,0),e._exactFitScreen=!1,e._isHeadlessMode=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=fl.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null===(r=e._gameCanvas)||void 0===r||null===(s=r.parentNode)||void 0===s||s.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(a=e._gameCanvas)||void 0===a||null===(o=a.parentNode)||void 0===o||o.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var h=e._fnGroup,l=0;l<h.length;l++)if(u=h[l],void 0!==document[u[1]]){for(var c=0;c<u.length;c++)e._fn[h[0][c]]=u[c];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}return s(i,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!==(e=window.devicePixelRatio)&&void 0!==e?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===ml.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):ae(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new Mn(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-top")||"0"),bottom:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-bottom")||"0"),left:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-left")||"0"),right:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-right")||"0")}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new Mn(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(ae(9201),new Mn(0,0));var e,t,i;switch(this._windowType){case ml.SubFrame:return this._gameFrame?new Mn(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(ae(9201),new Mn(0,0));case ml.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,i=this.isFrameRotated?e.clientWidth:e.clientHeight,new Mn(t,i);case ml.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,i=this.isFrameRotated?window.innerWidth:window.innerHeight,new Mn(t,i);case ml.Unknown:default:return new Mn(0,0)}}},{key:"_windowType",get:function(){return this._isHeadlessMode?ml.Unknown:this.isFullScreen?ml.Fullscreen:this._gameFrame?this._exactFitScreen?ml.BrowserWindow:ml.SubFrame:(ae(9201),ml.Unknown)}},{key:"init",value:function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=pl[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._isHeadlessMode=e.isHeadlessMode,this._resizeFrame()}},{key:"requestFullScreen",value:function(){var e=this;return new Promise((function(t,i){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var n=e._getFullscreenTarget();n?n.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(i)}),{once:!0,capture:!0}):i(new Error("Cannot access fullscreen target"))})))}))}},{key:"exitFullScreen",value:function(){var e=this;return new Promise((function(t,i){var n=document[e._fn.exitFullscreen]();window.Promise&&n instanceof Promise?n.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(i):(e.windowSize=e._cachedFrameSize,t())}))}},{key:"_registerEvent",value:function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var i,n,r=window.devicePixelRatio;null===(i=window.matchMedia("(resolution: ".concat(r,"dppx)")))||void 0===i||null===(n=i.addEventListener)||void 0===n||n.call(i,"change",(function(){e.emit("window-resize",e.windowSize.width,e.windowSize.height),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change",e.windowSize.width,e.windowSize.height),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change",e.windowSize.width,e.windowSize.height)}))}},{key:"_convertToSizeInCssPixels",value:function(e){var t=e.clone(),i=this.devicePixelRatio;return t.width/=i,t.height/=i,t}},{key:"_resizeFrame",value:function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===ml.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width="".concat(e.width,"px"),this._gameFrame.style.height="".concat(e.height,"px")}else{var t=window.innerWidth,i=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 ".concat(t,"px"),this._gameFrame.style.width="".concat(i,"px"),this._gameFrame.style.height="".concat(t,"px")):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width="".concat(t,"px"),this._gameFrame.style.height="".concat(i,"px"))}this._updateContainer()}}},{key:"_getFullscreenTarget",value:function(){var e=this._windowType;return e===ml.Fullscreen?document[this._fn.fullscreenElement]:e===ml.SubFrame?this._gameFrame:document.body}},{key:"_doRequestFullScreen",value:function(){var e=this;return new Promise((function(t,i){if(e._supportFullScreen){var n=e._getFullscreenTarget();if(n){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=n[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(i):(e._onFullscreenChange=t,e._onFullscreenError=i)}else i(new Error("Cannot access fullscreen target"))}else i(new Error("fullscreen is not supported"))}))}},{key:"_updateFrameState",value:function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=Qh.isMobile&&(t&&e===fl.PORTRAIT||!t&&e===fl.LANDSCAPE)}},{key:"_updateContainer",value:function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void ae(9201);var e,t,i=B.view.getDesignResolutionSize(),n=this._gameFrame,r=n.clientWidth,s=n.clientHeight,a=i.width,o=i.height,u=r/a,h=s/o,l=this._gameContainer.style;u<h?(e=r,t=o*u):(e=a*h,t=s),l.width="".concat(e,"px"),l.height="".concat(t,"px")}else{var c=this._gameContainer.style;c.width="100%",c.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize",this.windowSize.width,this.windowSize.height),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else ae(9201)}}]),i}(Hh)),yl=function(){function e(){n(this,e)}return s(e,[{key:"init",value:function(){var e,t,i=null===(e=Dt.querySettings(Ot.Category.SCREEN,"exactFitScreen"))||void 0===e||e,n=null!==(t=Dt.querySettings(Ot.Category.SCREEN,"orientation"))&&void 0!==t?t:"auto",r=3===Dt.querySettings(Ot.Category.RENDERING,"renderMode");vl.init({exactFitScreen:i,configOrientation:n,isHeadlessMode:r},(function(){var e,t=B.director;null!==(e=t.root)&&void 0!==e&&e.pipeline?t.root.pipeline.shadingScale=vl.resolutionScale:ae(1220)}))}},{key:"devicePixelRatio",get:function(){return vl.devicePixelRatio}},{key:"windowSize",get:function(){return vl.windowSize},set:function(e){vl.windowSize=e}},{key:"resolution",get:function(){return vl.resolution}},{key:"supportsFullScreen",get:function(){return vl.supportFullScreen}},{key:"fullScreen",value:function(){return vl.isFullScreen}},{key:"requestFullScreen",value:function(e,t,i){return arguments.length>0&&ae(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),vl.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==i||i()}))}},{key:"exitFullScreen",value:function(){return vl.exitFullScreen()}},{key:"autoFullScreen",value:function(e,t){var i;null===(i=this.requestFullScreen(e,t))||void 0===i||i.catch((function(){}))}},{key:"disableAutoFullScreen",value:function(){}}]),e}(),gl=e("screen",new yl);B.screen=gl;var Sl=e("sys",{Feature:Yh,hasFeature:function(e){return Qh.hasFeature(e)},NetworkType:Xh,Language:Wh,OS:jh,Platform:qh,BrowserType:zh,isNative:Qh.isNative,isBrowser:Qh.isBrowser,isMobile:Qh.isMobile,isLittleEndian:Qh.isLittleEndian,platform:Qh.platform,language:Qh.language,languageCode:Qh.nativeLanguage,os:Qh.os,osVersion:Qh.osVersion,osMainVersion:Qh.osMainVersion,browserType:Qh.browserType,browserVersion:Qh.browserVersion,isXR:Qh.isXR,windowPixelResolution:gl.windowSize,capabilities:{canvas:!0,opengl:!0,webp:Qh.hasFeature(Yh.WEBP),imageBitmap:Qh.hasFeature(Yh.IMAGE_BITMAP),touches:Qh.hasFeature(Yh.INPUT_TOUCH),mouse:Qh.hasFeature(Yh.EVENT_MOUSE),keyboard:Qh.hasFeature(Yh.EVENT_KEYBOARD),accelerometer:Qh.hasFeature(Yh.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return Qh.networkType},getBatteryLevel:function(){return Qh.getBatteryLevel()},garbageCollect:function(){Qh.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : ".concat(this.isMobile,"\r\n"),e+="language : ".concat(this.language,"\r\n"),e+="browserType : ".concat(this.browserType,"\r\n"),e+="browserVersion : ".concat(this.browserVersion,"\r\n"),e+="supports webp: ".concat(Sl.hasFeature(Yh.WEBP),"\r\n"),e+="supports bitmap: ".concat(Sl.hasFeature(Yh.IMAGE_BITMAP),"\r\n"),e+="supports touches: ".concat(Sl.hasFeature(Yh.INPUT_TOUCH),"\r\n"),e+="supports mouse: ".concat(Sl.hasFeature(Yh.EVENT_MOUSE),"\r\n"),e+="supports keyboard: ".concat(Sl.hasFeature(Yh.EVENT_KEYBOARD),"\r\n"),e+="supports accelerometer: ".concat(Sl.hasFeature(Yh.EVENT_ACCELEROMETER),"\r\n"),e+="os : ".concat(this.os,"\r\n"),e+="osVersion : ".concat(this.osVersion,"\r\n"),e+="platform : ".concat(this.platform,"\r\n"),K(e+="Using ".concat(B.game.renderType===B.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS"," renderer.\r\n"))},openURL:function(e){Qh.openURL(e)},init:function(){var e=this;return Promise.resolve().then((function(){return Qh.init()})).then((function(){try{var t=Sl.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){var i=function(){ae(5200)};e.localStorage={getItem:i,setItem:i,clear:i,removeItem:i}}e.__isWebIOS14OrIPadOS14Env=(Sl.os===jh.IOS||Sl.os===jh.OSX)&&Qh.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}))},now:function(){return Qh.now()},restartVM:function(){Qh.restartJSVM()},getSafeAreaRect:function(){var e=B.view,t=vl.safeAreaEdge,i=vl.windowSize,n=new In(t.left,t.bottom),r=new In(i.width-t.right,i.height-t.top);e._convertToUISpace(n),e._convertToUISpace(r);var s=n.x,a=n.y,o=r.x-n.x,u=r.y-n.y;return new Dn(s,a,o,u)}});B.sys=Sl,ve(B,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),ve(Sl,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),me(Sl,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_".concat(e),newName:e,target:Sl.Language,targetName:"sys.Language"}}))),me(Sl,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_".concat(e),newName:e,target:Sl.OS,targetName:"sys.OS"}}))),me(Sl,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_".concat(e),newName:e,target:Sl.BrowserType,targetName:"sys.BrowserType"}}))),me(Sl,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:Sl.BrowserType,targetName:"sys.BrowserType"}]),me(Sl,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:Sl.Platform,targetName:"sys.Platform"}}))),me(Sl,"sys",[{name:"IPHONE",newName:"IOS",target:Sl.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:Sl.Platform,targetName:"sys.Platform"}]),pe(Sl,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),me(Sl,"sys",[{name:"windowPixelResolution",target:gl,targetName:"screen",newName:"windowSize"}]),ve(gl,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var Al=e("visibleRect",{topLeft:B.v2(0,0),topRight:B.v2(0,0),top:B.v2(0,0),bottomLeft:B.v2(0,0),bottomRight:B.v2(0,0),bottom:B.v2(0,0),center:B.v2(0,0),left:B.v2(0,0),right:B.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,s=r+i,a=n+t;this.topLeft.x=n,this.topLeft.y=s,this.topRight.x=a,this.topRight.y=s,this.top.x=n+t/2,this.top.y=s,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=a,this.right.y=r+i/2}});B.visibleRect=Al;var Tl=String.prototype.charCodeAt;function El(e){return this[e]}function bl(e,t){for(var i=e.length,n=t^i,r=0,s="string"==typeof e?Tl:El;i>=4;){var a=255&s.call(e,r)|(255&s.call(e,++r))<<8|(255&s.call(e,++r))<<16|(255&s.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&s.call(e,r+2))<<16;case 2:n^=(255&s.call(e,r+1))<<8;case 1:n=1540483477*(65535&(n^=255&s.call(e,r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}function Cl(){}B.easing=zo,Cl.prototype.once=function(e,t,i){return this.on(e,t,i,!0)},Cl.prototype.targetOff=function(e){this.removeAll(e)},e("jsbUtils",Object.freeze({__proto__:null,syncNodeValues:function(e){var t=e._lpos;e.setPositionForJS(t.x,t.y,t.z);var i=e._lscale;e.setScaleForJS(i.x,i.y,i.z);var n=e._lrot;e.setRotationForJS(n.x,n.y,n.z,n.w);var r=e._euler;e.setRotationFromEulerForJS(r.x,r.y,r.z)},updateChildrenForDeserialize:function e(t){if(t){var i=t._children;if(i){var n=i.length;if(n){t._setChildren(i);for(var r=0;r<n;++r)e(i[r])}}}},ExtraEventMethods:Cl}));var Rl=function(){function e(){n(this,e),this._finalizationRegistry=null,this._gcObjects=new WeakMap}return s(e,[{key:"registerGCObject",value:function(e){return e}},{key:"init",value:function(){}},{key:"finalizationRegistryCallback",value:function(e){var t=this._gcObjects.get(e);t&&(this._gcObjects.delete(e),t.destroy()),this._finalizationRegistry.unregister(e)}},{key:"destroy",value:function(){}}]),e}(),xl=e("garbageCollectionManager",new Rl),wl=e("GCObject",function(){function e(){return n(this,e),xl.registerGCObject(this)}return s(e,[{key:"destroy",value:function(){}}]),e}());function kl(e,t){for(var i,n=R(t);!(i=n()).done;){var r=i.value;Array.isArray(r)?kl(e,r):e.push(r)}}function Il(e){var t=[];return kl(t,e),t.join("")}B.math=Gn,B.geometry=Sh;var Bl,Pl,Ml,Ol,Dl,Ll,Nl,Fl,Gl,Vl,Ul,Hl,zl,Wl,Xl,jl,ql,Yl,Kl,Ql,Jl,Zl,$l,ec,tc,ic,nc,rc,sc,ac,oc,uc,hc,lc,cc,_c,fc,dc,mc,pc,vc,yc,gc,Sc,Ac=function(e,t,i){for(var n=0;n<t.length;++n)e.length<=n&&e.push(new i),e[n].copy(t[n]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(Bl||(Bl={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(Pl||(Pl={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.NVN=5]="NVN",e[e.WEBGL=6]="WEBGL",e[e.WEBGL2=7]="WEBGL2",e[e.WEBGPU=8]="WEBGPU"}(Ml||(Ml={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(Ol||(Ol={})),function(e){e[e.ELEMENT_INDEX_UINT=0]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=1]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=2]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=3]="BLEND_MINMAX",e[e.COMPUTE_SHADER=4]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=5]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=6]="COUNT"}(Dl||(Dl={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(Ll||(Ll={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Nl||(Nl={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(Fl||(Fl={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(Gl||(Gl={})),function(e){e[e.NONE=0]="NONE"}(Vl||(Vl={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(Ul||(Ul={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(Hl||(Hl={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(zl||(zl={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Wl||(Wl={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Xl||(Xl={})),function(e){e[e.NONE=0]="NONE",e[e.RENDER_TARGET=1]="RENDER_TARGET",e[e.SAMPLED_TEXTURE=2]="SAMPLED_TEXTURE",e[e.LINEAR_FILTER=4]="LINEAR_FILTER",e[e.STORAGE_TEXTURE=8]="STORAGE_TEXTURE",e[e.VERTEX_ATTRIBUTE=16]="VERTEX_ATTRIBUTE"}(jl||(jl={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(ql||(ql={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(Yl||(Yl={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Kl||(Kl={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Ql||(Ql={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Jl||(Jl={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Zl||(Zl={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}($l||($l={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(ec||(ec={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(tc||(tc={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(ic||(ic={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(nc||(nc={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(rc||(rc={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=4]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=8]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=16]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=32]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=64]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=128]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=256]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=512]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=1024]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=2048]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=4096]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=8192]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=16384]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=32768]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=65536]="TRANSFER_READ",e[e.HOST_READ=131072]="HOST_READ",e[e.PRESENT=262144]="PRESENT",e[e.VERTEX_SHADER_WRITE=524288]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=1048576]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=2097152]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=4194304]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=8388608]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=16777216]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=33554432]="HOST_PREINITIALIZED",e[e.HOST_WRITE=67108864]="HOST_WRITE"}(sc||(sc={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(ac||(ac={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(oc||(oc={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(uc||(uc={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(hc||(hc={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(lc||(lc={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(cc||(cc={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(_c||(_c={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(fc||(fc={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(dc||(dc={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(mc||(mc={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(pc||(pc={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(vc||(vc={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(yc||(yc={})),function(e){e[e.FULL=0]="FULL",e[e.SPLIT_BEGIN=1]="SPLIT_BEGIN",e[e.SPLIT_END=2]="SPLIT_END"}(gc||(gc={})),function(e){e[e.RASTER=0]="RASTER",e[e.COMPUTE=1]="COMPUTE",e[e.COPY=2]="COPY",e[e.MOVE=3]="MOVE",e[e.RAYTRACE=4]="RAYTRACE",e[e.PRESENT=5]="PRESENT"}(Sc||(Sc={}));var Tc,Ec=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(this,e),this.x=t,this.y=i,this.z=r}return s(e,[{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}}]),e}(),bc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,f=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,d=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,m=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,p=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,v=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1,y=arguments.length>16&&void 0!==arguments[16]?arguments[16]:0,g=arguments.length>17&&void 0!==arguments[17]?arguments[17]:0,S=arguments.length>18&&void 0!==arguments[18]?arguments[18]:new Ec,A=arguments.length>19&&void 0!==arguments[19]?arguments[19]:new Ec,T=arguments.length>20&&void 0!==arguments[20]&&arguments[20],E=arguments.length>21&&void 0!==arguments[21]?arguments[21]:-1,b=arguments.length>22&&void 0!==arguments[22]?arguments[22]:1,C=arguments.length>23&&void 0!==arguments[23]?arguments[23]:1;n(this,e),this.maxVertexAttributes=t,this.maxVertexUniformVectors=i,this.maxFragmentUniformVectors=r,this.maxTextureUnits=s,this.maxImageUnits=a,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=u,this.maxShaderStorageBufferBindings=h,this.maxShaderStorageBlockSize=l,this.maxUniformBufferBindings=c,this.maxUniformBlockSize=_,this.maxTextureSize=f,this.maxCubeMapTextureSize=d,this.maxArrayTextureLayers=m,this.max3DTextureSize=p,this.uboOffsetAlignment=v,this.maxComputeSharedMemorySize=y,this.maxComputeWorkGroupInvocations=g,this.maxComputeWorkGroupSize=S,this.maxComputeWorkGroupCount=A,this.supportQuery=T,this.clipSpaceMinZ=E,this.screenSpaceSignY=b,this.clipSpaceSignY=C}return s(e,[{key:"copy",value:function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.maxArrayTextureLayers=e.maxArrayTextureLayers,this.max3DTextureSize=e.max3DTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this}}]),e}(),Cc=function(){function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];n(this,e),this.enableBarrierDeduce=t}return s(e,[{key:"copy",value:function(e){return this.enableBarrierDeduce=e.enableBarrierDeduce,this}}]),e}(),Rc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(this,e),this.x=t,this.y=i,this.z=r}return s(e,[{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}}]),e}(),xc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;n(this,e),this.x=t,this.y=i,this.width=r,this.height=s}return s(e,[{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}}]),e}(),wc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;n(this,e),this.width=t,this.height=i,this.depth=r}return s(e,[{key:"copy",value:function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this}}]),e}(),kc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;n(this,e),this.mipLevel=t,this.baseArrayLayer=i,this.layerCount=r}return s(e,[{key:"copy",value:function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this}}]),e}(),Ic=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;n(this,e),this.baseMipLevel=t,this.levelCount=i,this.baseArrayLayer=r,this.layerCount=s}return s(e,[{key:"copy",value:function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this}}]),e}(),Bc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new kc,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Rc,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new kc,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Rc,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new wc;n(this,e),this.srcSubres=t,this.srcOffset=i,this.dstSubres=r,this.dstOffset=s,this.extent=a}return s(e,[{key:"copy",value:function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this}}]),e}(),Pc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new kc,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Rc,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new wc,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new kc,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Rc,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new wc;n(this,e),this.srcSubres=t,this.srcOffset=i,this.srcExtent=r,this.dstSubres=s,this.dstOffset=a,this.dstExtent=o}return s(e,[{key:"copy",value:function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this}}]),e}(),Mc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Rc,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new wc,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new kc;n(this,e),this.buffOffset=t,this.buffStride=i,this.buffTexHeight=r,this.texOffset=s,this.texExtent=a,this.texSubres=o}return s(e,[{key:"copy",value:function(e){return this.buffOffset=e.buffOffset,this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this}}]),e}(),Oc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;n(this,e),this.left=t,this.top=i,this.width=r,this.height=s,this.minDepth=a,this.maxDepth=o}return s(e,[{key:"copy",value:function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this}}]),e}(),Dc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;n(this,e),this.x=t,this.y=i,this.z=r,this.w=s}return s(e,[{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}}]),e}(),Lc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[0],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[0],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[0],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[0],u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[0],h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:[0];n(this,e),this.maxBlockCounts=t,this.maxSamplerTextureCounts=i,this.maxSamplerCounts=r,this.maxTextureCounts=s,this.maxBufferCounts=a,this.maxImageCounts=o,this.maxSubpassInputCounts=u,this.setIndices=h}return s(e,[{key:"copy",value:function(e){return this.maxBlockCounts=e.maxBlockCounts.slice(),this.maxSamplerTextureCounts=e.maxSamplerTextureCounts.slice(),this.maxSamplerCounts=e.maxSamplerCounts.slice(),this.maxTextureCounts=e.maxTextureCounts.slice(),this.maxBufferCounts=e.maxBufferCounts.slice(),this.maxImageCounts=e.maxImageCounts.slice(),this.maxSubpassInputCounts=e.maxSubpassInputCounts.slice(),this.setIndices=e.setIndices.slice(),this}}]),e}(),Nc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Yl.ON,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;n(this,e),this.windowId=t,this.windowHandle=i,this.vsyncMode=r,this.width=s,this.height=a}return s(e,[{key:"copy",value:function(e){return this.windowId=e.windowId,this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this}}]),e}(),Fc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Lc;n(this,e),this.bindingMappingInfo=t}return s(e,[{key:"copy",value:function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this}}]),e}(),Gc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Gl.NONE,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Hl.NONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Vl.NONE;n(this,e),this.usage=t,this.memUsage=i,this.size=r,this.stride=s,this.flags=a}return s(e,[{key:"copy",value:function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this}}]),e}(),Vc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(this,e),this.buffer=t,this.offset=i,this.range=r}return s(e,[{key:"copy",value:function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this}}]),e}(),Uc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;n(this,e),this.vertexCount=t,this.firstVertex=i,this.indexCount=r,this.firstIndex=s,this.vertexOffset=a,this.instanceCount=o,this.firstInstance=u}return s(e,[{key:"copy",value:function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this}}]),e}(),Hc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;n(this,e),this.groupCountX=t,this.groupCountY=i,this.groupCountZ=r,this.indirectBuffer=s,this.indirectOffset=a}return s(e,[{key:"copy",value:function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this}}]),e}(),zc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];n(this,e),this.drawInfos=t}return s(e,[{key:"copy",value:function(e){return Ac(this.drawInfos,e.drawInfos,Uc),this}}]),e}(),Wc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:zl.TEX2D,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Wl.NONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ll.UNKNOWN,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Xl.NONE,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:ql.ONE,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:1,_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0;n(this,e),this.type=t,this.usage=i,this.format=r,this.width=s,this.height=a,this.flags=o,this.layerCount=u,this.levelCount=h,this.samples=l,this.depth=c,this.externalRes=_}return s(e,[{key:"copy",value:function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this}}]),e}(),Xc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:zl.TEX2D,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ll.UNKNOWN,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;n(this,e),this.texture=t,this.type=i,this.format=r,this.baseLevel=s,this.levelCount=a,this.baseLayer=o,this.layerCount=u}return s(e,[{key:"copy",value:function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this}}]),e}(),jc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Kl.LINEAR,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Kl.LINEAR,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Kl.NONE,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ql.WRAP,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ql.WRAP,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Ql.WRAP,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Jl.ALWAYS;n(this,e),this.minFilter=t,this.magFilter=i,this.mipFilter=r,this.addressU=s,this.addressV=a,this.addressW=o,this.maxAnisotropy=u,this.cmpFunc=h}return s(e,[{key:"copy",value:function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this}}]),e}(),qc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Fl.UNKNOWN,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(this,e),this.name=t,this.type=i,this.count=r}return s(e,[{key:"copy",value:function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this}}]),e}(),Yc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;n(this,e),this.set=t,this.binding=i,this.name=r,this.members=s,this.count=a,this.flattened=o}return s(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,Ac(this.members,e.members,qc),this.count=e.count,this.flattened=e.flattened,this}}]),e}(),Kc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Fl.UNKNOWN,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;n(this,e),this.set=t,this.binding=i,this.name=r,this.type=s,this.count=a,this.flattened=o}return s(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.flattened=e.flattened,this}}]),e}(),Qc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;n(this,e),this.set=t,this.binding=i,this.name=r,this.count=s,this.flattened=a}return s(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.flattened=e.flattened,this}}]),e}(),Jc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Fl.UNKNOWN,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;n(this,e),this.set=t,this.binding=i,this.name=r,this.type=s,this.count=a,this.flattened=o}return s(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.flattened=e.flattened,this}}]),e}(),Zc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Fl.UNKNOWN,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Ul.READ_WRITE,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;n(this,e),this.set=t,this.binding=i,this.name=r,this.type=s,this.count=a,this.memoryAccess=o,this.flattened=u}return s(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this.flattened=e.flattened,this}}]),e}(),$c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ul.READ_WRITE,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;n(this,e),this.set=t,this.binding=i,this.name=r,this.count=s,this.memoryAccess=a,this.flattened=o}return s(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this.flattened=e.flattened,this}}]),e}(),e_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;n(this,e),this.set=t,this.binding=i,this.name=r,this.count=s,this.flattened=a}return s(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.flattened=e.flattened,this}}]),e}(),t_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ic.NONE,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";n(this,e),this.stage=t,this.source=i}return s(e,[{key:"copy",value:function(e){return this.stage=e.stage,this.source=e.source,this}}]),e}(),i_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ll.UNKNOWN,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;n(this,e),this.name=t,this.format=i,this.isNormalized=r,this.stream=s,this.isInstanced=a,this.location=o}return s(e,[{key:"copy",value:function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this}}]),e}(),n_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[],h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:[],l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:[],c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:[];n(this,e),this.name=t,this.stages=i,this.attributes=r,this.blocks=s,this.buffers=a,this.samplerTextures=o,this.samplers=u,this.textures=h,this.images=l,this.subpassInputs=c}return s(e,[{key:"copy",value:function(e){return this.name=e.name,Ac(this.stages,e.stages,t_),Ac(this.attributes,e.attributes,i_),Ac(this.blocks,e.blocks,Yc),Ac(this.buffers,e.buffers,$c),Ac(this.samplerTextures,e.samplerTextures,Kc),Ac(this.samplers,e.samplers,Qc),Ac(this.textures,e.textures,Jc),Ac(this.images,e.images,Zc),Ac(this.subpassInputs,e.subpassInputs,e_),this}}]),e}(),r_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n(this,e),this.attributes=t,this.vertexBuffers=i,this.indexBuffer=r,this.indirectBuffer=s}return s(e,[{key:"copy",value:function(e){return Ac(this.attributes,e.attributes,i_),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this}}]),e}(),s_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ll.UNKNOWN,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ql.ONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:nc.CLEAR,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:rc.STORE,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];n(this,e),this.format=t,this.sampleCount=i,this.loadOp=r,this.storeOp=s,this.barrier=a,this.isGeneralLayout=o}return s(e,[{key:"copy",value:function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this}}]),e}(),a_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ll.UNKNOWN,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ql.ONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:nc.CLEAR,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:rc.STORE,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:nc.CLEAR,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:rc.STORE,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,h=arguments.length>7&&void 0!==arguments[7]&&arguments[7];n(this,e),this.format=t,this.sampleCount=i,this.depthLoadOp=r,this.depthStoreOp=s,this.stencilLoadOp=a,this.stencilStoreOp=o,this.barrier=u,this.isGeneralLayout=h}return s(e,[{key:"copy",value:function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this}}]),e}(),o_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:-1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:ac.NONE,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:ac.NONE;n(this,e),this.inputs=t,this.colors=i,this.resolves=r,this.preserves=s,this.depthStencil=a,this.depthStencilResolve=o,this.depthResolveMode=u,this.stencilResolveMode=h}return s(e,[{key:"copy",value:function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this}}]),e}(),u_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;n(this,e),this.srcSubpass=t,this.dstSubpass=i,this.generalBarrier=r,this.bufferBarriers=s,this.buffers=a,this.bufferBarrierCount=o,this.textureBarriers=u,this.textures=h,this.textureBarrierCount=l}return s(e,[{key:"copy",value:function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.generalBarrier=e.generalBarrier,this.bufferBarriers=e.bufferBarriers,this.buffers=e.buffers,this.bufferBarrierCount=e.bufferBarrierCount,this.textureBarriers=e.textureBarriers,this.textures=e.textures,this.textureBarrierCount=e.textureBarrierCount,this}}]),e}(),h_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new a_,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];n(this,e),this.colorAttachments=t,this.depthStencilAttachment=i,this.subpasses=r,this.dependencies=s}return s(e,[{key:"copy",value:function(e){return Ac(this.colorAttachments,e.colorAttachments,s_),this.depthStencilAttachment.copy(e.depthStencilAttachment),Ac(this.subpasses,e.subpasses,o_),Ac(this.dependencies,e.dependencies,u_),this}}]),e}(),l_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:sc.NONE,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:sc.NONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:gc.FULL;n(this,e),this.prevAccesses=t,this.nextAccesses=i,this.type=r}return s(e,[{key:"copy",value:function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this.type=e.type,this}}]),e}(),c_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:sc.NONE,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:sc.NONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:gc.FULL,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,h=arguments.length>7&&void 0!==arguments[7]&&arguments[7],l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null;n(this,e),this.prevAccesses=t,this.nextAccesses=i,this.type=r,this.baseMipLevel=s,this.levelCount=a,this.baseSlice=o,this.sliceCount=u,this.discardContents=h,this.srcQueue=l,this.dstQueue=c}return s(e,[{key:"copy",value:function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this.type=e.type,this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseSlice=e.baseSlice,this.sliceCount=e.sliceCount,this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this}}]),e}(),__=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:sc.NONE,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:sc.NONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:gc.FULL,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;n(this,e),this.prevAccesses=t,this.nextAccesses=i,this.type=r,this.offset=s,this.size=a,this.discardContents=o,this.srcQueue=u,this.dstQueue=h}return s(e,[{key:"copy",value:function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this.type=e.type,this.offset=e.offset,this.size=e.size,this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this}}]),e}(),f_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;n(this,e),this.renderPass=t,this.colorTextures=i,this.depthStencilTexture=r}return s(e,[{key:"copy",value:function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this}}]),e}(),d_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:dc.UNKNOWN,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ic.NONE,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];n(this,e),this.binding=t,this.descriptorType=i,this.count=r,this.stageFlags=s,this.immutableSamplers=a}return s(e,[{key:"copy",value:function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this}}]),e}(),m_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];n(this,e),this.bindings=t}return s(e,[{key:"copy",value:function(e){return Ac(this.bindings,e.bindings,d_),this}}]),e}(),p_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;n(this,e),this.layout=t}return s(e,[{key:"copy",value:function(e){return this.layout=e.layout,this}}]),e}(),v_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];n(this,e),this.setLayouts=t}return s(e,[{key:"copy",value:function(e){return this.setLayouts=e.setLayouts.slice(),this}}]),e}(),y_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];n(this,e),this.attributes=t}return s(e,[{key:"copy",value:function(e){return Ac(this.attributes,e.attributes,i_),this}}]),e}(),g_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:vc.PRIMARY;n(this,e),this.queue=t,this.type=i}return s(e,[{key:"copy",value:function(e){return this.queue=e.queue,this.type=e.type,this}}]),e}(),S_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:mc.GRAPHICS;n(this,e),this.type=t}return s(e,[{key:"copy",value:function(e){return this.type=e.type,this}}]),e}(),A_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:pc.OCCLUSION,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32767,r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];n(this,e),this.type=t,this.maxQueryObjects=i,this.forceWait=r}return s(e,[{key:"copy",value:function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this}}]),e}(),T_=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Nl.NONE,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],u=arguments.length>6&&void 0!==arguments[6]&&arguments[6],h=arguments.length>7&&void 0!==arguments[7]&&arguments[7];n(this,e),this.name=t,this.size=i,this.count=r,this.type=s,this.hasAlpha=a,this.hasDepth=o,this.hasStencil=u,this.isCompressed=h},E_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;n(this,e),this.bufferSize=t,this.textureSize=i}return s(e,[{key:"copy",value:function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this}}]),e}(),b_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(this,e),this.writeMask=t,this.compareMask=i,this.reference=r}return s(e,[{key:"copy",value:function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this}}]),e}(),C_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Oc,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new xc,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Dc,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:new b_,_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:new b_;n(this,e),this.viewport=t,this.scissor=i,this.blendConstant=r,this.lineWidth=s,this.depthBiasConstant=a,this.depthBiasClamp=o,this.depthBiasSlope=u,this.depthMinBounds=h,this.depthMaxBounds=l,this.stencilStatesFront=c,this.stencilStatesBack=_}return s(e,[{key:"copy",value:function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this}}]),e}(),R_=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this))._objectType=Bl.UNKNOWN,r._objectID=0,r._typedID=0,r._objectType=e,r._objectID=i._idTable[Bl.UNKNOWN]++,r._typedID=i._idTable[e]++,r}return s(i,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),i}(wl);R_._idTable=Array(Bl.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(Tc||(Tc={}));var x_=Object.freeze([new T_("UNKNOWN",0,0,Nl.NONE,!1,!1,!1,!1),new T_("A8",1,1,Nl.UNORM,!0,!1,!1,!1),new T_("L8",1,1,Nl.UNORM,!1,!1,!1,!1),new T_("LA8",1,2,Nl.UNORM,!0,!1,!1,!1),new T_("R8",1,1,Nl.UNORM,!1,!1,!1,!1),new T_("R8SN",1,1,Nl.SNORM,!1,!1,!1,!1),new T_("R8UI",1,1,Nl.UINT,!1,!1,!1,!1),new T_("R8I",1,1,Nl.INT,!1,!1,!1,!1),new T_("R16F",2,1,Nl.FLOAT,!1,!1,!1,!1),new T_("R16UI",2,1,Nl.UINT,!1,!1,!1,!1),new T_("R16I",2,1,Nl.INT,!1,!1,!1,!1),new T_("R32F",4,1,Nl.FLOAT,!1,!1,!1,!1),new T_("R32UI",4,1,Nl.UINT,!1,!1,!1,!1),new T_("R32I",4,1,Nl.INT,!1,!1,!1,!1),new T_("RG8",2,2,Nl.UNORM,!1,!1,!1,!1),new T_("RG8SN",2,2,Nl.SNORM,!1,!1,!1,!1),new T_("RG8UI",2,2,Nl.UINT,!1,!1,!1,!1),new T_("RG8I",2,2,Nl.INT,!1,!1,!1,!1),new T_("RG16F",4,2,Nl.FLOAT,!1,!1,!1,!1),new T_("RG16UI",4,2,Nl.UINT,!1,!1,!1,!1),new T_("RG16I",4,2,Nl.INT,!1,!1,!1,!1),new T_("RG32F",8,2,Nl.FLOAT,!1,!1,!1,!1),new T_("RG32UI",8,2,Nl.UINT,!1,!1,!1,!1),new T_("RG32I",8,2,Nl.INT,!1,!1,!1,!1),new T_("RGB8",3,3,Nl.UNORM,!1,!1,!1,!1),new T_("SRGB8",3,3,Nl.UNORM,!1,!1,!1,!1),new T_("RGB8SN",3,3,Nl.SNORM,!1,!1,!1,!1),new T_("RGB8UI",3,3,Nl.UINT,!1,!1,!1,!1),new T_("RGB8I",3,3,Nl.INT,!1,!1,!1,!1),new T_("RGB16F",6,3,Nl.FLOAT,!1,!1,!1,!1),new T_("RGB16UI",6,3,Nl.UINT,!1,!1,!1,!1),new T_("RGB16I",6,3,Nl.INT,!1,!1,!1,!1),new T_("RGB32F",12,3,Nl.FLOAT,!1,!1,!1,!1),new T_("RGB32UI",12,3,Nl.UINT,!1,!1,!1,!1),new T_("RGB32I",12,3,Nl.INT,!1,!1,!1,!1),new T_("RGBA8",4,4,Nl.UNORM,!0,!1,!1,!1),new T_("BGRA8",4,4,Nl.UNORM,!0,!1,!1,!1),new T_("SRGB8_A8",4,4,Nl.UNORM,!0,!1,!1,!1),new T_("RGBA8SN",4,4,Nl.SNORM,!0,!1,!1,!1),new T_("RGBA8UI",4,4,Nl.UINT,!0,!1,!1,!1),new T_("RGBA8I",4,4,Nl.INT,!0,!1,!1,!1),new T_("RGBA16F",8,4,Nl.FLOAT,!0,!1,!1,!1),new T_("RGBA16UI",8,4,Nl.UINT,!0,!1,!1,!1),new T_("RGBA16I",8,4,Nl.INT,!0,!1,!1,!1),new T_("RGBA32F",16,4,Nl.FLOAT,!0,!1,!1,!1),new T_("RGBA32UI",16,4,Nl.UINT,!0,!1,!1,!1),new T_("RGBA32I",16,4,Nl.INT,!0,!1,!1,!1),new T_("R5G6B5",2,3,Nl.UNORM,!1,!1,!1,!1),new T_("R11G11B10F",4,3,Nl.FLOAT,!1,!1,!1,!1),new T_("RGB5A1",2,4,Nl.UNORM,!0,!1,!1,!1),new T_("RGBA4",2,4,Nl.UNORM,!0,!1,!1,!1),new T_("RGB10A2",2,4,Nl.UNORM,!0,!1,!1,!1),new T_("RGB10A2UI",2,4,Nl.UINT,!0,!1,!1,!1),new T_("RGB9E5",2,4,Nl.FLOAT,!0,!1,!1,!1),new T_("DEPTH",4,1,Nl.FLOAT,!1,!0,!1,!1),new T_("DEPTH_STENCIL",5,2,Nl.FLOAT,!1,!0,!0,!1),new T_("BC1",1,3,Nl.UNORM,!1,!1,!1,!0),new T_("BC1_ALPHA",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("BC1_SRGB",1,3,Nl.UNORM,!1,!1,!1,!0),new T_("BC1_SRGB_ALPHA",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("BC2",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("BC2_SRGB",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("BC3",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("BC3_SRGB",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("BC4",1,1,Nl.UNORM,!1,!1,!1,!0),new T_("BC4_SNORM",1,1,Nl.SNORM,!1,!1,!1,!0),new T_("BC5",1,2,Nl.UNORM,!1,!1,!1,!0),new T_("BC5_SNORM",1,2,Nl.SNORM,!1,!1,!1,!0),new T_("BC6H_UF16",1,3,Nl.UFLOAT,!1,!1,!1,!0),new T_("BC6H_SF16",1,3,Nl.FLOAT,!1,!1,!1,!0),new T_("BC7",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("BC7_SRGB",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ETC_RGB8",1,3,Nl.UNORM,!1,!1,!1,!0),new T_("ETC2_RGB8",1,3,Nl.UNORM,!1,!1,!1,!0),new T_("ETC2_SRGB8",1,3,Nl.UNORM,!1,!1,!1,!0),new T_("ETC2_RGB8_A1",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ETC2_SRGB8_A1",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ETC2_RGBA8",2,4,Nl.UNORM,!0,!1,!1,!0),new T_("ETC2_SRGB8_A8",2,4,Nl.UNORM,!0,!1,!1,!0),new T_("EAC_R11",1,1,Nl.UNORM,!1,!1,!1,!0),new T_("EAC_R11SN",1,1,Nl.SNORM,!1,!1,!1,!0),new T_("EAC_RG11",2,2,Nl.UNORM,!1,!1,!1,!0),new T_("EAC_RG11SN",2,2,Nl.SNORM,!1,!1,!1,!0),new T_("PVRTC_RGB2",2,3,Nl.UNORM,!1,!1,!1,!0),new T_("PVRTC_RGBA2",2,4,Nl.UNORM,!0,!1,!1,!0),new T_("PVRTC_RGB4",2,3,Nl.UNORM,!1,!1,!1,!0),new T_("PVRTC_RGBA4",2,4,Nl.UNORM,!0,!1,!1,!0),new T_("PVRTC2_2BPP",2,4,Nl.UNORM,!0,!1,!1,!0),new T_("PVRTC2_4BPP",2,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_4x4",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_5x4",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_5x5",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_6x5",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_6x6",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_8x5",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_8x6",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_8x8",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_10x5",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_10x6",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_10x8",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_10x10",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_12x10",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_RGBA_12x12",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_4x4",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_5x4",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_5x5",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_6x5",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_6x6",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_8x5",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_8x6",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_8x8",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_10x5",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_10x6",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_10x8",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_10x10",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_12x10",1,4,Nl.UNORM,!0,!1,!1,!0),new T_("ASTC_SRGBA_12x12",1,4,Nl.UNORM,!0,!1,!1,!0)]),w_=dc.UNIFORM_BUFFER|dc.DYNAMIC_UNIFORM_BUFFER|dc.STORAGE_BUFFER|dc.DYNAMIC_STORAGE_BUFFER,k_=dc.SAMPLER_TEXTURE|dc.SAMPLER|dc.TEXTURE|dc.STORAGE_IMAGE|dc.INPUT_ATTACHMENT,I_=dc.DYNAMIC_STORAGE_BUFFER|dc.DYNAMIC_UNIFORM_BUFFER;function B_(e){return e>0&&0==(e&e-1)}function P_(e,t,i,n){if(!x_[e].isCompressed)return t*i*n*x_[e].size;switch(e){case Ll.BC1:case Ll.BC1_ALPHA:case Ll.BC1_SRGB:case Ll.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Ll.BC2:case Ll.BC2_SRGB:case Ll.BC3:case Ll.BC3_SRGB:case Ll.BC4:case Ll.BC4_SNORM:case Ll.BC6H_SF16:case Ll.BC6H_UF16:case Ll.BC7:case Ll.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Ll.BC5:case Ll.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case Ll.ETC_RGB8:case Ll.ETC2_RGB8:case Ll.ETC2_SRGB8:case Ll.ETC2_RGB8_A1:case Ll.EAC_R11:case Ll.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Ll.ETC2_RGBA8:case Ll.ETC2_SRGB8_A1:case Ll.EAC_RG11:case Ll.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Ll.PVRTC_RGB2:case Ll.PVRTC_RGBA2:case Ll.PVRTC2_2BPP:return Math.ceil(t/8)*Math.ceil(i/4)*8*n;case Ll.PVRTC_RGB4:case Ll.PVRTC_RGBA4:case Ll.PVRTC2_4BPP:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Ll.ASTC_RGBA_4X4:case Ll.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Ll.ASTC_RGBA_5X4:case Ll.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(i/4)*16*n;case Ll.ASTC_RGBA_5X5:case Ll.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(i/5)*16*n;case Ll.ASTC_RGBA_6X5:case Ll.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(i/5)*16*n;case Ll.ASTC_RGBA_6X6:case Ll.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(i/6)*16*n;case Ll.ASTC_RGBA_8X5:case Ll.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(i/5)*16*n;case Ll.ASTC_RGBA_8X6:case Ll.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(i/6)*16*n;case Ll.ASTC_RGBA_8X8:case Ll.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(i/8)*16*n;case Ll.ASTC_RGBA_10X5:case Ll.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(i/5)*16*n;case Ll.ASTC_RGBA_10X6:case Ll.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(i/6)*16*n;case Ll.ASTC_RGBA_10X8:case Ll.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(i/8)*16*n;case Ll.ASTC_RGBA_10X10:case Ll.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(i/10)*16*n;case Ll.ASTC_RGBA_12X10:case Ll.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(i/10)*16*n;case Ll.ASTC_RGBA_12X12:case Ll.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(i/12)*16*n;default:return 0}}function M_(e,t,i,n,r){for(var s=0,a=0;a<r;++a)s+=P_(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1);return s}var O_=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function D_(e){return O_[e]||0}function L_(e){if(e.isCompressed)return Uint8Array;var t=e.size/e.count;switch(e.type){case Nl.UNORM:case Nl.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}case Nl.SNORM:case Nl.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array;default:return Int8Array}case Nl.FLOAT:return Float32Array}return Float32Array}function N_(e){switch(e){case Ll.BC1:case Ll.BC1_ALPHA:case Ll.BC1_SRGB:case Ll.BC1_SRGB_ALPHA:case Ll.BC2:case Ll.BC2_SRGB:case Ll.BC3:case Ll.BC3_SRGB:case Ll.BC4:case Ll.BC4_SNORM:case Ll.BC6H_SF16:case Ll.BC6H_UF16:case Ll.BC7:case Ll.BC7_SRGB:case Ll.BC5:case Ll.BC5_SNORM:case Ll.ETC_RGB8:case Ll.ETC2_RGB8:case Ll.ETC2_SRGB8:case Ll.ETC2_RGB8_A1:case Ll.EAC_R11:case Ll.EAC_R11SN:case Ll.ETC2_RGBA8:case Ll.ETC2_SRGB8_A1:case Ll.EAC_RG11:case Ll.EAC_RG11SN:return{width:4,height:4};case Ll.PVRTC_RGB2:case Ll.PVRTC_RGBA2:case Ll.PVRTC2_2BPP:return{width:8,height:4};case Ll.PVRTC_RGB4:case Ll.PVRTC_RGBA4:case Ll.PVRTC2_4BPP:return{width:4,height:4};case Ll.ASTC_RGBA_4X4:case Ll.ASTC_SRGBA_4X4:return{width:4,height:4};case Ll.ASTC_RGBA_5X4:case Ll.ASTC_SRGBA_5X4:return{width:5,height:4};case Ll.ASTC_RGBA_5X5:case Ll.ASTC_SRGBA_5X5:return{width:5,height:5};case Ll.ASTC_RGBA_6X5:case Ll.ASTC_SRGBA_6X5:return{width:6,height:5};case Ll.ASTC_RGBA_6X6:case Ll.ASTC_SRGBA_6X6:return{width:6,height:6};case Ll.ASTC_RGBA_8X5:case Ll.ASTC_SRGBA_8X5:return{width:8,height:5};case Ll.ASTC_RGBA_8X6:case Ll.ASTC_SRGBA_8X6:return{width:8,height:6};case Ll.ASTC_RGBA_8X8:case Ll.ASTC_SRGBA_8X8:return{width:8,height:8};case Ll.ASTC_RGBA_10X5:case Ll.ASTC_SRGBA_10X5:return{width:10,height:5};case Ll.ASTC_RGBA_10X6:case Ll.ASTC_SRGBA_10X6:return{width:10,height:6};case Ll.ASTC_RGBA_10X8:case Ll.ASTC_SRGBA_10X8:return{width:10,height:8};case Ll.ASTC_RGBA_10X10:case Ll.ASTC_SRGBA_10X10:return{width:10,height:10};case Ll.ASTC_RGBA_12X10:case Ll.ASTC_SRGBA_12X10:return{width:12,height:10};case Ll.ASTC_RGBA_12X12:case Ll.ASTC_SRGBA_12X12:return{width:12,height:12};default:return{width:1,height:1}}}function F_(e,t){return Math.ceil(e/t)*t}var G_=Object.freeze({__proto__:null,get ObjectType(){return Bl},get Status(){return Pl},get API(){return Ml},get SurfaceTransform(){return Ol},get Feature(){return Dl},get Format(){return Ll},get FormatType(){return Nl},get Type(){return Fl},get BufferUsageBit(){return Gl},get BufferFlagBit(){return Vl},get MemoryAccessBit(){return Ul},get MemoryUsageBit(){return Hl},get TextureType(){return zl},get TextureUsageBit(){return Wl},get TextureFlagBit(){return Xl},get FormatFeatureBit(){return jl},get SampleCount(){return ql},get VsyncMode(){return Yl},get Filter(){return Kl},get Address(){return Ql},get ComparisonFunc(){return Jl},get StencilOp(){return Zl},get BlendFactor(){return $l},get BlendOp(){return ec},get ColorMask(){return tc},get ShaderStageFlagBit(){return ic},get LoadOp(){return nc},get StoreOp(){return rc},get AccessFlagBit(){return sc},get ResolveMode(){return ac},get PipelineBindPoint(){return oc},get PrimitiveMode(){return uc},get PolygonMode(){return hc},get ShadeModel(){return lc},get CullMode(){return cc},get DynamicStateFlagBit(){return _c},get StencilFace(){return fc},get DescriptorType(){return dc},get QueueType(){return mc},get QueryType(){return pc},get CommandBufferType(){return vc},get ClearFlagBit(){return yc},get BarrierType(){return gc},get PassType(){return Sc},Size:Ec,DeviceCaps:bc,DeviceOptions:Cc,Offset:Rc,Rect:xc,Extent:wc,TextureSubresLayers:kc,TextureSubresRange:Ic,TextureCopy:Bc,TextureBlit:Pc,BufferTextureCopy:Mc,Viewport:Oc,Color:Dc,BindingMappingInfo:Lc,SwapchainInfo:Nc,DeviceInfo:Fc,BufferInfo:Gc,BufferViewInfo:Vc,DrawInfo:Uc,DispatchInfo:Hc,IndirectBuffer:zc,TextureInfo:Wc,TextureViewInfo:Xc,SamplerInfo:jc,Uniform:qc,UniformBlock:Yc,UniformSamplerTexture:Kc,UniformSampler:Qc,UniformTexture:Jc,UniformStorageImage:Zc,UniformStorageBuffer:$c,UniformInputAttachment:e_,ShaderStage:t_,Attribute:i_,ShaderInfo:n_,InputAssemblerInfo:r_,ColorAttachment:s_,DepthStencilAttachment:a_,SubpassInfo:o_,SubpassDependency:u_,RenderPassInfo:h_,GeneralBarrierInfo:l_,TextureBarrierInfo:c_,BufferBarrierInfo:__,FramebufferInfo:f_,DescriptorSetLayoutBinding:d_,DescriptorSetLayoutInfo:m_,DescriptorSetInfo:p_,PipelineLayoutInfo:v_,InputState:y_,CommandBufferInfo:g_,QueueInfo:S_,QueryPoolInfo:A_,FormatInfo:T_,MemoryStatus:E_,DynamicStencilStates:b_,DynamicStates:C_,GFXObject:R_,get AttributeName(){return Tc},FormatInfos:x_,DESCRIPTOR_BUFFER_TYPE:w_,DESCRIPTOR_SAMPLER_TYPE:k_,DESCRIPTOR_DYNAMIC_TYPE:I_,DRAW_INFO_SIZE:28,IsPowerOf2:B_,FormatSize:P_,FormatSurfaceSize:M_,GetTypeSize:D_,getTypedArrayConstructor:L_,formatAlignment:N_,alignTo:F_}),V_=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.BUFFER))._usage=Gl.NONE,e._memUsage=Hl.NONE,e._size=0,e._stride=1,e._count=0,e._flags=Vl.NONE,e._isBufferView=!1,e}return s(i,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),i}(R_),U_=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.COMMAND_BUFFER))._queue=null,e._type=vc.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}return s(i,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),i}(R_),H_=function(){function e(){n(this,e),this._gfxAPI=Ml.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(Dl.COUNT),this._formatFeatures=new Array(Ll.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new E_,this._caps=new bc,this._bindingMappingInfo=new Lc,this._samplers=new Map,this._generalBarrierss=new Map,this._textureBarriers=new Map,this._bufferBarriers=new Map}return s(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"hasFeature",value:function(e){return this._features[e]}},{key:"getFormatFeatures",value:function(e){return this._formatFeatures[e]}},{key:"enableAutoBarrier",value:function(){}}]),e}();H_.canvas=void 0;var z_=function(){function e(t){n(this,e),this._texture2D=null,this._texture3D=null,this._textureCube=null,this._texture2DArray=null;var i=new Uint8Array(64);if(i.fill(255),t.capabilities.maxTextureSize>=2){this._texture2D=t.createTexture(new Wc(zl.TEX2D,Wl.STORAGE|Wl.SAMPLED,Ll.RGBA8,2,2,Xl.NONE));var r=new Mc(0,0,0,new Rc(0,0,0),new wc(2,2,1));t.copyBuffersToTexture([i],this._texture2D,[r])}if(t.capabilities.maxTextureSize>=2){this._textureCube=t.createTexture(new Wc(zl.CUBE,Wl.STORAGE|Wl.SAMPLED,Ll.RGBA8,2,2,Xl.NONE,6));var s=new Mc(0,0,0,new Rc(0,0,0),new wc(2,2,1));t.copyBuffersToTexture([i],this._textureCube,[s]),s.texSubres.baseArrayLayer=1,t.copyBuffersToTexture([i],this._textureCube,[s]),s.texSubres.baseArrayLayer=2,t.copyBuffersToTexture([i],this._textureCube,[s]),s.texSubres.baseArrayLayer=3,t.copyBuffersToTexture([i],this._textureCube,[s]),s.texSubres.baseArrayLayer=4,t.copyBuffersToTexture([i],this._textureCube,[s]),s.texSubres.baseArrayLayer=5,t.copyBuffersToTexture([i],this._textureCube,[s])}if(t.capabilities.max3DTextureSize>=2){this._texture3D=t.createTexture(new Wc(zl.TEX3D,Wl.STORAGE|Wl.SAMPLED,Ll.RGBA8,2,2,Xl.NONE,1,1,ql.ONE,2));var a=new Mc(0,0,0,new Rc(0,0,0),new wc(2,2,2),new kc(0,0,1));t.copyBuffersToTexture([i],this._texture3D,[a])}if(t.capabilities.maxArrayTextureLayers>=2){this._texture2DArray=t.createTexture(new Wc(zl.TEX2D_ARRAY,Wl.STORAGE|Wl.SAMPLED,Ll.RGBA8,2,2,Xl.NONE,2));var o=new Mc(0,0,0,new Rc(0,0,0),new wc(2,2,1),new kc(0,0,1));t.copyBuffersToTexture([i],this._texture2DArray,[o]),o.texSubres.baseArrayLayer=1,t.copyBuffersToTexture([i],this._texture2DArray,[o])}}return s(e,[{key:"getTexture",value:function(e){switch(e){case zl.TEX2D:return this._texture2D;case zl.TEX3D:return this._texture3D;case zl.CUBE:return this._textureCube;case zl.TEX2D_ARRAY:return this._texture2DArray;default:return null}}}]),e}(),W_=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.SWAPCHAIN))._transform=Ol.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}return s(i,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),i}(R_),X_=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.FRAMEBUFFER))._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}return s(i,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),i}(R_),j_=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.INPUT_ASSEMBLER))._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new Uc,e}return s(i,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo},set:function(e){this._drawInfo=e}},{key:"getVertexBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}},{key:"computeAttributesHash",value:function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var i=this.attributes[t];e+=",".concat(i.name,",").concat(i.format,",").concat(i.isNormalized,",").concat(i.stream,",").concat(i.isInstanced,",").concat(i.location)}return bl(e,666)}}]),i}(R_),q_=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.DESCRIPTOR_SET))._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}return s(i,[{key:"layout",get:function(){return this._layout}},{key:"bindBuffer",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this._layout.bindingIndices[e],r=this._layout.bindings[n];if(r&&r.descriptorType&w_){var s=this._layout.descriptorIndices[e];this._buffers[s+i]!==t&&(this._buffers[s+i]=t,this._isDirty=!0)}}},{key:"bindSampler",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this._layout.bindingIndices[e],r=this._layout.bindings[n];if(r&&r.descriptorType&k_){var s=this._layout.descriptorIndices[e];this._samplers[s+i]!==t&&(this._samplers[s+i]=t,this._isDirty=!0)}}},{key:"bindTexture",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this._layout.bindingIndices[e],r=this._layout.bindings[n];if(r&&r.descriptorType&k_){var s=this._layout.descriptorIndices[e];this._textures[s+i]!==t&&(this._textures[s+i]=t,this._isDirty=!0)}}},{key:"getBuffer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this._layout.descriptorIndices[e];return this._buffers[i+t]}},{key:"getSampler",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this._layout.descriptorIndices[e];return this._samplers[i+t]}},{key:"getTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this._layout.descriptorIndices[e];return this._textures[i+t]}}]),i}(R_),Y_=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.DESCRIPTOR_SET_LAYOUT))._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}return s(i,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),i}(R_),K_=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.PIPELINE_LAYOUT))._setLayouts=[],e}return s(i,[{key:"setLayouts",get:function(){return this._setLayouts}}]),i}(R_),Q_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:hc.FILL,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:lc.GOURAND,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:cc.BACK,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=!(arguments.length>9&&void 0!==arguments[9])||arguments[9],_=arguments.length>10&&void 0!==arguments[10]&&arguments[10],f=arguments.length>11&&void 0!==arguments[11]?arguments[11]:1;n(this,e),this.isDiscard=t,this.polygonMode=i,this.shadeModel=r,this.cullMode=s,this.isFrontFaceCCW=a,this.depthBiasEnabled=o,this.depthBias=u,this.depthBiasClamp=h,this.depthBiasSlop=l,this.isDepthClip=c,this.isMultisample=_,this.lineWidth=f}return s(e,[{key:"native",get:function(){return this}},{key:"reset",value:function(){this.isDiscard=!1,this.polygonMode=hc.FILL,this.shadeModel=lc.GOURAND,this.cullMode=cc.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}},{key:"assign",value:function(e){Object.assign(this,e)}},{key:"destroy",value:function(){}}]),e}(),J_=function(){function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Jl.LESS,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Jl.ALWAYS,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:65535,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:65535,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Zl.KEEP,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:Zl.KEEP,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:Zl.KEEP,_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,f=arguments.length>11&&void 0!==arguments[11]&&arguments[11],d=arguments.length>12&&void 0!==arguments[12]?arguments[12]:Jl.ALWAYS,m=arguments.length>13&&void 0!==arguments[13]?arguments[13]:65535,p=arguments.length>14&&void 0!==arguments[14]?arguments[14]:65535,v=arguments.length>15&&void 0!==arguments[15]?arguments[15]:Zl.KEEP,y=arguments.length>16&&void 0!==arguments[16]?arguments[16]:Zl.KEEP,g=arguments.length>17&&void 0!==arguments[17]?arguments[17]:Zl.KEEP,S=arguments.length>18&&void 0!==arguments[18]?arguments[18]:1;n(this,e),this.depthTest=t,this.depthWrite=i,this.depthFunc=r,this.stencilTestFront=s,this.stencilFuncFront=a,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=u,this.stencilFailOpFront=h,this.stencilZFailOpFront=l,this.stencilPassOpFront=c,this.stencilRefFront=_,this.stencilTestBack=f,this.stencilFuncBack=d,this.stencilReadMaskBack=m,this.stencilWriteMaskBack=p,this.stencilFailOpBack=v,this.stencilZFailOpBack=y,this.stencilPassOpBack=g,this.stencilRefBack=S}return s(e,[{key:"native",get:function(){return this}},{key:"reset",value:function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Jl.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Jl.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Zl.KEEP,this.stencilZFailOpFront=Zl.KEEP,this.stencilPassOpFront=Zl.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Jl.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Zl.KEEP,this.stencilZFailOpBack=Zl.KEEP,this.stencilPassOpBack=Zl.KEEP,this.stencilRefBack=1}},{key:"assign",value:function(e){Object.assign(this,e)}},{key:"destroy",value:function(){}}]),e}(),Z_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$l.ONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:$l.ZERO,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ec.ADD,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:$l.ONE,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:$l.ZERO,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:ec.ADD,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:tc.ALL;n(this,e),this.blend=t,this.blendSrc=i,this.blendDst=r,this.blendEq=s,this.blendSrcAlpha=a,this.blendDstAlpha=o,this.blendAlphaEq=u,this.blendColorMask=h}return s(e,[{key:"reset",value:function(){this.blend=!1,this.blendSrc=$l.ONE,this.blendDst=$l.ZERO,this.blendEq=ec.ADD,this.blendSrcAlpha=$l.ONE,this.blendDstAlpha=$l.ZERO,this.blendAlphaEq=ec.ADD,this.blendColorMask=tc.ALL}},{key:"assign",value:function(e){Object.assign(this,e)}},{key:"destroy",value:function(){}}]),e}(),$_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Dc,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[new Z_];n(this,e),this.isA2C=t,this.isIndepend=i,this.blendColor=r,this.targets=s}return s(e,[{key:"native",get:function(){return this}},{key:"setTarget",value:function(e,t){var i=this.targets[e];i||(i=this.targets[e]=new Z_),Object.assign(i,t)}},{key:"reset",value:function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()}},{key:"destroy",value:function(){}}]),e}(),ef=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new y_,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Q_,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new J_,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:new $_,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:uc.TRIANGLE_LIST,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:_c.NONE,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:oc.GRAPHICS;n(this,e),this.shader=t,this.pipelineLayout=i,this.renderPass=r,this.inputState=s,this.rasterizerState=a,this.depthStencilState=o,this.blendState=u,this.primitive=h,this.dynamicStates=l,this.bindPoint=c},tf=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.PIPELINE_STATE))._shader=null,e._pipelineLayout=null,e._primitive=uc.TRIANGLE_LIST,e._is=null,e._rs=new Q_,e._dss=new J_,e._bs=new $_,e._dynamicStates=_c.NONE,e._renderPass=null,e}return s(i,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),i}(R_),nf=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.QUEUE))._type=mc.GRAPHICS,e}return s(i,[{key:"type",get:function(){return this._type}}]),i}(R_),rf=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.RENDER_PASS))._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}return s(i,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}},{key:"computeHash",value:function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var i=this._subpasses[t];if(i.inputs.length){e+="ia";for(var n=0;n<i.inputs.length;++n){var r=this._colorInfos[i.inputs[n]];e+=",".concat(r.format,",").concat(r.sampleCount)}}if(i.colors.length){e+="ca";for(var s=0;s<i.inputs.length;++s){var a=this._colorInfos[i.inputs[s]];e+=",".concat(a.format,",").concat(a.sampleCount)}}if(i.depthStencil>=0){var o=this._colorInfos[i.depthStencil];e+="ds,".concat(o.format,",").concat(o.sampleCount)}}else{e+="ca";for(var u=0;u<this._colorInfos.length;++u){var h=this._colorInfos[u];e+=",".concat(h.format,",").concat(h.sampleCount)}var l=this._depthStencilInfo;l&&(e+="ds,".concat(l.format,",").concat(l.sampleCount))}return bl(e,666)}}]),i}(R_),sf=function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,Bl.SAMPLER))._info=new jc,s._hash=0,s._info.copy(e),s._hash=r,s}return s(i,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}],[{key:"computeHash",value:function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16}},{key:"unpackFromHash",value:function(e){var t=new jc;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t}}]),i}(R_),af=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.SHADER))._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}return s(i,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),i}(R_),of=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,Bl.TEXTURE))._info=new Wc,e._viewInfo=new Xc,e._isPowerOf2=!1,e._isTextureView=!1,e._size=0,e}return s(i,[{key:"type",get:function(){return this._info.type}},{key:"usage",get:function(){return this._info.usage}},{key:"format",get:function(){return this._info.format}},{key:"width",get:function(){return this._info.width}},{key:"height",get:function(){return this._info.height}},{key:"depth",get:function(){return this._info.depth}},{key:"layerCount",get:function(){return this._info.layerCount}},{key:"levelCount",get:function(){return this._info.levelCount}},{key:"samples",get:function(){return this._info.samples}},{key:"flags",get:function(){return this._info.flags}},{key:"size",get:function(){return this._size}},{key:"info",get:function(){return this._info}},{key:"viewInfo",get:function(){return this._viewInfo}},{key:"isTextureView",get:function(){return this._isTextureView}}],[{key:"getLevelCount",value:function(e,t){return Math.floor(Math.log2(Math.max(e,t)))}}]),i}(R_),uf=function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,Bl.GLOBAL_BARRIER))._info=new l_,s._hash=0,s._info.copy(e),s._hash=r,s}return s(i,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}],[{key:"computeHash",value:function(e){return bl("".concat(e.prevAccesses," ").concat(e.nextAccesses," ").concat(e.type),666)}}]),i}(R_),hf=function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,Bl.TEXTURE_BARRIER))._info=new c_,s._hash=0,s._info.copy(e),s._hash=r,s}return s(i,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}],[{key:"computeHash",value:function(e){var t="".concat(e.prevAccesses," ").concat(e.nextAccesses);return t+=e.type,t+=e.baseMipLevel,t+=e.levelCount,t+=e.baseSlice,t+=e.sliceCount,t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,bl(t+=e.dstQueue?e.dstQueue.type:0,666)}}]),i}(R_),lf=function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,Bl.BUFFER_BARRIER))._info=new __,s._hash=0,s._info.copy(e),s._hash=r,s}return s(i,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}],[{key:"computeHash",value:function(e){var t="".concat(e.prevAccesses," ").concat(e.nextAccesses);return t+=e.type,t+=e.offset,t+=e.size,t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,bl(t+=e.dstQueue?e.dstQueue.type:0,666)}}]),i}(R_),cf={Device:H_,Swapchain:W_,Buffer:V_,Texture:of,Sampler:sf,Shader:af,InputAssembler:j_,RenderPass:rf,Framebuffer:X_,DescriptorSet:q_,DescriptorSetLayout:Y_,PipelineLayout:K_,PipelineState:tf,CommandBuffer:U_,Queue:nf,GeneralBarrier:uf,TextureBarrier:hf,BufferBarrier:lf,RasterizerState:Q_,BlendState:$_,BlendTarget:Z_,DepthStencilState:J_,PipelineStateInfo:ef};Object.assign(cf,G_),B.gfx=cf;var _f,ff,df={GFXDevice:!0,GFXBuffer:!0,GFXTexture:!0,GFXSampler:!0,GFXShader:!0,GFXInputAssembler:!0,GFXRenderPass:!0,GFXFramebuffer:!0,GFXPipelineState:!0,GFXCommandBuffer:!0,GFXQueue:!0,GFXObjectType:!0,GFXObject:!1,GFXAttributeName:!0,GFXType:!0,GFXFormat:!0,GFXBufferUsageBit:!0,GFXMemoryUsageBit:!0,GFXBufferFlagBit:!0,GFXBufferAccessBit:"MemoryAccessBit",GFXPrimitiveMode:!0,GFXPolygonMode:!0,GFXShadeModel:!0,GFXCullMode:!0,GFXComparisonFunc:!0,GFXStencilOp:!0,GFXBlendOp:!0,GFXBlendFactor:!0,GFXColorMask:!0,GFXFilter:!0,GFXAddress:!0,GFXTextureType:!0,GFXTextureUsageBit:!0,GFXSampleCount:!0,GFXTextureFlagBit:!0,GFXShaderStageFlagBit:!0,GFXDescriptorType:!0,GFXCommandBufferType:!0,GFXLoadOp:!0,GFXStoreOp:!0,GFXPipelineBindPoint:!0,GFXDynamicStateFlagBit:!0,GFXStencilFace:!0,GFXQueueType:!0,GFXRect:!0,GFXViewport:!0,GFXColor:!0,GFXClearFlag:!0,GFXOffset:!0,GFXExtent:!0,GFXTextureSubres:"TextureSubresLayers",GFXTextureCopy:!0,GFXBufferTextureCopy:!0,GFXFormatType:!0,GFXFormatInfo:!0,GFXMemoryStatus:!0,GFXFormatInfos:!0,GFXFormatSize:!0,GFXFormatSurfaceSize:!0,GFXGetTypeSize:!0,getTypedArrayConstructor:!1};for(var mf in df){var pf=df[mf];!0===pf?pf=mf.slice(3):!1===pf&&(pf=mf),me(B,"cc",[{name:mf,newName:pf,target:B.gfx,targetName:"cc.gfx"}])}pe(B,"cc",[{name:"GFX_MAX_VERTEX_ATTRIBUTES"},{name:"GFX_MAX_TEXTURE_UNITS"},{name:"GFX_MAX_ATTACHMENTS"},{name:"GFX_MAX_BUFFER_BINDINGS"},{name:"GFXTextureLayout"}]),pe(Dl,"Feature",[{name:"COLOR_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.RENDER_TARGET;"},{name:"COLOR_HALF_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.RENDER_TARGET;"},{name:"TEXTURE_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R32F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);"},{name:"TEXTURE_HALF_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R16F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);"},{name:"TEXTURE_FLOAT_LINEAR",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.LINEAR_FILTER;"},{name:"TEXTURE_HALF_FLOAT_LINEAR",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.LINEAR_FILTER;"},{name:"FORMAT_R11G11B10F",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R11G11B10F) !== FormatFeatureBit.NONE;"},{name:"FORMAT_SRGB",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.SRGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ETC1",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC_RGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ETC2",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC2_RGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_DXT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.BC1) !== FormatFeatureBit.NONE;"},{name:"FORMAT_PVRTC",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.PVRTC_RGB2) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ASTC",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ASTC_RGBA_4x4) !== FormatFeatureBit.NONE;"},{name:"FORMAT_RGB8",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.RGB8) !== FormatFeatureBit.NONE;"}]),pe(s_.prototype,"ColorAttachment",[{name:"beginAccesses",suggest:"Please assign to ColorAttachment.barrier instead"},{name:"endAccesses",suggest:"Please assign to ColorAttachment.barrier instead"}]),pe(a_.prototype,"DepthStencilAttachment",[{name:"beginAccesses",suggest:"Please assign to DepthStencilAttachment.barrier instead"},{name:"endAccesses",suggest:"Please assign to DepthStencilAttachment.barrier instead"}]),me(H_.prototype,"Device",[{name:"getGlobalBarrier",newName:"getGeneralBarrier"}]),function(e){e[e.AUTO=0]="AUTO",e[e.CANVAS=1]="CANVAS",e[e.WEBGL=2]="WEBGL",e[e.HEADLESS=3]="HEADLESS"}(_f||(_f={})),function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.CANVAS=0]="CANVAS",e[e.WEBGL=1]="WEBGL",e[e.OPENGL=2]="OPENGL",e[e.HEADLESS=3]="HEADLESS"}(ff||(ff={}));var vf=function(){function e(){n(this,e),this.initialized=!1,this._canvas=null,this._renderType=ff.UNKNOWN}return s(e,[{key:"gfxDevice",get:function(){return this._gfxDevice}},{key:"swapchain",get:function(){return this._swapchain}},{key:"init",value:function(e,t){if(!this.initialized){var i=Dt.querySettings(Ot.Category.RENDERING,"renderMode");if(this._canvas=e,this._renderType=this._determineRenderType(i),this._renderType===ff.WEBGL){var n=new Fc(t),r=!!globalThis.WebGL2RenderingContext;globalThis.navigator.userAgent.toLowerCase(),Sl.browserType===zh.UC&&(r=!1);var s=[];r&&B.WebGL2Device&&s.push(B.WebGL2Device),B.WebGLDevice&&s.push(B.WebGLDevice),B.EmptyDevice&&s.push(B.EmptyDevice),H_.canvas=e;for(var a=0;a<s.length&&(this._gfxDevice=new s[a],!this._gfxDevice.initialize(n));a++);this._initSwapchain()}else this._renderType===ff.HEADLESS&&B.EmptyDevice&&(this._gfxDevice=new B.EmptyDevice,this._gfxDevice.initialize(new Fc(t)),this._initSwapchain());if(!this._gfxDevice)return J("can not support canvas rendering in 3D"),void(this._renderType=ff.UNKNOWN);this._canvas&&(this._canvas.oncontextmenu=function(){return!1})}}},{key:"_initSwapchain",value:function(){var e=new Nc(1,this._canvas),t=gl.windowSize;e.width=t.width,e.height=t.height,this._swapchain=this._gfxDevice.createSwapchain(e)}},{key:"_determineRenderType",value:function(e){("number"!=typeof e||e>ff.HEADLESS||e<_f.AUTO)&&(e=_f.AUTO);var t=ff.CANVAS,i=!1;if(e===_f.CANVAS?(t=ff.CANVAS,i=!0):e===_f.AUTO||e===_f.WEBGL?(t=ff.WEBGL,i=!0):e===_f.HEADLESS&&(t=ff.HEADLESS,i=!0),!i)throw new Error(_e(3820,e));return t}}]),e}(),yf=new vf;e("gfx",Object.freeze({__proto__:null,DescriptorSet:q_,Buffer:V_,CommandBuffer:U_,get ObjectType(){return Bl},get Status(){return Pl},get API(){return Ml},get SurfaceTransform(){return Ol},get Feature(){return Dl},get Format(){return Ll},get FormatType(){return Nl},get Type(){return Fl},get BufferUsageBit(){return Gl},get BufferFlagBit(){return Vl},get MemoryAccessBit(){return Ul},get MemoryUsageBit(){return Hl},get TextureType(){return zl},get TextureUsageBit(){return Wl},get TextureFlagBit(){return Xl},get FormatFeatureBit(){return jl},get SampleCount(){return ql},get VsyncMode(){return Yl},get Filter(){return Kl},get Address(){return Ql},get ComparisonFunc(){return Jl},get StencilOp(){return Zl},get BlendFactor(){return $l},get BlendOp(){return ec},get ColorMask(){return tc},get ShaderStageFlagBit(){return ic},get LoadOp(){return nc},get StoreOp(){return rc},get AccessFlagBit(){return sc},get ResolveMode(){return ac},get PipelineBindPoint(){return oc},get PrimitiveMode(){return uc},get PolygonMode(){return hc},get ShadeModel(){return lc},get CullMode(){return cc},get DynamicStateFlagBit(){return _c},get StencilFace(){return fc},get DescriptorType(){return dc},get QueueType(){return mc},get QueryType(){return pc},get CommandBufferType(){return vc},get ClearFlagBit(){return yc},get BarrierType(){return gc},get PassType(){return Sc},Size:Ec,DeviceCaps:bc,DeviceOptions:Cc,Offset:Rc,Rect:xc,Extent:wc,TextureSubresLayers:kc,TextureSubresRange:Ic,TextureCopy:Bc,TextureBlit:Pc,BufferTextureCopy:Mc,Viewport:Oc,Color:Dc,BindingMappingInfo:Lc,SwapchainInfo:Nc,DeviceInfo:Fc,BufferInfo:Gc,BufferViewInfo:Vc,DrawInfo:Uc,DispatchInfo:Hc,IndirectBuffer:zc,TextureInfo:Wc,TextureViewInfo:Xc,SamplerInfo:jc,Uniform:qc,UniformBlock:Yc,UniformSamplerTexture:Kc,UniformSampler:Qc,UniformTexture:Jc,UniformStorageImage:Zc,UniformStorageBuffer:$c,UniformInputAttachment:e_,ShaderStage:t_,Attribute:i_,ShaderInfo:n_,InputAssemblerInfo:r_,ColorAttachment:s_,DepthStencilAttachment:a_,SubpassInfo:o_,SubpassDependency:u_,RenderPassInfo:h_,GeneralBarrierInfo:l_,TextureBarrierInfo:c_,BufferBarrierInfo:__,FramebufferInfo:f_,DescriptorSetLayoutBinding:d_,DescriptorSetLayoutInfo:m_,DescriptorSetInfo:p_,PipelineLayoutInfo:v_,InputState:y_,CommandBufferInfo:g_,QueueInfo:S_,QueryPoolInfo:A_,FormatInfo:T_,MemoryStatus:E_,DynamicStencilStates:b_,DynamicStates:C_,GFXObject:R_,get AttributeName(){return Tc},FormatInfos:x_,DESCRIPTOR_BUFFER_TYPE:w_,DESCRIPTOR_SAMPLER_TYPE:k_,DESCRIPTOR_DYNAMIC_TYPE:I_,DRAW_INFO_SIZE:28,IsPowerOf2:B_,FormatSize:P_,FormatSurfaceSize:M_,GetTypeSize:D_,getTypedArrayConstructor:L_,formatAlignment:N_,alignTo:F_,Device:H_,DefaultResource:z_,Swapchain:W_,Framebuffer:X_,InputAssembler:j_,DescriptorSetLayout:Y_,PipelineLayout:K_,RasterizerState:Q_,DepthStencilState:J_,BlendTarget:Z_,BlendState:$_,PipelineStateInfo:ef,PipelineState:tf,Queue:nf,RenderPass:rf,Sampler:sf,Shader:af,Texture:of,GeneralBarrier:uf,TextureBarrier:hf,get LegacyRenderMode(){return _f},get RenderType(){return ff},DeviceManager:vf,deviceManager:yf}));var gf=new Cn;function Sf(e,t,i,n){var r=i.chunk,s=i.data,a=r.vb,o=i.vertexCount;e.getWorldMatrix(gf);for(var u=0,h=0;h<o;h++){var l=s[h],c=l.x,_=l.y,f=gf.m03*c+gf.m07*_+gf.m15;f=f?Math.abs(1/f):1,a[u+0]=(gf.m00*c+gf.m04*_+gf.m12)*f,a[u+1]=(gf.m01*c+gf.m05*_+gf.m13)*f,a[u+2]=(gf.m02*c+gf.m06*_+gf.m14)*f,cn.toArray(a,n,u+5),u+=9}r.bufferId;for(var d=r.vertexOffset,m=r.meshBuffer,p=r.meshBuffer.iData,v=m.indexOffset,y=0,g=o/4;y<g;y++){var S=d+4*y;p[v++]=S,p[v++]=S+1,p[v++]=S+2,p[v++]=S+1,p[v++]=S+3,p[v++]=S+2}m.indexOffset+=i.indexCount,m.setDirty()}function Af(e,t){for(var i,n,r,s=e.vertexFormat,a=e.chunk.vb,o=0,u=0;u<s.length;++u){if(i=s[u],(n=x_[i.format]).hasAlpha)if(r=e.floatStride,n.size/n.count==1)for(var h=~~Li(Math.round(255*t),0,255),l=o;l<a.length;l+=r)a[l]=(4294967040&a[l]|h)>>>0;else if(n.size/n.count==4)for(var c=o+3;c<a.length;c+=r)a[c]=t;o+=n.size>>2}}var Tf={},Ef=function(){function e(t){n(this,e),this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=Ue(!0),this._count=0)}return s(e,[{key:"add",value:function(e,t){return e in this._map||this._count++,this._map[e]=t}},{key:"get",value:function(e){return this._map[e]}},{key:"has",value:function(e){return e in this._map}},{key:"remove",value:function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t}},{key:"clear",value:function(){0!==this._count&&(this._map=Ue(!0),this._count=0)}},{key:"forEach",value:function(e){for(var t in this._map)e(this._map[t],t)}},{key:"find",value:function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null}},{key:"count",get:function(){return this._count}},{key:"destroy",value:function(){this._map=null}}]),e}(),bf=function(){function e(t,i){n(this,e),this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var r=0,s=i.length;r<s;r++)this.pipes.push(i[r])}return s(e,[{key:"insert",value:function(e,t){return t>this.pipes.length?(ae(4921),this):(this.pipes.splice(t,0,e),this)}},{key:"append",value:function(e){return this.pipes.push(e),this}},{key:"remove",value:function(e){return this.pipes.splice(e,1),this}},{key:"sync",value:function(e){var t=this.pipes;if(0===t.length)return null;e.isFinished=!1;for(var i=0,n=t.length;i<n;){var r=(0,t[i])(e);if(r)return e.isFinished=!0,r;++i!==n&&(e.input=e.output,e.output=null)}return e.isFinished=!0,e.output}},{key:"async",value:function(e){0!==this.pipes.length&&(e.isFinished=!1,this._flow(0,e))}},{key:"_flow",value:function(e,t){var i=this;(0,this.pipes[e])(t,(function(n){n?(t.isFinished=!0,t.dispatch("complete",n)):++e<i.pipes.length?(t.input=t.output,t.output=null,i._flow(e,t)):(t.isFinished=!0,t.dispatch("complete",n,t.output))}))}}]),e}();bf._pipelineId=0,s((function e(t){if(n(this,e),this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(t)for(var i in t)this._weakMap[i]=new WeakRef(t[i])}),[{key:"add",value:function(e,t){return this._weakMap[e]=new WeakRef(t),t}},{key:"has",value:function(e){return e in this._weakMap&&!!this._weakMap[e].deref()}},{key:"get",value:function(e){return this._weakMap[e]&&this._weakMap[e].deref()}},{key:"remove",value:function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()}},{key:"clear",value:function(){this._weakMap=Ue(!0)}},{key:"forEach",value:function(e){for(var t in this._weakMap){var i=this.get(t);i&&e(i,t)}}},{key:"find",value:function(e){for(var t in this._weakMap){var i=this.get(t);if(i&&e(i,t))return this._weakMap[t].deref()}return null}},{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}},{key:"destroy",value:function(){this._weakMap={}}}]);var Cf,Rf=new Ef,xf=new Ef,wf=new Ef,kf=new Ef,If=new bf("normal load",[]),Bf=new bf("fetch",[]),Pf=new bf("transform url",[]),Mf=new Map;!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(Cf||(Cf={}));var Of,Df={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.INTERNAL="internal",e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(Of||(Of={}));var Lf=function(){function e(t){n(this,e),this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinished=!0,this.set(t)}return s(e,[{key:"isFinish",get:function(){return this.isFinished},set:function(e){this.isFinished=e}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object.create(null);this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)}},{key:"dispatch",value:function(e,t,i,n,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,i);break;case"progress":this.onProgress&&this.onProgress(t,i,n,r);break;case"error":this.onError&&this.onError(t,i,n,r);break;default:var s="on".concat(e[0].toUpperCase()).concat(e.substr(1));"function"==typeof this[s]&&this[s](t,i,n,r)}}},{key:"recycle",value:function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))}}],[{key:"create",value:function(t){var i;return 0!==e._deadPool.length?(i=e._deadPool.pop()).set(t):i=new e(t),i}}]),e}();Lf.MAX_DEAD_NUM=500,Lf._taskId=0,Lf._deadPool=[];var Nf="0123456789abcdef".split(""),Ff=["","","",""],Gf=Ff.concat(Ff,"-",Ff,"-",Ff,"-",Ff,"-",Ff,Ff,Ff),Vf=Gf.map((function(e,t){return"-"===e?NaN:t})).filter(Number.isFinite);function Uf(e){var t=e.split("@")[0];if(22!==t.length)return e;Gf[0]=e[0],Gf[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=Ut[e.charCodeAt(i)],s=Ut[e.charCodeAt(i+1)];Gf[Vf[n++]]=Nf[r>>2],Gf[Vf[n++]]=Nf[(3&r)<<2|s>>4],Gf[Vf[n++]]=Nf[15&s]}return e.replace(t,Gf.join(""))}var Hf=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function zf(e){var t=Hf.exec(e);return t?t[1]:""}function Wf(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.nativeExt&&(t.ext=t.nativeExt);var i=kf.find((function(t){return!!t.getAssetInfo(e)}));return i&&(t.bundle=i.name),qf(e,t)}function Xf(e){return!!e&&(e instanceof B.SceneAsset||e instanceof B.Scene)}function jf(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function qf(e,t){var i=Lf.create({input:e,options:t}),n=[];try{for(var r,s=R(Pf.sync(i));!(r=s()).done;){var a=r.value,o=a.url;a.recycle(),n.push(o)}}catch(e){for(var u,h=R(i.output);!(u=h()).done;)u.value.recycle();J(e.message,e.stack)}return i.recycle(),n.length>1?n:n[0]}var Yf,Kf,Qf,Jf=Object.freeze({__proto__:null,getUuidFromURL:zf,getUrlWithUuid:Wf,isScene:Xf,normalize:jf,transform:qf,decodeUuid:Uf}),Zf=Js,$f=js,ed=e("Asset",Hs("cc.Asset")((Kf=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).loaded=!0,e._native=Qf&&Qf(),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(m(e),"_uuid",{value:"",writable:!0}),e}return s(i,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=Wf(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=Wf(this._uuid,{__nativeName__:e,nativeExt:tl(e),isNative:!0})}return this._nativeUrl}},{key:"uuid",get:function(){return this._uuid}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"toString",value:function(){return this.nativeUrl}},{key:"serialize",value:function(){}},{key:"_setRawAsset",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._native=!1!==t?e||"":"/".concat(e)}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}},{key:"addRef",value:function(){return this._ref++,this}},{key:"decRef",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._ref>0&&this._ref--,e&&B.assetManager._releaseManager.tryRelease(this),this}},{key:"onLoaded",value:function(){}},{key:"initDefault",value:function(e){e&&(this._uuid=e),this.isDefault=!0}},{key:"validate",value:function(){return!0}},{key:"destroy",value:function(){return $(_e(12101,this._uuid)),g(l(i.prototype),"destroy",this).call(this)}}],[{key:"deserialize",value:function(e){return B.deserialize(e)}}]),i}(Uh(Ga)),Qf=Ms(Kf.prototype,"_native",[Zf],(function(){return""})),x(Kf.prototype,"_nativeAsset",[$f],Object.getOwnPropertyDescriptor(Kf.prototype,"_nativeAsset"),Kf.prototype),Yf=Kf))||Yf);ed.prototype.createNode=null,B.Asset=ed;var td,id,nd,rd,sd,ad,od;!function(e){e[e.RGB565=Ll.R5G6B5]="RGB565",e[e.RGB5A1=Ll.RGB5A1]="RGB5A1",e[e.RGBA4444=Ll.RGBA4]="RGBA4444",e[e.RGB888=Ll.RGB8]="RGB888",e[e.RGB32F=Ll.RGB32F]="RGB32F",e[e.RGBA8888=Ll.RGBA8]="RGBA8888",e[e.RGBA32F=Ll.RGBA32F]="RGBA32F",e[e.A8=Ll.A8]="A8",e[e.I8=Ll.L8]="I8",e[e.AI8=Ll.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=Ll.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=Ll.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=1024]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=Ll.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=Ll.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=1025]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=Ll.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=1026]="RGBA_ETC1",e[e.RGB_ETC2=Ll.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=Ll.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=Ll.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=Ll.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=Ll.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=Ll.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=Ll.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=Ll.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=Ll.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=Ll.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=Ll.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=Ll.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=Ll.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=Ll.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=Ll.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=Ll.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(td||(td={})),function(e){e[e.REPEAT=Ql.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Ql.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Ql.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Ql.BORDER]="CLAMP_TO_BORDER"}(id||(id={})),function(e){e[e.NONE=Kl.NONE]="NONE",e[e.LINEAR=Kl.LINEAR]="LINEAR",e[e.NEAREST=Kl.POINT]="NEAREST"}(nd||(nd={}));var ud=1346981187,hd=wt({PVR:0,PKM:1,ASTC:2});function ld(e,t){return e[t]<<8|e[t+1]}function cd(e){return!!(Sl.hasFeature(Sl.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}var _d,fd,dd,md,pd,vd,yd,gd,Sd,Ad,Td,Ed,bd=e("ImageAsset",Hs("cc.ImageAsset")((od=ad=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this))._nativeData=void 0,r._exportedExts=void 0,r._format=td.RGBA8888,r._width=0,r._height=0,r._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1,mipmapLevelDataSize:[]},void 0!==e&&r.reset(e),r}return s(i,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||cd(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||cd(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=td.RGB_ETC1&&this._format<=td.RGBA_ASTC_12x12||this._format>=td.RGB_A_PVRTC_2BPPV1&&this._format<=td.RGBA_ETC1}},{key:"mipmapLevelDataSize",get:function(){return this._nativeData.mipmapLevelDataSize}},{key:"url",get:function(){return this.nativeUrl}},{key:"reset",value:function(e){cd(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)}},{key:"destroy",value:function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):cd(this.data)&&this.data.close&&this.data.close(),g(l(i.prototype),"destroy",this).call(this)}},{key:"_serialize",value:function(){}},{key:"_deserialize",value:function(e){var t="";"string"==typeof e?t=e:(this._width=e.w,this._height=e.h,t=e.fmt);for(var n,r=yf.gfxDevice,s=t.split("_"),a=Number.MAX_VALUE,o=this._format,u="",h=Lt.SUPPORT_TEXTURE_FORMATS,l=R(s);!(n=l()).done;){var c=n.value.split("@"),_=parseInt(c[0],void 0),f=i.extnames[_]||c[0],d=h.indexOf(f);if(-1!==d&&d<a){var m=c[1]?parseInt(c[1]):this._format;if(!(".astc"!==f||r&&r.getFormatFeatures(Ll.ASTC_RGBA_4X4)&jl.SAMPLED_TEXTURE))continue;if(!(".pvr"!==f||r&&r.getFormatFeatures(Ll.PVRTC_RGBA4)&jl.SAMPLED_TEXTURE))continue;if(!(m!==td.RGB_ETC1&&m!==td.RGBA_ETC1||r&&r.getFormatFeatures(Ll.ETC_RGB8)&jl.SAMPLED_TEXTURE))continue;if(!(m!==td.RGB_ETC2&&m!==td.RGBA_ETC2||r&&r.getFormatFeatures(Ll.ETC2_RGB8)&jl.SAMPLED_TEXTURE))continue;if(".webp"===f&&!Sl.hasFeature(Sl.Feature.WEBP))continue;a=d,u=f,o=m}}u?(this._setRawAsset(u),this._format=o):ae(3121)}},{key:"initDefault",value:function(e){if(g(l(i.prototype),"initDefault",this).call(this,e),i._sharedPlaceHolderCanvas)this.reset(i._sharedPlaceHolderCanvas);else{var t=M.document.createElement("canvas"),n=t.getContext("2d"),r=t.width=t.height=2;n.fillStyle="#ff00ff",n.fillRect(0,0,r,r),this.reset(t),i._sharedPlaceHolderCanvas=t}}},{key:"validate",value:function(){return!!this.data}}],[{key:"mergeCompressedTextureMips",value:function(e){var t=new Uint8Array(0),i=null;try{for(var n,r=8+4*e.length,s=0,a=R(e);!(n=a()).done;)s+=n.value.byteLength;s+=r,t=new Uint8Array(s);var o=new DataView(t.buffer,t.byteOffset,t.byteLength);o.setUint32(0,ud,!0),o.setUint32(4,e.length,!0);for(var u=r,h=0;h<e.length;h++){var l=e[h];if(o.setUint32(8+4*h,l.byteLength,!0),l instanceof ArrayBuffer){var c=new Uint8Array(l);t.set(c,u)}else{var _=new Uint8Array(l.buffer,l.byteOffset,l.byteLength);t.set(_,u)}u+=l.byteLength}}catch(e){i=e,console.warn(i)}return t}},{key:"parseCompressedTextures",value:function(e,t){var n={_data:new Uint8Array(0),_compressed:!0,width:0,height:0,format:0,mipmapLevelDataSize:[]},r=e instanceof ArrayBuffer?e:e.buffer,s=new DataView(r);if(s.getUint32(0,!0)===ud){var a=s.getUint32(4,!0),o=s.getUint32(8,!0),u=8+4*a;i.parseCompressedTexture(e,0,u,o,t,n);for(var h=u+o,l=1;l<a;l++){var c=s.getUint32(8+4*l,!0);i.parseCompressedTexture(e,l,h,c,t,n),h+=c}}else i.parseCompressedTexture(e,0,0,0,t,n);return n}},{key:"parseCompressedTexture",value:function(e,t,n,r,s,a){switch(s){case hd.PVR:i.parsePVRTexture(e,t,n,r,a);break;case hd.PKM:i.parsePKMTexture(e,t,n,r,a);break;case hd.ASTC:i.parseASTCTexture(e,t,n,r,a)}}},{key:"parsePVRTexture",value:function(e,t,i,n,r){var s=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(s,i,13);if(55727696===a[0]){var o=i+a[12]+52,u=n-a.byteLength;if(n>0){var h=new Uint8Array(s,o,u),l=new Uint8Array(r._data.byteLength+h.byteLength);l.set(r._data),l.set(h,r._data.byteLength),r._data=l,r.mipmapLevelDataSize[t]=u}else r._data=new Uint8Array(s,o);r.width=t>0?r.width:a[7],r.height=t>0?r.height:a[6]}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var c=i+a[0],_=n-a.byteLength;if(n>0){var f=new Uint8Array(s,c,_),d=new Uint8Array(r._data.byteLength+f.byteLength);d.set(r._data),d.set(f,r._data.byteLength),r._data=d,r.mipmapLevelDataSize[t]=_}else r._data=new Uint8Array(s,c);r.width=t>0?r.width:a[1],r.height=t>0?r.height:a[2]}}},{key:"parsePKMTexture",value:function(e,t,i,n,r){var s=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(s,i,16),o=ld(a,6);if(0!==o&&1!==o&&3!==o)throw new Error("Invalid magic number in ETC header");var u=i+16,h=n-16;if(n>0){var l=new Uint8Array(s,u,h),c=new Uint8Array(r._data.byteLength+l.byteLength);c.set(r._data),c.set(l,r._data.byteLength),r._data=c,r.mipmapLevelDataSize[t]=h}else r._data=new Uint8Array(s,u);r.width=t>0?r.width:ld(a,12),r.height=t>0?r.height:ld(a,14)}},{key:"parseASTCTexture",value:function(e,t,i,n,r){var s=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(s,i,16);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var o=a[4],u=a[5],h=a[6];if((o<3||o>6||u<3||u>6||h<3||h>6)&&(o<4||7===o||9===o||11===o||o>12||u<4||7===u||9===u||11===u||u>12||1!==h))throw new Error("Invalid block number in ASTC header");var l=function(e,t){return 4===e?td.RGBA_ASTC_4x4:5===e?4===t?td.RGBA_ASTC_5x4:td.RGBA_ASTC_5x5:6===e?5===t?td.RGBA_ASTC_6x5:td.RGBA_ASTC_6x6:8===e?5===t?td.RGBA_ASTC_8x5:6===t?td.RGBA_ASTC_8x6:td.RGBA_ASTC_8x8:10===e?5===t?td.RGBA_ASTC_10x5:6===t?td.RGBA_ASTC_10x6:8===t?td.RGBA_ASTC_10x8:td.RGBA_ASTC_10x10:10===t?td.RGBA_ASTC_12x10:td.RGBA_ASTC_12x12}(o,u),c=i+16,_=n-16;if(n>0){var f=new Uint8Array(s,c,_),d=new Uint8Array(r._data.byteLength+f.byteLength);d.set(r._data),d.set(f,r._data.byteLength),r._data=d,r.mipmapLevelDataSize[t]=_}else r._data=new Uint8Array(s,c);r.width=t>0?r.width:a[7]+(a[8]<<8)+(a[9]<<16),r.height=t>0?r.height:a[10]+(a[11]<<8)+(a[12]<<16),r.format=l}}]),i}(ed),ad.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],ad._sharedPlaceHolderCanvas=null,x((sd=od).prototype,"_nativeAsset",[Ta],Object.getOwnPropertyDescriptor(sd.prototype,"_nativeAsset"),sd.prototype),rd=sd))||rd);B.ImageAsset=bd,Bt(Ll);var Cd,Rd,xd,wd=new ke("Tex"),kd=Hs("cc.TextureBase")((Ed=Td=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._format=dd&&dd(),e._minFilter=md&&md(),e._magFilter=pd&&pd(),e._mipFilter=vd&&vd(),e._wrapS=yd&&yd(),e._wrapT=gd&&gd(),e._wrapR=Sd&&Sd(),e._anisotropy=Ad&&Ad(),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new jc,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=wd.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=bl(e._id,666),e}return s(i,[{key:"isCompressed",get:function(){return this._format>=td.RGB_ETC1&&this._format<=td.RGBA_ASTC_12x12||this._format>=td.RGB_A_PVRTC_2BPPV1&&this._format<=td.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){void 0===i&&(i=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=i,this._samplerInfo.addressW=i,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}},{key:"destroy",value:function(){var e,t=g(l(i.prototype),"destroy",this).call(this);return t&&null!==(e=B.director.root)&&void 0!==e&&e.batcher2D&&B.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),t}},{key:"getHash",value:function(){return this._textureHash}},{key:"getGFXTexture",value:function(){return null}},{key:"getSamplerInfo",value:function(){return this._samplerInfo}},{key:"getGFXSampler",value:function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):ue(9302)),this._gfxSampler}},{key:"_serialize",value:function(){return""}},{key:"_deserialize",value:function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))}},{key:"_getGFXDevice",value:function(){return yf.gfxDevice}},{key:"_getGFXFormat",value:function(){return this._getGFXPixelFormat(this._format)}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?td.RGBA8888:e}},{key:"_getGFXPixelFormat",value:function(e){return e===td.RGBA_ETC1?e=td.RGB_ETC1:e===td.RGB_A_PVRTC_4BPPV1?e=td.RGB_PVRTC_4BPPV1:e===td.RGB_A_PVRTC_2BPPV1&&(e=td.RGB_PVRTC_2BPPV1),e}}]),i}(ed),Td.PixelFormat=td,Td.WrapMode=id,Td.Filter=nd,dd=Ms((fd=Ed).prototype,"_format",[Js],(function(){return td.RGBA8888})),md=Ms(fd.prototype,"_minFilter",[Js],(function(){return nd.LINEAR})),pd=Ms(fd.prototype,"_magFilter",[Js],(function(){return nd.LINEAR})),vd=Ms(fd.prototype,"_mipFilter",[Js],(function(){return nd.NONE})),yd=Ms(fd.prototype,"_wrapS",[Js],(function(){return id.REPEAT})),gd=Ms(fd.prototype,"_wrapT",[Js],(function(){return id.REPEAT})),Sd=Ms(fd.prototype,"_wrapR",[Js],(function(){return id.REPEAT})),Ad=Ms(fd.prototype,"_anisotropy",[Js],(function(){return 0})),_d=fd))||_d;B.TextureBase=kd;var Id=e("Script",Hs("cc.Script")(Cd=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(ed))||Cd);B._Script=Id;var Bd=e("JavaScript",Hs("cc.JavaScript")(Rd=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(Id))||Rd);B._JavaScript=Bd;var Pd,Md,Od,Dd,Ld,Nd,Fd,Gd=e("TypeScript",Hs("cc.TypeScript")(xd=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(Id))||xd);B._TypeScript=Gd;var Vd,Ud,Hd,zd,Wd,Xd,jd,qd,Yd,Kd,Qd,Jd,Zd=e("EventHandler",Hs("cc.ClickEvent")((Md=function(){function e(){n(this,e),this.target=Od&&Od(),this.component=Dd&&Dd(),this._componentId=Ld&&Ld(),this.handler=Nd&&Nd(),this.customEventData=Fd&&Fd()}return s(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}},{key:"emit",value:function(e){var t=this.target;if(B.isValid(t)){this._genCompIdIfNeeded();var i=B.js.getClassById(this._componentId),n=t.getComponent(i);if(B.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(n,e))}}}},{key:"_compName2Id",value:function(e){var t=B.js.getClassByName(e);return B.js.getClassId(t)}},{key:"_compId2Name",value:function(e){var t=B.js.getClassById(e);return B.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}}],[{key:"emitEvents",value:function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var s=0,a=t.length;s<a;s++){var o=t[s];o instanceof e&&o.emit(n)}}}]),e}(),Od=Ms(Md.prototype,"target",[Js],(function(){return null})),Dd=Ms(Md.prototype,"component",[Js],(function(){return""})),Ld=Ms(Md.prototype,"_componentId",[Js],(function(){return""})),Nd=Ms(Md.prototype,"handler",[Js],(function(){return""})),Fd=Ms(Md.prototype,"customEventData",[Js],(function(){return""})),Pd=Md))||Pd),$d=new ke("Comp"),em=Ga.Flags.IsOnLoadCalled,tm=e("Component",(Vd=Hs("cc.Component"),Ud=Aa(Id),Vd((Yd=qd=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).node=Wd&&Wd(),e._enabled=Xd&&Xd(),e.__prefab=jd&&jd(),e._sceneGetter=null,e._id=$d.getNewId(),e}return s(i,[{key:"name",get:function(){if(this._name)return this._name;var e=He(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?"".concat(this.node.name,"<").concat(e,">"):e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=B.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&em}},{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){return!!g(l(i.prototype),"destroy",this).call(this)&&(this._enabled&&this.node.activeInHierarchy&&B.director._compScheduler.disableComp(this),!0)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks(),B.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return e||(e=B.instantiate._clone(this,this)),e&&(e.node=null),e}},{key:"schedule",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:B.macro.REPEAT_FOREVER,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;ce(e,1619),ce((t=t||0)>=0,1620),i=Number.isNaN(i)?B.macro.REPEAT_FOREVER:i,n=n||0;var r=B.director.getScheduler(),s=r.isTargetPaused(this);r.schedule(e,this,t,i,n,s)}},{key:"scheduleOnce",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.schedule(e,0,0,t)}},{key:"unschedule",value:function(e){e&&B.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){B.director.getScheduler().unscheduleAllForTarget(this)}}]),i}(Ga),qd.EventHandler=Zd,qd.system=null,x((zd=Yd).prototype,"__scriptAsset",[Ud],Object.getOwnPropertyDescriptor(zd.prototype,"__scriptAsset"),zd.prototype),Wd=Ms(zd.prototype,"node",[Js],(function(){return null})),Xd=Ms(zd.prototype,"_enabled",[Js],(function(){return!0})),jd=Ms(zd.prototype,"__prefab",[Js],(function(){return null})),Hd=zd))||Hd)),im=tm.prototype;im.update=null,im.lateUpdate=null,im.__preload=null,im.onLoad=null,im.start=null,im.onEnable=null,im.onDisable=null,im.onDestroy=null,im.onFocusInEditor=null,im.onLostFocusInEditor=null,im.resetInEditor=null,im._getLocalBounds=null,im.onRestore=null,tm._requireComponent=null,tm._executionOrder=0,Ne(tm,"_registerEditorProps",(function(e,t){var i=t.requireComponent;i&&(Array.isArray(i)&&(i=i.filter(Boolean)),e._requireComponent=i);var n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)})),B.Component=tm;var nm=e("MissingScript",Hs("cc.MissingScript")((Qd=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._$erialized=Jd&&Jd(),e}return s(i,[{key:"onLoad",value:function(){ae(4600,this.node.name)}}],[{key:"safeFindClass",value:function(e){var t=_t(e);if(t)return t;B.deserialize.reportMissingClass(e)}}]),i}(tm),Jd=Ms(Qd.prototype,"_$erialized",[Js,$s],(function(){return null})),Kd=Qd))||Kd);B._MissingScript=nm;try{var rm=nm.__values__;0!==rm.length&&"_$erialized"===rm[rm.length-1]||(J("The '_$erialized' prop in MissingScript is missing. Please contact jare."),J("    Error props: ['".concat(rm,"']")))}catch(qn){J("Error when checking MissingScript 5, ".concat(qn))}var sm=function(){function e(t,i){n(this,e),this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=i}return s(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function am(e){var t=e;return{chunks:t.chunks,document:t.document}}function om(e){if(e.length<16)throw new um(_e(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new um(_e(13100));var i=t.getUint32(4,!0);if(1!==i)throw new um(_e(13101,i));if(t.getUint32(8,!0)!==t.byteLength)throw new um(_e(13102));var n=12,r=t.getUint32(n,!0);n+=4;var s=new Uint8Array(t.buffer,n+t.byteOffset,r);n+=r;var a,o=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(_e(13104))}(s);try{a=JSON.parse(o)}catch(e){throw new um(e)}for(var u=[];n<t.byteLength;){n%8!=0&&(n+=8-n%8);var h=t.getUint32(n,!0);n+=4,u.push(new Uint8Array(t.buffer,n+t.byteOffset,h)),n+=h}if(n!==t.byteLength)throw new um(_e(13102));return new sm(a,u)}var um=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(d(Error));function hm(e,t,i,n,r){if(t instanceof B.ValueType){r||e.push("if(prop){");var s=He(t);e.push("s._deserializeFastDefinedObject(o".concat(i,",prop,").concat(s,");")),r||e.push("}else o".concat(i,"=null;"))}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, ".concat(n,");\n} else {\n    o").concat(i,"=null;\n}\n"))}s((function e(){n(this,e),this._viewOrPaddings=[],this._length=0}),[{key:"byteLength",get:function(){return this._length}},{key:"alignAs",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var i=e-t;return this._viewOrPaddings.push(i),this._length+=i,i}}return 0}},{key:"append",value:function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"get",value:function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(i){"number"==typeof i?t+=i:(e.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength),t),t+=i.byteLength)})),e}}]),B.internal.parseCCONJson=am,B.internal.decodeCCONBinary=om,B.internal.CCON=sm;var lm=Ci.Attr.DELIMETER,cm="".concat(lm,"type"),_m="".concat(lm,"default"),fm="".concat(lm,"formerlySerializedAs"),dm=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.call(this,(function(e){e.clear()}),1)}return s(i,[{key:"get",value:function(e,t,i,n,r){var s=this._get();return s?(s.reset(e,t,i,n,r),s):new mm(e,t,i,n,r)}}]),i}(pt),mm=function(){function e(t,i,r,s){n(this,e),this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=s,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._reportMissingClass=r,this._onDereferenced=null==i?void 0:i.onDereferenced}return s(e,[{key:"reset",value:function(e,t,i,n){this.result=e,this.customEnv=n,this._classFinder=t,this._reportMissingClass=i,this._onDereferenced=null==t?void 0:t.onDereferenced}},{key:"clear",value:function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null}},{key:"deserialize",value:function(e){var t,i=!1;e instanceof sm?(i=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:i};var n=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(n,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData}},{key:"_deserializeObject",value:function(e,t,i,n){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,i,n):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}}},{key:"_deserializeTypedArrayView",value:function(e){return globalThis[e.ctor].from(e.array)}},{key:"_deserializeTypedArrayViewRef",value:function(e){var t=e.offset,i=e.length,n=e.ctor;return new globalThis[n](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,i)}},{key:"_deserializeArray",value:function(e){for(var t,n=new Array(e.length),r=0;r<e.length;r++)"object"===i(t=e[r])&&t?this._deserializeAndAssignField(n,t,"".concat(r))&&(n[r]=null):n[r]=t;return n}},{key:"_deserializePlainObject",value:function(e){var t={};return this._fillPlainObject(t,e),t}},{key:"_deserializeTypeTaggedObject",value:function(e,t,i,n){var r=this,s=e.__type__,a=this._classFinder(s,e,i,n);if(!a)return this._classFinder===_t&&this._reportMissingClass(s),null;var o=function(e){var i=new e;return t>=0&&(r.deserializedList[t]=i),i}(a);return this._deserializeInto(e,o,a),o}},{key:"_deserializeInto",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];n||!t[Ya]?t._deserialize?t._deserialize(e.content,this):B.Class._isCCClass(i)?this._deserializeFireClass(t,e,i):this._deserializeFastDefinedObject(t,e,i):this._runCustomizedDeserialize(e,t,i)}},{key:"_runCustomizedDeserialize",value:function(e,t,n){var r=this,s={readProperty:function(t){var n=e[t];return"object"===i(n)&&n?r._deserializeObjectField(n):n},readThis:function(){r._deserializeInto(e,t,n,!0)},readSuper:function(){var i=et(n);i&&r._deserializeInto(e,t,i)}};t[Ya](s,this._context)}},{key:"_deserializeFireClass",value:function(e,t,n){var r;if(n.hasOwnProperty("__deserialize__"))r=n.__deserialize__;else{r=function(e,t){for(var n=Ci.Attr.getClassAttrs(t),r=t.__values__,s=["var prop;"],a=Nt.test(mt(t)),o=0;o<r.length;o++){var u=r[o],h=void 0,l=void 0;Ci.IDENTIFIER_RE.test(u)?(l='"'.concat(u,'"'),h=".".concat(u)):(l=Ci.escapeForJS(u),h="[".concat(l,"]"));var c=h;if(n[u+fm]){var _=n[u+fm];c=Ci.IDENTIFIER_RE.test(_)?".".concat(_):"[".concat(Ci.escapeForJS(_),"]")}s.push("prop=d".concat(c,";")),s.push("if(typeof ".concat("prop",'!=="undefined"){'));var f=Ci.getDefault(n[u+_m]),d=n[u+cm];if(a&&(void 0!==f||d)){var m=void 0;if(void 0===f)m=d instanceof Ci.Attr.PrimitiveType||d===Si||d===Ai;else{var p=i(f);m="string"===p||"number"===p||"boolean"===p}m?s.push("o".concat(h,"=prop;")):hm(s,f,h,l,!0)}else s.push("".concat("if(typeof ".concat("prop",'!=="object"){')+"o").concat(h,"=prop;")+"}else{"),hm(s,f,h,l,!1),s.push("}");s.push("}")}return(tt(t,B.Node)||tt(t,B.Component))&&s.push("d._id&&(o._id=d._id);"),"_$erialized"===r[r.length-1]&&(s.push("o._$erialized=JSON.parse(JSON.stringify(d));"),s.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",s.join(""))}(0,n);try{if(n===nm){var s=n.__values__;0!==s.length&&"_$erialized"===s[s.length-1]||(J("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),J("    Error props: ['".concat(s,"']. Please contact jare.")));var a=r;r=function(e,t,i,n){a(e,t,i,n),t._$erialized||J("Unable to stash previously serialized data. ".concat(JSON.stringify(i)))}}}catch(e){J("Error when checking MissingScript 6, ".concat(e))}Ne(n,"__deserialize__",r,!0)}r(this,e,t,n)}},{key:"_deserializeAndAssignField",value:function(e,t,i){var n=t.__id__;if("number"==typeof n){var r=this.deserializedList[n];if(r)e[i]=r;else{var s,a=this._serializedData[n];e[i]=this._deserializeObject(a,n,void 0,i),null===(s=this._onDereferenced)||void 0===s||s.call(this,this.deserializedList,n,e,i)}}else{var o=t.__uuid__;if(o){var u=t.__expectedType__;this.result.push(e,i,o,u)}else e[i]=this._deserializeObject(t,-1)}return!1}},{key:"_deserializeObjectField",value:function(e){var t=e.__id__;if("number"==typeof t){var i=this.deserializedList[t];if(i)return i;var n=this._serializedData[t];return this._deserializeObject(n,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)}},{key:"_fillPlainObject",value:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];"object"!==i(r)?"__type__"!==n&&(e[n]=r):r?this._deserializeAndAssignField(e,r,n)&&(e[n]=null):e[n]=null}}},{key:"_deserializeFastDefinedObject",value:function(e,t,n){if(n===B.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===B.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==B.Color){if(n===B.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var r=Ci.Attr.getClassAttrs(n),s=n.__values__,a=0;a<s.length;a++){var o=s[a],u=t[o];void 0!==u||t.hasOwnProperty(o)||(u=Ci.getDefault(r[o+_m])),"object"!==i(u)?e[o]=u:u?this._deserializeAndAssignField(e,u,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var h=t.a;e.a=void 0===h?255:h}}}]),e}();mm.pool=new dm;var pm=[In,an,en,vn,cn,Mn,Dn,Cn];function vm(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var ym=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},vm,vm,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){Cn.fromArray(e,t,1)}],gm=e("Details",function(){function e(){n(this,e),this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}return s(e,[{key:"init",value:function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])}},{key:"reset",value:function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)}},{key:"push",value:function(e,t,i,n){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(i),this.uuidTypeList.push(n||"")}}]),e}());function Sm(e,t){for(var i=e[4][t[0]],n=i[0],r=new(0,n[0]),s=n[1],a=n[2],o=i[i.length-1],u=1;u<o;++u)r[s[i[u]]]=t[u];for(;u<t.length;++u){var h=s[i[u]],l=n[i[u]+a];(0,Rm[l])(e,r,h,t[u])}return r}function Am(e,t,i){var n=new t;return n._deserialize?n._deserialize(i,e[0]):ue(5303,He(t)),n}function Tm(e,t,i,n){n>=0?t[i]=e[5][n]:e[7][3*~n]=t}function Em(e){return function(t,i,n,r){for(var s=0;s<r.length;++s)e(t,r,s,r[s]);i[n]=r}}function bm(e,t,i,n){t[i]=null,e[8][n]=t}function Cm(e,t,i,n){t[i]=Sm(e,n)}gm.pool=new pt((function(e){e.reset()}),5),gm.pool.get=function(){return this._get()||new gm};var Rm=new Array(13);function xm(e,t,i){return e||i(t),Object}function wm(e,t,i,n,r,s,a){var o=e(t);if(!o){if(r)return void(i[n]=function(t,i,n){return function(){var r=e(n)||xm(s,n,a);return t[i]=r,new r}}(i,n,t));o=xm(s,t,a)}i[n]=o}function km(e,t,i,n){for(var r=i||_t,s=e[3],a=0;a<s.length;++a){var o=s[a];"string"!=typeof o?wm(r,o[0],o,0,t,i,n):wm(r,o,s,a,t,i,n)}}function Im(e){var t=e[4];if(t)for(var i=e[3],n=0;n<t.length;++n){var r=t[n];r[0]=i[r[0]]}}function Bm(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var r,s=!t;if(t=t||gm.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Pm}return!1}(e)){t.init(e),n=n||{};var a,o=e[0],u=!1;if("object"===i(o)&&(u=o.preprocessed,o=o.version),o<1)throw new Error(_e(5304,o));n._version=o,n.result=t,e[0]=n,u||(km(e,!1,n.classFinder,null!==(a=n.reportMissingClass)&&void 0!==a?a:Bm.reportMissingClass),Im(e)),B.game._isCloning=!0;var h=e[5],l=function(e){var t=e[5],i=e[6],n=0===i?0:i.length,r=t[t.length-1],s=t.length-n;"number"!=typeof r?r=0:(r<0&&(r=~r),--s);for(var a=0;a<s;++a)t[a]=Sm(e,t[a]);for(var o=e[3],u=0;u<n;++u,++a){var h=i[u],l=t[a];if(h>=0){var c=o[h];t[a]=Am(e,c,l)}else(0,Rm[h=~h])(e,t,a,l)}return r}(e);B.game._isCloning=!1,e[7]&&function(e,t,i){for(var n=e.length-1,r=0,s=3*e[n];r<s;r+=3){var a=e[r],o=t[e[r+2]],u=e[r+1];u>=0?a[i[u]]=o:a[~u]=o}for(;r<n;r+=3){var h=t[e[r]],l=t[e[r+2]],c=e[r+1];c>=0?h[i[c]]=l:h[~c]=l}}(e[7],h,e[2]),function(e){for(var t=e[5],i=e[2],n=e[1],r=e[8],s=e[9],a=e[10],o=0;o<r.length;++o){var u=r[o];"number"==typeof u&&(r[o]=t[u]);var h=s[o];"number"==typeof h&&(h=h>=0?i[h]:~h,s[o]=h);var l=a[o];"number"==typeof l&&(a[o]=n[l])}}(e),r=h[l]}else r=function(e,t,i){var n,r=(i=i||{}).classFinder||_t,s=i.createAssetRefs||Sl.platform===qh.EDITOR_CORE,a=i.customEnv,o=i.ignoreEditorOnly,u=null!==(n=i.reportMissingClass)&&void 0!==n?n:B.deserialize.reportMissingClass;t.init();var h=mm.pool.get(t,r,u,a,o);B.game._isCloning=!0;var l=h.deserialize(e);return B.game._isCloning=!1,mm.pool.put(h),s&&t.assignAssetsBy((function(e,t){return EditorExtends.serialize.asAsset(e,t.type)})),l}(e,t,n);return s&&gm.pool.put(t),r}Rm[0]=function(e,t,i,n){t[i]=n},Rm[1]=Tm,Rm[2]=Em(Tm),Rm[3]=Em(bm),Rm[4]=Cm,Rm[5]=function(e,t,i,n){ym[n[0]](t[i],n)},Rm[6]=bm,Rm[7]=function(e,t,i,n){t[i].set(n)},Rm[8]=function(e,t,i,n){var r=new pm[n[0]];ym[n[0]](r,n),t[i]=r},Rm[9]=Em(Cm),Rm[10]=function(e,t,i,n){var r=e[3][n[0]];t[i]=Am(e,r,n[1])},Rm[11]=function(e,t,i,n){var r=n[0];t[i]=r;for(var s=1;s<n.length;s+=3){var a=n[s],o=n[s+1],u=n[s+2];(0,Rm[o])(e,r,a,u)}},Rm[12]=function(e,t,i,n){for(var r=n[0],s=0;s<r.length;++s){var a=r[s],o=n[s+1];0!==o&&(0,Rm[o])(e,r,s,a)}t[i]=r},Bm.Details=gm,Bm.reportMissingClass=function(e){ue(5302,e)};var Pm=function e(t){n(this,e),this.preprocessed=!0,this.version=t};function Mm(e,t,i){return[1,0,0,[e],0,i?[t,-1]:[t],[0],0,[],[],[]]}B.deserialize=Bm;var Om=new WeakMap,Dm=new WeakSet,Lm=new WeakSet;function Nm(e,t){var i;i=nm.safeFindClass;var n,r=gm.pool.get();try{n=Bm(e,r,{classFinder:i,customEnv:t})}catch(e){throw J(e),gm.pool.put(r),e}n._uuid=t.__uuid__||"";for(var s=r.uuidList,a=r.uuidObjList,o=r.uuidPropList,u=r.uuidTypeList||[],h=[],l=0;l<s.length;l++){var c=s[l];h[l]={uuid:Uf(c),owner:a[l],prop:o[l],type:_t(u[l])}}return Om.set(n,h),n._native&&Dm.add(n),gm.pool.put(r),n}var Fm=function(){function e(){n(this,e),this._depends=new Ef}return s(e,[{key:"init",value:function(){this._depends.clear()}},{key:"getNativeDep",value:function(e){var t=this._depends.get(e);return t&&t.nativeDep?u({},t.nativeDep):null}},{key:"getDeps",value:function(e){return this._depends.has(e)?this._depends.get(e).deps:[]}},{key:"getDepsRecursively",value:function(e){var t=Object.create(null),i=[];return this._descend(e,t,i),i}},{key:"remove",value:function(e){this._depends.remove(e)}},{key:"parse",value:function(e,t){var i,n,r=null;if(Array.isArray(t)||t.__type__||t instanceof sm){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(n=(i=t[5])[i.length-1])&&n<0)try{var s=Nm(t,{__uuid__:e});(r=this._parseDepsFromAsset(s)).nativeDep&&(r.nativeDep.uuid=e),wf.add("".concat(e,"@import"),s)}catch(t){xf.remove("".concat(e,"@import")),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r}},{key:"_parseDepsFromAsset",value:function(e){for(var t={deps:[],parsedFromExistAsset:!0},i=Om.get(e),n=0,r=i.length;n<r;n++)t.deps.push(i[n].uuid);return Dm.has(e)&&(t.nativeDep=e._nativeDep),t}},{key:"_parseDepsFromJson",value:function(e){var t=function(e){return i=(t=e)[1],t[10].map((function(e){return i[e]}));var t,i}(e);return t.forEach((function(e,i){return t[i]=Uf(e)})),t}},{key:"_descend",value:function(e,t,i){for(var n=this.getDeps(e),r=0;r<n.length;r++){var s=n[r];t[s]||(t[s]=!0,i.push(s),this._descend(s,t,i))}}}],[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}();Fm._instance=void 0;var Gm,Vm=Fm.instance,Um=[new Mc];function Hm(e){return e&&0==(e&e-1)}var zm,Wm,Xm,jm,qm,Ym=Hs("cc.SimpleTexture")(Gm=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gfxTexture=null,e._gfxTextureView=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e._baseLevel=0,e._maxLevel=1e3,e}return s(i,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}},{key:"getGFXTexture",value:function(){return this._gfxTextureView}},{key:"destroy",value:function(){return this._tryDestroyTextureView(),this._tryDestroyTexture(),g(l(i.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this._gfxTexture&&!(this._mipmapLevel<=t)){var n=this._getGFXDevice();if(n){var r=Um[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=i,ArrayBuffer.isView(e)?n.copyBuffersToTexture([e],this._gfxTexture,Um):n.copyTexImagesToTexture([e],this._gfxTexture,Um)}}}},{key:"_assignImage",value:function(e,t,i){var n=e.data;if(n&&(this.uploadData(n,t,i),this._checkTextureLoaded(),Lt.CLEANUP_IMAGE_CACHE)){var r=Vm.getDeps(this._uuid),s=r.indexOf(e._uuid);-1!==s&&(gt(r,s),e.decRef())}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_setMipRange",value:function(e,t){this._baseLevel=e<1?0:e,this._maxLevel=t<1?0:t}},{key:"setMipRange",value:function(e,t){ce(e<=t,3124),this._setMipRange(e,t);var i=this._getGFXDevice();if(i){var n=this._createTextureView(i);this._tryDestroyTextureView(),this._gfxTextureView=n}}},{key:"_getGfxTextureCreateInfo",value:function(){return null}},{key:"_getGfxTextureViewCreateInfo",value:function(){return null}},{key:"_tryReset",value:function(){if(this._tryDestroyTextureView(),this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&(this._createTexture(e),this._gfxTextureView=this._createTextureView(e))}}},{key:"isUsingOfflineMipmaps",value:function(){return!1}},{key:"_createTexture",value:function(e){if(0!==this._width&&0!==this._height){var t=Xl.NONE;this._mipFilter!==nd.NONE&&function(e,t,i){return!(e.gfxAPI===Ml.WEBGL)||Hm(t)&&Hm(i)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var i=Math.max(e,t),n=0;i;)i>>=1,n++;return n}(this._width,this._height),this.isUsingOfflineMipmaps()||this.isCompressed||(t=Xl.GEN_MIPMAP));var i=this._getGfxTextureCreateInfo({usage:Wl.SAMPLED|Wl.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(i){var n=e.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=n}}}},{key:"_createTextureView",value:function(e){if(!this._gfxTexture)return null;var t=this._maxLevel<this._mipmapLevel?this._maxLevel:this._mipmapLevel-1,i=this._getGfxTextureViewCreateInfo({texture:this._gfxTexture,format:this._getGFXFormat(),baseLevel:this._baseLevel,levelCount:t-this._baseLevel+1});return i?e.createTexture(i):null}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}},{key:"_tryDestroyTextureView",value:function(){this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}}]),i}(kd))||Gm;B.SimpleTexture=Ym;var Km=[],Qm=e("Texture2D",(zm=Hs("cc.Texture2D"),Wm=Aa([bd]),zm((jm=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._mipmaps=qm&&qm(),e}return s(i,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){if(e.length>0&&e[0].mipmapLevelDataSize&&e[0].mipmapLevelDataSize.length>0){Km.length=0;for(var t=e[0].mipmapLevelDataSize,i=e[0].data,n=e[0].width,r=e[0].height,s=e[0].format,a=0,o=0;o<t.length;o++){var u=new Uint8Array(i.buffer,a,t[o]),h=new Uint8Array(t[o]);h.set(u),Km[o]=new bd({_data:h,_compressed:!0,width:n,height:r,format:s,mipmapLevelDataSize:[]}),Km[o]._uuid=e[0]._uuid,this.setMipFilter(nd.LINEAR),a+=t[o]}this._setMipmapParams(Km)}else this._setMipmapParams(e)}},{key:"_setMipmapParams",value:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0];this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,i){t._assignImage(e,i)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}},{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var i=void 0===e.baseLevel?0:e.baseLevel,n=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(i,n),this._tryReset()}},{key:"create",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:td.RGBA8888,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1e3;this.reset({width:e,height:t,format:i,mipmapLevel:n,baseLevel:r,maxLevel:s})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;if(!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),n=0;n<i;++n){var r=e+n;this._assignImage(this._mipmaps[r],r)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],g(l(i.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(){return null}},{key:"_deserialize",value:function(e,t){var n=e;g(l(i.prototype),"_deserialize",this).call(this,n.base,t),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r)if(this._mipmaps[r]=new bd,n.mipmaps[r]){var s=n.mipmaps[r];t.result.push(this._mipmaps,"".concat(r),s,mt(bd))}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=new Wc(zl.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e),t}},{key:"_getGfxTextureViewCreateInfo",value:function(e){var t=new Xc;return t.type=zl.TEX2D,Object.assign(t,e),t}},{key:"initDefault",value:function(e){g(l(i.prototype),"initDefault",this).call(this,e);var t=new bd;t.initDefault(),this.image=t}},{key:"validate",value:function(){return this.mipmaps&&0!==this.mipmaps.length}}]),i}(Ym),qm=Ms(jm.prototype,"_mipmaps",[Wm],(function(){return[]})),Xm=jm))||Xm));B.Texture2D=Qm;var Jm=function(){function e(t,i){n(this,e),this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var r=new Zm;r.initWithSize(t,i),this._texture=r,this._width=t,this._height=i,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}return s(e,[{key:"insertSpriteFrame",value:function(e){var t=e.rect,i=e.texture,n=this._innerTextureInfos[i.getId()],r=t.x,s=t.y;if(n)r+=n.x,s+=n.y;else{var a=i.width,o=i.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+o+2>this._nexty&&(this._nexty=this._y+o+2),this._nexty>this._height)return null;B.internal.dynamicAtlasManager.textureBleeding&&((a<=8||o<=8)&&(this._texture.drawTextureAt(i.image,this._x-1,this._y-1),this._texture.drawTextureAt(i.image,this._x-1,this._y+1),this._texture.drawTextureAt(i.image,this._x+1,this._y-1),this._texture.drawTextureAt(i.image,this._x+1,this._y+1)),this._texture.drawTextureAt(i.image,this._x-1,this._y),this._texture.drawTextureAt(i.image,this._x+1,this._y),this._texture.drawTextureAt(i.image,this._x,this._y-1),this._texture.drawTextureAt(i.image,this._x,this._y+1)),this._texture.drawTextureAt(i.image,this._x,this._y),this._innerTextureInfos[i.getId()]={x:this._x,y:this._y,texture:i},this._count++,r+=this._x,s+=this._y,this._x+=a+2}var u={x:r,y:s,texture:this._texture};return this._innerSpriteFrames.push(e),u}},{key:"deleteInnerTexture",value:function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)}},{key:"isEmpty",value:function(){return this._count<=0}},{key:"reset",value:function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,i=e.length;t<i;t++){var n=e[t];n.isValid&&n._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}}},{key:"destroy",value:function(){this.reset(),this._texture.destroy()}}]),e}(),Zm=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"initWithSize",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:td.RGBA8888;this.reset({width:e,height:t,format:i})}},{key:"drawTextureAt",value:function(e,t,i){var n=this.getGFXTexture();if(e&&n){var r=this._getGFXDevice();if(r){var s=new Mc;s.texOffset.x=t,s.texOffset.y=i,s.texExtent.width=e.width,s.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],n,[s])}else console.warn("Unable to get device")}}}]),i}(Qm),$m={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},ep=e("Layers",function(){function e(){n(this,e)}return s(e,null,[{key:"init",value:function(){var t=Dt.querySettings(Ot.Category.ENGINE,"customLayers");if(t)for(var i=0;i<t.length;i++){var n=t[i];e.addLayer(n.name,n.bit)}}},{key:"makeMaskInclude",value:function(e){for(var t,i=0,n=R(e);!(t=n()).done;)i|=t.value;return i}},{key:"makeMaskExclude",value:function(t){return~e.makeMaskInclude(t)}},{key:"addLayer",value:function(t,i){if(void 0!==i)if(i>19||i<0)console.warn("maximum layers reached.");else{var n=1<<i;e.Enum[t],_e(2104,t),e.Enum[t]=n,Ne(e.Enum,String(n),t),e.BitMask[t]=n,Ne(e.BitMask,String(n),t)}else console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var i=1<<t;delete e.Enum[e.Enum[i]],delete e.Enum[i],delete e.BitMask[e.BitMask[i]],delete e.BitMask[i]}}},{key:"nameToLayer",value:function(t){return void 0===t?(console.warn("name can't be undefined"),-1):O(e.Enum[t])}},{key:"layerToName",value:function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]}}]),e}());ep.Enum=wt($m),ep.BitMask=Rt(u({},$m)),B.Layers=ep;var tp,ip,np=function(){function e(t){n(this,e),this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}return s(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?ae(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}},{key:"applyOpacity",value:function(e){this._opacity=this._localOpacity*e}}],[{key:"markOpacityTree",value:function(){}}]),e}();Ga.Flags.Destroying,function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(tp||(tp=e("NodeSpace",{}))),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(ip||(ip=e("TransformBit",{}))),B.internal.TransformBit=ip;var rp,sp,ap,op,up,hp,lp,cp,_p,fp,dp,mp,pp,vp,yp,gp,Sp,Ap,Tp,Ep=e("MobilityMode",wt({Static:0,Stationary:1,Movable:2}));!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.MOBILITY_CHANGED="mobility-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed",e.COMPONENT_ADDED="component-added",e.COMPONENT_REMOVED="component-removed",e.LIGHT_PROBE_CHANGED="light-probe-changed",e.LIGHT_PROBE_BAKING_CHANGED="light-probe-baking-changed"}(rp||(rp=e("NodeEventType",{})));var bp=Ga.Flags.Destroying,Cp=Ga.Flags.DontDestroy,Rp=Ga.Flags.Deactivating,xp=new ke("Node");function wp(e){return e?"string"==typeof e?ft(e):e:(ue(3804),null)}var kp,Ip,Bp,Pp,Mp,Op,Dp,Lp,Np,Fp,Gp,Vp=new an,Up=new an,Hp=new vn,zp=new vn,Wp=new vn,Xp=new dn,jp=(new dn,new Cn),qp=new Cn,Yp=[],Kp=Symbol("ReserveContentsForAllSyncablePrefab"),Qp=0,Jp=(sp=Hs("cc.Node"),ap=Aa(an),op=Aa(Ep),kp=sp((Tp=Ap=function(e){h(r,e);var t=v(r);function r(e){var i;return n(this,r),(i=t.call(this,e))._parent=lp&&lp(),i._children=cp&&cp(),i._active=_p&&_p(),i._components=fp&&fp(),i._prefab=dp&&dp(),i._scene=null,i._activeInHierarchy=!1,i._id=xp.getNewId(),i._name=void 0,i._eventProcessor=new B.NodeEventProcessor(m(i)),i._eventMask=0,i._siblingIndex=0,i._originalSceneId="",i._uiProps=new np(m(i)),i._static=!1,i._lpos=mp&&mp(),i._lrot=pp&&pp(),i._lscale=vp&&vp(),i._mobility=yp&&yp(),i._layer=gp&&gp(),i._euler=Sp&&Sp(),i._transformFlags=ip.NONE,i._eulerDirty=!1,i._flagChangeVersion=0,i._hasChangedFlags=0,i._name=void 0!==e?e:"New Node",i._pos=new an,i._rot=new vn,i._scale=new an(1,1,1),i._mat=new Cn,i}return s(r,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&Cp)>0},set:function(e){e?this._objFlags|=Cp:this._objFlags&=~Cp}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(e=!!e,this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&B.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}},{key:"_updateScene",value:function(){null==this._parent?J("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene}},{key:"attr",value:function(e){Ze(this,e)}},{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t&&this.updateWorldTransform(),this._parent!==e){var i=this._parent,n=e;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,t),this.emit&&this.emit(rp.PARENT_CHANGED,i),i&&!(i._objFlags&bp)){var r=i._children.indexOf(this);i._children.splice(r,1),i._updateSiblingIndex(),i.emit&&i.emit(rp.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(rp.CHILD_ADDED,this)),this._onHierarchyChanged(i)}}},{key:"getChildByUuid",value:function(e){if(!e)return K("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return K("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){for(var t=e.split("/"),n=this,r=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},s=0;s<t.length;++s){var a=r(s);if("continue"!==a&&"object"===i(a))return a.v}return n}},{key:"addChild",value:function(e){e.setParent(this)}},{key:"insertChild",value:function(e,t){e.setParent(this),e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&Rp)ue(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e),this._eventProcessor.onUpdatingSiblingIndex())}}},{key:"walk",value:function(e,t){var i=1,n=null,s=null,a=0,o=r._stacks[r._stackId];o||(o=[],r._stacks.push(o)),r._stackId++,o.length=0,o[0]=this;for(var u=null,h=!1;i;)if(s=o[--i])if(!h&&e?e(s):h&&t&&t(s),o[i]=null,h){if(u===this._parent)break;if(h=!1,n)if(n[++a])o[i]=n[a],i++;else if(u&&(o[i]=u,i++,h=!0,u._parent?(a=(n=u._parent._children).indexOf(u),u=u._parent):(u=null,n=null),a<0))break}else s._children.length>0?(u=s,n=s._children,a=0,o[i]=n[a],i++):(o[i]=s,i++,h=!0);o.length=0,r._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){this._children.indexOf(e)>-1&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;t>=0;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=wp(e);return t?r._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=wp(e),i=[];return t&&r._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=wp(e);return t?r._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=wp(e),i=[];return t&&(r._findComponents(this,t,i),r._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=ft(e)))throw B._RF.peek()&&ue(3808,e),TypeError(_e(3807,e))}else{if(!e)throw TypeError(_e(3804));t=e}if("function"!=typeof t)throw TypeError(_e(3809));if(!tt(t,B.Component))throw TypeError(_e(3810));var i=t._requireComponent;if(i)if(Array.isArray(i))for(var n=0;n<i.length;n++){var r=i[n];this.getComponent(r)||this.addComponent(r)}else{var s=i;this.getComponent(s)||this.addComponent(s)}var a=new t;return a.node=this,this._components.push(a),this.emit(rp.COMPONENT_ADDED,a),this._activeInHierarchy&&B.director._nodeActivator.activateComp(a),a}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof tm?e:this.getComponent(e))&&t.destroy()}else ue(3813)}},{key:"on",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(e){case rp.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}},{key:"off",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this._eventProcessor.off(e,t,i,n);var r=this._eventProcessor.hasEventListener(e);if(!r)switch(e){case rp.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,i,n){this._eventProcessor.once(e,t,i,n)}},{key:"emit",value:function(e,t,i,n,r,s){this._eventProcessor.emit(e,t,i,n,r,s)}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(rp.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"destroy",value:function(){return!!g(l(r.prototype),"destroy",this).call(this)&&(this.active=!1,!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&bp)){var t=this._components.indexOf(e);-1!==t?(this._components.splice(t,1),this.emit(rp.COMPONENT_REMOVED,e)):e.node!==this&&ue(3815)}}else ue(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(rp.SIBLING_ORDER_CHANGED)}},{key:"_instantiate",value:function(e,t){return e||(e=B.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e}},{key:"_onHierarchyChangedBase",value:function(){var e=this._parent;!this._persistNode||e instanceof B.Scene||B.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&B.director._nodeActivator.activateNode(this,t)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=bp;var e=this._parent,t=!!e&&0!=(e._objFlags&bp);if(this._persistNode&&B.game.removePersistRootNode(this),!t&&e){this.emit(rp.PARENT_CHANGED,this);var i=e._children.indexOf(this);e._children.splice(i,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(rp.CHILD_REMOVED,this)}this.emit(rp.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var n=this._children,r=0;r<n.length;++r)n[r]._destroyImmediate();for(var s=this._components,a=0;a<s.length;++a)s[a]._destroyImmediate();return t}},{key:"_onPreDestroy",value:function(){return this._onPreDestroyBase()}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(vn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){an.set(this._euler,0,0,e),vn.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(ip.ROTATION),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Cn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(ip.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return an.transformQuat(new an,an.FORWARD,this.worldRotation)},set:function(e){var t=e.length();an.multiplyScalar(Vp,e,-1/t),vn.fromViewUp(Hp,Vp),this.setWorldRotation(Hp)}},{key:"up",get:function(){return an.transformQuat(new an,an.UP,this.worldRotation)}},{key:"right",get:function(){return an.transformQuat(new an,an.RIGHT,this.worldRotation)}},{key:"mobility",get:function(){return this._mobility},set:function(e){this._mobility=e,this.emit(rp.MOBILITY_CHANGED)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(rp.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._flagChangeVersion===Qp?this._hasChangedFlags:0},set:function(e){this._flagChangeVersion=Qp,this._hasChangedFlags=e}},{key:qa,value:function(e){e.writeThis()}},{key:"_onSetParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(r._setScene)),t){var i=this._parent;i?(i.updateWorldTransform(),Di(Cn.determinant(i._mat),0,Mi)?(ae(14300),this._transformFlags|=ip.TRS,this.updateWorldTransform()):(Cn.multiply(jp,Cn.invert(jp,i._mat),this._mat),Cn.toRTS(jp,this._lrot,this._lpos,this._lscale))):(an.copy(this._lpos,this._pos),vn.copy(this._lrot,this._rot),an.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(ip.TRS)}},{key:"_onHierarchyChanged",value:function(e){this.eventProcessor.reattach(),this._onHierarchyChangedBase(e)}},{key:"_onBatchCreated",value:function(e){this.hasChangedFlags=ip.TRS,this._transformFlags|=ip.TRS;for(var t=this._children.length,i=0;i<t;++i)this._children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"_onPostActivated",value:function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(ip.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)}},{key:"translate",value:function(e,t){var i=t||tp.LOCAL;if(i===tp.LOCAL)an.transformQuat(Vp,e,this._lrot),this._lpos.x+=Vp.x,this._lpos.y+=Vp.y,this._lpos.z+=Vp.z;else if(i===tp.WORLD)if(this._parent){vn.invert(Hp,this._parent.worldRotation),an.transformQuat(Vp,e,Hp);var n=this.worldScale;this._lpos.x+=Vp.x/n.x,this._lpos.y+=Vp.y/n.y,this._lpos.z+=Vp.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(ip.POSITION),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.POSITION)}},{key:"rotate",value:function(e,t){var i=t||tp.LOCAL;if(vn.normalize(Hp,e),i===tp.LOCAL)vn.multiply(this._lrot,this._lrot,Hp);else if(i===tp.WORLD){var n=this.worldRotation;vn.multiply(zp,Hp,n),vn.invert(Hp,n),vn.multiply(zp,Hp,zp),vn.multiply(this._lrot,this._lrot,zp)}this._eulerDirty=!0,this.invalidateChildren(ip.ROTATION),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.ROTATION)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(Vp),an.subtract(Vp,Vp,e),an.normalize(Vp,Vp),vn.fromViewUp(Hp,Vp,t),this.setWorldRotation(Hp)}},{key:"invalidateChildren",value:function(e){var t,i,n=0,r=0,s=0,a=0,o=e|ip.POSITION;for(Yp[0]=this;n>=0;){if(a=(t=Yp[n--]).hasChangedFlags,t.isValid&&(t._transformFlags&a&e)!==e)for(t._transformFlags|=e,t.hasChangedFlags=a|e,s=(i=t._children).length,r=0;r<s;r++)Yp[++n]=i[r];e=o}}},{key:"updateWorldTransform",value:function(){if(this._transformFlags){for(var e,t=this,i=0;t&&t._transformFlags;)Yp[i++]=t,t=t._parent;for(var n=0;i;){if(n|=(e=Yp[--i])._transformFlags,t){if(n&ip.POSITION&&(an.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&ip.RS){Cn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Cn.multiply(e._mat,t._mat,e._mat);var r=n&ip.ROTATION?e._rot:null;Cn.toRTS(e._mat,r,null,e._scale)}}else n&ip.POSITION&&(an.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&ip.RS&&(n&ip.ROTATION&&vn.copy(e._rot,e._lrot),n&ip.SCALE&&(an.copy(e._scale,e._lscale),Cn.fromRTS(e._mat,e._rot,e._pos,e._scale)));e._transformFlags=ip.NONE,t=e}}}},{key:"setPosition",value:function(e,t,i){void 0===t&&void 0===i?an.copy(this._lpos,e):void 0===i?an.set(this._lpos,e,t,this._lpos.z):an.set(this._lpos,e,t,i),this.invalidateChildren(ip.POSITION),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.POSITION)}},{key:"getPosition",value:function(e){return e?an.set(e,this._lpos.x,this._lpos.y,this._lpos.z):an.copy(new an,this._lpos)}},{key:"setRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?vn.copy(this._lrot,e):vn.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(ip.ROTATION),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.ROTATION)}},{key:"setRotationFromEuler",value:function(e,t,i){var n=void 0===i?this._euler.z:i;void 0===t?(an.copy(this._euler,e),vn.fromEuler(this._lrot,e.x,e.y,e.z)):(an.set(this._euler,e,t,n),vn.fromEuler(this._lrot,e,t,n)),this._eulerDirty=!1,this.invalidateChildren(ip.ROTATION),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.ROTATION)}},{key:"getRotation",value:function(e){return e?vn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):vn.copy(new vn,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t&&void 0===i?an.copy(this._lscale,e):void 0===i?an.set(this._lscale,e,t,this._lscale.z):an.set(this._lscale,e,t,i),this.invalidateChildren(ip.SCALE),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.SCALE)}},{key:"getScale",value:function(e){return e?an.set(e,this._lscale.x,this._lscale.y,this._lscale.z):an.copy(new an,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){an.copy(e,t);for(var i=this,n=0;i._parent;)Yp[n++]=i,i=i._parent;for(;n>=0;)an.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=Yp[--n];return e}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?an.copy(this._pos,e):an.set(this._pos,e,t,i);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),an.transformMat4(r,this._pos,Cn.invert(jp,n._mat))):an.copy(r,this._pos),this.invalidateChildren(ip.POSITION),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.POSITION)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?an.copy(e,this._pos):an.copy(new an,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?vn.copy(this._rot,e):vn.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),vn.multiply(this._lrot,vn.conjugate(this._lrot,this._parent._rot),this._rot)):vn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ip.ROTATION),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.ROTATION)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){vn.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),vn.multiply(this._lrot,vn.conjugate(this._lrot,this._parent._rot),this._rot)):vn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ip.ROTATION),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.ROTATION)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?vn.copy(e,this._rot):vn.copy(new vn,this._rot)}},{key:"setWorldScale",value:function(e,t,i){var n=this._parent;n&&this.updateWorldTransform(),void 0===t||void 0===i?an.copy(this._scale,e):an.set(this._scale,e,t,i),n?(Vp.x=this._scale.x/an.set(Up,this._mat.m00,this._mat.m01,this._mat.m02).length(),Vp.y=this._scale.y/an.set(Up,this._mat.m04,this._mat.m05,this._mat.m06).length(),Vp.z=this._scale.z/an.set(Up,this._mat.m08,this._mat.m09,this._mat.m10).length(),Cn.scale(jp,this._mat,Vp),Cn.multiply(qp,Cn.invert(qp,n._mat),jp),dn.fromQuat(Xp,vn.conjugate(Wp,this._lrot)),dn.multiplyMat4(Xp,Xp,qp),this._lscale.x=an.set(Vp,Xp.m00,Xp.m01,Xp.m02).length(),this._lscale.y=an.set(Vp,Xp.m03,Xp.m04,Xp.m05).length(),this._lscale.z=an.set(Vp,Xp.m06,Xp.m07,Xp.m08).length()):an.copy(this._lscale,this._scale),this.invalidateChildren(ip.SCALE),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,ip.SCALE)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?an.copy(e,this._scale):an.copy(new an,this._scale)}},{key:"getWorldMatrix",value:function(e){this.updateWorldTransform();var t=e||new Cn;return Cn.copy(t,this._mat)}},{key:"getWorldRS",value:function(e){this.updateWorldTransform();var t=e||new Cn;return Cn.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t}},{key:"getWorldRT",value:function(e){this.updateWorldTransform();var t=e||new Cn;return Cn.fromRT(t,this._rot,this._pos)}},{key:"setRTS",value:function(e,t,i){var n=0;e&&(n|=ip.ROTATION,void 0!==e.w?(vn.copy(this._lrot,e),this._eulerDirty=!0):(an.copy(this._euler,e),vn.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(an.copy(this._lpos,t),n|=ip.POSITION),i&&(an.copy(this._lscale,i),n|=ip.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(rp.TRANSFORM_CHANGED,n))}},{key:"isTransformDirty",value:function(){return this._transformFlags!==ip.NONE}},{key:"pauseSystemEvents",value:function(e){this._eventProcessor.setEnabled(!1,e)}},{key:"resumeSystemEvents",value:function(e){this._eventProcessor.setEnabled(!0,e)}},{key:"getPathInHierarchy",value:function(){for(var e=this.name,t=this.parent;t&&!(t instanceof B.Scene);)e="".concat(t.name,"/").concat(e),t=t.parent;return e}}],[{key:"_setScene",value:function(e){e._updateScene()}},{key:"_findComponent",value:function(e,t){var i=t,n=e._components;if(i._sealed)for(var r=0;r<n.length;++r){var s=n[r];if(s.constructor===t)return s}else for(var a=0;a<n.length;++a){var o=n[a];if(o instanceof t)return o}return null}},{key:"_findComponents",value:function(e,t,i){var n=t,r=e._components;if(n._sealed)for(var s=0;s<r.length;++s){var a=r[s];a.constructor===t&&i.push(a)}else for(var o=0;o<r.length;++o){var u=r[o];u instanceof t&&i.push(u)}}},{key:"_findChildComponent",value:function(e,t){for(var i=0;i<e.length;++i){var n=e[i],s=r._findComponent(n,t);if(s)return s;if(n._children.length>0&&(s=r._findChildComponent(n._children,t)))return s}return null}},{key:"_findChildComponents",value:function(e,t,i){for(var n=0;n<e.length;++n){var s=e[n];r._findComponents(s,t,i),s._children.length>0&&r._findChildComponents(s._children,t,i)}}},{key:"isNode",value:function(e){return e instanceof r&&(e.constructor===r||!(e instanceof B.Scene))}},{key:"resetHasChangedFlags",value:function(){Qp+=1}},{key:"clearNodeArray",value:function(){r.ClearFrame<r.ClearRound?r.ClearFrame++:(r.ClearFrame=0,Yp.length=0)}}]),r}(Ga),Ap.idGenerator=xp,Ap._stacks=[[]],Ap._stackId=0,Ap.EventType=rp,Ap.NodeSpace=tp,Ap.TransformDirtyBit=ip,Ap.TransformBit=ip,Ap.reserveContentsForAllSyncablePrefabTag=Kp,Ap.ClearFrame=0,Ap.ClearRound=1e3,x((hp=Tp).prototype,"_persistNode",[js],Object.getOwnPropertyDescriptor(hp.prototype,"_persistNode"),hp.prototype),lp=Ms(hp.prototype,"_parent",[Js],(function(){return null})),cp=Ms(hp.prototype,"_children",[Js],(function(){return[]})),_p=Ms(hp.prototype,"_active",[Js],(function(){return!0})),fp=Ms(hp.prototype,"_components",[Js],(function(){return[]})),dp=Ms(hp.prototype,"_prefab",[Js],(function(){return null})),mp=Ms(hp.prototype,"_lpos",[Js],(function(){return new an})),pp=Ms(hp.prototype,"_lrot",[Js],(function(){return new vn})),vp=Ms(hp.prototype,"_lscale",[Js],(function(){return new an(1,1,1)})),yp=Ms(hp.prototype,"_mobility",[Js],(function(){return Ep.Static})),gp=Ms(hp.prototype,"_layer",[Js],(function(){return ep.Enum.DEFAULT})),Sp=Ms(hp.prototype,"_euler",[Js],(function(){return new an})),x(hp.prototype,"eulerAngles",[ap],Object.getOwnPropertyDescriptor(hp.prototype,"eulerAngles"),hp.prototype),x(hp.prototype,"mobility",[op],Object.getOwnPropertyDescriptor(hp.prototype,"mobility"),hp.prototype),up=hp))||up,e({Node:kp,BaseNode:kp}),kp);B.Node=Jp,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(Fp||(Fp={})),function(e){e[e.NONE=0]="NONE",e[e.AUTO=1]="AUTO",e[e.BAKED_CONVOLUTION_MAP=2]="BAKED_CONVOLUTION_MAP"}(Gp||(Gp={}));var Zp=e("TextureCube",Hs("cc.TextureCube")((Np=Lp=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).isRGBE=Pp&&Pp(),e._mipmapAtlas=Mp&&Mp(),e._mipmapMode=Op&&Op(),e._mipmaps=Dp&&Dp(),e}return s(i,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0].front;this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,i){$p(e,(function(e,n){t._assignImage(e,i,n)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"mipmapAtlas",get:function(){return this._mipmapAtlas},set:function(e){var t=this;if(this._mipmapAtlas=e,this._mipmapAtlas){var i=this._mipmapAtlas.atlas.front;if(i.data){var n=this._mipmapAtlas.atlas,r=this._mipmapAtlas.layout,s=r[0],a=Object.assign(M.document.createElement("canvas"),{width:i.width,height:i.height}).getContext("2d");this.reset({width:s.width,height:s.height,format:i.format,mipmapLevel:r.length});for(var o=function(e){var s=r[e];$p(n,(function(e,n){a.clearRect(0,0,i.width,i.height);var r=e.data;a.drawImage(r,0,0);var o=a.getImageData(s.left,s.top,s.width,s.height),u=new bd({_data:o.data,_compressed:e.isCompressed,width:o.width,height:o.height,format:e.format});t._assignImage(u,s.level,n)}))},u=0;u<r.length;u++)o(u)}}else this.reset({width:0,height:0,mipmapLevel:0})}},{key:"isUsingOfflineMipmaps",value:function(){return this._mipmapMode===Gp.BAKED_CONVOLUTION_MAP}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}},{key:"onLoaded",value:function(){this._mipmapMode===Gp.BAKED_CONVOLUTION_MAP?this.mipmapAtlas=this._mipmapAtlas:this.mipmaps=this._mipmaps}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var i=void 0===e.baseLevel?0:e.baseLevel,n=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(i,n),this._tryReset()}},{key:"updateMipmaps",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1?arguments[1]:void 0;if(!(t>=this._mipmaps.length))for(var n=Math.min(void 0===i?this._mipmaps.length:i,this._mipmaps.length-t),r=function(i){var n=t+i;$p(e._mipmaps[n],(function(t,i){e._assignImage(t,n,i)}))},s=0;s<n;++s)r(s)}},{key:"destroy",value:function(){return this._mipmaps=[],this._mipmapAtlas=null,g(l(i.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[],this._mipmapAtlas=null}},{key:"_serialize",value:function(){return null}},{key:"_deserialize",value:function(e,t){var n=e;if(g(l(i.prototype),"_deserialize",this).call(this,n.base,t),this.isRGBE=n.rgbe,this._mipmapMode=n.mipmapMode,this._mipmapMode===Gp.BAKED_CONVOLUTION_MAP){var r=n.mipmapAtlas,s=n.mipmapLayout;this._mipmapAtlas={atlas:{},layout:s},this._mipmapAtlas.atlas={front:new bd,back:new bd,left:new bd,right:new bd,top:new bd,bottom:new bd};var a=mt(bd);t.result.push(this._mipmapAtlas.atlas,"front",r.front,a),t.result.push(this._mipmapAtlas.atlas,"back",r.back,a),t.result.push(this._mipmapAtlas.atlas,"left",r.left,a),t.result.push(this._mipmapAtlas.atlas,"right",r.right,a),t.result.push(this._mipmapAtlas.atlas,"top",r.top,a),t.result.push(this._mipmapAtlas.atlas,"bottom",r.bottom,a)}else{this._mipmaps=new Array(n.mipmaps.length);for(var o=0;o<n.mipmaps.length;++o){this._mipmaps[o]={front:new bd,back:new bd,left:new bd,right:new bd,top:new bd,bottom:new bd};var u=n.mipmaps[o],h=mt(bd);t.result.push(this._mipmaps[o],"front",u.front,h),t.result.push(this._mipmaps[o],"back",u.back,h),t.result.push(this._mipmaps[o],"left",u.left,h),t.result.push(this._mipmaps[o],"right",u.right,h),t.result.push(this._mipmaps[o],"top",u.top,h),t.result.push(this._mipmaps[o],"bottom",u.bottom,h)}}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=new Wc(zl.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t}},{key:"_getGfxTextureViewCreateInfo",value:function(e){var t=new Xc;return t.type=zl.CUBE,t.baseLayer=0,t.layerCount=6,Object.assign(t,e),t}},{key:"_uploadAtlas",value:function(){var e=this,t=this._mipmapAtlas.layout,i=t[0];this.reset({width:i.width,height:i.height,format:this._mipmapAtlas.atlas.front.format,mipmapLevel:t.length}),$p(this._mipmapAtlas.atlas,(function(i,n){var r=new Qm;r.image=i,r.reset({width:i.width,height:i.height,format:i.format}),r.uploadData(i.data);for(var s=0;s<t.length;s++){var a=t[s],o=new Uint8Array(4*a.width*a.height),u=new Mc;u.texOffset.x=a.left,u.texOffset.y=a.top,u.texExtent.width=a.width,u.texExtent.height=a.height,e._getGFXDevice().copyTextureToBuffers(r.getGFXTexture(),[o],[u]);var h=new bd({_data:o,_compressed:i.isCompressed,width:a.width,height:a.height,format:i.format});e._assignImage(h,a.level,n)}}))}},{key:"initDefault",value:function(e){g(l(i.prototype),"initDefault",this).call(this,e);var t=new bd;t.initDefault(),this.mipmaps=[{front:t,back:t,top:t,bottom:t,left:t,right:t}]}},{key:"validate",value:function(){if(this._mipmapMode===Gp.BAKED_CONVOLUTION_MAP){if(null===this.mipmapAtlas||0===this.mipmapAtlas.layout.length)return!1;var e=this.mipmapAtlas.atlas;return!!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))}}],[{key:"fromTexture2DArray",value:function(e,t){for(var n=[],r=e.length/6,s=0;s<r;s++){var a=6*s;n.push({front:e[a+Fp.front].image,back:e[a+Fp.back].image,left:e[a+Fp.left].image,right:e[a+Fp.right].image,top:e[a+Fp.top].image,bottom:e[a+Fp.bottom].image})}return(t=t||new i).mipmaps=n,t}}]),i}(Ym),Lp.FaceIndex=Fp,Pp=Ms((Bp=Np).prototype,"isRGBE",[Js],(function(){return!1})),Mp=Ms(Bp.prototype,"_mipmapAtlas",[Js],(function(){return null})),Op=Ms(Bp.prototype,"_mipmapMode",[Js],(function(){return Gp.NONE})),Dp=Ms(Bp.prototype,"_mipmaps",[Js],(function(){return[]})),Ip=Bp))||Ip);function $p(e,t){t(e.front,Fp.front),t(e.back,Fp.back),t(e.left,Fp.left),t(e.right,Fp.right),t(e.top,Fp.top),t(e.bottom,Fp.bottom)}B.TextureCube=Zp;var ev=function(){function e(){n(this,e),this._groundAlbedoHDR=new en(.2,.2,.2,1),this._skyColorHDR=new en(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new en(.2,.2,.2,1),this._skyColorLDR=new en(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}return s(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}},{key:"initialize",value:function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR}}]),e}();ev.SUN_ILLUM=65e3,ev.SKY_ILLUM=2e4,B.Ambient=ev;var tv,iv,nv="MainFlow",rv="ForwardFlow",sv="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(tv||(tv={})),B.RenderPassStage=tv,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(iv||(iv={}));var av,ov={bindings:[],layouts:{}},uv={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.UBO_CSM=3]="UBO_CSM",e[e.SAMPLER_SHADOWMAP=4]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=5]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_SHADOW_MAP=6]="SAMPLER_SPOT_SHADOW_MAP",e[e.SAMPLER_DIFFUSEMAP=7]="SAMPLER_DIFFUSEMAP",e[e.COUNT=8]="COUNT"}(av||(av={}));var hv,lv=av.SAMPLER_SHADOWMAP,cv=av.COUNT-lv;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.UBO_SH=6]="UBO_SH",e[e.SAMPLER_JOINTS=7]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=8]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=9]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=10]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=11]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=12]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=13]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=14]="STORAGE_REFLECTION",e[e.SAMPLER_REFLECTION_PROBE_CUBE=15]="SAMPLER_REFLECTION_PROBE_CUBE",e[e.SAMPLER_REFLECTION_PROBE_PLANAR=16]="SAMPLER_REFLECTION_PROBE_PLANAR",e[e.SAMPLER_REFLECTION_PROBE_DATA_MAP=17]="SAMPLER_REFLECTION_PROBE_DATA_MAP",e[e.COUNT=18]="COUNT"}(hv||(hv={}));var _v,fv=hv.SAMPLER_JOINTS,dv=hv.STORAGE_REFLECTION-fv,mv=hv.COUNT-fv-dv;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL",e[e.COUNT=3]="COUNT"}(_v||(_v={}));var pv=new Lc([lv,0,fv,0],[cv,0,dv,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,mv,0],[0,0,0,0],[0,2,1,3]),vv=function e(){n(this,e)};vv.SIZE=4*(vv.COUNT=4+(vv.DEBUG_VIEW_MODE_OFFSET=4+(vv.PROBE_INFO_OFFSET=4+(vv.NATIVE_SIZE_OFFSET=4+(vv.SCREEN_SIZE_OFFSET=4+(vv.TIME_OFFSET=0)))))),vv.NAME="CCGlobal",vv.BINDING=av.UBO_GLOBAL,vv.DESCRIPTOR=new d_(vv.BINDING,dc.UNIFORM_BUFFER,1,ic.ALL),vv.LAYOUT=new Yc(_v.GLOBAL,vv.BINDING,vv.NAME,[new qc("cc_time",Fl.FLOAT4,1),new qc("cc_screenSize",Fl.FLOAT4,1),new qc("cc_nativeSize",Fl.FLOAT4,1),new qc("cc_probeInfo",Fl.FLOAT4,1),new qc("cc_debug_view_mode",Fl.FLOAT4,1)],1),ov.layouts[vv.NAME]=vv.LAYOUT,ov.bindings[vv.BINDING]=vv.DESCRIPTOR;var yv=function e(){n(this,e)};yv.SIZE=4*(yv.COUNT=4+(yv.VIEW_PORT_OFFSET=4+(yv.NEAR_FAR_OFFSET=4+(yv.GLOBAL_FOG_ADD_OFFSET=4+(yv.GLOBAL_FOG_BASE_OFFSET=4+(yv.GLOBAL_FOG_COLOR_OFFSET=4+(yv.AMBIENT_GROUND_OFFSET=4+(yv.AMBIENT_SKY_OFFSET=4+(yv.MAIN_LIT_COLOR_OFFSET=4+(yv.MAIN_LIT_DIR_OFFSET=4+(yv.EXPOSURE_OFFSET=4+(yv.SCREEN_SCALE_OFFSET=4+(yv.SURFACE_TRANSFORM_OFFSET=4+(yv.CAMERA_POS_OFFSET=16+(yv.MAT_VIEW_PROJ_INV_OFFSET=16+(yv.MAT_VIEW_PROJ_OFFSET=16+(yv.MAT_PROJ_INV_OFFSET=16+(yv.MAT_PROJ_OFFSET=16+(yv.MAT_VIEW_INV_OFFSET=16+(yv.MAT_VIEW_OFFSET=0)))))))))))))))))))),yv.NAME="CCCamera",yv.BINDING=av.UBO_CAMERA,yv.DESCRIPTOR=new d_(yv.BINDING,dc.UNIFORM_BUFFER,1,ic.ALL),yv.LAYOUT=new Yc(_v.GLOBAL,yv.BINDING,yv.NAME,[new qc("cc_matView",Fl.MAT4,1),new qc("cc_matViewInv",Fl.MAT4,1),new qc("cc_matProj",Fl.MAT4,1),new qc("cc_matProjInv",Fl.MAT4,1),new qc("cc_matViewProj",Fl.MAT4,1),new qc("cc_matViewProjInv",Fl.MAT4,1),new qc("cc_cameraPos",Fl.FLOAT4,1),new qc("cc_surfaceTransform",Fl.FLOAT4,1),new qc("cc_screenScale",Fl.FLOAT4,1),new qc("cc_exposure",Fl.FLOAT4,1),new qc("cc_mainLitDir",Fl.FLOAT4,1),new qc("cc_mainLitColor",Fl.FLOAT4,1),new qc("cc_ambientSky",Fl.FLOAT4,1),new qc("cc_ambientGround",Fl.FLOAT4,1),new qc("cc_fogColor",Fl.FLOAT4,1),new qc("cc_fogBase",Fl.FLOAT4,1),new qc("cc_fogAdd",Fl.FLOAT4,1),new qc("cc_nearFar",Fl.FLOAT4,1),new qc("cc_viewPort",Fl.FLOAT4,1)],1),ov.layouts[yv.NAME]=yv.LAYOUT,ov.bindings[yv.BINDING]=yv.DESCRIPTOR;var gv=function e(){n(this,e)};gv.SIZE=4*(gv.COUNT=4+(gv.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(gv.SHADOW_COLOR_OFFSET=4+(gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(gv.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(gv.SHADOW_PROJ_INFO_OFFSET=4+(gv.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(gv.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(gv.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(gv.MAT_LIGHT_VIEW_OFFSET=0))))))))))),gv.NAME="CCShadow",gv.BINDING=av.UBO_SHADOW,gv.DESCRIPTOR=new d_(gv.BINDING,dc.UNIFORM_BUFFER,1,ic.ALL),gv.LAYOUT=new Yc(_v.GLOBAL,gv.BINDING,gv.NAME,[new qc("cc_matLightView",Fl.MAT4,1),new qc("cc_matLightViewProj",Fl.MAT4,1),new qc("cc_shadowInvProjDepthInfo",Fl.FLOAT4,1),new qc("cc_shadowProjDepthInfo",Fl.FLOAT4,1),new qc("cc_shadowProjInfo",Fl.FLOAT4,1),new qc("cc_shadowNFLSInfo",Fl.FLOAT4,1),new qc("cc_shadowWHPBInfo",Fl.FLOAT4,1),new qc("cc_shadowLPNNInfo",Fl.FLOAT4,1),new qc("cc_shadowColor",Fl.FLOAT4,1),new qc("cc_planarNDInfo",Fl.FLOAT4,1)],1),ov.layouts[gv.NAME]=gv.LAYOUT,ov.bindings[gv.BINDING]=gv.DESCRIPTOR;var Sv=function e(){n(this,e)};Sv.CSM_LEVEL_COUNT=4,Sv.SIZE=4*(Sv.COUNT=4+(Sv.CSM_SPLITS_INFO_OFFSET=(Sv.CSM_PROJ_INFO_OFFSET=(Sv.CSM_PROJ_DEPTH_INFO_OFFSET=(Sv.MAT_CSM_VIEW_PROJ_OFFSET=(Sv.CSM_ATLAS_OFFSET=(Sv.CSM_VIEW_DIR_2_OFFSET=(Sv.CSM_VIEW_DIR_1_OFFSET=(Sv.CSM_VIEW_DIR_0_OFFSET=0)+4*Sv.CSM_LEVEL_COUNT)+4*Sv.CSM_LEVEL_COUNT)+4*Sv.CSM_LEVEL_COUNT)+4*Sv.CSM_LEVEL_COUNT)+16*Sv.CSM_LEVEL_COUNT)+4*Sv.CSM_LEVEL_COUNT)+4*Sv.CSM_LEVEL_COUNT)),Sv.NAME="CCCSM",Sv.BINDING=av.UBO_CSM,Sv.DESCRIPTOR=new d_(Sv.BINDING,dc.UNIFORM_BUFFER,1,ic.FRAGMENT),Sv.LAYOUT=new Yc(_v.GLOBAL,Sv.BINDING,Sv.NAME,[new qc("cc_csmViewDir0",Fl.FLOAT4,Sv.CSM_LEVEL_COUNT),new qc("cc_csmViewDir1",Fl.FLOAT4,Sv.CSM_LEVEL_COUNT),new qc("cc_csmViewDir2",Fl.FLOAT4,Sv.CSM_LEVEL_COUNT),new qc("cc_csmAtlas",Fl.FLOAT4,Sv.CSM_LEVEL_COUNT),new qc("cc_matCSMViewProj",Fl.MAT4,Sv.CSM_LEVEL_COUNT),new qc("cc_csmProjDepthInfo",Fl.FLOAT4,Sv.CSM_LEVEL_COUNT),new qc("cc_csmProjInfo",Fl.FLOAT4,Sv.CSM_LEVEL_COUNT),new qc("cc_csmSplitsInfo",Fl.FLOAT4,1)],1),ov.layouts[Sv.NAME]=Sv.LAYOUT,ov.bindings[Sv.BINDING]=Sv.DESCRIPTOR;var Av=av.SAMPLER_SHADOWMAP,Tv=new d_(Av,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),Ev=new Kc(_v.GLOBAL,Av,"cc_shadowMap",Fl.SAMPLER2D,1);ov.layouts.cc_shadowMap=Ev,ov.bindings[Av]=Tv;var bv=av.SAMPLER_ENVIRONMENT,Cv=new d_(bv,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),Rv=new Kc(_v.GLOBAL,bv,"cc_environment",Fl.SAMPLER_CUBE,1);ov.layouts.cc_environment=Rv,ov.bindings[bv]=Cv;var xv=av.SAMPLER_DIFFUSEMAP,wv=new d_(xv,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),kv=new Kc(_v.GLOBAL,xv,"cc_diffuseMap",Fl.SAMPLER_CUBE,1);ov.layouts.cc_diffuseMap=kv,ov.bindings[xv]=wv;var Iv=av.SAMPLER_SPOT_SHADOW_MAP,Bv=new d_(Iv,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),Pv=new Kc(_v.GLOBAL,Iv,"cc_spotShadowMap",Fl.SAMPLER2D,1);ov.layouts.cc_spotShadowMap=Pv,ov.bindings[Iv]=Bv;var Mv=function e(){n(this,e)};Mv.SIZE=4*(Mv.COUNT=4+(Mv.REFLECTION_PROBE_DATA2=4+(Mv.REFLECTION_PROBE_DATA1=4+(Mv.LOCAL_SHADOW_BIAS=4+(Mv.LIGHTINGMAP_UVPARAM=16+(Mv.MAT_WORLD_IT_OFFSET=16+(Mv.MAT_WORLD_OFFSET=0))))))),Mv.NAME="CCLocal",Mv.BINDING=hv.UBO_LOCAL,Mv.DESCRIPTOR=new d_(Mv.BINDING,dc.UNIFORM_BUFFER,1,ic.VERTEX|ic.COMPUTE),Mv.LAYOUT=new Yc(_v.LOCAL,Mv.BINDING,Mv.NAME,[new qc("cc_matWorld",Fl.MAT4,1),new qc("cc_matWorldIT",Fl.MAT4,1),new qc("cc_lightingMapUVParam",Fl.FLOAT4,1),new qc("cc_localShadowBias",Fl.FLOAT4,1),new qc("cc_reflectionProbeData1",Fl.FLOAT4,1),new qc("cc_reflectionProbeData2",Fl.FLOAT4,1)],1),uv.layouts[Mv.NAME]=Mv.LAYOUT,uv.bindings[Mv.BINDING]=Mv.DESCRIPTOR;var Ov=function e(){n(this,e)};Ov.SIZE=4*(Ov.COUNT=4+(Ov.WORLD_BOUND_HALF_EXTENTS=4+(Ov.WORLD_BOUND_CENTER=0))),Ov.NAME="CCWorldBound",Ov.BINDING=hv.UBO_LOCAL,Ov.DESCRIPTOR=new d_(Ov.BINDING,dc.UNIFORM_BUFFER,1,ic.VERTEX|ic.COMPUTE),Ov.LAYOUT=new Yc(_v.LOCAL,Ov.BINDING,Ov.NAME,[new qc("cc_worldBoundCenter",Fl.FLOAT4,1),new qc("cc_worldBoundHalfExtents",Fl.FLOAT4,1)],1),uv.layouts[Ov.NAME]=Ov.LAYOUT,uv.bindings[Ov.BINDING]=Ov.DESCRIPTOR;var Dv="a_matWorld0",Lv="a_sh_linear_const_r",Nv=function e(){n(this,e)};Nv.BATCHING_COUNT=10,Nv.MAT_WORLDS_OFFSET=0,Nv.SIZE=4*(Nv.COUNT=16*Nv.BATCHING_COUNT),Nv.NAME="CCLocalBatched",Nv.BINDING=hv.UBO_LOCAL,Nv.DESCRIPTOR=new d_(Nv.BINDING,dc.UNIFORM_BUFFER,1,ic.VERTEX|ic.COMPUTE),Nv.LAYOUT=new Yc(_v.LOCAL,Nv.BINDING,Nv.NAME,[new qc("cc_matWorlds",Fl.MAT4,Nv.BATCHING_COUNT)],1),uv.layouts[Nv.NAME]=Nv.LAYOUT,uv.bindings[Nv.BINDING]=Nv.DESCRIPTOR;var Fv=function e(){n(this,e)};Fv.LIGHTS_PER_PASS=1,Fv.SIZE=4*(Fv.COUNT=(Fv.LIGHT_DIR_OFFSET=(Fv.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Fv.LIGHT_COLOR_OFFSET=(Fv.LIGHT_POS_OFFSET=0)+4*Fv.LIGHTS_PER_PASS)+4*Fv.LIGHTS_PER_PASS)+4*Fv.LIGHTS_PER_PASS)+4*Fv.LIGHTS_PER_PASS),Fv.NAME="CCForwardLight",Fv.BINDING=hv.UBO_FORWARD_LIGHTS,Fv.DESCRIPTOR=new d_(Fv.BINDING,dc.DYNAMIC_UNIFORM_BUFFER,1,ic.FRAGMENT),Fv.LAYOUT=new Yc(_v.LOCAL,Fv.BINDING,Fv.NAME,[new qc("cc_lightPos",Fl.FLOAT4,Fv.LIGHTS_PER_PASS),new qc("cc_lightColor",Fl.FLOAT4,Fv.LIGHTS_PER_PASS),new qc("cc_lightSizeRangeAngle",Fl.FLOAT4,Fv.LIGHTS_PER_PASS),new qc("cc_lightDir",Fl.FLOAT4,Fv.LIGHTS_PER_PASS)],1),uv.layouts[Fv.NAME]=Fv.LAYOUT,uv.bindings[Fv.BINDING]=Fv.DESCRIPTOR;var Gv=function e(){n(this,e)};Gv.LIGHTS_PER_PASS=10;var Vv=function e(){n(this,e)};Vv.SIZE=4*(Vv.COUNT=4+(Vv.JOINTS_TEXTURE_INFO_OFFSET=0)),Vv.NAME="CCSkinningTexture",Vv.BINDING=hv.UBO_SKINNING_TEXTURE,Vv.DESCRIPTOR=new d_(Vv.BINDING,dc.UNIFORM_BUFFER,1,ic.VERTEX),Vv.LAYOUT=new Yc(_v.LOCAL,Vv.BINDING,Vv.NAME,[new qc("cc_jointTextureInfo",Fl.FLOAT4,1)],1),uv.layouts[Vv.NAME]=Vv.LAYOUT,uv.bindings[Vv.BINDING]=Vv.DESCRIPTOR;var Uv=function e(){n(this,e)};Uv.SIZE=4*(Uv.COUNT=4+(Uv.JOINTS_ANIM_INFO_OFFSET=0)),Uv.NAME="CCSkinningAnimation",Uv.BINDING=hv.UBO_SKINNING_ANIMATION,Uv.DESCRIPTOR=new d_(Uv.BINDING,dc.UNIFORM_BUFFER,1,ic.VERTEX),Uv.LAYOUT=new Yc(_v.LOCAL,Uv.BINDING,Uv.NAME,[new qc("cc_jointAnimInfo",Fl.FLOAT4,1)],1),uv.layouts[Uv.NAME]=Uv.LAYOUT,uv.bindings[Uv.BINDING]=Uv.DESCRIPTOR;var Hv=function(){function e(){n(this,e)}return s(e,null,[{key:"JOINT_UNIFORM_CAPACITY",get:function(){return e._jointUniformCapacity}},{key:"COUNT",get:function(){return e._count}},{key:"SIZE",get:function(){return e._size}},{key:"initLayout",value:function(t){e._jointUniformCapacity=t,e._count=12*t,e._size=4*e._count,e.LAYOUT.members[0].count=3*t}}]),e}();function zv(e){Hv.initLayout(e),uv.layouts[Hv.NAME]=Hv.LAYOUT,uv.bindings[Hv.BINDING]=Hv.DESCRIPTOR}Hv._jointUniformCapacity=0,Hv._count=0,Hv._size=0,Hv.NAME="CCSkinning",Hv.BINDING=hv.UBO_SKINNING_TEXTURE,Hv.DESCRIPTOR=new d_(Hv.BINDING,dc.UNIFORM_BUFFER,1,ic.VERTEX),Hv.LAYOUT=new Yc(_v.LOCAL,Hv.BINDING,Hv.NAME,[new qc("cc_joints",Fl.FLOAT4,1)],1);var Wv=function e(){n(this,e)};Wv.MAX_MORPH_TARGET_COUNT=60,Wv.OFFSET_OF_WEIGHTS=0,Wv.OFFSET_OF_VERTICES_COUNT=4+(Wv.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(Wv.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Wv.MAX_MORPH_TARGET_COUNT)),Wv.COUNT_BASE_4_BYTES=4*Math.ceil(Wv.MAX_MORPH_TARGET_COUNT/4)+4,Wv.SIZE=4*Wv.COUNT_BASE_4_BYTES,Wv.NAME="CCMorph",Wv.BINDING=hv.UBO_MORPH,Wv.DESCRIPTOR=new d_(Wv.BINDING,dc.UNIFORM_BUFFER,1,ic.VERTEX),Wv.LAYOUT=new Yc(_v.LOCAL,Wv.BINDING,Wv.NAME,[new qc("cc_displacementWeights",Fl.FLOAT4,Wv.MAX_MORPH_TARGET_COUNT/4),new qc("cc_displacementTextureInfo",Fl.FLOAT4,1)],1),uv.layouts[Wv.NAME]=Wv.LAYOUT,uv.bindings[Wv.BINDING]=Wv.DESCRIPTOR;var Xv=function e(){n(this,e)};Xv.NAME="CCUILocal",Xv.BINDING=hv.UBO_UI_LOCAL,Xv.DESCRIPTOR=new d_(Xv.BINDING,dc.DYNAMIC_UNIFORM_BUFFER,1,ic.VERTEX),Xv.LAYOUT=new Yc(_v.LOCAL,Xv.BINDING,Xv.NAME,[new qc("cc_local_data",Fl.FLOAT4,1)],1),uv.layouts[Xv.NAME]=Xv.LAYOUT,uv.bindings[Xv.BINDING]=Xv.DESCRIPTOR;var jv=function e(){n(this,e)};jv.SIZE=4*(jv.COUNT=4+(jv.SH_QUADRATIC_A_OFFSET=4+(jv.SH_QUADRATIC_B_OFFSET=4+(jv.SH_QUADRATIC_G_OFFSET=4+(jv.SH_QUADRATIC_R_OFFSET=4+(jv.SH_LINEAR_CONST_B_OFFSET=4+(jv.SH_LINEAR_CONST_G_OFFSET=4+(jv.SH_LINEAR_CONST_R_OFFSET=0)))))))),jv.NAME="CCSH",jv.BINDING=hv.UBO_SH,jv.DESCRIPTOR=new d_(jv.BINDING,dc.UNIFORM_BUFFER,1,ic.FRAGMENT),jv.LAYOUT=new Yc(_v.LOCAL,jv.BINDING,jv.NAME,[new qc("cc_sh_linear_const_r",Fl.FLOAT4,1),new qc("cc_sh_linear_const_g",Fl.FLOAT4,1),new qc("cc_sh_linear_const_b",Fl.FLOAT4,1),new qc("cc_sh_quadratic_r",Fl.FLOAT4,1),new qc("cc_sh_quadratic_g",Fl.FLOAT4,1),new qc("cc_sh_quadratic_b",Fl.FLOAT4,1),new qc("cc_sh_quadratic_a",Fl.FLOAT4,1)],1),uv.layouts[jv.NAME]=jv.LAYOUT,uv.bindings[jv.BINDING]=jv.DESCRIPTOR;var qv=hv.SAMPLER_JOINTS,Yv=new d_(qv,dc.SAMPLER_TEXTURE,1,ic.VERTEX),Kv=new Kc(_v.LOCAL,qv,"cc_jointTexture",Fl.SAMPLER2D,1);uv.layouts.cc_jointTexture=Kv,uv.bindings[qv]=Yv;var Qv=hv.SAMPLER_JOINTS,Jv=new d_(Qv,dc.SAMPLER_TEXTURE,1,ic.VERTEX),Zv=new Kc(_v.LOCAL,Qv,"cc_realtimeJoint",Fl.SAMPLER2D,1);uv.layouts.cc_realtimeJoint=Zv,uv.bindings[Qv]=Jv;var $v=hv.SAMPLER_MORPH_POSITION,ey=new d_($v,dc.SAMPLER_TEXTURE,1,ic.VERTEX),ty=new Kc(_v.LOCAL,$v,"cc_PositionDisplacements",Fl.SAMPLER2D,1);uv.layouts.cc_PositionDisplacements=ty,uv.bindings[$v]=ey;var iy=hv.SAMPLER_MORPH_NORMAL,ny=new d_(iy,dc.SAMPLER_TEXTURE,1,ic.VERTEX),ry=new Kc(_v.LOCAL,iy,"cc_NormalDisplacements",Fl.SAMPLER2D,1);uv.layouts.cc_NormalDisplacements=ry,uv.bindings[iy]=ny;var sy=hv.SAMPLER_MORPH_TANGENT,ay=new d_(sy,dc.SAMPLER_TEXTURE,1,ic.VERTEX),oy=new Kc(_v.LOCAL,sy,"cc_TangentDisplacements",Fl.SAMPLER2D,1);uv.layouts.cc_TangentDisplacements=oy,uv.bindings[sy]=ay;var uy=hv.SAMPLER_LIGHTMAP,hy=new d_(uy,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),ly=new Kc(_v.LOCAL,uy,"cc_lightingMap",Fl.SAMPLER2D,1);uv.layouts.cc_lightingMap=ly,uv.bindings[uy]=hy;var cy=hv.SAMPLER_SPRITE,_y=new d_(cy,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),fy=new Kc(_v.LOCAL,cy,"cc_spriteTexture",Fl.SAMPLER2D,1);uv.layouts.cc_spriteTexture=fy,uv.bindings[cy]=_y;var dy=hv.SAMPLER_REFLECTION,my=new d_(dy,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),py=new Kc(_v.LOCAL,dy,"cc_reflectionTexture",Fl.SAMPLER2D,1);uv.layouts.cc_reflectionTexture=py,uv.bindings[dy]=my;var vy=hv.STORAGE_REFLECTION,yy=new d_(vy,dc.STORAGE_IMAGE,1,ic.COMPUTE),gy=new Zc(_v.LOCAL,vy,"cc_reflectionStorage",Fl.IMAGE2D,1);uv.layouts.cc_reflectionStorage=gy,uv.bindings[vy]=yy;var Sy=hv.SAMPLER_REFLECTION_PROBE_CUBE,Ay=new d_(Sy,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),Ty=new Kc(_v.LOCAL,Sy,"cc_reflectionProbeCubemap",Fl.SAMPLER_CUBE,1);uv.layouts.cc_reflectionProbeCubemap=Ty,uv.bindings[Sy]=Ay;var Ey=hv.SAMPLER_REFLECTION_PROBE_PLANAR,by=new d_(Ey,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),Cy=new Kc(_v.LOCAL,Ey,"cc_reflectionProbePlanarMap",Fl.SAMPLER2D,1);uv.layouts.cc_reflectionProbePlanarMap=Cy,uv.bindings[Ey]=by;var Ry=hv.SAMPLER_REFLECTION_PROBE_DATA_MAP,xy=new d_(Ry,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT),wy=new Kc(_v.LOCAL,Ry,"cc_reflectionProbeDataMap",Fl.SAMPLER2D,1);uv.layouts.cc_reflectionProbeDataMap=wy,uv.bindings[Ry]=xy;var ky,Iy,By,Py=ep.makeMaskExclude([ep.BitMask.UI_2D,ep.BitMask.GIZMOS,ep.BitMask.EDITOR,ep.BitMask.SCENE_GIZMO,ep.BitMask.PROFILER]),My=ep.makeMaskExclude([ep.BitMask.UI_2D,ep.BitMask.PROFILER]),Oy=ep.Enum.ALL;function Dy(e){return(e.getFormatFeatures(Ll.R32F)&(jl.RENDER_TARGET|jl.SAMPLED_TEXTURE))==(jl.RENDER_TARGET|jl.SAMPLED_TEXTURE)&&!(e.gfxAPI===Ml.WEBGL)}function Ly(){return!(!B.rendering||!B.rendering.enableEffectImport)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:nv,PIPELINE_FLOW_FORWARD:rv,PIPELINE_FLOW_SHADOW:sv,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return tv},get RenderPriority(){return iv},globalDescriptorSetLayout:ov,localDescriptorSetLayout:uv,get PipelineGlobalBindings(){return av},get ModelLocalBindings(){return hv},get SetIndex(){return _v},bindingMappingInfo:pv,UBOGlobal:vv,UBOCamera:yv,UBOShadow:gv,UBOCSM:Sv,UNIFORM_SHADOWMAP_BINDING:Av,UNIFORM_ENVIRONMENT_BINDING:bv,UNIFORM_DIFFUSEMAP_BINDING:xv,UNIFORM_SPOT_SHADOW_MAP_TEXTURE_BINDING:Iv,UBOLocal:Mv,UBOWorldBound:Ov,INST_MAT_WORLD:Dv,INST_SH:Lv,UBOLocalBatched:Nv,UBOForwardLight:Fv,UBODeferredLight:Gv,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Vv,UBOSkinningAnimation:Uv,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:Hv,localDescriptorSetLayout_ResizeMaxJoints:zv,UBOMorph:Wv,UBOUILocal:Xv,UBOSH:jv,UNIFORM_JOINT_TEXTURE_BINDING:qv,UNIFORM_REALTIME_JOINT_TEXTURE_BINDING:Qv,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:$v,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:iy,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:sy,UNIFORM_LIGHTMAP_TEXTURE_BINDING:uy,UNIFORM_SPRITE_TEXTURE_BINDING:cy,UNIFORM_REFLECTION_TEXTURE_BINDING:dy,UNIFORM_REFLECTION_STORAGE_BINDING:vy,UNIFORM_REFLECTION_PROBE_CUBEMAP_BINDING:Sy,UNIFORM_REFLECTION_PROBE_TEXTURE_BINDING:Ey,UNIFORM_REFLECTION_PROBE_DATA_MAP_BINDING:Ry,CAMERA_DEFAULT_MASK:Py,CAMERA_EDITOR_MASK:My,MODEL_ALWAYS_MASK:Oy,supportsR16HalfFloatTexture:function(e){return(e.getFormatFeatures(Ll.R16F)&(jl.RENDER_TARGET|jl.SAMPLED_TEXTURE))==(jl.RENDER_TARGET|jl.SAMPLED_TEXTURE)},supportsR32FloatTexture:Dy,isEnableEffect:Ly}));var Ny=4227858432,Fy=66060288,Gy=1044480,Vy=4095,Uy=function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return t<<26&Ny|e<<20&Fy|i<<12&Gy|n&Vy},Hy=function(e){return(e&Ny)>>>26},zy=function(e){return(e&Fy)>>>20},Wy=function(e){return(e&Gy)>>>12},Xy=function(e){return e&Vy},jy=function(e,t){return 67108863&e|t<<26&Ny},qy=(a(ky={},Fl.UNKNOWN,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ae(12010,i)})),a(ky,Fl.INT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]})),a(ky,Fl.INT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return In.fromArray(t,e,i)})),a(ky,Fl.INT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return an.fromArray(t,e,i)})),a(ky,Fl.INT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return en.fromArray(t,e,i)})),a(ky,Fl.FLOAT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]})),a(ky,Fl.FLOAT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return In.fromArray(t,e,i)})),a(ky,Fl.FLOAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return an.fromArray(t,e,i)})),a(ky,Fl.FLOAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return en.fromArray(t,e,i)})),a(ky,Fl.MAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return dn.fromArray(t,e,i)})),a(ky,Fl.MAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Cn.fromArray(t,e,i)})),ky),Yy=(a(Iy={},Fl.UNKNOWN,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ae(12010,i)})),a(Iy,Fl.INT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]=t})),a(Iy,Fl.INT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return In.toArray(e,t,i)})),a(Iy,Fl.INT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return an.toArray(e,t,i)})),a(Iy,Fl.INT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return en.toArray(e,t,i)})),a(Iy,Fl.FLOAT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]=t})),a(Iy,Fl.FLOAT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return In.toArray(e,t,i)})),a(Iy,Fl.FLOAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return an.toArray(e,t,i)})),a(Iy,Fl.FLOAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return en.toArray(e,t,i)})),a(Iy,Fl.MAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return dn.toArray(e,t,i)})),a(Iy,Fl.MAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Cn.toArray(e,t,i)})),Iy),Ky=(a(By={},Fl.INT,(function(e){return"number"==typeof e})),a(By,Fl.FLOAT,(function(e){return"number"==typeof e})),a(By,Fl.INT2,(function(e){return!!(e instanceof In)})),a(By,Fl.FLOAT2,(function(e){return!!(e instanceof In)})),a(By,Fl.INT3,(function(e){return!!(e instanceof an)})),a(By,Fl.FLOAT3,(function(e){return!!(e instanceof an)})),a(By,Fl.INT4,(function(e){return!!(e instanceof en)})),a(By,Fl.FLOAT4,(function(e){return!!(e instanceof en||e instanceof cn||e instanceof vn)})),a(By,Fl.MAT3,(function(e){return!!(e instanceof dn)})),a(By,Fl.MAT4,(function(e){return!!(e instanceof Cn)})),By),Qy=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Jy(e){switch(e){case Fl.BOOL:case Fl.INT:case Fl.UINT:case Fl.FLOAT:return Qy[0];case Fl.BOOL2:case Fl.INT2:case Fl.UINT2:case Fl.FLOAT2:return Qy[1];case Fl.BOOL4:case Fl.INT4:case Fl.UINT4:case Fl.FLOAT4:return Qy[2];case Fl.MAT4:return Qy[3];case Fl.SAMPLER2D:return"default-texture";case Fl.SAMPLER_CUBE:return"default-cube-texture";case Fl.SAMPLER2D_ARRAY:return"default-array-texture";case Fl.SAMPLER3D:return"default-3d-texture"}return Qy[0]}function Zy(e){switch(e){case Fl.SAMPLER2D:return"-texture";case Fl.SAMPLER_CUBE:return"-cube-texture";case Fl.SAMPLER2D_ARRAY:return"-array-texture";case Fl.SAMPLER3D:return"-3d-texture";default:return"-unknown"}}function $y(e,t){for(var i=Object.entries(t),n=!1,r=0;r<i.length;r++)e[i[r][0]]!==i[r][1]&&(e[i[r][0]]=i[r][1],n=!0);return n}function eg(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '".concat(e.type,"'")),"-1"}}function tg(e,t){for(var i=0;i<e.length;i++){var n=e[i];if("!"===n[0]){if(t[n.slice(1)])return!1}else if(!t[n])return!1}return!0}var ig=new Map;function ng(e,t){if(t.count)return e+D_(t.type)*t.count;var i=ig.get(t.name);return void 0!==i?e+D_(t.type)*i:(console.error("uniform '".concat(t.name,"' must have a count")),e)}function rg(e){return Math.ceil(Math.log2(Math.max(e,2)))}ig.set("cc_joints",Hv.LAYOUT.members[0].count),ig.set("cc_lightPos",Fv.LIGHTS_PER_PASS),ig.set("cc_lightColor",Fv.LIGHTS_PER_PASS),ig.set("cc_lightSizeRangeAngle",Fv.LIGHTS_PER_PASS),ig.set("cc_lightDir",Fv.LIGHTS_PER_PASS);var sg=new m_;function ag(e,t,i,n,r){for(var s=e.builtins[n],a=[],o=function(e){var t=s.blocks[e],n=i.layouts[t.name],o=n&&i.bindings.find((function(e){return e.binding===n.binding}));if(!(n&&o&&o.descriptorType&w_))return console.warn("builtin UBO '".concat(t.name,"' not available!")),"continue";a.push(n),r&&!r.includes(o)&&r.push(o)},u=0;u<s.blocks.length;u++)o(u);Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var h=[],l=function(e){var t=s.samplerTextures[e],n=i.layouts[t.name],a=n&&i.bindings.find((function(e){return e.binding===n.binding}));if(!(n&&a&&a.descriptorType&k_))return console.warn("builtin samplerTexture '".concat(t.name,"' not available!")),"continue";h.push(n),r&&!r.includes(a)&&r.push(a)},c=0;c<s.samplerTextures.length;c++)l(c);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,h),r&&r.sort((function(e,t){return e.binding-t.binding}))}function og(e,t,i,n,r){for(var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new Set,a="layout\\(location = ([^\\)]+)\\)\\s+".concat(n,".*?\\s(\\w+)[;,\\)]"),o=new RegExp(a,"g"),u=e,h=o.exec(e),l=function(){var a=h[2];if(!r.has(a)){var l=t.attributes.find((function(e){return e.name===a})),c=!0,_=0;if("in"===n){var f=e.slice(0,h.index);c=!(null==l||!l.defines.every((function(e){var t=e.startsWith("!"),n=t?e.slice(1):e,r=i.find((function(e){return e.name===n})),s=!!r;if(r&&(s=!("0"===r.value||"false"===r.value||"FALSE"===r.value)),s=t?!s:s){var a="[\\n|\\s]+#(?:if|elif)(.*?".concat(n,".*?(?:(?!#if|#elif).)*)[\\n|\\s]+$"),o=new RegExp(a,"g").exec(f);if(o){var u=o[1].split("||").some((function(e){return e.split("&&").every((function(e){var t=!0;if(e.includes("==")){var i=e.split("==");i[0].replaceAll(" ","")===n&&(t=i[1].replaceAll(" ","")===r.value)}else if(e.includes("!=")){var s=e.split("!=");s[0].replaceAll(" ","")===n&&(t=s[1].replaceAll(" ","")!==r.value)}return t}))}));s=s&&u}}return s})))}if(c){for(;s.has(_);)_++;s.add(_),l&&(l.location=_),r.set(a,_)}var d=h[0].replace(h[1],"".concat(_));u=u.replace(h[0],d)}h=o.exec(e)};h;)l();return u}function ug(e){switch(e.gfxAPI){case Ml.GLES2:case Ml.WEBGL:return"glsl1";case Ml.GLES3:case Ml.WEBGL2:return"glsl3";default:return"glsl4"}}var hg,lg,cg,_g,fg,dg,mg,pg,vg=new(function(){function e(){n(this,e),this._templates={},this._cache={},this._templateInfos={}}return s(e,[{key:"register",value:function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var i=0;i<e.techniques.length;i++)for(var n=e.techniques[i],r=0;r<n.passes.length;r++){var s=n.passes[r];void 0!==s.propertyIndex&&void 0===s.properties&&(s.properties=n.passes[s.propertyIndex].properties)}}},{key:"define",value:function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;var i=u({},e);if(function(e){for(var t=0,i=function(i){var n=e.defines[i],r=1;if("number"===n.type){var s=n.range;r=rg(s[1]-s[0]+1),n._map=function(e){return e-s[0]}}else"string"===n.type?(r=rg(n.options.length),n._map=function(e){return Math.max(0,n.options.findIndex((function(t){return t===e})))}):"boolean"===n.type&&(n._map=function(e){return e?1:0});n._offset=t,t+=r},n=0;n<e.defines.length;n++)i(n);for(var r in t>31&&(e.uber=!0),e.constantMacros="",e.builtins.statistics)e.constantMacros+="#define ".concat(r," ").concat(e.builtins.statistics[r],"\n")}(i),this._templates[e.name]=i,!this._templateInfos[i.hash]){var n={};n.samplerStartBinding=i.blocks.length,n.shaderInfo=new n_,n.blockSizes=[],n.bindings=[];for(var r=0;r<i.blocks.length;r++){var s=i.blocks[r];n.blockSizes.push(s.members.reduce(ng,0)),n.bindings.push(new d_(s.binding,dc.UNIFORM_BUFFER,1,s.stageFlags)),n.shaderInfo.blocks.push(new Yc(_v.MATERIAL,s.binding,s.name,s.members.map((function(e){return new qc(e.name,e.type,e.count)})),1))}for(var a=0;a<i.samplerTextures.length;a++){var o=i.samplerTextures[a];n.bindings.push(new d_(o.binding,dc.SAMPLER_TEXTURE,o.count,o.stageFlags)),n.shaderInfo.samplerTextures.push(new Kc(_v.MATERIAL,o.binding,o.name,o.type,o.count))}for(var h=0;h<i.samplers.length;h++){var l=i.samplers[h];n.bindings.push(new d_(l.binding,dc.SAMPLER,l.count,l.stageFlags)),n.shaderInfo.samplers.push(new Qc(_v.MATERIAL,l.binding,l.name,l.count))}for(var c=0;c<i.textures.length;c++){var _=i.textures[c];n.bindings.push(new d_(_.binding,dc.TEXTURE,_.count,_.stageFlags)),n.shaderInfo.textures.push(new Jc(_v.MATERIAL,_.binding,_.name,_.type,_.count))}for(var f=0;f<i.buffers.length;f++){var d=i.buffers[f];n.bindings.push(new d_(d.binding,dc.STORAGE_BUFFER,1,d.stageFlags)),n.shaderInfo.buffers.push(new $c(_v.MATERIAL,d.binding,d.name,1,d.memoryAccess))}for(var m=0;m<i.images.length;m++){var p=i.images[m];n.bindings.push(new d_(p.binding,dc.STORAGE_IMAGE,p.count,p.stageFlags)),n.shaderInfo.images.push(new Zc(_v.MATERIAL,p.binding,p.name,p.type,p.count,p.memoryAccess))}for(var v=0;v<i.subpassInputs.length;v++){var y=i.subpassInputs[v];n.bindings.push(new d_(y.binding,dc.INPUT_ATTACHMENT,y.count,y.stageFlags)),n.shaderInfo.subpassInputs.push(new e_(_v.MATERIAL,y.binding,y.name,y.count))}n.gfxAttributes=[];for(var g=0;g<i.attributes.length;g++){var S=i.attributes[g];n.gfxAttributes.push(new i_(S.name,S.format,S.isNormalized,0,S.isInstanced,S.location))}ag(i,n,uv,"locals"),n.shaderInfo.stages.push(new t_(ic.VERTEX,"")),n.shaderInfo.stages.push(new t_(ic.FRAGMENT,"")),n.handleMap=function(e){for(var t={},i=0;i<e.blocks.length;i++)for(var n=e.blocks[i],r=n.members,s=0,a=0;a<r.length;a++){var o=r[a];t[o.name]=Uy(n.binding,o.type,o.count,s),s+=(D_(o.type)>>2)*o.count}for(var u=0;u<e.samplerTextures.length;u++){var h=e.samplerTextures[u];t[h.name]=Uy(h.binding,h.type,h.count)}return t}(i),n.setLayouts=[],this._templateInfos[i.hash]=n}return i}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"getTemplateInfo",value:function(e){var t=this._templates[e].hash;return this._templateInfos[t]}},{key:"getDescriptorSetLayout",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._templates[t],r=this._templateInfos[n.hash];return r.setLayouts.length||(sg.bindings=r.bindings,r.setLayouts[_v.MATERIAL]=e.createDescriptorSetLayout(sg),sg.bindings=uv.bindings,r.setLayouts[_v.LOCAL]=e.createDescriptorSetLayout(sg)),r.setLayouts[i?_v.LOCAL:_v.MATERIAL]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){return function(e,t){var i=e.defines;if(e.uber){for(var n="",r=0;r<i.length;r++){var s=i[r],a=t[s.name];if(a&&s._map){var o=s._map(a),u=s._offset;n+="".concat(u).concat(o,"|")}}return"".concat(n).concat(e.hash)}for(var h=0,l=0;l<i.length;l++){var c=i[l],_=t[c.name];_&&c._map&&(h|=c._map(_)<<c._offset)}return"".concat(h.toString(16),"|").concat(e.hash)}(this._templates[e],t)}},{key:"destroyShaderByDefines",value:function(e){var t=this,i=Object.keys(e);if(i.length)for(var n=i.map((function(t){var i=e[t];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp("".concat(t).concat(i))})),r=Object.keys(this._cache).filter((function(e){return n.every((function(i){return i.test(t._cache[e].name)}))})),s=0;s<r.length;s++){var a=r[s],o=this._cache[a];$("destroyed shader ".concat(o.name)),o.destroy(),delete this._cache[a]}}},{key:"getGFXShader",value:function(e,t,i,n,r){Object.assign(i,n.macros),r||(r=this.getKey(t,i));var s=this._cache[r];if(s)return s;var a=this._templates[t],o=this._templateInfos[a.hash];o.pipelineLayout||(this.getDescriptorSetLayout(e,t),ag(a,o,ov,"globals"),o.setLayouts[_v.GLOBAL]=n.descriptorSetLayout,o.pipelineLayout=e.createPipelineLayout(new v_(o.setLayouts)));var u=function(e,t){for(var i=[],n=0;n<t.length;n++){var r=t[n],s=r.name,a=e[s],o=eg(r,a),u=!a||"0"===a;i.push({name:s,value:o,isDefault:u})}return i}(i,a.defines),h=n.constantMacros+a.constantMacros+u.reduce((function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.value,"\n")}),""),l=a.glsl3,c=ug(e);c?l=a[c]:console.error("Invalid GFX API!"),o.shaderInfo.stages[0].source=h+l.vert,o.shaderInfo.stages[1].source=h+l.frag,o.shaderInfo.attributes=function(e,t,i){for(var n=[],r=e.attributes,s=0;s<r.length;s++)tg(r[s].defines,i)&&n.push(t[s]);return n}(a,o.gfxAttributes,i),o.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:"".concat(e,"|").concat(t.name).concat(t.value)}),"")}(t,u);var _=o.shaderInfo;return this._cache[r]=e.createShader(_)}}]),e}());B.programLib=vg;var yg=["planar-shadow","skybox","deferred-lighting","bloom","post-process","profiler","splash-screen","standard","unlit","sprite","particle","particle-gpu","particle-trail","billboard","terrain","graphics","clear-stencil","spine","occlusion-query","geometry-renderer","debug-renderer"],gg=e("EffectAsset",Hs("cc.EffectAsset")((pg=mg=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).techniques=cg&&cg(),e.shaders=_g&&_g(),e.combinations=fg&&fg(),e.hideInEditor=dg&&dg(),e}return s(i,[{key:"onLoaded",value:function(){B.rendering&&B.rendering.enableEffectImport?(function(e){for(var t=0;t<e.techniques.length;t++)for(var i=e.techniques[t],n=0;n<i.passes.length;n++){var r=i.passes[n];void 0!==r.propertyIndex&&void 0===r.properties&&(r.properties=i.passes[r.propertyIndex].properties)}}(this),B.rendering.programLib.addEffect(this)):vg.register(this),i.register(this),B.game.once(B.Game.EVENT_RENDERER_INITED,this._precompile,this)}},{key:"_precompile",value:function(){var e=this;if(B.rendering&&B.rendering.enableEffectImport)B.rendering.programLib.precompileEffect(yf.gfxDevice,this);else for(var t=B.director.root,i=function(i){var n=e.shaders[i],r=e.combinations[i];if(!r)return"continue";(function(e){return Object.keys(e).reduce((function(t,i){return t.reduce((function(t,n){for(var r=e[i],s=0;s<r.length;++s){var a=u({},n);a[i]=r[s],t.push(a)}return t}),[])}),[{}])})(r).forEach((function(e){return vg.getGFXShader(yf.gfxDevice,n.name,e,t.pipeline)}))},n=0;n<this.shaders.length;n++)i(n)}},{key:"destroy",value:function(){return i.remove(this),g(l(i.prototype),"destroy",this).call(this)}},{key:"initDefault",value:function(e){g(l(i.prototype),"initDefault",this).call(this,e);var t=i.get("builtin-unlit");this.name="builtin-unlit",this.shaders=t.shaders,this.combinations=t.combinations,this.techniques=t.techniques}},{key:"validate",value:function(){return this.techniques.length>0&&this.shaders.length>0}}],[{key:"register",value:function(e){i._effects[e.name]=e,i._layoutValid=!1}},{key:"remove",value:function(e){if("string"!=typeof e)i._effects[e.name]&&i._effects[e.name]===e&&delete i._effects[e.name];else{if(i._effects[e])return void delete i._effects[e];for(var t in i._effects)if(i._effects[t]._uuid===e)return void delete i._effects[t]}}},{key:"get",value:function(e){if(i._effects[e])return i._effects[e];for(var t in i._effects)if(i._effects[t]._uuid===e)return i._effects[t];return yg.includes(e)&&ae(16101,e),null}},{key:"getAll",value:function(){return i._effects}},{key:"isLayoutValid",value:function(){return i._layoutValid}},{key:"setLayoutValid",value:function(){i._layoutValid=!0}}]),i}(ed),mg._effects={},mg._layoutValid=!0,cg=Ms((lg=pg).prototype,"techniques",[Js],(function(){return[]})),_g=Ms(lg.prototype,"shaders",[Js],(function(){return[]})),fg=Ms(lg.prototype,"combinations",[Js],(function(){return[]})),dg=Ms(lg.prototype,"hideInEditor",[Js,$s],(function(){return!1})),hg=lg))||hg);B.EffectAsset=gg;var Sg=function(){function e(){n(this,e),this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new Ef,this.scenes=new Ef,this.paths=new Ef}return s(e,[{key:"init",value:function(e){var t=this;!function(e){var t=e.uuids,i=e.paths,n=e.types,r=e.deps,s=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,o=t.length;a<o;a++)t[a]=Uf(t[a]);for(var u in i){var h=i[u],l=h[1];h[1]=n[l]}}else{for(var c=Object.create(null),_=0,f=t.length;_<f;_++){var d=t[_];t[_]=c[d]=Uf(d)}t=c}for(var m in i){var p=i[m];s[t[m]]=p}var v=e.scenes;for(var y in v){var g=v[y];v[y]=t[g]}var S=e.packs;for(var A in S)for(var T=S[A],E=0;E<T.length;++E)T[E]=t[T[E]];var b=e.versions;if(b)for(var C in b)for(var R=b[C],x=0;x<R.length;x+=2){var w=R[x];R[x]=t[w]||w}var k=e.redirect;if(k)for(var I=0;I<k.length;I+=2)k[I]=t[k[I]],k[I+1]=r[k[I+1]];if(e.extensionMap){var B=function(i){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,i))return"continue";e.extensionMap[i].forEach((function(n,r){e.extensionMap[i][r]=t[n]||n}))};for(var P in e.extensionMap)B(P)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var i=function(i){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,i))return"continue";e.extensionMap[i].forEach((function(e){var n=t.assetInfos.get(e);n&&(n.extension=i)}))};for(var n in e.extensionMap)i(n)}},{key:"getInfoWithPath",value:function(e,t){if(!e)return null;e=jf(e);var i=this.paths.get(e);if(i){if(!t)return i[0];for(var n=0,r=i.length;n<r;n++){var s=i[n];if(tt(s.ctor,t))return s}}return null}},{key:"getDirWithPath",value:function(e,t,i){"/"===(e=jf(e))[e.length-1]&&(e=e.slice(0,-1));var n=i||[];return this.paths.forEach((function(i,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var s=0,a=i.length;s<a;s++){var o=i[s];t&&!tt(o.ctor,t)||n.push(o)}})),n}},{key:"getAssetInfo",value:function(e){return this.assetInfos.get(e)||null}},{key:"getSceneInfo",value:function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/".concat(e)),this.scenes.find((function(t,i){return i.endsWith(e)}))}},{key:"destroy",value:function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()}},{key:"_initUuid",value:function(e){if(e){this.assetInfos.clear();for(var t=0,i=e.length;t<i;t++){var n=e[t];this.assetInfos.add(n,{uuid:n})}}}},{key:"_initPath",value:function(e){if(e){var t=this.paths;for(var i in t.clear(),e){var n=e[i],r=n[0],s=n[1],a=3===n.length,o=this.assetInfos.get(i);o.path=r,o.ctor=_t(s),t.has(r)?a?t.get(r).push(o):t.get(r).unshift(o):t.add(r,[o])}}}},{key:"_initScene",value:function(e){if(e){var t=this.scenes;t.clear();var i=this.assetInfos;for(var n in e){var r=e[n],s=i.get(r);s.url=n,t.add(n,s)}}}},{key:"_initPackage",value:function(e){if(e){var t=this.assetInfos;for(var i in e){var n=e[i],r={uuid:i,packedUuids:n,ext:".json"};t.add(i,r);for(var s=0,a=n.length;s<a;s++){var o=n[s],u=t.get(o),h=u.packs;h?1===a?h.unshift(r):h.push(r):u.packs=[r]}}}}},{key:"_initVersion",value:function(e){if(e){var t=this.assetInfos,i=e.import;if(i)for(var n=0,r=i.length;n<r;n+=2){var s=i[n];t.get(s).ver=i[n+1]}if(i=e.native)for(var a=0,o=i.length;a<o;a+=2){var u=i[a];t.get(u).nativeVer=i[a+1]}}}},{key:"_initRedirect",value:function(e){if(e)for(var t=this.assetInfos,i=0,n=e.length;i<n;i+=2){var r=e[i];t.get(r).redirect=e[i+1]}}}]),e}();function Ag(e,t){e._uuid&&t.push(e._uuid)}function Tg(e,t){for(var n=Object.getOwnPropertyNames(e),r=0;r<n.length;r++){var s=n[r];if("node"!==s&&"__eventTargets"!==s){var a=e[s];if("object"===i(a)&&a)if(Array.isArray(a))for(var o=0;o<a.length;o++){var u=a[o];u instanceof ed&&Ag(u,t)}else if(a.constructor&&a.constructor!==Object)a instanceof ed&&Ag(a,t);else for(var h=Object.getOwnPropertyNames(a),l=0;l<h.length;l++){var c=a[h[l]];c instanceof ed&&Ag(c,t)}}}}function Eg(e,t){for(var i=0;i<e._components.length;i++)Tg(e._components[i],t);for(var n=0;n<e._children.length;n++)Eg(e._children[n],t)}function bg(e,t,i,n){i.push(e._uuid);for(var r=Vm.getDeps(e._uuid),s=0,a=r.length;s<a;s++){var o=Rf.get(r[s]);if(o){var u=o._uuid;u in t?t[u]+=n:t[u]=o.refCount+n,i.includes(u)||bg(o,t,i,n)}}}var Cg=[];function Rg(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,bg(e,t,Cg,-1),Cg.length=0,0!==t[e._uuid])return t[e._uuid];for(var i in t)0!==t[i]&&bg(Rf.get(i),t,Cg,1);return Cg.length=0,t[e._uuid]}var xg=new(function(){function e(){n(this,e),this._persistNodeDeps=new Ef,this._toDelete=new Ef,this._eventListener=!1,this._dontDestroyAssets=[]}return s(e,[{key:"addIgnoredAsset",value:function(e){this._dontDestroyAssets.push(e._uuid)}},{key:"init",value:function(){this._persistNodeDeps.clear(),this._toDelete.clear()}},{key:"_addPersistNodeRef",value:function(e){var t=[];Eg(e,t);for(var i=0,n=t.length;i<n;i++){var r=Rf.get(t[i]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)}},{key:"_removePersistNodeRef",value:function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),i=0,n=t.length;i<n;i++){var r=Rf.get(t[i]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}}},{key:"_autoRelease",value:function(e,t,i){if(e){for(var n=Vm.getDeps(e.uuid),r=0,s=n.length;r<s;r++){var a=Rf.get(n[r]);a&&a.decRef(e.autoReleaseAssets)}var o=Vm._depends.get(e.uuid);if(o&&o.persistDeps)for(var u=o.persistDeps,h=0,l=u.length;h<l;h++){var c=Rf.get(u[h]);c&&c.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&Vm.remove(e.uuid)}var _=Vm._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),i){for(var d,m,p=i[f],v=this._persistNodeDeps.get(p.uuid),y=R(v);!(m=y()).done;){var g=m.value,S=Rf.get(g);S&&S.addRef()}_&&(d=_.persistDeps).push.apply(d,E(v))}}},{key:"tryRelease",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e instanceof ed&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,jt(this._freeAssets.bind(this)))))}},{key:"_freeAssets",value:function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()}},{key:"_free",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=e._uuid;if(this._toDelete.remove(i),Ha(e,!0)&&-1===this._dontDestroyAssets.indexOf(i)&&!(!t&&e.refCount>0&&Rg(e)>0)){Rf.remove(i);for(var n=Vm.getDeps(i),r=0,s=n.length;r<s;r++){var a=Rf.get(n[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),Vm.remove(i)}}}]),e}()),wg=null;function kg(e,t){for(var i=0,n=e.input.length;i<n;i++){var r=e.input[i];t&&!r.isNative&&r.content instanceof ed&&r.content.decRef(!1),r.recycle()}e.input=null}function Ig(e,t){return t?/\?/.test(e)?"".concat(e,"&_t=").concat(Date.now()):"".concat(e,"?_t=").concat(Date.now()):e}function Bg(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;e(r,(function(s,a){r++,!s||r>t?n&&n(s,a):setTimeout((function(){Bg(e,t,i,n,r)}),i)}))}function Pg(e,t,i,n,r){try{for(var s=Vm.parse(e,t),a=0,o=s.deps.length;a<o;a++){var h=s.deps[a];h in i||(i[h]=!0,n.push({uuid:h,bundle:r&&r.name}))}s.nativeDep&&(r&&(s.nativeDep.bundle=r.name),n.push(u({},s.nativeDep)))}catch(e){J(e.message,e.stack)}}function Mg(e,t,i){t&&(i=void 0!==i?i:B.assetManager.cacheAsset,Xf(t)||!i||t.isDefault||Rf.add(e,t))}function Og(e,t,i){var n=0,r=[],s=e.length;0===s&&i&&i(r);for(var a=function(e){e&&r.push(e),++n===s&&i&&i(r)},o=0;o<s;o++)t(e[o],a)}function Dg(e,t,i){var n=e,r=t,s=i;if(void 0===i){var a="function"==typeof e;t?(s=t,a||(r=null)):void 0===t&&a&&(s=e,n=null,r=null),void 0!==t&&a&&(r=e,n=null)}return{options:n||Object.create(null),onProgress:r,onComplete:s}}function Lg(e,t,i){var n=e,r=t,s=i;if(void 0===i){var a=tt(e,ed);t?(s=t,a&&(r=null)):void 0!==t||a||(s=e,r=null,n=null),void 0===t||a||(r=e,n=null)}return{type:n,onProgress:r||wg,onComplete:s}}function Ng(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=i[t];if(!r||n[t])return!1;n[t]=!0;var s=!1,a=Vm.getDeps(t);if(a)for(var o=0,u=a.length;o<u;o++){var h=a[o];if(h===e||Ng(e,h,i,n)){s=!0;break}}return s}function Fg(e){return function(t,i){if(e){var n=[];Array.isArray(i)?i.forEach((function(e){return e instanceof ed&&n.push(e.addRef())})):i instanceof ed&&n.push(i.addRef()),jt((function(){n.forEach((function(e){return e.decRef(!1)})),e(t,i)}))}}}var Gg=function(){function e(){n(this,e),this._config=new Sg}return s(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}},{key:"getInfoWithPath",value:function(e,t){return this._config.getInfoWithPath(e,t)}},{key:"getDirWithPath",value:function(e,t,i){return this._config.getDirWithPath(e,t,i)}},{key:"getAssetInfo",value:function(e){return this._config.getAssetInfo(e)}},{key:"getSceneInfo",value:function(e){return this._config.getSceneInfo(e)}},{key:"init",value:function(e){this._config.init(e),kf.add(e.name,this)}},{key:"load",value:function(e,t,i,n){var r=Lg(t,i,n),s=r.type,a=r.onProgress,o=r.onComplete,u={__requestType__:Cf.PATH,type:s,bundle:this.name,__outputAsArray__:Array.isArray(e)};B.assetManager.loadAny(e,u,a,o)}},{key:"preload",value:function(e,t,i,n){var r=Lg(t,i,n),s=r.type,a=r.onProgress,o=r.onComplete;B.assetManager.preloadAny(e,{__requestType__:Cf.PATH,type:s,bundle:this.name},a,o)}},{key:"loadDir",value:function(e,t,i,n){var r=Lg(t,i,n),s=r.type,a=r.onProgress,o=r.onComplete;B.assetManager.loadAny(e,{__requestType__:Cf.DIR,type:s,bundle:this.name,__outputAsArray__:!0},a,o)}},{key:"preloadDir",value:function(e,t,i,n){var r=Lg(t,i,n),s=r.type,a=r.onProgress,o=r.onComplete;B.assetManager.preloadAny(e,{__requestType__:Cf.DIR,type:s,bundle:this.name},a,o)}},{key:"loadScene",value:function(e,t,i,n){var r=Dg(t,i,n),s=r.options,a=r.onProgress,o=r.onComplete;s.preset=s.preset||"scene",s.bundle=this.name,B.assetManager.loadAny({scene:e},s,a,(function(e,t){if(e)J(e.message,e.stack);else if(t.scene){var i=t.scene;i._id=t._uuid,i.name=t.name}else e=new Error("The asset ".concat(t._uuid," is not a scene"));o&&o(e,t)}))}},{key:"preloadScene",value:function(e,t,i,n){var r=Dg(t,i,n),s=r.options,a=r.onProgress,o=r.onComplete;s.bundle=this.name,B.assetManager.preloadAny({scene:e},s,a,(function(t){t&&ue(1210,e,t.message),o&&o(t)}))}},{key:"get",value:function(e,t){var i=this.getInfoWithPath(e,t);return i&&Rf.get(i.uuid)||null}},{key:"release",value:function(e,t){var i=this.get(e,t);i&&xg.tryRelease(i,!0)}},{key:"releaseUnusedAssets",value:function(){var e=this;Rf.forEach((function(t){var i=e.getAssetInfo(t._uuid);i&&!i.redirect&&xg.tryRelease(t)}))}},{key:"releaseAll",value:function(){var e=this;Rf.forEach((function(t){var i=e.getAssetInfo(t._uuid);i&&!i.redirect&&xg.tryRelease(t,!0)}))}},{key:"_destroy",value:function(){this._config.destroy()}}]),e}(),Vg=e("resources",new Gg);function Ug(e,t,i){var n=new M.Image;function r(){n.removeEventListener("load",r),n.removeEventListener("error",s),i&&i(null,n)}function s(){n.removeEventListener("load",r),n.removeEventListener("error",s),i&&i(new Error(_e(4930,e)))}return"file:"!==M.location.protocol&&(n.crossOrigin="anonymous"),n.addEventListener("load",r),n.addEventListener("error",s),n.src=e,n}function Hg(e,t,i,n){var r=new XMLHttpRequest,s="download failed: ".concat(e,", status: ");if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?n&&n(null,r.response):n&&n(new Error("".concat(s).concat(r.status,"(no response)")))},i&&(r.onprogress=function(e){e.lengthComputable&&i(e.loaded,e.total)}),r.onerror=function(){n&&n(new Error("".concat(s).concat(r.status,"(error)")))},r.ontimeout=function(){n&&n(new Error("".concat(s).concat(r.status,"(time out)")))},r.onabort=function(){n&&n(new Error("".concat(s).concat(r.status,"(abort)")))},r.send(null),r}B.resources=Vg;var zg=M.document,Wg={};function Xg(e,t,i){if(Wg[e])return i&&i(null),null;var n=zg.createElement("script");function r(){n.parentNode.removeChild(n),n.removeEventListener("load",r,!1),n.removeEventListener("error",s,!1),Wg[e]=!0,i&&i(null)}function s(){n.parentNode.removeChild(n),n.removeEventListener("load",r,!1),n.removeEventListener("error",s,!1),i&&i(new Error(_e(4928,e)))}return"file:"!==M.location.protocol&&(n.crossOrigin="anonymous"),n.async=t.scriptAsyncLoading||!1,n.src=e,n.addEventListener("load",r,!1),n.addEventListener("error",s,!1),zg.body.appendChild(n),n}var jg=/^(?:\w+:\/\/|\.+\/).+/,qg=function(e,t,i){(Sl.hasFeature(Sl.Feature.IMAGE_BITMAP)&&B.assetManager.allowImageBitmap?Yg:Ug)(e,t,i)},Yg=function(e,t,i){t.xhrResponseType="blob",Hg(e,t,t.onFileProgress,i)},Kg=function(e,t,i){t.xhrResponseType="json",Hg(e,t,t.onFileProgress,i)},Qg=function(e,t,i){t.xhrResponseType="arraybuffer",Hg(e,t,t.onFileProgress,i)},Jg=function(e,t,i){Kg(e,t,(function(t,n){if(t)i(t);else{var r=am(n);Promise.all(r.chunks.map((function(i){return new Promise((function(n,r){Qg("".concat(il(e)).concat(i),{},(function(e,i){t?r(t):n(new Uint8Array(i))}))}))}))).then((function(e){var t=new sm(r.document,e);i(null,t)})).catch((function(e){i(e)}))}}))},Zg=function(e,t,i){Qg(e,t,(function(e,t){if(e)i(e);else try{var n=om(new Uint8Array(t));i(null,n)}catch(e){i(e)}}))},$g=function(e,t,i){t.xhrResponseType="text",Hg(e,t,t.onFileProgress,i)},eS=function(e,t,i){var n=nl(e),r=e;jg.test(r)||(r=-1!==uS.remoteBundles.indexOf(n)?"".concat(uS.remoteServerAddress,"remote/").concat(n):"assets/".concat(n));var s=t.version||uS.bundleVers[n],a=0,o="".concat(r,"/config.").concat(s?"".concat(s,"."):"","json"),u=null,h=null;Kg(o,t,(function(e,t){h=e,(u=t)&&(u.base="".concat(r,"/")),2==++a&&i(h,u)})),Xg("".concat(r,"/index.").concat(s?"".concat(s,"."):"","js"),t,(function(e){h=e,2==++a&&i(e,u)}))},tS=function(){function e(){n(this,e),this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=Ug,this.downloadDomAudio=null,this.downloadFile=Hg,this.downloadScript=Xg,this._downloaders={".png":qg,".jpg":qg,".bmp":qg,".jpeg":qg,".gif":qg,".ico":qg,".tiff":qg,".webp":qg,".image":qg,".pvr":Qg,".pkm":Qg,".astc":Qg,".txt":$g,".xml":$g,".vsh":$g,".fsh":$g,".atlas":$g,".tmx":$g,".tsx":$g,".json":Kg,".ExportJson":Kg,".plist":$g,".ccon":Jg,".cconb":Zg,".fnt":$g,".binary":Qg,".bin":Qg,".dbbin":Qg,".skel":Qg,".js":Xg,bundle:eS,default:$g},this._downloading=new Ef,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}return s(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=i}},{key:"register",value:function(e,t){"object"===i(e)?Ze(this._downloaders,e):this._downloaders[e]=t}},{key:"download",value:function(e,t,i,n,r){var s=this,a=xf.get(e);if(a)r(null,a);else{var o=this._downloading.get(e);if(o){o.push(r);var u=this._queue.find((function(t){return t.id===e}));if(!u)return;var h=n.priority||0;u.priority<h&&(u.priority=h,this._queueDirty=!0)}else{var l=void 0!==n.maxRetryCount?n.maxRetryCount:this.maxRetryCount,c=void 0!==n.maxConcurrency?n.maxConcurrency:this.maxConcurrency,_=void 0!==n.maxRequestsPerFrame?n.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[i]||this._downloaders.default;Bg((function(i,a){if(0===i&&s._downloading.add(e,[r]),s.limited){s._updateTime();var o=function(e,t){s._totalNum--,s._handleQueueInNextFrame(c,_),a(e,t)};s._totalNum<c&&s._totalNumThisPeriod<_?(f(Ig(t,s.appendTimeStamp),n,o),s._totalNum++,s._totalNumThisPeriod++):(s._queue.push({id:e,priority:n.priority||0,url:t,options:n,done:o,handler:f}),s._queueDirty=!0,s._totalNum<c&&s._handleQueueInNextFrame(c,_))}else f(Ig(t,s.appendTimeStamp),n,a)}),l,this.retryInterval,(function(t,i){t||xf.add(e,i);for(var n=s._downloading.remove(e),r=0,a=n.length;r<a;r++)n[r](t,i)}))}}}},{key:"loadSubpackage",value:function(e,t){B.assetManager.loadBundle(e,null,t)}},{key:"_updateTime",value:function(){var e=performance.now(),t=B.game.deltaTime,i=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*i&&(this._totalNumThisPeriod=0,this._lastDate=e)}},{key:"_handleQueue",value:function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var i=this._queue.pop();if(!i)break;this._totalNum++,this._totalNumThisPeriod++,i.handler(Ig(i.url,this.appendTimeStamp),i.options,i.done)}this._handleQueueInNextFrame(e,t)}},{key:"_handleQueueInNextFrame",value:function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(jt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)}}],[{key:"instance",get:function(){return e._instance||(e._instance=new e),e._instance}}]),e}();tS._instance=void 0;var iS,nS,rS,sS,aS,oS,uS=tS.instance,hS=tS.instance,lS=e("JsonAsset",Hs("cc.JsonAsset")((nS=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).json=rS&&rS(),e}return i}(ed),rS=Ms(nS.prototype,"json",[Js],(function(){return null})),iS=nS))||iS);B.JsonAsset=lS;var cS,_S,fS=e("TextAsset",Hs("cc.TextAsset")((aS=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).text=oS&&oS(),e}return s(i,[{key:"toString",value:function(){return this.text}}]),i}(ed),oS=Ms(aS.prototype,"text",[Js],(function(){return""})),sS=aS))||sS);B.TextAsset=fS;var dS=e("BufferAsset",Hs("cc.BufferAsset")((x((_S=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._buffer=null,e}return s(i,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}},{key:"buffer",value:function(){return this._buffer,this._buffer}},{key:"validate",value:function(){return!!this._buffer}}]),i}(ed)).prototype,"_nativeAsset",[Ta],Object.getOwnPropertyDescriptor(_S.prototype,"_nativeAsset"),_S.prototype),cS=_S))||cS);function mS(e,t,i,n){var r=null,s=null;try{(r=new bd)._nativeUrl=e,r._nativeAsset=t}catch(e){s=e}n(s,r)}function pS(e,t,i,n){var r=new lS;r.json=t,n(null,r)}function vS(e,t,i,n){var r=new fS;r.text=t,n(null,r)}function yS(e,t,i,n){var r=new dS;r._nativeUrl=e,r._nativeAsset=t,n(null,r)}function gS(e,t,i,n){var r=new ed;r._nativeUrl=e,r._nativeAsset=t,n(null,r)}function SS(e,i,n,r){var s=kf.get(i.name);s||(s=i.name===Of.RESOURCES?Vg:new Gg,i.base=i.base||"".concat(e,"/"),s.init(i)),t.import("virtual:///prerequisite-imports/".concat(s.name)).then((function(){r(null,s)})).catch(r)}B.BufferAsset=dS;var AS=new(function(){function e(){n(this,e),this._creating=new Ef,this._producers={".png":mS,".jpg":mS,".bmp":mS,".jpeg":mS,".gif":mS,".ico":mS,".tiff":mS,".webp":mS,".image":mS,".pvr":mS,".pkm":mS,".txt":vS,".xml":vS,".vsh":vS,".fsh":vS,".atlas":vS,".tmx":vS,".tsx":vS,".fnt":vS,".json":pS,".ExportJson":pS,".binary":yS,".bin":yS,".dbbin":yS,".skel":yS,bundle:SS,default:gS}}return s(e,[{key:"register",value:function(e,t){"object"===i(e)?Ze(this._producers,e):this._producers[e]=t}},{key:"create",value:function(e,t,i,n,r){var s=this,a=this._producers[i]||this._producers.default,o=Rf.get(e);if(n.reloadAsset||!o){var u=this._creating.get(e);u?u.push(r):(this._creating.add(e,[r]),a(e,t,n,(function(t,i){!t&&i instanceof ed&&(i._uuid=e,Mg(e,i,n.cacheAsset));for(var r=s._creating.remove(e),a=0,o=r.length;a<o;a++)r[a](t,i)})))}else r(null,o)}}]),e}()),TS=new(function(){function e(){n(this,e),this._loading=new Ef,this._unpackers={".json":this.unpackJson}}return s(e,[{key:"unpackJson",value:function(e,t,i,n){var r=Ue(!0),s=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(_e(5304,e[0]));km(e,!0,void 0,Bm.reportMissingClass),Im(e);for(var t=new Pm(e[0]),i=e[1],n=e[2],r=e[3],s=e[4],a=e[5],o=0;o<a.length;++o)a[o].unshift(t,i,n,r,s);return a}(t)).length!==e.length&&ue(4915);for(var a=0;a<e.length;a++)r["".concat(e[a],"@import")]=t[a]}else{var o=mt(Qm),u=mt(bd);if(t.type===o&&t.data){var h=t.data;h.length!==e.length&&ue(4915);for(var l=0;l<e.length;l++)r["".concat(e[l],"@import")]=Mm(o,{base:h[l][0],mipmaps:h[l][1]})}else if(t.type===u&&t.data){var c=t.data;c.length!==e.length&&ue(4915);for(var _=0;_<e.length;_++)r["".concat(e[_],"@import")]=c[_]}else s=new Error("unmatched type pack!"),r=null}n(s,r)}},{key:"init",value:function(){this._loading.clear()}},{key:"register",value:function(e,t){"object"===i(e)?Ze(this._unpackers,e):this._unpackers[e]=t}},{key:"unpack",value:function(e,t,i,n,r){t?(0,this._unpackers[i])(e,t,n,r):r(new Error("package data is wrong!"))}},{key:"load",value:function(e,t,i){var n=this;if(!e.isNative&&e.info&&e.info.packs)if(xf.has(e.id))i(null,xf.get(e.id));else{var r=e.info.packs,s=r.find((function(e){return n._loading.has(e.uuid)}));if(s)this._loading.get(s.uuid).push({onComplete:i,id:e.id});else{s=r[0],this._loading.add(s.uuid,[{onComplete:i,id:e.id}]);var a=qf(s.uuid,{ext:s.ext,bundle:e.config.name});hS.download(s.uuid,a,s.ext,e.options,(function(t,i){xf.remove(s.uuid),t&&J(t.message,t.stack),n.unpack(s.packedUuids,i,s.ext,e.options,(function(e,i){if(!e)for(var r in i)xf.add(r,i[r]);for(var a=n._loading.remove(s.uuid),o=0,u=a.length;o<u;o++){var h=a[o];if(t||e)h.onComplete(t||e);else{var l=i[h.id];l?h.onComplete(null,l):h.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else hS.download(e.id,e.url,e.ext,e.options,i)}}]),e}());function ES(e,t){var i=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},i=!0);var n=e.options,r=e.progress,s=[],a=r.total,o=n.__exclude__=n.__exclude__||Object.create(null);e.output=[],Og(e.input,(function(n,u){if(!n.isNative&&Rf.has(n.uuid)){var h=Rf.get(n.uuid);return n.content=h.addRef(),e.output.push(n),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,n),void u()}TS.load(n,e.options,(function(h,l){h?e.isFinished||(!B.assetManager.force||i?(J(h.message,h.stack),r.canInvoke=!1,t(h)):(e.output.push(n),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,n))):e.isFinished||(n.file=l,e.output.push(n),n.isNative||(o[n.uuid]=!0,Pg(n.uuid,l,o,s,n.config),r.total=a+s.length),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,n)),u()}))}),(function(){if(e.isFinished)return kg(e,!0),void e.dispatch("error");if(s.length>0){var a=Lf.create({input:s,progress:r,options:n,onProgress:e.onProgress,onError:Lf.prototype.recycle,onComplete:function(n){var r;n||((r=e.output).push.apply(r,E(a.output)),a.recycle()),i&&bS(e),t(n)}});Bf.async(a)}else i&&bS(e),t()}))}function bS(e){for(var t=e.output,i=0,n=t.length;i<n;i++)t[i].content&&t[i].content.decRef(!1)}var CS=new(function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"parse",value:function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return ae(5100),{};for(var i=null,n=0,r=t.childNodes.length;n<r&&1!==(i=t.childNodes[n]).nodeType;n++);return this._parseNode(i)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},i="",n=0,r=e.childNodes.length;n<r;n++){var s=e.childNodes[n];1===s.nodeType&&("key"===s.tagName?i=s.firstChild.nodeValue:t[i]=this._parseNode(s))}return t}}]),i}(function(){function e(){n(this,e),this._parser=null,globalThis.DOMParser&&(this._parser=new DOMParser)}return s(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")}}]),e}())),RS=function(){function e(){n(this,e),this._parsing=new Ef,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}return s(e,[{key:"parseImage",value:function(e,t,i){e instanceof HTMLImageElement?i(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){i(null,e)}),(function(e){i(e,null)}))}},{key:"parsePVRTex",value:function(e,t,i){var n=null,r=null;try{r=bd.parseCompressedTextures(e,0)}catch(e){n=e,console.warn(n)}i(n,r)}},{key:"parsePKMTex",value:function(e,t,i){var n=null,r=null;try{r=bd.parseCompressedTextures(e,1)}catch(e){n=e,console.warn(n)}i(n,r)}},{key:"parseASTCTex",value:function(e,t,i){var n=null,r=null;try{r=bd.parseCompressedTextures(e,2)}catch(e){n=e,console.warn(n)}i(n,r)}},{key:"parsePlist",value:function(e,t,i){var n=null,r=CS.parse(e);r||(n=new Error("parse failed")),i(n,r)}},{key:"parseImport",value:function(e,t,i){if(e){var n=null,r=null;try{n=Nm(e,t)}catch(e){r=e}i(r,n)}else i(new Error("The json file of asset ".concat(t.__uuid__," is empty or missing")))}},{key:"init",value:function(){this._parsing.clear()}},{key:"register",value:function(e,t){"object"===i(e)?Ze(this._parsers,e):this._parsers[e]=t}},{key:"parse",value:function(e,t,i,n,r){var s=this,a=wf.get(e);if(a)r(null,a);else{var o=this._parsing.get(e);if(o)o.push(r);else{var u=this._parsers[i];u?(this._parsing.add(e,[r]),u(t,n,(function(t,i){t?xf.remove(e):Xf(i)||wf.add(e,i);for(var n=s._parsing.remove(e),r=0,a=n.length;r<a;r++)n[r](t,i)}))):r(null,t)}}}}],[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}();RS._instance=void 0;var xS=RS.instance;function wS(e,t){var i=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},i=!0);var n=e.options,r=e.progress;n.__exclude__=n.__exclude__||Object.create(null),e.output=[],Og(e.input,(function(s,a){var o=Lf.create({input:s,onProgress:e.onProgress,options:n,progress:r,onComplete:function(n,u){n&&!e.isFinished&&(!B.assetManager.force||i?(J(n.message,n.stack),r.canInvoke=!1,t(n)):r.canInvoke&&e.dispatch("progress",++r.finish,r.total,s)),e.output.push(u),o.recycle(),a(null)}});kS.async(o)}),(function(){if(n.__exclude__=null,e.isFinished)return kg(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var i=e.output=[],n=0,r=t.length;n<r;n++)i.push(t[n].content);else e.output=t[0].content}(e),kg(e,!0),t()}))}var kS=new bf("loadOneAsset",[function(e,t){var i=e.output=e.input,n=i.options,r=i.isNative,s=i.uuid,a=i.file,o=n.reloadAsset;a||!o&&!r&&Rf.has(s)?t():TS.load(i,e.options,(function(e,n){i.file=n,t(e)}))},function(e,t){var i=e.output=e.input,n=e.progress,r=e.options.__exclude__,s=i.id,a=i.file,o=i.options;if(i.isNative)xS.parse(s,a,i.ext,o,(function(r,a){r?t(r):(i.content=a,n.canInvoke&&e.dispatch("progress",++n.finish,n.total,i),xf.remove(s),wf.remove(s),t())}));else{var u=i.uuid;if(u in r){var h=r[u],l=h.finish,c=h.content,_=h.err,f=h.callbacks;n.canInvoke&&e.dispatch("progress",++n.finish,n.total,i),l||Ng(u,u,r)?(c&&c.addRef(),i.content=c,t(_)):f.push({done:t,item:i})}else if(!o.reloadAsset&&Rf.has(u)){var d=Rf.get(u);i.content=d.addRef(),n.canInvoke&&e.dispatch("progress",++n.finish,n.total,i),t()}else o.__uuid__=u,xS.parse(s,a,"import",o,(function(i,n){i?t(i):function(e,t,i){var n=e.input,r=e.progress,s=n,a=s.uuid,o=s.id,u=s.options,h=s.config,l=u.cacheAsset,c=[];t.addRef&&t.addRef(),Pg(a,t,Object.create(null),c,h),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=c.length,n);var _=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:i,item:n}]},f=Lf.create({input:c,options:e.options,onProgress:e.onProgress,onError:Lf.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var i,n=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),s=R(n);!(i=s()).done;){var u=i.value;u&&(r[u instanceof ed?"".concat(u._uuid,"@import"):"".concat(a,"@native")]=u)}!function(e,t,i){var n=Om.get(t);if(n){for(var r=0,s=n.length;r<s;r++){var a=n[r],o=i["".concat(a.uuid,"@import")];if(o)a.owner[a.prop]=o.addRef();else{if(J("The asset ".concat(a.uuid," is missing!")),a.type&&a.type!==ed){var u=new a.type;u.initDefault(a.uuid),a.owner[a.prop]=u}!0}}Om.delete(t)}Dm.has(t)&&(i["".concat(e,"@native")]?t._nativeAsset=i["".concat(e,"@native")]:(!0,console.error("the native asset of ".concat(e," is missing!"))),Dm.delete(t))}(a,t,r);try{"function"!=typeof t.onLoaded||Lm.has(t)||Dm.has(t)||(t.onLoaded(),Lm.add(t))}catch(e){J("The asset ".concat(a," is invalid for some reason, detail message: ").concat(e.message,", stack: ").concat(e.stack))}xf.remove(o),wf.remove(o),Mg(a,t,l),f.recycle()}for(var h=_.callbacks,c=0,d=h.length;c<d;c++){var m=h[c];t.addRef&&t.addRef(),m.item.content=t,m.done(e)}h.length=0}});If.async(f)}(e,n,t)}))}}]);function IS(e,t){var i=e.options,n=Object.create(null),r=Object.create(null);for(var s in i)switch(s){case Cf.PATH:case Cf.UUID:case Cf.DIR:case Cf.SCENE:case Cf.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":n[s]=i[s];break;case"__exclude__":case"__outputAsArray__":r[s]=i[s];break;default:n[s]=i[s],r[s]=i[s]}e.options=r;var a=Lf.create({input:e.input,options:n}),o=null;try{e.output=e.source=Pf.sync(a)}catch(e){o=e;for(var u=0,h=a.output.length;u<h;u++)a.output[u].recycle()}a.recycle(),t(o)}var BS=function(){function e(){n(this,e),this.uuid="",this.overrideUuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return s(e,[{key:"id",get:function(){return this._id||(this._id="".concat(this.overrideUuid||this.uuid,"@").concat(this.isNative?"native":"import")),this._id}},{key:"recycle",value:function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.overrideUuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))}}],[{key:"create",value:function(){return 0!==e._deadPool.length?e._deadPool.pop():new e}}]),e}();BS.MAX_DEAD_NUM=500,BS._deadPool=[];var PS=[];function MS(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var r=function(r){var s,a=n[r],o=BS.create(),u=null,h=null;if("string"==typeof a&&((a=Object.create(null))[t.__requestType__||Cf.UUID]=n[r]),"object"===i(a))for(var l in Je(a,t),a.preset&&Je(a,Df[a.preset]),a){switch(l){case Cf.UUID:if("break"===function(){var e,t=o.uuid=Uf(a.uuid);if(!a.bundle){var i=kf.find((function(e){return!!e.getAssetInfo(t)}));a.bundle=i&&i.name}if(kf.has(a.bundle)){if(u=kf.get(a.bundle).config,(h=u.getAssetInfo(t))&&h.redirect){if(!kf.has(h.redirect))throw new Error("Please load bundle ".concat(h.redirect," first"));u=kf.get(h.redirect).config,h=u.getAssetInfo(t)}o.config=u,o.info=h}return o.ext=a.ext||(null===(e=h)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case Cf.DIR:if(kf.has(a.bundle)){kf.get(a.bundle).config.getDirWithPath(a.dir,a.type,PS);for(var c,_=R(PS);!(c=_()).done;){var f=c.value;n.push({uuid:f.uuid,__isNative__:!1,ext:f.extension||".json",bundle:a.bundle})}PS.length=0}o.recycle(),o=null;break;case Cf.PATH:if(kf.has(a.bundle)){if(u=kf.get(a.bundle).config,(h=u.getInfoWithPath(a.path,a.type))&&h.redirect){if(!kf.has(h.redirect))throw new Error("you need to load bundle ".concat(h.redirect," first"));u=kf.get(h.redirect).config,h=u.getAssetInfo(h.uuid)}if(!h)throw o.recycle(),new Error("Bundle ".concat(a.bundle," doesn't contain ").concat(a.path));o.config=u,o.uuid=h.uuid,o.info=h}o.ext=a.ext||(null===(s=h)||void 0===s?void 0:s.extension)||".json";break;case Cf.SCENE:if(!a.bundle){var d=kf.find((function(e){return!!e.getSceneInfo(a.scene)}));a.bundle=d&&d.name}if(kf.has(a.bundle)){if(u=kf.get(a.bundle).config,(h=u.getSceneInfo(a.scene))&&h.redirect){if(!kf.has(h.redirect))throw new Error("you need to load bundle ".concat(h.redirect," first"));u=kf.get(h.redirect).config,h=u.getAssetInfo(h.uuid)}if(!h)throw o.recycle(),new Error("Bundle ".concat(u.name," doesn't contain scene ").concat(a.scene));o.config=u,o.uuid=h.uuid,o.info=h}break;case"__isNative__":o.isNative=a.__isNative__;break;case Cf.URL:o.url=a.url,o.uuid=a.uuid||a.url,o.ext=a.ext||tl(a.url),o.isNative=void 0===a.__isNative__||a.__isNative__;break;default:o.options[l]=a[l]}if(!o)break}if(!o)return"continue";if(e.output.push(o),!o.uuid&&!o.url)throw new Error("Can not parse this input:".concat(JSON.stringify(a)))},s=0;s<n.length;s++)r(s);return null}function OS(e){for(var t=e.output=e.input,i=0;i<t.length;i++){var n=t[i];!Mf.has(n.uuid)||function(){var e=Mf.get(n.uuid),t=kf.find((function(t){return!!t.getAssetInfo(e)}));if(t){var i;n.overrideUuid=e;var r=t.config,s=r.getAssetInfo(e);if(s&&s.redirect){if(!kf.has(s.redirect))throw new Error("Please load bundle ".concat(s.redirect," first"));s=(r=kf.get(s.redirect).config).getAssetInfo(e)}n.config=r,n.info=s,n.ext=n.isNative?n.ext:(null===(i=s)||void 0===i?void 0:i.extension)||".json"}else ae(16201,e,n.uuid)}()}}function DS(e){for(var t=e.output=e.input,i=0;i<t.length;i++){var n=t[i];if(!n.url){var r,s,a=n.config;s=n.isNative?a&&a.nativeBase?a.base+a.nativeBase:B.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:B.assetManager.generalImportBase;var o=n.overrideUuid||n.uuid,u="";n.info&&(u=n.isNative?n.info.nativeVer?".".concat(n.info.nativeVer):"":n.info.ver?".".concat(n.info.ver):""),r=".ttf"===n.ext?"".concat(s,"/").concat(o.slice(0,2),"/").concat(o).concat(u,"/").concat(n.options.__nativeName__):"".concat(s,"/").concat(o.slice(0,2),"/").concat(o).concat(u).concat(n.ext),n.url=r}}return null}var LS=e("AssetManager",function(){function e(){n(this,e),this.pipeline=If.append(IS).append(wS),this.fetchPipeline=Bf.append(IS).append(ES),this.transformPipeline=Pf.append(MS).append(OS).append(DS),this.bundles=kf,this.assets=Rf,this.assetsOverrideMap=Mf,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Vm,this.force=!1,this.allowImageBitmap=!Sl.isMobile,this.utils=Jf,this.downloader=hS,this.parser=xS,this.packManager=TS,this.cacheAsset=!0,this.cacheManager=null,this.presets=Df,this.factory=AS,this.preprocessPipe=IS,this.fetchPipe=ES,this.loadPipe=wS,this.references=null,this._releaseManager=xg,this._files=xf,this._parsed=wf,this._parsePipeline=null,this._projectBundles=[]}return s(e,[{key:"main",get:function(){return kf.get(Of.MAIN)||null}},{key:"resources",get:function(){return kf.get(Of.RESOURCES)||null}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.server||Dt.querySettings(Ot.Category.ASSETS,"server")||"",i=e.bundleVers||Dt.querySettings(Ot.Category.ASSETS,"bundleVers")||{},n=e.remoteBundles||Dt.querySettings(Ot.Category.ASSETS,"remoteBundles")||[];this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t,i,n),this.parser.init(),this.dependUtil.init();var r=e.importBase||Dt.querySettings(Ot.Category.ASSETS,"importBase")||"";r&&r.endsWith("/")&&(r=r.substr(0,r.length-1));var s=e.nativeBase||Dt.querySettings(Ot.Category.ASSETS,"nativeBase")||"";s&&s.endsWith("/")&&(s=s.substr(0,s.length-1)),this.generalImportBase=r,this.generalNativeBase=s,this._projectBundles=Dt.querySettings(Ot.Category.ASSETS,"projectBundles")||[];var a=Dt.querySettings(Ot.Category.ASSETS,"assetsOverrides")||{};for(var o in a)this.assetsOverrideMap.set(o,a[o])}},{key:"getBundle",value:function(e){return kf.get(e)||null}},{key:"removeBundle",value:function(e){e._destroy(),kf.remove(e.name)}},{key:"loadAny",value:function(e,t,i,n){var r=Dg(t,i,n),s=r.options,a=r.onProgress,o=r.onComplete;s.preset=s.preset||"default",e=Array.isArray(e)?e.slice():e;var u=Lf.create({input:e,onProgress:a,onComplete:Fg(o),options:s});If.async(u)}},{key:"preloadAny",value:function(e,t,i,n){var r=Dg(t,i,n),s=r.options,a=r.onProgress,o=r.onComplete;s.preset=s.preset||"preload",e=Array.isArray(e)?e.slice():e;var u=Lf.create({input:e,onProgress:a,onComplete:Fg(o),options:s});Bf.async(u)}},{key:"loadRemote",value:function(e,t,i){var n=Dg(t,void 0,i),r=n.options,s=n.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,i){t?(J(t.message,t.stack),s&&s(t,i)):AS.create(e,i,r.ext||tl(e),r,(function(e,t){s&&s(e,t)}))}))):Fg(s)(null,this.assets.get(e))}},{key:"loadBundle",value:function(e,t,i){var n=Dg(t,void 0,i),r=n.options,s=n.onComplete,a=nl(e);this.bundles.has(a)?Fg(s)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,i){t?(J(t.message,t.stack),s&&s(t,i)):AS.create(e,i,"bundle",r,(function(e,t){s&&s(e,t)}))})))}},{key:"releaseAsset",value:function(e){xg.tryRelease(e,!0)}},{key:"releaseUnusedAssets",value:function(){Rf.forEach((function(e){xg.tryRelease(e)}))}},{key:"releaseAll",value:function(){Rf.forEach((function(e){xg.tryRelease(e,!0)}))}},{key:"loadWithJson",value:function(){throw new Error("Only valid in Editor")}}],[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}());LS._instance=void 0,LS.Pipeline=bf,LS.Task=Lf,LS.Cache=Ef,LS.RequestItem=BS,LS.Bundle=Gg,LS.BuiltinBundleName=Of,LS.CacheManager=function e(){n(this,e),this.cacheDir=void 0,this.cacheEnabled=void 0,this.autoClear=void 0,this.cacheInterval=void 0,this.deleteInterval=void 0,this.cachedFiles=void 0},LS.Downloader=tS,LS.Parser=RS,LS.DependUtil=Fm;var NS=e("assetManager",B.assetManager=LS.instance);B.AssetManager=LS;var FS,GS,VS,US=function(){function e(){n(this,e),this._resources={},this._materialsToBeCompiled=[]}return s(e,[{key:"init",value:function(){for(var e=this._resources,t=new Uint8Array(16),i=new Uint8Array(16),n=new Uint8Array(16),r=new Uint8Array(16),s=new Uint8Array(16),a=0,o=0;o<4;o++)t[a]=0,t[a+1]=0,t[a+2]=0,t[a+3]=255,i[a]=0,i[a+1]=0,i[a+2]=0,i[a+3]=0,n[a]=119,n[a+1]=119,n[a+2]=119,n[a+3]=255,r[a]=255,r[a+1]=255,r[a+2]=255,r[a+3]=255,s[a]=127,s[a+1]=127,s[a+2]=255,s[a+3]=255,a+=4;var u=new Uint8Array(1024);a=0;for(var h=0;h<256;h++)u[a]=221,u[a+1]=221,u[a+2]=221,u[a+3]=255,a+=4;a=0;for(var l=0;l<8;l++){for(var c=0;c<8;c++)u[a]=85,u[a+1]=85,u[a+2]=85,u[a+3]=255,a+=4;a+=32}a+=32;for(var _=0;_<8;_++){for(var f=0;f<8;f++)u[a]=85,u[a+1]=85,u[a+2]=85,u[a+3]=255,a+=4;a+=32}var d={width:2,height:2,_data:t,_compressed:!1,format:Qm.PixelFormat.RGBA8888},m={width:2,height:2,_data:i,_compressed:!1,format:Qm.PixelFormat.RGBA8888},p={width:2,height:2,_data:n,_compressed:!1,format:Qm.PixelFormat.RGBA8888},v={width:2,height:2,_data:r,_compressed:!1,format:Qm.PixelFormat.RGBA8888},y={width:2,height:2,_data:s,_compressed:!1,format:Qm.PixelFormat.RGBA8888},g={width:16,height:16,_data:u,_compressed:!1,format:Qm.PixelFormat.RGBA8888},S=new bd(d),A=new Qm;A._uuid="black-texture",A.image=S,e[A._uuid]=A;var T=new bd(m),E=new Qm;E._uuid="empty-texture",E.image=T,e[E._uuid]=E;var b=new Zp;b._uuid="black-cube-texture",b.setMipFilter(Zp.Filter.NEAREST),b.image={front:new bd(d),back:new bd(d),left:new bd(d),right:new bd(d),top:new bd(d),bottom:new bd(d)},e[b._uuid]=b;var C=new bd(p),R=new Qm;R._uuid="grey-texture",R.image=C,e[R._uuid]=R;var x=new Zp;x._uuid="grey-cube-texture",x.setMipFilter(Zp.Filter.NEAREST),x.image={front:new bd(p),back:new bd(p),left:new bd(p),right:new bd(p),top:new bd(p),bottom:new bd(p)},e[x._uuid]=x;var w=new bd(v),k=new Qm;k._uuid="white-texture",k.image=w,e[k._uuid]=k;var I=new Zp;I._uuid="white-cube-texture",I.setMipFilter(Zp.Filter.NEAREST),I.image={front:new bd(v),back:new bd(v),left:new bd(v),right:new bd(v),top:new bd(v),bottom:new bd(v)},e[I._uuid]=I;var P=new bd(y),M=new Qm;M._uuid="normal-texture",M.image=P,e[M._uuid]=M;var O=new bd(g),D=new Qm;D._uuid="default-texture",D.image=O,e[D._uuid]=D;var L=new Zp;if(L.setMipFilter(Zp.Filter.NEAREST),L._uuid="default-cube-texture",L.image={front:new bd(g),back:new bd(g),left:new bd(g),right:new bd(g),top:new bd(g),bottom:new bd(g)},e[L._uuid]=L,B.SpriteFrame){var N=new B.SpriteFrame,F=S,G=new Qm;G.image=F,N.texture=G,N._uuid="default-spriteframe",e[N._uuid]=N}}},{key:"addAsset",value:function(e,t){this._resources[e]=t}},{key:"get",value:function(e){return this._resources[e]}},{key:"loadBuiltinAssets",value:function(){var e=this,t=Dt.querySettings(Ot.Category.ENGINE,"builtinAssets");if(!t)return Promise.resolve();var i=this._resources;return new Promise((function(n,r){NS.loadBundle(Of.INTERNAL,(function(s){s?r(s):NS.loadAny(t,(function(t,s){t?r(t):(s.forEach((function(t){i[t.name]=t,xg.addIgnoredAsset(t),t instanceof B.Material&&e._materialsToBeCompiled.push(t)})),n())}))}))}))}},{key:"compileBuiltinMaterial",value:function(){for(var e=0;e<this._materialsToBeCompiled.length;++e)for(var t=this._materialsToBeCompiled[e],i=0;i<t.passes.length;++i)t.passes[i].tryCompile();this._materialsToBeCompiled.length=0}}]),e}(),HS=e("builtinResMgr",B.builtinResMgr=new US),zS=e("getPhaseID",(FS=new Map,GS=0,function(e){return"number"==typeof e?e:(FS.has(e)||(FS.set(e,1<<GS),GS++),FS.get(e))})),WS=32,XS=e("InstancedBuffer",function(){function e(t){n(this,e),this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}return s(e,[{key:"destroy",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0}},{key:"merge",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=e.instancedAttributeBlock,r=n.buffer.length;if(r){var s=e.inputAssembler,a=e.descriptorSet.getTexture(uy),o=e.descriptorSet.getTexture(Sy),u=e.descriptorSet.getTexture(Ey),h=e.useReflectionProbeType,l=i;l||(l=e.shaders[t]);for(var c=e.descriptorSet,_=0;_<this.instances.length;++_){var f,d,m=this.instances[_];if(!((null===(f=m.ia.indexBuffer)||void 0===f?void 0:f.objectID)!==(null===(d=s.indexBuffer)||void 0===d?void 0:d.objectID)||m.count>=1024)&&m.lightingMap.objectID===a.objectID&&m.useReflectionProbeType===h&&m.reflectionProbeCubemap.objectID===o.objectID&&m.reflectionProbePlanarMap.objectID===u.objectID&&m.stride===r){if(m.count>=m.capacity){m.capacity<<=1;var p=m.stride*m.capacity,v=m.data;m.data=new Uint8Array(p),m.data.set(v),m.vb.resize(p)}return m.shader=l,m.descriptorSet=c,m.data.set(n.buffer,m.stride*m.count++),void(this.hasPendingModels=!0)}}for(var y=this._device.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,r*WS,r)),g=new Uint8Array(r*WS),S=s.vertexBuffers.slice(),A=s.attributes.slice(),T=s.indexBuffer,E=0;E<n.attributes.length;E++){var b=n.attributes[E],C=new i_(b.name,b.format,b.isNormalized,S.length,!0);A.push(C)}g.set(n.buffer),S.push(y);var R=new r_(A,S,T),x=this._device.createInputAssembler(R);this.instances.push({count:1,capacity:WS,vb:y,data:g,ia:x,stride:r,shader:l,descriptorSet:c,lightingMap:a,reflectionProbeCubemap:o,reflectionProbePlanarMap:u,useReflectionProbeType:h}),this.hasPendingModels=!0}}},{key:"uploadBuffers",value:function(e){for(var t=0;t<this.instances.length;++t){var i=this.instances[t];i.count&&(i.ia.instanceCount=i.count,e.updateBuffer(i.vb,i.data))}}},{key:"clear",value:function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1}}]),e}()),jS=function(){function e(t){n(this,e),this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}return s(e,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0}},{key:"merge",value:function(e,t,i){var n=e.subMesh.flatBuffers;if(0!==n.length){for(var r=0,s=0,a=n[0].count,o=e.passes[t],u=e.shaders[t],h=e.descriptorSet,l=!1,c=0;c<this.batches.length;++c){var _=this.batches[c];if(_.vbs.length===n.length&&_.mergeCount<Nv.BATCHING_COUNT){l=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==n[f].stride){l=!1;break}if(l){for(var d=0;d<_.vbs.length;++d){var m=n[d],p=_.vbs[d],v=_.vbDatas[d];(r=(a+_.vbCount)*m.stride)>p.size&&(p.resize(r),_.vbDatas[d]=new Uint8Array(r),_.vbDatas[d].set(v)),_.vbDatas[d].set(m.buffer,_.vbCount*m.stride)}var y=_.vbIdxData;(s=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(s),_.vbIdxData=new Float32Array(s/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(y),y=_.vbIdxData);var g=_.vbCount,S=g+a,A=_.mergeCount;if(y[g]!==A||y[S-1]!==A)for(var T=g;T<S;T++)y[T]=A+.1;return Cn.toArray(_.uboData,i.transform.worldMatrix,Nv.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(h.bindBuffer(Nv.BINDING,_.ubo),h.update(),_.pass=o,_.shader=u,_.descriptorSet=h),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var E=[],b=[],C=[],R=0;R<n.length;++R){var x=n[R],w=this._device.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,x.count*x.stride,x.stride));w.update(x.buffer.buffer),E.push(w),b.push(new Uint8Array(w.size)),C.push(w)}var k=this._device.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,4*a,4)),I=new Float32Array(a);I.fill(0),k.update(I),C.push(k);for(var B=e.inputAssembler.attributes,P=new Array(B.length+1),M=0;M<B.length;++M)P[M]=B[M];P[B.length]=new i_("a_dyn_batch_id",Ll.R32F,!1,n.length);var O=new r_(P,C),D=this._device.createInputAssembler(O),L=this._device.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,Nv.SIZE,Nv.SIZE));h.bindBuffer(Nv.BINDING,L),h.update();var N=new Float32Array(Nv.COUNT);Cn.toArray(N,i.transform.worldMatrix,Nv.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:b,vbIdx:k,vbIdxData:I,vbCount:a,ia:D,ubo:L,uboData:N,pass:o,shader:u,descriptorSet:h})}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}}]),e}(),qS=new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.DEVICE),YS=new Vc(null),KS=new p_(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(VS||(VS={}));var QS=function(){function e(t){n(this,e),this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new $_,this._dss=new J_,this._rs=new Q_,this._priority=iv.DEFAULT,this._stage=tv.DEFAULT,this._phase=zS("default"),this._passID=4294967295,this._phaseID=4294967295,this._primitive=uc.TRIANGLE_LIST,this._batchingScheme=VS.NONE,this._dynamicStates=_c.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._rootBufferDirty=!1,this._root=t,this._device=yf.gfxDevice}return s(e,[{key:"initialize",value:function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Fl.UNKNOWN,n=this._propertyHandleMap[e];return n?(i?n=jy(n,i):t&&(n=jy(n,Hy(n)-t)),n+t):0}},{key:"getBinding",value:function(t){var i=this.getHandle(t);return i?e.getBindingFromHandle(i):-1}},{key:"setUniform",value:function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),s=e.getOffsetFromHandle(t),a=this._getBlockView(r,n);Yy[r](a,i,s),this._rootBufferDirty=!0}},{key:"getUniform",value:function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),s=e.getOffsetFromHandle(t),a=this._getBlockView(r,n);return qy[r](a,i,s)}},{key:"setUniformArray",value:function(t,i){for(var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),s=D_(r)>>2,a=this._getBlockView(r,n),o=e.getOffsetFromHandle(t),u=0;u<i.length;u++,o+=s)null!==i[u]&&Yy[r](a,i[u],o);this._rootBufferDirty=!0}},{key:"bindTexture",value:function(e,t,i){this._descriptorSet.bindTexture(e,t,i||0)}},{key:"bindSampler",value:function(e,t,i){this._descriptorSet.bindSampler(e,t,i||0)}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(){console.warn("base pass cannot override states, please use pass instance instead.")}},{key:"_setRootBufferDirty",value:function(e){this._rootBufferDirty=e}},{key:"update",value:function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()):ue(12006)}},{key:"getInstancedBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._instancedBuffers[e]||(this._instancedBuffers[e]=new XS(this))}},{key:"getBatchedBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._batchedBuffers[e]||(this._batchedBuffers[e]=new jS(this))}},{key:"destroy",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var i in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[i].destroy();for(var n in this._batchedBuffers)this._batchedBuffers[n].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy()}},{key:"resetUniform",value:function(t){var i=this.getHandle(t);if(i){for(var n=e.getTypeFromHandle(i),r=e.getBindingFromHandle(i),s=e.getOffsetFromHandle(i),a=e.getCountFromHandle(i),o=this._getBlockView(n,r),u=this._properties[t],h=u&&u.value||Jy(n),l=(D_(n)>>2)*a,c=0;c+h.length<=l;c+=h.length)o.set(h,s+c);this._rootBufferDirty=!0}}},{key:"resetTexture",value:function(t,i){var n=this.getHandle(t);if(n){var r=e.getTypeFromHandle(n),s=e.getBindingFromHandle(n),a=this._properties[t],o=a&&a.value,u=o?"".concat(o).concat(Zy(r)):Jy(r),h=HS.get(u),l=h&&h.getGFXTexture(),c=a&&void 0!==a.samplerHash?sf.unpackFromHash(a.samplerHash):h&&h.getSamplerInfo(),_=this._device.getSampler(c);this._descriptorSet.bindSampler(s,_,i||0),this._descriptorSet.bindTexture(s,l,i||0)}}},{key:"resetUBOs",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],i=0,n=0;n<t.members.length;n++){for(var r=t.members[n],s=this._getBlockView(r.type,t.binding),a=this._properties[r.name],o=a&&a.value||Jy(r.type),u=(D_(r.type)>>2)*r.count,h=0;h+o.length<=u;h+=o.length)s.set(o,i+h);i+=u}this._rootBufferDirty=!0}},{key:"resetTextures",value:function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],i=0;i<t.count;i++)this.resetTexture(t.name,i)}},{key:"tryCompile",value:function(){var t=this._root.pipeline;if(!t)return!1;if(this._syncBatchingScheme(),B.rendering&&B.rendering.enableEffectImport){var i=B.rendering.programLib,n=i.getProgramVariant(this._device,this._phaseID,this._programName,this._defines);if(!n)return console.warn("create shader ".concat(this._programName," failed")),!1;this._shader=n.shader,this._pipelineLayout=i.getPipelineLayout(this.device,this._phaseID,this._programName)}else{var r=vg.getGFXShader(this._device,this._programName,this._defines,t);if(!r)return console.warn("create shader ".concat(this._programName," failed")),!1;this._shader=r,this._pipelineLayout=vg.getTemplateInfo(this._programName).pipelineLayout}return this._hash=e.getPassHash(this),!0}},{key:"getShaderVariant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,i=0;i<e.length;i++){var n=e[i];this._defines[n.name]=n.value}var r=null;if(B.rendering&&B.rendering.enableEffectImport){var s=B.rendering.programLib.getProgramVariant(this._device,this._phaseID,this._programName,this._defines);s&&(r=s.shader)}else r=vg.getGFXShader(this._device,this._programName,this._defines,t);for(var a=0;a<e.length;a++){var o=e[a];delete this._defines[o.name]}return r}},{key:"beginChangeStatesSilently",value:function(){}},{key:"endChangeStatesSilently",value:function(){}},{key:"_doInit",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._priority=iv.DEFAULT,this._stage=tv.DEFAULT,B.rendering&&B.rendering.enableEffectImport){var n=B.rendering;if("number"==typeof t.phase?(this._passID=t._passID,this._phaseID=t._phaseID):(this._passID=n.getPassID(t.pass),this._passID!==n.INVALID_ID&&(this._phaseID=n.getPhaseID(this._passID,t.phase))),this._passID===n.INVALID_ID)return void console.error("Invalid render pass, program: ".concat(t.program));if(this._phaseID===n.INVALID_ID)return void console.error("Invalid render phase, program: ".concat(t.program))}this._phase=zS("default"),this._primitive=uc.TRIANGLE_LIST,this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=i?u({},t.defines):t.defines,B.rendering&&B.rendering.enableEffectImport?this._shaderInfo=B.rendering.programLib.getProgramInfo(this._phaseID,this._programName):this._shaderInfo=vg.getTemplate(t.program),this._properties=t.properties||this._properties;var r=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),B.rendering&&B.rendering.enableEffectImport?KS.layout=B.rendering.programLib.getMaterialDescriptorSetLayout(this._device,this._phaseID,t.program):KS.layout=vg.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(KS);var s,a,o=this._shaderInfo.blocks;if(B.rendering&&B.rendering.enableEffectImport){var h=B.rendering.programLib;s=h.getBlockSizes(this._phaseID,this._programName),a=h.getHandleMap(this._phaseID,this._programName)}else{var l=vg.getTemplateInfo(t.program);s=l.blockSizes,a=l.handleMap}if(B.rendering&&B.rendering.enableEffectImport){var c=B.rendering.programLib,_=c.getShaderInfo(this._phaseID,this.program);this._buildMaterialUniformBlocks(r,_.blocks,s)}else this._buildUniformBlocks(r,o,s);var f=this._propertyHandleMap=a,d={};for(var m in this._properties){var p=this._properties[m];p.handleInfo&&(d[m]=this.getHandle.apply(this,p.handleInfo))}Object.assign(f,d)}},{key:"_buildUniformBlocks",value:function(e,t,i){for(var n=e.capabilities.uboOffsetAlignment,r=[],s=0,a=0,o=0;o<t.length;o++){var u=i[o];r.push(a),a+=Math.ceil(u/n)*n,s=u}var h=r[r.length-1]+s;h&&(qS.size=16*Math.ceil(h/16),this._rootBuffer=e.createBuffer(qS),this._rootBlock=new ArrayBuffer(h));for(var l=0,c=0;l<t.length;l++){var _=t[l].binding,f=i[l];YS.buffer=this._rootBuffer,YS.offset=r[c++],YS.range=16*Math.ceil(f/16);var d=this._buffers[_]=e.createBuffer(YS);this._blocks[_]=new Float32Array(this._rootBlock,YS.offset,f/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[_]=new Int32Array(this._blocks[_].buffer,this._blocks[_].byteOffset,this._blocks[_].length),this._descriptorSet.bindBuffer(_,d)}}},{key:"_buildMaterialUniformBlocks",value:function(e,t,i){for(var n=e.capabilities.uboOffsetAlignment,r=[],s=0,a=0,o=0;o<t.length;o++)if(1===t[o].set){var u=i[o];r.push(a),a+=Math.ceil(u/n)*n,s=u}if(0!==s){var h=r[r.length-1]+s;h&&(qS.size=16*Math.ceil(h/16),this._rootBuffer=e.createBuffer(qS),this._rootBlock=new ArrayBuffer(h))}for(var l=0,c=0;l<t.length;l++)if(1===t[l].set){var _=t[l].binding,f=i[l];YS.buffer=this._rootBuffer,YS.offset=r[c++],YS.range=16*Math.ceil(f/16);var d=this._buffers[_]=e.createBuffer(YS);this._blocks[_]=new Float32Array(this._rootBlock,YS.offset,f/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[_]=new Int32Array(this._blocks[_].buffer,this._blocks[_].byteOffset,this._blocks[_].length),this._descriptorSet.bindBuffer(_,d)}}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_INSTANCING?this._device.hasFeature(Dl.INSTANCED_ARRAYS)?this._batchingScheme=VS.INSTANCING:(this._defines.USE_INSTANCING=!1,this._batchingScheme=VS.NONE):this._defines.USE_BATCHING?this._batchingScheme=VS.VB_MERGING:this._batchingScheme=VS.NONE}},{key:"_getBlockView",value:function(e,t){return e<Fl.FLOAT?this._blocksInt[t]:this._blocks[t]}},{key:"_initPassFromTarget",value:function(e,t,i){this._priority=e.priority,this._stage=e.stage,this._phase=e.phase,this._phaseID=e._phaseID,this._passID=e._passID,this._batchingScheme=e.batchingScheme,this._primitive=e.primitive,this._dynamicStates=e.dynamicStates,this._bs=e.blendState,this._dss=t,this._descriptorSet=e.descriptorSet,this._rs=e.rasterizerState,this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,B.rendering&&B.rendering.enableEffectImport?this._pipelineLayout=B.rendering.programLib.getPipelineLayout(this.device,this._phaseID,this._programName):this._pipelineLayout=vg.getTemplateInfo(this._programName).pipelineLayout,this._hash=e._hash^i}},{key:"_updatePassHash",value:function(){this._hash=e.getPassHash(this)}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return B.rendering&&B.rendering.enableEffectImport?B.rendering.programLib.getLocalDescriptorSetLayout(this._device,this._phaseID,this._programName):vg.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"passID",get:function(){return this._passID}},{key:"phaseID",get:function(){return this._phaseID}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}],[{key:"fillPipelineInfo",value:function(e,t){void 0!==t.priority&&(e._priority=t.priority),void 0!==t.primitive&&(e._primitive=t.primitive),void 0!==t.stage&&(e._stage=t.stage),void 0!==t.dynamicStates&&(e._dynamicStates=t.dynamicStates),void 0!==t.phase&&(e._phase=zS(t.phase));var i=e._bs;if(t.blendState){var n=t.blendState,r=n.targets;r&&r.forEach((function(e,t){i.setTarget(t,e)})),void 0!==n.isA2C&&(i.isA2C=n.isA2C),void 0!==n.isIndepend&&(i.isIndepend=n.isIndepend),void 0!==n.blendColor&&(i.blendColor=n.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)}},{key:"getPassHash",value:function(e){var t="";if(B.rendering&&B.rendering.enableEffectImport){var i=B.rendering.programLib.getKey(e._phaseID,e.program,e.defines);t="".concat(e._phaseID.toString(),",").concat(i)}else t=vg.getKey(e.program,e.defines);var n,r="".concat(t,",").concat(e._primitive,",").concat(e._dynamicStates);return r+=function(e){for(var t,i=",bs,".concat(e.isA2C),n=R(e.targets);!(t=n()).done;){var r=t.value;i+=",bt,".concat(r.blend,",").concat(r.blendEq,",").concat(r.blendAlphaEq,",").concat(r.blendColorMask),i+=",".concat(r.blendSrc,",").concat(r.blendDst,",").concat(r.blendSrcAlpha,",").concat(r.blendDstAlpha)}return i}(e._bs),r+=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),(t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack))+",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)}(e._dss),bl(r+=(n=e._rs,",rs,".concat(n.cullMode,",").concat(n.depthBias,",").concat(n.isFrontFaceCCW)),666)}}]),e}();QS.getTypeFromHandle=Hy,QS.getBindingFromHandle=zy,QS.getCountFromHandle=Wy,QS.getOffsetFromHandle=Xy;var JS=e("PipelineStateManager",function(){function e(){n(this,e)}return s(e,null,[{key:"getOrCreatePipelineState",value:function(e,t,i,n,r){var s=t.hash^n.hash^r.attributesHash^i.typedID,a=this._PSOHashMap.get(s);if(!a){var o=t.pipelineLayout,u=new y_(r.attributes),h=new ef(i,o,n,u,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(h),this._PSOHashMap.set(s,a)}return a}}]),e}());JS._PSOHashMap=new Map;var ZS=new Oc,$S=new xc;function eA(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var tA,iA,nA,rA,sA,aA,oA,uA,hA,lA=null;function cA(){return lA}function _A(e,t,i,n,r){if(!Ly()&&n&&n.enabled&&r===lA){var s=n.subModels[0],a=s.inputAssembler,o=s.passes,u=s.shaders,h=s.descriptorSet;ZS.width=$S.width=r.window.width,ZS.height=$S.height=r.window.height;var l=JS.getOrCreatePipelineState(e,o[0],u[0],t,a);i.setViewport(ZS),i.setScissor($S),i.bindPipelineState(l),i.bindDescriptorSet(_v.MATERIAL,o[0].descriptorSet),i.bindDescriptorSet(_v.LOCAL,h),i.bindInputAssembler(a),i.draw(a)}}var fA=new en,dA=e("Material",(tA=Hs("cc.Material"),iA=Aa(gg),tA((rA=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._effectAsset=sA&&sA(),e._techIdx=aA&&aA(),e._defines=oA&&oA(),e._states=uA&&uA(),e._props=hA&&hA(),e._passes=[],e._hash=0,e}return s(i,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}},{key:"initialize",value:function(e){this._passes.length?ae(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){return this._doDestroy(),g(l(i.prototype),"destroy",this).call(this)}},{key:"recompileShaders",value:function(){console.warn("Shaders in material asset '".concat(this.name,"' cannot be modified at runtime, please instantiate the material first."))}},{key:"overridePipelineStates",value:function(){console.warn("Pipeline states in material asset '".concat(this.name,"' cannot be modified at runtime, please instantiate the material first."))}},{key:"onLoaded",value:function(){this._update()}},{key:"resetUniforms",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var i,n=R(this._passes);!(i=n()).done;){var r=i.value;r.resetUBOs(),r.resetTextures()}}},{key:"setProperty",value:function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,s=r.length,a=0;a<s;a++){var o=r[a];this._uploadProperty(o,e,t)&&(this._props[o.propertyIndex][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var u=this._passes[i];this._uploadProperty(u,e,t)&&(this._props[u.propertyIndex][e]=t,n=!0)}n||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++){var s=i[r];if(e in s)return s[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null}},{key:"copy",value:function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var i=0;i<e._props.length;i++)this._props[i]=u({},e._props[i]);this._defines.length=e._defines.length;for(var n=0;n<e._defines.length;n++)this._defines[n]=u({},e._defines[n]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=u({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()}},{key:"_fillInfo",value:function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=gg.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)}},{key:"_prepareInfo",value:function(e,t){var i=e;if(!Array.isArray(i)){var n=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(n).fill(i)}for(var r=0;r<i.length;++r)Object.assign(t[r]||(t[r]={}),i[r])}},{key:"_createPasses",value:function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,i=[],n=0;n<t;++n){var r=e.passes[n],s=r.passIndex=n,a=r.defines=this._defines[s]||(this._defines[s]={});if(r.stateOverrides=this._states[s]||(this._states[s]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var o=new QS(B.director.root);o.initialize(r),i.push(o)}}return i}},{key:"_update",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._effectAsset){this._passes=this._createPasses();var n=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=n,t)this._passes.forEach((function(t,i){var n=e._props[i];for(var r in n||(n=e._props[i]={}),void 0!==t.propertyIndex&&Object.assign(n,e._props[t.propertyIndex]),n)e._uploadProperty(t,r,n[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=i.getHash(this)}},{key:"_uploadProperty",value:function(e,t,i){var n=e.getHandle(t);if(!n)return!1;if(QS.getTypeFromHandle(n)<Fl.SAMPLER1D)if(Array.isArray(i))e.setUniformArray(n,i);else if(null!==i){var r;if(null!==(r=e.properties[t])&&void 0!==r&&r.linear){var s=i;eA(fA,s),fA.w=s.w,i=fA}e.setUniform(n,i)}else e.resetUniform(t);else if(Array.isArray(i))for(var a=0;a<i.length;a++)this._bindTexture(e,n,i[a],a);else i?this._bindTexture(e,n,i):e.resetTexture(t);return!0}},{key:"_bindTexture",value:function(e,t,i,n){var r=QS.getBindingFromHandle(t);if(i instanceof of)e.bindTexture(r,i,n);else if(i instanceof kd){var s=i.getGFXTexture();if(!s||!s.width||!s.height)return;e.bindTexture(r,s,n),e.bindSampler(r,i.getGFXSampler(),n)}}},{key:"_doDestroy",value:function(){if(this._passes&&this._passes.length)for(var e,t=R(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0}},{key:"initDefault",value:function(e){g(l(i.prototype),"initDefault",this).call(this,e),this.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0},technique:0}),this.setProperty("mainColor",new cn("#ff00ff"))}},{key:"validate",value:function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0}}],[{key:"getHash",value:function(e){for(var t,i=0,n=R(e.passes);!(t=n()).done;)i^=t.value.hash;return i}}]),i}(ed),sA=Ms(rA.prototype,"_effectAsset",[iA],(function(){return null})),aA=Ms(rA.prototype,"_techIdx",[Js],(function(){return 0})),oA=Ms(rA.prototype,"_defines",[Js],(function(){return[]})),uA=Ms(rA.prototype,"_states",[Js],(function(){return[]})),hA=Ms(rA.prototype,"_props",[Js],(function(){return[]})),nA=rA))||nA));B.Material=dA;var mA=wt({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),pA=wt({Planar:0,ShadowMap:1}),vA=wt({HARD:0,SOFT:1,SOFT_2X:2,SOFT_4X:3}),yA=wt({LEVEL_1:1,LEVEL_2:2,LEVEL_3:3,LEVEL_4:4}),gA=wt({NONE:1,RemoveDuplicates:2,DisableRotationFix:3}),SA=pA.ShadowMap+1,AA=function(){function e(){n(this,e),this.fixedSphere=new dr(0,0,0,.01),this.maxReceived=4,this._matLight=new Cn,this._material=null,this._instancingMaterial=null,this._enabled=!1,this._type=SA,this._distance=0,this._normal=new an(0,1,0),this._shadowColor=new cn(0,0,0,76),this._size=new In(1024,1024),this._shadowMapDirty=!1}return s(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,this.activate()}},{key:"type",get:function(){return this._type},set:function(e){this._type=this.enabled?e:SA,this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){an.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"getPlanarShader",value:function(e){this._material||(this._material=new dA,this._material.initialize({effectName:"pipeline/planar-shadow"}));var t=this._material.passes;return t.length>0?t[0].getShaderVariant(e):null}},{key:"getPlanarInstanceShader",value:function(e){this._instancingMaterial||(this._instancingMaterial=new dA,this._instancingMaterial.initialize({effectName:"pipeline/planar-shadow",defines:{USE_INSTANCING:!0}}));var t=this._instancingMaterial.passes;return t.length>0?t[0].getShaderVariant(e):null}},{key:"initialize",value:function(e){this._enabled=e.enabled,this._type=this.enabled?e.type:SA,this.normal=e.planeDirection,this.distance=e.planeHeight,this.shadowColor=e.shadowColor,this.maxReceived=e.maxReceived,e.shadowMapSize!==this._size.x&&(this.size.set(e.shadowMapSize,e.shadowMapSize),this._shadowMapDirty=!0)}},{key:"activate",value:function(){if(this._enabled)if(this.type===pA.Planar)this._updatePlanarInfo();else{var e=B.director.root;e.pipeline.macros.CC_SHADOW_TYPE=2,e.onGlobalPipelineStateChanged()}else{var t=B.director.root;t.pipeline.macros.CC_SHADOW_TYPE=0,t.onGlobalPipelineStateChanged()}}},{key:"_updatePlanarInfo",value:function(){this._material||(this._material=new dA,this._material.initialize({effectName:"pipeline/planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new dA,this._instancingMaterial.initialize({effectName:"pipeline/planar-shadow",defines:{USE_INSTANCING:!0}}));var e=B.director.root;e.pipeline.macros.CC_SHADOW_TYPE=1,e.onGlobalPipelineStateChanged()}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()}}]),e}();AA.MAX_FAR=2e3,AA.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),B.Shadows=AA;var TA=function(e){h(i,e);var t=v(i);function i(e,r){var s,a;n(this,i),(a=t.call(this,e.root))._parent=void 0,a._owner=void 0,a._dontNotify=!1,a._parent=e,a._owner=r,a._doInit(a._parent,!0);for(var o=0;o<a._shaderInfo.blocks.length;o++){var u=a._shaderInfo.blocks[o],h=a._blocks[u.binding],c=a._parent.blocks[u.binding];h.set(c)}a._rootBufferDirty=!0;for(var _=a._parent,f=0;f<a._shaderInfo.samplerTextures.length;f++)for(var d=a._shaderInfo.samplerTextures[f],p=0;p<d.count;p++){var v=_._descriptorSet.getSampler(d.binding,p),y=_._descriptorSet.getTexture(d.binding,p);a._descriptorSet.bindSampler(d.binding,v,p),a._descriptorSet.bindTexture(d.binding,y,p)}return g((s=m(a),l(i.prototype)),"tryCompile",s).call(s),a}return s(i,[{key:"parent",get:function(){return this._parent}},{key:"overridePipelineStates",value:function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),QS.fillPipelineInfo(this,e),QS.fillPipelineInfo(this,t),this._onStateChange()}},{key:"tryCompile",value:function(e){if(e&&!$y(this._defines,e))return!1;var t=g(l(i.prototype),"tryCompile",this).call(this);return this._onStateChange(),t}},{key:"beginChangeStatesSilently",value:function(){this._dontNotify=!0}},{key:"endChangeStatesSilently",value:function(){this._dontNotify=!1}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._batchingScheme=VS.NONE}},{key:"_onStateChange",value:function(){this._hash=QS.getPassHash(this),this._owner.onPassStateChange(this._dontNotify)}}]),i}(QS),EA=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this))._passes=[],r._parent=void 0,r._owner=void 0,r._subModelIdx=0,r._parent=e.parent,r._owner=e.owner||null,r._subModelIdx=e.subModelIdx||0,r.copy(r._parent),r}return s(i,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}},{key:"recompileShaders",value:function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var i,n=R(this._passes);!(i=n()).done;)i.value.tryCompile(e);else this._passes[t].tryCompile(e)}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n],s=this._states[n]||(this._states[n]={});for(var a in e)s[a]=e[a];r.overridePipelineStates(i[r.passIndex],s)}else{var o=this._states[t]||(this._states[t]={});for(var u in e)o[u]=e[u];this._passes[t].overridePipelineStates(i[t],o)}}}},{key:"destroy",value:function(){return this._doDestroy(),!0}},{key:"onPassStateChange",value:function(e){this._hash=dA.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}},{key:"_createPasses",value:function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new TA(t[i],this));return e}}]),i}(dA),bA=null,CA=null,RA=wt({HEMISPHERE_DIFFUSE:0,AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION:1,DIFFUSEMAP_WITH_REFLECTION:2}),xA=function(){function e(){n(this,e),this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1,this._editableMaterial=null,this._activated=!1,this._reflectionHDR=null,this._reflectionLDR=null,this._rotationAngle=0}return s(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._useHDR=e,this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"useConvolutionMap",get:function(){return this.reflectionMap?this.reflectionMap.isUsingOfflineMipmaps():!!this.envmap&&this.envmap.isUsingOfflineMipmaps()}},{key:"envmap",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"reflectionMap",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR:this._reflectionLDR}},{key:"initialize",value:function(e){this._activated=!1,this._enabled=e.enabled,this._useIBL=e.useIBL,this._useDiffuseMap=e.applyDiffuseMap,this._useHDR=e.useHDR}},{key:"setEnvMaps",value:function(e,t){this._envmapHDR=e,this._envmapLDR=t,this._updateGlobalBinding(),this._updatePipeline()}},{key:"setDiffuseMaps",value:function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()}},{key:"setSkyboxMaterial",value:function(e){e?(this._editableMaterial=new EA({parent:e}),this._editableMaterial.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE})):this._editableMaterial=null,this._updatePipeline()}},{key:"setReflectionMaps",value:function(e,t){this._reflectionHDR=e,this._reflectionLDR=t,this._updateGlobalBinding(),this._updatePipeline()}},{key:"setRotationAngle",value:function(e){this._rotationAngle=e}},{key:"getRotationAngle",value:function(){return this._rotationAngle}},{key:"updateMaterialRenderInfo",value:function(){this._updateGlobalBinding(),this._updatePipeline()}},{key:"activate",value:function(){var e=B.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=HS.get("default-cube-texture"),this._model||(this._model=B.director.root.createModel(B.renderer.scene.Model));var t=this._default.isRGBE;if(this._default.isUsingOfflineMipmaps(),this.envmap&&(t=this.envmap.isRGBE,this.envmap.isUsingOfflineMipmaps()),!CA){var i=new dA;i.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:t}}),CA=new EA({parent:i})}this.enabled&&(bA||(bA=B.utils.createMesh(B.primitives.box({width:2,height:2,length:2}))),this._editableMaterial?this._model.initSubModel(0,bA.renderingSubMeshes[0],this._editableMaterial):this._model.initSubModel(0,bA.renderingSubMeshes[0],CA)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline(),this._activated=!0}},{key:"_updatePipeline",value:function(){var e=B.director.root,t=e.pipeline,i=this.useIBL?this.isRGBE?2:1:0,n=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR,s=this.useConvolutionMap;if(t.macros.CC_USE_IBL===i&&t.macros.CC_USE_DIFFUSEMAP===n&&t.macros.CC_USE_HDR===r&&t.macros.CC_IBL_CONVOLUTED===s||(t.macros.CC_USE_IBL=i,t.macros.CC_USE_DIFFUSEMAP=n,t.macros.CC_USE_HDR=r,t.macros.CC_IBL_CONVOLUTED=s,this._activated&&e.onGlobalPipelineStateChanged()),this.enabled){var a=this.envmap?this.envmap:this._default,o=this._editableMaterial?this._editableMaterial:CA;o&&(o.setProperty("environmentMap",a),o.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE})),this._model&&(this._model.setSubModelMaterial(0,o),this._updateSubModes())}}},{key:"_updateGlobalBinding",value:function(){if(this._globalDSManager){var e=yf.gfxDevice;if(this.reflectionMap){var t=this.reflectionMap.getGFXTexture(),i=e.getSampler(this.reflectionMap.getSamplerInfo());this._globalDSManager.bindSampler(bv,i),this._globalDSManager.bindTexture(bv,t)}else{var n=this.envmap?this.envmap:this._default;if(n){var r=n.getGFXTexture(),s=e.getSampler(n.getSamplerInfo());this._globalDSManager.bindSampler(bv,s),this._globalDSManager.bindTexture(bv,r)}}var a=this.diffuseMap?this.diffuseMap:this._default;if(a){var o=a.getGFXTexture(),u=e.getSampler(a.getSamplerInfo());this._globalDSManager.bindSampler(xv,u),this._globalDSManager.bindTexture(xv,o)}this._globalDSManager.update()}}},{key:"_updateSubModes",value:function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;t++)e[t].update()}}]),e}();B.Skybox=xA;var wA,kA,IA,BA,PA,MA,OA,DA,LA,NA,FA,GA,VA,UA,HA,zA,WA,XA,jA,qA,YA,KA,QA,JA,ZA,$A,eT,tT,iT,nT,rT,sT,aT,oT,uT,hT,lT,cT,_T,fT,dT,mT,pT,vT,yT,gT,ST,AT,TT,ET,bT,CT,RT,xT,wT,kT,IT,BT,PT,MT,OT,DT,LT,NT,FT,GT,VT,UT,HT,zT,WT,XT,jT,qT,YT,KT,QT,JT,ZT,$T,eE,tE,iE,nE,rE,sE,aE,oE,uE,hE,lE,cE,_E,fE,dE,mE,pE,vE,yE,gE,SE,AE,TE,EE,bE,CE,RE,xE,wE,kE,IE,BE,PE=new en,ME=wt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),OE=ME.LAYERED+1,DE=function(){function e(){n(this,e),this._fogColor=new cn("#C8C8C8"),this._colorArray=new en(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._activated=!1}return s(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,e?this.activate():(this._type=OE,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate=e,this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),PE.set(e.x,e.y,e.z,e.w),eA(this._colorArray,PE)}},{key:"type",get:function(){return this._type},set:function(e){this._type=this.enabled?e:OE,this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"initialize",value:function(e){this._activated=!1,this.fogColor=e.fogColor,this._enabled=e.enabled,this._type=this.enabled?e.type:OE,this._accurate=e.accurate,this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange}},{key:"activate",value:function(){this._updatePipeline(),this._activated=!0}},{key:"_updatePipeline",value:function(){var e=B.director.root,t=this.enabled?this.type:OE,i=this.accurate?1:0,n=e.pipeline;n.macros.CC_USE_FOG===t&&n.macros.CC_USE_ACCURATE_FOG===i||(n.macros.CC_USE_FOG=t,n.macros.CC_USE_ACCURATE_FOG=i,this._activated&&e.onGlobalPipelineStateChanged())}}]),e}();B.Fog=DE;var LE=new an(0,1,0),NE=new an,FE=new en,GE=new cn,VE=new vn,UE=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},HE=e("AmbientInfo",(wA=Hs("cc.AmbientInfo"),kA=Aa(si),IA=Zs("_skyColor"),BA=Zs("_skyIllum"),PA=Zs("_groundAlbedo"),wA((x((OA=function(){function e(){n(this,e),this._skyColorHDR=DA&&DA(),this._skyIllumHDR=LA&&LA(),this._groundAlbedoHDR=NA&&NA(),this._skyColorLDR=FA&&FA(),this._skyIllumLDR=GA&&GA(),this._groundAlbedoLDR=VA&&VA(),this._resource=null}return s(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=B.director.root.pipeline.pipelineSceneData.isHDR;return FE.set(e?this._skyColorHDR:this._skyColorLDR),UE(FE),GE.set(255*FE.x,255*FE.y,255*FE.z,255)},set:function(e){FE.set(e.x,e.y,e.z,e.w),B.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(FE):this._skyColorLDR.set(FE),this._resource&&this._resource.skyColor.set(FE)}},{key:"skyColor",set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=B.director.root.pipeline.pipelineSceneData.isHDR;return FE.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),UE(FE),GE.set(255*FE.x,255*FE.y,255*FE.z,255)},set:function(e){FE.set(e.x,e.y,e.z,e.w),B.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(FE):this._groundAlbedoLDR.set(FE),this._resource&&this._resource.groundAlbedo.set(FE)}},{key:"groundAlbedo",set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}},{key:"activate",value:function(e){this._resource=e,this._resource.initialize(this)}}]),e}()).prototype,"skyIllum",[kA],Object.getOwnPropertyDescriptor(OA.prototype,"skyIllum"),OA.prototype),DA=Ms(OA.prototype,"_skyColorHDR",[Js,IA],(function(){return new en(.2,.5,.8,1)})),LA=Ms(OA.prototype,"_skyIllumHDR",[Js,BA],(function(){return ev.SKY_ILLUM})),NA=Ms(OA.prototype,"_groundAlbedoHDR",[Js,PA],(function(){return new en(.2,.2,.2,1)})),FA=Ms(OA.prototype,"_skyColorLDR",[Js],(function(){return new en(.2,.5,.8,1)})),GA=Ms(OA.prototype,"_skyIllumLDR",[Js],(function(){return ev.SKY_ILLUM})),VA=Ms(OA.prototype,"_groundAlbedoLDR",[Js],(function(){return new en(.2,.2,.2,1)})),MA=OA))||MA));B.AmbientInfo=HE;var zE=e("SkyboxInfo",(UA=Hs("cc.SkyboxInfo"),HA=Aa(RA),zA=Aa(Zp),WA=Aa(si),XA=Aa(Zp),jA=Aa(Zp),qA=Aa(dA),YA=Aa(Zp),KA=Zs("_envmap"),QA=Aa(Zp),JA=Aa(Zp),ZA=Aa(Zp),$A=Aa(dA),eT=Aa(Zp),tT=Aa(Zp),UA((x((nT=function(){function e(){n(this,e),this._envLightingType=rT&&rT(),this._envmapHDR=sT&&sT(),this._envmapLDR=aT&&aT(),this._diffuseMapHDR=oT&&oT(),this._diffuseMapLDR=uT&&uT(),this._enabled=hT&&hT(),this._useHDR=lT&&lT(),this._editableMaterial=cT&&cT(),this._reflectionHDR=_T&&_T(),this._reflectionLDR=fT&&fT(),this._rotationAngle=dT&&dT(),this._resource=null}return s(e,[{key:"applyDiffuseMap",get:function(){return RA.DIFFUSEMAP_WITH_REFLECTION===this._envLightingType},set:function(e){this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"envLightingType",get:function(){return this._envLightingType},set:function(e){this.envmap||RA.HEMISPHERE_DIFFUSE===e?(RA.HEMISPHERE_DIFFUSE===e?(this.useIBL=!1,this.applyDiffuseMap=!1):RA.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION===e?(this.useIBL=!0,this.applyDiffuseMap=!1):RA.DIFFUSEMAP_WITH_REFLECTION===e&&(this.useIBL=!0,this.applyDiffuseMap=!0),this._envLightingType=e):(this.useIBL=!1,this.applyDiffuseMap=!1,this._envLightingType=RA.HEMISPHERE_DIFFUSE,ae(15001))}},{key:"useIBL",get:function(){return RA.HEMISPHERE_DIFFUSE!==this._envLightingType},set:function(e){this._resource&&(this._resource.useIBL=e)}},{key:"useHDR",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&this.envLightingType===RA.DIFFUSEMAP_WITH_REFLECTION&&(null===this.diffuseMap?(this.envLightingType=RA.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION,ae(15e3)):this.diffuseMap.isDefault&&ae(15002)),this._resource&&(this._resource.useHDR=this._useHDR,this._resource.updateMaterialRenderInfo())}},{key:"envmap",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){var t=B.director.root.pipeline.pipelineSceneData.isHDR;t?(this._envmapHDR=e,this._reflectionHDR=null):(this._envmapLDR=e,this._reflectionLDR=null),e||(t?this._diffuseMapHDR=null:this._diffuseMapLDR=null,this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=RA.HEMISPHERE_DIFFUSE,ae(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=e)}},{key:"rotationAngle",get:function(){return this._rotationAngle},set:function(e){this._rotationAngle=e,this._resource&&this._resource.setRotationAngle(this._rotationAngle)}},{key:"diffuseMap",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}},{key:"reflectionMap",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR:this._reflectionLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR=e:this._reflectionLDR=e,this._resource&&this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR)}},{key:"skyboxMaterial",get:function(){return this._editableMaterial},set:function(e){this._editableMaterial=e,this._resource&&this._resource.setSkyboxMaterial(this._editableMaterial)}},{key:"activate",value:function(e){this.envLightingType=this._envLightingType,this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setSkyboxMaterial(this._editableMaterial),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.setRotationAngle(this._rotationAngle),this._resource.activate()}}]),e}()).prototype,"envLightingType",[HA],Object.getOwnPropertyDescriptor(nT.prototype,"envLightingType"),nT.prototype),x(nT.prototype,"envmap",[zA],Object.getOwnPropertyDescriptor(nT.prototype,"envmap"),nT.prototype),x(nT.prototype,"rotationAngle",[WA],Object.getOwnPropertyDescriptor(nT.prototype,"rotationAngle"),nT.prototype),x(nT.prototype,"diffuseMap",[XA],Object.getOwnPropertyDescriptor(nT.prototype,"diffuseMap"),nT.prototype),x(nT.prototype,"reflectionMap",[jA],Object.getOwnPropertyDescriptor(nT.prototype,"reflectionMap"),nT.prototype),x(nT.prototype,"skyboxMaterial",[qA],Object.getOwnPropertyDescriptor(nT.prototype,"skyboxMaterial"),nT.prototype),rT=Ms(nT.prototype,"_envLightingType",[Js],(function(){return RA.HEMISPHERE_DIFFUSE})),sT=Ms(nT.prototype,"_envmapHDR",[Js,YA,KA],(function(){return null})),aT=Ms(nT.prototype,"_envmapLDR",[Js,QA],(function(){return null})),oT=Ms(nT.prototype,"_diffuseMapHDR",[Js,JA],(function(){return null})),uT=Ms(nT.prototype,"_diffuseMapLDR",[Js,ZA],(function(){return null})),hT=Ms(nT.prototype,"_enabled",[Js],(function(){return!1})),lT=Ms(nT.prototype,"_useHDR",[Js],(function(){return!0})),cT=Ms(nT.prototype,"_editableMaterial",[Js,$A],(function(){return null})),_T=Ms(nT.prototype,"_reflectionHDR",[Js,eT],(function(){return null})),fT=Ms(nT.prototype,"_reflectionLDR",[Js,tT],(function(){return null})),dT=Ms(nT.prototype,"_rotationAngle",[Js],(function(){return 0})),iT=nT))||iT));B.SkyboxInfo=zE;var WE=e("FogInfo",(mT=Hs("cc.FogInfo"),pT=Aa(ME),vT=Aa(si),yT=Aa(si),gT=Aa(si),ST=Aa(si),AT=Aa(si),TT=Aa(si),mT((LT=DT=function(){function e(){n(this,e),this._type=CT&&CT(),this._fogColor=RT&&RT(),this._enabled=xT&&xT(),this._fogDensity=wT&&wT(),this._fogStart=kT&&kT(),this._fogEnd=IT&&IT(),this._fogAtten=BT&&BT(),this._fogTop=PT&&PT(),this._fogRange=MT&&MT(),this._accurate=OT&&OT(),this._resource=null}return s(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}},{key:"activate",value:function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()}}]),e}(),DT.FogType=ME,x((bT=LT).prototype,"type",[pT],Object.getOwnPropertyDescriptor(bT.prototype,"type"),bT.prototype),x(bT.prototype,"fogDensity",[vT],Object.getOwnPropertyDescriptor(bT.prototype,"fogDensity"),bT.prototype),x(bT.prototype,"fogStart",[yT],Object.getOwnPropertyDescriptor(bT.prototype,"fogStart"),bT.prototype),x(bT.prototype,"fogEnd",[gT],Object.getOwnPropertyDescriptor(bT.prototype,"fogEnd"),bT.prototype),x(bT.prototype,"fogAtten",[ST],Object.getOwnPropertyDescriptor(bT.prototype,"fogAtten"),bT.prototype),x(bT.prototype,"fogTop",[AT],Object.getOwnPropertyDescriptor(bT.prototype,"fogTop"),bT.prototype),x(bT.prototype,"fogRange",[TT],Object.getOwnPropertyDescriptor(bT.prototype,"fogRange"),bT.prototype),CT=Ms(bT.prototype,"_type",[Js],(function(){return ME.LINEAR})),RT=Ms(bT.prototype,"_fogColor",[Js],(function(){return new cn("#C8C8C8")})),xT=Ms(bT.prototype,"_enabled",[Js],(function(){return!1})),wT=Ms(bT.prototype,"_fogDensity",[Js],(function(){return.3})),kT=Ms(bT.prototype,"_fogStart",[Js],(function(){return.5})),IT=Ms(bT.prototype,"_fogEnd",[Js],(function(){return 300})),BT=Ms(bT.prototype,"_fogAtten",[Js],(function(){return 5})),PT=Ms(bT.prototype,"_fogTop",[Js],(function(){return 1.5})),MT=Ms(bT.prototype,"_fogRange",[Js],(function(){return 1.2})),OT=Ms(bT.prototype,"_accurate",[Js],(function(){return!1})),ET=bT))||ET)),XE=e("ShadowsInfo",(NT=Hs("cc.ShadowsInfo"),FT=Aa(pA),GT=Aa(si),VT=Aa(ri),UT=Aa(mA),NT((x((zT=function(){function e(){n(this,e),this._enabled=WT&&WT(),this._type=XT&&XT(),this._normal=jT&&jT(),this._distance=qT&&qT(),this._shadowColor=YT&&YT(),this._maxReceived=KT&&KT(),this._size=QT&&QT(),this._resource=null}return s(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"planeDirection",get:function(){return this._normal},set:function(e){an.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"planeHeight",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(VE),this.planeDirection=an.transformQuat(NE,LE,VE),e.getWorldPosition(NE),this.planeHeight=an.dot(this._normal,NE)}},{key:"activate",value:function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()}}]),e}()).prototype,"type",[FT],Object.getOwnPropertyDescriptor(zT.prototype,"type"),zT.prototype),x(zT.prototype,"planeHeight",[GT],Object.getOwnPropertyDescriptor(zT.prototype,"planeHeight"),zT.prototype),x(zT.prototype,"maxReceived",[VT],Object.getOwnPropertyDescriptor(zT.prototype,"maxReceived"),zT.prototype),x(zT.prototype,"shadowMapSize",[UT],Object.getOwnPropertyDescriptor(zT.prototype,"shadowMapSize"),zT.prototype),WT=Ms(zT.prototype,"_enabled",[Js],(function(){return!1})),XT=Ms(zT.prototype,"_type",[Js],(function(){return pA.Planar})),jT=Ms(zT.prototype,"_normal",[Js],(function(){return new an(0,1,0)})),qT=Ms(zT.prototype,"_distance",[Js],(function(){return 0})),YT=Ms(zT.prototype,"_shadowColor",[Js],(function(){return new cn(0,0,0,76)})),KT=Ms(zT.prototype,"_maxReceived",[Js],(function(){return 4})),QT=Ms(zT.prototype,"_size",[Js],(function(){return new In(1024,1024)})),HT=zT))||HT));B.ShadowsInfo=XE;var jE=e("DEFAULT_WORLD_MIN_POS",new an(-1024,-1024,-1024)),qE=e("DEFAULT_WORLD_MAX_POS",new an(1024,1024,1024)),YE=e("DEFAULT_OCTREE_DEPTH",8),KE=e("OctreeInfo",(JT=Hs("cc.OctreeInfo"),ZT=Aa(ri),JT((x((eE=function(){function e(){n(this,e),this._enabled=tE&&tE(),this._minPos=iE&&iE(),this._maxPos=nE&&nE(),this._depth=rE&&rE(),this._resource=null}return s(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}},{key:"activate",value:function(e){this._resource=e,this._resource.initialize(this)}}]),e}()).prototype,"depth",[ZT],Object.getOwnPropertyDescriptor(eE.prototype,"depth"),eE.prototype),tE=Ms(eE.prototype,"_enabled",[Js],(function(){return!1})),iE=Ms(eE.prototype,"_minPos",[Js],(function(){return new an(jE)})),nE=Ms(eE.prototype,"_maxPos",[Js],(function(){return new an(qE)})),rE=Ms(eE.prototype,"_depth",[Js],(function(){return YE})),$T=eE))||$T));B.OctreeInfo=KE;var QE,JE,ZE,$E,eb,tb,ib,nb,rb,sb,ab,ob,ub,hb,lb,cb,_b,fb,db,mb,pb,vb,yb,gb,Sb,Ab,Tb,Eb,bb,Cb,Rb,xb,wb,kb,Ib,Bb,Pb,Mb,Ob,Db,Lb,Nb,Fb,Gb,Vb,Ub,Hb,zb,Wb,Xb,jb,qb,Yb,Kb,Qb,Jb,Zb,$b,eC,tC,iC,nC,rC,sC,aC,oC=e("LightProbeInfo",(sE=Hs("cc.LightProbeInfo"),aE=Aa(si),oE=Aa(ri),uE=Aa(ri),hE=Aa(si),sE((x((cE=function(){function e(){n(this,e),this._giScale=_E&&_E(),this._giSamples=fE&&fE(),this._bounces=dE&&dE(),this._reduceRinging=mE&&mE(),this._showProbe=pE&&pE(),this._showWireframe=vE&&vE(),this._showConvex=yE&&yE(),this._data=gE&&gE(),this._nodes=[],this._scene=null,this._resource=null}return s(e,[{key:"giScale",get:function(){return this._giScale},set:function(e){this._giScale!==e&&(this._giScale=e,this._resource&&(this._resource.giScale=e))}},{key:"giSamples",get:function(){return this._giSamples},set:function(e){this._giSamples!==e&&(this._giSamples=e,this._resource&&(this._resource.giSamples=e))}},{key:"bounces",get:function(){return this._bounces},set:function(e){this._bounces!==e&&(this._bounces=e,this._resource&&(this._resource.bounces=e))}},{key:"reduceRinging",get:function(){return this._reduceRinging},set:function(e){this._reduceRinging!==e&&(this._reduceRinging=e,this._resource&&(this._resource.reduceRinging=e))}},{key:"showProbe",get:function(){return this._showProbe},set:function(e){this._showProbe!==e&&(this._showProbe=e,this._resource&&(this._resource.showProbe=e))}},{key:"showWireframe",get:function(){return this._showWireframe},set:function(e){this._showWireframe!==e&&(this._showWireframe=e,this._resource&&(this._resource.showWireframe=e))}},{key:"showConvex",get:function(){return this._showConvex},set:function(e){this._showConvex!==e&&(this._showConvex=e,this._resource&&(this._resource.showConvex=e))}},{key:"data",get:function(){return this._data},set:function(e){this._data!==e&&(this._data=e,this._resource&&(this._resource.data=e))}},{key:"activate",value:function(e,t){this._scene=e,this._resource=t,this._resource.initialize(this)}},{key:"onProbeBakeFinished",value:function(){this.onProbeBakingChanged(this._scene)}},{key:"onProbeBakeCleared",value:function(){this.clearSHCoefficients(),this.onProbeBakingChanged(this._scene)}},{key:"onProbeBakingChanged",value:function(e){if(e){e.emit(rp.LIGHT_PROBE_BAKING_CHANGED);for(var t=0;t<e.children.length;t++){var i=e.children[t];this.onProbeBakingChanged(i)}}}},{key:"clearSHCoefficients",value:function(){if(this._data){for(var e=this._data.probes,t=0;t<e.length;t++)e[t].coefficients.length=0;this.clearAllSHUBOs()}}},{key:"isUniqueNode",value:function(){return 1===this._nodes.length}},{key:"addNode",value:function(e){if(!e)return!1;for(var t=0;t<this._nodes.length;t++)if(this._nodes[t].node===e)return!1;return this._nodes.push({node:e,probes:null}),!0}},{key:"removeNode",value:function(e){if(!e)return!1;var t=this._nodes.findIndex((function(t){return t.node===e}));return-1!==t&&(this._nodes.splice(t,1),!0)}},{key:"syncData",value:function(e,t){for(var i=0;i<this._nodes.length;i++)if(this._nodes[i].node===e)return void(this._nodes[i].probes=t)}},{key:"update",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(B.internal.LightProbesData){this._data||(this._data=new B.internal.LightProbesData,this._resource&&(this._resource.data=this._data));for(var t=[],i=0;i<this._nodes.length;i++){var n=this._nodes[i].node,r=this._nodes[i].probes,s=n.worldPosition;if(r)for(var a=0;a<r.length;a++){var o=new an(0,0,0);an.add(o,r[a],s),t.push(o)}}var u=t.length;if(u<4)return this.resetAllTetraIndices(),void this._data.reset();this._data.updateProbes(t),e&&(this.resetAllTetraIndices(),this._data.updateTetrahedrons())}}},{key:"clearAllSHUBOs",value:function(){if(this._scene){var e=this._scene.renderScene;if(e)for(var t=e.models,i=0;i<t.length;i++)t[i].clearSHUBOs()}}},{key:"resetAllTetraIndices",value:function(){if(this._scene){var e=this._scene.renderScene;if(e)for(var t=e.models,i=0;i<t.length;i++)t[i].tetrahedronIndex=-1}}}]),e}()).prototype,"giScale",[aE],Object.getOwnPropertyDescriptor(cE.prototype,"giScale"),cE.prototype),x(cE.prototype,"giSamples",[oE],Object.getOwnPropertyDescriptor(cE.prototype,"giSamples"),cE.prototype),x(cE.prototype,"bounces",[uE],Object.getOwnPropertyDescriptor(cE.prototype,"bounces"),cE.prototype),x(cE.prototype,"reduceRinging",[hE],Object.getOwnPropertyDescriptor(cE.prototype,"reduceRinging"),cE.prototype),_E=Ms(cE.prototype,"_giScale",[Js],(function(){return 1})),fE=Ms(cE.prototype,"_giSamples",[Js],(function(){return 1024})),dE=Ms(cE.prototype,"_bounces",[Js],(function(){return 2})),mE=Ms(cE.prototype,"_reduceRinging",[Js],(function(){return 0})),pE=Ms(cE.prototype,"_showProbe",[Js],(function(){return!0})),vE=Ms(cE.prototype,"_showWireframe",[Js],(function(){return!0})),yE=Ms(cE.prototype,"_showConvex",[Js],(function(){return!1})),gE=Ms(cE.prototype,"_data",[Js],(function(){return null})),lE=cE))||lE)),uC=e("SceneGlobals",(SE=Hs("cc.SceneGlobals"),AE=Aa(zE),SE((EE=function(){function e(){n(this,e),this.ambient=bE&&bE(),this.shadows=CE&&CE(),this._skybox=RE&&RE(),this.fog=xE&&xE(),this.octree=wE&&wE(),this.lightProbeInfo=kE&&kE(),this.bakedWithStationaryMainLight=IE&&IE(),this.bakedWithHighpLightmap=BE&&BE()}return s(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}},{key:"activate",value:function(e){var t=B.director.root.pipeline.pipelineSceneData;this.skybox.activate(t.skybox),this.ambient.activate(t.ambient),this.shadows.activate(t.shadows),this.fog.activate(t.fog),this.octree.activate(t.octree),this.lightProbeInfo&&t.lightProbes&&this.lightProbeInfo.activate(e,t.lightProbes),B.director.root.onGlobalPipelineStateChanged()}}]),e}(),bE=Ms(EE.prototype,"ambient",[Js],(function(){return new HE})),CE=Ms(EE.prototype,"shadows",[Js],(function(){return new XE})),RE=Ms(EE.prototype,"_skybox",[Js],(function(){return new zE})),xE=Ms(EE.prototype,"fog",[Js],(function(){return new WE})),x(EE.prototype,"skybox",[AE],Object.getOwnPropertyDescriptor(EE.prototype,"skybox"),EE.prototype),wE=Ms(EE.prototype,"octree",[Js],(function(){return new KE})),kE=Ms(EE.prototype,"lightProbeInfo",[Js],(function(){return new oC})),IE=Ms(EE.prototype,"bakedWithStationaryMainLight",[Js],(function(){return!1})),BE=Ms(EE.prototype,"bakedWithHighpLightmap",[Js],(function(){return!1})),TE=EE))||TE));B.SceneGlobals=uC;var hC=Hs("cc.TargetInfo")((JE=function e(){n(this,e),this.localID=ZE&&ZE()},ZE=Ms(JE.prototype,"localID",[Js],(function(){return[]})),QE=JE))||QE,lC=($E=Hs("cc.TargetOverrideInfo"),eb=Aa(Ga),tb=Aa(hC),ib=Aa(Jp),nb=Aa(hC),$E((sb=function e(){n(this,e),this.source=ab&&ab(),this.sourceInfo=ob&&ob(),this.propertyPath=ub&&ub(),this.target=hb&&hb(),this.targetInfo=lb&&lb()},ab=Ms(sb.prototype,"source",[Js,eb],(function(){return null})),ob=Ms(sb.prototype,"sourceInfo",[Js,tb],(function(){return null})),ub=Ms(sb.prototype,"propertyPath",[Js],(function(){return[]})),hb=Ms(sb.prototype,"target",[Js,ib],(function(){return null})),lb=Ms(sb.prototype,"targetInfo",[Js,nb],(function(){return null})),rb=sb))||rb),cC=Hs("cc.CompPrefabInfo")((_b=function e(){n(this,e),this.fileId=fb&&fb()},fb=Ms(_b.prototype,"fileId",[Js],(function(){return""})),cb=_b))||cb,_C=(db=Hs("CCPropertyOverrideInfo"),mb=Aa(hC),db((vb=function(){function e(){n(this,e),this.targetInfo=yb&&yb(),this.propertyPath=gb&&gb(),this.value=Sb&&Sb()}return s(e,[{key:"isTarget",value:function(){}}]),e}(),yb=Ms(vb.prototype,"targetInfo",[Js,mb],(function(){return null})),gb=Ms(vb.prototype,"propertyPath",[Js],(function(){return[]})),Sb=Ms(vb.prototype,"value",[Js],null),pb=vb))||pb),fC=(Ab=Hs("cc.MountedChildrenInfo"),Tb=Aa(hC),Eb=Aa([Jp]),Ab((Cb=function(){function e(){n(this,e),this.targetInfo=Rb&&Rb(),this.nodes=xb&&xb()}return s(e,[{key:"isTarget",value:function(){}}]),e}(),Rb=Ms(Cb.prototype,"targetInfo",[Js,Tb],(function(){return null})),xb=Ms(Cb.prototype,"nodes",[Js,Eb],(function(){return[]})),bb=Cb))||bb),dC=(wb=Hs("cc.MountedComponentsInfo"),kb=Aa(hC),Ib=Aa([tm]),wb((Pb=function(){function e(){n(this,e),this.targetInfo=Mb&&Mb(),this.components=Ob&&Ob()}return s(e,[{key:"isTarget",value:function(){}}]),e}(),Mb=Ms(Pb.prototype,"targetInfo",[Js,kb],(function(){return null})),Ob=Ms(Pb.prototype,"components",[Js,Ib],(function(){return[]})),Bb=Pb))||Bb),mC=(Db=Hs("cc.PrefabInstance"),Lb=Aa(Jp),Nb=Aa([fC]),Fb=Aa([dC]),Gb=Aa([_C]),Vb=Aa([hC]),Db((Hb=function(){function e(){n(this,e),this.fileId=zb&&zb(),this.prefabRootNode=Wb&&Wb(),this.mountedChildren=Xb&&Xb(),this.mountedComponents=jb&&jb(),this.propertyOverrides=qb&&qb(),this.removedComponents=Yb&&Yb(),this.targetMap={},this.expanded=!1}return s(e,[{key:"findPropertyOverride",value:function(){}},{key:"removePropertyOverride",value:function(){}}]),e}(),zb=Ms(Hb.prototype,"fileId",[Js],(function(){return""})),Wb=Ms(Hb.prototype,"prefabRootNode",[Js,Lb],null),Xb=Ms(Hb.prototype,"mountedChildren",[Js,Nb],(function(){return[]})),jb=Ms(Hb.prototype,"mountedComponents",[Js,Fb],(function(){return[]})),qb=Ms(Hb.prototype,"propertyOverrides",[Js,Gb],(function(){return[]})),Yb=Ms(Hb.prototype,"removedComponents",[Js,Vb],(function(){return[]})),Ub=Hb))||Ub),pC=(Kb=Hs("cc.PrefabInfo"),Qb=Aa(Jp),Jb=Aa(mC),Zb=Aa([lC]),Kb((eC=function e(){n(this,e),this.root=tC&&tC(),this.asset=iC&&iC(),this.fileId=nC&&nC(),this.instance=rC&&rC(),this.targetOverrides=sC&&sC(),this.nestedPrefabInstanceRoots=aC&&aC()},tC=Ms(eC.prototype,"root",[Js,Qb],null),iC=Ms(eC.prototype,"asset",[Js],null),nC=Ms(eC.prototype,"fileId",[Js],(function(){return""})),rC=Ms(eC.prototype,"instance",[Js,Jb],null),sC=Ms(eC.prototype,"targetOverrides",[Js,Zb],null),aC=Ms(eC.prototype,"nestedPrefabInstanceRoots",[Js],null),$b=eC))||$b);function vC(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return ue(3701,e.name),void(t.instance=void 0);var i=e._objFlags,n=e._parent,r=e._id,s=e._prefab;e[Ea],B.game._isCloning=!0,t.asset._doInstantiate(e),B.game._isCloning=!1,e._objFlags=i,e._parent=n,e._id=r,e._prefab&&(e._prefab.instance=null==s?void 0:s.instance)}}function yC(e,t,i){var n;if(t&&e){var r=t,s=null===(n=e._prefab)||void 0===n?void 0:n.instance;!i&&s&&(t[s.fileId]={},r=t[s.fileId]);var a=e._prefab;a&&(r[a.fileId]=e);for(var o=e.components,u=0;u<o.length;u++){var h=o[u];h.__prefab&&(r[h.__prefab.fileId]=h)}for(var l=0;l<e.children.length;l++)yC(e.children[l],r,!1)}}function gC(e,t){if(!e)return null;for(var i=t,n=0;n<e.length;n++){if(!i)return null;i=i[e[n]]}return i}function SC(e,t,i){if(t)for(var n=0;n<t.length;n++){var r=t[n];if(r&&r.targetInfo){var s=gC(r.targetInfo.localID,i);if(!s)continue;var a=i,o=r.targetInfo.localID;if(o.length>0)for(var u=0;u<o.length-1;u++)a=a[o[u]];if(r.nodes)for(var h=0;h<r.nodes.length;h++){var l=r.nodes[h];l&&!s._children.includes(l)&&(s._children.push(l),l._parent=s,yC(l,a,!1),l._siblingIndex=s._children.length-1,CC(l,!0))}}}}function AC(e,t,i){if(t)for(var n=0;n<t.length;n++){var r=t[n];if(r&&r.targetInfo){var s=gC(r.targetInfo.localID,i);if(!s)continue;if(r.components)for(var a=0;a<r.components.length;a++){var o=r.components[a];o&&(o.node=s,s._components.push(o))}}}}function TC(e,t,i){if(t)for(var n=0;n<t.length;n++){var r=t[n];if(r){var s=gC(r.localID,i);if(!s||!s.node)continue;var a=s.node.components.indexOf(s);a>=0&&s.node._components.splice(a,1)}}}function EC(e,t,i){if(!(t.length<=0))for(var n=null,r=0;r<t.length;r++){var s=t[r];if(s&&s.targetInfo){if(!(n=gC(s.targetInfo.localID,i)))continue;var a=n,o=s.propertyPath.slice();if(o.length>0){var u=o.pop();if(!u)continue;for(var h=0;h<o.length&&(a=a[o[h]]);h++);if(!a)continue;if(Array.isArray(a))if("length"===u)a[u]=s.value;else{var l=Number.parseInt(u);Number.isInteger(l)&&l<a.length&&(a[u]=s.value)}else a[u]instanceof Mt?a[u].set(s.value):a[u]=s.value}}}}function bC(e){var t,i=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(i)for(var n=0;n<i.length;n++){var r,s,a=i[n],o=a.source,u=a.sourceInfo;if(u){var h,l,c=null===(h=a.source)||void 0===h||null===(l=h._prefab)||void 0===l?void 0:l.instance;c&&c.targetMap&&(o=gC(u.localID,c.targetMap))}if(o){var _,f=a.targetInfo;if(f){var d=null===(r=a.target)||void 0===r||null===(s=r._prefab)||void 0===s?void 0:s.instance;if(d&&d.targetMap&&(_=gC(f.localID,d.targetMap))){var m=a.propertyPath.slice(),p=o;if(m.length>0){var v=m.pop();if(!v)return;for(var y=0;y<m.length&&(p=p[m[y]]);y++);if(!p)continue;p[v]=_}}}}}}function CC(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=e._prefab,n=null==i?void 0:i.instance;if(n&&!n.expanded){vC(e),t&&e&&e.children&&e.children.forEach((function(e){CC(e,!0)}));var r={};n.targetMap=r,yC(e,r,!0),SC(0,n.mountedChildren,r),TC(0,n.removedComponents,r),AC(0,n.mountedComponents,r),EC(0,n.propertyOverrides,r),n.expanded=!0}else t&&e&&e.children&&e.children.forEach((function(e){CC(e,!0)}))}function RC(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){var t,i;CC(e),xC(e,null===(t=e._prefab)||void 0===t||null===(i=t.instance)||void 0===i?void 0:i.fileId)}))}function xC(e,t){for(var i=e.components,n=e.children,r=0;r<i.length;r++){var s,a,o=i[r],u=null!==(s=null===(a=o.__prefab)||void 0===a?void 0:a.fileId)&&void 0!==s?s:"";o._id="".concat(t).concat(u)}for(var h=0;h<n.length;h++){var l=n[h],c=l._prefab,_=null!=c&&c.instance?c.instance.fileId:null==c?void 0:c.fileId;_&&(l._id="".concat(t).concat(_),null!=c&&c.instance||xC(l,t))}}B._PrefabInfo=pC;var wC,kC,IC,BC,PC,MC,OC,DC=Object.freeze({__proto__:null,createNodeWithPrefab:vC,generateTargetMap:yC,getTarget:gC,applyMountedChildren:SC,applyMountedComponents:AC,applyRemovedComponents:TC,applyPropertyOverrides:EC,applyTargetOverrides:bC,expandPrefabInstanceNode:CC,expandNestedPrefabInstanceNode:RC,applyNodeAndComponentId:xC,TargetInfo:hC,TargetOverrideInfo:lC,CompPrefabInfo:cC,PropertyOverrideInfo:_C,MountedChildrenInfo:fC,MountedComponentsInfo:dC,PrefabInstance:mC,PrefabInfo:pC}),LC=e("Scene",Hs("cc.Scene")((kC=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this,e)).autoReleaseAssets=IC&&IC(),r._globals=BC&&BC(),r.dependAssets=null,r._renderScene=null,r._inited=void 0,r._prefabSyncedInLiveReload=!1,r._activeInHierarchy=!1,B.director&&B.director.root&&(r._renderScene=B.director.root.createScene({})),r._inited=!B.game||!B.game._isCloning,r}return s(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"_updateScene",value:function(){this._scene=this}},{key:"destroy",value:function(){var e=Ga.prototype.destroy.call(this);if(e)for(var t=this._children,i=0;i<t.length;++i)t[i].active=!1;return this._renderScene&&B.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e}},{key:"addComponent",value:function(){throw new Error(_e(3822))}},{key:"_onHierarchyChanged",value:function(){}},{key:"_onPostActivated",value:function(){}},{key:"_onBatchCreated",value:function(e){for(var t=this._children.length,i=0;i<t;++i)this._children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)}},{key:"updateWorldTransform",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(RC(this),bC(this),this._onBatchCreated(k),this._inited=!0),this.walk(Jp._setScene)}},{key:"_activate",value:function(e){e=!1!==e,B.director._nodeActivator.activateNode(this,e),this._globals.activate(this)}}]),i}(Jp),IC=Ms(kC.prototype,"autoReleaseAssets",[Js],(function(){return!1})),BC=Ms(kC.prototype,"_globals",[Js],(function(){return new uC})),wC=kC))||wC);B.Scene=LC;var NC=e("SceneAsset",Hs("cc.SceneAsset")((MC=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).scene=OC&&OC(),e}return s(i,[{key:"initDefault",value:function(e){g(l(i.prototype),"initDefault",this).call(this,e),this.scene=new LC("New Scene")}},{key:"validate",value:function(){return!!this.scene}}]),i}(ed),OC=Ms(MC.prototype,"scene",[Js],(function(){return null})),PC=MC))||PC);B.SceneAsset=NC,xe({SystemEventType:{newName:"Input.EventType",since:"3.3.0",removed:!1}}),xe({SystemEvent:{newName:"Input",since:"3.4.0",removed:!1},systemEvent:{newName:"input",since:"3.4.0",removed:!1}});var FC,GC,VC=e("Event",function(){function e(t,i){n(this,e),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!i}return s(e,[{key:"unuse",value:function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),e}());VC.NO_TYPE="no_type",VC.TOUCH="touch",VC.MOUSE="mouse",VC.KEYBOARD="keyboard",VC.ACCELERATION="acceleration",VC.NONE=0,VC.CAPTURING_PHASE=1,VC.AT_TARGET=2,VC.BUBBLING_PHASE=3,B.Event=VC,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(FC||(FC=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.GAMEPAD_INPUT="gamepad-input",e.GAMEPAD_CHANGE="gamepad-change",e.HANDLE_INPUT="handle-input",e.HANDLE_POSE_INPUT="handle-pose-input",e.HMD_POSE_INPUT="hmd-pose-input",e.HANDHELD_POSE_INPUT="handheld-pose-input"}(GC||(GC={})),B.SystemEventType=FC;var UC=e("EventAcceleration",function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,FC.DEVICEMOTION,r)).acc=void 0,s.acc=e,s}return i}(VC));VC.EventAcceleration=UC;var HC=e("EventKeyboard",function(e){h(i,e);var t=v(i);function i(e,r,s){var a;return n(this,i),"boolean"==typeof r&&(r=r?FC.KEY_DOWN:FC.KEY_UP),(a=t.call(this,r,s)).windowId=void 0,a.keyCode=void 0,a.rawEvent=void 0,a._isPressed=void 0,a._isPressed=r!==FC.KEY_UP,"number"==typeof e?a.keyCode=e:(a.keyCode=e.keyCode,a.rawEvent=e),a.windowId=0,a}return s(i,[{key:"isPressed",get:function(){return this._isPressed}}]),i}(VC));VC.EventKeyboard=HC;var zC=e("EventMouse",function(e){h(i,e);var t=v(i);function i(e,r,s,a){var o;return n(this,i),(o=t.call(this,e,r)).movementX=0,o.movementY=0,o.windowId=0,o.preventSwallow=!1,o._eventType=void 0,o._button=i.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=e,s&&(o._prevX=s.x,o._prevY=s.y),o.windowId=null!=a?a:o.windowId,o}return s(i,[{key:"eventType",get:function(){return this._eventType}},{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e||(e=new In),In.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e||(e=new In),In.set(e,this._x,B.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e||(e=new In),In.set(e,this._x,this._y),B.view._convertToUISpace(e),e}},{key:"getPreviousLocation",value:function(e){return e||(e=new In),In.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new In),In.set(e,this._prevX,this._prevY),B.view._convertToUISpace(e),e}},{key:"getDelta",value:function(e){return e||(e=new In),In.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e||(e=new In),In.set(e,(this._x-this._prevX)/B.view.getScaleX(),(this._y-this._prevY)/B.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/B.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/B.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=B.view.getViewportRect();return(this._x-e.x)/B.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=B.view.getViewportRect();return(this._y-e.y)/B.view.getScaleY()}}]),i}(VC));zC.BUTTON_MISSING=-1,zC.BUTTON_LEFT=0,zC.BUTTON_RIGHT=2,zC.BUTTON_MIDDLE=1,zC.BUTTON_4=3,zC.BUTTON_5=4,zC.BUTTON_6=5,zC.BUTTON_7=6,zC.BUTTON_8=7,VC.EventMouse=zC;var WC=new In,XC=e("EventTouch",function(e){h(i,e);var t=v(i);function i(e,r,s){var a,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return n(this,i),(a=t.call(this,s,r)).touch=null,a.simulate=!1,a.windowId=0,a.preventSwallow=!1,a._eventCode=void 0,a._touches=void 0,a._allTouches=void 0,a._eventCode=s,a._touches=e||[],a._allTouches=o,a}return s(i,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"getAllTouches",value:function(){return this._allTouches}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new In}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new In}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new In}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new In}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new In}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new In}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new In}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new In}},{key:"getDeltaX",value:function(){return this.touch?this.touch.getDelta(WC).x:0}},{key:"getDeltaY",value:function(){return this.touch?this.touch.getDelta(WC).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),i}(VC));XC.MAX_TOUCHES=5,VC.EventTouch=XC;var jC,qC=e("EventGamepad",function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,e,!1)).gamepad=void 0,s.gamepad=r,s}return i}(VC)),YC=e("EventHandle",function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,e,!1)).handleInputDevice=void 0,s.handleInputDevice=r,s}return i}(VC)),KC=(e("EventHMD",function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,e,!1)).hmdInputDevice=void 0,s.hmdInputDevice=r,s}return i}(VC)),e("EventHandheld",function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,e,!1)).handheldInputDevice=void 0,s.handheldInputDevice=r,s}return i}(VC)),e("Acceleration",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;n(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=i,this.z=r,this.timestamp=s})));!function(e){e[e.NONE=0]="NONE",e[e.MOBILE_BACK=6]="MOBILE_BACK",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(jC||(jC=e("KeyCode",{})));var QC=new In,JC=e("Touch",function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(this,e),this._point=new In,this._prevPoint=new In,this._lastModified=0,this._id=0,this._startPoint=new In,this._startPointCaptured=!1,this.setTouchInfo(r,t,i)}return s(e,[{key:"lastModified",get:function(){return this._lastModified}},{key:"getLocation",value:function(e){return e||(e=new In),e.set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return e||(e=new In),e.set(this._point.x,this._point.y),B.view._convertToUISpace(e),e}},{key:"getUILocationX",value:function(){var e=B.view.getViewportRect();return(this._point.x-e.x)/B.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=B.view.getViewportRect();return(this._point.y-e.y)/B.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return e||(e=new In),e.set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new In),e.set(this._prevPoint.x,this._prevPoint.y),B.view._convertToUISpace(e),e}},{key:"getStartLocation",value:function(e){return e||(e=new In),e.set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return e||(e=new In),e.set(this._startPoint.x,this._startPoint.y),B.view._convertToUISpace(e),e}},{key:"getDelta",value:function(e){return e||(e=new In),e.set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e||(e=new In),QC.set(this._point),QC.subtract(this._prevPoint),e.set(B.view.getScaleX(),B.view.getScaleY()),In.divide(e,QC,e),e}},{key:"getLocationInView",value:function(e){return e||(e=new In),e.set(this._point.x,B.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return e||(e=new In),e.set(this._prevPoint.x,B.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return e||(e=new In),e.set(this._startPoint.x,B.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;this._prevPoint=this._point,this._point=new In(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new In(this._point),this._startPointCaptured=!0)}},{key:"setPoint",value:function(e,t){"object"===i(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=B.game.frameStartTime}},{key:"setPrevPoint",value:function(e,t){"object"===i(e)?this._prevPoint=new In(e.x,e.y):this._prevPoint=new In(e||0,t||0),this._lastModified=B.game.frameStartTime}}]),e}());B.Touch=JC;var ZC,$C,eR,tR=function(){function e(){n(this,e),this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new Hh,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,Qh.browserType===zh.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}return s(e,[{key:"_registerEvent",value:function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)}},{key:"_unregisterEvent",value:function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)}},{key:"_didAccelerate",value:function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var i=0,n=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var s=e.accelerationIncludingGravity;i=.1*((null==s?void 0:s.x)||0),n=.1*((null==s?void 0:s.y)||0),r=.1*((null==s?void 0:s.z)||0)}else{var a=e;i=(a.gamma||0)/90*.981,n=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(vl.isFrameRotated){var o=i;i=-n,n=o}var u=i;90===window.orientation?(i=-n,n=u):-90===window.orientation?(i=n,n=-u):180===window.orientation&&(i=-i,n=-n),Qh.os===jh.ANDROID&&Qh.browserType!==zh.MOBILE_QQ&&(i=-i,n=-n);var h=performance.now(),l=new KC(i,n,r,h),c=new UC(l);this._eventTarget.emit(GC.DEVICEMOTION,c)}}},{key:"start",value:function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()}},{key:"stop",value:function(){this._unregisterEvent()}},{key:"setInterval",value:function(e){this._intervalInMileSeconds=e}},{key:"on",value:function(e,t,i){this._eventTarget.on(e,t,i)}}]),e}(),iR=function e(){n(this,e)},nR=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"getValue",value:function(){throw new Error("Method not implemented.")}}]),i}(iR),rR=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"getValue",value:function(){throw new Error("Method not implemented.")}}]),i}(iR),sR=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"getValue",value:function(){throw new Error("Method not implemented.")}}]),i}(iR),aR=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"getValue",value:function(){throw new Error("Method not implemented.")}}]),i}(iR),oR=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this)).positive=void 0,r.negative=void 0,r.positive=e.positive,r.negative=e.negative,r}return s(i,[{key:"getValue",value:function(){var e=this.positive.getValue(),t=this.negative.getValue();return Math.abs(e)>Math.abs(t)?e:-t}}]),i}(nR),uR=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this)).up=void 0,r.down=void 0,r.left=void 0,r.right=void 0,r.xAxis=void 0,r.yAxis=void 0,r.up=e.up,r.down=e.down,r.left=e.left,r.right=e.right,r.xAxis=new oR({positive:r.right,negative:r.left}),r.yAxis=new oR({positive:r.up,negative:r.down}),r}return s(i,[{key:"getValue",value:function(){return new In(this.xAxis.getValue(),this.yAxis.getValue())}}]),i}(rR),hR=(function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this)).up=void 0,r.down=void 0,r.left=void 0,r.right=void 0,r.forward=void 0,r.backward=void 0,r.xAxis=void 0,r.yAxis=void 0,r.zAxis=void 0,r.up=e.up,r.down=e.down,r.left=e.left,r.right=e.right,r.forward=e.forward,r.backward=e.backward,r.xAxis=new oR({positive:r.right,negative:r.left}),r.yAxis=new oR({positive:r.up,negative:r.down}),r.zAxis=new oR({positive:r.forward,negative:r.backward}),r}s(i,[{key:"getValue",value:function(){return new an(this.xAxis.getValue(),this.yAxis.getValue(),this.zAxis.getValue())}}])}(sR),function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"getValue",value:function(){return g(l(i.prototype),"getValue",this).call(this)}}]),i}(nR)),lR=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(uR),cR=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(uR),_R=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"getValue",value:function(){return g(l(i.prototype),"getValue",this).call(this)}}]),i}(aR),fR=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"getValue",value:function(){return g(l(i.prototype),"getValue",this).call(this)}}]),i}(sR),dR=function(){function e(t){n(this,e),this._deviceId=-1,this._connected=!1,this._deviceId=t,this._initInputSource()}return s(e,[{key:"buttonNorth",get:function(){return this._buttonNorth}},{key:"buttonEast",get:function(){return this._buttonEast}},{key:"buttonWest",get:function(){return this._buttonWest}},{key:"buttonSouth",get:function(){return this._buttonSouth}},{key:"buttonL1",get:function(){return this._buttonL1}},{key:"buttonL2",get:function(){return this._buttonL2}},{key:"buttonL3",get:function(){return this._buttonL3}},{key:"buttonR1",get:function(){return this._buttonR1}},{key:"buttonR2",get:function(){return this._buttonR2}},{key:"buttonR3",get:function(){return this._buttonR3}},{key:"buttonShare",get:function(){return this._buttonShare}},{key:"buttonOptions",get:function(){return this._buttonOptions}},{key:"dpad",get:function(){return this._dpad}},{key:"leftStick",get:function(){return this._leftStick}},{key:"rightStick",get:function(){return this._rightStick}},{key:"buttonStart",get:function(){return this._buttonStart}},{key:"deviceId",get:function(){return this._deviceId}},{key:"connected",get:function(){return this._connected}},{key:"_axisToButtons",value:function(e){var t=Math.abs(e);return e>0?{negative:0,positive:t}:e<0?{negative:t,positive:0}:{negative:0,positive:0}}},{key:"_initInputSource",value:function(){var t=this;this._buttonNorth=new hR,this._buttonNorth.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[3].value:0},this._buttonEast=new hR,this._buttonEast.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[1].value:0},this._buttonWest=new hR,this._buttonWest.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[2].value:0},this._buttonSouth=new hR,this._buttonSouth.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[0].value:0},this._buttonL1=new hR,this._buttonL1.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[4].value:0},this._buttonL2=new hR,this._buttonL2.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[6].value:0},this._buttonL3=new hR,this._buttonL3.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[10].value:0},this._buttonR1=new hR,this._buttonR1.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[5].value:0},this._buttonR2=new hR,this._buttonR2.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[7].value:0},this._buttonR3=new hR,this._buttonR3.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[11].value:0},this._buttonShare=new hR,this._buttonShare.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[8].value:0},this._buttonOptions=new hR,this._buttonOptions.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[9].value:0};var i=new hR;i.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[12].value:0};var n=new hR;n.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[13].value:0};var r=new hR;r.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[14].value:0};var s=new hR;s.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?i.buttons[15].value:0},this._dpad=new lR({up:i,down:n,left:r,right:s});var a=new hR;a.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?t._axisToButtons(i.axes[1]).negative:0};var o=new hR;o.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?t._axisToButtons(i.axes[1]).positive:0};var u=new hR;u.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?t._axisToButtons(i.axes[0]).negative:0};var h=new hR;h.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?t._axisToButtons(i.axes[0]).positive:0},this._leftStick=new cR({up:a,down:o,left:u,right:h});var l=new hR;l.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?t._axisToButtons(i.axes[3]).negative:0};var c=new hR;c.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?t._axisToButtons(i.axes[3]).positive:0};var _=new hR;_.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?t._axisToButtons(i.axes[2]).negative:0};var f=new hR;f.getValue=function(){var i=e._getWebGamepad(t.deviceId);return i?t._axisToButtons(i.axes[2]).positive:0},this._rightStick=new cR({up:l,down:c,left:_,right:f}),this._buttonStart=new hR,this._buttonStart.getValue=function(){return 0}}}],[{key:"_init",value:function(){Qh.hasFeature(Yh.EVENT_GAMEPAD)&&e._registerEvent()}},{key:"_on",value:function(t,i,n){e._eventTarget.on(t,i,n)}},{key:"_removeInputDevice",value:function(t){var i=e.all.findIndex((function(e){return e.deviceId===t}));-1!==i&&gt(e.all,i)}},{key:"_getOrCreateInputDevice",value:function(t,i){var n=e.all.find((function(e){return e.deviceId===t}));return n||(n=new e(t),e.all.push(n)),n._connected=i,n}},{key:"_ensureDirectorDefined",value:function(){return new Promise((function(t){e._intervalId=setInterval((function(){B.director&&B.Director&&(clearInterval(e._intervalId),e._intervalId=-1,t())}),50)}))}},{key:"_registerEvent",value:function(){e._ensureDirectorDefined().then((function(){B.director.on(B.Director.EVENT_BEGIN_FRAME,e._scanGamepads)})).catch((function(){})),window.addEventListener("gamepadconnected",(function(t){e._cachedWebGamepads[t.gamepad.index]=t.gamepad;var i=e._getOrCreateInputDevice(t.gamepad.index,!0);e._eventTarget.emit(GC.GAMEPAD_CHANGE,new qC(GC.GAMEPAD_CHANGE,i))})),window.addEventListener("gamepaddisconnected",(function(t){e._cachedWebGamepads[t.gamepad.index]=null;var i=e._getOrCreateInputDevice(t.gamepad.index,!1);e._removeInputDevice(t.gamepad.index),e._eventTarget.emit(GC.GAMEPAD_CHANGE,new qC(GC.GAMEPAD_CHANGE,i))}))}},{key:"_scanGamepads",value:function(){var t=e._getWebGamePads();if(t){for(var i=[],n=0;n<t.length;++n){var r=null==t?void 0:t[n];if(r){var s=e._cachedWebGamepads[r.index];if(s){for(var a=void 0,o=s.buttons,u=0;u<o.length;++u){var h=o[u],l=r.buttons[u];if(Math.abs(h.value-l.value)>.01){a=e._getOrCreateInputDevice(r.index,!0);break}}if(a){i.push(a);continue}for(var c=s.axes,_=0;_<c.length;++_){var f=c[_],d=r.axes[_];if(Math.abs(f-d)>.01){a=e._getOrCreateInputDevice(r.index,!0);break}}if(a){i.push(a);continue}}}}e._cachedWebGamepads=t;for(var m=0;m<i.length;++m){var p=i[m];e._eventTarget.emit(GC.GAMEPAD_INPUT,new qC(GC.GAMEPAD_INPUT,p))}}}},{key:"_getWebGamePads",value:function(){return"function"==typeof navigator.getGamepads?navigator.getGamepads():"function"==typeof navigator.webkitGetGamepads?navigator.webkitGetGamepads():[]}},{key:"_getWebGamepad",value:function(t){for(var i=e._getWebGamePads(),n=0;n<i.length;++n){var r=i[n];if(r&&r.index===t)return r}}}]),e}();dR.all=[],dR._eventTarget=new Hh,dR._cachedWebGamepads=[],dR._intervalId=-1,function(e){e[e.BUTTON_EAST=0]="BUTTON_EAST",e[e.BUTTON_SOUTH=1]="BUTTON_SOUTH",e[e.BUTTON_WEST=2]="BUTTON_WEST",e[e.BUTTON_NORTH=3]="BUTTON_NORTH",e[e.BUTTON_TRIGGER_LEFT=4]="BUTTON_TRIGGER_LEFT",e[e.BUTTON_TRIGGER_RIGHT=5]="BUTTON_TRIGGER_RIGHT",e[e.TRIGGER_LEFT=6]="TRIGGER_LEFT",e[e.TRIGGER_RIGHT=7]="TRIGGER_RIGHT",e[e.GRIP_LEFT=8]="GRIP_LEFT",e[e.GRIP_RIGHT=9]="GRIP_RIGHT",e[e.BUTTON_LEFT_STICK=10]="BUTTON_LEFT_STICK",e[e.LEFT_STICK_UP=11]="LEFT_STICK_UP",e[e.LEFT_STICK_DOWN=12]="LEFT_STICK_DOWN",e[e.LEFT_STICK_LEFT=13]="LEFT_STICK_LEFT",e[e.LEFT_STICK_RIGHT=14]="LEFT_STICK_RIGHT",e[e.BUTTON_RIGHT_STICK=15]="BUTTON_RIGHT_STICK",e[e.RIGHT_STICK_UP=16]="RIGHT_STICK_UP",e[e.RIGHT_STICK_DOWN=17]="RIGHT_STICK_DOWN",e[e.RIGHT_STICK_LEFT=18]="RIGHT_STICK_LEFT",e[e.RIGHT_STICK_RIGHT=19]="RIGHT_STICK_RIGHT",e[e.ROKID_MENU=20]="ROKID_MENU",e[e.ROKID_START=21]="ROKID_START"}(ZC||(ZC={})),function(e){e[e.KET_CLICK=0]="KET_CLICK",e[e.KET_STICK=1]="KET_STICK",e[e.KET_GRAB=2]="KET_GRAB"}($C||($C={})),function(e){e[e.UNDEFINE=0]="UNDEFINE",e[e.X=1]="X",e[e.Y=2]="Y",e[e.LEFT_STICK_X=3]="LEFT_STICK_X",e[e.LEFT_STICK_Y=4]="LEFT_STICK_Y",e[e.RIGHT_STICK_X=5]="RIGHT_STICK_X",e[e.RIGHT_STICK_Y=6]="RIGHT_STICK_Y",e[e.LEFT_TRIGGER=7]="LEFT_TRIGGER",e[e.RIGHT_TIRGGER=8]="RIGHT_TIRGGER",e[e.LEFT_GRIP=9]="LEFT_GRIP",e[e.RIGHT_GRIP=10]="RIGHT_GRIP"}(eR||(eR={}));var mR,pR,vR={1:ZC.BUTTON_EAST,2:ZC.BUTTON_SOUTH,3:ZC.BUTTON_NORTH,4:ZC.BUTTON_WEST,9:ZC.BUTTON_LEFT_STICK,10:ZC.BUTTON_RIGHT_STICK,11:ZC.ROKID_MENU,12:ZC.ROKID_START,13:ZC.BUTTON_TRIGGER_LEFT,14:ZC.BUTTON_TRIGGER_RIGHT},yR=function(){function e(){var t,i=this;n(this,e),this._eventTarget=new Hh,this._nativeButtonState=(a(t={},ZC.BUTTON_SOUTH,0),a(t,ZC.BUTTON_EAST,0),a(t,ZC.BUTTON_WEST,0),a(t,ZC.BUTTON_NORTH,0),a(t,ZC.BUTTON_TRIGGER_LEFT,0),a(t,ZC.BUTTON_TRIGGER_RIGHT,0),a(t,ZC.TRIGGER_LEFT,0),a(t,ZC.TRIGGER_RIGHT,0),a(t,ZC.GRIP_LEFT,0),a(t,ZC.GRIP_RIGHT,0),a(t,ZC.LEFT_STICK_UP,0),a(t,ZC.LEFT_STICK_DOWN,0),a(t,ZC.LEFT_STICK_LEFT,0),a(t,ZC.LEFT_STICK_RIGHT,0),a(t,ZC.RIGHT_STICK_UP,0),a(t,ZC.RIGHT_STICK_DOWN,0),a(t,ZC.RIGHT_STICK_LEFT,0),a(t,ZC.RIGHT_STICK_RIGHT,0),a(t,ZC.BUTTON_LEFT_STICK,0),a(t,ZC.BUTTON_RIGHT_STICK,0),a(t,ZC.ROKID_MENU,0),a(t,ZC.ROKID_START,0),t),this._initInputSource(),window.addEventListener("xr-remote-input",(function(e){var t=e,n=t.detail.keyEventType,r=t.detail.stickAxisCode,s=t.detail.stickAxisValue,a=t.detail.stickKeyCode,o=t.detail.isButtonPressed;if(n===$C.KET_CLICK){var u=vR[a];i._nativeButtonState[u]=o?1:0}else if(n===$C.KET_STICK||n===$C.KET_GRAB){var h,l,c;switch(r){case eR.LEFT_STICK_X:h=ZC.LEFT_STICK_LEFT,l=ZC.LEFT_STICK_RIGHT,c=i._axisToButtons(s);break;case eR.LEFT_STICK_Y:h=ZC.LEFT_STICK_DOWN,l=ZC.LEFT_STICK_UP,c=i._axisToButtons(s);break;case eR.RIGHT_STICK_X:h=ZC.RIGHT_STICK_LEFT,l=ZC.RIGHT_STICK_RIGHT,c=i._axisToButtons(s);break;case eR.RIGHT_STICK_Y:h=ZC.RIGHT_STICK_DOWN,l=ZC.RIGHT_STICK_UP,c=i._axisToButtons(s);break;case eR.LEFT_TRIGGER:i._nativeButtonState[ZC.TRIGGER_LEFT]=s;break;case eR.RIGHT_TIRGGER:i._nativeButtonState[ZC.TRIGGER_RIGHT]=s;break;case eR.LEFT_GRIP:i._nativeButtonState[ZC.GRIP_LEFT]=s;break;case eR.RIGHT_GRIP:i._nativeButtonState[ZC.GRIP_RIGHT]=s}h&&l&&c&&(i._nativeButtonState[h]=c.negative,i._nativeButtonState[l]=c.positive)}i._eventTarget.emit(GC.HANDLE_INPUT,new YC(GC.HANDLE_INPUT,i))}))}return s(e,[{key:"buttonNorth",get:function(){return this._buttonNorth}},{key:"buttonEast",get:function(){return this._buttonEast}},{key:"buttonWest",get:function(){return this._buttonWest}},{key:"buttonSouth",get:function(){return this._buttonSouth}},{key:"buttonTriggerLeft",get:function(){return this._buttonTriggerLeft}},{key:"buttonTriggerRight",get:function(){return this._buttonTriggerRight}},{key:"triggerLeft",get:function(){return this._triggerLeft}},{key:"triggerRight",get:function(){return this._triggerRight}},{key:"gripLeft",get:function(){return this._gripLeft}},{key:"gripRight",get:function(){return this._gripRight}},{key:"leftStick",get:function(){return this._leftStick}},{key:"rightStick",get:function(){return this._rightStick}},{key:"buttonLeftStick",get:function(){return this._buttonLeftStick}},{key:"buttonRightStick",get:function(){return this._buttonRightStick}},{key:"buttonOptions",get:function(){return this._buttonOptions}},{key:"buttonStart",get:function(){return this._buttonStart}},{key:"handLeftPosition",get:function(){return this._handLeftPosition}},{key:"handLeftOrientation",get:function(){return this._handLeftOrientation}},{key:"handRightPosition",get:function(){return this._handRightPosition}},{key:"handRightOrientation",get:function(){return this._handRightOrientation}},{key:"aimLeftPosition",get:function(){return this._aimLeftPosition}},{key:"aimLeftOrientation",get:function(){return this._aimLeftOrientation}},{key:"aimRightPosition",get:function(){return this._aimRightPosition}},{key:"aimRightOrientation",get:function(){return this._aimRightOrientation}},{key:"_axisToButtons",value:function(e){var t=Math.abs(e);return e>0?{negative:0,positive:t}:e<0?{negative:t,positive:0}:{negative:0,positive:0}}},{key:"_on",value:function(e,t,i){this._eventTarget.on(e,t,i)}},{key:"_initInputSource",value:function(){var e=this;this._buttonNorth=new hR,this._buttonNorth.getValue=function(){return e._nativeButtonState[ZC.BUTTON_NORTH]},this._buttonEast=new hR,this._buttonEast.getValue=function(){return e._nativeButtonState[ZC.BUTTON_EAST]},this._buttonWest=new hR,this._buttonWest.getValue=function(){return e._nativeButtonState[ZC.BUTTON_WEST]},this._buttonSouth=new hR,this._buttonSouth.getValue=function(){return e._nativeButtonState[ZC.BUTTON_SOUTH]},this._buttonTriggerLeft=new hR,this._buttonTriggerLeft.getValue=function(){return e._nativeButtonState[ZC.BUTTON_TRIGGER_LEFT]},this._buttonTriggerRight=new hR,this._buttonTriggerRight.getValue=function(){return e._nativeButtonState[ZC.BUTTON_TRIGGER_RIGHT]},this._triggerLeft=new hR,this._triggerLeft.getValue=function(){return e._nativeButtonState[ZC.TRIGGER_LEFT]},this._triggerRight=new hR,this._triggerRight.getValue=function(){return e._nativeButtonState[ZC.TRIGGER_RIGHT]},this._gripLeft=new hR,this._gripLeft.getValue=function(){return e._nativeButtonState[ZC.GRIP_LEFT]},this._gripRight=new hR,this._gripRight.getValue=function(){return e._nativeButtonState[ZC.GRIP_RIGHT]},this._buttonLeftStick=new hR,this._buttonLeftStick.getValue=function(){return e._nativeButtonState[ZC.BUTTON_LEFT_STICK]};var t=new hR;t.getValue=function(){return e._nativeButtonState[ZC.LEFT_STICK_UP]};var i=new hR;i.getValue=function(){return e._nativeButtonState[ZC.LEFT_STICK_DOWN]};var n=new hR;n.getValue=function(){return e._nativeButtonState[ZC.LEFT_STICK_LEFT]};var r=new hR;r.getValue=function(){return e._nativeButtonState[ZC.LEFT_STICK_RIGHT]},this._leftStick=new cR({up:t,down:i,left:n,right:r}),this._buttonRightStick=new hR,this._buttonRightStick.getValue=function(){return e._nativeButtonState[ZC.BUTTON_RIGHT_STICK]};var s=new hR;s.getValue=function(){return e._nativeButtonState[ZC.RIGHT_STICK_UP]};var a=new hR;a.getValue=function(){return e._nativeButtonState[ZC.RIGHT_STICK_DOWN]};var o=new hR;o.getValue=function(){return e._nativeButtonState[ZC.RIGHT_STICK_LEFT]};var u=new hR;u.getValue=function(){return e._nativeButtonState[ZC.RIGHT_STICK_RIGHT]},this._rightStick=new cR({up:s,down:a,left:o,right:u}),this._buttonOptions=new hR,this._buttonOptions.getValue=function(){return e._nativeButtonState[ZC.ROKID_MENU]},this._buttonStart=new hR,this._buttonStart.getValue=function(){return e._nativeButtonState[ZC.ROKID_START]},this._handLeftPosition=new fR,this._handLeftPosition.getValue=function(){return an.ZERO},this._handLeftOrientation=new _R,this._handLeftOrientation.getValue=function(){return vn.IDENTITY},this._handRightPosition=new fR,this._handRightPosition.getValue=function(){return an.ZERO},this._handRightOrientation=new _R,this._handRightOrientation.getValue=function(){return vn.IDENTITY},this._aimLeftPosition=new fR,this._aimLeftPosition.getValue=function(){return an.ZERO},this._aimLeftOrientation=new _R,this._aimLeftOrientation.getValue=function(){return vn.IDENTITY},this._aimRightPosition=new fR,this._aimRightPosition.getValue=function(){return an.ZERO},this._aimRightOrientation=new _R,this._aimRightOrientation.getValue=function(){return vn.IDENTITY}}}]),e}(),gR=function(){function e(){n(this,e),this._eventTarget=new Hh,this._initInputSource()}return s(e,[{key:"viewLeftPosition",get:function(){return this._viewLeftPosition}},{key:"viewLeftOrientation",get:function(){return this._viewLeftOrientation}},{key:"viewRightPosition",get:function(){return this._viewRightPosition}},{key:"viewRightOrientation",get:function(){return this._viewRightOrientation}},{key:"headMiddlePosition",get:function(){return this._headMiddlePosition}},{key:"headMiddleOrientation",get:function(){return this._headMiddleOrientation}},{key:"_on",value:function(e,t,i){this._eventTarget.on(e,t,i)}},{key:"_initInputSource",value:function(){this._viewLeftPosition=new fR,this._viewLeftPosition.getValue=function(){return an.ZERO},this._viewLeftOrientation=new _R,this._viewLeftOrientation.getValue=function(){return vn.IDENTITY},this._viewRightPosition=new fR,this._viewRightPosition.getValue=function(){return an.ZERO},this._viewRightOrientation=new _R,this._viewRightOrientation.getValue=function(){return vn.IDENTITY},this._headMiddlePosition=new fR,this._headMiddlePosition.getValue=function(){return an.ZERO},this._headMiddleOrientation=new _R,this._headMiddleOrientation.getValue=function(){return vn.IDENTITY}}}]),e}(),SR=function(){function e(){n(this,e),this._eventTarget=new Hh,this._initInputSource()}return s(e,[{key:"handheldPosition",get:function(){return this._handheldPosition}},{key:"handheldOrientation",get:function(){return this._handheldOrientation}},{key:"_on",value:function(e,t,i){this._eventTarget.on(e,t,i)}},{key:"_initInputSource",value:function(){this._handheldPosition=new fR,this._handheldPosition.getValue=function(){return an.ZERO},this._handheldOrientation=new _R,this._handheldOrientation.getValue=function(){return vn.IDENTITY}}}]),e}(),AR={Backspace:jC.BACKSPACE,Tab:jC.TAB,Enter:jC.ENTER,ShiftLeft:jC.SHIFT_LEFT,ControlLeft:jC.CTRL_LEFT,AltLeft:jC.ALT_LEFT,ShiftRight:jC.SHIFT_RIGHT,ControlRight:jC.CTRL_RIGHT,AltRight:jC.ALT_RIGHT,Pause:jC.PAUSE,CapsLock:jC.CAPS_LOCK,Escape:jC.ESCAPE,Space:jC.SPACE,PageUp:jC.PAGE_UP,PageDown:jC.PAGE_DOWN,End:jC.END,Home:jC.HOME,ArrowLeft:jC.ARROW_LEFT,ArrowUp:jC.ARROW_UP,ArrowRight:jC.ARROW_RIGHT,ArrowDown:jC.ARROW_DOWN,Insert:jC.INSERT,Delete:jC.DELETE,Digit0:jC.DIGIT_0,Digit1:jC.DIGIT_1,Digit2:jC.DIGIT_2,Digit3:jC.DIGIT_3,Digit4:jC.DIGIT_4,Digit5:jC.DIGIT_5,Digit6:jC.DIGIT_6,Digit7:jC.DIGIT_7,Digit8:jC.DIGIT_8,Digit9:jC.DIGIT_9,KeyA:jC.KEY_A,KeyB:jC.KEY_B,KeyC:jC.KEY_C,KeyD:jC.KEY_D,KeyE:jC.KEY_E,KeyF:jC.KEY_F,KeyG:jC.KEY_G,KeyH:jC.KEY_H,KeyI:jC.KEY_I,KeyJ:jC.KEY_J,KeyK:jC.KEY_K,KeyL:jC.KEY_L,KeyM:jC.KEY_M,KeyN:jC.KEY_N,KeyO:jC.KEY_O,KeyP:jC.KEY_P,KeyQ:jC.KEY_Q,KeyR:jC.KEY_R,KeyS:jC.KEY_S,KeyT:jC.KEY_T,KeyU:jC.KEY_U,KeyV:jC.KEY_V,KeyW:jC.KEY_W,KeyX:jC.KEY_X,KeyY:jC.KEY_Y,KeyZ:jC.KEY_Z,Numpad0:jC.NUM_0,Numpad1:jC.NUM_1,Numpad2:jC.NUM_2,Numpad3:jC.NUM_3,Numpad4:jC.NUM_4,Numpad5:jC.NUM_5,Numpad6:jC.NUM_6,Numpad7:jC.NUM_7,Numpad8:jC.NUM_8,Numpad9:jC.NUM_9,NumpadMultiply:jC.NUM_MULTIPLY,NumpadAdd:jC.NUM_PLUS,NumpadSubtract:jC.NUM_SUBTRACT,NumpadDecimal:jC.NUM_DECIMAL,NumpadDivide:jC.NUM_DIVIDE,NumpadEnter:jC.NUM_ENTER,F1:jC.F1,F2:jC.F2,F3:jC.F3,F4:jC.F4,F5:jC.F5,F6:jC.F6,F7:jC.F7,F8:jC.F8,F9:jC.F9,F10:jC.F10,F11:jC.F11,F12:jC.F12,NumLock:jC.NUM_LOCK,ScrollLock:jC.SCROLL_LOCK,Semicolon:jC.SEMICOLON,Equal:jC.EQUAL,Comma:jC.COMMA,Minus:jC.DASH,Period:jC.PERIOD,Slash:jC.SLASH,Backquote:jC.BACK_QUOTE,BracketLeft:jC.BRACKET_LEFT,Backslash:jC.BACKSLASH,BracketRight:jC.BRACKET_RIGHT,Quote:jC.QUOTE},TR=function(){function e(){n(this,e),this._eventTarget=new Hh,this._registerEvent()}return s(e,[{key:"dispatchKeyboardDownEvent",value:function(e){this._handleKeyboardDown(e)}},{key:"dispatchKeyboardUpEvent",value:function(e){this._handleKeyboardUp(e)}},{key:"on",value:function(e,t,i){this._eventTarget.on(e,t,i)}},{key:"_registerEvent",value:function(){var e=document.getElementById("GameCanvas");null==e||e.addEventListener("keydown",this._handleKeyboardDown.bind(this)),null==e||e.addEventListener("keyup",this._handleKeyboardUp.bind(this))}},{key:"_getInputEvent",value:function(e,t){var i,n=(i=e.code,AR[i]||jC.NONE);return new HC(n,t)}},{key:"_handleKeyboardDown",value:function(e){if(e.stopPropagation(),e.preventDefault(),e.repeat){var t=this._getInputEvent(e,GC.KEY_PRESSING);this._eventTarget.emit(GC.KEY_PRESSING,t)}else{var i=this._getInputEvent(e,GC.KEY_DOWN);this._eventTarget.emit(GC.KEY_DOWN,i)}}},{key:"_handleKeyboardUp",value:function(e){var t=this._getInputEvent(e,GC.KEY_UP);e.stopPropagation(),e.preventDefault(),this._eventTarget.emit(GC.KEY_UP,t)}}]),e}(),ER=function(){function e(){n(this,e),this._canvas=void 0,this._eventTarget=new Hh,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new In,this._handleMouseDown=void 0,this._handleMouseMove=void 0,this._handleMouseUp=void 0,Qh.hasFeature(Yh.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._handleMouseDown=this._createCallback(GC.MOUSE_DOWN),this._handleMouseMove=this._createCallback(GC.MOUSE_MOVE),this._handleMouseUp=this._createCallback(GC.MOUSE_UP),this._registerEvent())}return s(e,[{key:"dispatchMouseDownEvent",value:function(e){this._handleMouseDown(e)}},{key:"dispatchMouseMoveEvent",value:function(e){this._handleMouseMove(e)}},{key:"dispatchMouseUpEvent",value:function(e){this._handleMouseUp(e)}},{key:"dispatchScrollEvent",value:function(e){this._handleMouseWheel(e)}},{key:"on",value:function(e,t,i){this._eventTarget.on(e,t,i)}},{key:"_getCanvasRect",value:function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Dn(t.x,t.y,t.width,t.height):new Dn(0,0,0,0)}},{key:"_getLocation",value:function(e){var t=this._getCanvasRect(),i=vl.devicePixelRatio,n=this._pointLocked?this._preMousePos.x/i+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/i-e.movementY:t.y+t.height-e.clientY;return new In(n*=i,r*=i)}},{key:"_registerEvent",value:function(){var e,t,i,n,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._handleMouseDown),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._handleMouseMove),window.addEventListener("mouseup",this._handleMouseUp),null===(i=this._canvas)||void 0===i||i.addEventListener("mouseup",this._handleMouseUp),null===(n=this._canvas)||void 0===n||n.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()}},{key:"_registerPointerLockEvent",value:function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)}},{key:"_createCallback",value:function(e){var t=this;return function(i){var n,r=t._getLocation(i),s=i.button,a=i.buttons,o=s;switch(e){case GC.MOUSE_DOWN:null===(n=t._canvas)||void 0===n||n.focus(),t._isPressed=!0;break;case GC.MOUSE_UP:t._isPressed=!1;break;case GC.MOUSE_MOVE:o=1&a?zC.BUTTON_LEFT:2&a?zC.BUTTON_RIGHT:4&a?zC.BUTTON_MIDDLE:zC.BUTTON_MISSING}var u=new zC(e,!1,t._preMousePos);u.setLocation(r.x,r.y),u.setButton(o),u.movementX=i.movementX,u.movementY=i.movementY,t._preMousePos.set(r.x,r.y),i.stopPropagation(),i.target===t._canvas&&i.preventDefault(),t._eventTarget.emit(e,u)}}},{key:"_handleMouseWheel",value:function(e){var t=GC.MOUSE_WHEEL,i=this._getLocation(e),n=e.button,r=new zC(t,!1,this._preMousePos);r.setLocation(i.x,i.y),r.setButton(n),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(i.x,i.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)}}]),e}(),bR=new In,CR=new(function(){function e(){n(this,e),this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}return s(e,[{key:"_cloneTouch",value:function(e){var t=e.getID();e.getStartLocation(bR);var i=new JC(bR.x,bR.y,t);return e.getLocation(bR),i.setPoint(bR.x,bR.y),e.getPreviousLocation(bR),i.setPrevPoint(bR),i}},{key:"_createTouch",value:function(e,t,i){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var n=new JC(t,i,e);return this._touchMap.set(e,n),this._updateTouch(n,t,i),this._cloneTouch(n)}console.log("The touches is more than MAX_TOUCHES.")}}},{key:"releaseTouch",value:function(e){this._touchMap.has(e)&&this._touchMap.delete(e)}},{key:"getTouch",value:function(e,t,i){var n=this._touchMap.get(e);return n?this._updateTouch(n,t,i):n=this._createTouch(e,t,i),n?this._cloneTouch(n):void 0}},{key:"getAllTouches",value:function(){var e=this,t=[];return this._touchMap.forEach((function(i){if(i){var n=e._cloneTouch(i);t.push(n)}})),t}},{key:"_updateTouch",value:function(e,t,i){e.getLocation(bR),e.setPrevPoint(bR),e.setPoint(t,i)}},{key:"_checkTouchMapSizeMoreThanMax",value:function(e){var t=this;if(this._touchMap.has(e))return!1;var i=Lt.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<i)return!1;var n=performance.now();return this._touchMap.forEach((function(e){n-e.lastModified>Lt.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id ".concat(e.getID(),".")),t.releaseTouch(e.getID()))})),i>=this._touchMap.size}}]),e}()),RR=function(){function e(){n(this,e),this._canvas=void 0,this._eventTarget=new Hh,Qh.hasFeature(Yh.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}return s(e,[{key:"_registerEvent",value:function(){var e,t,i,n;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(GC.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(GC.TOUCH_MOVE)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchend",this._createCallback(GC.TOUCH_END)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchcancel",this._createCallback(GC.TOUCH_CANCEL))}},{key:"_createCallback",value:function(e){var t=this;return function(i){for(var n,r=t._getCanvasRect(),s=[],a=i.changedTouches.length,o=0;o<a;++o){var u=i.changedTouches[o],h=u.identifier;if(null!==h){var l=t._getLocation(u,r),c=CR.getTouch(h,l.x,l.y);c&&(e!==GC.TOUCH_END&&e!==GC.TOUCH_CANCEL||CR.releaseTouch(h),s.push(c))}}if(i.stopPropagation(),i.target===t._canvas&&i.preventDefault(),e===GC.TOUCH_START&&(null===(n=t._canvas)||void 0===n||n.focus()),s.length>0){var _=new XC(s,!1,e,Lt.ENABLE_MULTI_TOUCH?CR.getAllTouches():s);t._eventTarget.emit(e,_)}}}},{key:"_getCanvasRect",value:function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Dn(t.x,t.y,t.width,t.height):new Dn(0,0,0,0)}},{key:"_getLocation",value:function(e,t){if(globalThis.__globalXR.ar&&globalThis.__globalXR.ar.isWebXR())return new In(e.clientX,e.clientY);var i=e.clientX-t.x,n=t.y+t.height-e.clientY;if(vl.isFrameRotated){var r=i;i=t.height-n,n=r}var s=vl.devicePixelRatio;return new In(i*=s,n*=s)}},{key:"on",value:function(e,t,i){this._eventTarget.on(e,t,i)}}]),e}();!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(pR||(pR={}));var xR=function(){function e(t){n(this,e),this.priority=pR.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}return s(e,[{key:"dispatchEvent",value:function(e){return this._inputEventTarget.emit(e.type,e),!0}}]),e}(),wR=(a(mR={},GC.MOUSE_DOWN,GC.TOUCH_START),a(mR,GC.MOUSE_MOVE,GC.TOUCH_MOVE),a(mR,GC.MOUSE_UP,GC.TOUCH_END),mR),kR=e("Input",function(){function e(){n(this,e),this._dispatchImmediately=!0,this._eventTarget=new Hh,this._touchInput=new RR,this._mouseInput=new ER,this._keyboardInput=new TR,this._accelerometerInput=new tR,this._handleInput=new yR,this._hmdInput=new gR,this._handheldInput=new SR,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._eventGamepadList=[],this._eventHandleList=[],this._eventHMDList=[],this._eventHandheldList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new xR(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher),dR._init()}return s(e,[{key:"_dispatchMouseDownEvent",value:function(e){var t,i;null===(t=(i=this._mouseInput).dispatchMouseDownEvent)||void 0===t||t.call(i,e)}},{key:"_dispatchMouseMoveEvent",value:function(e){var t,i;null===(t=(i=this._mouseInput).dispatchMouseMoveEvent)||void 0===t||t.call(i,e)}},{key:"_dispatchMouseUpEvent",value:function(e){var t,i;null===(t=(i=this._mouseInput).dispatchMouseUpEvent)||void 0===t||t.call(i,e)}},{key:"_dispatchMouseScrollEvent",value:function(e){var t,i;null===(t=(i=this._mouseInput).dispatchScrollEvent)||void 0===t||t.call(i,e)}},{key:"_dispatchKeyboardDownEvent",value:function(e){var t,i;null===(t=(i=this._keyboardInput).dispatchKeyboardDownEvent)||void 0===t||t.call(i,e)}},{key:"_dispatchKeyboardUpEvent",value:function(e){var t,i;null===(t=(i=this._keyboardInput).dispatchKeyboardUpEvent)||void 0===t||t.call(i,e)}},{key:"on",value:function(e,t,i){return this._eventTarget.on(e,t,i),t}},{key:"once",value:function(e,t,i){return this._eventTarget.once(e,t,i),t}},{key:"off",value:function(e,t,i){this._eventTarget.off(e,t,i)}},{key:"setAccelerometerEnabled",value:function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()}},{key:"setAccelerometerInterval",value:function(e){this._accelerometerInput.setInterval(e)}},{key:"_simulateEventTouch",value:function(e){var t=wR[e.type],i=CR.getTouch(0,e.getLocationX(),e.getLocationY());if(i){var n=[i],r=new XC(n,!1,t,t===GC.TOUCH_END?[]:n);r.windowId=e.windowId,t===GC.TOUCH_END&&CR.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}}},{key:"_registerEventDispatcher",value:function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))}},{key:"_emitEvent",value:function(e){for(var t=this._eventDispatcherList.length,i=0;i<t;++i){var n=this._eventDispatcherList[i];try{if(!n.dispatchEvent(e))break}catch(t){console.error("Error occurs in an event listener: ".concat(e.type)),console.error(t)}}}},{key:"_registerEvent",value:function(){var e=this;if(Sl.hasFeature(Sl.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(GC.TOUCH_START,(function(i){e._dispatchOrPushEventTouch(i,t)})),this._touchInput.on(GC.TOUCH_MOVE,(function(i){e._dispatchOrPushEventTouch(i,t)})),this._touchInput.on(GC.TOUCH_END,(function(i){e._dispatchOrPushEventTouch(i,t)})),this._touchInput.on(GC.TOUCH_CANCEL,(function(i){e._dispatchOrPushEventTouch(i,t)}))}if(Sl.hasFeature(Sl.Feature.EVENT_MOUSE)){var i=this._eventMouseList;this._mouseInput.on(GC.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,i)})),this._mouseInput.on(GC.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,i)})),this._mouseInput.on(GC.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,i)})),this._mouseInput.on(GC.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,i)}))}if(Sl.hasFeature(Sl.Feature.EVENT_KEYBOARD)){var n=this._eventKeyboardList;this._keyboardInput.on(GC.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,n)})),this._keyboardInput.on(GC.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,n)})),this._keyboardInput.on(GC.KEY_UP,(function(t){e._dispatchOrPushEvent(t,n)}))}if(Sl.hasFeature(Sl.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(GC.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}if(Sl.hasFeature(Sl.Feature.EVENT_GAMEPAD)){var s=this._eventGamepadList;dR._on(GC.GAMEPAD_CHANGE,(function(t){e._dispatchOrPushEvent(t,s)})),dR._on(GC.GAMEPAD_INPUT,(function(t){e._dispatchOrPushEvent(t,s)}))}if(Sl.hasFeature(Sl.Feature.EVENT_HANDLE)){var a=this._eventHandleList;this._handleInput._on(GC.HANDLE_INPUT,(function(t){e._dispatchOrPushEvent(t,a)})),this._handleInput._on(GC.HANDLE_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,a)}))}if(Sl.hasFeature(Sl.Feature.EVENT_HMD)){var o=this._eventHMDList;this._hmdInput._on(GC.HMD_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,o)}))}if(Sl.hasFeature(Sl.Feature.EVENT_HANDHELD)){var u=this._eventHandheldList;this._handheldInput._on(GC.HANDHELD_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,u)}))}}},{key:"_clearEvents",value:function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0,this._eventGamepadList.length=0,this._eventHandleList.length=0,this._eventHMDList.length=0}},{key:"_dispatchOrPushEvent",value:function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)}},{key:"_dispatchOrPushEventTouch",value:function(e,t){if(this._dispatchImmediately)for(var i=e.getTouches(),n=i.length,r=0;r<n;++r)e.touch=i[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)}},{key:"_frameDispatchEvents",value:function(){for(var e=this._eventHMDList,t=0,i=e.length;t<i;++t){var n=e[t];this._emitEvent(n)}for(var r=this._eventHandheldList,s=0,a=r.length;s<a;++s){var o=r[s];this._emitEvent(o)}for(var u=this._eventMouseList,h=0,l=u.length;h<l;++h){var c=u[h];this._emitEvent(c)}for(var _=this._eventTouchList,f=0,d=_.length;f<d;++f)for(var m=_[f],p=m.getTouches(),v=p.length,y=0;y<v;++y)m.touch=p[y],m.propagationStopped=m.propagationImmediateStopped=!1,this._emitEvent(m);for(var g=this._eventKeyboardList,S=0,A=g.length;S<A;++S){var T=g[S];this._emitEvent(T)}for(var E=this._eventAccelerationList,b=0,C=E.length;b<C;++b){var R=E[b];this._emitEvent(R)}for(var x=this._eventGamepadList,w=0,k=x.length;w<k;++w){var I=x[w];this._emitEvent(I)}for(var B=this._eventHandleList,P=0,M=B.length;P<M;++P){var O=B[P];this._emitEvent(O)}this._clearEvents()}}]),e}());kR.EventType=GC;var IR=e("input",new kR),BR=e("SystemEvent",function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),e=t.call(this),IR.on(GC.MOUSE_DOWN,(function(t){e.emit(FC.MOUSE_DOWN,t)})),IR.on(GC.MOUSE_MOVE,(function(t){e.emit(FC.MOUSE_MOVE,t)})),IR.on(GC.MOUSE_UP,(function(t){e.emit(FC.MOUSE_UP,t)})),IR.on(GC.MOUSE_WHEEL,(function(t){e.emit(FC.MOUSE_WHEEL,t)})),IR.on(GC.TOUCH_START,(function(t){e.emit(FC.TOUCH_START,t.touch,t)})),IR.on(GC.TOUCH_MOVE,(function(t){e.emit(FC.TOUCH_MOVE,t.touch,t)})),IR.on(GC.TOUCH_END,(function(t){e.emit(FC.TOUCH_END,t.touch,t)})),IR.on(GC.TOUCH_CANCEL,(function(t){e.emit(FC.TOUCH_CANCEL,t.touch,t)})),IR.on(GC.KEY_DOWN,(function(t){e.emit(FC.KEY_DOWN,t)})),IR.on(GC.KEY_PRESSING,(function(t){e.emit(FC.KEY_DOWN,t)})),IR.on(GC.KEY_UP,(function(t){e.emit(FC.KEY_UP,t)})),IR.on(GC.DEVICEMOTION,(function(t){e.emit(FC.DEVICEMOTION,t)})),e}return s(i,[{key:"setAccelerometerEnabled",value:function(e){IR.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){IR.setAccelerometerInterval(e)}},{key:"on",value:function(e,t,n,r){return g(l(i.prototype),"on",this).call(this,e,t,n,r),t}},{key:"off",value:function(e,t,n){g(l(i.prototype),"off",this).call(this,e,t,n)}}]),i}(Hh));BR.EventType=FC,B.SystemEvent=BR;var PR,MR,OR,DR,LR,NR,FR,GR,VR=e("systemEvent",new BR);B.systemEvent=VR,me(FC,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),me(VC,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:BR.EventType,targetName:"SystemEvent.EventType"}]),ve(VC,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),me(zC,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_".concat(e),target:BR.EventType,targetName:"SystemEvent.EventType"}}))),me(zC,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:BR.EventType,targetName:"SystemEvent.EventType"}]),ve(zC.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),me(XC,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:BR.EventType,targetName:"SystemEvent.EventType"}]),me(XC,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:BR.EventType,targetName:"SystemEvent.EventType"}]),me(XC,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:BR.EventType,targetName:"SystemEvent.EventType"}]),me(XC,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:BR.EventType,targetName:"SystemEvent.EventType"}]),ve(XC.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),me(XC.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:XC,targetName:"EventTouch"}]),ve(Lt.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),ve(Lt.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),ve(Lt.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),ve(Lt.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),ve(Lt,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(PR||(PR={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(MR||(MR={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(OR||(OR={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(DR||(DR={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(LR||(LR={})),function(e){e[e.DEFAULT=-1]="DEFAULT",e[e.LEFT_EYE=0]="LEFT_EYE",e[e.RIGHT_EYE=1]="RIGHT_EYE",e[e.MAIN=2]="MAIN"}(NR||(NR={})),function(e){e[e.NO_TRACKING=0]="NO_TRACKING",e[e.POSITION_AND_ROTATION=1]="POSITION_AND_ROTATION",e[e.POSITION=2]="POSITION",e[e.ROTATION=3]="ROTATION"}(FR||(FR={})),function(e){e[e.EDITOR=0]="EDITOR",e[e.GAME_VIEW=1]="GAME_VIEW",e[e.SCENE_VIEW=2]="SCENE_VIEW",e[e.PREVIEW=3]="PREVIEW",e[e.GAME=100]="GAME"}(GR||(GR={}));var UR=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],HR=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],zR=[100,200,400,800],WR=new an,XR=new an,jR=new Cn,qR=yc.STENCIL<<1,YR=[],KR=function(){function e(t){if(n(this,e),this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=PR.VERTICAL,this._fov=Gi(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Dc(.2,.2,.2,1),this._viewport=new Dn(0,0,1,1),this._orientedViewport=new Dn(0,0,1,1),this._curTransform=Ol.IDENTITY,this._isProjDirty=!0,this._matView=new Cn,this._matProj=new Cn,this._matProjInv=new Cn,this._matViewProj=new Cn,this._matViewProjInv=new Cn,this._frustum=new Ts,this._forward=new an,this._position=new an,this._priority=0,this._aperture=OR.F16_0,this._apertureValue=void 0,this._shutter=LR.D125,this._shutterValue=0,this._iso=DR.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=yc.NONE,this._clearDepth=1,this._visibility=Py,this._exposure=0,this._clearStencil=0,this._geometryRenderer=null,this._windowId=0,this._cameraType=NR.DEFAULT,this._trackingType=FR.NO_TRACKING,this._usage=GR.GAME,this._device=t,this._apertureValue=UR[this._aperture],this._shutterValue=HR[this._shutter],this._isoValue=zR[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!YR.length){var i=t.capabilities.clipSpaceSignY;YR[Ol.IDENTITY]=new Cn(1,0,0,0,0,i),YR[Ol.ROTATE_90]=new Cn(0,1,0,0,-i,0),YR[Ol.ROTATE_180]=new Cn(-1,0,0,0,0,-i),YR[Ol.ROTATE_270]=new Cn(0,-1,0,0,i,0)}}return s(e,[{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"systemWindowId",get:function(){return this._windowId}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=UR[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=HR[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=zR[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"aspect",get:function(){return this._aspect}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"viewport",get:function(){return this._viewport},set:function(e){ae(8302),this.setViewportInOrientedSpace(e)}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"_updateAspect",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain,i=t&&t.surfaceTransform||Ol.IDENTITY;i%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0}},{key:"initialize",value:function(e){void 0!==e.usage?this._usage=e.usage:this.setDefaultUsage(),void 0!==e.trackingType&&(this._trackingType=e.trackingType),void 0!==e.cameraType&&(this._cameraType=e.cameraType),this.node=e.node,this._width=1,this._height=1,this.clearFlag=yc.NONE,this.clearDepth=1,this.visibility=Py,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)}},{key:"destroy",value:function(){var e;this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,null===(e=this._geometryRenderer)||void 0===e||e.destroy()}},{key:"attachToScene",value:function(e){this._enabled=!0,this._scene=e}},{key:"detachFromScene",value:function(){this._enabled=!1,this._scene=null}},{key:"resize",value:function(e,t){this._window&&(this._width=e,this._height=t,this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0)}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._updateAspect(),this.isWindowSize=!1}},{key:"syncCameraEditor",value:function(){}},{key:"update",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._node){var i=!1;(this._node.hasChangedFlags||t)&&(Cn.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,Cn.multiply(this._matView,(new Cn).scale(this._node.worldScale),this._matView),this._node.getWorldPosition(this._position),i=!0);var n=null===(e=this.window)||void 0===e?void 0:e.swapchain,r=n&&n.surfaceTransform||Ol.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var s=this._device.capabilities.clipSpaceSignY;if(this._proj===MR.PERSPECTIVE)Cn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===PR.VERTICAL,this._device.capabilities.clipSpaceMinZ,s,r);else{var a=this._orthoHeight*this._aspect,o=this._orthoHeight;Cn.ortho(this._matProj,-a,a,-o,o,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,s,r)}Cn.invert(this._matProjInv,this._matProj),i=!0,this._isProjDirty=!1}i&&(Cn.multiply(this._matViewProj,this._matProj,this._matView),Cn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}}},{key:"surfaceTransform",get:function(){return this._curTransform}},{key:"setViewportInOrientedSpace",value:function(e){var t,i=e.x,n=e.width,r=e.height,s=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,a=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(a&&a.surfaceTransform||Ol.IDENTITY){case Ol.ROTATE_90:this._viewport.x=1-s-r,this._viewport.y=i,this._viewport.width=r,this._viewport.height=n;break;case Ol.ROTATE_180:this._viewport.x=1-i-n,this._viewport.y=1-s-r,this._viewport.width=n,this._viewport.height=r;break;case Ol.ROTATE_270:this._viewport.x=s,this._viewport.y=1-i-n,this._viewport.width=r,this._viewport.height=n;break;case Ol.IDENTITY:this._viewport.x=i,this._viewport.y=s,this._viewport.width=n,this._viewport.height=r}this._orientedViewport.x=i,this._orientedViewport.y=s,this._orientedViewport.width=n,this._orientedViewport.height=r,this.resize(this.width,this.height)}},{key:"initGeometryRenderer",value:function(){var e;this._geometryRenderer||(this._geometryRenderer=B.internal.GeometryRenderer?new B.internal.GeometryRenderer:null,null===(e=this._geometryRenderer)||void 0===e||e.activate(this._device))}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"cameraType",get:function(){return this._cameraType},set:function(e){this._cameraType=e}},{key:"trackingType",get:function(){return this._trackingType},set:function(e){this._trackingType=e}},{key:"cameraUsage",get:function(){return this._usage},set:function(e){this._usage=e}},{key:"changeTargetWindow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._window&&this._window.detachCamera(this);var t=e||B.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var i=t.swapchain,n=i&&i.surfaceTransform||Ol.IDENTITY;n%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}}},{key:"detachCamera",value:function(){this._window&&this._window.detachCamera(this)}},{key:"screenPointToRay",value:function(e,t,i){if(!this._node)return null;var n=this.width,r=this.height,s=this._orientedViewport.x*n,a=this._orientedViewport.y*r,o=this._orientedViewport.width*n,u=this._orientedViewport.height*r,h=this._proj===MR.PERSPECTIVE,l=this._device.capabilities.clipSpaceSignY,c=bn[this._curTransform];an.set(WR,(t-s)/o*2-1,(i-a)/u*2-1,h?1:-1);var _=WR.x,f=WR.y;return WR.x=_*c[0]+f*c[2]*l,WR.y=_*c[1]+f*c[3]*l,an.transformMat4(h?WR:e.o,WR,this._matViewProjInv),h?(this._node.getWorldPosition(XR),er.fromPoints(e,XR,WR)):an.transformQuat(e.d,an.FORWARD,this._node.worldRotation),e}},{key:"screenToWorld",value:function(e,t){var i=this.width,n=this.height,r=this._orientedViewport.x*i,s=this._orientedViewport.y*n,a=this._orientedViewport.width*i,o=this._orientedViewport.height*n,u=this._device.capabilities.clipSpaceSignY,h=bn[this._curTransform];if(this._proj===MR.PERSPECTIVE){an.set(e,(t.x-r)/a*2-1,(t.y-s)/o*2-1,1);var l=e.x,c=e.y;e.x=l*h[0]+c*h[2]*u,e.y=l*h[1]+c*h[3]*u,an.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(WR),an.lerp(e,WR,e,Fi(this._nearClip/this._farClip,1,t.z))}else{an.set(e,(t.x-r)/a*2-1,(t.y-s)/o*2-1,2*t.z-1);var _=e.x,f=e.y;e.x=_*h[0]+f*h[2]*u,e.y=_*h[1]+f*h[3]*u,an.transformMat4(e,e,this._matViewProjInv)}return e}},{key:"worldToScreen",value:function(e,t){var i=this._device.capabilities.clipSpaceSignY,n=bn[this._curTransform];an.transformMat4(e,t,this._matViewProj);var r=e.x,s=e.y;e.x=r*n[0]+s*n[2]*i,e.y=r*n[1]+s*n[3]*i;var a=this.width,o=this.height,u=this._orientedViewport.x*a,h=this._orientedViewport.y*o,l=this._orientedViewport.width*a,c=this._orientedViewport.height*o;return e.x=u+.5*(e.x+1)*l,e.y=h+.5*(e.y+1)*c,e.z=.5*e.z+.5,e}},{key:"worldMatrixToScreen",value:function(e,t,i,n){Cn.multiply(e,this._matViewProj,t),Cn.multiply(e,YR[this._curTransform],e);var r=i/2,s=n/2;return Cn.identity(jR),Cn.transform(jR,jR,an.set(WR,r,s,0)),Cn.scale(jR,jR,an.set(WR,r,s,1)),Cn.multiply(e,jR,e),e}},{key:"calculateObliqueMat",value:function(e){var t=new en(Math.sign(e.x),Math.sign(e.y),1,1).transformMat4(this._matProjInv),i=new en(this._matProj.m03,this._matProj.m07,this._matProj.m11,this._matProj.m15),n=2/en.dot(e,t),r=e.multiplyScalar(n).subtract(i);this._matProj.m02=r.x,this._matProj.m06=r.y,this._matProj.m10=r.z,this._matProj.m14=r.w}},{key:"setExposure",value:function(e){this._exposure=.833333/Math.pow(2,e)}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)}},{key:"setDefaultUsage",value:function(){this._usage=GR.GAME}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),QR=new an,JR=dr.create(0,0,0,1),ZR=new Eh((function(){return{model:null,depth:0}}),128);function $R(e,t){var i=0;e.node&&(an.subtract(QR,e.node.worldPosition,t.position),i=an.dot(QR,t.forward));var n=ZR.alloc();return n.model=e,n.depth=i,n}function ex(e,t){var i=e.pipelineSceneData,n=i.validPunctualLights;n.length=0;for(var r=t.scene.spotLights,s=0;s<r.length;s++){var a=r[s];a.baked||(dr.set(JR,a.position.x,a.position.y,a.position.z,a.range),is.sphereFrustum(JR,t.frustum)&&n.push(a))}for(var o=t.scene.sphereLights,u=0;u<o.length;u++){var h=o[u];h.baked||(dr.set(JR,h.position.x,h.position.y,h.position.z,h.range),is.sphereFrustum(JR,t.frustum)&&n.push(h))}i.validPunctualLights=n}function tx(e,t,i){var n=e.scene.mainLight,r=t.csmLayers.layerObjects,s=i.validFrustum,a=i.shadowObjects;a.length=0;for(var o=e.visibility,u=r.length-1;u>=0;u--){var h=r.array[u];if(h){var l=h.model;l&&l.enabled&&l.node&&((o&l.node.layer)===l.node.layer||o&l.visFlags)&&l.worldBounds&&l.castShadow?is.aabbFrustum(l.worldBounds,s)&&(a.push(h),i.level<n.csmLevel&&n.csmOptimizationMode===gA.RemoveDuplicates&&is.aabbFrustumCompletelyInside(l.worldBounds,s)&&r.fastRemove(u)):r.fastRemove(u)}else r.fastRemove(u)}}function ix(e,t){var i=t.scene,n=i.mainLight,r=e.pipelineSceneData,s=r.shadows,a=r.skybox,o=r.csmLayers,u=r.renderObjects;ZR.freeArray(u),u.length=0;var h=o.castShadowObjects;h.length=0;var l=o.layerObjects;l.clear(),s.enabled&&(e.pipelineUBO.updateShadowUBORange(gv.SHADOW_COLOR_OFFSET,s.shadowColor),s.type===pA.ShadowMap&&n&&n.node&&o.update(r,t)),t.clearFlag&qR&&(a.enabled&&a.model?u.push($R(a.model,t)):t.cameraUsage!==GR.EDITOR&&t.cameraUsage!==GR.SCENE_VIEW&&B.warnID(15100,t.name));var c=i.models,_=t.visibility;function f(e){if(e.enabled){if(i.isCulledByLod(t,e))return;if(e.castShadow&&(h.push($R(e,t)),l.push($R(e,t))),e.node&&(_&e.node.layer)===e.node.layer||_&e.visFlags){if(e.worldBounds&&!is.aabbFrustum(e.worldBounds,t.frustum))return;u.push($R(e,t))}}}for(var d=0;d<c.length;d++)f(c[d])}var nx,rx=new p_(null),sx=function(){function e(){n(this,e),this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=iv.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null,this._instancedAttributeBlock={buffer:null,views:[],attributes:[]},this._instancedWorldMatrixIndex=-1,this._instancedSHIndex=-1,this._useReflectionProbeType=0}return s(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?ue(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===VS.VB_MERGING&&this.subMesh.genFlatBuffers(),this._descriptorSet&&(this._descriptorSet.destroy(),rx.layout=e[0].localSetLayout,this._descriptorSet=this._device.createDescriptorSet(rx)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler=this._device.createInputAssembler(e.iaInfo),this._passes[0].batchingScheme===VS.VB_MERGING&&this.subMesh.genFlatBuffers(),this._subMesh=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"instancedAttributeBlock",get:function(){return this._instancedAttributeBlock}},{key:"instancedWorldMatrixIndex",get:function(){return this._instancedWorldMatrixIndex},set:function(e){this._instancedWorldMatrixIndex=e}},{key:"instancedSHIndex",get:function(){return this._instancedSHIndex},set:function(e){this._instancedSHIndex=e}},{key:"useReflectionProbeType",get:function(){return this._useReflectionProbeType},set:function(e){this._useReflectionProbeType=e}},{key:"initialize",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=B.director.root;this._device=yf.gfxDevice,rx.layout=t[0].localSetLayout,this._inputAssembler=this._device.createInputAssembler(e.iaInfo),this._descriptorSet=this._device.createDescriptorSet(rx);var r=B.director.root.pipeline,s=r.pipelineSceneData.getOcclusionQueryPass();if(s){var a=new p_(null);a.layout=s.localSetLayout,this._worldBoundDescriptorSet=this._device.createDescriptorSet(a)}this._subMesh=e,this._patches=i,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===VS.VB_MERGING&&this.subMesh.genFlatBuffers(),this.priority=iv.DEFAULT;var o=B.rendering;if((!o||!o.enableEffectImport)&&t[0].phase===zS("reflection")||Ly()&&t[0].phaseID===o.getPhaseID(o.getPassID("default"),"reflection")){var u=n.mainWindow.width,h=n.mainWindow.height,l=512;h<u?(u=l*u/h,h=l):h=l*h/(u=l),this._reflectionTex=this._device.createTexture(new Wc(zl.TEX2D,Wl.STORAGE|Wl.TRANSFER_SRC|Wl.SAMPLED,Ll.RGBA8,u,h)),this.descriptorSet.bindTexture(dy,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new jc(Kl.LINEAR,Kl.LINEAR,Kl.NONE,Ql.CLAMP,Ql.CLAMP,Ql.CLAMP)),this.descriptorSet.bindSampler(dy,this._reflectionSampler),this.descriptorSet.bindTexture(vy,this._reflectionTex)}}},{key:"initPlanarShadowShader",value:function(){var e=B.director.root.pipeline.pipelineSceneData.shadows;this._planarShader=e.getPlanarShader(this._patches)}},{key:"initPlanarShadowInstanceShader",value:function(){var e=B.director.root.pipeline.pipelineSceneData.shadows;this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)}},{key:"destroy",value:function(){var e;this._descriptorSet.destroy(),this._descriptorSet=null,this._inputAssembler.destroy(),this._inputAssembler=null,null===(e=this._worldBoundDescriptorSet)||void 0===e||e.destroy(),this._worldBoundDescriptorSet=null,this.priority=iv.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null}},{key:"update",value:function(){for(var e,t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),null===(e=this._worldBoundDescriptorSet)||void 0===e||e.update()}},{key:"onPipelineStateChanged",value:function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}},{key:"onMacroPatchesStateChanged",value:function(e){this._patches=e;var t=this._passes;if(t){for(var i=0;i<t.length;i++){var n=t[i];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}}},{key:"onGeometryChanged",value:function(){if(this._subMesh){var e=this._subMesh.drawInfo;if(this._inputAssembler&&e){var t=this._inputAssembler.drawInfo;Object.keys(e).forEach((function(i){t[i]=e[i]})),this._inputAssembler.drawInfo=t}}}},{key:"getInstancedAttributeIndex",value:function(e){for(var t=this.instancedAttributeBlock.attributes,i=0;i<t.length;i++)if(t[i].name===e)return i;return-1}},{key:"updateInstancedWorldMatrix",value:function(e,t){var i=this.instancedAttributeBlock.views,n=i[t],r=i[t+1],s=i[t+2];n[0]=e.m00,n[1]=e.m01,n[2]=e.m02,n[3]=e.m12,r[0]=e.m04,r[1]=e.m05,r[2]=e.m06,r[3]=e.m13,s[0]=e.m08,s[1]=e.m09,s[2]=e.m10,s[3]=e.m14}},{key:"updateInstancedSH",value:function(e,t){for(var i=this.instancedAttributeBlock.views,n=(jv.SH_QUADRATIC_R_OFFSET-jv.SH_LINEAR_CONST_R_OFFSET)/4,r=0,s=t;s<t+n;s++)for(var a=0;a<4;a++)i[s][a]=e[r++]}},{key:"UpdateInstancedAttributes",value:function(e){this.instancedWorldMatrixIndex=-1,this.instancedSHIndex=-1;var t=this.passes[0];if(t.device.hasFeature(Dl.INSTANCED_ARRAYS)){for(var i=0,n=0;n<e.length;n++){var r=e[n];r.isInstanced&&(i+=x_[r.format].size)}var s=this.instancedAttributeBlock;s.buffer=new Uint8Array(i),s.views.length=s.attributes.length=0;for(var a=0,o=0;o<e.length;o++){var u=e[o];if(u.isInstanced){var h=new i_;h.format=u.format,h.name=u.name,h.isNormalized=u.isNormalized,h.location=u.location,s.attributes.push(h);var l=x_[u.format],c=new(L_(l))(s.buffer.buffer,a,l.count);s.views.push(c),a+=l.size}}t.batchingScheme===VS.INSTANCING&&t.getInstancedBuffer().destroy(),this.instancedWorldMatrixIndex=this.getInstancedAttributeIndex(Dv),this.instancedSHIndex=this.getInstancedAttributeIndex(Lv)}}},{key:"_flushPassInfo",value:function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,i=e.length;t<i;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}}}]),e}(),ax=new s_;ax.format=Ll.RGBA8;var ox=new a_;ox.format=Ll.DEPTH_STENCIL;var ux,hx,lx=new h_([ax],ox),cx={width:1,height:1,renderPassInfo:lx},_x=e("RenderTexture",Hs("cc.RenderTexture")(nx=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._window=null,e}return s(i,[{key:"window",get:function(){return this._window}},{key:"initialize",value:function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){if(this._window){var e=B.director.root;null==e||e.destroyWindow(this._window),this._window=null}return g(l(i.prototype),"destroy",this).call(this)}},{key:"resize",value:function(e,t){this._width=Math.floor(Li(e,1,2048)),this._height=Math.floor(Li(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)}},{key:"_serialize",value:function(){return{}}},{key:"_deserialize",value:function(e,t){var n=e;this._width=n.w,this._height=n.h,this._name=n.n,g(l(i.prototype),"_deserialize",this).call(this,n.base,t)}},{key:"getGFXTexture",value:function(){return this._window&&this._window.framebuffer.colorTextures[0]}},{key:"onLoaded",value:function(){this._initWindow()}},{key:"_initWindow",value:function(e){var t=B.director.root;cx.title=this._name,cx.width=this._width,cx.height=this._height,cx.renderPassInfo=e&&e.passInfo?e.passInfo:lx,ax.barrier=yf.gfxDevice.getGeneralBarrier(new l_(sc.FRAGMENT_SHADER_READ_TEXTURE,sc.FRAGMENT_SHADER_READ_TEXTURE)),this._window?(this._window.destroy(),this._window.initialize(yf.gfxDevice,cx)):this._window=t.createWindow(cx)}},{key:"initDefault",value:function(e){g(l(i.prototype),"initDefault",this).call(this,e),this._width=this._height=1,this._initWindow()}},{key:"validate",value:function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048}},{key:"readPixels",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;i=i||this.width,n=n||this.height;var s=this.getGFXTexture();if(!s)return ue(7606),null;var a=4*i*n;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return ue(7607,a),null;var o=this._getGFXDevice(),u=[],h=[],l=new Mc;return l.texOffset.x=e,l.texOffset.y=t,l.texExtent.width=i,l.texExtent.height=n,h.push(l),u.push(r),null==o||o.copyTextureToBuffers(s,u,h),r}}]),i}(kd))||nx);B.RenderTexture=_x,function(e){e[e.SKYBOX=qR|yc.DEPTH_STENCIL]="SKYBOX",e[e.SOLID_COLOR=yc.ALL]="SOLID_COLOR"}(ux||(ux={})),function(e){e[e.CUBE=0]="CUBE",e[e.PLANAR=1]="PLANAR"}(hx||(hx={}));var fx,dx=[new an(0,-90,0),new an(0,90,0),new an(90,0,0),new an(-90,0,0),new an(0,0,0),new an(0,180,0)],mx=function(){function e(t){n(this,e),this.bakedCubeTextures=[],this.realtimePlanarTexture=null,this._resolution=256,this._clearFlag=ux.SKYBOX,this._backgroundColor=new cn(0,0,0,255),this._visibility=Py,this._probeType=hx.CUBE,this._cubemap=null,this._size=new an(1,1,1),this._camera=null,this._probeId=0,this._needRefresh=!1,this._needRender=!1,this._node=null,this._cameraNode=null,this._boundingBox=null,this._cameraWorldPos=new an,this._cameraWorldRotation=new vn,this._forward=new an,this._up=new an,this._previewSphere=null,this._previewPlane=null,this._probeId=t}return s(e,[{key:"probeType",get:function(){return this._probeType},set:function(e){this._probeType=e}},{key:"resolution",get:function(){return this._resolution},set:function(e){e!==this._resolution&&this.bakedCubeTextures.forEach((function(t){t.resize(e,e)})),this._resolution=e}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this.camera.clearFlag=this._clearFlag}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.camera.clearColor=this._backgroundColor}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera.visibility=this._visibility}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e);var t=this.node.getWorldPosition();ms.set(this._boundingBox,t.x,t.y,t.z,this._size.x,this._size.y,this._size.z)}},{key:"cubemap",get:function(){return this._cubemap},set:function(e){this._cubemap=e}},{key:"node",get:function(){return this._node}},{key:"camera",get:function(){return this._camera}},{key:"needRefresh",get:function(){return this._needRefresh},set:function(e){this._needRefresh=e}},{key:"needRender",get:function(){return this._needRender},set:function(e){this._needRender=e}},{key:"boundingBox",get:function(){return this._boundingBox}},{key:"cameraNode",get:function(){return this._cameraNode},set:function(e){this._cameraNode=e}},{key:"previewSphere",get:function(){return this._previewSphere},set:function(e){this._previewSphere=e}},{key:"previewPlane",get:function(){return this._previewPlane},set:function(e){this._previewPlane=e}},{key:"initialize",value:function(e,t){this._node=e,this._cameraNode=t;var i=this.node.getWorldPosition();this._boundingBox=ms.create(i.x,i.y,i.z,this._size.x,this._size.y,this._size.z),this._createCamera(t)}},{key:"initBakedTextures",value:function(){if(0===this.bakedCubeTextures.length)for(var e=0;e<6;e++){var t=this._createTargetTexture(this._resolution,this._resolution);this.bakedCubeTextures.push(t)}}},{key:"captureCubemap",value:function(){this.initBakedTextures(),this._resetCameraParams(),this._needRender=!0}},{key:"renderPlanarReflection",value:function(e){if(e){if(!this.realtimePlanarTexture){var t=B.view.getDesignResolutionSize();this.realtimePlanarTexture=this._createTargetTexture(t.width,t.height),B.internal.reflectionProbeManager.updatePlanarMap(this,this.realtimePlanarTexture.getGFXTexture())}this._syncCameraParams(e),this._transformReflectionCamera(e),this._needRender=!0}}},{key:"switchProbeType",value:function(e,t){e===hx.CUBE?this._needRender=!1:null!==t&&this.renderPlanarReflection(t)}},{key:"getProbeId",value:function(){return this._probeId}},{key:"updateProbeId",value:function(e){this._probeId=e}},{key:"renderArea",value:function(){return this._probeType===hx.PLANAR?new In(this.realtimePlanarTexture.width,this.realtimePlanarTexture.height):new In(this.resolution,this.resolution)}},{key:"isFinishedRendering",value:function(){return!0}},{key:"validate",value:function(){return null!==this.cubemap}},{key:"destroy",value:function(){this._camera&&(this._camera.destroy(),this._camera=null);for(var e=0;e<this.bakedCubeTextures.length;e++)this.bakedCubeTextures[e].destroy();this.bakedCubeTextures=[],this.realtimePlanarTexture&&(this.realtimePlanarTexture.destroy(),this.realtimePlanarTexture=null)}},{key:"enable",value:function(){}},{key:"disable",value:function(){}},{key:"updateCameraDir",value:function(e){this.cameraNode.setRotationFromEuler(dx[e]),this.camera.update(!0)}},{key:"updateBoundingBox",value:function(){if(this.node){this.node.updateWorldTransform();var e=this.node.getWorldPosition();ms.set(this._boundingBox,e.x,e.y,e.z,this._size.x,this._size.y,this._size.z)}}},{key:"hasFrameBuffer",value:function(e){if(0===this.bakedCubeTextures.length)return!1;for(var t=0;t<this.bakedCubeTextures.length;t++){var i;if((null===(i=this.bakedCubeTextures[t].window)||void 0===i?void 0:i.framebuffer)===e)return!0}return!1}},{key:"_syncCameraParams",value:function(e){this.camera.projectionType=e.projectionType,this.camera.orthoHeight=e.orthoHeight,this.camera.nearClip=e.nearClip,this.camera.farClip=e.farClip,this.camera.fov=e.fov,this.camera.visibility=e.visibility,this.camera.clearFlag=e.clearFlag,this.camera.clearColor=e.clearColor,this.camera.priority=e.priority-1,this.camera.resize(e.width,e.height)}},{key:"_createCamera",value:function(e){if(B.director.root,!this._camera){if(this._camera=B.director.root.createCamera(),!this._camera)return null;this._camera.initialize({name:e.name,node:e,projection:MR.PERSPECTIVE,window:B.director.root&&B.director.root.tempWindow,priority:0,cameraType:NR.DEFAULT,trackingType:FR.NO_TRACKING})}return this._camera.setViewportInOrientedSpace(new Dn(0,0,1,1)),this._camera.fovAxis=PR.VERTICAL,this._camera.fov=Gi(90),this._camera.orthoHeight=10,this._camera.nearClip=1,this._camera.farClip=1e3,this._camera.clearColor=this._backgroundColor,this._camera.clearDepth=1,this._camera.clearStencil=0,this._camera.clearFlag=this._clearFlag,this._camera.visibility=this._visibility,this._camera.aperture=OR.F16_0,this._camera.shutter=LR.D125,this._camera.iso=DR.ISO100,this._camera}},{key:"_resetCameraParams",value:function(){this.camera.projectionType=MR.PERSPECTIVE,this.camera.orthoHeight=10,this.camera.nearClip=1,this.camera.farClip=1e3,this.camera.fov=Gi(90),this.camera.priority=0,this.camera.resize(this.resolution,this.resolution),this.camera.visibility=this._visibility,this.camera.clearFlag=this._clearFlag,this.camera.clearColor=this._backgroundColor,this.cameraNode.worldPosition=this.node.worldPosition,this.cameraNode.worldRotation=this.node.worldRotation,this.camera.update(!0)}},{key:"_createTargetTexture",value:function(e,t){var i=new _x;return i.reset({width:e,height:t}),i}},{key:"_transformReflectionCamera",value:function(e){var t=an.dot(this.node.worldPosition,this.node.up);this._reflect(this._cameraWorldPos,e.node.worldPosition,this.node.up,t),this.cameraNode.worldPosition=this._cameraWorldPos,an.transformQuat(this._forward,an.FORWARD,e.node.worldRotation),this._reflect(this._forward,this._forward,this.node.up,0),this._forward.normalize(),this._forward.negative(),an.transformQuat(this._up,this.node.up,e.node.worldRotation),this._reflect(this._up,this._up,this.node.up,0),this._up.normalize(),vn.fromViewUp(this._cameraWorldRotation,this._forward,this._up),this.cameraNode.worldRotation=this._cameraWorldRotation,this.camera.update(!0);var i=new en(this.node.up.x,this.node.up.y,this.node.up.z,-an.dot(this.node.up,this.node.worldPosition));i.transformMat4(this.camera.matView.clone().invert().transpose()),this.camera.calculateObliqueMat(i)}},{key:"_reflect",value:function(e,t,i,n){var r=an.clone(i);r.normalize();var s=an.dot(r,t)-n;return r.multiplyScalar(2*s),an.subtract(e,t,r),e}}]),e}(),px=new Cn,vx=[{name:"CC_RECEIVE_SHADOW",value:!0}],yx=[{name:"CC_USE_LIGHTMAP",value:1}],gx=[{name:"CC_USE_LIGHTMAP",value:2}],Sx=[{name:"CC_LIGHT_MAP_VERSION",value:2}],Ax=[{name:"CC_USE_LIGHT_PROBE",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(fx||(fx={}));var Tx,Ex=new jc(Kl.LINEAR,Kl.LINEAR,Kl.NONE,Ql.CLAMP,Ql.CLAMP,Ql.CLAMP),bx=new jc(Kl.LINEAR,Kl.LINEAR,Kl.LINEAR,Ql.CLAMP,Ql.CLAMP,Ql.CLAMP),Cx=function(){function e(){n(this,e),this.type=fx.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(Mv.COUNT),this._localBuffer=null,this._localSHData=null,this._localSHBuffer=null,this._lightmap=null,this._lightmapUVParam=new en,this._tetrahedronIndex=-1,this._lastWorldBoundCenter=new an(1/0,1/0,1/0),this._useLightProbe=!1,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._receiveDirLight=!0,this._shadowBias=0,this._shadowNormalBias=0,this._reflectionProbeId=-1,this._enabled=!0,this._visFlags=ep.Enum.NONE,this._priority=0,this._bakeToReflectionProbe=!0,this._reflectionProbeType=0,this._device=yf.gfxDevice}return s(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"localSHBuffer",get:function(){return this._localSHBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"useLightProbe",get:function(){return this._useLightProbe},set:function(e){this._useLightProbe=e,this.onMacroPatchesStateChanged()}},{key:"tetrahedronIndex",get:function(){return this._tetrahedronIndex},set:function(e){this._tetrahedronIndex=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e,this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveDirLight",get:function(){return this._receiveDirLight},set:function(e){this._receiveDirLight=e,this.onMacroPatchesStateChanged()}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"bakeToReflectionProbe",get:function(){return this._bakeToReflectionProbe},set:function(e){this._bakeToReflectionProbe=e}},{key:"reflectionProbeType",get:function(){return this._reflectionProbeType},set:function(e){this._reflectionProbeType=e;for(var t=this._subModels,i=0;i<t.length;i++)t[i].useReflectionProbeType=e;this.onMacroPatchesStateChanged()}},{key:"reflectionProbeId",get:function(){return this._reflectionProbeId},set:function(e){this._reflectionProbeId=e}},{key:"initialize",value:function(){this._inited||(this._receiveShadow=!0,this.castShadow=!1,this.enabled=!0,this.visFlags=ep.Enum.NONE,this._inited=!0,this._bakeToReflectionProbe=!0,this._reflectionProbeType=0)}},{key:"destroy",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)this._subModels[t].destroy();this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._localSHBuffer&&(this._localSHBuffer.destroy(),this._localSHBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1}},{key:"attachToScene",value:function(e){this.scene=e,this._localDataUpdated=!0}},{key:"detachFromScene",value:function(){this.scene=null}},{key:"updateTransform",value:function(){var e=this.transform;if(e.hasChangedFlags||e.isTransformDirty()){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}}},{key:"updateWorldBound",value:function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}}},{key:"updateUBOs",value:function(e){for(var t=this._subModels,i=0;i<t.length;i++)t[i].update();this._updateStamp=e,this.updateSHUBOs();var n=this.node.scene.globals.shadows.enabled&&this.node.scene.globals.shadows.type===pA.Planar;if(this._localDataUpdated){this._localDataUpdated=!1;for(var r=this.transform._mat,s=!1,a=0;a<t.length;a++){var o=t[a],u=o.instancedWorldMatrixIndex;u>=0?o.updateInstancedWorldMatrix(r,u):s=!0}(s||n)&&this._localBuffer&&(Cn.toArray(this._localData,r,Mv.MAT_WORLD_OFFSET),Cn.inverseTranspose(px,r),Cn.toArray(this._localData,px,Mv.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}}},{key:"showTetrahedron",value:function(){return this.isLightProbeAvailable()}},{key:"isLightProbeAvailable",value:function(){if(!this._useLightProbe)return!1;var e=B.director.root.pipeline.pipelineSceneData.lightProbes;return!(!e||e.empty()||!this._worldBounds)}},{key:"updateSHBuffer",value:function(){if(this._localSHData){for(var e=this._subModels,t=!1,i=0;i<e.length;i++){var n=e[i],r=n.instancedSHIndex;r>=0?n.updateInstancedSH(this._localSHData,r):t=!0}t&&this._localSHBuffer&&this._localSHBuffer.update(this._localSHData)}}},{key:"clearSHUBOs",value:function(){if(this._localSHData){for(var e=0;e<jv.COUNT;e++)this._localSHData[e]=0;this.updateSHBuffer()}}},{key:"updateSHUBOs",value:function(){if(this.isLightProbeAvailable()){var e=this._worldBounds.center;if(!e.equals(this._lastWorldBoundCenter,Mi)){var t=[],i=new en(0,0,0,0),n=B.director.root.pipeline.pipelineSceneData.lightProbes;this._lastWorldBoundCenter.set(e),this._tetrahedronIndex=n.data.getInterpolationWeights(e,this._tetrahedronIndex,i),n.data.getInterpolationSHCoefficients(this._tetrahedronIndex,i,t)&&this._localSHData&&(B.internal.SH.reduceRinging(t,n.reduceRinging),B.internal.SH.updateUBOData(this._localSHData,jv.SH_LINEAR_CONST_R_OFFSET,t),this.updateSHBuffer())}}}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=ms.fromPoints(ms.create(),e,t),this._worldBounds=ms.clone(this._modelBounds))}},{key:"_createSubModel",value:function(){return new sx}},{key:"initSubModel",value:function(e,t,i){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)}},{key:"setSubModelMesh",value:function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)}},{key:"setSubModelMaterial",value:function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()}},{key:"onMacroPatchesStateChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))}},{key:"onGeometryChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onGeometryChanged()}},{key:"initLightingmap",value:function(e,t){this._lightmap=e,this._lightmapUVParam=t}},{key:"updateLightingmap",value:function(e,t){en.toArray(this._localData,t,Mv.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,this.onMacroPatchesStateChanged(),e||(e=HS.get("empty-texture"));var i=e.getGFXTexture();if(i)for(var n=this._device.getSampler(e.mipmaps.length>1?bx:Ex),r=this._subModels,s=0;s<r.length;s++){var a=r[s].descriptorSet;a.bindTexture(uy,i),a.bindSampler(uy,n),a.update()}}},{key:"updateReflectionProbeCubemap",value:function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),e||(e=HS.get("default-cube-texture"));var t=e.getGFXTexture();if(t)for(var i=this._device.getSampler(e.getSamplerInfo()),n=this._subModels,r=0;r<n.length;r++){var s=n[r].descriptorSet;s&&(s.bindSampler(Sy,i),s.bindTexture(Sy,t),s.update())}}},{key:"updateReflectionProbePlanarMap",value:function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged();var t=this._device.getSampler(new jc(Kl.LINEAR,Kl.LINEAR,Kl.NONE,Ql.CLAMP,Ql.CLAMP,Ql.CLAMP));if(e||(e=HS.get("empty-texture").getGFXTexture()),e)for(var i=this._subModels,n=0;n<i.length;n++){var r=i[n].descriptorSet;r&&(r.bindTexture(Ey,e),r.bindSampler(Ey,t),r.update())}}},{key:"updateReflectionProbeDataMap",value:function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),e||(e=HS.get("empty-texture"));var t=e.getGFXTexture();if(t)for(var i=this._subModels,n=0;n<i.length;n++){var r=i[n].descriptorSet;r&&(r.bindTexture(Ry,t),r.bindSampler(Ry,e.getGFXSampler()),r.update())}}},{key:"updateLocalShadowBias",value:function(){var e=this._localData;e[Mv.LOCAL_SHADOW_BIAS+0]=this._shadowBias,e[Mv.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,this._localDataUpdated=!0}},{key:"updateReflectionProbeId",value:function(){var e=this._localData;e[Mv.LOCAL_SHADOW_BIAS+2]=this._reflectionProbeId,e[Mv.LOCAL_SHADOW_BIAS+3]=0;var t=null;B.internal.reflectionProbeManager&&(t=B.internal.reflectionProbeManager.getProbeById(this._reflectionProbeId)),t&&(t.probeType===hx.PLANAR?(e[Mv.REFLECTION_PROBE_DATA1]=t.node.up.x,e[Mv.REFLECTION_PROBE_DATA1+1]=t.node.up.y,e[Mv.REFLECTION_PROBE_DATA1+2]=t.node.up.z,e[Mv.REFLECTION_PROBE_DATA1+3]=1,e[Mv.REFLECTION_PROBE_DATA2]=1,e[Mv.REFLECTION_PROBE_DATA2+1]=0,e[Mv.REFLECTION_PROBE_DATA2+2]=0,e[Mv.REFLECTION_PROBE_DATA2+3]=1):(e[Mv.REFLECTION_PROBE_DATA1]=t.node.worldPosition.x,e[Mv.REFLECTION_PROBE_DATA1+1]=t.node.worldPosition.y,e[Mv.REFLECTION_PROBE_DATA1+2]=t.node.worldPosition.z,e[Mv.REFLECTION_PROBE_DATA1+3]=0,e[Mv.REFLECTION_PROBE_DATA2]=t.size.x,e[Mv.REFLECTION_PROBE_DATA2+1]=t.size.y,e[Mv.REFLECTION_PROBE_DATA2+2]=t.size.z,e[Mv.REFLECTION_PROBE_DATA2+3]=t.cubemap?t.cubemap.mipmapLevel:1)),this._localDataUpdated=!0}},{key:"getMacroPatches",value:function(){var e=this.receiveShadow?vx:null;if(null!=this._lightmap){var t=!1;this.node&&this.node.scene&&(t=this.node.scene.globals.bakedWithStationaryMainLight);var i=t?gx:yx;e=e?e.concat(i):i,this.node.scene.globals.bakedWithHighpLightmap&&(e=e.concat(Sx))}this._useLightProbe&&(e=e?e.concat(Ax):Ax);var n=[{name:"CC_USE_REFLECTION_PROBE",value:this._reflectionProbeType}];e=e?e.concat(n):n;var r=[{name:"CC_DISABLE_DIRECTIONAL_LIGHT",value:!this._receiveDirLight}];return e?e.concat(r):r}},{key:"_updateAttributesAndBinding",value:function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initLocalSHDescriptors(e),this._updateLocalSHDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),t.worldBoundDescriptorSet&&this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var i=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(i.attributes,t)}}},{key:"_updateInstancedAttributes",value:function(e,t){t.UpdateInstancedAttributes(e),this._localDataUpdated=!0}},{key:"_initLocalDescriptors",value:function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.DEVICE,Mv.SIZE,Mv.SIZE)))}},{key:"_initLocalSHDescriptors",value:function(){this._useLightProbe&&(this._localSHData||(this._localSHData=new Float32Array(jv.COUNT)),this._localSHBuffer||(this._localSHBuffer=this._device.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.DEVICE,jv.SIZE,jv.SIZE))))}},{key:"_initWorldBoundDescriptors",value:function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.DEVICE,Ov.SIZE,Ov.SIZE)))}},{key:"_updateLocalDescriptors",value:function(e,t){this._localBuffer&&t.bindBuffer(Mv.BINDING,this._localBuffer)}},{key:"_updateLocalSHDescriptors",value:function(e,t){this._localSHBuffer&&t.bindBuffer(jv.BINDING,this._localSHBuffer)}},{key:"_updateWorldBoundDescriptors",value:function(e,t){this._worldBoundBuffer&&t.bindBuffer(Ov.BINDING,this._worldBoundBuffer)}}]),e}(),Rx=function(){function e(){n(this,e),this._enabled=!1,this._minPos=new an(0,0,0),this._maxPos=new an(0,0,0),this._depth=0}return s(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"initialize",value:function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth}}]),e}();function xx(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),s=2*n-8*r+4,a=3*n/s,o=2*r/s,u=1/o*a,h=1/o*(1-a-o);e.x=3.2404542*u-1.5371385+-.4985314*h,e.y=-.969266*u+1.8760108+.041556*h,e.z=.0556434*u-.2040259+1.0572252*h}!function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(Tx||(Tx={}));var wx,kx,Ix,Bx,Px,Mx,Ox,Dx,Lx,Nx,Fx,Gx=function(e){return 4*Math.PI*Math.PI*e*e},Vx=function(){function e(){n(this,e),this._baked=!1,this._color=new an(1,1,1),this._colorTemp=6550,this._colorTempRGB=new an(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Tx.UNKNOWN,this._visibility=Py}return s(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,xx(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=ip.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"initialize",value:function(){this.color=new an(1,1,1),this.colorTemperature=6550}},{key:"attachToScene",value:function(e){this._scene=e}},{key:"detachFromScene",value:function(){this._scene=null}},{key:"destroy",value:function(){this._name=null,this._node=null}},{key:"update",value:function(){}}]),e}(),Ux=new an(0,0,-1),Hx=new an,zx=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._dir=new an(1,-1,-1),e._illuminanceHDR=ev.SUN_ILLUM,e._illuminanceLDR=1,e._shadowEnabled=!1,e._shadowPcf=vA.HARD,e._shadowBias=1e-5,e._shadowNormalBias=0,e._shadowSaturation=1,e._shadowDistance=50,e._shadowInvisibleOcclusionRange=200,e._csmLevel=yA.LEVEL_4,e._csmNeedUpdate=!1,e._csmLayerLambda=.75,e._csmOptimizationMode=gA.DisableRotationFix,e._csmLayersTransition=!1,e._csmTransitionRange=.05,e._shadowFixedArea=!1,e._shadowNear=.1,e._shadowFar=10,e._shadowOrthoSize=5,e._type=Tx.DIRECTIONAL,e}return s(i,[{key:"direction",get:function(){return this._dir},set:function(e){an.normalize(this._dir,e)}},{key:"illuminance",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._activate()}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._activate()}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,AA.MAX_FAR)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,AA.MAX_FAR)}},{key:"csmLevel",get:function(){return this._csmLevel},set:function(e){this._csmLevel=e,this._activate()}},{key:"csmNeedUpdate",get:function(){return this._csmNeedUpdate},set:function(e){this._csmNeedUpdate=e}},{key:"csmLayerLambda",get:function(){return this._csmLayerLambda},set:function(e){this._csmLayerLambda=e}},{key:"csmOptimizationMode",get:function(){return this._csmOptimizationMode},set:function(e){this._csmOptimizationMode=e}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e,this._activate()}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,AA.MAX_FAR)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e}},{key:"csmLayersTransition",get:function(){return this._csmLayersTransition},set:function(e){this._csmLayersTransition=e,this._activate()}},{key:"csmTransitionRange",get:function(){return this._csmTransitionRange},set:function(e){this._csmTransitionRange=e}},{key:"initialize",value:function(){g(l(i.prototype),"initialize",this).call(this),this.illuminance=ev.SUN_ILLUM,this.direction=new an(1,-1,-1)}},{key:"update",value:function(){this._node&&this._node.hasChangedFlags&&(this.direction=an.transformQuat(Hx,Ux,this._node.worldRotation))}},{key:"_activate",value:function(){var e=B.director.root,t=e.pipeline;this._shadowEnabled?(this._shadowFixedArea||!t.pipelineSceneData.csmSupported?t.macros.CC_DIR_LIGHT_SHADOW_TYPE=1:this.csmLevel>1&&t.pipelineSceneData.csmSupported?(t.macros.CC_DIR_LIGHT_SHADOW_TYPE=2,t.macros.CC_CASCADED_LAYERS_TRANSITION=this._csmLayersTransition):t.macros.CC_DIR_LIGHT_SHADOW_TYPE=1,t.macros.CC_DIR_SHADOW_PCF_TYPE=this._shadowPcf):t.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,e.onGlobalPipelineStateChanged()}}]),i}(Vx),Wx=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=ms.create(),e._pos=new an,e._type=Tx.SPHERE,e}return s(i,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}},{key:"initialize",value:function(){g(l(i.prototype),"initialize",this).call(this),this.size=.15,this.range=1,this.luminanceHDR=1700/Gx(.15),this.luminanceLDR=1}},{key:"update",value:function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;ms.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}}}]),i}(Vx),Xx=new an(0,0,-1),jx=new vn,qx=new Cn,Yx=new Cn,Kx=new Cn,Qx=new Cn,Jx=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._dir=new an(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._shadowEnabled=!1,e._shadowPcf=vA.HARD,e._shadowBias=1e-5,e._shadowNormalBias=0,e._aabb=ms.create(),e._frustum=Ts.create(),e._pos=new an,e._type=Tx.SPOT,e}return s(i,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return B.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){B.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"initialize",value:function(){g(l(i.prototype),"initialize",this).call(this),this.size=.15,this.luminanceHDR=1700/Gx(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._dir.set(new an(1,-1,-1))}},{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),an.transformQuat(this._dir,Xx,this._node.getWorldRotation(jx)),an.normalize(this._dir,this._dir),ms.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(qx),Cn.invert(qx,qx),Cn.perspective(Yx,this._angle,1,.001,this._range),Cn.multiply(Kx,Yx,qx),this._frustum.update(Kx,Qx),this._needUpdate=!1)}}]),i}(Vx),Zx=function(){function e(){n(this,e),this.screenUsagePercentage=1,this._models=[]}return s(e,[{key:"models",get:function(){return this._models}},{key:"addModel",value:function(e){this._models.splice(0,0,e)}},{key:"eraseModel",value:function(e){var t=this._models.indexOf(e);t>=0&&this._models.splice(t,1)}},{key:"clearModels",value:function(){this._models.length=0}}]),e}(),$x=function(){function e(){n(this,e),this.scene=void 0,this.node=null,this._device=void 0,this.enabled=!0,this._localBoundaryCenter=new an(0,0,0),this._objectSize=1,this._lodDataArray=[],this._lockedLODLevelVec=[],this._isLockLevelChanged=!1,this._device=yf.gfxDevice}return s(e,[{key:"localBoundaryCenter",get:function(){return this._localBoundaryCenter.clone()},set:function(e){this._localBoundaryCenter.set(e)}},{key:"lodCount",get:function(){return this._lodDataArray.length}},{key:"objectSize",get:function(){return this._objectSize},set:function(e){this._objectSize=e}},{key:"lodDataArray",get:function(){return this._lodDataArray}},{key:"attachToScene",value:function(e){this.scene=e}},{key:"detachFromScene",value:function(){this.scene=null}},{key:"lockLODLevels",value:function(e){if(e.length!==this._lockedLODLevelVec.length)this._isLockLevelChanged=!0;else for(var t=e.length,i=0;i<t;i++)if(e[i]!==this._lockedLODLevelVec[i]){this._isLockLevelChanged=!0;break}this._lockedLODLevelVec=e}},{key:"isLockLevelChanged",value:function(){return this._isLockLevelChanged}},{key:"resetLockChangeFlag",value:function(){this._isLockLevelChanged=!1}},{key:"getLockedLODLevels",value:function(){return this._lockedLODLevelVec}},{key:"clearLODs",value:function(){this._lodDataArray.length=0}},{key:"insertLOD",value:function(e,t){this._lodDataArray.splice(e,0,t)}},{key:"updateLOD",value:function(e,t){this._lodDataArray[e]=t}},{key:"eraseLOD",value:function(e){this._lodDataArray.splice(e,1)}},{key:"getVisibleLODLevel",value:function(e){for(var t=this.getScreenUsagePercentage(e),i=-1,n=0;n<this.lodCount;++n)if(t>=this.lodDataArray[n].screenUsagePercentage){i=n;break}return i}},{key:"getScreenUsagePercentage",value:function(e){return this.node?(e.projectionType===MR.PERSPECTIVE&&(t=an.len(this.localBoundaryCenter.transformMat4(this.node.worldMatrix).subtract(e.node.worldPosition))),this.distanceToScreenUsagePercentage(e,t,this.getWorldSpaceSize())):0;var t}},{key:"distanceToScreenUsagePercentage",value:function(e,t,i){return e.projectionType===MR.PERSPECTIVE?i*e.matProj.m05/(2*t):i*e.matProj.m05*.5}},{key:"getWorldSpaceSize",value:function(){var e=this.node.scale;return Math.max(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z))*this.objectSize}}]),e}(),ew=Object.freeze({__proto__:null,get CameraFOVAxis(){return PR},get CameraProjection(){return MR},get CameraAperture(){return OR},get CameraISO(){return DR},get CameraShutter(){return LR},get CameraType(){return NR},get TrackingType(){return FR},get CameraUsage(){return GR},SKYBOX_FLAG:qR,Camera:KR,get ModelType(){return fx},Model:Cx,SubModel:sx,Ambient:ev,EnvironmentLightingType:RA,Skybox:xA,ShadowSize:mA,ShadowType:pA,PCFType:vA,CSMLevel:yA,CSMOptimizationMode:gA,Shadows:AA,FogType:ME,Fog:DE,Octree:Rx,ColorTemperatureToRGB:xx,get LightType(){return Tx},nt2lm:Gx,Light:Vx,DirectionalLight:zx,SphereLight:Wx,SpotLight:Jx,get ProbeClearFlag(){return ux},get ProbeType(){return hx},ReflectionProbe:mx,LODData:Zx,LODGroup:$x});!function(e){e[e.PER_INSTANCE=0]="PER_INSTANCE",e[e.PER_BATCH=1]="PER_BATCH",e[e.PER_PHASE=2]="PER_PHASE",e[e.PER_PASS=3]="PER_PASS",e[e.COUNT=4]="COUNT"}(wx||(wx={})),function(e){e[e.CONSTANTS=0]="CONSTANTS",e[e.CBV=1]="CBV",e[e.UAV=2]="UAV",e[e.SRV=3]="SRV",e[e.TABLE=4]="TABLE",e[e.SSV=5]="SSV"}(kx||(kx={})),function(e){e[e.MANAGED=0]="MANAGED",e[e.MEMORYLESS=1]="MEMORYLESS",e[e.PERSISTENT=2]="PERSISTENT",e[e.EXTERNAL=3]="EXTERNAL",e[e.BACKBUFFER=4]="BACKBUFFER"}(Ix||(Ix={})),function(e){e[e.NONE=0]="NONE",e[e.RENDER_OPAQUE=1]="RENDER_OPAQUE",e[e.RENDER_CUTOUT=2]="RENDER_CUTOUT",e[e.RENDER_TRANSPARENT=3]="RENDER_TRANSPARENT"}(Bx||(Bx={})),function(e){e[e.BUFFER=0]="BUFFER",e[e.TEXTURE1D=1]="TEXTURE1D",e[e.TEXTURE2D=2]="TEXTURE2D",e[e.TEXTURE3D=3]="TEXTURE3D"}(Px||(Px={})),function(e){e[e.NONE=0]="NONE",e[e.UNIFORM=1]="UNIFORM",e[e.INDIRECT=2]="INDIRECT",e[e.STORAGE=4]="STORAGE",e[e.SAMPLED=8]="SAMPLED",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT",e[e.SHADING_RATE=128]="SHADING_RATE"}(Mx||(Mx={})),function(e){e[e.SYNC=0]="SYNC",e[e.ASYNC=1]="ASYNC"}(Ox||(Ox={})),function(e){e[e.NONE=0]="NONE",e[e.OPAQUE_OBJECT=1]="OPAQUE_OBJECT",e[e.CUTOUT_OBJECT=2]="CUTOUT_OBJECT",e[e.TRANSPARENT_OBJECT=4]="TRANSPARENT_OBJECT",e[e.SHADOW_CASTER=8]="SHADOW_CASTER",e[e.UI=16]="UI",e[e.DEFAULT_LIGHTING=32]="DEFAULT_LIGHTING",e[e.VOLUMETRIC_LIGHTING=64]="VOLUMETRIC_LIGHTING",e[e.CLUSTERED_LIGHTING=128]="CLUSTERED_LIGHTING",e[e.PLANAR_SHADOW=256]="PLANAR_SHADOW",e[e.GEOMETRY=512]="GEOMETRY",e[e.PROFILER=1024]="PROFILER",e[e.DRAW_INSTANCING=2048]="DRAW_INSTANCING",e[e.DRAW_NON_INSTANCING=4096]="DRAW_NON_INSTANCING",e[e.REFLECTION_PROBE=8192]="REFLECTION_PROBE",e[e.ALL=4294967295]="ALL"}(Dx||(Dx={})),function(e){e[e.NONE=0]="NONE",e[e.DEFAULT=1]="DEFAULT",e[e.CLUSTERED=2]="CLUSTERED"}(Lx||(Lx={})),function(e){e[e.RENDER_TARGET=0]="RENDER_TARGET",e[e.DEPTH_STENCIL=1]="DEPTH_STENCIL",e[e.SHADING_RATE=2]="SHADING_RATE"}(Nx||(Nx={})),function(e){e[e.READ=0]="READ",e[e.READ_WRITE=1]="READ_WRITE",e[e.WRITE=2]="WRITE"}(Fx||(Fx={}));var tw,iw=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Fx.WRITE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Nx.RENDER_TARGET,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:nc.LOAD,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:rc.STORE,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:yc.ALL,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:new Dc;n(this,e),this.slotName=void 0,this.accessType=void 0,this.attachmentType=void 0,this.loadOp=void 0,this.storeOp=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.slotID=0,this.slotName=t,this.accessType=i,this.attachmentType=r,this.loadOp=s,this.storeOp=a,this.clearFlags=o,this.clearColor=u};!function(e){e[e.FLOAT_TYPE=0]="FLOAT_TYPE",e[e.INT_TYPE=1]="INT_TYPE"}(tw||(tw={}));var nw,rw,sw=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Fx.READ,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:yc.NONE,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Dc,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:tw.FLOAT_TYPE;n(this,e),this.name=void 0,this.accessType=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.clearValueType=void 0,this.name=t,this.accessType=i,this.clearFlags=r,this.clearColor=s,this.clearValueType=a},aw=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;n(this,e),this.light=void 0,this.level=void 0,this.light=t,this.level=i};!function(e){e[e.UNIFORM_BUFFER=0]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=1]="DYNAMIC_UNIFORM_BUFFER",e[e.SAMPLER_TEXTURE=2]="SAMPLER_TEXTURE",e[e.SAMPLER=3]="SAMPLER",e[e.TEXTURE=4]="TEXTURE",e[e.STORAGE_BUFFER=5]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=6]="DYNAMIC_STORAGE_BUFFER",e[e.STORAGE_IMAGE=7]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=8]="INPUT_ATTACHMENT"}(nw||(nw={})),pe(kd.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),me(_x.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var ow=(a(rw={},Nl.UNORM,"Uint"),a(rw,Nl.SNORM,"Int"),a(rw,Nl.UINT,"Uint"),a(rw,Nl.INT,"Int"),a(rw,Nl.UFLOAT,"Float"),a(rw,Nl.FLOAT,"Float"),a(rw,"default","Uint"),rw);function uw(e){var t=ow[e.type]||ow.default,i=e.size/e.count*8;return"".concat(t).concat(i)}function hw(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ll.R32F,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=x_[i];r||(r=s.size);for(var a="set".concat(uw(s)),o=s.size/s.count,u=Math.floor(t.length/s.count),h=Sl.isLittleEndian,l=0;l<u;++l)for(var c=n+r*l,_=0;_<s.count;++_){var f=c+o*_;e[a](f,t[s.count*l+_],h)}}function lw(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ll.R32F,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.byteLength-n,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6?arguments[6]:void 0;a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var o=x_[i];s||(s=o.size);for(var u="set".concat(uw(o)),h="get".concat(uw(o)),l=o.size/o.count,c=Math.floor(r/s),_=Sl.isLittleEndian,f=0;f<c;++f)for(var d=n+s*f,m=0;m<o.count;++m){var p=d+l*m,v=e[h](p,_);a[u](p,t(v,m,e),_)}return a}var cw,_w=e("RenderingSubMesh",function(){function e(t,i,r){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];n(this,e),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._isOwnerOfIndexBuffer=!0,this._drawInfo=null,this._attributes=i,this._vertexBuffers=t,this._indexBuffer=s,this._indirectBuffer=a,this._primitiveMode=r,this._iaInfo=new r_(i,t,s,a),this._isOwnerOfIndexBuffer=o}return s(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:an.ZERO,max:an.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:an.ZERO,max:an.ZERO}};var e=this.mesh,t=this.subMeshIdx,i=e.readAttribute(t,Tc.ATTR_POSITION),n=e.readIndices(t),r=new an,s=new an,a=this.attributes.find((function(e){return e.name===Tc.ATTR_POSITION}));if(a){var o=x_[a.format].count;2===o?(r.set(i[0],i[1],0),s.set(i[0],i[1],0)):(r.set(i[0],i[1],i[2]),s.set(i[0],i[1],i[2]));for(var u=0;u<i.length;u+=o)2===o?(r.x=i[u]>r.x?i[u]:r.x,r.y=i[u+1]>r.y?i[u+1]:r.y,s.x=i[u]<s.x?i[u]:s.x,s.y=i[u+1]<s.y?i[u+1]:s.y):(r.x=i[u]>r.x?i[u]:r.x,r.y=i[u+1]>r.y?i[u+1]:r.y,r.z=i[u+2]>r.z?i[u+2]:r.z,s.x=i[u]<s.x?i[u]:s.x,s.y=i[u+1]<s.y?i[u+1]:s.y,s.z=i[u+2]<s.z?i[u+2]:s.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:r,min:s}},this._geometricInfo}},{key:"invalidateGeometricInfo",value:function(){this._geometricInfo=void 0}},{key:"drawInfo",get:function(){return this._drawInfo},set:function(e){this._drawInfo=e}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"genFlatBuffers",value:function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,i=e.struct.primitives[this.subMeshIdx];i.indexView&&(t=i.indexView.count);for(var n=0;n<i.vertexBundelIndices.length;n++){var r=i.vertexBundelIndices[n],s=e.struct.vertexBundles[r],a=i.indexView?i.indexView.count:s.view.count,o=s.view.stride,u=o*a,h=new Uint8Array(e.data.buffer,s.view.offset,s.view.length),l=new Uint8Array(i.indexView?u:s.view.length);if(i.indexView){for(var c=e.readIndices(this.subMeshIdx),_=0;_<t;++_)for(var f=_*o,d=c[_]*o,m=0;m<o;++m)l[f+m]=h[d+m];this._flatBuffers.push({stride:o,count:a,buffer:l})}else l.set(e.data.subarray(s.view.offset,s.view.offset+s.view.length)),this._flatBuffers.push({stride:o,count:a,buffer:l})}}}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],i=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var n,r,s=this.mesh.struct,a=s.primitives[this.subMeshIdx];if(!s.jointMaps||void 0===a.jointMapIndex||!s.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var o=B.director.root.device,u=0;u<a.vertexBundelIndices.length;u++){var h=s.vertexBundles[a.vertexBundelIndices[u]];r=0,n=Ll.UNKNOWN;for(var l=0;l<h.attributes.length;l++){var c=h.attributes[l];if(c.name===Tc.ATTR_JOINTS){n=c.format;break}r+=x_[c.format].size}n?function(){var l=new Uint8Array(e.mesh.data.buffer,h.view.offset,h.view.length),c=new DataView(l.slice().buffer),_=s.jointMaps[a.jointMapIndex];lw(c,(function(e){return _.indexOf(e)}),n,r,h.view.length,h.view.stride,c);var f=o.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE,h.view.length,h.view.stride));f.update(c.buffer),t.push(f),i.push(u)}():t.push(this.vertexBuffers[a.vertexBundelIndices[u]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(o)),t}},{key:"iaInfo",get:function(){return this._iaInfo}},{key:"destroy",value:function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._isOwnerOfIndexBuffer&&this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)}},{key:"enableVertexIdChannel",value:function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(e);this._vertexBuffers.push(n),this._attributes.push(new i_("a_vertexId",Ll.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:i}}}},{key:"_allocVertexIdBuffer",value:function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(t),n=0;n<t;++n)i[n]=n+.5;var r=e.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return r.update(i),r}}]),e}());!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA",e[e.FXAAHQ=2]="FXAAHQ"}(cw||(cw={}));var fw=[];function dw(e){return fw.includes(e)||fw.push(e),fw.indexOf(e)}function mw(e,t){var i=nc.CLEAR;return e&yc.COLOR||t!==Nx.RENDER_TARGET||(i=e&qR?nc.CLEAR:nc.LOAD),(e&yc.DEPTH_STENCIL)!==yc.DEPTH_STENCIL&&t===Nx.DEPTH_STENCIL&&(e&yc.DEPTH||(i=nc.LOAD),e&yc.STENCIL||(i=nc.LOAD)),i}function pw(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=new xc,a=e?e.viewport:new xc(0,0,1,1),o=t,u=i;if(s.x=a.x*o,s.y=a.y*u,s.width=a.width*o,s.height=a.height*u,n)switch(n.type){case Tx.DIRECTIONAL:var h=n;if(h.shadowFixedArea||h.csmLevel===yA.LEVEL_1)s.x=0,s.y=0,s.width=o,s.height=u;else{var l=B.director.root.device.capabilities.screenSpaceSignY;s.x=r%2*.5*o,s.y=l?.5*(1-Math.floor(r/2))*u:.5*Math.floor(r/2)*u,s.width=.5*o,s.height=.5*u}break;case Tx.SPOT:s.x=0,s.y=0,s.width=o,s.height=u}return s}s((function e(){n(this,e),this._init()}),[{key:"_updateFxaaPass",value:function(){if(this.fxaaMaterial){var e=this.fxaaMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}}},{key:"_init",value:function(){if(!this.fxaaMaterial){this.fxaaMaterial=new dA,this.fxaaMaterial._uuid="builtin-fxaa-material",this.fxaaMaterial.initialize({effectName:"pipeline/fxaa-hq"});for(var e=0;e<this.fxaaMaterial.passes.length;++e)this.fxaaMaterial.passes[e].tryCompile();this._updateFxaaPass()}}}]),s((function e(){n(this,e),this.threshold=.1,this.iterations=2,this.intensity=.8,this._init()}),[{key:"_updateBloomPass",value:function(){if(this.bloomMaterial){var e=this.bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=0;t<6;++t){var i=this.bloomMaterial.passes[1+t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently();var n=this.bloomMaterial.passes[7+t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}var r=this.bloomMaterial.passes[13];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}}},{key:"_init",value:function(){if(!this.bloomMaterial){this.bloomMaterial=new dA,this.bloomMaterial._uuid="builtin-bloom-material",this.bloomMaterial.initialize({effectName:"pipeline/bloom"});for(var e=0;e<this.bloomMaterial.passes.length;++e)this.bloomMaterial.passes[e].tryCompile();this._updateBloomPass()}}}]);var vw=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:cw.NONE;n(this,e),this.antiAliasing=cw.NONE,this.antiAliasing=t,this._init()}return s(e,[{key:"_init",value:function(){this.postMaterial=new dA,this.postMaterial.name="builtin-post-process-material",Lt.ENABLE_ANTIALIAS_FXAA&&(this.antiAliasing=cw.FXAA),this.postMaterial.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this.antiAliasing}});for(var e=0;e<this.postMaterial.passes.length;++e)this.postMaterial.passes[e].tryCompile()}}]),e}(),yw=null;function gw(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:cw.NONE;(!yw||yw&&yw.antiAliasing!==n)&&(yw=new vw(n));var r=dw(e),s=pw(e,e.window.width,e.window.height),a=s.width,o=s.height,u="postprocessPassRTName".concat(r),h="postprocessPassDS".concat(r);t.containsResource(u)||(t.addRenderTexture(u,Ll.BGRA8,a,o,e.window),t.addDepthStencil(h,Ll.DEPTH_STENCIL,a,o,Ix.MANAGED)),t.updateRenderWindow(u,e.window),t.updateDepthStencil(h,a,o);var l=t.addRasterPass(a,o,"post-process");if(l.name="CameraPostprocessPass".concat(r),l.setViewport(new Oc(s.x,s.y,s.width,s.height)),t.containsResource(i)){var c=new sw;c.name="outputResultMap",l.addComputeView(i,c)}var _=new Dc(0,0,0,e.clearColor.w);e.clearFlag&yc.COLOR&&(_.x=e.clearColor.x,_.y=e.clearColor.y,_.z=e.clearColor.z);var f=new iw("_",Fx.WRITE,Nx.RENDER_TARGET,mw(e.clearFlag,Nx.RENDER_TARGET),rc.STORE,e.clearFlag,_),d=new iw("_",Fx.WRITE,Nx.DEPTH_STENCIL,mw(e.clearFlag,Nx.DEPTH_STENCIL),rc.STORE,e.clearFlag,new Dc(e.clearDepth,e.clearStencil,0,0));return l.addRasterView(u,f),l.addRasterView(h,d),l.addQueue(Bx.NONE).addFullscreenQuad(yw.postMaterial,0,Dx.NONE),l.addQueue(Bx.RENDER_TRANSPARENT).addSceneOfCamera(e,new aw,Dx.UI),cA()===e&&(l.showStatistics=!0),{rtName:u,dsName:h}}function Sw(e,t,i){var n=dw(e),r="Camera".concat(n),s=Ew(r,e,t),a=pw(e,e.window.width,e.window.height),o=a.width,u=a.height,h="dsForwardPassColor".concat(r),l="dsForwardPassDS".concat(r);t.containsResource(h)||(i?t.addRenderTarget(h,Ll.RGBA16F,o,u,Ix.MANAGED):t.addRenderTexture(h,Ll.BGRA8,o,u,e.window),t.addDepthStencil(l,Ll.DEPTH_STENCIL,o,u,Ix.MANAGED)),i?(t.updateRenderTarget(h,o,u),t.updateDepthStencil(l,o,u)):(t.updateRenderWindow(h,e.window),t.updateDepthStencil(l,o,u));var c=t.addRasterPass(o,u,"default");c.name="CameraForwardPass".concat(n),c.setViewport(new Oc(a.x,a.y,o,u));for(var _,f=R(s.mainLightShadowNames);!(_=f()).done;){var d=_.value;if(t.containsResource(d)){var m=new sw("cc_shadowMap");c.addComputeView(d,m)}}for(var p,v=R(s.spotLightShadowNames);!(p=v()).done;){var y=p.value;if(t.containsResource(y)){var g=new sw("cc_spotShadowMap");c.addComputeView(y,g)}}var S=new iw("_",Fx.WRITE,Nx.RENDER_TARGET,i?nc.CLEAR:mw(e.clearFlag,Nx.RENDER_TARGET),rc.STORE,e.clearFlag,new Dc(e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w)),A=new iw("_",Fx.WRITE,Nx.DEPTH_STENCIL,i?nc.CLEAR:mw(e.clearFlag,Nx.DEPTH_STENCIL),rc.STORE,e.clearFlag,new Dc(e.clearDepth,e.clearStencil,0,0));c.addRasterView(h,S),c.addRasterView(l,A),c.addQueue(Bx.RENDER_OPAQUE).addSceneOfCamera(e,new aw,Dx.OPAQUE_OBJECT|Dx.PLANAR_SHADOW|Dx.CUTOUT_OBJECT|Dx.DEFAULT_LIGHTING|Dx.DRAW_INSTANCING);var T=Dx.TRANSPARENT_OBJECT|Dx.GEOMETRY;return i||(T|=Dx.UI,c.showStatistics=!0),c.addQueue(Bx.RENDER_TRANSPARENT).addSceneOfCamera(e,new aw,T),{rtName:h,dsName:l}}function Aw(e,t,i,n,r,s,a){var o=s,u=a,h=pw(i,s,a,n,r);s=h.width,a=h.height;var l=t.device,c=e;if(!t.containsResource(c)){var _=Dy(l)?Ll.R32F:Ll.RGBA8;t.addRenderTarget(c,_,o,u,Ix.MANAGED),t.addDepthStencil("".concat(c,"Depth"),Ll.DEPTH_STENCIL,o,u,Ix.MANAGED)}t.updateRenderTarget(c,o,u),t.updateDepthStencil("".concat(c,"Depth"),o,u);var f=t.addRasterPass(s,a,"default");f.name=e,f.setViewport(new Oc(h.x,h.y,h.width,h.height)),f.addRasterView(c,new iw("_",Fx.WRITE,Nx.RENDER_TARGET,nc.CLEAR,rc.STORE,yc.COLOR,new Dc(1,1,1,i.clearColor.w))),f.addRasterView("".concat(c,"Depth"),new iw("_",Fx.WRITE,Nx.DEPTH_STENCIL,nc.CLEAR,rc.DISCARD,yc.DEPTH_STENCIL,new Dc(i.clearDepth,i.clearStencil,0,0))),f.addQueue(Bx.RENDER_OPAQUE).addSceneOfCamera(i,new aw(n,r),Dx.SHADOW_CASTER)}var Tw=function e(){n(this,e),this.shadowEnabled=!1,this.mainLightShadowNames=new Array,this.spotLightShadowNames=new Array};function Ew(e,t,i){!function(e,t){var i=e.pipelineSceneData.validPunctualLights;i.length=0;for(var n=dr.create(0,0,0,1),r=t.scene.spotLights,s=0;s<r.length;s++){var a=r[s];a.baked||(dr.set(n,a.position.x,a.position.y,a.position.z,a.range),is.sphereFrustum(n,t.frustum)&&i.push(a))}for(var o=t.scene.sphereLights,u=0;u<o.length;u++){var h=o[u];h.baked||(dr.set(n,h.position.x,h.position.y,h.position.z,h.range),is.sphereFrustum(n,t.frustum)&&i.push(h))}}(i,t);var n=i,r=n.pipelineSceneData.shadows,s=i.pipelineSceneData.validPunctualLights,a=new Tw,o=i.pipelineSceneData.shadows;if(!r.enabled||r.type!==pA.ShadowMap)return a;a.shadowEnabled=!0;for(var u=[],h=0,l=0;h<r.maxReceived&&l<s.length;){var c=s[l];c.type===Tx.SPOT&&c.shadowEnabled&&(u.push(c),h++),l++}var _=t.scene.mainLight,f=o.size.x,d=o.size.y;if(_&&_.shadowEnabled)if(a.mainLightShadowNames[0]="MainLightShadow".concat(e),_.shadowFixedArea)Aw(a.mainLightShadowNames[0],i,t,_,0,f,d);else for(var m=n.pipelineSceneData.csmSupported?_.csmLevel:1,p=0;p<m;p++)a.mainLightShadowNames[p]="MainLightShadow".concat(e),Aw(a.mainLightShadowNames[p],i,t,_,p,f,d);for(var v=0;v<u.length;v++){var y=u[v],g="SpotLightShadow".concat(v.toString()).concat(e);a.spotLightShadowNames[v]=g,Aw(g,i,t,y,0,f,d)}return a}var bw=function e(){n(this,e)};function Cw(e,t){var i=dw(e),n=pw(e,e.window.width,e.window.height),r=n.width,s=n.height,a="gBufferPassColorCamera",o="gBufferPassNormal",u="gBufferPassEmissive",h="gBufferPassDSCamera";if(!t.containsResource(a)){var l=Ll.RGBA16F;t.addRenderTarget(a,l,r,s,Ix.MANAGED),t.addRenderTarget(o,l,r,s,Ix.MANAGED),t.addRenderTarget(u,l,r,s,Ix.MANAGED),t.addDepthStencil(h,Ll.DEPTH_STENCIL,r,s,Ix.MANAGED)}t.updateRenderTarget(a,r,s),t.updateRenderTarget(o,r,s),t.updateRenderTarget(u,r,s),t.updateDepthStencil(h,r,s);var c=t.addRasterPass(r,s,"default");c.name="CameraGBufferPass".concat(i),c.setViewport(new Oc(n.x,n.y,n.width,n.height));var _=new Dc(0,0,0,0);e.clearFlag&yc.COLOR&&(t.pipelineSceneData.isHDR?eA(_,e.clearColor):(_.x=e.clearColor.x,_.y=e.clearColor.y,_.z=e.clearColor.z));var f=new iw("_",Fx.WRITE,Nx.RENDER_TARGET,nc.CLEAR,rc.STORE,e.clearFlag,_),d=new iw("_",Fx.WRITE,Nx.RENDER_TARGET,nc.CLEAR,rc.STORE,e.clearFlag,new Dc(0,0,0,0)),m=new iw("_",Fx.WRITE,Nx.RENDER_TARGET,nc.CLEAR,rc.STORE,e.clearFlag,new Dc(0,0,0,0)),p=new iw("_",Fx.WRITE,Nx.DEPTH_STENCIL,nc.CLEAR,rc.STORE,e.clearFlag,new Dc(e.clearDepth,e.clearStencil,0,0));c.addRasterView(a,f),c.addRasterView(o,d),c.addRasterView(u,m),c.addRasterView(h,p),c.addQueue(Bx.RENDER_OPAQUE).addSceneOfCamera(e,new aw,Dx.OPAQUE_OBJECT|Dx.CUTOUT_OBJECT);var v=new bw;return v.color=a,v.normal=o,v.emissive=u,v.ds=h,v}var Rw=function(){function e(){n(this,e),this._init()}return s(e,[{key:"_init",value:function(){this.deferredLightingMaterial=new dA,this.deferredLightingMaterial.name="builtin-deferred-material",this.deferredLightingMaterial.initialize({effectName:"pipeline/deferred-lighting",defines:{CC_RECEIVE_SHADOW:1}});for(var e=0;e<this.deferredLightingMaterial.passes.length;++e)this.deferredLightingMaterial.passes[e].tryCompile()}}]),e}(),xw=null;function ww(e,t,i){xw||(xw=new Rw);var n=dw(e),r=Ew("Camera".concat(n),e,t),s=pw(e,e.window.width,e.window.height),a=s.width,o=s.height,u="deferredLightingPassRTName",h="deferredLightingPassDS";t.containsResource(u)||(t.addRenderTarget(u,Ll.RGBA8,a,o,Ix.MANAGED),t.addDepthStencil(h,Ll.DEPTH_STENCIL,a,o,Ix.MANAGED)),t.updateRenderTarget(u,a,o),t.updateDepthStencil(h,a,o);var l=t.addRasterPass(a,o,"deferred-lighting");l.name="CameraLightingPass".concat(n),l.setViewport(new Oc(s.x,s.y,a,o));for(var c,_=R(r.mainLightShadowNames);!(c=_()).done;){var f=c.value;if(t.containsResource(f)){var d=new sw("cc_shadowMap");l.addComputeView(f,d)}}for(var m,p=R(r.spotLightShadowNames);!(m=p()).done;){var v=m.value;if(t.containsResource(v)){var y=new sw("cc_spotShadowMap");l.addComputeView(v,y)}}if(t.containsResource(i.color)){var g=new sw;g.name="gbuffer_albedoMap",l.addComputeView(i.color,g);var S=new sw;S.name="gbuffer_normalMap",l.addComputeView(i.normal,S);var A=new sw;A.name="gbuffer_emissiveMap",l.addComputeView(i.emissive,A);var T=new sw;T.name="depth_stencil",l.addComputeView(i.ds,T)}var E=new Dc(0,0,0,0);e.clearFlag&yc.COLOR&&(E.x=e.clearColor.x,E.y=e.clearColor.y,E.z=e.clearColor.z),E.w=0;var b=new iw("_",Fx.WRITE,Nx.RENDER_TARGET,nc.CLEAR,rc.STORE,e.clearFlag,E);return l.addRasterView(u,b),l.addQueue(Bx.RENDER_TRANSPARENT).addCameraQuad(e,xw.deferredLightingMaterial,0,Dx.VOLUMETRIC_LIGHTING),{rtName:u,dsName:h}}function kw(e,t){var i=dw(e),n="Camera".concat(i),r=pw(e,e.window.width,e.window.height),s=r.width,a=r.height,o="dsUIAndProfilerPassColor".concat(n),u="dsUIAndProfilerPassDS".concat(n);t.containsResource(o)||(t.addRenderTexture(o,Ll.BGRA8,s,a,e.window),t.addDepthStencil(u,Ll.DEPTH_STENCIL,s,a,Ix.MANAGED)),t.updateRenderWindow(o,e.window),t.updateDepthStencil(u,s,a);var h=t.addRasterPass(s,a,"default");h.name="CameraUIAndProfilerPass".concat(i),h.setViewport(new Oc(r.x,r.y,s,a));var l=new iw("_",Fx.WRITE,Nx.RENDER_TARGET,mw(e.clearFlag,Nx.RENDER_TARGET),rc.STORE,e.clearFlag,new Dc(e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w)),c=new iw("_",Fx.WRITE,Nx.DEPTH_STENCIL,mw(e.clearFlag,Nx.DEPTH_STENCIL),rc.STORE,e.clearFlag,new Dc(e.clearDepth,e.clearStencil,0,0));h.addRasterView(o,l),h.addRasterView(u,c);var _=Dx.UI;h.addQueue(Bx.RENDER_TRANSPARENT).addSceneOfCamera(e,new aw,_),cA()===e&&(h.showStatistics=!0)}function Iw(e,t){for(var i,n=R(t.descriptorSetLayoutData.descriptorBlocks);!(i=n()).done;)for(var r=i.value,s=0;s!==r.descriptors.length;++s)if(e===r.descriptors[s].descriptorID)return r.offset+s;return-1}function Bw(e){for(var t,i=B.director.root.pipeline.layoutGraph,n=i.vertices(),r=i.attributeIndex.get(e),s=R(n);!(t=s()).done;)for(var a,o=t.value,u=R(i.getLayout(o).descriptorSets);!(a=u()).done;)for(var h,l=T(a.value,2),c=(l[0],l[1]),_=R(c.descriptorSetLayoutData.descriptorBlocks);!(h=_()).done;)for(var f,d=R(h.value.descriptors);!(f=d()).done;)if(f.value.descriptorID===r)return Iw(r,c);return-1}var Pw=new Map;function Mw(e){var t=Pw.get(e);if(t)return t;var i=B.director.root.pipeline,n=i.layoutGraph.locateChild(i.layoutGraph.nullVertex(),e);Z(4294967295!==n);var r=i.layoutGraph.getLayout(n).descriptorSets.get(wx.PER_PASS);return Pw.set(e,r),r}var Ow,Dw,Lw,Nw,Fw,Gw=new jc(Kl.LINEAR,Kl.LINEAR,Kl.NONE,Ql.CLAMP,Ql.CLAMP,Ql.CLAMP),Vw=new jc(Kl.POINT,Kl.POINT,Kl.NONE,Ql.CLAMP,Ql.CLAMP,Ql.CLAMP),Uw=function(){function e(t){n(this,e),this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t,this._linearSampler=this._device.getSampler(Gw),this._pointSampler=this._device.getSampler(Vw);var i=new m_(ov.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(i),this._globalDescriptorSet=this._device.createDescriptorSet(new p_(this._descriptorSetLayout))}return s(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet},set:function(e){this._globalDescriptorSet=e}},{key:"regenLayout",value:function(){var e=new m_(ov.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new p_(this._descriptorSetLayout))}},{key:"bindBuffer",value:function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindBuffer(e,t),n=i.next()}},{key:"bindSampler",value:function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindSampler(e,t),n=i.next()}},{key:"bindTexture",value:function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindTexture(e,t),n=i.next()}},{key:"update",value:function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()}},{key:"getOrCreateDescriptorSet",value:function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var i=Ly()?Mw("default").descriptorSet:this._globalDescriptorSet,n=t.createDescriptorSet(new p_(Ly()?Mw("default").descriptorSetLayout:this._descriptorSetLayout));this._descriptorSetMap.set(e,n);for(var r=av.UBO_GLOBAL;r<av.COUNT;r++)n.bindBuffer(r,i.getBuffer(r)),n.bindSampler(r,i.getSampler(r)),n.bindTexture(r,i.getTexture(r));var s=t.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,gv.SIZE,gv.SIZE)),a=Ly()?Bw("CCShadow"):gv.BINDING;n.bindBuffer(a,s),n.update()}return this._descriptorSetMap.get(e)}},{key:"destroy",value:function(){this._descriptorSetLayout.destroy()}}]),e}(),Hw=e("DebugView",function(){function e(){n(this,e),this._singleMode=0,this._compositeModeValue=0,this._lightingWithAlbedo=!0,this._csmLayerColoration=!1,this._activate()}return s(e,[{key:"singleMode",get:function(){return this._singleMode},set:function(e){this._singleMode=e,this._updatePipeline()}},{key:"lightingWithAlbedo",get:function(){return this._lightingWithAlbedo},set:function(e){this._lightingWithAlbedo=e,this._updatePipeline()}},{key:"csmLayerColoration",get:function(){return this._csmLayerColoration},set:function(e){this._csmLayerColoration=e,this._updatePipeline()}},{key:"isCompositeModeEnabled",value:function(e){return 0!=(this._compositeModeValue&1<<e)}},{key:"enableCompositeMode",value:function(e,t){this._enableCompositeMode(e,t),this._updatePipeline()}},{key:"enableAllCompositeMode",value:function(e){this._enableAllCompositeMode(e),this._updatePipeline()}},{key:"isEnabled",value:function(){return 0!==this._getType()}},{key:"reset",value:function(){this._activate(),this._updatePipeline()}},{key:"_activate",value:function(){this._singleMode=0,this._enableAllCompositeMode(!0),this._lightingWithAlbedo=!0,this._csmLayerColoration=!1}},{key:"_updatePipeline",value:function(){var e=B.director.root,t=e.pipeline,i=this._getType();t.macros.CC_USE_DEBUG_VIEW!==i&&(t.macros.CC_USE_DEBUG_VIEW=i,e.onGlobalPipelineStateChanged())}},{key:"_enableCompositeMode",value:function(e,t){t?this._compositeModeValue|=1<<e:this._compositeModeValue&=~(1<<e)}},{key:"_enableAllCompositeMode",value:function(e){for(var t=0;t<17;t++)e?this._compositeModeValue|=1<<t:this._compositeModeValue&=~(1<<t)}},{key:"_getType",value:function(){if(0!==this._singleMode)return 1;if(!0!==this._lightingWithAlbedo||!1!==this._csmLayerColoration)return 2;for(var e=0;e<17;e++)if(!this.isCompositeModeEnabled(e))return 2;return 0}}]),e}()),zw=new Cn,Ww=new Cn,Xw=new Cn,jw=new en,qw=new en(0,0,1,0),Yw=new an,Kw=function(){function e(){n(this,e),this._globalUBO=new Float32Array(vv.COUNT),this._cameraUBO=new Float32Array(yv.COUNT),this._shadowUBO=new Float32Array(gv.COUNT),this._csmUBO=new Float32Array(Sv.COUNT)}return s(e,[{key:"_initCombineSignY",value:function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5}},{key:"activate",value:function(e,t){this._device=e,this._pipeline=t;var i=this._pipeline.descriptorSet;if(!Ly()){this._initCombineSignY();var n=e.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,vv.SIZE,vv.SIZE));i.bindBuffer(vv.BINDING,n);var r=e.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,yv.SIZE,yv.SIZE));i.bindBuffer(yv.BINDING,r);var s=e.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,gv.SIZE,gv.SIZE)),a=Ly()?Bw("CCShadow"):gv.BINDING;i.bindBuffer(a,s);var o=e.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,Sv.SIZE,Sv.SIZE)),u=Ly()?Bw("CCCSM"):Sv.BINDING;i.bindBuffer(u,o)}}},{key:"updateGlobalUBO",value:function(t){var i=this._pipeline.globalDSManager,n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;n.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(n.getBuffer(vv.BINDING),this._globalUBO),i.bindBuffer(vv.BINDING,n.getBuffer(vv.BINDING)),i.update()}},{key:"updateCameraUBO",value:function(t){var i=this._pipeline.globalDSManager,n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(n.getBuffer(yv.BINDING),this._cameraUBO),i.bindBuffer(yv.BINDING,n.getBuffer(yv.BINDING)),i.update()}},{key:"updateShadowUBO",value:function(t){var i=this._pipeline.pipelineSceneData;if(i.shadows.enabled){var n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,s=i.shadowFrameBufferMap,a=t.scene.mainLight;a&&s.has(a)&&n.bindTexture(Av,s.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,this._csmUBO,t),n.update();var o=Ly()?Bw("CCShadow"):gv.BINDING;r[0].updateBuffer(n.getBuffer(o),this._shadowUBO);var u=Ly()?Bw("CCCSM"):Sv.BINDING;r[0].updateBuffer(n.getBuffer(u),this._csmUBO)}}},{key:"updateShadowUBOLight",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,i,n),t.bindTexture(Av,HS.get("default-texture").getGFXTexture()),t.bindTexture(Iv,HS.get("default-texture").getGFXTexture()),t.update();var r=Ly()?Bw("CCShadow"):gv.BINDING;this._pipeline.commandBuffers[0].updateBuffer(t.getBuffer(r),this._shadowUBO)}},{key:"updateShadowUBORange",value:function(e,t){t instanceof Cn?Cn.toArray(this._shadowUBO,t,e):t instanceof cn&&cn.toArray(this._shadowUBO,t,e)}},{key:"destroy",value:function(){}}],[{key:"updateGlobalUBOView",value:function(e,t){var i=B.director,n=i.root,r=t,s=Math.floor(e.width),a=Math.floor(e.height);r[vv.TIME_OFFSET]=n.cumulativeTime,r[vv.TIME_OFFSET+1]=n.frameTime,r[vv.TIME_OFFSET+2]=i.getTotalFrames(),r[vv.TIME_OFFSET+3]=n.cumulativeTime-Math.floor(n.frameTime),r[vv.SCREEN_SIZE_OFFSET]=s,r[vv.SCREEN_SIZE_OFFSET+1]=a,r[vv.SCREEN_SIZE_OFFSET+2]=1/s,r[vv.SCREEN_SIZE_OFFSET+3]=1/a,r[vv.NATIVE_SIZE_OFFSET]=s,r[vv.NATIVE_SIZE_OFFSET+1]=a,r[vv.NATIVE_SIZE_OFFSET+2]=1/r[vv.NATIVE_SIZE_OFFSET],r[vv.NATIVE_SIZE_OFFSET+3]=1/r[vv.NATIVE_SIZE_OFFSET+1],B.internal.reflectionProbeManager&&(r[vv.PROBE_INFO_OFFSET]=B.internal.reflectionProbeManager.getMaxProbeId()+1);var o=n.debugView;r[vv.DEBUG_VIEW_MODE_OFFSET]=o.singleMode;for(var u=1;u<=3;u++)r[vv.DEBUG_VIEW_MODE_OFFSET+u]=0;for(var h=0;h<17;h++){var l=h%8;r[vv.DEBUG_VIEW_MODE_OFFSET+1+(h>>3)]+=(o.isCompositeModeEnabled(h)?1:0)*Math.pow(10,l)}r[vv.DEBUG_VIEW_MODE_OFFSET+3]+=(o.lightingWithAlbedo?1:0)*Math.pow(10,6),r[vv.DEBUG_VIEW_MODE_OFFSET+3]+=(o.csmLayerColoration?1:0)*Math.pow(10,7)}},{key:"updateCameraUBOView",value:function(e,t,i){var n,r=(i.scene?i.scene:B.director.getScene().renderScene).mainLight,s=e.pipelineSceneData,a=s.ambient,o=s.skybox,u=s.fog,h=s.shadows,l=t,c=i.exposure,_=s.isHDR;if(l[yv.SCREEN_SCALE_OFFSET]=s.shadingScale,l[yv.SCREEN_SCALE_OFFSET+1]=s.shadingScale,l[yv.SCREEN_SCALE_OFFSET+2]=1/l[yv.SCREEN_SCALE_OFFSET],l[yv.SCREEN_SCALE_OFFSET+3]=1/l[yv.SCREEN_SCALE_OFFSET+1],l[yv.EXPOSURE_OFFSET]=c,l[yv.EXPOSURE_OFFSET+1]=1/c,l[yv.EXPOSURE_OFFSET+2]=_?1:0,l[yv.EXPOSURE_OFFSET+3]=1/KR.standardExposureValue,r){var f=r.shadowEnabled&&h.type===pA.ShadowMap?1:0,d=r.direction;if(qw.set(d.x,d.y,d.z,f),en.toArray(l,qw,yv.MAIN_LIT_DIR_OFFSET),an.toArray(l,r.color,yv.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var m=r.colorTemperatureRGB;l[yv.MAIN_LIT_COLOR_OFFSET]*=m.x,l[yv.MAIN_LIT_COLOR_OFFSET+1]*=m.y,l[yv.MAIN_LIT_COLOR_OFFSET+2]*=m.z}l[yv.MAIN_LIT_COLOR_OFFSET+3]=_?r.illuminance*c:r.illuminance}else qw.set(0,0,1,0),en.toArray(l,qw,yv.MAIN_LIT_DIR_OFFSET),en.toArray(l,en.ZERO,yv.MAIN_LIT_COLOR_OFFSET);var p=a.skyColor;p.w=_?a.skyIllum*c:a.skyIllum,l[yv.AMBIENT_SKY_OFFSET+0]=p.x,l[yv.AMBIENT_SKY_OFFSET+1]=p.y,l[yv.AMBIENT_SKY_OFFSET+2]=p.z,l[yv.AMBIENT_SKY_OFFSET+3]=p.w,l[yv.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,l[yv.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,l[yv.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,l[yv.AMBIENT_GROUND_OFFSET+3]=o.envmap?null===(n=o.envmap)||void 0===n?void 0:n.mipmapLevel:1,Cn.toArray(l,i.matView,yv.MAT_VIEW_OFFSET),Cn.toArray(l,i.node.worldMatrix,yv.MAT_VIEW_INV_OFFSET),an.toArray(l,i.position,yv.CAMERA_POS_OFFSET),Cn.toArray(l,i.matProj,yv.MAT_PROJ_OFFSET),Cn.toArray(l,i.matProjInv,yv.MAT_PROJ_INV_OFFSET),Cn.toArray(l,i.matViewProj,yv.MAT_VIEW_PROJ_OFFSET),Cn.toArray(l,i.matViewProjInv,yv.MAT_VIEW_PROJ_INV_OFFSET),l[yv.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),l[yv.SURFACE_TRANSFORM_OFFSET]=i.surfaceTransform,l[yv.SURFACE_TRANSFORM_OFFSET+1]=i.cameraUsage,l[yv.SURFACE_TRANSFORM_OFFSET+2]=Math.cos(Gi(s.skybox.getRotationAngle())),l[yv.SURFACE_TRANSFORM_OFFSET+3]=Math.sin(Gi(s.skybox.getRotationAngle()));var v=u.colorArray;l[yv.GLOBAL_FOG_COLOR_OFFSET]=v.x,l[yv.GLOBAL_FOG_COLOR_OFFSET+1]=v.y,l[yv.GLOBAL_FOG_COLOR_OFFSET+2]=v.z,l[yv.GLOBAL_FOG_COLOR_OFFSET+3]=v.z,l[yv.GLOBAL_FOG_BASE_OFFSET]=u.fogStart,l[yv.GLOBAL_FOG_BASE_OFFSET+1]=u.fogEnd,l[yv.GLOBAL_FOG_BASE_OFFSET+2]=u.fogDensity,l[yv.GLOBAL_FOG_ADD_OFFSET]=u.fogTop,l[yv.GLOBAL_FOG_ADD_OFFSET+1]=u.fogRange,l[yv.GLOBAL_FOG_ADD_OFFSET+2]=u.fogAtten,l[yv.NEAR_FAR_OFFSET]=i.nearClip,l[yv.NEAR_FAR_OFFSET+1]=i.farClip,l[yv.VIEW_PORT_OFFSET]=s.shadingScale*i.window.width*i.viewport.x,l[yv.VIEW_PORT_OFFSET+1]=s.shadingScale*i.window.height*i.viewport.y,l[yv.VIEW_PORT_OFFSET+2]=s.shadingScale*i.window.width*i.viewport.z,l[yv.VIEW_PORT_OFFSET+3]=s.shadingScale*i.window.height*i.viewport.w}},{key:"getPCFRadius",value:function(e,t){var i=e.size.x;switch(t.shadowPcf){case vA.HARD:return 0;case vA.SOFT:return 1/(.5*i);case vA.SOFT_2X:return 2/(.5*i);case vA.SOFT_4X:return 3/(.5*i)}return 0}},{key:"updatePlanarNormalAndDistance",value:function(e,t){an.normalize(Yw,e.normal),t[gv.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Yw.x,t[gv.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Yw.y,t[gv.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Yw.z,t[gv.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=-e.distance}},{key:"updateShadowUBOView",value:function(t,i,n,r){var s=t.device,a=r.scene.mainLight,o=t.pipelineSceneData,u=o.shadows,h=o.csmLayers,l=i,c=n,_=o.csmSupported,f=Dy(s)?0:1;if(a&&u.enabled){if(u.type===pA.ShadowMap){if(a.shadowEnabled){if(a.shadowFixedArea||a.csmLevel===yA.LEVEL_1||!_){var d=h.specialLayer.matShadowView,m=h.specialLayer.matShadowProj,p=h.specialLayer.matShadowViewProj,v=.1,y=0,g=0;a.shadowFixedArea?(v=a.shadowNear,y=a.shadowFar,g=0):(y=h.specialLayer.shadowCameraFar,g=1),Cn.toArray(l,d,gv.MAT_LIGHT_VIEW_OFFSET),l[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=m.m10,l[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=m.m14,l[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=m.m11,l[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=m.m15,l[gv.SHADOW_PROJ_INFO_OFFSET+0]=m.m00,l[gv.SHADOW_PROJ_INFO_OFFSET+1]=m.m05,l[gv.SHADOW_PROJ_INFO_OFFSET+2]=1/m.m00,l[gv.SHADOW_PROJ_INFO_OFFSET+3]=1/m.m05,Cn.toArray(l,p,gv.MAT_LIGHT_VIEW_PROJ_OFFSET),jw.set(v,y,0,1-a.shadowSaturation),en.toArray(l,jw,gv.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),jw.set(0,f,a.shadowNormalBias,g),en.toArray(l,jw,gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}else{for(var S=this.getPCFRadius(u,a),A=0;A<a.csmLevel;A++){var T=h.layers[A],E=T.matShadowView;jw.set(E.m00,E.m04,E.m08,S),en.toArray(c,jw,Sv.CSM_VIEW_DIR_0_OFFSET+4*A),jw.set(E.m01,E.m05,E.m09,T.splitCameraNear),en.toArray(c,jw,Sv.CSM_VIEW_DIR_1_OFFSET+4*A),jw.set(E.m02,E.m06,E.m10,T.splitCameraFar),en.toArray(c,jw,Sv.CSM_VIEW_DIR_2_OFFSET+4*A);var b=T.csmAtlas;en.toArray(c,b,Sv.CSM_ATLAS_OFFSET+4*A);var C=T.matShadowViewProj;Cn.toArray(c,C,Sv.MAT_CSM_VIEW_PROJ_OFFSET+16*A);var R=T.matShadowProj;c[Sv.CSM_PROJ_DEPTH_INFO_OFFSET+0+4*A]=R.m10,c[Sv.CSM_PROJ_DEPTH_INFO_OFFSET+1+4*A]=R.m14,c[Sv.CSM_PROJ_DEPTH_INFO_OFFSET+2+4*A]=R.m11,c[Sv.CSM_PROJ_DEPTH_INFO_OFFSET+3+4*A]=R.m15,c[Sv.CSM_PROJ_INFO_OFFSET+0+4*A]=R.m00,c[Sv.CSM_PROJ_INFO_OFFSET+1+4*A]=R.m05,c[Sv.CSM_PROJ_INFO_OFFSET+2+4*A]=1/R.m00,c[Sv.CSM_PROJ_INFO_OFFSET+3+4*A]=1/R.m05}jw.set(a.csmTransitionRange,0,0,0),en.toArray(c,jw,Sv.CSM_SPLITS_INFO_OFFSET),jw.set(.1,a.shadowDistance,0,1-a.shadowSaturation),en.toArray(l,jw,gv.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),jw.set(0,f,a.shadowNormalBias,a.csmLevel),en.toArray(l,jw,gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}jw.set(u.size.x,u.size.y,a.shadowPcf,a.shadowBias),en.toArray(l,jw,gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}}else e.updatePlanarNormalAndDistance(u,l);cn.toArray(l,u.shadowColor,gv.SHADOW_COLOR_OFFSET)}}},{key:"updateShadowUBOLightView",value:function(e,t,i,n){var r=e.device,s=e.pipelineSceneData,a=s.shadows,o=s.csmLayers,u=t,h=Dy(r)?0:1,l=e.device.capabilities,c=s.csmSupported;switch(i.type){case Tx.DIRECTIONAL:var _=i;if(a.enabled&&_&&_.shadowEnabled&&a.type===pA.ShadowMap){var f,d,m,p=.1,v=0,y=0;if(_.shadowFixedArea||_.csmLevel===yA.LEVEL_1||!c)f=o.specialLayer.matShadowView,d=o.specialLayer.matShadowProj,m=o.specialLayer.matShadowViewProj,_.shadowFixedArea?(p=_.shadowNear,v=_.shadowFar,y=0):(p=.1,v=o.specialLayer.shadowCameraFar,y=1),jw.set(0,h,_.shadowNormalBias,0),en.toArray(u,jw,gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);else{var g=o.layers[n];f=g.matShadowView,d=g.matShadowProj,m=g.matShadowViewProj,p=g.splitCameraNear,v=g.splitCameraFar,y=_.csmLevel}Cn.toArray(u,f,gv.MAT_LIGHT_VIEW_OFFSET),u[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,u[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,u[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,u[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,u[gv.SHADOW_PROJ_INFO_OFFSET+0]=d.m00,u[gv.SHADOW_PROJ_INFO_OFFSET+1]=d.m05,u[gv.SHADOW_PROJ_INFO_OFFSET+2]=1/d.m00,u[gv.SHADOW_PROJ_INFO_OFFSET+3]=1/d.m05,Cn.toArray(u,m,gv.MAT_LIGHT_VIEW_PROJ_OFFSET),jw.set(p,v,0,1-_.shadowSaturation),en.toArray(u,jw,gv.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),jw.set(0,h,_.shadowNormalBias,y),en.toArray(u,jw,gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),jw.set(a.size.x,a.size.y,_.shadowPcf,_.shadowBias),en.toArray(u,jw,gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}break;case Tx.SPOT:var S=i;a.enabled&&S&&S.shadowEnabled&&(Cn.invert(zw,i.node.getWorldMatrix()),Cn.toArray(u,zw,gv.MAT_LIGHT_VIEW_OFFSET),Cn.perspective(Ww,i.angle,1,.001,i.range,!0,l.clipSpaceMinZ,l.clipSpaceSignY,0),Cn.multiply(Xw,Ww,zw),Cn.toArray(u,Xw,gv.MAT_LIGHT_VIEW_PROJ_OFFSET),jw.set(.01,i.range,0,0),en.toArray(u,jw,gv.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),jw.set(a.size.x,a.size.y,S.shadowPcf,S.shadowBias),en.toArray(u,jw,gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),jw.set(1,h,S.shadowNormalBias,0),en.toArray(u,jw,gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET))}cn.toArray(u,a.shadowColor,gv.SHADOW_COLOR_OFFSET)}},{key:"getCombineSignY",value:function(){return e._combineSignY}}]),e}();Kw._combineSignY=0;var Qw,Jw,Zw,$w,ek,tk,ik,nk,rk=e("RenderStage",Hs("RenderStage")((Dw=function(){function e(){n(this,e),this._name=Lw&&Lw(),this._priority=Nw&&Nw(),this._enabled=!0,this._tag=Fw&&Fw()}return s(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e,t){this._pipeline=e,this._flow=t}}]),e}(),Lw=Ms(Dw.prototype,"_name",[Js],(function(){return""})),Nw=Ms(Dw.prototype,"_priority",[Js],(function(){return 0})),Fw=Ms(Dw.prototype,"_tag",[Js],(function(){return 0})),Ow=Dw))||Ow);B.RenderStage=rk;var sk,ak=e("RenderFlow",(Qw=Hs("RenderFlow"),Jw=Aa([rk]),Qw(($w=function(){function e(){n(this,e),this._name=ek&&ek(),this._priority=tk&&tk(),this._tag=ik&&ik(),this._stages=nk&&nk()}return s(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}},{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)}},{key:"render",value:function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].enabled&&this._stages[t].render(e)}},{key:"destroy",value:function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0}}]),e}(),ek=Ms($w.prototype,"_name",[Js],(function(){return""})),tk=Ms($w.prototype,"_priority",[Js],(function(){return 0})),ik=Ms($w.prototype,"_tag",[Js],(function(){return 0})),nk=Ms($w.prototype,"_stages",[Jw,Js],(function(){return[]})),Zw=$w))||Zw));B.RenderFlow=ak,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(sk||(sk=e("PipelineEventType",{})));var ok,uk,hk,lk,ck,_k,fk,dk,mk,pk,vk,yk,gk,Sk,Ak,Tk,Ek,bk,Ck,Rk,xk,wk,kk,Ik,Bk,Pk,Mk,Ok,Dk,Lk,Nk,Fk,Gk,Vk,Uk,Hk,zk,Wk,Xk,jk,qk,Yk,Kk,Qk,Jk,Zk,$k,eI,tI,iI,nI,rI,sI,aI,oI,uI,hI,lI,cI,_I,fI,dI,mI,pI,vI,yI,gI,SI,AI,TI,EI,bI,CI,RI,xI,wI,kI,II,BI,PI,MI,OI,DI,LI,NI,FI,GI,VI,UI,HI,zI=e("PipelineEventProcessor",function(e){h(i,e);var t=v(i);function i(){var e,r,s;n(this,i);for(var a=arguments.length,o=new Array(a),u=0;u<a;u++)o[u]=arguments[u];return(s=t.call.apply(t,[this].concat(o))).eventTargetOn=g((e=m(s),l(i.prototype)),"on",e),s.eventTargetOnce=g((r=m(s),l(i.prototype)),"once",r),s}return s(i,[{key:"on",value:function(e,t,i,n){return this.eventTargetOn(e,t,i,n)}},{key:"once",value:function(e,t,i){return this.eventTargetOnce(e,t,i)}}]),i}(Hh)),WI=new xc,XI=new Oc,jI=function e(){n(this,e),this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},qI=function e(){n(this,e),this.quadIB=null,this.quadVB=null,this.quadIA=null},YI=e("RenderPipeline",(ok=Hs("cc.RenderPipeline"),uk=Aa([ak]),ok((lk=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._tag=ck&&ck(),e._flows=_k&&_k(),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new zI,e._commandBuffers=[],e._pipelineUBO=new Kw,e._macros={},e._constantMacros="",e._profiler=null,e._geometryRenderer=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new xc,e._clusterEnabled=!1,e._bloomEnabled=!1,e}return s(i,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"getPipelineRenderData",value:function(){return this._pipelineRenderData}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}},{key:"initialize",value:function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0}},{key:"createRenderPass",value:function(e,t,i){var n=this._device,r=new s_,s=new a_;r.format=t,s.format=i,s.stencilStoreOp=rc.DISCARD,s.depthStoreOp=rc.DISCARD,e&yc.COLOR||(e&qR?r.loadOp=nc.CLEAR:(r.loadOp=nc.LOAD,r.barrier=n.getGeneralBarrier(new l_(sc.COLOR_ATTACHMENT_WRITE,sc.COLOR_ATTACHMENT_WRITE)))),(e&yc.DEPTH_STENCIL)!==yc.DEPTH_STENCIL&&(e&yc.DEPTH||(s.depthLoadOp=nc.LOAD),e&yc.STENCIL||(s.stencilLoadOp=nc.LOAD)),s.barrier=n.getGeneralBarrier(new l_(sc.DEPTH_STENCIL_ATTACHMENT_WRITE,sc.DEPTH_STENCIL_ATTACHMENT_WRITE));var a=new h_([r],s);return n.createRenderPass(a)}},{key:"getRenderPass",value:function(e,t){var i=function(e){for(var t,i=666,n=R(e.colorTextures);!(t=n()).done;){var r=t.value,s=null==r?void 0:r.info;i=bl("".concat(s.type,"_").concat(s.usage,"_").concat(s.format,"_").concat(s.width,"_").concat(s.height,"_").concat(s.flags,"_\n            ").concat(s.layerCount,"_").concat(s.levelCount,"_").concat(s.samples,"_").concat(s.depth,"_").concat(s.externalRes),i)}if(e.depthStencilTexture){var a=e.depthStencilTexture.info;i=bl("".concat(a.type,"_").concat(a.usage,"_").concat(a.format,"_").concat(a.width,"_").concat(a.height,"_").concat(a.flags,"_\n            ").concat(a.layerCount,"_").concat(a.levelCount,"_").concat(a.samples,"_").concat(a.depth,"_").concat(a.externalRes),i)}return i}(t),n=bl("".concat(i,"_").concat(e),666),r=this._renderPasses.get(n);return r||(r=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(n,r),r)}},{key:"newFramebufferByRatio",value:function(e){for(var t=this.pipelineSceneData,i=this._width*t.shadingScale,n=this._height*t.shadingScale,r=e.colorTextures,s=0;s<r.length;s++)r[s].resize(i,n);e.depthStencilTexture&&e.depthStencilTexture.resize(i,n);var a=this._device.createFramebuffer(new f_(e.renderPass,r,e.depthStencilTexture));return e.destroy(),a}},{key:"generateRenderArea",value:function(e,t){var i=e.viewport,n=e.window.width,r=e.window.height;t.x=i.x*n,t.y=i.y*r,t.width=i.width*n,t.height=i.height*r}},{key:"generateViewport",value:function(e,t){this.generateRenderArea(e,WI),t||(t=XI);var i=this.pipelineSceneData.shadingScale;return t.left=WI.x*i,t.top=WI.y*i,t.width=WI.width*i,t.height=WI.height*i,t}},{key:"generateScissor",value:function(e,t){t||(t=WI),this.generateRenderArea(e,t);var i=this.pipelineSceneData.shadingScale;return t.x*=i,t.y*=i,t.width*=i,t.height*=i,t}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(e){this._pipelineSceneData.shadingScale!==e&&(this._pipelineSceneData.shadingScale=e,this.emit(sk.ATTACHMENT_SCALE_CAHNGED,e))}},{key:"getMacroString",value:function(e){var t=this._macros[e];return void 0===t?"":t}},{key:"getMacroInt",value:function(e){var t=this._macros[e];return void 0===t?0:t}},{key:"getMacroBool",value:function(e){var t=this._macros[e];return void 0!==t&&t}},{key:"setMacroString",value:function(e,t){this._macros[e]=t}},{key:"setMacroInt",value:function(e,t){this._macros[e]=t}},{key:"setMacroBool",value:function(e,t){this._macros[e]=t}},{key:"activate",value:function(){this._device=yf.gfxDevice,this._generateConstantMacros(),this._globalDSManager=new Uw(this._device),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._macros.CC_USE_DEBUG_VIEW=0,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0}},{key:"_ensureEnoughSize",value:function(){}},{key:"render",value:function(e){if(0!==e.length){this.updateGeometryRenderer(e),this._commandBuffers[0].begin(),this.emit(sk.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var i=e[t];if(i.window.swapchain)return void(lA=i)}lA=null}(e);for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){this.emit(sk.RENDER_CAMERA_BEGIN,i),ex(this,i),ix(this,i),this._pipelineUBO.updateGlobalUBO(i.window),this._pipelineUBO.updateCameraUBO(i);for(var n=0;n<this._flows.length;n++)this._flows[n].render(i);this.emit(sk.RENDER_CAMERA_END,i)}}this.emit(sk.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}}},{key:"_destroyQuadInputAssembler",value:function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)}},{key:"_destroyBloomData",value:function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var i=0;i<t.downsampleTexs.length;++i)t.downsampleTexs[i].destroy(),t.downsampleFramebuffers[i].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var n=0;n<t.upsampleTexs.length;++n)t.upsampleTexs[n].destroy(),t.upsampleFramebuffers[n].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}}},{key:"_genQuadVertexData",value:function(e,t){var i=new Float32Array(16),n=t.x/this._width,r=(t.x+t.width)/this._width,s=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var o=a;a=s,s=o}var u=0;switch(e){case Ol.IDENTITY:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=s,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=s;break;case Ol.ROTATE_90:u=0,i[u++]=-1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=s,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=n,i[u++]=s;break;case Ol.ROTATE_180:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=s,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=s,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=a;break;case Ol.ROTATE_270:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=s,i[u++]=1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=r,i[u++]=s,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=a}return i}},{key:"_createQuadInputAssembler",value:function(){var e=new qI,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t,n=this._device.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE|Hl.HOST,i,t));if(!n)return e;var r=Uint8Array.BYTES_PER_ELEMENT,s=6*r,a=this._device.createBuffer(new Gc(Gl.INDEX|Gl.TRANSFER_DST,Hl.DEVICE,s,r));if(!a)return e;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,a.update(o);var u=new Array(2);u[0]=new i_("a_position",Ll.RG32F),u[1]=new i_("a_texCoord",Ll.RG32F);var h=this._device.createInputAssembler(new r_(u,[n],a));return e.quadIB=a,e.quadVB=n,e.quadIA=h,e}},{key:"updateQuadVertexData",value:function(e,t){var i=this._lastUsedRenderArea;if(i.x!==e.x||i.y!==e.y||i.width!==e.width||i.height!==e.height){var n=this._genQuadVertexData(Ol.IDENTITY,e);this._quadVBOffscreen.update(n);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||Ol.IDENTITY,e);this._quadVBOnscreen.update(r),i.copy(e)}}},{key:"destroy",value:function(){for(var e,t,n=0;n<this._flows.length;n++)this._flows[n].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(t=this._pipelineSceneData)||void 0===t||t.destroy(),g(l(i.prototype),"destroy",this).call(this)}},{key:"onGlobalPipelineStateChanged",value:function(){}},{key:"_generateConstantMacros",value:function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE ".concat(this.device.getFormatFeatures(Ll.RGBA32F)&(jl.RENDER_TARGET|jl.SAMPLED_TEXTURE)?1:0,"\n"),e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING ".concat(this._clusterEnabled?1:0,"\n"),e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS ".concat(this.device.capabilities.maxVertexUniformVectors,"\n"),e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS ".concat(this.device.capabilities.maxFragmentUniformVectors,"\n"),e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT ".concat(this.device.hasFeature(Dl.INPUT_ATTACHMENT_BENEFIT)?1:0,"\n"),e+="#define CC_PLATFORM_ANDROID_AND_WEBGL ".concat(Qh.os===jh.ANDROID&&Qh.isBrowser?1:0,"\n"),e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES ".concat(Lt.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0,"\n");var t=Hv.JOINT_UNIFORM_CAPACITY;e+="#define CC_JOINT_UNIFORM_CAPACITY ".concat(t,"\n"),this._constantMacros=e}},{key:"updateGeometryRenderer",value:function(e){if(!this._geometryRenderer)for(var t=0;t<e.length;t++){var i=e[t];if(i&&i.window&&i.window.swapchain)return i.initGeometryRenderer(),void(this._geometryRenderer=i.geometryRenderer)}}},{key:"generateBloomRenderData",value:function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new jI,t=this.device,i=new s_;i.format=Ll.RGBA8,i.loadOp=nc.CLEAR,i.storeOp=rc.STORE,i.barrier=t.getGeneralBarrier(new l_(sc.NONE,sc.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new h_([i]));var n=this._width,r=this._height;e.prefiterTex=t.createTexture(new Wc(zl.TEX2D,Wl.COLOR_ATTACHMENT|Wl.SAMPLED,Ll.RGBA8,n>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new f_(e.renderPass,[e.prefiterTex])),n>>=1,r>>=1;for(var s=0;s<6;++s)e.downsampleTexs.push(t.createTexture(new Wc(zl.TEX2D,Wl.COLOR_ATTACHMENT|Wl.SAMPLED,Ll.RGBA8,n>>1,r>>1))),e.downsampleFramebuffers[s]=t.createFramebuffer(new f_(e.renderPass,[e.downsampleTexs[s]])),e.upsampleTexs.push(t.createTexture(new Wc(zl.TEX2D,Wl.COLOR_ATTACHMENT|Wl.SAMPLED,Ll.RGBA8,n,r))),e.upsampleFramebuffers[s]=t.createFramebuffer(new f_(e.renderPass,[e.upsampleTexs[s]])),n>>=1,r>>=1;e.combineTex=t.createTexture(new Wc(zl.TEX2D,Wl.COLOR_ATTACHMENT|Wl.SAMPLED,Ll.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new f_(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}}},{key:"on",value:function(e,t,i,n){return this._eventProcessor.on(e,t,i,n)}},{key:"once",value:function(e,t,i){return this._eventProcessor.once(e,t,i)}},{key:"off",value:function(e,t,i){this._eventProcessor.off(e,t,i)}},{key:"emit",value:function(e,t,i,n,r,s){this._eventProcessor.emit(e,t,i,n,r,s)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e)}},{key:"removeAll",value:function(e){this._eventProcessor.removeAll(e)}},{key:"hasEventListener",value:function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)}}]),i}(ed),ck=Ms(lk.prototype,"_tag",[Js],(function(){return 0})),_k=Ms(lk.prototype,"_flows",[uk,Js],(function(){return[]})),hk=lk))||hk));B.RenderPipeline=YI,ve(YI.prototype,"RenderPipeline.prototype",[{name:"geometryRenderer",suggest:"please use camera.geometryRenderer instead."}]),function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(fk||(fk={})),function(e){e[e.AR=5]="AR",e[e.FORWARD=10]="FORWARD"}(dk||(dk={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(mk||(mk={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(pk||(pk={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(vk||(vk={})),Bt(zl),Bt(Wl),Bt(rc),Bt(nc),Bt(sc),Bt(Ll),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(HI||(HI={})),Bt(HI),yk=Hs("RenderTextureDesc"),gk=Aa(zl),Sk=Aa(Wl),Ak=Aa(Ll),yk((Tk=function e(){n(this,e),this.name=Ek&&Ek(),this.type=bk&&bk(),this.usage=Ck&&Ck(),this.format=Rk&&Rk(),this.width=xk&&xk(),this.height=wk&&wk()},Ek=Ms(Tk.prototype,"name",[Js],(function(){return""})),bk=Ms(Tk.prototype,"type",[gk],(function(){return zl.TEX2D})),Ck=Ms(Tk.prototype,"usage",[Sk],(function(){return Wl.COLOR_ATTACHMENT})),Rk=Ms(Tk.prototype,"format",[Ak],(function(){return Ll.UNKNOWN})),xk=Ms(Tk.prototype,"width",[Js],(function(){return-1})),wk=Ms(Tk.prototype,"height",[Js],(function(){return-1})),Tk));var KI,QI=(kk=Hs("RenderTextureConfig"),Ik=Aa(_x),kk((Pk=function e(){n(this,e),this.name=Mk&&Mk(),this.texture=Ok&&Ok()},Mk=Ms(Pk.prototype,"name",[Js],(function(){return""})),Ok=Ms(Pk.prototype,"texture",[Ik],(function(){return null})),Bk=Pk))||Bk),JI=(Dk=Hs("MaterialConfig"),Lk=Aa(dA),Dk((Nk=function e(){n(this,e),this.name=Fk&&Fk(),this.material=Gk&&Gk()},Fk=Ms(Nk.prototype,"name",[Js],(function(){return""})),Gk=Ms(Nk.prototype,"material",[Lk],(function(){return null})),Nk)),Vk=Hs("FrameBufferDesc"),Uk=Aa([oi]),Hk=Aa(_x),Vk((zk=function e(){n(this,e),this.name=Wk&&Wk(),this.renderPass=Xk&&Xk(),this.colorTextures=jk&&jk(),this.depthStencilTexture=qk&&qk(),this.texture=Yk&&Yk()},Wk=Ms(zk.prototype,"name",[Js],(function(){return""})),Xk=Ms(zk.prototype,"renderPass",[Js],(function(){return 0})),jk=Ms(zk.prototype,"colorTextures",[Uk],(function(){return[]})),qk=Ms(zk.prototype,"depthStencilTexture",[Js],(function(){return""})),Yk=Ms(zk.prototype,"texture",[Hk],(function(){return null})),zk)),Kk=Hs("ColorDesc"),Qk=Aa(Ll),Jk=Aa(nc),Zk=Aa(rc),$k=Aa(sc),eI=Aa(sc),Kk((iI=function e(){n(this,e),this.format=nI&&nI(),this.loadOp=rI&&rI(),this.storeOp=sI&&sI(),this.sampleCount=aI&&aI(),this.beginAccesses=oI&&oI(),this.endAccesses=uI&&uI()},nI=Ms(iI.prototype,"format",[Qk],(function(){return Ll.UNKNOWN})),rI=Ms(iI.prototype,"loadOp",[Jk],(function(){return nc.CLEAR})),sI=Ms(iI.prototype,"storeOp",[Zk],(function(){return rc.STORE})),aI=Ms(iI.prototype,"sampleCount",[Js],(function(){return 1})),oI=Ms(iI.prototype,"beginAccesses",[$k],(function(){return sc.NONE})),uI=Ms(iI.prototype,"endAccesses",[eI],(function(){return sc.COLOR_ATTACHMENT_WRITE})),tI=iI))||tI),ZI=(hI=Hs("DepthStencilDesc"),lI=Aa(Ll),cI=Aa(nc),_I=Aa(rc),fI=Aa(nc),dI=Aa(rc),mI=Aa(sc),pI=Aa(sc),hI((yI=function e(){n(this,e),this.format=gI&&gI(),this.depthLoadOp=SI&&SI(),this.depthStoreOp=AI&&AI(),this.stencilLoadOp=TI&&TI(),this.stencilStoreOp=EI&&EI(),this.sampleCount=bI&&bI(),this.beginAccesses=CI&&CI(),this.endAccesses=RI&&RI()},gI=Ms(yI.prototype,"format",[lI],(function(){return Ll.UNKNOWN})),SI=Ms(yI.prototype,"depthLoadOp",[cI],(function(){return nc.CLEAR})),AI=Ms(yI.prototype,"depthStoreOp",[_I],(function(){return rc.STORE})),TI=Ms(yI.prototype,"stencilLoadOp",[fI],(function(){return nc.CLEAR})),EI=Ms(yI.prototype,"stencilStoreOp",[dI],(function(){return rc.STORE})),bI=Ms(yI.prototype,"sampleCount",[Js],(function(){return 1})),CI=Ms(yI.prototype,"beginAccesses",[mI],(function(){return sc.NONE})),RI=Ms(yI.prototype,"endAccesses",[pI],(function(){return sc.DEPTH_STENCIL_ATTACHMENT_WRITE})),vI=yI))||vI);xI=Hs("RenderPassDesc"),wI=Aa([JI]),kI=Aa(ZI),xI((II=function e(){n(this,e),this.index=BI&&BI(),this.colorAttachments=PI&&PI(),this.depthStencilAttachment=MI&&MI()},BI=Ms(II.prototype,"index",[Js],(function(){return-1})),PI=Ms(II.prototype,"colorAttachments",[wI],(function(){return[]})),MI=Ms(II.prototype,"depthStencilAttachment",[kI],(function(){return new ZI})),II)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(KI||(KI={})),Bt(KI);var $I=(OI=Hs("RenderQueueDesc"),DI=Aa(KI),LI=Aa([oi]),OI((FI=function e(){n(this,e),this.isTransparent=GI&&GI(),this.sortMode=VI&&VI(),this.stages=UI&&UI()},GI=Ms(FI.prototype,"isTransparent",[Js],(function(){return!1})),VI=Ms(FI.prototype,"sortMode",[DI],(function(){return KI.FRONT_TO_BACK})),UI=Ms(FI.prototype,"stages",[LI],(function(){return[]})),NI=FI))||NI);function eB(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function tB(e,t){return e.priority-t.priority||e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var iB=function(){function e(t){n(this,e),this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new bh((function(){return{priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Ch(64,this._passDesc.sortFunc)}return s(e,[{key:"clear",value:function(){this.queue.clear(),this._passPool.reset()}},{key:"insertRenderPass",value:function(e,t,i){var n=e.model.subModels[t],r=n.passes[i],s=n.shaders[i];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|n.priority<<8|i,o=this._passPool.add();return o.priority=e.model.priority,o.hash=a,o.depth=e.depth||0,o.shaderId=s.typedID,o.subModel=n,o.passIdx=i,this.queue.push(o),!0}},{key:"sort",value:function(){this.queue.sort()}},{key:"recordCommandBuffer",value:function(e,t,i){for(var n=0;n<this.queue.length;++n){var r=this.queue.array[n],s=r.subModel,a=r.passIdx,o=s.inputAssembler,u=s.passes[a],h=s.shaders[a],l=JS.getOrCreatePipelineState(e,u,h,t,o);i.bindPipelineState(l),i.bindDescriptorSet(_v.MATERIAL,u.descriptorSet),i.bindDescriptorSet(_v.LOCAL,s.descriptorSet),i.bindInputAssembler(o),i.draw(o)}}}]),e}();function nB(e){for(var t=0,i=0;i<e.stages.length;i++)t|=zS(e.stages[i]);var n=eB;switch(e.sortMode){case KI.BACK_TO_FRONT:n=tB;break;case KI.FRONT_TO_BACK:n=eB}return new iB({isTransparent:e.isTransparent,phases:t,sortFunc:n})}function rB(e){e.clear()}function sB(e){e.sort()}var aB=function(){function e(){n(this,e),this.queue=new Set}return s(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"uploadBuffers",value:function(e){for(var t=this.queue.values(),i=t.next();!i.done;){for(var n=0;n<i.value.batches.length;++n){var r=i.value.batches[n];if(r.mergeCount){for(var s=0;s<r.vbs.length;++s)r.vbs[s].update(r.vbDatas[s]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}i=t.next()}}},{key:"recordCommandBuffer",value:function(e,t,i){for(var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4?arguments[4]:void 0,s=this.queue.values(),a=s.next();!a.done;){for(var o=!1,u=0;u<a.value.batches.length;++u){var h=a.value.batches[u];if(h.mergeCount){if(!o){var l=h.shader,c=JS.getOrCreatePipelineState(e,h.pass,l,t,h.ia);i.bindPipelineState(c),i.bindDescriptorSet(_v.MATERIAL,h.pass.descriptorSet),o=!0}n&&i.bindDescriptorSet(_v.GLOBAL,n),r?i.bindDescriptorSet(_v.LOCAL,h.descriptorSet,r):i.bindDescriptorSet(_v.LOCAL,h.descriptorSet,a.value.dynamicOffsets),i.bindInputAssembler(h.ia),i.draw(h.ia)}}a=s.next()}}}]),e}(),oB=function(){function e(){n(this,e),this.queue=new Set,this._renderQueue=[]}return s(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._renderQueue.length=0,this.queue.clear()}},{key:"sort",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.pass.blendState.targets[0].blend||this._renderQueue.push(t.value),t=e.next();for(t=(e=this.queue.values()).next();!t.done;)t.value.pass.blendState.targets[0].blend&&this._renderQueue.push(t.value),t=e.next()}},{key:"uploadBuffers",value:function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()}},{key:"recordCommandBuffer",value:function(e,t,i){for(var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4?arguments[4]:void 0,s=0===this._renderQueue.length?this.queue.values():this._renderQueue.values(),a=s.next();!a.done;){var o=a.value,u=o.instances,h=o.pass,l=o.hasPendingModels;if(l){i.bindDescriptorSet(_v.MATERIAL,h.descriptorSet);for(var c=null,_=0;_<u.length;++_){var f=u[_];if(f.count){var d=f.shader,m=JS.getOrCreatePipelineState(e,h,d,t,f.ia);c!==m&&(i.bindPipelineState(m),c=m),n&&i.bindDescriptorSet(_v.GLOBAL,n),r?i.bindDescriptorSet(_v.LOCAL,f.descriptorSet,r):i.bindDescriptorSet(_v.LOCAL,f.descriptorSet,a.value.dynamicOffsets),i.bindInputAssembler(f.ia),i.draw(f.ia)}}}a=s.next()}}}]),e}(),uB=new Eh((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),hB=new Float32Array(4),lB=[],cB=[],_B=new Cn,fB=new Cn;function dB(e,t){return!(!t.worldBounds||is.aabbWithAABB(t.worldBounds,e.aabb))}function mB(e,t){return!(!t.worldBounds||is.aabbWithAABB(t.worldBounds,e.aabb)&&is.aabbFrustum(t.worldBounds,e.frustum))}var pB="forward-add",vB=zS(pB),yB=[];function gB(e,t){var i=B.rendering;Ly()&&(vB=i.getPhaseID(i.getPassID("default"),pB)),t.length=0;for(var n=!1,r=0;r<e.length;r++){for(var s=e[r].passes,a=-1,o=0;o<s.length;o++)if((!i||!i.enableEffectImport)&&s[o].phase===vB||Ly()&&s[o].phaseID===vB){a=o,n=!0;break}t.push(a)}return n}var SB,AB,TB,EB,bB,CB,RB,xB,wB,kB,IB=function(){function e(t){n(this,e),this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._instancedLightPassPool=uB.alloc(),this._batchedLightPassPool=uB.alloc(),this._shadowUBO=new Float32Array(gv.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueues=[],this._batchedQueues=[],this._lightMeterScale=1e4,this._pipeline=t,this._device=t.device;var i=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Fv.SIZE/i)*i,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new Vc(this._lightBuffer,0,Fv.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}return s(e,[{key:"clear",value:function(){this._instancedQueues.forEach((function(e){e.clear()})),this._instancedQueues.length=0,this._batchedQueues.forEach((function(e){e.clear()})),this._batchedQueues.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}uB.freeArray(this._lightPasses),this._lightPasses.length=0,this._instancedLightPassPool.dynamicOffsets.length=0,this._instancedLightPassPool.lights.length=0,this._batchedLightPassPool.dynamicOffsets.length=0,this._batchedLightPassPool.lights.length=0}},{key:"destroy",value:function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,i=0;i<t.length;i++){var n=t[i],r=e.get(n);if(r){var s=Ly()?Bw("CCShadow"):gv.BINDING;r.getBuffer(s).destroy(),r.getTexture(Av).destroy(),r.getTexture(Iv).destroy(),r.destroy()}e.delete(n)}}},{key:"gatherLightPasses",value:function(e,t){this.clear();var i=this._pipeline.pipelineSceneData.validPunctualLights;if(i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var n=this._pipeline.pipelineSceneData.renderObjects,r=0;r<n.length;r++){var s=n[r].model,a=s.subModels;if(gB(a,yB)&&(cB.length=0,this._lightCulling(s,i),cB.length))for(var o=0;o<a.length;o++){var u=yB[o];if(!(u<0)){var h=a[o],l=h.passes[u];h.passes[0].blendState.targets[0].blend||(Ly()&&Bw("CCForwardLight"),h.descriptorSet.bindBuffer(Fv.BINDING,this._firstLightBufferView),h.descriptorSet.update(),this._addRenderQueue(l,h,s,u))}}}for(var c=0;c<i.length;c++){var _=i[c];this._instancedLightPassPool.lights.push(_),this._instancedLightPassPool.dynamicOffsets.push(this._lightBufferStride*c),this._batchedLightPassPool.lights.push(_),this._batchedLightPassPool.dynamicOffsets.push(this._lightBufferStride*c)}this._instancedQueues.forEach((function(e){e.uploadBuffers(t)})),this._batchedQueues.forEach((function(e){e.uploadBuffers(t)}))}}},{key:"recordCommandBuffer",value:function(e,t,i){for(var n=this._pipeline.globalDSManager,r=0;r<this._instancedQueues.length;++r){var s=this._instancedLightPassPool.lights[r];lB[0]=this._instancedLightPassPool.dynamicOffsets[r];var a=n.getOrCreateDescriptorSet(s);this._instancedQueues[r].recordCommandBuffer(e,t,i,a,lB)}for(var o=0;o<this._batchedQueues.length;++o){var u=this._batchedLightPassPool.lights[o];lB[0]=this._batchedLightPassPool.dynamicOffsets[o];var h=n.getOrCreateDescriptorSet(u);this._batchedQueues[o].recordCommandBuffer(e,t,i,h,lB)}for(var l=0;l<this._lightPasses.length;l++){var c=this._lightPasses[l],_=c.subModel,f=c.passIdx,d=c.dynamicOffsets,m=c.lights,p=_.passes[f],v=_.shaders[f],y=_.inputAssembler,g=JS.getOrCreatePipelineState(e,p,v,t,y),S=p.descriptorSet,A=_.descriptorSet;i.bindPipelineState(g),i.bindDescriptorSet(_v.MATERIAL,S),i.bindInputAssembler(y);for(var T=0;T<d.length;++T){var E=m[T],b=n.getOrCreateDescriptorSet(E);lB[0]=d[T],i.bindDescriptorSet(_v.GLOBAL,b),i.bindDescriptorSet(_v.LOCAL,A,lB),i.draw(y)}}}},{key:"_lightCulling",value:function(e,t){for(var i=!1,n=0;n<t.length;n++){var r=t[n];switch(r.type){case Tx.SPHERE:i=dB(r,e);break;case Tx.SPOT:i=mB(r,e)}i||cB.push(n)}}},{key:"_addRenderQueue",value:function(e,t,i,n){var r=this._pipeline.pipelineSceneData.validPunctualLights,s=e.batchingScheme,a=null;s===VS.NONE&&((a=uB.alloc()).subModel=t,a.passIdx=n);for(var o=0;o<cB.length;o++){var u=cB[o],h=r[u];if((h.visibility&i.node.layer)===i.node.layer)switch(s){case VS.INSTANCING:var l=e.getInstancedBuffer(o);l.merge(t,n),l.dynamicOffsets[0]=this._lightBufferStride,this._instancedQueues[o]||(this._instancedQueues[o]=new oB),this._instancedQueues[o].queue.add(l);break;case VS.VB_MERGING:var c=e.getBatchedBuffer(o);c.merge(t,n,i),c.dynamicOffsets[0]=this._lightBufferStride,this._batchedQueues[o]||(this._batchedQueues[o]=new aB),this._batchedQueues[o].queue.add(c);break;default:a.lights.push(h),a.dynamicOffsets.push(this._lightBufferStride*u)}}s===VS.NONE&&this._lightPasses.push(a)}},{key:"_updateLightDescriptorSet",value:function(e,t){for(var i=this._pipeline.device,n=this._pipeline.pipelineSceneData,r=n.shadows,s=n.shadowFrameBufferMap,a=e.scene.mainLight,o=Dy(i)?0:1,u=this._pipeline.globalDSManager,h=n.validPunctualLights,l=this._pipeline.device.capabilities,c=0;c<h.length;c++){var _=h[c],f=u.getOrCreateDescriptorSet(_);if(f){var d=void 0,m=void 0;switch(_.type){case Tx.SPHERE:a&&Kw.updatePlanarNormalAndDistance(r,this._shadowUBO),this._shadowUBO[gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=o,this._shadowUBO[gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,cn.toArray(this._shadowUBO,r.shadowColor,gv.SHADOW_COLOR_OFFSET);break;case Tx.SPOT:var p=_;if(a&&Kw.updatePlanarNormalAndDistance(r,this._shadowUBO),Cn.invert(_B,_.node.getWorldMatrix()),Cn.perspective(fB,_.angle,1,.001,_.range,!0,l.clipSpaceMinZ,l.clipSpaceSignY,0),d=fB.clone(),m=fB.clone().invert(),Cn.multiply(fB,fB,_B),Cn.toArray(this._shadowUBO,_B,gv.MAT_LIGHT_VIEW_OFFSET),Cn.toArray(this._shadowUBO,fB,gv.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[gv.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[gv.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=_.range,this._shadowUBO[gv.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[gv.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=p.shadowPcf,this._shadowUBO[gv.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=p.shadowBias,this._shadowUBO[gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=o,this._shadowUBO[gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=p.shadowNormalBias,this._shadowUBO[gv.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[gv.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[gv.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=m.m10,this._shadowUBO[gv.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=m.m14,this._shadowUBO[gv.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=m.m11,this._shadowUBO[gv.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=m.m15,this._shadowUBO[gv.SHADOW_PROJ_INFO_OFFSET+0]=d.m00,this._shadowUBO[gv.SHADOW_PROJ_INFO_OFFSET+1]=d.m05,this._shadowUBO[gv.SHADOW_PROJ_INFO_OFFSET+2]=1/d.m00,this._shadowUBO[gv.SHADOW_PROJ_INFO_OFFSET+3]=1/d.m05,cn.toArray(this._shadowUBO,r.shadowColor,gv.SHADOW_COLOR_OFFSET),s.has(_)){var v,y=null===(v=s.get(_))||void 0===v?void 0:v.colorTextures[0];y&&f.bindTexture(Iv,y)}}f.update();var g=Ly()?Bw("CCShadow"):gv.BINDING;t.updateBuffer(f.getBuffer(g),this._shadowUBO)}}}},{key:"_updateUBOs",value:function(e,t){var i=e.exposure,n=this._pipeline.pipelineSceneData,r=n.isHDR,s=n.shadows,a=n.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=qi(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new Vc(this._lightBuffer,0,Fv.SIZE)));for(var o=0,u=0;o<a.length;o++,u+=this._lightBufferElementCount){var h=a[o];switch(h.type){case Tx.SPHERE:if(an.toArray(hB,h.position),hB[3]=0,this._lightBufferData.set(hB,u+Fv.LIGHT_POS_OFFSET),hB[0]=h.size,hB[1]=h.range,hB[2]=0,hB[3]=0,this._lightBufferData.set(hB,u+Fv.LIGHT_SIZE_RANGE_ANGLE_OFFSET),an.toArray(hB,h.color),h.useColorTemperature){var l=h.colorTemperatureRGB;hB[0]*=l.x,hB[1]*=l.y,hB[2]*=l.z}hB[3]=r?h.luminance*i*this._lightMeterScale:h.luminance,this._lightBufferData.set(hB,u+Fv.LIGHT_COLOR_OFFSET);break;case Tx.SPOT:if(an.toArray(hB,h.position),hB[3]=1,this._lightBufferData.set(hB,u+Fv.LIGHT_POS_OFFSET),hB[0]=h.size,hB[1]=h.range,hB[2]=h.spotAngle,hB[3]=s.enabled&&h.shadowEnabled&&s.type===pA.ShadowMap?1:0,this._lightBufferData.set(hB,u+Fv.LIGHT_SIZE_RANGE_ANGLE_OFFSET),an.toArray(hB,h.direction),this._lightBufferData.set(hB,u+Fv.LIGHT_DIR_OFFSET),an.toArray(hB,h.color),h.useColorTemperature){var c=h.colorTemperatureRGB;hB[0]*=c.x,hB[1]*=c.y,hB[2]*=c.z}hB[3]=r?h.luminance*i*this._lightMeterScale:h.luminance,this._lightBufferData.set(hB,u+Fv.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)}}]),e}(),BB=new ms,PB=function(){function e(t){n(this,e),this._pendingSubModels=[],this._castModels=[],this._instancedQueue=new oB,this._pipeline=void 0,this._pipeline=t}return s(e,[{key:"gatherShadowPasses",value:function(e,t){var i=this._pipeline.pipelineSceneData.shadows;if(this._instancedQueue.clear(),this._pendingSubModels.length=0,this._castModels.length=0,i.enabled&&i.type===pA.Planar&&!(i.normal.length()<1e-6)){var n=e.scene,r=e.frustum,s=0!=(e.visibility&ep.BitMask.DEFAULT);if(n.mainLight&&s){for(var a=n.models,o=0;o<a.length;o++){var u=a[o];n.isCulledByLod(e,u)||u.enabled&&u.node&&u.castShadow&&this._castModels.push(u)}var h=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(h);for(var l=0;l<this._castModels.length;l++){var c=this._castModels[l];if(!c.worldBounds||(ms.transform(BB,c.worldBounds,i.matLight),is.aabbFrustum(BB,r)))for(var _=c.subModels,f=0;f<_.length;f++)for(var d=_[f],m=d.passes,p=0;p<m.length;p++)m[p].batchingScheme===VS.INSTANCING?(h.merge(d,p,d.planarShader),this._instancedQueue.queue.add(h)):this._pendingSubModels.push(d)}this._instancedQueue.uploadBuffers(t)}}}},{key:"recordCommandBuffer",value:function(e,t,i){var n=this._pipeline.pipelineSceneData.shadows;if(n.enabled&&n.type===pA.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,i),this._pendingSubModels.length)){var r=n.material.passes[0],s=r.descriptorSet;i.bindDescriptorSet(_v.MATERIAL,s);for(var a=this._pendingSubModels,o=0;o<a.length;o++){var u=a[o],h=u.planarShader,l=u.inputAssembler,c=JS.getOrCreatePipelineState(e,r,h,t,l);i.bindPipelineState(c),i.bindDescriptorSet(_v.LOCAL,u.descriptorSet),i.bindInputAssembler(l),i.draw(l)}}}}]),e}(),MB=function(){function e(){n(this,e),this._phaseID=zS("default");var t=B.rendering;Ly()&&(this._phaseID=t.getPhaseID(t.getPassID("default"),"default"))}return s(e,[{key:"activate",value:function(e){this._pipeline=e}},{key:"render",value:function(e,t){for(var i=this._pipeline,n=i.device,r=i.commandBuffers[0],s=e.scene.batches,a=0;a<s.length;a++){var o=s[a],u=!1;if(e.visibility&o.visFlags&&(u=!0),u)for(var h=o.shaders.length,l=0;l<h;l++){var c=o.passes[l];if(c.phase===this._phaseID){var _=o.shaders[l],f=o.inputAssembler,d=JS.getOrCreatePipelineState(n,c,_,t,f);r.bindPipelineState(d),r.bindDescriptorSet(_v.MATERIAL,c.descriptorSet);var m=o.descriptorSet;r.bindDescriptorSet(_v.LOCAL,m),r.bindInputAssembler(f),r.draw(f)}}}}}]),e}(),OB=[new Dc(0,0,0,1)],DB=e("ForwardStage",(SB=Hs("ForwardStage"),AB=Aa([$I]),SB((RB=CB=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this)).renderQueues=bB&&bB(),e._renderQueues=[],e._renderArea=new xc,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=zS("default"),e._clearFlag=4294967295,e.additiveInstanceQueues=[],e._batchedQueue=new aB,e._instancedQueue=new oB,e._uiPhase=new MB,e}return s(i,[{key:"addRenderInstancedQueue",value:function(e){this.additiveInstanceQueues.includes(e)||this.additiveInstanceQueues.push(e)}},{key:"removeRenderInstancedQueue",value:function(e){var t=this.additiveInstanceQueues.indexOf(e);t>-1&&this.additiveInstanceQueues.splice(t,1)}},{key:"initialize",value:function(e){return g(l(i.prototype),"initialize",this).call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e,t){g(l(i.prototype),"activate",this).call(this,e,t);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=nB(this.renderQueues[n]);this._additiveLightQueue=new IB(this._pipeline),this._planarQueue=new PB(this._pipeline),this._uiPhase.activate(e)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){var t;this._instancedQueue.clear(),this._batchedQueue.clear();var i=this._pipeline,n=i.device;this._renderQueues.forEach(rB);for(var r=i.pipelineSceneData.renderObjects,s=0,a=0,o=0,u=0;u<r.length;++u){var h=r[u],l=h.model.subModels;for(s=0;s<l.length;++s){var c=l[s],_=c.passes;for(a=0;a<_.length;++a){var f=_[a];if(f.phase===this._phaseID){var d=f.batchingScheme;if(d===VS.INSTANCING){var m=f.getInstancedBuffer();m.merge(c,a),this._instancedQueue.queue.add(m)}else if(d===VS.VB_MERGING){var p=f.getBatchedBuffer();p.merge(c,a,h.model),this._batchedQueue.queue.add(p)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(h,s,a)}}}}this._instancedQueue.sort(),this._renderQueues.forEach(sB);var v=i.commandBuffers[0];i.pipelineUBO.updateShadowUBO(e);for(var y=0;y<this.additiveInstanceQueues.length;y++)this.additiveInstanceQueues[y].uploadBuffers(v);this._instancedQueue.uploadBuffers(v),this._batchedQueue.uploadBuffers(v),this._additiveLightQueue.gatherLightPasses(e,v),this._planarQueue.gatherShadowPasses(e,v),e.clearFlag&yc.COLOR&&(OB[0].x=e.clearColor.x,OB[0].y=e.clearColor.y,OB[0].z=e.clearColor.z,OB[0].w=e.clearColor.w),i.generateRenderArea(e,this._renderArea);var g=e.window.framebuffer,S=i.getRenderPass(e.clearFlag&this._clearFlag,g);v.beginRenderPass(S,g,this._renderArea,OB,e.clearDepth,e.clearStencil),v.bindDescriptorSet(_v.GLOBAL,i.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,S,v);for(var A=0;A<this.additiveInstanceQueues.length;A++)this.additiveInstanceQueues[A].recordCommandBuffer(n,S,v);this._instancedQueue.recordCommandBuffer(n,S,v),this._batchedQueue.recordCommandBuffer(n,S,v),this._additiveLightQueue.recordCommandBuffer(n,S,v),v.bindDescriptorSet(_v.GLOBAL,i.descriptorSet),this._planarQueue.recordCommandBuffer(n,S,v),this._renderQueues[1].recordCommandBuffer(n,S,v),null===(t=e.geometryRenderer)||void 0===t||t.render(S,v,i.pipelineSceneData),this._uiPhase.render(e,S),_A(n,S,v,i.profiler,e),v.endRenderPass()}}]),i}(rk),CB.initInfo={name:"ForwardStage",priority:dk.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:KI.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:KI.BACK_TO_FRONT,stages:["default","planarShadow"]}]},bB=Ms((EB=RB).prototype,"renderQueues",[AB,Js],(function(){return[]})),TB=EB))||TB)),LB=e("ForwardFlow",Hs("ForwardFlow")((kB=wB=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"initialize",value:function(e){if(g(l(i.prototype),"initialize",this).call(this,e),0===this._stages.length){var t=new DB;t.initialize(DB.initInfo),this._stages.push(t)}return!0}},{key:"activate",value:function(e){g(l(i.prototype),"activate",this).call(this,e)}},{key:"render",value:function(e){g(l(i.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){g(l(i.prototype),"destroy",this).call(this)}}]),i}(ak),wB.initInfo={name:rv,priority:mk.FORWARD,stages:[]},xB=kB))||xB),NB=zS("shadow-caster");function FB(e){var t=e.passes,i=B.rendering;Ly()&&(NB=i.getPhaseID(i.getPassID("default"),"shadow-caster"));for(var n=0;n<t.length;n++)if((!i||!i.enableEffectImport)&&t[n].phase===NB||Ly()&&t[n].phaseID===NB)return n;return-1}var GB,VB,UB,HB,zB,WB,XB=function(){function e(t){n(this,e),this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new oB,this._batchedQueue=new aB}return s(e,[{key:"gatherLightPasses",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.clear();var r=this._pipeline.pipelineSceneData,s=r.shadows;if(t&&s.enabled&&s.type===pA.ShadowMap){switch(t.type){case Tx.DIRECTIONAL:var a=t;if(a.shadowEnabled){var o,u=r.csmLayers;tx(e,r,o=a.shadowFixedArea?u.specialLayer:u.layers[n]);for(var h=o.shadowObjects,l=0;l<h.length;l++){var c=h[l],_=c.model;this.add(_)}}break;case Tx.SPOT:var f=t;if(f.shadowEnabled)for(var d=f.visibility,m=r.csmLayers.castShadowObjects,p=0;p<m.length;p++){var v=m[p],y=v.model;(!y.worldBounds||(d&y.node.layer)===y.node.layer&&is.aabbFrustum(y.worldBounds,f.frustum))&&this.add(y)}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}}},{key:"clear",value:function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()}},{key:"add",value:function(e){for(var t=e.subModels,i=0;i<t.length;i++){var n=t[i],r=FB(n);if(!(r<0)){var s=n.passes[r];if(s.batchingScheme===VS.INSTANCING){var a=s.getInstancedBuffer();a.merge(n,r),this._instancedQueue.queue.add(a)}else if(s.batchingScheme===VS.VB_MERGING){var o=s.getBatchedBuffer();o.merge(n,r,e),this._batchedQueue.queue.add(o)}else{var u=n.shaders[r];this._subModelsArray.push(n),u&&this._shaderArray.push(u),this._passArray.push(s)}}}}},{key:"recordCommandBuffer",value:function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],s=this._shaderArray[n],a=this._passArray[n],o=r.inputAssembler,u=JS.getOrCreatePipelineState(e,a,s,t,o),h=a.descriptorSet;i.bindPipelineState(u),i.bindDescriptorSet(_v.MATERIAL,h),i.bindDescriptorSet(_v.LOCAL,r.descriptorSet),i.bindInputAssembler(o),i.draw(o)}}}]),e}(),jB=[new Dc(1,1,1,1)],qB=e("ShadowStage",Hs("ShadowStage")((UB=VB=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._shadowFrameBuffer=null,e._renderArea=new xc,e._light=null,e._globalDS=null,e._level=0,e._isShadowMapCleared=!1,e}return s(i,[{key:"setUsage",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this._globalDS=e,this._light=t,this._shadowFrameBuffer=i,this._level=n}},{key:"destroy",value:function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()}},{key:"clearFramebuffer",value:function(e){if(this._light&&this._shadowFrameBuffer&&!this._isShadowMapCleared){jB[0].w=e.clearColor.w;var t=this._pipeline,i=t.pipelineSceneData,n=i.shadingScale,r=i.shadows,s=e.viewport,a=r.size;this._renderArea.x=s.x*a.x,this._renderArea.y=s.y*a.y,this._renderArea.width=s.width*a.x*n,this._renderArea.height=s.height*a.y*n;var o=t.commandBuffers[0],u=this._shadowFrameBuffer.renderPass;o.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,jB,e.clearDepth,e.clearStencil),o.endRenderPass(),this._isShadowMapCleared=!0}}},{key:"render",value:function(e){var t=this._pipeline,i=t.pipelineSceneData,n=i.shadows,r=this._globalDS,s=t.commandBuffers[0],a=this._level,o=t.device;if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(r,this._light,a),this._additiveShadowQueue.gatherLightPasses(e,this._light,s,a);var u=n.size;switch(this._light.type){case Tx.DIRECTIONAL:var h=this._light;if(h.shadowFixedArea||h.csmLevel===yA.LEVEL_1||!i.csmSupported)this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=u.x,this._renderArea.height=u.y;else{var l=o.capabilities.screenSpaceSignY;this._renderArea.x=a%2*.5*u.x,this._renderArea.y=l>0?.5*(1-Math.floor(a/2))*u.y:.5*Math.floor(a/2)*u.y,this._renderArea.width=.5*u.x,this._renderArea.height=.5*u.y}break;case Tx.SPOT:this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=u.x,this._renderArea.height=u.y}var c=this._shadowFrameBuffer.renderPass;s.beginRenderPass(c,this._shadowFrameBuffer,this._renderArea,jB,e.clearDepth,e.clearStencil),s.bindDescriptorSet(_v.GLOBAL,r),this._additiveShadowQueue.recordCommandBuffer(o,c,s),s.endRenderPass(),this._isShadowMapCleared=!1}}},{key:"activate",value:function(e,t){g(l(i.prototype),"activate",this).call(this,e,t),this._additiveShadowQueue=new XB(e),this._isShadowMapCleared=!1}}]),i}(rk),VB.initInfo={name:"ShadowStage",priority:dk.FORWARD,tag:0},GB=UB))||GB),YB=[],KB=e("ShadowFlow",Hs("ShadowFlow")((WB=zB=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._shadowRenderPass=null,e}return s(i,[{key:"initialize",value:function(e){if(g(l(i.prototype),"initialize",this).call(this,e),0===this._stages.length){var t=new qB;t.initialize(qB.initInfo),this._stages.push(t)}return!0}},{key:"activate",value:function(e){g(l(i.prototype),"activate",this).call(this,e);var t=Dy(e.device)?0:1;e.macros.CC_SHADOWMAP_FORMAT=t;var n=e.device.gfxAPI===Ml.WEBGL?1:0;e.macros.CC_SHADOWMAP_USE_LINEAR_DEPTH=n,e.pipelineSceneData.csmSupported=e.device.capabilities.maxFragmentUniformVectors>=(vv.COUNT+yv.COUNT+gv.COUNT+Sv.COUNT)/4,e.macros.CC_SUPPORT_CASCADED_SHADOW_MAP=e.pipelineSceneData.csmSupported,e.macros.CC_SHADOW_TYPE=0,e.macros.CC_DIR_SHADOW_PCF_TYPE=vA.HARD,e.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,e.macros.CC_CASCADED_LAYERS_TRANSITION=0,e.onGlobalPipelineStateChanged()}},{key:"render",value:function(e){var t=this._pipeline,i=t.pipelineSceneData.shadows,n=t.pipelineSceneData.csmLayers,r=t.pipelineSceneData.shadowFrameBufferMap,s=n.castShadowObjects,a=this._pipeline.pipelineSceneData.validPunctualLights;if(i.enabled&&i.type===pA.ShadowMap){for(var o=0,u=0;o<i.maxReceived&&u<a.length;){var h=a[u];h.type===Tx.SPOT&&h.shadowEnabled&&(YB.push(h),o++),u++}if(0!==s.length){i.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l&&l.shadowEnabled){var c=t.descriptorSet;r.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);var _=r.get(l);if(l.shadowFixedArea)this._renderStage(e,l,_,c);else for(var f=t.pipelineSceneData.csmSupported?l.csmLevel:1,d=0;d<f;d++)this._renderStage(e,l,_,c,d)}for(var m=0;m<YB.length;m++){var p=YB[m],v=t.globalDSManager.getOrCreateDescriptorSet(p);r.has(p)||this._initShadowFrameBuffer(t,p,e.window.swapchain);var y=r.get(p);this._renderStage(e,p,y,v)}YB.length=0}else this.clearShadowMap(YB,e)}}},{key:"destroy",value:function(){if(g(l(i.prototype),"destroy",this).call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,t=Array.from(e.values()),n=0;n<t.length;n++){var r=t[n];if(r){for(var s=r.colorTextures,a=0;a<s.length;a++){var o=s[a];o&&o.destroy()}s.length=0;var u=r.depthStencilTexture;u&&u.destroy(),r.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()}},{key:"_initShadowFrameBuffer",value:function(e,t){var i=e.device,n=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,s=Dy(i)?Ll.R32F:Ll.RGBA8;if(!this._shadowRenderPass){var a=new s_;a.format=s,a.loadOp=nc.CLEAR,a.storeOp=rc.STORE,a.sampleCount=1;var o=new a_;o.format=Ll.DEPTH_STENCIL,o.depthLoadOp=nc.CLEAR,o.depthStoreOp=rc.DISCARD,o.stencilLoadOp=nc.CLEAR,o.stencilStoreOp=rc.DISCARD,o.sampleCount=1;var u=new h_([a],o);this._shadowRenderPass=i.createRenderPass(u)}var h=[];h.push(i.createTexture(new Wc(zl.TEX2D,Wl.COLOR_ATTACHMENT|Wl.SAMPLED,s,n.x,n.y)));var l=i.createTexture(new Wc(zl.TEX2D,Wl.DEPTH_STENCIL_ATTACHMENT,Ll.DEPTH_STENCIL,n.x,n.y)),c=i.createFramebuffer(new f_(this._shadowRenderPass,h,l));r.set(t,c)}},{key:"_renderStage",value:function(e,t,i,n){for(var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=0;s<this._stages.length;s++){var a=this._stages[s];a.setUsage(n,t,i,r),a.render(e)}}},{key:"clearShadowMap",value:function(e,t){var i=this._pipeline,n=i.pipelineSceneData,r=t.scene.mainLight;if(r){var s=this._pipeline.descriptorSet;n.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var a=n.shadowFrameBufferMap.get(r),o=0;o<this._stages.length;o++){var u=this._stages[o];u.setUsage(s,r,a),u.clearFramebuffer(t)}}for(var h=0;h<e.length;h++){var l=e[h],c=i.globalDSManager.getOrCreateDescriptorSet(l);n.shadowFrameBufferMap.has(l)||this._initShadowFrameBuffer(this._pipeline,l,t.window.swapchain);for(var _=n.shadowFrameBufferMap.get(l),f=0;f<this._stages.length;f++){var d=this._stages[f];d.setUsage(c,l,_),d.clearFramebuffer(t)}}}},{key:"resizeShadowMap",value:function(){for(var e,t=this._pipeline.pipelineSceneData.shadows,i=t.size,n=this._pipeline,r=n.device,s=n.pipelineSceneData.shadowFrameBufferMap,a=Dy(r)?Ll.R32F:Ll.RGBA8,o=R(s.keys());!(e=o()).done;){var u=e.value,h=s.get(u);if(h){var l=[];l.push(n.device.createTexture(new Wc(zl.TEX2D,Wl.COLOR_ATTACHMENT|Wl.SAMPLED,a,i.x,i.y)));var c=h.depthStencilTexture;c&&c.resize(i.x,i.y);var _=h.renderPass;h.destroy();var f=r.createFramebuffer(new f_(_,l,c));s.set(u,f)}}t.shadowMapDirty=!1}}]),i}(ak),zB.initInfo={name:sv,priority:mk.SHADOW,tag:HI.SCENE,stages:[]},HB=WB))||HB),QB=new Cn,JB=new Cn,ZB=new Cn,$B=new Cn,eP=new Cn,tP=new Cn,iP=new Cn,nP=new an(0,0,0),rP=new an,sP=new In,aP=new an,oP=new an,uP=new an(1e7,1e7,1e7),hP=new an(-1e7,-1e7,-1e7),lP=new an,cP=0,_P=0,fP=function(){function e(t){n(this,e),this._shadowObjects=[],this._shadowCameraFar=0,this._level=void 0,this._matShadowView=new Cn,this._matShadowProj=new Cn,this._matShadowViewProj=new Cn,this._validFrustum=new Ts,this._splitFrustum=new Ts,this._lightViewFrustum=new Ts,this._castLightViewBoundingBox=new ms,this._level=t,this._validFrustum.accurate=!0,this._splitFrustum.accurate=!0,this._lightViewFrustum.accurate=!0}return s(e,[{key:"level",get:function(){return this._level}},{key:"shadowObjects",get:function(){return this._shadowObjects}},{key:"shadowCameraFar",get:function(){return this._shadowCameraFar},set:function(e){this._shadowCameraFar=e}},{key:"matShadowView",get:function(){return this._matShadowView},set:function(e){this._matShadowView=e}},{key:"matShadowProj",get:function(){return this._matShadowProj},set:function(e){this._matShadowProj=e}},{key:"matShadowViewProj",get:function(){return this._matShadowViewProj},set:function(e){this._matShadowViewProj=e}},{key:"validFrustum",get:function(){return this._validFrustum}},{key:"splitFrustum",get:function(){return this._splitFrustum}},{key:"lightViewFrustum",get:function(){return this._lightViewFrustum}},{key:"castLightViewBoundingBox",get:function(){return this._castLightViewBoundingBox}},{key:"copyToValidFrustum",value:function(e){Ts.copy(this._validFrustum,e)}},{key:"calculateValidFrustumOrtho",value:function(e,t,i,n,r){Ts.createOrtho(this._validFrustum,e,t,i,n,r)}},{key:"calculateSplitFrustum",value:function(e,t,i,n){this._splitFrustum.split(i,n,e.aspect,e.fov,t)}},{key:"destroy",value:function(){this._shadowObjects.length=0}},{key:"createMatrix",value:function(e,t,i){var n=B.director.root.device,r=e.shadowInvisibleOcclusionRange;Ts.copy(this._lightViewFrustum,this._splitFrustum),Cn.fromRT(JB,e.node.rotation,nP),Cn.invert(ZB,JB);var s,a,o=ZB.clone();this._lightViewFrustum.transform(ZB),ms.fromPoints(this._castLightViewBoundingBox,uP,hP),this._castLightViewBoundingBox.mergeFrustum(this._lightViewFrustum),e.csmOptimizationMode===gA.DisableRotationFix?(s=2*this._castLightViewBoundingBox.halfExtents.x,a=2*this._castLightViewBoundingBox.halfExtents.y):s=a=an.distance(this._lightViewFrustum.vertices[0],this._lightViewFrustum.vertices[6]);var u=B.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1;if(u>1&&e.csmOptimizationMode===gA.RemoveDuplicates)if(this._level>=u-1)_P=this._castLightViewBoundingBox.halfExtents.z,cP=this._castLightViewBoundingBox.center.z;else{var h=Math.abs(this._castLightViewBoundingBox.center.z-cP)+_P;this._castLightViewBoundingBox.halfExtents.z=Math.max(this._castLightViewBoundingBox.center.z,h)}var l=this._castLightViewBoundingBox.halfExtents.z;this._shadowCameraFar=2*l+r;var c=this._castLightViewBoundingBox.center;if(lP.set(c.x,c.y,c.z+l+r),an.transformMat4(lP,lP,JB),Cn.fromRT(JB,e.node.rotation,lP),Cn.invert(ZB,JB),!i){var _=.5*s,f=.5*a;Cn.ortho($B,-_,_,-f,f,.1,this._shadowCameraFar,n.capabilities.clipSpaceMinZ,n.capabilities.clipSpaceSignY),Cn.multiply(tP,$B,o),an.transformMat4(rP,lP,tP);var d=2/t;sP.set(d,d);var m=rP.x%sP.x,p=rP.y%sP.y;aP.set(rP.x-m,rP.y-p,rP.z),Cn.invert(iP,tP),an.transformMat4(oP,aP,iP),Cn.fromRT(JB,e.node.rotation,oP),Cn.invert(ZB,JB),Cn.multiply(eP,$B,ZB),Cn.copy(this._matShadowView,ZB),Cn.copy(this._matShadowProj,$B),Cn.copy(this._matShadowViewProj,eP)}Ts.createOrtho(this._validFrustum,s,a,.1,this._shadowCameraFar,JB)}}]),e}(),dP=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this,e))._splitCameraNear=0,r._splitCameraFar=0,r._csmAtlas=new en,r._calculateAtlas(e),r}return s(i,[{key:"splitCameraNear",get:function(){return this._splitCameraNear},set:function(e){this._splitCameraNear=e}},{key:"splitCameraFar",get:function(){return this._splitCameraFar},set:function(e){this._splitCameraFar=e}},{key:"csmAtlas",get:function(){return this._csmAtlas},set:function(e){this._csmAtlas=e}},{key:"destroy",value:function(){g(l(i.prototype),"destroy",this).call(this)}},{key:"_calculateAtlas",value:function(e){var t=B.director.root.device.capabilities.clipSpaceSignY,i=e%2-.5,n=(.5-Math.floor(e/2))*t;this._csmAtlas.set(.5,.5,i,n)}}]),i}(fP),mP=function(){function e(){n(this,e),this._castShadowObjects=[],this._layerObjects=new Ch(64),this._layers=[],this._levelCount=0,this._specialLayer=new fP(1),this._shadowDistance=0;for(var t=0;t<yA.LEVEL_4;t++)this._layers[t]=new dP(t)}return s(e,[{key:"castShadowObjects",get:function(){return this._castShadowObjects}},{key:"layerObjects",get:function(){return this._layerObjects}},{key:"layers",get:function(){return this._layers}},{key:"specialLayer",get:function(){return this._specialLayer}},{key:"update",value:function(e,t){var i=t.scene.mainLight;if(null!==i){var n=e.shadows,r=B.director.root.pipeline.pipelineSceneData.csmSupported?i.csmLevel:1,s=i.shadowDistance;n.enabled&&i.shadowEnabled&&(i.shadowFixedArea?this._updateFixedArea(i):((i.csmNeedUpdate||this._levelCount!==r||this._shadowDistance!==s)&&(this._splitFrustumLevels(i),this._levelCount=r,this._shadowDistance=s),this._calculateCSM(t,i,n)))}}},{key:"destroy",value:function(){this._castShadowObjects.length=0;for(var e=0;e<this._layers.length;e++)this._layers[e].destroy();this._layers.length=0}},{key:"_updateFixedArea",value:function(e){var t=B.director.root.device,i=e.shadowOrthoSize,n=e.shadowOrthoSize,r=e.shadowNear,s=e.shadowFar;Cn.fromRT(JB,e.node.getWorldRotation(),e.node.getWorldPosition()),Cn.invert(ZB,JB),Cn.ortho($B,-i,i,-n,n,r,s,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY),Cn.multiply(eP,$B,ZB),this._specialLayer.matShadowView=ZB,this._specialLayer.matShadowProj=$B,this._specialLayer.matShadowViewProj=eP,this._specialLayer.calculateValidFrustumOrtho(2*i,2*n,r,s,JB)}},{key:"_splitFrustumLevels",value:function(e){var t=.1,i=e.shadowDistance,n=i/t,r=B.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1,s=e.csmLayerLambda;this._layers[0].splitCameraNear=t;for(var a=1;a<r;a++){var o=a/r,u=s*t*Math.pow(n,o)+(1-s)*(t+(i-t)*o),h=1.005*u;this._layers[a].splitCameraNear=u,this._layers[a-1].splitCameraFar=h}this._layers[r-1].splitCameraFar=i,e.csmNeedUpdate=!1}},{key:"_calculateCSM",value:function(e,t,i){var n=B.director.root.pipeline.pipelineSceneData.csmSupported?t.csmLevel:1,r=n>1?.5*i.size.x:i.size.x;if(!(r<0)){this._getCameraWorldMatrix(QB,e);for(var s=n-1;s>=0;s--){var a=this._layers[s],o=a.splitCameraNear,u=a.splitCameraFar;a.calculateSplitFrustum(e,QB,o,u),a.createMatrix(t,r,!1)}n===yA.LEVEL_1?(this._specialLayer.shadowCameraFar=this._layers[0].shadowCameraFar,Cn.copy(this._specialLayer.matShadowView,this._layers[0].matShadowView),Cn.copy(this._specialLayer.matShadowProj,this._layers[0].matShadowProj),Cn.copy(this._specialLayer.matShadowViewProj,this._layers[0].matShadowViewProj),this._specialLayer.copyToValidFrustum(this._layers[0].validFrustum)):(this._specialLayer.calculateSplitFrustum(e,QB,.1,t.shadowDistance),this._specialLayer.createMatrix(t,r,!0))}}},{key:"_getCameraWorldMatrix",value:function(e,t){if(t.node){var i=t.node,n=i.getWorldPosition(),r=i.getWorldRotation();Cn.fromRT(e,r,n),e.m08*=-1,e.m09*=-1,e.m10*=-1}}}]),e}(),pP=e("PipelineSceneData",function(){function e(){n(this,e),this.fog=new DE,this.ambient=new ev,this.skybox=new xA,this.shadows=new AA,this.csmLayers=new mP,this.octree=new Rx,this.lightProbes=B.internal.LightProbes?new B.internal.LightProbes:null,this.validPunctualLights=[],this.renderObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._csmSupported=!0,this._shadingScale=1}return s(e,[{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale=e}},{key:"csmSupported",get:function(){return this._csmSupported},set:function(e){this._csmSupported=e}},{key:"activate",value:function(e){return this._device=e,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0}},{key:"initGeometryRendererMaterials",value:function(){for(var e=0,t=0;t<6;t++){this._geometryRendererMaterials[t]=new dA,this._geometryRendererMaterials[t]._uuid="geometry-renderer-material-".concat(t),this._geometryRendererMaterials[t].initialize({effectName:"internal/builtin-geometry-renderer",technique:t});for(var i=0;i<this._geometryRendererMaterials[t].passes.length;++i)this._geometryRendererPasses[e]=this._geometryRendererMaterials[t].passes[i],this._geometryRendererShaders[e]=this._geometryRendererMaterials[t].passes[i].getShaderVariant(),e++}}},{key:"geometryRendererPasses",get:function(){return this._geometryRendererPasses}},{key:"geometryRendererShaders",get:function(){return this._geometryRendererShaders}},{key:"initOcclusionQuery",value:function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new dA;e._uuid="default-occlusion-query-material",e.initialize({effectName:"internal/builtin-occlusion-query"}),this._occlusionQueryMaterial=e,e.passes.length>0&&(this._occlusionQueryShader=e.passes[0].getShaderVariant())}}},{key:"getOcclusionQueryPass",value:function(){return this._occlusionQueryMaterial&&this._occlusionQueryMaterial.passes.length>0?this._occlusionQueryMaterial.passes[0]:null}},{key:"updatePipelineSceneData",value:function(){}},{key:"destroy",value:function(){var e,t,i;this.shadows.destroy(),this.csmLayers.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(i=this._occlusionQueryIndicesBuffer)||void 0===i||i.destroy(),this._occlusionQueryIndicesBuffer=null}},{key:"_createOcclusionQueryIA",value:function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),i=3*Float32Array.BYTES_PER_ELEMENT,n=8*i;this._occlusionQueryVertexBuffer=e.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE,n,i)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),s=Uint16Array.BYTES_PER_ELEMENT,a=36*s;this._occlusionQueryIndicesBuffer=e.createBuffer(new Gc(Gl.INDEX|Gl.TRANSFER_DST,Hl.DEVICE,a,s)),this._occlusionQueryIndicesBuffer.update(r);var o=[new i_("a_position",Ll.RGB32F)],u=new r_(o,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(u)}}]),e}()),vP=ep.makeMaskExclude([ep.BitMask.UI_2D,ep.BitMask.UI_3D,ep.BitMask.GIZMOS,ep.BitMask.EDITOR,ep.BitMask.SCENE_GIZMO,ep.BitMask.PROFILER]),yP="CC_USE_RGBE_OUTPUT",gP=zS("default"),SP=zS("reflect-map");function AP(e){var t=e.passes,i=B.rendering;Ly()&&(gP=i.getPhaseID(i.getPassID("default"),"default"));for(var n=0;n<t.length;n++)if((!i||!i.enableEffectImport)&&t[n].phase===gP||Ly()&&t[n].phaseID===gP)return n;return-1}function TP(e){var t=e.passes,i=B.rendering;Ly()&&(SP=i.getPhaseID(i.getPassID("default"),"reflect-map"));for(var n=0;n<t.length;n++)if((!i||!i.enableEffectImport)&&t[n].phase===SP||Ly()&&t[n].phaseID===SP)return n;return-1}var EP,bP,CP,RP,xP,wP,kP,IP,BP,PP,MP,OP,DP,LP,NP,FP,GP,VP,UP,HP,zP,WP,XP,jP,qP,YP,KP,QP,JP,ZP,$P,eM,tM,iM,nM,rM,sM,aM=function(){function e(t){n(this,e),this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._rgbeSubModelsArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new oB,this._batchedQueue=new aB}return s(e,[{key:"gatherRenderObjects",value:function(e,t,i){this.clear();var n=t.scene,r=this._pipeline.pipelineSceneData.skybox;r.enabled&&r.model&&e.camera.clearFlag&qR&&this.add(r.model);for(var s=n.models,a=e.camera.visibility,o=0;o<s.length;o++){var u=s[o];n.isCulledByLod(t,u)||u.enabled&&u.node&&u.worldBounds&&u.bakeToReflectionProbe&&(e.probeType===hx.CUBE?((a&u.node.layer)===u.node.layer||a&u.visFlags)&&is.aabbWithAABB(u.worldBounds,e.boundingBox)&&this.add(u):((u.node.layer&vP)===u.node.layer||vP&u.visFlags)&&is.aabbFrustum(u.worldBounds,e.camera.frustum)&&this.add(u))}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},{key:"clear",value:function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear(),this._rgbeSubModelsArray.length=0}},{key:"add",value:function(e){for(var t=e.subModels,i=0;i<t.length;i++){var n=t[i],r=TP(n),s=!0;if(r<0&&(r=AP(n),s=!1),!(r<0)){var a=n.passes[r],o=a.batchingScheme;if(!s){var u=n.patches,h=[{name:yP,value:!0}];u=u?u.concat(h):h,n.onMacroPatchesStateChanged(u),this._rgbeSubModelsArray.push(n)}if(o===VS.INSTANCING){var l=a.getInstancedBuffer();l.merge(n,r),this._instancedQueue.queue.add(l)}else if(a.batchingScheme===VS.VB_MERGING){var c=a.getBatchedBuffer();c.merge(n,r,e),this._batchedQueue.queue.add(c)}else{var _=n.shaders[r];this._subModelsArray.push(n),_&&this._shaderArray.push(_),this._passArray.push(a)}}}}},{key:"recordCommandBuffer",value:function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],s=this._shaderArray[n],a=this._passArray[n],o=r.inputAssembler,u=JS.getOrCreatePipelineState(e,a,s,t,o),h=a.descriptorSet;i.bindPipelineState(u),i.bindDescriptorSet(_v.MATERIAL,h),i.bindDescriptorSet(_v.LOCAL,r.descriptorSet),i.bindInputAssembler(o),i.draw(o)}this.resetRGBEMacro(),this._instancedQueue.clear(),this._batchedQueue.clear()}},{key:"resetRGBEMacro",value:function(){for(var e=0;e<this._rgbeSubModelsArray.length;e++){var t=this._rgbeSubModelsArray[e],i=t.patches;if(i){for(var n=0;n<i.length;n++)if(i[n].name===yP){i.splice(n,1);break}t.onMacroPatchesStateChanged(i)}}}}]),e}(),oM=[new Dc(1,1,1,1)],uM=e("ReflectionProbeStage",Hs("ReflectionProbeStage")((CP=bP=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._frameBuffer=null,e._renderArea=new xc,e._probe=null,e._rgbeColor=new an,e}return s(i,[{key:"setUsageInfo",value:function(e,t){this._probe=e,this._frameBuffer=t}},{key:"destroy",value:function(){var e;this._frameBuffer=null,null===(e=this._probeRenderQueue)||void 0===e||e.clear()}},{key:"clearFramebuffer",value:function(e){if(this._frameBuffer){oM[0].w=e.clearColor.w;var t=this._pipeline,i=t.pipelineSceneData.shadingScale,n=e.viewport,r=this._probe.resolution;this._renderArea.x=n.x*r,this._renderArea.y=n.y*r,this._renderArea.width=n.width*r*i,this._renderArea.height=n.height*r*i;var s=t.commandBuffers[0],a=this._frameBuffer.renderPass;s.beginRenderPass(a,this._frameBuffer,this._renderArea,oM,e.clearDepth,e.clearStencil),s.endRenderPass()}}},{key:"render",value:function(e){var t=this._pipeline,i=t.commandBuffers[0];this._probeRenderQueue.gatherRenderObjects(this._probe,e,i),t.pipelineUBO.updateCameraUBO(this._probe.camera),this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=this._probe.renderArea().x,this._renderArea.height=this._probe.renderArea().y;var n=this._frameBuffer.renderPass;if(this._probe.camera.clearFlag&yc.COLOR){this._rgbeColor.x=this._probe.camera.clearColor.x,this._rgbeColor.y=this._probe.camera.clearColor.y,this._rgbeColor.z=this._probe.camera.clearColor.z;var r=function(e){var t=Math.max(Math.max(e.x,e.y),e.z),i=128;t>1e-4&&(i=Math.log(t)/Math.log(1.1),i=Li((i=Math.ceil(i))+128,0,255));var n=1/Math.pow(1.1,i-128),r=function(e,t,i){if(t>i){var n=t;t=i,i=n}return e<t?t:e>i?i:e}(e.multiplyScalar(n),new an(0,0,0),new an(1,1,1));r.multiplyScalar(255);var s,a,o=fn(r).add((s=r.subtract(fn(r)))<(a=new an(.5,.5,.5))?a:s);return new en(o.x/255,o.y/255,o.z/255,i/255)}(this._rgbeColor);oM[0].x=r.x,oM[0].y=r.y,oM[0].z=r.z,oM[0].w=r.w}var s=t.device;i.beginRenderPass(n,this._frameBuffer,this._renderArea,oM,this._probe.camera.clearDepth,this._probe.camera.clearStencil),i.bindDescriptorSet(_v.GLOBAL,t.descriptorSet),this._probeRenderQueue.recordCommandBuffer(s,n,i),i.endRenderPass(),t.pipelineUBO.updateCameraUBO(e)}},{key:"activate",value:function(e,t){g(l(i.prototype),"activate",this).call(this,e,t),this._probeRenderQueue=new aM(e)}}]),i}(rk),bP.initInfo={name:"ReflectionProbeStage",priority:dk.FORWARD,tag:0},EP=CP))||EP),hM=e("ReflectionProbeFlow",Hs("ReflectionProbeFlow")((wP=xP=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"initialize",value:function(e){if(g(l(i.prototype),"initialize",this).call(this,e),0===this._stages.length){var t=new uM;t.initialize(uM.initInfo),this._stages.push(t)}return!0}},{key:"activate",value:function(e){g(l(i.prototype),"activate",this).call(this,e)}},{key:"render",value:function(e){if(B.internal.reflectionProbeManager)for(var t=B.internal.reflectionProbeManager.getProbes(),i=0;i<t.length;i++)t[i].needRender&&t[i].probeType===hx.PLANAR&&this._renderStage(e,t[i])}},{key:"destroy",value:function(){g(l(i.prototype),"destroy",this).call(this)}},{key:"_renderStage",value:function(e,t){for(var i=0;i<this._stages.length;i++){var n=this._stages[i];if(t.probeType===hx.PLANAR)B.internal.reflectionProbeManager.updatePlanarMap(t,null),n.setUsageInfo(t,t.realtimePlanarTexture.window.framebuffer),n.render(e),B.internal.reflectionProbeManager.updatePlanarMap(t,t.realtimePlanarTexture.getGFXTexture());else{for(var r=0;r<6;r++){var s=t.bakedCubeTextures[r];if(!s)return;t.updateCameraDir(r),n.setUsageInfo(t,s.window.framebuffer),n.render(e)}t.needRender=!1}}}}]),i}(ak),xP.initInfo={name:"PIPELINE_FLOW_RELECTION_PROBE",priority:0,tag:HI.SCENE,stages:[]},RP=wP))||RP),lM=e("ForwardPipeline",(kP=Hs("ForwardPipeline"),IP=Aa([QI]),kP((PP=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).renderTextures=MP&&MP(),e._postRenderPass=null,e}return s(i,[{key:"postRenderPass",get:function(){return this._postRenderPass}},{key:"initialize",value:function(e){if(g(l(i.prototype),"initialize",this).call(this,e),0===this._flows.length){var t=new KB;t.initialize(KB.initInfo),this._flows.push(t);var n=new hM;n.initialize(hM.initInfo),this._flows.push(n);var r=new LB;r.initialize(LB.initInfo),this._flows.push(r)}return!0}},{key:"activate",value:function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new pP,!(!g(l(i.prototype),"activate",this).call(this,e)||!this._activeRenderer(e)&&(ue(2402),1))}},{key:"_ensureEnoughSize",value:function(e){for(var t=this._width,i=this._height,n=0;n<e.length;++n){var r=e[n].window;t=Math.max(r.width,t),i=Math.max(r.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i)}},{key:"destroy",value:function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();return this._commandBuffers.length=0,g(l(i.prototype),"destroy",this).call(this)}},{key:"_activeRenderer",value:function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Av,t),this._descriptorSet.bindTexture(Av,HS.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Iv,t),this._descriptorSet.bindTexture(Iv,HS.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0}},{key:"_destroyUBOs",value:function(){this._descriptorSet&&(this._descriptorSet.getBuffer(vv.BINDING).destroy(),this._descriptorSet.getBuffer(gv.BINDING).destroy(),this._descriptorSet.getBuffer(yv.BINDING).destroy(),this._descriptorSet.getTexture(Av).destroy(),this._descriptorSet.getTexture(Iv).destroy())}}]),i}(YI),MP=Ms(PP.prototype,"renderTextures",[IP,Js],(function(){return[]})),BP=PP))||BP)),cM=[new Dc(0,0,0,0),new Dc(0,0,0,0),new Dc(0,0,0,0)],_M=e("GbufferStage",(OP=Hs("GbufferStage"),DP=Aa([$I]),OP((VP=GP=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this)).renderQueues=FP&&FP(),e._renderQueues=[],e._renderArea=new xc,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=zS("default"),e._batchedQueue=new aB,e._instancedQueue=new oB,e}return s(i,[{key:"initialize",value:function(e){return g(l(i.prototype),"initialize",this).call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e,t){g(l(i.prototype),"activate",this).call(this,e,t);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=nB(this.renderQueues[n])}},{key:"destroy",value:function(){}},{key:"render",value:function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(rB),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var n=t.pipelineSceneData.renderObjects,r=0,s=0,a=0,o=0;o<n.length;++o){var u=n[o],h=u.model.subModels;for(r=0;r<h.length;++r){var l=h[r],c=l.passes;for(s=0;s<c.length;++s){var _=c[s];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===VS.INSTANCING){var d=_.getInstancedBuffer();d.merge(l,s),this._instancedQueue.queue.add(d)}else if(f===VS.VB_MERGING){var m=_.getBatchedBuffer();m.merge(l,s,u.model),this._batchedQueue.queue.add(m)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(u,r,s)}}}}this._renderQueues.forEach(sB);var p=t.commandBuffers[0];this._instancedQueue.uploadBuffers(p),this._batchedQueue.uploadBuffers(p),e.clearFlag&yc.COLOR&&(t.pipelineSceneData.isHDR?eA(cM[0],e.clearColor):(cM[0].x=e.clearColor.x,cM[0].y=e.clearColor.y,cM[0].z=e.clearColor.z)),cM[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,y=v.renderPass;p.beginRenderPass(y,v,this._renderArea,cM,e.clearDepth,e.clearStencil),p.setScissor(t.generateScissor(e)),p.setViewport(t.generateViewport(e)),p.bindDescriptorSet(_v.GLOBAL,t.descriptorSet);for(var g=0;g<this.renderQueues.length;g++)this._renderQueues[g].recordCommandBuffer(i,y,p);this._instancedQueue.recordCommandBuffer(i,y,p),this._batchedQueue.recordCommandBuffer(i,y,p),p.endRenderPass()}}]),i}(rk),GP.initInfo={name:"GbufferStage",priority:pk.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:KI.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:KI.BACK_TO_FRONT,stages:["default"]}]},FP=Ms((NP=VP).prototype,"renderQueues",[DP,Js],(function(){return[]})),LP=NP))||LP)),fM=[new Dc(0,0,0,1)],dM=e("LightingStage",(UP=Hs("LightingStage"),HP=Aa(dA),zP=Aa([$I]),UP((KP=YP=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._deferredLitsBufs=null,e._maxDeferredLights=Gv.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new xc,e._uiPhase=void 0,e._deferredMaterial=jP&&jP(),e.renderQueues=qP&&qP(),e._phaseID=zS("default"),e._renderQueues=[],e._uiPhase=new MB,e}return s(i,[{key:"initialize",value:function(e){return g(l(i.prototype),"initialize",this).call(this,e),!0}},{key:"gatherLights",value:function(e){for(var t=this._pipeline,i=t.commandBuffers[0],n=e.scene.sphereLights,r=e.scene.spotLights,s=dr.create(0,0,0,1),a=new Float32Array(4),o=e.exposure,u=0,h=en.length,l=h*this._maxDeferredLights,c=0;c<n.length&&u<this._maxDeferredLights;c++,++u){var _=n[c];if(dr.set(s,_.position.x,_.position.y,_.position.z,_.range),is.sphereFrustum(s,e.frustum)){if(an.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,u*h),an.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}t.pipelineSceneData.isHDR?a[3]=_.luminance*o*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,u*h+1*l),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,u*h+2*l)}}for(var d=0;d<r.length&&u<this._maxDeferredLights;d++,++u){var m=r[d];if(dr.set(s,m.position.x,m.position.y,m.position.z,m.range),is.sphereFrustum(s,e.frustum)){if(an.toArray(a,m.position),a[3]=1,this._lightBufferData.set(a,u*h+0*l),an.toArray(a,m.color),m.useColorTemperature){var p=m.colorTemperatureRGB;a[0]*=p.x,a[1]*=p.y,a[2]*=p.z}t.pipelineSceneData.isHDR?a[3]=m.luminance*o*this._lightMeterScale:a[3]=m.luminance,this._lightBufferData.set(a,u*h+1*l),a[0]=m.size,a[1]=m.range,a[2]=m.spotAngle,this._lightBufferData.set(a,u*h+2*l),an.toArray(a,m.direction),this._lightBufferData.set(a,u*h+3*l)}}var v=3*l+3;this._lightBufferData.set([u],v),i.updateBuffer(this._deferredLitsBufs,this._lightBufferData)}},{key:"_createStageDescriptor",value:function(e){var t=this._pipeline.device,i=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;i=Math.ceil(i/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,i,t.capabilities.uboOffsetAlignment));var n=t.createBuffer(new Vc(this._deferredLitsBufs,0,i));this._lightBufferData=new Float32Array(i/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new p_(e.localSetLayout)),this._descriptorSet.bindBuffer(Fv.BINDING,n);var r=t.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.DEVICE,Mv.SIZE,Mv.SIZE));this._descriptorSet.bindBuffer(Mv.BINDING,r)}},{key:"activate",value:function(e,t){g(l(i.prototype),"activate",this).call(this,e,t),this._uiPhase.activate(e);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=nB(this.renderQueues[n]);this._planarQueue=new PB(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)}},{key:"destroy",value:function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null}},{key:"render",value:function(e){var t,i=this._pipeline,n=i.device,r=i.commandBuffers[0],s=i.pipelineSceneData,a=s.renderObjects;this._planarQueue.gatherShadowPasses(e,r),i.generateRenderArea(e,this._renderArea);for(var o=i.getPipelineRenderData(),u=s.deferredLightingMaterial.passes[0],h=u.getShaderVariant(),l=0;l<3;++l)u.descriptorSet.bindTexture(l,o.gbufferRenderTargets[l]),u.descriptorSet.bindSampler(l,o.sampler);u.descriptorSet.bindTexture(3,o.outputDepth),u.descriptorSet.bindSampler(3,o.sampler),u.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(u),this.gatherLights(e),e.clearFlag&yc.COLOR&&(fM[0].x=e.clearColor.x,fM[0].y=e.clearColor.y,fM[0].z=e.clearColor.z),fM[0].w=0;var c=o.outputFrameBuffer,_=c.renderPass;i.pipelineUBO.updateShadowUBO(e),r.beginRenderPass(_,c,this._renderArea,fM,e.clearDepth,e.clearStencil),r.setScissor(i.generateScissor(e)),r.setViewport(i.generateViewport(e)),r.bindDescriptorSet(_v.GLOBAL,i.descriptorSet);var f=i.quadIAOffscreen,d=null;null!=u&&null!=h&&null!=f&&(d=JS.getOrCreatePipelineState(n,u,h,_,f)),null!=d&&(this._descriptorSet.update(),r.bindPipelineState(d),r.bindDescriptorSet(_v.MATERIAL,u.descriptorSet),r.bindDescriptorSet(_v.LOCAL,this._descriptorSet),r.bindInputAssembler(f),r.draw(f)),this._renderQueues.forEach(rB);for(var m=0,p=0,v=0,y=0;y<a.length;++y){var g=a[y],S=g.model.subModels;for(m=0;m<S.length;++m){var A=S[m].passes;for(p=0;p<A.length;++p)if(A[p].phase===this._phaseID)for(v=0;v<this._renderQueues.length;v++)this._renderQueues[v].insertRenderPass(g,m,p)}}if(a.length>0){this._renderQueues.forEach(sB);for(var T=0;T<this._renderQueues.length;T++)this._renderQueues[T].recordCommandBuffer(n,_,r);this._planarQueue.recordCommandBuffer(n,_,r)}null===(t=e.geometryRenderer)||void 0===t||t.render(_,r,i.pipelineSceneData),this._uiPhase.render(e,_),r.endRenderPass()}}]),i}(rk),YP.initInfo={name:"LightingStage",priority:pk.LIGHTING,tag:0},jP=Ms((XP=KP).prototype,"_deferredMaterial",[HP,Js],(function(){return null})),qP=Ms(XP.prototype,"renderQueues",[zP,Js],(function(){return[]})),WP=XP))||WP)),mM=[new Dc(0,0,0,1)],pM=e("PostProcessStage",(QP=Hs("PostProcessStage"),JP=Aa(dA),ZP=Aa([$I]),QP((rM=nM=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._postProcessMaterial=tM&&tM(),e.renderQueues=iM&&iM(),e._renderArea=new xc,e._stageDesc=void 0,e._localUBO=void 0,e._uiPhase=new MB,e}return s(i,[{key:"initialize",value:function(e){return g(l(i.prototype),"initialize",this).call(this,e),!0}},{key:"activate",value:function(e,t){g(l(i.prototype),"activate",this).call(this,e,t),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){var t=this._pipeline,i=t.device,n=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var s=e.viewport;this._renderArea.x=s.x*e.window.width,this._renderArea.y=s.y*e.window.height,this._renderArea.width=s.width*e.window.width,this._renderArea.height=s.height*e.window.height;var a=t.getPipelineRenderData(),o=e.window.framebuffer,u=t.getRenderPass(e.clearFlag,o);e.clearFlag&yc.COLOR&&(mM[0].x=e.clearColor.x,mM[0].y=e.clearColor.y,mM[0].z=e.clearColor.z),mM[0].w=e.clearColor.w,r.beginRenderPass(u,o,this._renderArea,mM,e.clearDepth,e.clearStencil),r.bindDescriptorSet(_v.GLOBAL,t.descriptorSet);var h=n.postprocessMaterial.passes[0],l=h.getShaderVariant();t.bloomEnabled?h.descriptorSet.bindTexture(0,a.bloom.combineTex):h.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),h.descriptorSet.bindSampler(0,a.sampler),h.descriptorSet.update();var c=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=h&&null!=l&&null!=c&&(_=JS.getOrCreatePipelineState(i,h,l,u,c));var f=t.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(this._stageDesc||(this._stageDesc=i.createDescriptorSet(new p_(h.localSetLayout)),this._localUBO=i.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.DEVICE,Mv.SIZE,Mv.SIZE)),this._stageDesc.bindBuffer(Mv.BINDING,this._localUBO)),this._stageDesc.update(),r.bindPipelineState(_),r.bindDescriptorSet(_v.MATERIAL,h.descriptorSet),r.bindDescriptorSet(_v.LOCAL,this._stageDesc),r.bindInputAssembler(c),r.draw(c)),this._uiPhase.render(e,u),_A(i,u,r,t.profiler,e),r.endRenderPass()}}]),i}(rk),nM.initInfo={name:"PostProcessStage",priority:fk.POST_PROCESS,tag:0},tM=Ms((eM=rM).prototype,"_postProcessMaterial",[JP,Js],(function(){return null})),iM=Ms(eM.prototype,"renderQueues",[ZP,Js],(function(){return[]})),$P=eM))||$P));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(sM||(sM={}));var vM,yM,gM,SM,AM,TM,EM,bM=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._antiAliasing=sM.NONE,e}return s(i,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var i=new dA;i.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var n=0;n<i.passes.length;++n)i.passes[n].tryCompile();this._postprocessMaterial=i}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"updatePipelineSceneData",value:function(){this.updatePipelinePassInfo()}},{key:"updateBloomPass",value:function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=0;t<6;++t){var i=this._bloomMaterial.passes[1+t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently();var n=this._bloomMaterial.passes[7+t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}var r=this._bloomMaterial.passes[13];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}}},{key:"updatePostProcessPass",value:function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}}},{key:"initPipelinePassInfo",value:function(){var e=new dA;e._uuid="builtin-deferred-material",e.initialize({effectName:"pipeline/deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var i=new dA;i._uuid="builtin-bloom-material",i.initialize({effectName:"pipeline/bloom"});for(var n=0;n<i.passes.length;++n)i.passes[n].tryCompile();this._bloomMaterial=i;var r=new dA;r._uuid="builtin-post-process-material",Lt.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=sM.FXAA),r.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var s=0;s<r.passes.length;++s)r.passes[s].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}},{key:"updatePipelinePassInfo",value:function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()}},{key:"activate",value:function(e){return g(l(i.prototype),"activate",this).call(this,e),this.initPipelinePassInfo(),!0}},{key:"updateDeferredPassInfo",value:function(){this.updateDeferredLightPass()}},{key:"updateDeferredLightPass",value:function(){if(this._deferredLightingMaterial){B.director.root.pipeline.macros.CC_RECEIVE_SHADOW=1;var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}}}]),i}(pP),CM=[new Dc(0,0,0,1)],RM=function e(){n(this,e)};RM.SIZE=4*(RM.COUNT=4+(RM.TEXTURE_SIZE_OFFSET=0));var xM,wM,kM,IM,BM,PM,MM,OM,DM,LM,NM,FM,GM,VM=e("BloomStage",(vM=Hs("BloomStage"),yM=Aa(dA),vM((EM=TM=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this)).threshold=1,e.intensity=.8,e.iterations=2,e._bloomMaterial=AM&&AM(),e._renderArea=new xc,e._bloomUBO=[],e}return s(i,[{key:"initialize",value:function(e){return g(l(i.prototype),"initialize",this).call(this,e),!0}},{key:"activate",value:function(e,t){g(l(i.prototype),"activate",this).call(this,e,t),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){var t,i=this._pipeline;if(i.generateBloomRenderData(),(null!==(t=e.window)&&void 0!==t&&t.swapchain||i.macros.CC_PIPELINE_TYPE)&&i.bloomEnabled&&0!==i.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var n=0;n<14;++n)this._bloomUBO[n]=i.device.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,RM.SIZE,RM.SIZE));e.clearFlag&yc.COLOR&&(CM[0].x=e.clearColor.x,CM[0].y=e.clearColor.y,CM[0].z=e.clearColor.z),CM[0].w=e.clearColor.w,this._prefilterPass(e,i),this._downsamplePass(e,i),this._upsamplePass(e,i),this._combinePass(e,i)}}},{key:"_prefilterPass",value:function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var i=t.commandBuffers[0],n=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),s=r.bloom,a=new Float32Array(RM.COUNT);a[RM.TEXTURE_SIZE_OFFSET+2]=this.threshold,i.updateBuffer(this._bloomUBO[0],a),i.beginRenderPass(s.renderPass,s.prefilterFramebuffer,this._renderArea,CM,0,0),i.bindDescriptorSet(_v.GLOBAL,t.descriptorSet),n.descriptorSet.bindBuffer(0,this._bloomUBO[0]),n.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),n.descriptorSet.bindSampler(1,s.sampler),n.descriptorSet.update(),i.bindDescriptorSet(_v.MATERIAL,n.descriptorSet);var o=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null,h=n.getShaderVariant();null!=n&&null!=h&&null!=o&&(u=JS.getOrCreatePipelineState(t.device,n,h,s.renderPass,o)),null!=u&&(i.bindPipelineState(u),i.bindInputAssembler(o),i.draw(o)),i.endRenderPass()}},{key:"_downsamplePass",value:function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var i=t.commandBuffers[0],n=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,s=new Float32Array(RM.COUNT),a=0;a<this.iterations;++a){s[RM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[RM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[a+1],s),this._renderArea.width>>=1,this._renderArea.height>>=1,i.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,CM,0,0);var o=n.passes[1+a],u=o.getShaderVariant();o.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?o.descriptorSet.bindTexture(1,r.prefiterTex):o.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),o.descriptorSet.bindSampler(1,r.sampler),o.descriptorSet.update(),i.bindDescriptorSet(_v.MATERIAL,o.descriptorSet);var h=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null;null!=o&&null!=u&&null!=h&&(l=JS.getOrCreatePipelineState(t.device,o,u,r.renderPass,h)),null!=l&&(i.bindPipelineState(l),i.bindInputAssembler(h),i.draw(h)),i.endRenderPass()}}},{key:"_upsamplePass",value:function(e,t){var i=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var n=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,s=new Float32Array(RM.COUNT),a=0;a<this.iterations;++a){var o=a+6+1;s[RM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[RM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[o],s),this._renderArea.width<<=1,this._renderArea.height<<=1,n.beginRenderPass(i.renderPass,i.upsampleFramebuffers[this.iterations-1-a],this._renderArea,CM,0,0);var u=r.passes[7+a],h=u.getShaderVariant();u.descriptorSet.bindBuffer(0,this._bloomUBO[o]),0===a?u.descriptorSet.bindTexture(1,i.downsampleTexs[this.iterations-1]):u.descriptorSet.bindTexture(1,i.upsampleTexs[this.iterations-a]),u.descriptorSet.bindSampler(1,i.sampler),u.descriptorSet.update(),n.bindDescriptorSet(_v.MATERIAL,u.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null;null!=u&&null!=h&&null!=l&&(c=JS.getOrCreatePipelineState(t.device,u,h,i.renderPass,l)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}}},{key:"_combinePass",value:function(e,t){t.generateRenderArea(e,this._renderArea);var i=t.commandBuffers[0],n=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),s=r.bloom,a=new Float32Array(RM.COUNT);a[RM.TEXTURE_SIZE_OFFSET+3]=this.intensity,i.updateBuffer(this._bloomUBO[13],a),i.beginRenderPass(s.renderPass,s.combineFramebuffer,this._renderArea,CM,0,0),i.bindDescriptorSet(_v.GLOBAL,t.descriptorSet);var o=n.passes[13];o.descriptorSet.bindBuffer(0,this._bloomUBO[13]),o.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),o.descriptorSet.bindTexture(2,s.upsampleTexs[0]),o.descriptorSet.bindSampler(1,s.sampler),o.descriptorSet.bindSampler(2,s.sampler),o.descriptorSet.update(),i.bindDescriptorSet(_v.MATERIAL,o.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null,l=o.getShaderVariant();null!=o&&null!=l&&null!=u&&(h=JS.getOrCreatePipelineState(t.device,o,l,s.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}}]),i}(rk),TM.initInfo={name:"BloomStage",priority:fk.BLOOM,tag:0},AM=Ms((SM=EM).prototype,"_bloomMaterial",[yM,Js],(function(){return null})),gM=SM))||gM)),UM=e("MainFlow",Hs("MainFlow")((kM=wM=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"initialize",value:function(e){if(g(l(i.prototype),"initialize",this).call(this,e),0===this._stages.length){var t=new _M;t.initialize(_M.initInfo),this._stages.push(t);var n=new dM;n.initialize(dM.initInfo),this._stages.push(n);var r=new VM;r.initialize(VM.initInfo),this._stages.push(r);var s=new pM;s.initialize(pM.initInfo),this._stages.push(s)}return!0}},{key:"activate",value:function(e){g(l(i.prototype),"activate",this).call(this,e)}},{key:"render",value:function(e){g(l(i.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){g(l(i.prototype),"destroy",this).call(this)}}]),i}(ak),wM.initInfo={name:nv,priority:vk.MAIN,stages:[]},xM=kM))||xM),HM=function(){h(t,(function e(){n(this,e),this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null}));var e=v(t);function t(){var i;n(this,t);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(i=e.call.apply(e,[this].concat(s))).gbufferFrameBuffer=null,i.gbufferRenderTargets=[],i}return t}(),zM=e("DeferredPipeline",(IM=Hs("DeferredPipeline"),BM=Aa([QI]),IM((MM=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gbufferRenderPass=null,e._lightingRenderPass=null,e.renderTextures=OM&&OM(),e}return s(i,[{key:"initialize",value:function(e){if(g(l(i.prototype),"initialize",this).call(this,e),0===this._flows.length){var t=new KB;t.initialize(KB.initInfo),this._flows.push(t);var n=new UM;n.initialize(UM.initInfo),this._flows.push(n)}return!0}},{key:"activate",value:function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new bM,!(!g(l(i.prototype),"activate",this).call(this,e)||!this._activeRenderer(e)&&(ue(2402),1))}},{key:"destroy",value:function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();return this._commandBuffers.length=0,g(l(i.prototype),"destroy",this).call(this)}},{key:"onGlobalPipelineStateChanged",value:function(){this.pipelineSceneData.updatePipelineSceneData()}},{key:"getPipelineRenderData",value:function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData}},{key:"_activeRenderer",value:function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var i=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Av,i),this._descriptorSet.bindTexture(Av,HS.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Iv,i),this._descriptorSet.bindTexture(Iv,HS.get("default-texture").getGFXTexture()),this._descriptorSet.update();var n=new qI;if(!(n=this._createQuadInputAssembler()).quadIB||!n.quadVB||!n.quadIA)return!1;this._quadIB=n.quadIB,this._quadVBOffscreen=n.quadVB,this._quadIAOffscreen=n.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var s=new s_;s.format=Ll.RGBA16F,s.loadOp=nc.CLEAR,s.storeOp=rc.STORE;var a=new s_;a.format=Ll.RGBA16F,a.loadOp=nc.CLEAR,a.storeOp=rc.STORE;var o=new s_;o.format=Ll.RGBA16F,o.loadOp=nc.CLEAR,o.storeOp=rc.STORE;var u=new a_;u.format=Ll.DEPTH_STENCIL,u.depthLoadOp=nc.CLEAR,u.depthStoreOp=rc.STORE,u.stencilLoadOp=nc.CLEAR,u.stencilStoreOp=rc.STORE;var h=new h_([s,a,o],u);this._gbufferRenderPass=t.createRenderPass(h)}if(!this._lightingRenderPass){var l=new s_;l.format=Ll.RGBA8,l.loadOp=nc.CLEAR,l.storeOp=rc.STORE,l.barrier=t.getGeneralBarrier(new l_(sc.NONE,sc.COLOR_ATTACHMENT_WRITE));var c=new a_;c.format=Ll.DEPTH_STENCIL,c.depthLoadOp=nc.LOAD,c.depthStoreOp=rc.DISCARD,c.stencilLoadOp=nc.LOAD,c.stencilStoreOp=rc.DISCARD,l.barrier=t.getGeneralBarrier(new l_(sc.DEPTH_STENCIL_ATTACHMENT_WRITE,sc.DEPTH_STENCIL_ATTACHMENT_WRITE));var _=new h_([l],c);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0}},{key:"_destroyUBOs",value:function(){this._descriptorSet&&(this._descriptorSet.getBuffer(vv.BINDING).destroy(),this._descriptorSet.getBuffer(gv.BINDING).destroy(),this._descriptorSet.getBuffer(yv.BINDING).destroy(),this._descriptorSet.getTexture(Av).destroy(),this._descriptorSet.getTexture(Iv).destroy())}},{key:"_destroyDeferredData",value:function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var i=0;i<e.outputRenderTargets.length;i++)e.outputRenderTargets[i].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null}},{key:"_ensureEnoughSize",value:function(e){for(var t=this._width,i=this._height,n=0;n<e.length;++n){var r=e[n].window;t=Math.max(r.width,t),i=Math.max(r.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i,this._destroyDeferredData(),this._generateDeferredRenderData())}},{key:"_generateDeferredRenderData",value:function(){for(var e=this,t=this.device,i=this._pipelineRenderData=new HM,n=this.pipelineSceneData,r=0;r<3;++r)i.gbufferRenderTargets.push(t.createTexture(new Wc(zl.TEX2D,Wl.COLOR_ATTACHMENT|Wl.SAMPLED,Ll.RGBA16F,this._width*n.shadingScale,this._height*n.shadingScale)));i.outputDepth=t.createTexture(new Wc(zl.TEX2D,Wl.DEPTH_STENCIL_ATTACHMENT|Wl.SAMPLED,Ll.DEPTH_STENCIL,this._width*n.shadingScale,this._height*n.shadingScale)),i.gbufferFrameBuffer=t.createFramebuffer(new f_(this._gbufferRenderPass,i.gbufferRenderTargets,i.outputDepth)),i.outputRenderTargets.push(t.createTexture(new Wc(zl.TEX2D,Wl.COLOR_ATTACHMENT|Wl.SAMPLED,Ll.RGBA16F,this._width*n.shadingScale,this._height*n.shadingScale))),i.outputFrameBuffer=t.createFramebuffer(new f_(this._lightingRenderPass,i.outputRenderTargets,null)),i.sampler=this.globalDSManager.pointSampler,this.on(sk.ATTACHMENT_SCALE_CAHNGED,(function(t){i.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,i.gbufferFrameBuffer=e.newFramebufferByRatio(i.gbufferFrameBuffer),i.gbufferFrameBuffer=e.newFramebufferByRatio(i.outputFrameBuffer)}))}}]),i}(YI),OM=Ms(MM.prototype,"renderTextures",[BM,Js],(function(){return[]})),PM=MM))||PM)),WM=function(){function e(){n(this,e),this._arrayBufferOrPaddings=[],this._length=0}return s(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(i){"number"==typeof i?t+=i:(e.set(new Uint8Array(i),t),t+=i.byteLength)})),e.buffer}}]),e}(),XM=function(){function e(t,i){if(n(this,e),this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var r=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(r).fill(null);for(var s=0;s<r;++s){var a=this._mesh.struct.morph.subMeshMorphs[s];a&&(a.targets.length>Wv.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[s]=new qM(this._mesh,s,this._mesh.struct.morph,i):this._subMeshRenderings[s]=new jM(this._mesh,s,this._mesh.struct.morph,i))}}}return s(e,[{key:"createInstance",value:function(){for(var e=this,t=this._mesh.struct.primitives.length,i=new Array(t),n=0;n<t;++n){var r,s;i[n]=null!==(r=null===(s=this._subMeshRenderings[n])||void 0===s?void 0:s.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var n;null===(n=i[e])||void 0===n||n.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var n=e._mesh.struct.morph.subMeshMorphs[t],r=i[t];if(null===r)return null;var s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:n.targets.length}];return n.attributes.includes(Tc.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),n.attributes.includes(Tc.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),n.attributes.includes(Tc.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push.apply(s,E(r.requiredPatches())),s},adaptPipelineState:function(e,t){var n;null===(n=i[e])||void 0===n||n.adaptPipelineState(t)},destroy:function(){for(var e,t=R(i);!(e=t()).done;){var n=e.value;null==n||n.destroy()}}}}}]),e}(),jM=function(){function e(t,i,r,s){n(this,e),this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=s;var a=r.subMeshMorphs[i];this._subMeshMorph=a,JM(t,i,s);var o=t.struct.vertexBundles[t.struct.primitives[i].vertexBundelIndices[0]].view.count;this._verticesCount=o;var u=a.targets.length,h=QM(s,o*u);this._textureInfo={width:h.width,height:h.height},this._attributes=a.attributes.map((function(e,i){var n=h.create(),r=n.valueView;return a.targets.forEach((function(e,n){for(var s=e.displacements[i],a=new Float32Array(t.data.buffer,t.data.byteOffset+s.offset,s.count),u=o*n*4,h=0;h<o;++h)r[u+4*h+0]=a[3*h+0],r[u+4*h+1]=a[3*h+1],r[u+4*h+2]=a[3*h+2]})),n.updatePixels(),{name:e,morphTexture:n}}))}return s(e,[{key:"destroy",value:function(){for(var e,t=R(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()}},{key:"createInstance",value:function(){var e=this,t=new KM(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(i){for(var n,r=R(e._attributes);!(n=r()).done;){var s=n.value,a=void 0;switch(s.name){case Tc.ATTR_POSITION:a=$v;break;case Tc.ATTR_NORMAL:a=iy;break;case Tc.ATTR_TANGENT:a=sy;break;default:Q("Unexpected attribute!")}void 0!==a&&(i.bindSampler(a,s.morphTexture.sampler),i.bindTexture(a,s.morphTexture.texture))}i.bindBuffer(Wv.BINDING,t.buffer),i.update()},destroy:function(){}}}}]),e}(),qM=function(){function e(t,i,r,s){n(this,e),this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=s;var a=r.subMeshMorphs[i];JM(t,i,s),this._attributes=a.attributes.map((function(e,i){return{name:e,targets:a.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[i].offset,e.displacements[i].count)}}))}}))}return s(e,[{key:"data",get:function(){return this._attributes}},{key:"createInstance",value:function(){return new YM(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)}}]),e}(),YM=function(){function e(t,i,r){n(this,e),this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new KM(r,0);var s=QM(r,i);this._morphUniforms.setMorphTextureInfo(s.width,s.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=s.create();return{attributeName:e.name,morphTexture:t}}))}return s(e,[{key:"setWeights",value:function(e){for(var t=0;t<this._attributes.length;++t){var i=this._attributes[t],n=i.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var s=0;s<r.targets.length;++s){var a=r.targets[s].displacements,o=e[s],u=a.length/3;if(0===s)for(var h=0;h<u;++h)n[4*h+0]=a[3*h+0]*o,n[4*h+1]=a[3*h+1]*o,n[4*h+2]=a[3*h+2]*o;else if(0!==o)for(var l=0;l<u;++l)n[4*l+0]+=a[3*l+0]*o,n[4*l+1]+=a[3*l+1]*o,n[4*l+2]+=a[3*l+2]*o}i.morphTexture.updatePixels()}}},{key:"requiredPatches",value:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]}},{key:"adaptPipelineState",value:function(e){for(var t,i=R(this._attributes);!(t=i()).done;){var n=t.value,r=void 0;switch(n.attributeName){case Tc.ATTR_POSITION:r=$v;break;case Tc.ATTR_NORMAL:r=iy;break;case Tc.ATTR_TANGENT:r=sy;break;default:Q("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,n.morphTexture.sampler),e.bindTexture(r,n.morphTexture.texture))}e.bindBuffer(Wv.BINDING,this._morphUniforms.buffer),e.update()}},{key:"destroy",value:function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()}}]),e}(),KM=function(){function e(t,i){n(this,e),this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=i,this._localBuffer=new DataView(new ArrayBuffer(Wv.SIZE)),this._remoteBuffer=t.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,Wv.SIZE,Wv.SIZE))}return s(e,[{key:"destroy",value:function(){this._remoteBuffer.destroy()}},{key:"buffer",get:function(){return this._remoteBuffer}},{key:"setWeights",value:function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Wv.OFFSET_OF_WEIGHTS+4*t,e[t],B.sys.isLittleEndian)}},{key:"setMorphTextureInfo",value:function(e,t){this._localBuffer.setFloat32(Wv.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,B.sys.isLittleEndian),this._localBuffer.setFloat32(Wv.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,B.sys.isLittleEndian)}},{key:"setVerticesCount",value:function(e){this._localBuffer.setFloat32(Wv.OFFSET_OF_VERTICES_COUNT,e,B.sys.isLittleEndian)}},{key:"commit",value:function(){this._remoteBuffer.update(this._localBuffer.buffer)}}]),e}();function QM(e,t){var i,n,r,s;e.getFormatFeatures(Ll.RGBA32F)&jl.SAMPLED_TEXTURE?(i=t,r=16,n=Qm.PixelFormat.RGBA32F,s=Float32Array):(i=4*t,r=4,n=Qm.PixelFormat.RGBA8888,s=Uint8Array);var a=function(e){e<5&&(e=5);var t=O(qi(e)),i=t>>1;return{width:1<<(1&t?i+1:i),height:1<<i}}(i),o=a.width,u=a.height;return{width:o,height:u,create:function(){var t=new ArrayBuffer(o*u*r),i=new Float32Array(t),a=s===Float32Array?i:new s(t),h=new bd({width:o,height:u,_data:a,_compressed:!1,format:n}),l=new Qm;l.setFilters(Qm.Filter.NEAREST,Qm.Filter.NEAREST),l.setMipFilter(Qm.Filter.NONE),l.setWrapMode(Qm.WrapMode.CLAMP_TO_EDGE,Qm.WrapMode.CLAMP_TO_EDGE,Qm.WrapMode.CLAMP_TO_EDGE),l.image=h,l.getGFXTexture()||Q("Unexpected: failed to create morph texture?");var c=e.getSampler(l.getSamplerInfo());return{get texture(){return l.getGFXTexture()},get sampler(){return c},get valueView(){return i},destroy:function(){l.destroy()},updatePixels:function(){l.uploadData(a)}}}}}function JM(e,t,i){e.renderingSubMeshes[t].enableVertexIdChannel(i)}function ZM(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var $M=new an,eO=new an,tO=new Uint8Array,iO=Hs("cc.Mesh")((LM=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this)).morphRendering=null,e._struct=NM&&NM(),e._hash=FM&&FM(),e._data=tO,e._initialized=!1,e._allowDataAccess=GM&&GM(),e._isMeshDataUploaded=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}return s(i,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=bl(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}},{key:"onLoaded",value:function(){this.initialize()}},{key:"initialize",value:function(){var e=this;if(!this._initialized)if(this._initialized=!0,this._struct.dynamic){for(var t=yf.gfxDevice,i=[],n=[],r=0;r<this._struct.vertexBundles.length;r++){var s=this._struct.vertexBundles[r],a=t.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE,s.view.length,s.view.stride));i.push(a)}for(var o=0;o<this._struct.primitives.length;o++){var u=this._struct.primitives[o],h=u.indexView,l=null;h&&(l=t.createBuffer(new Gc(Gl.INDEX|Gl.TRANSFER_DST,Hl.DEVICE,h.length,h.stride)));for(var c=[],_=0;_<u.vertexBundelIndices.length;_++){var f=u.vertexBundelIndices[_];c.push(i[f])}for(var d=[],m=0;m<u.vertexBundelIndices.length;m++)for(var p,v=u.vertexBundelIndices[m],y=R(this._struct.vertexBundles[v].attributes);!(p=y()).done;){var g=p.value,S=new i_;S.copy(g),d.push(S)}var A=new _w(c,d,u.primitiveMode,l);A.drawInfo=new Uc,A.mesh=this,A.subMeshIdx=o,n.push(A)}this._renderingSubMeshes=n}else!function(){for(var t=e._data.buffer,i=yf.gfxDevice,n=e._createVertexBuffers(i,t),r=[],s=0;s<e._struct.primitives.length;s++){var a=e._struct.primitives[s];if(0!==a.vertexBundelIndices.length){var o=null,u=null;if(a.indexView){var h=a.indexView,l=h.stride,c=h.length;if(4===l&&!i.hasFeature(Dl.ELEMENT_INDEX_UINT)){var _=e._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(_>=65536){ae(10001,_,65536);continue}l>>=1,c>>=1}o=i.createBuffer(new Gc(Gl.INDEX,Hl.DEVICE,c,l)),u=new(ZM(h.stride))(t,h.offset,h.count),h.stride!==l&&(u=ZM(l).from(u)),o.update(u)}var f=a.vertexBundelIndices.map((function(e){return n[e]})),d=[];if(a.vertexBundelIndices.length>0)for(var m=a.vertexBundelIndices[0],p=e._struct.vertexBundles[m].attributes,v=0;v<p.length;++v){var y=p[v];d[v]=new i_(y.name,y.format,y.isNormalized,y.stream,y.isInstanced,y.location)}var g=new _w(f,d,a.primitiveMode,o);g.mesh=e,g.subMeshIdx=s,r.push(g)}}e._renderingSubMeshes=r,e._struct.morph&&(e.morphRendering=function(e,t){return new XM(e,t)}(e,i)),e._isMeshDataUploaded=!0,e._allowDataAccess||e.releaseData()}()}},{key:"updateSubMesh",value:function(e,t){if(this._struct.dynamic)if(e>=this._struct.primitives.length)ae(14201);else{var i=[];if(t.positions.length>0&&i.push(t.positions),t.normals&&t.normals.length>0&&i.push(t.normals),t.uvs&&t.uvs.length>0&&i.push(t.uvs),t.tangents&&t.tangents.length>0&&i.push(t.tangents),t.colors&&t.colors.length>0&&i.push(t.colors),t.customAttributes)for(var n=0;n<t.customAttributes.length;n++)i.push(t.customAttributes[n].values);for(var r=this._struct.dynamic,s=r.info,a=this._struct.primitives[e],o=this._renderingSubMeshes[e],u=o.drawInfo,h=0;h<i.length;h++){var l=i[h],c=this._struct.vertexBundles[a.vertexBundelIndices[h]],_=c.view.stride,f=l.byteLength/_,d=l.byteLength,m=new Uint8Array(this._data.buffer,c.view.offset,d),p=new Uint8Array(l.buffer,l.byteOffset,d),v=o.vertexBuffers[h];s.maxSubMeshVertices,d>0&&(m.set(p),v.update(p,d)),c.view.count=f,u.vertexCount=f}if(a.indexView){var y=a.indexView,g=y.stride,S=2===g?t.indices16.length:t.indices32.length,A=S*g,T=new Uint8Array(this._data.buffer,y.offset,A),E=2===g?new Uint8Array(t.indices16.buffer,t.indices16.byteOffset,A):new Uint8Array(t.indices32.buffer,t.indices32.byteOffset,A),b=o.indexBuffer;s.maxSubMeshIndices,A>0&&(T.set(E),b.update(E,A)),y.count=S,u.indexCount=S}if(t.minPos&&t.maxPos){var C=new an(t.minPos.x,t.minPos.y,t.minPos.z),x=new an(t.maxPos.x,t.maxPos.y,t.maxPos.z);r.bounds[e]||(r.bounds[e]=new ms),ms.fromPoints(r.bounds[e],C,x);for(var w,k=new an,I=new an,B=R(r.bounds);!(w=B()).done;){var P=w.value;P&&(P.getBoundary(k,I),an.min(C,k,C),an.max(x,I,x))}this._struct.minPosition=new an(C.x,C.y,C.z),this._struct.maxPosition=new an(x.x,x.y,x.z)}o.invalidateGeometricInfo()}else ae(14200)}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),g(l(i.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1,this._isMeshDataUploaded=!1}}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0}},{key:"getBoneSpaceBounds",value:function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var i=[],n=e.bindposes,r=0;r<n.length;r++)t.push(new ms(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);for(var s=this._struct.primitives,a=0;a<s.length;a++){var o=this.readAttribute(a,Tc.ATTR_JOINTS),u=this.readAttribute(a,Tc.ATTR_WEIGHTS),h=this.readAttribute(a,Tc.ATTR_POSITION);if(o&&u&&h)for(var l=Math.min(o.length/4,u.length/4,h.length/3),c=0;c<l;c++){an.set($M,h[3*c+0],h[3*c+1],h[3*c+2]);for(var _=0;_<4;++_){var f=4*c+_,d=o[f];if(!(0===u[f]||d>=n.length)){an.transformMat4(eO,$M,n[d]),i[d]=!0;var m=t[d];an.min(m.center,m.center,eO),an.max(m.halfExtents,m.halfExtents,eO)}}}}for(var p=0;p<n.length;p++){var v=t[p];i[p]?ms.fromPoints(v,v.center,v.halfExtents):t[p]=null}return t}},{key:"merge",value:function(e,t,i){if(i&&!this.validateMergingMesh(e))return!1;var n=new an,r=t&&new vn,s=t&&new ms;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),o=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(an.add(s.center,a.maxPosition,a.minPosition),an.multiplyScalar(s.center,s.center,.5),an.subtract(s.halfExtents,a.maxPosition,a.minPosition),an.multiplyScalar(s.halfExtents,s.halfExtents,.5),ms.transform(s,s,t),an.add(a.maxPosition,s.center,s.halfExtents),an.subtract(a.minPosition,s.center,s.halfExtents));for(var u=0;u<a.vertexBundles.length;u++)for(var h=a.vertexBundles[u],l=0;l<h.attributes.length;l++)if(h.attributes[l].name===Tc.ATTR_POSITION||h.attributes[l].name===Tc.ATTR_NORMAL){var c=h.attributes[l].format,_=new DataView(o.buffer,h.view.offset+nO(h.attributes,l)),f=aO(_,c),d=oO(_,c);if(!f||!d)continue;for(var m=h.view.count,p=h.view.stride,v=sO(c),y=0;y<m;y++){var g=y*p,S=g+v,A=S+v;switch(n.set(f(g),f(S),f(A)),h.attributes[l].name){case Tc.ATTR_POSITION:n.transformMat4(t);break;case Tc.ATTR_NORMAL:an.transformQuat(n,n,r)}d(g,n.x),d(S,n.y),d(A,n.z)}}}return this.reset({struct:a,data:o}),this.initialize(),!0}for(var T,E,b,C,x,w=new WM,k=0,I=0,B=0,P=0,M=0,O=0,D=0,L=0,N=!1,F=new Array(this._struct.vertexBundles.length),G=0;G<this._struct.vertexBundles.length;++G){var V=this._struct.vertexBundles[G],U=e._struct.vertexBundles[G];B=V.view.offset,P=U.view.offset,I=V.view.stride,k=V.view.count+U.view.count,T=new ArrayBuffer(k*I),E=new Uint8Array(T),B+=(b=this._data.subarray(B,B+V.view.length)).length,P+=(C=e._data.subarray(P,P+U.view.length)).length,E.set(b),M=0;for(var H,z=R(V.attributes);!(H=z()).done;){var W=H.value;D=0,N=!1;for(var X,j=R(U.attributes);!(X=j()).done;){var q=X.value;if(W.name===q.name&&W.format===q.format){N=!0;break}D+=x_[q.format].size}if(N){L=x_[W.format].size,O=V.view.length+M;for(var Y=0;Y<U.view.count;++Y){if(x=C.subarray(D,D+L),E.set(x,O),(W.name===Tc.ATTR_POSITION||W.name===Tc.ATTR_NORMAL)&&t){var K=new Float32Array(E.buffer,O,3);switch(n.set(K[0],K[1],K[2]),W.name){case Tc.ATTR_POSITION:n.transformMat4(t);break;case Tc.ATTR_NORMAL:an.transformQuat(n,n,r)}K[0]=n.x,K[1]=n.y,K[2]=n.z}O+=V.view.stride,D+=U.view.stride}}M+=x_[W.format].size}F[G]={attributes:V.attributes,view:{offset:w.getLength(),length:T.byteLength,count:k,stride:I}},w.addBuffer(T)}for(var Q,J,Z,$=0,ee=2,te=new Array(this._struct.primitives.length),ie=0;ie<this._struct.primitives.length;++ie){var ne=this._struct.primitives[ie],re=e._struct.primitives[ie];te[ie]={primitiveMode:ne.primitiveMode,vertexBundelIndices:ne.vertexBundelIndices};for(var se,ae=0,oe=R(ne.vertexBundelIndices);!(se=oe()).done;){var ue=se.value;ae=Math.max(ae,this._struct.vertexBundles[ue].view.count)}if(ne.indexView&&re.indexView){$=ne.indexView.count,$+=re.indexView.count,B=ne.indexView.offset,P=re.indexView.offset,ee=$<256?1:$<65536?2:4;var he=new ArrayBuffer($*ee);if(Q=2===ee?new Uint16Array(he):1===ee?new Uint8Array(he):new Uint32Array(he),J=2===ne.indexView.stride?new Uint16Array(this._data.buffer,B,ne.indexView.count):1===ne.indexView.stride?new Uint8Array(this._data.buffer,B,ne.indexView.count):new Uint32Array(this._data.buffer,B,ne.indexView.count),ee===ne.indexView.stride)Q.set(J);else for(var le=0;le<ne.indexView.count;++le)Q[le]=J[le];B+=ne.indexView.length,Z=2===re.indexView.stride?new Uint16Array(e._data.buffer,P,re.indexView.count):1===re.indexView.stride?new Uint8Array(e._data.buffer,P,re.indexView.count):new Uint32Array(e._data.buffer,P,re.indexView.count);for(var ce=0;ce<re.indexView.count;++ce)Q[ne.indexView.count+ce]=ae+Z[ce];P+=re.indexView.length,te[ie].indexView={offset:w.getLength(),length:he.byteLength,count:$,stride:ee},w.setNextAlignment(ee),w.addBuffer(he)}}var _e={vertexBundles:F,primitives:te,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _e.minPosition&&e._struct.minPosition&&_e.maxPosition&&e._struct.maxPosition&&(t?(an.add(s.center,e._struct.maxPosition,e._struct.minPosition),an.multiplyScalar(s.center,s.center,.5),an.subtract(s.halfExtents,e._struct.maxPosition,e._struct.minPosition),an.multiplyScalar(s.halfExtents,s.halfExtents,.5),ms.transform(s,s,t),an.add(n,s.center,s.halfExtents),an.max(_e.maxPosition,_e.maxPosition,n),an.subtract(n,s.center,s.halfExtents),an.min(_e.minPosition,_e.minPosition,n)):(an.min(_e.minPosition,_e.minPosition,e._struct.minPosition),an.max(_e.maxPosition,_e.maxPosition,e._struct.maxPosition))),this.reset({struct:_e,data:new Uint8Array(w.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(this._struct.dynamic||e._struct.dynamic)return!1;if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var s=0;s<this._struct.primitives.length;++s){var a=this._struct.primitives[s],o=e._struct.primitives[s];if(a.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var u=0;u<a.vertexBundelIndices.length;++u)if(a.vertexBundelIndices[u]!==o.vertexBundelIndices[u])return!1;if(a.primitiveMode!==o.primitiveMode)return!1;if(a.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var i=this,n=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,s=e.attributes[t].format,a=L_(x_[s]);if(0!==r){var o=new DataView(i._data.buffer,e.view.offset+nO(e.attributes,t)),u=x_[s],h=aO(o,s);if(a&&h){for(var l=u.count,c=new a(r*l),_=e.view.stride,f=0;f<r;++f)for(var d=0;d<l;++d)c[l*f+d]=h(_*f+c.BYTES_PER_ELEMENT*d);n=c}}})),n}},{key:"copyAttribute",value:function(e,t,i,n,r){var s=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var o=e.view.count;if(0!==o){var u=e.attributes[t].format,h=new DataView(s._data.buffer,e.view.offset+nO(e.attributes,t)),l=new DataView(i,r),c=x_[u],_=aO(h,u),f=oO(l,u);if(_&&f){for(var d=c.count,m=e.view.stride,p=sO(u),v=n,y=p,g=0;g<o;++g)for(var S=0;S<d;++S)f(v*g+y*S,_(m*g+p*S));a=!0}}else a=!0})),a}},{key:"readIndices",value:function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var i=t.indexView.stride;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)}},{key:"copyIndices",value:function(e,t){if(e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?Ll.R8UI:2===i.indexView.stride?Ll.R16UI:Ll.R32UI,s=aO(new DataView(this._data.buffer),r),a=0;a<n;++a)t[a]=s(i.indexView.offset+x_[r].size*a);return!0}},{key:"readAttributeFormat",value:function(e,t){var i=null;return this._accessAttribute(e,t,(function(e,t){var n=e.attributes[t].format;i=x_[n]})),i}},{key:"_accessAttribute",value:function(e,t,i){if(!(e>=this._struct.primitives.length))for(var n,r=R(this._struct.primitives[e].vertexBundelIndices);!(n=r()).done;){var s=n.value,a=this._struct.vertexBundles[s],o=a.attributes.findIndex((function(e){return e.name===t}));if(!(o<0)){i(a,o);break}}}},{key:"_createVertexBuffers",value:function(e,t){return this._struct.vertexBundles.map((function(i){var n=e.createBuffer(new Gc(Gl.VERTEX,Hl.DEVICE,i.view.length,i.view.stride)),r=new Uint8Array(t,i.view.offset,i.view.length);return n.update(r),n}))}},{key:"initDefault",value:function(e){g(l(i.prototype),"initDefault",this).call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:tO})}},{key:"allowDataAccess",get:function(){return this._allowDataAccess},set:function(e){this._allowDataAccess=e,this._isMeshDataUploaded&&!this._allowDataAccess&&this.releaseData()}},{key:"releaseData",value:function(){this._data=tO}}]),i}(ed),NM=Ms(LM.prototype,"_struct",[Js],(function(){return{vertexBundles:[],primitives:[]}})),FM=Ms(LM.prototype,"_hash",[Js],(function(){return 0})),GM=Ms(LM.prototype,"_allowDataAccess",[Js],(function(){return!0})),DM=LM))||DM;function nO(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=x_[r.format].size}return i}B.Mesh=iO;var rO=Sl.isLittleEndian;function sO(e){var t=x_[e];return t.size/t.count}function aO(e,t){var i=x_[t],n=i.size/i.count;switch(i.type){case Nl.UNORM:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,rO)};case 4:return function(t){return e.getUint32(t,rO)}}break;case Nl.SNORM:case Nl.INT:switch(n){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,rO)};case 4:return function(t){return e.getInt32(t,rO)}}break;case Nl.UINT:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,rO)};case 4:return function(t){return e.getUint32(t,rO)}}break;case Nl.FLOAT:return function(t){return e.getFloat32(t,rO)}}return null}function oO(e,t){var i=x_[t],n=i.size/i.count;switch(i.type){case Nl.UNORM:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,rO)};case 4:return function(t,i){return e.setUint32(t,i,rO)}}break;case Nl.SNORM:case Nl.INT:switch(n){case 1:return function(t,i){return e.setInt8(t,i)};case 2:return function(t,i){return e.setInt16(t,i,rO)};case 4:return function(t,i){return e.setInt32(t,i,rO)}}break;case Nl.UINT:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,rO)};case 4:return function(t,i){return e.setUint32(t,i,rO)}}break;case Nl.FLOAT:return function(t,i){return e.setFloat32(t,i,rO)}}return null}var uO,hO,lO=0,cO={};function _O(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function fO(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(uO||(uO={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(hO||(hO={}));var dO,mO,pO,vO,yO,gO,SO,AO,TO,EO=function(){function e(t){n(this,e),this._device=void 0,this._format=Ll.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Mc,this._region1=new Mc,this._region2=new Mc,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}return s(e,[{key:"initialize",value:function(e){var t=x_[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=L_(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0}},{key:"alloc",value:function(e,t){e=fO(e,this._alignment);var i=-1,n=-1;if(void 0!==t&&(i=t,n=this._findAvailableSpace(e,i)),n<0)for(var r=0;r<this._chunkCount&&(i=r,!((n=this._findAvailableSpace(e,i))>=0));++r);if(n>=0){var s=this._chunks[i];s.start+=e;var a={chunkIdx:i,start:n,end:n+e,texture:s.texture};return this._handles.push(a),a}var o=Math.sqrt(e/this._formatSize),u=this._roundUpFn&&this._roundUpFn(o,this._formatSize)||Math.max(1024,_O(o)),h=this._chunks[this.createChunk(u)];h.start+=e;var l={chunkIdx:this._chunkCount-1,start:0,end:e,texture:h.texture};return this._handles.push(l),l}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"createChunk",value:function(e){var t=e*e*this._formatSize;$("TextureBufferPool: Allocate chunk ".concat(this._chunkCount,", size: ").concat(t,", format: ").concat(this._format));var i={texture:this._device.createTexture(new Wc(zl.TEX2D,Wl.SAMPLED|Wl.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=i,this._chunkCount++}},{key:"update",value:function(e,t){var i=[],n=[],r=e.start/this._formatSize,s=t.byteLength/this._formatSize,a=r%e.texture.width,o=Math.floor(r/e.texture.width),u=Math.min(e.texture.width-a,s),h=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=o,this._region0.texExtent.width=u,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(t,h*this._formatSize,u*this._channels)),n.push(this._region0),a=0,o+=1,s-=u,h+=u),s>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=o,s>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(s/e.texture.width),u=this._region1.texExtent.width*this._region1.texExtent.height):(u=s,this._region1.texExtent.width=u,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(t,h*this._formatSize,u*this._channels)),n.push(this._region1),a=0,o+=this._region1.texExtent.height,s-=u,h+=u),s>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=o,this._region2.texExtent.width=s,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(t,h*this._formatSize,s*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}},{key:"_findAvailableSpace",value:function(e,t){var i=this._chunks[t],n=!1,r=i.start;if(r+e<=i.size)n=!0;else{r=0;for(var s=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<s.length;a++){var o=s[a];if(r+e<=o.start){n=!0;break}r=o.end}!n&&r+e<=i.size&&(n=!0)}return n?r:-1}},{key:"_McDonaldAlloc",value:function(e){e=fO(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var i=this._chunks[t],n=!1,r=i.start;if(r+e<=i.end?n=!0:r>i.end?r+e<=i.size?n=!0:e<=i.end&&(i.start=r=0,n=!0):r===i.end&&(i.start=r=0,i.end=i.size,e<=i.end&&(n=!0)),n){i.start+=e;var s={chunkIdx:t,start:r,end:r+e,texture:i.texture};return this._handles.push(s),s}}var a=Math.sqrt(e/this._formatSize),o=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,_O(a)),u=this._chunks[this.createChunk(o)];u.start+=e;var h={chunkIdx:this._chunkCount,start:0,end:e,texture:u.texture};return this._handles.push(h),h}}]),e}(),bO=function(){function e(t,i,r){n(this,e),this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=r*(1<<i)}return s(e,[{key:"allocateNewChunk",value:function(){return new ArrayBuffer(this._chunkSize)}}]),e}();s((function e(){n(this,e)}),[{key:"bind",value:function(){}}]),s((function e(){n(this,e)}),[{key:"alloc",value:function(e,t){return new ArrayBuffer(t)}},{key:"free",value:function(){}}]),function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(TO||(TO={}));var CO,RO,xO=function(){function e(t,i,r,s){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;n(this,e),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=s.COUNT,this._entryBits=a,this._dataType=i,this._dataMembers=r;var o=4;this._stride=o*this._elementCount,this._entriesPerChunk=1<<a,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new bO(t,a,this._stride);var u=TO.NEVER,h=!1,l=!1;for(var c in i){if(h=this._hasFloat32,(l=this._hasUint32)&&h)break;u=i[c],h||u!==TO.FLOAT32?l||u!==TO.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}return s(e,[{key:"alloc",value:function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var i=t[t.length-1];return t.length--,(e<<this._entryBits)+i+this._poolFlag}}for(var n=this._nativePool.allocateNewChunk(),r=[],s=[],a=[],o=this._hasFloat32,u=this._hasUint32,h=0;h<this._entriesPerChunk;h++)o&&r.push(new Float32Array(n,this._stride*h,this._elementCount)),u&&s.push(new Uint32Array(n,this._stride*h,this._elementCount)),h&&a.push(h);return u&&this._uint32BufferViews.push(s),o&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(n),(e<<this._entryBits)+this._poolFlag}},{key:"getBuffer",value:function(e){var t=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][i]}},{key:"getTypedArray",value:function(e,t){var i=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e,r=t,s=(this._dataType[t]===TO.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][n],a=this._dataMembers[t];return s.subarray(r,r+a)}},{key:"free",value:function(e){var t=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][i].fill(0),this._freeLists[t].push(i)}}]),e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB",e[e.RENDER2D=3]="RENDER2D"}(CO||(CO={})),function(e){e[e.POSITION=0]="POSITION",e[e.UV=3]="UV",e[e.COLOR=5]="COLOR",e[e.COUNT=9]="COUNT"}(RO||(RO={}));var wO,kO=(a(dO={},RO.POSITION,TO.FLOAT32),a(dO,RO.UV,TO.FLOAT32),a(dO,RO.COLOR,TO.UINT32),a(dO,RO.COUNT,TO.NEVER),dO),IO=(a(mO={},RO.POSITION,RO.UV-RO.POSITION),a(mO,RO.UV,RO.COLOR-RO.UV),a(mO,RO.COLOR,RO.COUNT-RO.COLOR),a(mO,RO.COUNT,1),mO),BO=new xO(CO.RENDER2D,kO,IO,RO);!function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(wO||(wO={}));var PO,MO=(a(pO={},wO.DIRTY_FLAG,TO.UINT32),a(pO,wO.LAYER,TO.UINT32),a(pO,wO.WORLD_SCALE,TO.FLOAT32),a(pO,wO.WORLD_POSITION,TO.FLOAT32),a(pO,wO.WORLD_ROTATION,TO.FLOAT32),a(pO,wO.WORLD_MATRIX,TO.FLOAT32),a(pO,wO.LOCAL_SCALE,TO.FLOAT32),a(pO,wO.LOCAL_POSITION,TO.FLOAT32),a(pO,wO.LOCAL_ROTATION,TO.FLOAT32),a(pO,wO.COUNT,TO.NEVER),pO),OO=(a(vO={},wO.DIRTY_FLAG,wO.LAYER-wO.DIRTY_FLAG),a(vO,wO.LAYER,wO.WORLD_SCALE-wO.LAYER),a(vO,wO.WORLD_SCALE,wO.WORLD_POSITION-wO.WORLD_SCALE),a(vO,wO.WORLD_POSITION,wO.WORLD_ROTATION-wO.WORLD_POSITION),a(vO,wO.WORLD_ROTATION,wO.WORLD_MATRIX-wO.WORLD_ROTATION),a(vO,wO.WORLD_MATRIX,wO.LOCAL_SCALE-wO.WORLD_MATRIX),a(vO,wO.LOCAL_SCALE,wO.LOCAL_POSITION-wO.LOCAL_SCALE),a(vO,wO.LOCAL_POSITION,wO.LOCAL_ROTATION-wO.LOCAL_POSITION),a(vO,wO.LOCAL_ROTATION,wO.COUNT-wO.LOCAL_ROTATION),a(vO,wO.COUNT,1),vO),DO=new xO(CO.NODE,MO,OO,wO);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(PO||(PO={}));var LO,NO=(a(yO={},PO.PRIORITY,TO.UINT32),a(yO,PO.STAGE,TO.UINT32),a(yO,PO.PHASE,TO.UINT32),a(yO,PO.PRIMITIVE,TO.UINT32),a(yO,PO.BATCHING_SCHEME,TO.UINT32),a(yO,PO.DYNAMIC_STATE,TO.UINT32),a(yO,PO.HASH,TO.UINT32),a(yO,PO.COUNT,TO.NEVER),yO),FO=(a(gO={},PO.PRIORITY,PO.STAGE-PO.PRIORITY),a(gO,PO.STAGE,PO.PHASE-PO.STAGE),a(gO,PO.PHASE,PO.PRIMITIVE-PO.PHASE),a(gO,PO.PRIMITIVE,PO.BATCHING_SCHEME-PO.PRIMITIVE),a(gO,PO.BATCHING_SCHEME,PO.DYNAMIC_STATE-PO.BATCHING_SCHEME),a(gO,PO.DYNAMIC_STATE,PO.HASH-PO.DYNAMIC_STATE),a(gO,PO.HASH,PO.COUNT-PO.HASH),a(gO,PO.COUNT,1),gO),GO=new xO(CO.PASS,NO,FO,PO);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(LO||(LO={}));var VO=(a(SO={},LO.CENTER,TO.FLOAT32),a(SO,LO.HALFEXTENTS,TO.FLOAT32),a(SO,LO.COUNT,TO.NEVER),SO),UO=(a(AO={},LO.CENTER,LO.HALFEXTENTS-LO.CENTER),a(AO,LO.HALFEXTENTS,LO.COUNT-LO.HALFEXTENTS),a(AO,LO.COUNT,1),AO),HO=new xO(CO.AABB,VO,UO,LO),zO=function(){function e(t){n(this,e),this._root=void 0,this._name="",this._cameras=[],this._models=[],this._lodGroups=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._lodStateCache=null,this._root=t}return s(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"batches",get:function(){return this._batches}},{key:"lodGroups",get:function(){return this._lodGroups}},{key:"initialize",value:function(e){return this._name=e.name,this._lodStateCache=new XO(this),!0}},{key:"update",value:function(e){var t=this._mainLight;t&&t.update();for(var i=this._sphereLights,n=0;n<i.length;n++)i[n].update();for(var r=this._spotLights,s=0;s<r.length;s++)r[s].update();for(var a=this._models,o=0;o<a.length;o++){var u=a[o];u.enabled&&(u.updateTransform(e),u.updateUBOs(e))}this._lodStateCache.updateLodState()}},{key:"destroy",value:function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this.removeLODGroups(),this._lodStateCache.clearCache()}},{key:"isCulledByLod",value:function(e,t){return this._lodStateCache.isLodModelCulled(e,t)}},{key:"addCamera",value:function(e){e.attachToScene(this),this._cameras.push(e),this._lodStateCache.addCamera(e)}},{key:"removeCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),e.detachFromScene(),void this._lodStateCache.removeCamera(e)}},{key:"removeCameras",value:function(){for(var e,t=R(this._cameras);!(e=t()).done;){var i=e.value;i.detachFromScene(),this._lodStateCache.removeCamera(i)}this._cameras.splice(0)}},{key:"setMainLight",value:function(e){this._mainLight=e}},{key:"unsetMainLight",value:function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=ip.ROTATION));this.setMainLight(null)}}},{key:"addDirectionalLight",value:function(e){e.attachToScene(this),this._directionalLights.push(e)}},{key:"removeDirectionalLight",value:function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)}},{key:"addSphereLight",value:function(e){e.attachToScene(this),this._sphereLights.push(e)}},{key:"removeSphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)}},{key:"addSpotLight",value:function(e){e.attachToScene(this),this._spotLights.push(e)}},{key:"removeSpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)}},{key:"removeSphereLights",value:function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0}},{key:"removeSpotLights",value:function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]}},{key:"addModel",value:function(e){e.attachToScene(this),this._models.push(e)}},{key:"removeModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return this._lodStateCache.removeModel(e),e.detachFromScene(),void this._models.splice(t,1)}},{key:"removeModels",value:function(){for(var e,t=R(this._models);!(e=t()).done;){var i=e.value;this._lodStateCache.removeModel(i),i.detachFromScene(),i.destroy()}this._models.length=0}},{key:"addBatch",value:function(e){this._batches.push(e)}},{key:"removeBatch",value:function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)}},{key:"removeBatches",value:function(){this._batches.length=0}},{key:"addLODGroup",value:function(e){this._lodGroups.push(e),e.attachToScene(this),this._lodStateCache.addLodGroup(e)}},{key:"removeLODGroup",value:function(e){var t=this._lodGroups.indexOf(e);t>=0&&(this._lodGroups.splice(t,1),e.detachFromScene(),this._lodStateCache.removeLodGroup(e))}},{key:"removeLODGroups",value:function(){for(var e,t=R(this._lodGroups);!(e=t()).done;){var i=e.value;this._lodStateCache.removeLodGroup(i)}this._lodGroups.length=0}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e,t=R(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()}},{key:"generateModelId",value:function(){return this._modelId++}}],[{key:"registerCreateFunc",value:function(t){t._createSceneFun=function(t){return new e(t)}}}]),e}(),WO=function e(){n(this,e),this.usedLevel=-1,this.lastUsedLevel=-1,this.transformDirty=!0},XO=function(){function e(t){n(this,e),this._renderScene=null,this._modelsInLODGroup=new Map,this._lodStateInCamera=new Map,this._newAddedLodGroupVec=new Array,this._levelModels=new Map,this._renderScene=t}return s(e,[{key:"addCamera",value:function(e){for(var t,i=R(this._renderScene.lodGroups);!(t=i()).done;){var n=t.value.node.layer;if((e.visibility&n)===n){this._lodStateInCamera.has(e)||this._lodStateInCamera.set(e,new Map);break}}}},{key:"removeCamera",value:function(e){this._lodStateInCamera.has(e)&&this._lodStateInCamera.delete(e)}},{key:"addLodGroup",value:function(e){this._newAddedLodGroupVec.push(e);for(var t,i=R(this._renderScene.cameras);!(t=i()).done;){var n=t.value;if(!this._lodStateInCamera.has(n)){var r=e.node.layer;(n.visibility&r)===r&&this._lodStateInCamera.set(n,new Map)}}}},{key:"removeLodGroup",value:function(e){for(var t=0;t<e.lodCount;t++)for(var i,n=R(e.lodDataArray[t].models);!(i=n()).done;){var r=i.value;this._modelsInLODGroup.delete(r)}for(var s,a=R(this._lodStateInCamera);!(s=a()).done;)s.value[1].delete(e);this._levelModels.delete(e)}},{key:"removeModel",value:function(e){this._modelsInLODGroup.has(e)&&this._modelsInLODGroup.delete(e)}},{key:"updateLodState",value:function(){for(var e,t=this,i=R(this._newAddedLodGroupVec);!(e=i()).done;){var n=e.value,r=this._levelModels.get(n);r||(r=new Map,this._levelModels.set(n,r));for(var s=0;s<n.lodCount;s++){var a=r.get(s);a||(a=new Array);for(var o,u=R(n.lodDataArray[s].models);!(o=u()).done;){var h=o.value,l=this._modelsInLODGroup.get(h);l||(l=new Map),this._modelsInLODGroup.set(h,l),a.push(h)}r.set(s,a)}}this._newAddedLodGroupVec.length=0;for(var c,_=function(){var e=c.value;if(e.enabled){var i=e.getLockedLODLevels();if(i.length>0){if(e.node.hasChangedFlags>0)for(var n,r=R(t._lodStateInCamera);!(n=r()).done;){var s=n.value,a=s[1].get(e);a||(a=new WO,s[1].set(e,a)),a.transformDirty=!0}if(e.isLockLevelChanged()){e.resetLockChangeFlag();var o=t._levelModels.get(e);if(o){o.forEach((function(e){e.forEach((function(e){var i=t._modelsInLODGroup.get(e);i&&i.clear()}))}));for(var u,h=R(i);!(u=h()).done;){var l=u.value,_=o.get(l);_&&_.forEach((function(e){var i=t._modelsInLODGroup.get(e);if(i&&e.node&&e.node.active)for(var n,r=R(t._lodStateInCamera);!(n=r()).done;){var s=n.value;i.set(s[0],!0)}}))}}}return"continue"}for(var f,d=!1,m=R(t._lodStateInCamera);!(f=m()).done;){var p=f.value,v=p[1].get(e);v||(v=new WO,p[1].set(e,v));var y=p[0].node.hasChangedFlags,g=e.node.hasChangedFlags;if(y>0||g>0||v.transformDirty){v.transformDirty&&(v.transformDirty=!1);var S=e.getVisibleLODLevel(p[0]);S!==v.usedLevel&&(v.lastUsedLevel=v.usedLevel,v.usedLevel=S,d=!0)}}var A=t._levelModels.get(e);if(!A)return"continue";e.isLockLevelChanged()?(e.resetLockChangeFlag(),A.forEach((function(e){e.forEach((function(e){var i=t._modelsInLODGroup.get(e);i&&i.clear()}))})),d=!0):d&&t._lodStateInCamera.forEach((function(i){var n=i.get(e);if(n&&n.usedLevel!==n.lastUsedLevel){var r=A.get(n.lastUsedLevel);r&&r.forEach((function(e){var i=t._modelsInLODGroup.get(e);i&&i.clear()}))}})),d&&t._lodStateInCamera.forEach((function(i,n){var r=i.get(e);if(r){var s=r.usedLevel,a=A.get(s);a&&a.forEach((function(e){var i=t._modelsInLODGroup.get(e);i&&e.node&&e.node.active&&i.set(n,!0)}))}}))}},f=R(this._renderScene.lodGroups);!(c=f()).done;)_()}},{key:"isLodModelCulled",value:function(e,t){var i=this._modelsInLODGroup.get(t);return!!i&&!i.has(e)}},{key:"clearCache",value:function(){this._levelModels.clear(),this._modelsInLODGroup.clear(),this._lodStateInCamera.clear(),this._newAddedLodGroupVec.length=0}},{key:"isLodGroupVisibleByCamera",value:function(e,t){var i=e.node.layer;return(t.visibility&i)===i}}]),e}();pe(zO.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),pe(zO.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]),pe(Cx.prototype,"Model.prototype",[{name:"isInstancingEnabled"},{name:"instancedAttributes"}]);var jO={};pe(jO,"CameraVisFlags",[{name:"GENERAL"}]),me(jO,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:ep.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:ep.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:ep.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:ep.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:ep.BitMask,targetName:"UI_2D"}]),B.CameraVisFlags=jO;var qO={};pe(qO,"VisibilityFlags",[{name:"GENERAL"}]),me(qO,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:ep.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:ep.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:ep.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:ep.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:ep.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:ep.Enum,targetName:"UI_2D"}]),B.VisibilityFlags=qO,me(QS.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),pe(KR.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),pe(AA.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),pe(Jx.prototype,"SpotLight.prototype",[{name:"aspect"}]),me(sx.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),pe(sx.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]);var YO=function(e){if(void 0===cO[e]){var t=1<<lO;cO[e]=t,lO+=1}},KO=Object.freeze({__proto__:null,addStage:YO,scene:ew,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var s=[];s.push(new i_(Tc.ATTR_POSITION,Ll.RGB32F)),t.normals&&s.push(new i_(Tc.ATTR_NORMAL,Ll.RGB32F)),t.uvs&&s.push(new i_(Tc.ATTR_TEX_COORD,Ll.RG32F)),t.colors&&s.push(new i_(Tc.ATTR_COLOR,Ll.RGB32F));var a=e.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE,4*i.length,4*i.length/n));a.update(new Float32Array(i));var o=null;return t.indices&&(o=e.createBuffer(new Gc(Gl.INDEX|Gl.TRANSFER_DST,Hl.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new r_(s,[a],o))},get RenderQueue(){return uO},get PassStage(){return hO},genHandle:Uy,getTypeFromHandle:Hy,getBindingFromHandle:zy,getCountFromHandle:Wy,getOffsetFromHandle:Xy,customizeType:jy,type2reader:qy,type2writer:Yy,type2validator:Ky,getDefaultFromType:Jy,getStringFromType:Zy,overrideMacros:$y,get BatchingSchemes(){return VS},Pass:QS,flattenShaderLocation:function(e,t,i,n,r){var s=e;if("vert"===n){var a=new Set;s=og(s=function(e,t,i,n){for(var r=new RegExp("layout\\(location = (\\d+)\\)\\s+in.*?\\s(\\w+)[;,\\)]","g"),s=r.exec(e),a=e,o=function(){var o=s[2],u=t.attributes.find((function(e){return e.name===o}));if(0===(null==u?void 0:u.defines.length)||(null==u?void 0:u.defines.every((function(e){return""===e})))){var h=parseInt(s[1]);if(h>15){for(var l=0;n.has(l);)l++;h=l;var c=s[0].replace(s[1],"".concat(h));a=e.replace(s[0],c)}n.add(h),i.set(s[2],h)}s=r.exec(e)};s;)o();return a}(e,t,r,a),t,i,"in",r,a),s=og(s,t,i,"out",r)}else"frag"===n&&(s=function(e,t,i){for(var n=e,r="layout\\(location = ([^\\)]+)\\)\\s+".concat("in",".*?\\s(\\w+)[;,\\)]"),s=new RegExp(r,"g"),a=s.exec(e);a;){var o=a[2];if(!i.has(o)){var u=0;u=i.get(o)||0;var h=a[0].replace(a[1],"".concat(u));n=n.replace(a[0],h)}a=s.exec(e)}return n}(s,0,r));return s},getDeviceShaderVersion:ug,programLib:vg,nearestPOT:_O,TextureBufferPool:EO,MaterialInstance:EA,PassInstance:TA,get PoolType(){return CO},NULL_HANDLE:0,get Render2dView(){return RO},Render2dPool:BO,get NodeView(){return wO},NodePool:DO,get PassView(){return PO},PassPool:GO,get AABBView(){return LO},AABBPool:HO,RenderScene:zO,CameraVisFlags:jO,VisibilityFlags:qO});e("renderer",KO);var QO=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._morphRenderingInstance=null,e._usedMaterials=new Set,e}return s(i,[{key:"getMacroPatches",value:function(e){var t=g(l(i.prototype),"getMacroPatches",this).call(this,e);if(this._morphRenderingInstance){var n=this._morphRenderingInstance.requiredPatches(e);if(n)return n.concat(null!=t?t:[])}return t}},{key:"initSubModel",value:function(e,t,n){return g(l(i.prototype),"initSubModel",this).call(this,e,t,this._launderMaterial(n))}},{key:"destroy",value:function(){g(l(i.prototype),"destroy",this).call(this),this._morphRenderingInstance=null}},{key:"setSubModelMaterial",value:function(e,t){return g(l(i.prototype),"setSubModelMaterial",this).call(this,e,this._launderMaterial(t))}},{key:"setMorphRendering",value:function(e){this._morphRenderingInstance=e}},{key:"_updateLocalDescriptors",value:function(e,t){g(l(i.prototype),"_updateLocalDescriptors",this).call(this,e,t),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,t)}},{key:"_launderMaterial",value:function(e){return e}}]),i}(Cx);Ci.Attr.setClassAttr(Zd,"target","type","Object"),Ci.Attr.setClassAttr(Zd,"target","ctor",Jp);var JO,ZO=new Array(16),$O=null,eD=new In,tD=[rp.TOUCH_START,rp.TOUCH_MOVE,rp.TOUCH_END,rp.TOUCH_CANCEL],iD=[rp.MOUSE_DOWN,rp.MOUSE_ENTER,rp.MOUSE_MOVE,rp.MOUSE_LEAVE,rp.MOUSE_UP,rp.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(JO||(JO={}));var nD,rD=function(){function e(t){n(this,e),this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._dispatchingTouch=null,this._isEnabled=!1,this._node=void 0,this._node=t}return s(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}},{key:"setEnabled",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._isEnabled!==t){this._isEnabled=t;var n=this.node,r=n.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(JO.MARK_LIST_DIRTY),i&&r.length>0)for(var s=0;s<r.length;++s){var a=r[s];a._eventProcessor.setEnabled(t,!0)}if(this._dispatchingTouch&&!this._isEnabled){var o=new XC([this._dispatchingTouch],!0,GC.TOUCH_CANCEL);o.touch=this._dispatchingTouch,this.dispatchEvent(o),this.claimedTouchIdList.length=0,this._dispatchingTouch=null}}}},{key:"reattach",value:function(){var t,i=this;this.node.walk((function(n){t||(t=i._searchComponentsInParent(e._maskComp)),n.eventProcessor.maskList=t}))}},{key:"destroy",value:function(){if($O===this._node&&($O=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(JO.REMOVE_POINTER_EVENT_PROCESSOR,this),this._dispatchingTouch){var t=new XC([this._dispatchingTouch],!0,GC.TOUCH_CANCEL);t.touch=this._dispatchingTouch,this.dispatchEvent(t),this._dispatchingTouch=null}}},{key:"on",value:function(e,t,i,n){var r,s;return this._tryEmittingAddEvent(e),((n=!!n)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(s=this.bubblingTarget)&&void 0!==s?s:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,i),t}},{key:"once",value:function(e,t,i,n){var r,s;return this._tryEmittingAddEvent(e),((n=!!n)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(s=this.bubblingTarget)&&void 0!==s?s:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,i,!0),t}},{key:"off",value:function(e,t,i,n){var r;null===(r=(n=!!n)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,i)}},{key:"targetOff",value:function(t){var i,n;null===(i=this.capturingTarget)||void 0===i||i.removeAll(t),null===(n=this.bubblingTarget)||void 0===n||n.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(JO.REMOVE_POINTER_EVENT_PROCESSOR,this)}},{key:"emit",value:function(e,t,i,n,r,s){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(e,t,i,n,r,s)}},{key:"dispatchEvent",value:function(e){var t,i=this.node,n=0;for(e.target=i,ZO.length=0,this.getCapturingTargets(e.type,ZO),e.eventPhase=1,n=ZO.length-1;n>=0;--n)if((t=ZO[n]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,ZO),e.propagationStopped))return void(ZO.length=0);if(ZO.length=0,e.eventPhase=2,e.currentTarget=i,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,ZO),e.eventPhase=3,n=0;n<ZO.length;++n)if((t=ZO[n]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(ZO.length=0);ZO.length=0}},{key:"hasEventListener",value:function(e,t,i){var n=!1;return this.bubblingTarget&&(n=this.bubblingTarget.hasEventListener(e,t,i)),!n&&this.capturingTarget&&(n=this.capturingTarget.hasEventListener(e,t,i)),n}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;){var n;null!==(n=i.eventProcessor.capturingTarget)&&void 0!==n&&n.hasEventListener(e)&&t.push(i),i=i.parent}}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;){var n;null!==(n=i.eventProcessor.bubblingTarget)&&void 0!==n&&n.hasEventListener(e)&&t.push(i),i=i.parent}}},{key:"onUpdatingSiblingIndex",value:function(){e.callbacksInvoker.emit(JO.MARK_LIST_DIRTY)}},{key:"_searchComponentsInParent",value:function(e){var t=this.node;if(e){for(var i=0,n=[],r=t;r&&Jp.isNode(r);r=r.parent,++i){var s=r.getComponent(e);if(s){var a={index:i,comp:s};n?n.push(a):n=[a]}}return n.length>0?n:null}return null}},{key:"_attachMask",value:function(){this.maskList=this._searchComponentsInParent(e._maskComp)}},{key:"_isTouchEvent",value:function(e){return-1!==tD.indexOf(e)}},{key:"_isMouseEvent",value:function(e){return-1!==iD.indexOf(e)}},{key:"_hasTouchListeners",value:function(){for(var e=0;e<tD.length;++e){var t=tD[e];if(this.hasEventListener(t))return!0}return!1}},{key:"_hasMouseListeners",value:function(){for(var e=0;e<iD.length;++e){var t=iD[e];if(this.hasEventListener(t))return!0}return!1}},{key:"_hasPointerListeners",value:function(){return!!this._hasTouchListeners()||this._hasMouseListeners()}},{key:"_tryEmittingAddEvent",value:function(t){var i=this._isTouchEvent(t),n=this._isMouseEvent(t);i?this.shouldHandleEventTouch=!0:n&&(this.shouldHandleEventMouse=!0),!i&&!n||this._hasPointerListeners()||e.callbacksInvoker.emit(JO.ADD_POINTER_EVENT_PROCESSOR,this)}},{key:"_newCallbacksInvoker",value:function(){var t=this,i=new Vh;return i._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(JO.REMOVE_POINTER_EVENT_PROCESSOR,t)})),i}},{key:"_handleEventMouse",value:function(e){switch(e.type){case GC.MOUSE_DOWN:return this._handleMouseDown(e);case GC.MOUSE_MOVE:return this._handleMouseMove(e);case GC.MOUSE_UP:return this._handleMouseUp(e);case GC.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}}},{key:"_handleMouseDown",value:function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(eD),!t._uiProps.uiTransformComp.hitTest(eD,e.windowId)||(e.type=rp.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))}},{key:"_handleMouseMove",value:function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(eD),t._uiProps.uiTransformComp.hitTest(eD,e.windowId)?(this.previousMouseIn||($O&&$O!==t&&(e.type=rp.MOUSE_LEAVE,$O.dispatchEvent(e),$O.eventProcessor.previousMouseIn=!1),$O=t,e.type=rp.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=rp.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=rp.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,$O=null),1)))}},{key:"_handleMouseUp",value:function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(eD),!t._uiProps.uiTransformComp.hitTest(eD,e.windowId)||(e.type=rp.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))}},{key:"_handleMouseWheel",value:function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(eD),!t._uiProps.uiTransformComp.hitTest(eD,e.windowId)||(e.type=rp.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))}},{key:"_handleEventTouch",value:function(e){switch(e.type){case GC.TOUCH_START:return this._handleTouchStart(e);case GC.TOUCH_MOVE:return this._handleTouchMove(e);case GC.TOUCH_END:return this._handleTouchEnd(e);case GC.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}}},{key:"_handleTouchStart",value:function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(eD),!t._uiProps.uiTransformComp.hitTest(eD,e.windowId)||(e.type=rp.TOUCH_START,e.bubbles=!0,this._dispatchingTouch=e.touch,t.dispatchEvent(e),0)))}},{key:"_handleTouchMove",value:function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=rp.TOUCH_MOVE,e.bubbles=!0,this._dispatchingTouch=e.touch,t.dispatchEvent(e),0))}},{key:"_handleTouchEnd",value:function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getLocation(eD),t._uiProps.uiTransformComp.hitTest(eD,e.windowId)?e.type=rp.TOUCH_END:e.type=rp.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e),this._dispatchingTouch=null)}},{key:"_handleTouchCancel",value:function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=rp.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))}}]),e}();rD._maskComp=null,rD.callbacksInvoker=new Vh,B.NodeEventProcessor=rD,me(Jp.prototype,"Node",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),me(Jp.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new In),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Mn),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),pe(uC.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),me(uC.prototype,"SceneGlobals.prototype",[{name:"distance",newName:"planeHeight"},{name:"normal",newName:"planeDirection"},{name:"size",newName:"shadowMapSize"}]),pe(Jp.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),me(np.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),pe(ep,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),me(ep,"Layers",[{name:"Default",newName:"DEFAULT",target:ep.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:ep.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:ep.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:ep.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:ep.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:ep.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:ep.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:ep.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:ep,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:ep,targetName:"Layers"}]),pe(ep.Enum,"Layers.Enum",[{name:"ALWAYS"}]),pe(ep.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var sD=Ga.Flags.HideInHierarchy,aD=Ga.Flags.DontSave,oD=e("PrivateNode",Hs("cc.PrivateNode")(nD=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),ae(12003,(r=t.call(this,e)).name),r.hideFlags|=aD|sD,r}return i}(Jp))||nD);function uD(e,t){if(!t){var i=B.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}me(FC,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:Jp.EventType,targetName:"Node.EventType"}}))),me(Jp.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:BR.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:BR.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:BR.EventType,targetName:"SystemEvent.EventType"}]),B.PrivateNode=oD,xe({BaseNode:{newName:"Node",since:"3.7.0",removed:!1}}),B.find=uD;var hD=gt,lD=Ga.Flags.IsStartCalled,cD=Ga.Flags.IsOnEnableCalled;function _D(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,s=e.length-1,a=s>>>1;r<=s;a=r+s>>>1){var o=e[a],u=o.constructor._executionOrder;if(u>i)s=a-1;else if(u<i)r=a+1;else{var h=o._id;if(h>n)s=a-1;else{if(!(h<n))return a;r=a+1}}}return~r}function fD(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}Ga.Flags.IsEditorOnEnableCalled;var dD=function e(t){n(this,e),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var i=vt;this._zero=new i([]),this._neg=new i([]),this._pos=new i([]),this._invoke=t};function mD(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}dD.stableRemoveInactive=fD;var pD=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){fD(this._zero,e),fD(this._neg,e),fD(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;e.array.length>0&&(e.array.sort(mD),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(mD),this._invoke(t),t.array.length=0)}}]),i}(dD),vD=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,n=_D(i,e);n<0&&i.splice(~n,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,n=_D(i.array,e);n>=0&&i.removeAt(n)}}},{key:"invoke",value:function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)}}]),i}(dD);function yD(e,t,i){var n="".concat("var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];").concat(e,"}"),r=t?Function("it","dt",n):Function("it",n);return function(e,t,i){return function(n,r){try{t(n,r)}catch(t){B._throw(t);var s=n.array;for(i&&(s[n.i]._objFlags|=i),++n.i;n.i<s.length;++n.i)try{e(s[n.i],r)}catch(e){B._throw(e),i&&(s[n.i]._objFlags|=i)}}}}(Function("c","dt",e),r,i)}var gD=yD("c.start();c._objFlags|=".concat(lD),!1,lD),SD=yD("c.update(dt)",!0),AD=yD("c.lateUpdate(dt)",!0),TD=function(e){var t=B.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];n._enabled&&(n.onEnable(),!n.node._activeInHierarchy||t._onEnabled(n))}},ED=function(){function e(){n(this,e),this._deferredComps=[],this.unscheduleAll()}return s(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new pD(gD),this.updateInvoker=new vD(SD),this.lateUpdateInvoker=new vD(AD),this._updating=!1}},{key:"_onEnabled",value:function(e){B.director.getScheduler().resumeTarget(e),e._objFlags|=cD,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){B.director.getScheduler().pauseTarget(e),e._objFlags&=~cD;var t=this._deferredComps.indexOf(e);t>=0?hD(this._deferredComps,t):(!e.start||e._objFlags&lD||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&cD)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&cD&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()}},{key:"_startForNewComps",value:function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}},{key:"_scheduleImmediate",value:function(e){"function"!=typeof e.start||e._objFlags&lD||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this._deferredComps,t=0,i=e.length;t<i;t++)this._scheduleImmediate(e[t]);e.length=0}}]),e}(),bD=Ga.Flags.IsPreloadStarted,CD=Ga.Flags.IsOnLoadStarted,RD=Ga.Flags.IsOnLoadCalled,xD=Ga.Flags.Deactivating,wD=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){dD.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),i}(dD),kD=yD("c.__preload();"),ID=yD("c.onLoad();c._objFlags|=".concat(RD),!1,RD),BD=new pt(4);function PD(e,t,i){ue(3817,e.name,i),console.log("Corrupted component value:",t),t?e._removeComponent(t):yt(e._components,i)}BD.get=function(){var e=this._get()||{preload:new wD(kD),onLoad:new pD(ID),onEnable:new pD(TD)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var MD=e("NodeActivator",function(){function e(){n(this,e),this.resetComp=void 0,this.reset()}return s(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=BD.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),BD.put(i)}else{this._deactivateNodeRecursively(e);for(var n,r=R(this._activatingStack);!(n=r()).done;){var s=n.value;s.preload.cancelInactive(bD),s.onLoad.cancelInactive(CD),s.onEnable.cancelInactive()}}e.emit(rp.ACTIVE_IN_HIERARCHY_CHANGED,e)}},{key:"activateComp",value:function(e,t,i,n){if(Ha(e,!0)&&(e._objFlags&bD||(e._objFlags|=bD,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&CD||(e._objFlags|=CD,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=RD):e._objFlags|=RD),e._enabled)){if(!e.node._activeInHierarchy)return;B.director._compScheduler.enableComp(e,n)}}},{key:"destroyComp",value:function(e){B.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&RD&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,n){if(e._objFlags&xD)ue(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,s=0;s<r;++s){var a=e._components[s];a instanceof B.Component?this.activateComp(a,t,i,n):(PD(e,a,s),--s,--r)}for(var o=0,u=e._children.length;o<u;++o){var h=e._children[o];h._active&&this._activateNodeRecursively(h,t,i,n)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=xD,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(B.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~xD)}for(var r=0,s=e._children.length;r<s;++r){var a=e._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),e._activeInHierarchy))return void(e._objFlags&=~xD)}e._onPostActivated(!1),e._objFlags&=~xD}}]),e}()),OD=Ga.Flags.Destroyed,DD=Ga.Flags.PersistentMask,LD="".concat(Ci.Attr.DELIMETER,"default"),ND=Ci.IDENTIFIER_RE,FD="var ",GD="o",VD={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},UD=Ci.escapeForJS,HD=function(){function e(t,i){n(this,e),this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=i}return s(e,[{key:"toString",value:function(){return"".concat(FD+this.varName,"=").concat(this.expression,";")}}]),e}();function zD(e,t){return t instanceof HD?new HD(t.varName,e+t.expression):e+t}function WD(e,t,i){Array.isArray(i)?(i[0]=zD(t,i[0]),e.push(i)):e.push("".concat(zD(t,i),";"))}var XD=function(){function e(t){n(this,e),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}return s(e,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(this._exps.length>1)e.push("".concat("t","=").concat(this._targetExp,";")),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];WD(e,"".concat(t+jD(n[0]),"="),n[1])}}}]),e}();function jD(e){return ND.test(e)?".".concat(e):"[".concat(UD(e),"]")}XD.pool=void 0,XD.pool=new pt((function(e){e._exps.length=0,e._targetExp=null}),1),XD.pool.get=function(e){var t=this._get()||new XD;return t._targetExp=e,t};var qD,YD,KD,QD,JD,ZD,$D,eL=function(){function e(t,i){var r;n(this,e),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=i,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Ue(),Ze(this.funcModuleCache,VD),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("".concat("var o",",").concat("t",";"),"if(R){","".concat(GD,"=R;"),"}else{","".concat(GD,"=R=new ").concat(this.getFuncModule(t.constructor,!0),"();"),"}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(r="".concat(FD+this.globalVariables.join(","),";"));var s=Il(["return (function(R){",r||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",s)(this.objs,this.funcs);for(var a=0,o=this.objsToClear_iN$t.length;a<o;++a)this.objsToClear_iN$t[a]._iN$t=null;this.objsToClear_iN$t.length=0}return s(e,[{key:"getFuncModule",value:function(e,t){var i=He(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=e===Function("return ".concat(i))())return this.funcModuleCache[i]=i,i}catch(e){}}}var s=this.funcs.indexOf(e);s<0&&(s=this.funcs.length,this.funcs.push(e));var a="F[".concat(s,"]");return t&&(a="(".concat(a,")")),this.funcModuleCache[i]=a,a}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O[".concat(t,"]")}},{key:"setValueType",value:function(e,t,i,n){var r=XD.pool.get(n),s=t.constructor.__props__;s||(s=Object.keys(t));for(var a=0;a<s.length;a++){var o=s[a],u=i[o];if(t[o]!==u){var h=this.enumerateField(i,o,u);r.append(o,h)}}r.writeCode(e),XD.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,n){for(var r=n.__values__,s=Ci.Attr.getClassAttrs(n),a=0;a<r.length;a++){var o=r[a],u=t[o],h=s[o+LD];if(!tL(h,u))if("object"===i(u)&&u instanceof B.ValueType&&(h=Ci.getDefault(h))&&h.constructor===u.constructor){var l=GD+jD(o);this.setValueType(e,h,u,l)}else this.setObjProp(e,t,o,u)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new HD(t,"new Array(".concat(e.length,")"))];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n)WD(i,"".concat(t,"[").concat(n,"]="),this.enumerateField(e,n,e[n]));return i}},{key:"instantiateTypedArray",value:function(e){var t=e.constructor.name;if(0===e.length)return"new ".concat(t);var i="a"+ ++this.localVariableId,n=[new HD(i,"new ".concat(t,"(").concat(e.length,")"))];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&WD(n,"".concat(i,"[").concat(r,"]="),e[r]);return n}},{key:"enumerateField",value:function(e,t,n){if("object"===i(n)&&n){var r=n._iN$t;if(r){var s=r.globalVar;if(!s){s=r.globalVar="v".concat(++this.globalVariableId),this.globalVariables.push(s);var a=r.source[0];r.source[0]=zD("".concat(s,"="),a)}return s}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?UD(n):("_objFlags"===t&&Ua(e)&&(n&=DD),n)}},{key:"setObjProp",value:function(e,t,i,n){WD(e,"".concat(GD+jD(i),"="),this.enumerateField(t,i,n))}},{key:"enumerateObject",value:function(e,t){var n=t.constructor;if(Ri(n))this.enumerateCCClass(e,t,n);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var s=t[r];"object"===i(s)&&s&&s===t._iN$t||this.setObjProp(e,t,r,s)}}},{key:"instantiateObj",value:function(e){if(e instanceof B.ValueType)return Ci.getNewValueTypeCode(e);if(e instanceof B.Asset)return this.getObjRef(e);if(e._objFlags&OD)return null;var t,i=e.constructor;if(Ri(i)){if(this.parent)if(this.parent instanceof B.Component){if(e instanceof B.Node||e instanceof B.Component)return this.getObjRef(e)}else if(this.parent instanceof B.Node)if(e instanceof B.Node){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof B.Component){var n;if(null===(n=e.node)||void 0===n||!n.isChildOf(this.parent))return this.getObjRef(e)}t=new HD(GD,"new ".concat(this.getFuncModule(i,!0),"()"))}else if(i===Object)t=new HD(GD,"{}");else{if(i)return this.getObjRef(e);t=new HD(GD,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]}}]),e}();function tL(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"===i(e)&&"object"===i(t)&&e.constructor===t.constructor)if(e instanceof B.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return De(e)&&De(t)}return!1}var iL,nL,rL,sL,aL,oL,uL=wt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),hL=e("Prefab",Hs("cc.Prefab")(($D=ZD=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this)).data=KD&&KD(),e.optimizationPolicy=QD&&QD(),e.persistent=JD&&JD(),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return s(i,[{key:"createNode",value:function(e){var t=B.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){var e,t;this._createFunction=(t=(e=this.data)instanceof B.Node&&e,new eL(e,t).result)}},{key:"_doInstantiate",value:function(e){return this.data._prefab||ae(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e;return this.optimizationPolicy!==uL.SINGLE_INSTANCE&&(this.optimizationPolicy===uL.MULTI_INSTANCE||this._instantiatedTimes+1>=i.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e}},{key:"initDefault",value:function(e){g(l(i.prototype),"initDefault",this).call(this,e),this.data=new Jp,this.data.name="(Missing Node)";var t=new B._PrefabInfo;t.asset=this,t.root=this.data,this.data._prefab=t}},{key:"validate",value:function(){return!!this.data}},{key:"onLoaded",value:function(){var e=this.data;RC(e),bC(e)}}]),i}(ed),ZD.OptimizationPolicy=uL,ZD.OptimizationPolicyThreshold=3,KD=Ms((YD=$D).prototype,"data",[Js],(function(){return null})),QD=Ms(YD.prototype,"optimizationPolicy",[Js],(function(){return uL.AUTO})),JD=Ms(YD.prototype,"persistent",[Js],(function(){return!1})),qD=YD))||qD);Ne(hL,"_utils",DC),B.Prefab=hL,ze(B,"cc._Prefab","Prefab");var lL,cL,_L,fL,dL,mL,pL,vL,yL,gL,SL,AL,TL,EL,bL,CL,RL,xL,wL,kL,IL,BL,PL,ML,OL,DL,LL,NL,FL,GL,VL,UL,HL,zL,WL,XL,jL,qL,YL,KL,QL,JL,ZL,$L,eN,tN={parent:null,owner:null,subModelIdx:0},iN=Xs,nN=Aa,rN=e("Renderer",(iL=Hs("cc.Renderer"),nL=nN(dA),rL=nN([dA]),iL(sL=iN((x((aL=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._materials=oL&&oL(),e._materialInstances=[],e}return s(i,[{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){for(var t=e.length,i=this._materials.length,n=t;n<i;n++)this.setMaterialInstance(null,n);this._materials.length=t,this._materialInstances.length=t;for(var r=0;r<t;r++)this._materialInstances[r]!=e[r]&&this.setMaterialInstance(e[r],r)}},{key:"getMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t){e&&e instanceof EA&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var i=this._materialInstances[t];i&&(i.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])}},{key:"getMaterialInstance",value:function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){tN.parent=this._materials[e],tN.owner=this,tN.subModelIdx=e;var t=new EA(tN);tN.parent=null,tN.owner=null,tN.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]}},{key:"setMaterialInstance",value:function(e,t){if("number"==typeof e){ae(12007);var i=e;e=t,t=i}var n=this._materialInstances[t];e&&e.parent?e!==n&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||n)&&this.setMaterial(e,t)}},{key:"getRenderMaterial",value:function(e){return this._materialInstances[e]||this._materials[e]}},{key:"_onMaterialModified",value:function(){}},{key:"_onRebuildPSO",value:function(){}},{key:"_clearMaterials",value:function(){}}]),i}(tm)).prototype,"sharedMaterials",[nL],Object.getOwnPropertyDescriptor(aL.prototype,"sharedMaterials"),aL.prototype),oL=Ms(aL.prototype,"_materials",[rL],(function(){return[]})),sL=aL))||sL)||sL)),sN=function(t){return e({ModelRenderer:t,RenderableComponent:t}),t}(Hs("cc.ModelRenderer")((cL=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._visFlags=_L&&_L(),e._models=[],e._priority=0,e}return s(i,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"priority",get:function(){return this._priority},set:function(e){e!==this._priority&&(this._priority=e,this._updatePriority())}},{key:"_collectModels",value:function(){return this._models}},{key:"onEnable",value:function(){this._updatePriority()}},{key:"_attachToScene",value:function(){}},{key:"_detachFromScene",value:function(){}},{key:"_onVisibilityChange",value:function(){}},{key:"_updatePriority",value:function(){if(this._models.length>0)for(var e=0;e<this._models.length;e++)this._models[e].priority=this._priority}}]),i}(rN),_L=Ms(cL.prototype,"_visFlags",[Js],(function(){return ep.Enum.NONE})),lL=cL))||lL),aN=Hs,oN=Ws,uN=Aa,hN=Zs,lN=Js,cN=wt({OFF:0,ON:1}),_N=wt({OFF:0,ON:1});!function(e){e[e.NONE=0]="NONE",e[e.BAKED_CUBEMAP=1]="BAKED_CUBEMAP",e[e.PLANAR_REFLECTION=2]="PLANAR_REFLECTION"}(eN||(eN={}));var fN,dN=(fL=aN("cc.ModelBakeSettings"),dL=hN("_recieveShadow"),mL=uN(ri),pL=uN(ai),vL=uN(ai),yL=uN(wt(eN)),gL=uN(ai),fL((OL=ML=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).texture=TL&&TL(),e.uvParam=EL&&EL(),e._bakeable=bL&&bL(),e._castShadow=CL&&CL(),e._receiveShadow=RL&&RL(),e._lightmapSize=xL&&xL(),e._useLightProbe=wL&&wL(),e._bakeToLightProbe=kL&&kL(),e._reflectionProbeType=IL&&IL(),e._bakeToReflectionProbe=BL&&BL(),e._probeCubemap=PL&&PL(),e._probePlanarmap=null,e}return s(i,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}},{key:"useLightProbe",get:function(){return this._useLightProbe},set:function(e){this._useLightProbe=e,this.emit(i.USE_LIGHT_PROBE_CHANGED)}},{key:"bakeToLightProbe",get:function(){return this._bakeToLightProbe},set:function(e){this._bakeToLightProbe=e}},{key:"reflectionProbe",get:function(){return this._reflectionProbeType},set:function(e){this._reflectionProbeType=e,this.emit(i.REFLECTION_PROBE_CHANGED)}},{key:"bakeToReflectionProbe",get:function(){return this._bakeToReflectionProbe},set:function(e){this._bakeToReflectionProbe=e,this.emit(i.BAKE_TO_REFLECTION_PROBE_CHANGED)}}]),i}(Hh),ML.USE_LIGHT_PROBE_CHANGED="use_light_probe_changed",ML.REFLECTION_PROBE_CHANGED="reflection_probe_changed",ML.BAKE_TO_REFLECTION_PROBE_CHANGED="bake_to_reflection_probe_changed",TL=Ms((AL=OL).prototype,"texture",[lN],(function(){return null})),EL=Ms(AL.prototype,"uvParam",[lN],(function(){return new en})),bL=Ms(AL.prototype,"_bakeable",[lN],(function(){return!1})),CL=Ms(AL.prototype,"_castShadow",[lN],(function(){return!1})),RL=Ms(AL.prototype,"_receiveShadow",[dL],(function(){return!1})),xL=Ms(AL.prototype,"_lightmapSize",[lN],(function(){return 64})),wL=Ms(AL.prototype,"_useLightProbe",[lN],(function(){return!1})),kL=Ms(AL.prototype,"_bakeToLightProbe",[lN],(function(){return!0})),IL=Ms(AL.prototype,"_reflectionProbeType",[lN],(function(){return eN.NONE})),BL=Ms(AL.prototype,"_bakeToReflectionProbe",[lN],(function(){return!0})),PL=Ms(AL.prototype,"_probeCubemap",[lN],(function(){return null})),x(AL.prototype,"lightmapSize",[mL],Object.getOwnPropertyDescriptor(AL.prototype,"lightmapSize"),AL.prototype),x(AL.prototype,"useLightProbe",[pL],Object.getOwnPropertyDescriptor(AL.prototype,"useLightProbe"),AL.prototype),x(AL.prototype,"bakeToLightProbe",[vL],Object.getOwnPropertyDescriptor(AL.prototype,"bakeToLightProbe"),AL.prototype),x(AL.prototype,"reflectionProbe",[yL],Object.getOwnPropertyDescriptor(AL.prototype,"reflectionProbe"),AL.prototype),x(AL.prototype,"bakeToReflectionProbe",[gL],Object.getOwnPropertyDescriptor(AL.prototype,"bakeToReflectionProbe"),AL.prototype),SL=AL))||SL),mN=(DL=aN("cc.MeshRenderer"),LL=oN(100),NL=uN(si),FL=uN(si),GL=uN(cN),VL=uN(_N),UL=uN(iO),DL(HL=LL(($L=ZL=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this)).bakeSettings=WL&&WL(),e._mesh=XL&&XL(),e._shadowCastingMode=jL&&jL(),e._shadowReceivingMode=qL&&qL(),e._shadowBias=YL&&YL(),e._shadowNormalBias=KL&&KL(),e._reflectionProbeId=QL&&QL(),e._reflectionProbeDataMap=null,e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,e._enableMorph=JL&&JL(),e._modelType=Cx,Dt.querySettings(Ot.Category.RENDERING,"highQualityMode")&&(e._shadowCastingMode=cN.ON,e.bakeSettings.castShadow=!0,e.bakeSettings.receiveShadow=!0),e}return s(i,[{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._updateShadowBias(),this._onUpdateLocalShadowBiasAndProbeId()}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._updateShadowNormalBias(),this._onUpdateLocalShadowBiasAndProbeId()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"onUpdateReceiveDirLight",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._model&&(t?this._model.receiveDirLight=!1:this.node&&(e&this.node.layer)===this.node.layer||e&this._model.visFlags?this._model.receiveDirLight=!0:this._model.receiveDirLight=!1)}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,i=this._mesh=e;null==i||i.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateUseLightProbe(),this._updateUseReflectionProbe(),this._updateReceiveDirLight()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}},{key:"onLoad",value:function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._updateUseLightProbe(),this._updateBakeToReflectionProbe(),this._updateUseReflectionProbe(),this._updateReceiveDirLight()}},{key:"onRestore",value:function(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._updateUseLightProbe(),this._updateBakeToReflectionProbe(),this._updateUseReflectionProbe(),this._updateReceiveDirLight()}},{key:"onEnable",value:function(){g(l(i.prototype),"onEnable",this).call(this),this.node.on(rp.MOBILITY_CHANGED,this.onMobilityChanged,this),this.node.on(rp.LIGHT_PROBE_BAKING_CHANGED,this.onLightProbeBakingChanged,this),this.bakeSettings.on(dN.USE_LIGHT_PROBE_CHANGED,this.onUseLightProbeChanged,this),this.bakeSettings.on(dN.REFLECTION_PROBE_CHANGED,this.onReflectionProbeChanged,this),this.bakeSettings.on(dN.BAKE_TO_REFLECTION_PROBE_CHANGED,this.onBakeToReflectionProbeChanged,this),this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._updateBakeToReflectionProbe(),this._updateUseReflectionProbe(),this._onUpdateLocalShadowBiasAndProbeId(),this._updateUseLightProbe(),this._updateReceiveDirLight(),this._onUpdateReflectionProbeDataMap(),this._attachToScene()}},{key:"onDisable",value:function(){this._model&&this._detachFromScene(),this.node.off(rp.MOBILITY_CHANGED,this.onMobilityChanged,this),this.node.off(rp.LIGHT_PROBE_BAKING_CHANGED,this.onLightProbeBakingChanged,this),this.bakeSettings.off(dN.USE_LIGHT_PROBE_CHANGED,this.onUseLightProbeChanged,this),this.bakeSettings.off(dN.REFLECTION_PROBE_CHANGED,this.onReflectionProbeChanged,this),this.bakeSettings.off(dN.BAKE_TO_REFLECTION_PROBE_CHANGED,this.onBakeToReflectionProbeChanged,this)}},{key:"onDestroy",value:function(){this._model&&(B.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}},{key:"onGeometryChanged",value:function(){if(this._model&&this._mesh){var e=this._mesh.struct;this._model.createBoundingShape(e.minPosition,e.maxPosition),this._model.updateWorldBound(),this._model.onGeometryChanged()}}},{key:"getWeight",value:function(e,t){this._subMeshShapesWeights.length;var i=this._subMeshShapesWeights[e];return i.length,i[t]}},{key:"setWeights",value:function(e,t){var i=this._subMeshShapesWeights;t>=i.length||i[t].length===e.length&&(i[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))}},{key:"setWeight",value:function(e,t,i){var n=this._subMeshShapesWeights;if(!(t>=n.length)){var r=n[t];i>=r.length||(r[i]=e,this._uploadSubMeshShapesWeights(t))}}},{key:"setInstancedAttribute",value:function(e,t){if(this.model)for(var i=this.model.subModels,n=0;n<i.length;n++)for(var r=i[n].instancedAttributeBlock,s=r.attributes,a=r.views,o=0;o<s.length;o++)if(s[o].name===e){a[o].set(t);break}}},{key:"_updateLightmap",value:function(e,t,i,n,r){this.bakeSettings.texture=e,this.bakeSettings.uvParam.x=t,this.bakeSettings.uvParam.y=i,this.bakeSettings.uvParam.z=n,this.bakeSettings.uvParam.w=r,this._onUpdateLightingmap(),this._updateReceiveDirLight()}},{key:"updateProbeCubemap",value:function(e,t){if((!this.bakeSettings._probeCubemap||this.bakeSettings._probeCubemap!==e)&&(this.bakeSettings._probeCubemap=e,null!==this.model)){var i=this.bakeSettings._probeCubemap;i||!this.node.scene||t||(i=this.node.scene._globals.skybox.envmap),this.model.updateReflectionProbeCubemap(i)}}},{key:"updateProbePlanarMap",value:function(e){this.bakeSettings._probePlanarmap!==e&&(this.bakeSettings._probePlanarmap=e,null!==this.model&&this.model.updateReflectionProbePlanarMap(this.bakeSettings._probePlanarmap))}},{key:"updateReflectionProbeDataMap",value:function(e){this._reflectionProbeDataMap=e,null!==this.model&&this.model.updateReflectionProbeDataMap(e)}},{key:"updateReflectionProbeId",value:function(e){this._reflectionProbeId=e,this.model&&(this.model.reflectionProbeId=e),this._onUpdateLocalShadowBiasAndProbeId()}},{key:"_updateReflectionProbeTexture",value:function(){if(null!==this.model)if(this.bakeSettings.reflectionProbe===eN.BAKED_CUBEMAP){var e=this.bakeSettings._probeCubemap;!e&&this.node.scene&&(e=this.node.scene._globals.skybox.envmap),this.model.updateReflectionProbeCubemap(e),this.model.updateReflectionProbePlanarMap(null)}else this.bakeSettings.reflectionProbe===eN.PLANAR_REFLECTION?(this.model.updateReflectionProbePlanarMap(this.bakeSettings._probePlanarmap),this.model.updateReflectionProbeCubemap(null)):(this.model.updateReflectionProbeCubemap(null),this.model.updateReflectionProbePlanarMap(null))}},{key:"_updateModels",value:function(){if(this.enabledInHierarchy){var e=this._model;if(e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model){if(this._mesh){var t=this._mesh.struct;this._model.createBoundingShape(t.minPosition,t.maxPosition)}this._model.initLightingmap(this.bakeSettings.texture,this.bakeSettings.uvParam),this._updateUseLightProbe(),this._updateModelParams(),this._onUpdateLightingmap(),this._onUpdateLocalShadowBiasAndProbeId(),this._updateUseReflectionProbe(),this._updateReceiveDirLight(),this._onUpdateReflectionProbeDataMap()}}}},{key:"_updateReceiveDirLight",value:function(){if(this._model){var e=this.node.scene;if(e&&e.renderScene){var t=e.renderScene.mainLight;if(t){var i=t.visibility;t.node&&(t.node.mobility===Ep.Static&&(this.bakeSettings.texture||this.node.scene.globals.lightProbeInfo.data&&this.node.scene.globals.lightProbeInfo.data.hasCoefficients()&&this._model.useLightProbe)?this.onUpdateReceiveDirLight(i,!0):this.onUpdateReceiveDirLight(i))}}}}},{key:"_createModel",value:function(){var e=this._morphInstance&&this._modelType===Cx?QO:this._modelType,t=this._model=B.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof QO&&t.setMorphRendering(this._morphInstance)}},{key:"_attachToScene",value:function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}}},{key:"_detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=ip.POSITION,this._model.transform.hasChangedFlags|=ip.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var i=0;i<e;++i){var n=this.getRenderMaterial(i);n&&!n.isValid&&(n=null);var r=t[i];r&&this._model.initSubModel(i,r,n||this._getBuiltinMaterial())}this._model.enabled=!0}}},{key:"_onUpdateLightingmap",value:function(){null!==this.model&&this.model.updateLightingmap(this.bakeSettings.texture,this.bakeSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.bakeSettings.uvParam.x,this.bakeSettings.uvParam.y,this.bakeSettings.uvParam.z,this.bakeSettings.uvParam.w])}},{key:"_onUpdateLocalShadowBiasAndProbeId",value:function(){null!==this.model&&(this.model.updateLocalShadowBias(),this.model.updateReflectionProbeId()),this.setInstancedAttribute("a_localShadowBiasAndProbeId",[this._shadowBias,this._shadowNormalBias,this._reflectionProbeId,0])}},{key:"_onUpdateReflectionProbeDataMap",value:function(){null!==this.model&&this.model.updateReflectionProbeDataMap(this._reflectionProbeDataMap)}},{key:"_onMaterialModified",value:function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap(),this._onUpdateLocalShadowBiasAndProbeId(),this._updateReflectionProbeTexture(),this._onUpdateReflectionProbeDataMap())}},{key:"_onMeshChanged",value:function(){}},{key:"_clearMaterials",value:function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)}},{key:"_getBuiltinMaterial",value:function(){return HS.get("missing-material")}},{key:"_onVisibilityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateShadowBias",value:function(){this._model&&(this._model.shadowBias=this._shadowBias)}},{key:"_updateShadowNormalBias",value:function(){this._model&&(this._model.shadowNormalBias=this._shadowNormalBias)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===cN.OFF?this._model.castShadow=!1:(this._shadowCastingMode,cN.ON,"ShadowCastingMode ".concat(this._shadowCastingMode," is not supported."),this._model.castShadow=!0))}},{key:"_updateReceiveShadow",value:function(){this._model&&(this._shadowReceivingMode===_N.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}},{key:"onMobilityChanged",value:function(){this._updateUseLightProbe(),this._updateReceiveDirLight()}},{key:"onLightProbeBakingChanged",value:function(){this._updateReceiveDirLight()}},{key:"onUseLightProbeChanged",value:function(){this._updateUseLightProbe()}},{key:"onReflectionProbeChanged",value:function(){this._updateUseReflectionProbe(),this._onUpdateLocalShadowBiasAndProbeId(),this.bakeSettings.reflectionProbe===eN.BAKED_CUBEMAP?(B.internal.reflectionProbeManager.updateUseCubeModels(this._model),B.internal.reflectionProbeManager.getUsedReflectionProbe(this._model,eN.BAKED_CUBEMAP)||ae(16302)):this.bakeSettings.reflectionProbe===eN.PLANAR_REFLECTION&&(B.internal.reflectionProbeManager.updateUsePlanarModels(this._model),B.internal.reflectionProbeManager.getUsedReflectionProbe(this._model,eN.PLANAR_REFLECTION)||ae(16302))}},{key:"onBakeToReflectionProbeChanged",value:function(){this._updateBakeToReflectionProbe()}},{key:"_updateUseLightProbe",value:function(){if(this._model){var e=this.node;this._mesh&&e&&e.mobility===Ep.Movable&&this.bakeSettings.useLightProbe?this._model.useLightProbe=!0:this._model.useLightProbe=!1}}},{key:"_isBatchingEnabled",value:function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var i=0;i<t.passes.length;++i)if(t.passes[i].batchingScheme)return!0}return!1}},{key:"_updateUseReflectionProbe",value:function(){this._model&&(this._model.reflectionProbeType=this.bakeSettings.reflectionProbe,this._updateReflectionProbeTexture())}},{key:"_updateBakeToReflectionProbe",value:function(){this._model&&(this._model.bakeToReflectionProbe=this.bakeSettings.bakeToReflectionProbe)}},{key:"_watchMorphInMesh",value:function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof QO&&this._model.setMorphRendering(this._morphInstance)}}},{key:"_initSubMeshShapesWeights",value:function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var i=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):i?(i.length,e.targets.length,i.slice(0)):new Array(e.targets.length).fill(0):[]}))}}}},{key:"_validateShapeWeights",value:function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var i=e.struct.morph;return i.subMeshMorphs.length===t.length&&t.every((function(e,t){var n,r,s=e.length;return(null!==(n=null===(r=i.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==n?n:0)===s}))}},{key:"_uploadSubMeshShapesWeights",value:function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])}}]),i}(sN),ZL.ShadowCastingMode=cN,ZL.ShadowReceivingMode=_N,WL=Ms((zL=$L).prototype,"bakeSettings",[lN],(function(){return new dN(this)})),XL=Ms(zL.prototype,"_mesh",[lN],(function(){return null})),jL=Ms(zL.prototype,"_shadowCastingMode",[lN],(function(){return cN.OFF})),qL=Ms(zL.prototype,"_shadowReceivingMode",[lN],(function(){return _N.ON})),YL=Ms(zL.prototype,"_shadowBias",[lN],(function(){return 0})),KL=Ms(zL.prototype,"_shadowNormalBias",[lN],(function(){return 0})),QL=Ms(zL.prototype,"_reflectionProbeId",[lN],(function(){return-1})),x(zL.prototype,"shadowBias",[NL],Object.getOwnPropertyDescriptor(zL.prototype,"shadowBias"),zL.prototype),x(zL.prototype,"shadowNormalBias",[FL],Object.getOwnPropertyDescriptor(zL.prototype,"shadowNormalBias"),zL.prototype),x(zL.prototype,"shadowCastingMode",[GL],Object.getOwnPropertyDescriptor(zL.prototype,"shadowCastingMode"),zL.prototype),x(zL.prototype,"receiveShadow",[VL],Object.getOwnPropertyDescriptor(zL.prototype,"receiveShadow"),zL.prototype),x(zL.prototype,"mesh",[UL],Object.getOwnPropertyDescriptor(zL.prototype,"mesh"),zL.prototype),JL=Ms(zL.prototype,"_enableMorph",[lN],(function(){return!0})),HL=zL))||HL)||HL),pN=ep.makeMaskExclude([ep.BitMask.UI_2D,ep.BitMask.UI_3D,ep.BitMask.GIZMOS,ep.BitMask.EDITOR,ep.BitMask.SCENE_GIZMO,ep.BitMask.PROFILER,ep.Enum.IGNORE_RAYCAST]),vN=e("ReflectionProbeManager",function(){function e(){n(this,e),this._probes=[],this._useCubeModels=new Map,this._usePlanarModels=new Map,this._updateForRuntime=!0,this._dataTexture=null,this._registeredEvent=!1}return s(e,[{key:"updateForRuntime",get:function(){return this._updateForRuntime},set:function(e){this._updateForRuntime=e}},{key:"registerEvent",value:function(){this._registeredEvent||(B.director.on(B.Director.EVENT_BEFORE_UPDATE,this.onUpdateProbes,this),this._registeredEvent=!0)}},{key:"onUpdateProbes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._updateForRuntime&&0!==this._probes.length){var t=B.director.getScene();if(t&&t.renderScene)for(var i=t.renderScene.models,n=0;n<i.length;n++){var r=i[n];r.node&&r.node.layer&pN&&(r.node.hasChangedFlags||e)&&(r.reflectionProbeType===eN.BAKED_CUBEMAP?this.updateUseCubeModels(r):r.reflectionProbeType===eN.PLANAR_REFLECTION&&this.updateUsePlanarModels(r))}}}},{key:"filterModelsForPlanarReflection",value:function(){if(0!==this._probes.length){var e=B.director.getScene();if(e&&e.renderScene)for(var t=e.renderScene.models,i=0;i<t.length;i++){var n=t[i];n.node&&n.node.layer&pN&&n.reflectionProbeType===eN.PLANAR_REFLECTION&&this.updateUsePlanarModels(n)}}}},{key:"clearPlanarReflectionMap",value:function(e){for(var t,i=R(this._usePlanarModels.entries());!(t=i()).done;){var n=t.value;n[1]===e&&this._updatePlanarMapOfModel(n[0],null,null)}}},{key:"register",value:function(e){-1===this._probes.indexOf(e)&&(this._probes.push(e),this.updateProbeData())}},{key:"unregister",value:function(e){for(var t=0;t<this._probes.length;t++)if(this._probes[t]===e){var i=this._probes.splice(t,1);i[0]&&this._removeDependentModels(i[0]);break}this.updateProbeData()}},{key:"exists",value:function(e){if(0===this._probes.length)return!1;for(var t=0;t<this._probes.length;t++)if(this._probes[t].getProbeId()===e)return!0;return!1}},{key:"getNewReflectionProbeId",value:function(){for(var e=0;;){if(!this.exists(e))return e;e++}}},{key:"getProbes",value:function(){return this._probes}},{key:"getProbeById",value:function(e){for(var t=0;t<this._probes.length;t++)if(this._probes[t].getProbeId()===e)return this._probes[t];return null}},{key:"clearAll",value:function(){this._probes=[]}},{key:"getProbeByCamera",value:function(e){for(var t=0;t<this._probes.length;t++)if(this._probes[t].camera===e)return this._probes[t];return null}},{key:"updateBakedCubemap",value:function(e){var t=this._getModelsByProbe(e);if(e.cubemap){for(var i=0;i<t.length;i++){var n=t[i];this._updateCubemapOfModel(n,e)}e.needRefresh=!1}}},{key:"updatePlanarMap",value:function(e,t){if(e.node&&e.node.scene){for(var i=this._getModelsByProbe(e),n=0;n<i.length;n++)this._updatePlanarMapOfModel(i[n],t,e);if(e.previewPlane){var r=e.previewPlane.getComponent(mN);r&&r.updateProbePlanarMap(t)}}}},{key:"updateUsePlanarModels",value:function(e){if(e.node&&e.worldBounds&&e.reflectionProbeType===eN.PLANAR_REFLECTION){for(var t=0;t<this._probes.length;t++){var i=this._probes[t];i.probeType===hx.PLANAR&&e.node.layer&pN&&(e.updateWorldBound(),is.aabbWithAABB(e.worldBounds,i.boundingBox)?this._usePlanarModels.set(e,i):this._usePlanarModels.has(e)&&this._usePlanarModels.get(e)===i&&(this._usePlanarModels.delete(e),this._updatePlanarMapOfModel(e,null,null)))}for(var n=0;n<this._probes.length;n++)this._probes[n].probeType===hx.PLANAR&&(this._probes[n].realtimePlanarTexture?this.updatePlanarMap(this._probes[n],this._probes[n].realtimePlanarTexture.getGFXTexture()):this.updatePlanarMap(this._probes[n],null))}}},{key:"updateUseCubeModels",value:function(e){if(e.node&&e.worldBounds&&e.node.layer&pN){e.updateWorldBound();var t=this._getNearestProbe(e);t?this._useCubeModels.has(e)?this._useCubeModels.get(e)!==t&&(this._useCubeModels.set(e,t),t.needRefresh=!0):(this._useCubeModels.set(e,t),t.needRefresh=!0):(this._updateCubemapOfModel(e,null),this._useCubeModels.delete(e))}for(var i=0;i<this._probes.length;i++)this._probes[i].needRefresh&&this._probes[i].probeType===hx.CUBE&&this.updateBakedCubemap(this._probes[i])}},{key:"updatePreviewSphere",value:function(e){if(e&&e.previewSphere){var t=e.previewSphere.getComponent(mN);t&&t.updateProbeCubemap(e.cubemap,!e.cubemap)}}},{key:"updatePreviewPlane",value:function(e){e&&e.previewPlane&&e.previewPlane.getComponent(mN)&&e.realtimePlanarTexture&&this.updatePlanarMap(e,e.realtimePlanarTexture.getGFXTexture())}},{key:"updateProbeData",value:function(){if(0!==this._probes.length){var e=this.getMaxProbeId(),t=e+1;this._dataTexture&&this._dataTexture.destroy();for(var i=new Float32Array(12*t),n=0,r=0;r<=e;r++){var s=this.getProbeById(r);s?(s.probeType===hx.CUBE?(i[n]=s.node.worldPosition.x,i[n+1]=s.node.worldPosition.y,i[n+2]=s.node.worldPosition.z,i[n+3]=0,i[n+4]=s.size.x,i[n+5]=s.size.y,i[n+6]=s.size.z,i[n+7]=0,i[n+8]=s.cubemap?s.cubemap.mipmapLevel:1):(i[n]=s.node.up.x,i[n+1]=s.node.up.y,i[n+2]=s.node.up.z,i[n+3]=1,i[n+4]=1,i[n+5]=1,i[n+6]=0,i[n+7]=0,i[n+8]=1),n+=12):n+=12}var a=new Uint8Array(i.buffer),o=new bd({_data:a,_compressed:!1,width:12,height:t,format:td.RGBA8888});this._dataTexture=new Qm,this._dataTexture.setFilters(Qm.Filter.NONE,Qm.Filter.NONE),this._dataTexture.setMipFilter(Qm.Filter.NONE),this._dataTexture.setWrapMode(Qm.WrapMode.CLAMP_TO_EDGE,Qm.WrapMode.CLAMP_TO_EDGE,Qm.WrapMode.CLAMP_TO_EDGE),this._dataTexture.image=o,this._dataTexture.uploadData(a);for(var u=0;u<this._probes.length;u++)for(var h=this._probes[u],l=this._getModelsByProbe(h),c=0;c<l.length;c++){var _=l[c].node.getComponent(mN);_&&(_.updateReflectionProbeDataMap(this._dataTexture),_.updateReflectionProbeId(h.getProbeId()))}}}},{key:"getMaxProbeId",value:function(){return 0===this._probes.length?-1:1===this._probes.length?this._probes[0].getProbeId():(this._probes.sort((function(e,t){return e.getProbeId()-t.getProbeId()})),this._probes[this._probes.length-1].getProbeId())}},{key:"getUsedReflectionProbe",value:function(e,t){if(t===eN.BAKED_CUBEMAP){if(this._useCubeModels.has(e))return this._useCubeModels.get(e)}else if(t===eN.PLANAR_REFLECTION&&this._usePlanarModels.has(e))return this._usePlanarModels.get(e);return null}},{key:"_getNearestProbe",value:function(e){if(!e.node||!e.worldBounds||0===this._probes.length)return null;for(var t,i=null,n=1/0,r=R(this._probes);!(t=r()).done;){var s=t.value;if(s.probeType===hx.CUBE&&s.validate()&&is.aabbWithAABB(e.worldBounds,s.boundingBox)){var a=an.distance(e.node.worldPosition,s.node.worldPosition);a<n&&(n=a,i=s)}}return i}},{key:"_getBlendProbe",value:function(e){if(0===this._probes.length)return null;if(!e.node||!e.worldBounds)return null;for(var t=[],i=0;i<this._probes.length;i++)this._probes[i].probeType===hx.CUBE&&this._probes[i].validate()&&is.aabbWithAABB(e.worldBounds,this._probes[i].boundingBox)&&t.push(this._probes[i]);return t.sort((function(t,i){var n=an.distance(e.node.worldPosition,t.node.worldPosition);return an.distance(e.node.worldPosition,i.node.worldPosition)-n})),t.length>1?t[1]:null}},{key:"_getModelsByProbe",value:function(e){var t=[],i=this._useCubeModels;e.probeType===hx.PLANAR&&(i=this._usePlanarModels);for(var n,r=R(i.entries());!(n=r()).done;){var s=n.value;s[1]===e&&t.push(s[0])}return t}},{key:"_removeDependentModels",value:function(e){for(var t,i=R(this._useCubeModels.keys());!(t=i()).done;){var n=t.value,r=this._useCubeModels.get(n);void 0!==r&&r===e&&(this._useCubeModels.delete(n),this.updateUseCubeModels(n))}for(var s,a=R(this._usePlanarModels.keys());!(s=a()).done;){var o=s.value,u=this._usePlanarModels.get(o);void 0!==u&&u===e&&(this._usePlanarModels.delete(o),this.updateUsePlanarModels(o))}}},{key:"_updateCubemapOfModel",value:function(e,t){if(e.node){var i=e.node.getComponent(mN);i&&(i.updateProbeCubemap(t?t.cubemap:null),i.updateReflectionProbeId(t?t.getProbeId():-1),t&&i.updateReflectionProbeDataMap(this._dataTexture))}}},{key:"_updatePlanarMapOfModel",value:function(e,t,i){var n=e.node.getComponent(mN);n&&(n.updateProbePlanarMap(t),n.updateReflectionProbeId(i?i.getProbeId():-1),i&&n.updateReflectionProbeDataMap(this._dataTexture))}}]),e}());function yN(){var e=new lM;return e.initialize({flows:[]}),e}vN.probeManager=void 0,vN.probeManager=new vN,B.internal.reflectionProbeManager=vN.probeManager;var gN=(a(fN={},fl.PORTRAIT,Ol.IDENTITY),a(fN,fl.LANDSCAPE_RIGHT,Ol.ROTATE_90),a(fN,fl.PORTRAIT_UPSIDE_DOWN,Ol.ROTATE_180),a(fN,fl.LANDSCAPE_LEFT,Ol.ROTATE_270),fN),SN=function(){function e(){n(this,e),this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null,this._device=null}return s(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"initialize",value:function(e,t){if(void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._device=e,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._swapchain=t.swapchain,this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var i=0;i<t.renderPassInfo.colorAttachments.length;i++)this._colorTextures.push(e.createTexture(new Wc(zl.TEX2D,Wl.COLOR_ATTACHMENT|Wl.SAMPLED|Wl.TRANSFER_SRC,t.renderPassInfo.colorAttachments[i].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==Ll.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new Wc(zl.TEX2D,Wl.DEPTH_STENCIL_ATTACHMENT|Wl.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)),this._hasOffScreenAttachments=!0)}return this._framebuffer=e.createFramebuffer(new f_(this._renderPass,this._colorTextures,this._depthStencilTexture)),!0}},{key:"destroy",value:function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._device=null}},{key:"resize",value:function(e,t){if(this._swapchain)this._swapchain.resize(e,t,gN[vl.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var i=0;i<this._colorTextures.length;i++)this._colorTextures[i].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this._framebuffer=this._device.createFramebuffer(new f_(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var n,r=R(this._cameras);!(n=r()).done;)n.value.resize(e,t)}},{key:"extractRenderCameras",value:function(e){for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t];i.enabled&&(i.update(),e.push(i))}}},{key:"attachCamera",value:function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()}},{key:"detachCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)}},{key:"clearCameras",value:function(){this._cameras.length=0}},{key:"sortCameras",value:function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))}}],[{key:"registerCreateFunc",value:function(t){t._createWindowFun=function(t){return new e(t)}}}]),e}(),AN=e("Root",function(){function e(t){var i=this;n(this,e),this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._usesCustomPipeline=!0,this._pipeline=null,this._pipelineEvent=null,this._classicPipeline=null,this._customPipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._debugView=new Hw,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._cameraList=[],this._device=t,this._dataPoolMgr=B.internal.DataPoolManager&&new B.internal.DataPoolManager(t),zO.registerCreateFunc(this),SN.registerCreateFunc(this),this._cameraPool=new Eh((function(){return new KR(i._device)}),4,(function(e){return e.destroy()}))}return s(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"usesCustomPipeline",get:function(){return this._usesCustomPipeline}},{key:"pipeline",get:function(){return this._pipeline}},{key:"customPipeline",get:function(){return this._customPipeline}},{key:"pipelineEvent",get:function(){return this._pipelineEvent}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"debugView",get:function(){return this._debugView}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}},{key:"cameraList",get:function(){return this._cameraList}},{key:"initialize",value:function(){var e,t=yf.swapchain,i=new s_;i.format=t.colorTexture.format;var n=new a_;n.format=t.depthStencilTexture.format,n.depthStoreOp=rc.DISCARD,n.stencilStoreOp=rc.DISCARD;var r=new h_([i],n);this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:r,swapchain:t}),this._curWindow=this._mainWindow;var s=Dt.querySettings(Ot.Category.ANIMATION,"customJointTextureLayouts")||[];null===(e=this._dataPoolMgr)||void 0===e||e.jointTexturePool.registerCustomTextureLayouts(s),this._resizeMaxJointForDS()}},{key:"destroy",value:function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null,this._pipelineEvent=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),B.rendering&&B.rendering.destroy()}},{key:"resize",value:function(e,t){for(var i,n=R(this._windows);!(i=n()).done;){var r=i.value;r.swapchain&&r.resize(e,t)}}},{key:"setRenderPipeline",value:function(e){var t=B.internal,i=B.director,n=B.rendering;e instanceof zM&&(this._useDeferredPipeline=!0);var r=!1;if(e||(e=yN(),r=!0),this._useDeferredPipeline&&this.device.hasFeature(Dl.COMPUTE_SHADER)||(e.clusterEnabled=!1),e.bloomEnabled=!1,""!==Lt.CUSTOM_PIPELINE_NAME&&n&&this.usesCustomPipeline?(this._customPipeline=n.createCustomPipeline(),r=!0,this._pipeline=this._customPipeline):(this._classicPipeline=e,this._pipeline=this._classicPipeline,this._pipelineEvent=this._classicPipeline,this._usesCustomPipeline=!1),(Dt.querySettings(Ot.Category.RENDERING,"renderMode")!==_f.HEADLESS||this._classicPipeline)&&!this._pipeline.activate(this._mainWindow.swapchain))return r&&this._pipeline.destroy(),this._classicPipeline=null,this._customPipeline=null,this._pipeline=null,this._pipelineEvent=null,!1;var s=i.getScene();return s&&s.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&t.Batcher2D&&(this._batcher=new t.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.onGlobalPipelineStateChanged()}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._cumulativeTime=0}},{key:"frameMove",value:function(e){var t=B.director,i=B.Director;this._frameTime=e,++this._frameCount,this._cumulativeTime+=e,this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var n=0;n<this._scenes.length;++n)this._scenes[n].removeBatches();var r=this._windows,s=this._cameraList;s.length=0;for(var a=0;a<r.length;a++)r[a].extractRenderCameras(s);if(this._pipeline&&s.length>0){this._device.acquire([yf.swapchain]);var o=this._scenes,u=t.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var h=0;h<o.length;h++)o[h].update(u);t.emit(i.EVENT_BEFORE_COMMIT),s.sort((function(e,t){return e.priority-t.priority}));for(var l=0;l<s.length;++l){var c;null===(c=s[l].geometryRenderer)||void 0===c||c.update()}t.emit(i.EVENT_BEFORE_RENDER),this._pipeline.render(s),t.emit(i.EVENT_AFTER_RENDER),this._device.present()}this._batcher&&this._batcher.reset()}},{key:"createWindow",value:function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){for(var e,t=R(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){for(var e,t=R(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0}},{key:"createModel",value:function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new Eh((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var i=t.alloc();return i.initialize(),i}},{key:"destroyModel",value:function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):ae(1300,e.constructor.name),e.destroy()}},{key:"createCamera",value:function(){return this._cameraPool.alloc()}},{key:"createLight",value:function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new Eh((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var i=t.alloc();return i.initialize(),i}},{key:"destroyLight",value:function(e){if(e.scene)switch(e.type){case Tx.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case Tx.SPHERE:e.scene.removeSphereLight(e);break;case Tx.SPOT:e.scene.removeSpotLight(e)}e.destroy()}},{key:"recycleLight",value:function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case Tx.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case Tx.SPHERE:e.scene.removeSphereLight(e);break;case Tx.SPOT:e.scene.removeSpotLight(e)}}},{key:"_resizeMaxJointForDS",value:function(){var e=(vv.COUNT+yv.COUNT+gv.COUNT+Mv.COUNT+Ov.COUNT)/4,t=Math.floor((yf.gfxDevice.capabilities.maxVertexUniformVectors-e)/3);zv(t=t<256?t:256)}}]),e}());B.Root=AN;var TN=new(function(){function e(){n(this,e),this._allRenderers=[],this._dirtyRenderers=[],this._dirtyVersion=0}return s(e,[{key:"addRenderer",value:function(e){-1===e._internalId&&(e._internalId=this._allRenderers.length,this._allRenderers.push(e))}},{key:"removeRenderer",value:function(e){if(-1!==e._internalId){var t=e._internalId;this._allRenderers[this._allRenderers.length-1]._internalId=t,gt(this._allRenderers,t),e._internalId=-1,e._dirtyVersion===this._dirtyVersion&&(At(this._dirtyRenderers,e),e._dirtyVersion=-1)}}},{key:"markDirtyRenderer",value:function(e){e._dirtyVersion!==this._dirtyVersion&&-1!==e._internalId&&(this._dirtyRenderers.push(e),e._dirtyVersion=this._dirtyVersion)}},{key:"updateAllDirtyRenderers",value:function(){for(var e=this._dirtyRenderers.length,t=this._dirtyRenderers,i=0;i<e;i++)t[i].updateRenderer();this._dirtyRenderers.length=0,this._dirtyVersion++}}]),e}()),EN=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],bN=[".mp3",".ogg",".wav",".m4a"];function CN(){return!0}var RN={transformURL:function(e){var t=zf(e);if(!t)return e;var i=kf.find((function(e){return!!e.getAssetInfo(t)}));if(!i)return e;var n,r=i.getAssetInfo(t);if(!(n=e.startsWith(i.base+i.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(n))return e;var s=!1;if(".ttf"===tl(e)&&(s=!0),s){var a=rl(e),o=nl(e);e="".concat(a,".").concat(n,"/").concat(o)}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return"".concat(e,".").concat(n)}));return e}},xN=e("CCLoader",function(){function e(){n(this,e),this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=Lg}return s(e,[{key:"onProgress",set:function(e){wg=e}},{key:"_cache",get:function(){if(Rf instanceof Ef)return Rf._map;var e={};return Rf.forEach((function(t,i){e[i]=t})),e}},{key:"load",value:function(e,t,i){void 0===i&&void 0!==t&&(i=t,t=null);for(var n=Array.isArray(e)?e:[e],r=0;r<n.length;r++){var s=n[r];"string"==typeof s?n[r]={url:s,__isNative__:!0}:(s.type&&(s.ext=".".concat(s.type),s.type=void 0),s.url&&(s.__isNative__=!0))}var a=[],o=[];NS.loadAny(n,null,(function(e,i,n){n.content&&(EN.includes(n.ext)?a.push(n.content):bN.includes(n.ext)&&o.push(n.content)),t&&t(e,i,n)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var s=function(e){var i=t[e];if(!(i instanceof ed)){var r=i,s=n[e].url;a.includes(r)?AS.create(s,i,".png",{},(function(i,n){r=t[e]=n})):o.includes(r)&&AS.create(s,i,".mp3",{},(function(i,n){r=t[e]=n})),Rf.add(s,r)}},u=0;u<t.length;u++)s(u);if(t.length>1){var h=Object.create(null);t.forEach((function(e){h[e._uuid]=e})),r={isCompleted:CN,_map:h}}else r=t[0]}i&&i(e,r)}))}},{key:"getXMLHttpRequest",value:function(){return new XMLHttpRequest}},{key:"getItem",value:function(e){return NS.assets.has(e)?{content:NS.assets.get(e)}:null}},{key:"loadRes",value:function(e,t,i,n){var r=this._parseLoadResArgs(t,i,n),s=r.type,a=r.onProgress,o=r.onComplete,u=tl(e);u&&!Vg.getInfoWithPath(e,s)&&(e=e.slice(0,-u.length)),Vg.load(e,s,a,o)}},{key:"loadResArray",value:function(e,t,i,n){var r=this._parseLoadResArgs(t,i,n),s=r.type,a=r.onProgress,o=r.onComplete;e.forEach((function(t,i){var n=tl(t);n&&!Vg.getInfoWithPath(t,s)&&(e[i]=t.slice(0,-n.length))})),Vg.load(e,s,a,o)}},{key:"loadResDir",value:function(e,t,i,n){var r=this._parseLoadResArgs(t,i,n),s=r.type,a=r.onProgress,o=r.onComplete;Vg.loadDir(e,s,a,(function(t,i){var n=[];t||(n=Vg.getDirWithPath(e,s).map((function(e){return e.path}))),o&&o(t,i,n)}))}},{key:"getRes",value:function(e,t){return Rf.has(e)?Rf.get(e):Vg.get(e,t)}},{key:"getResCount",value:function(){return Rf.count}},{key:"getDependsRecursively",value:function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return Vm.getDepsRecursively(t).concat([t])}},{key:"md5Pipe",get:function(){return RN}},{key:"downloader",get:function(){return hS}},{key:"loader",get:function(){return NS.parser}},{key:"addDownloadHandlers",value:function(e){var t=Object.create(null),i=function(i){var n=e[i];t[".".concat(i)]=function(e,t,i){n({url:e},i)}};for(var n in e)i(n);hS.register(t)}},{key:"addLoadHandlers",value:function(e){var t=Object.create(null),i=function(i){var n=e[i];t[".".concat(i)]=function(e,t,i){n({content:e},i)}};for(var n in e)i(n);xS.register(t)}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];"string"==typeof i&&(i=Rf.get(i)),NS.releaseAsset(i)}else e&&("string"==typeof e&&(e=Rf.get(e)),NS.releaseAsset(e))}},{key:"releaseAsset",value:function(e){NS.releaseAsset(e)}},{key:"releaseRes",value:function(e,t){Vg.release(e,t)}},{key:"releaseAll",value:function(){NS.releaseAll(),Rf.clear()}},{key:"removeItem",value:function(e){return!!Rf.remove(e)}},{key:"setAutoRelease",value:function(e,t){"object"===i(e)&&(e=e._uuid),this._autoReleaseSetting[e]=!!t}},{key:"setAutoReleaseRecursively",value:function(e,t){"object"===i(e)&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=Vm.getDepsRecursively(e),r=0;r<n.length;r++)this._autoReleaseSetting[n[r]]=t}},{key:"isAutoRelease",value:function(e){return"object"===i(e)&&(e=e._uuid),!!this._autoReleaseSetting[e]}}]),e}()),wN=e("loader",new xN),kN=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,NS.init(e),e.rawAssets&&Vg.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:Of.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){NS.loadAny(e,t)}}),IN=e("url",{});me(IN,"url",[{name:"normalize",target:NS.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?qf({path:sl(e.substr(10)),bundle:Of.RESOURCES,__isNative__:!0,ext:tl(e)}):""}}]),pe(kN,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),pe(wN,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"loader.assetLoader was removed, assetLoader and md5Pipe were merged into assetManager.transformPipeline"}]),me(B,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return wN}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return kN}},{name:"Pipeline",target:LS,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return IN}}]),pe(B,"cc",[{name:"LoadingItems",suggest:_e(1400,"LoadingItems","AssetManager.Task")}]),me(Lt,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:hS,targetName:"assetManager.downloader",newName:"maxConcurrency"}]);var BN=xg._autoRelease;xg._autoRelease=function(e,t,i){BN.call(xg,e,t,i);for(var n=wN._autoReleaseSetting,r=Object.keys(n),s=0;s<r.length;s++){var a=r[s];if(!0===n[a]){var o=Rf.get(a);o&&xg.tryRelease(o)}}};var PN=e("Director",function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._persistRootNodes={},e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new Ph,e._compScheduler=new ED,e._nodeActivator=new MD,e._systems=[],e}return s(i,[{key:"calculateDeltaTime",value:function(){}},{key:"end",value:function(){var e=this;this.once(i.EVENT_END_FRAME,(function(){e.purgeDirector()}))}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),Ha(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),NS.releaseAll()}},{key:"reset",value:function(){var e;for(var t in this.purgeDirector(),this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[t]);null===(e=this.getScene())||void 0===e||e.destroy(),this.emit(i.EVENT_RESET),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,n){var r=this;e instanceof NC&&(e=e.scene),ce(e instanceof LC,1216),e._load();for(var s=Object.keys(this._persistRootNodes).map((function(e){return r._persistRootNodes[e]})),a=0;a<s.length;a++){var o=s[a];o.emit(Jp.EventType.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var u=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(u){var h=u.getSiblingIndex();o.hideFlags&=~Ga.Flags.DontSave,o.hideFlags|=Ga.Flags.DontSave&u.hideFlags,u._destroyImmediate(),e.insertChild(o,h)}else o.hideFlags|=Ga.Flags.DontSave,o.parent=e}var l=this._scene;Ha(l)&&l.destroy(),NS._releaseManager._autoRelease(l,e,this._persistRootNodes),this._scene=null,Ga._deferredDestroy(),t&&t(),this.emit(i.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(i.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,n){var r=this;e instanceof NC&&(e=e.scene),ce(e,1205),ce(e instanceof LC,1216),this.once(i.EVENT_END_FRAME,(function(){r.runSceneImmediate(e,t,n)}))}},{key:"loadScene",value:function(e,t,n){var r=this;if(this._loadingScene)return ae(1208,e,this._loadingScene),!1;var s=NS.bundles.find((function(t){return!!t.getSceneInfo(e)}));return s?(this.emit(i.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene ".concat(e)),s.loadScene(e,(function(i,s){console.timeEnd("LoadScene ".concat(e)),r._loadingScene="",i?(J(i),t&&t(i)):r.runSceneImmediate(s,n,t)})),!0):(ue(1209,e),!1)}},{key:"preloadScene",value:function(e,t,i){var n=NS.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(n)n.preloadScene(e,null,t,i);else{var r='Can not preload the scene "'.concat(e,'" because it is not in the build settings.');i&&i(new Error(r)),J("preloadScene: ".concat(r))}}},{key:"resume",value:function(){this._paused&&(this._paused=!1)}},{key:"root",get:function(){return this._root}},{key:"getScene",value:function(){return this._scene}},{key:"getDeltaTime",value:function(){return B.game.deltaTime}},{key:"getTotalTime",value:function(){return B.game.totalTime}},{key:"getCurrentTime",value:function(){return B.game.frameStartTime}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(Ph.ID,e,200))}},{key:"registerSystem",value:function(e,t,i){t.id=e,t.priority=i,this._systems.push(t),this._systems.sort(Rh.sortByPriority)}},{key:"unregisterSystem",value:function(e){At(this._systems,e),this._systems.sort(Rh.sortByPriority)}},{key:"getSystem",value:function(e){return this._systems.find((function(t){return t.id===e}))}},{key:"getAnimationManager",value:function(){return this.getSystem(B.AnimationManager.ID)}},{key:"startAnimation",value:function(){this._invalid=!1}},{key:"stopAnimation",value:function(){this._invalid=!0}},{key:"mainLoop",value:function(e){var t;t=B.game._calculateDT(e),this.tick(t)}},{key:"tick",value:function(e){if(!this._invalid){if(this.emit(i.EVENT_BEGIN_FRAME),IR._frameDispatchEvents(),!this._paused){this.emit(i.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(i.EVENT_AFTER_UPDATE),Ga._deferredDestroy();for(var n=0;n<this._systems.length;++n)this._systems[n].postUpdate(e)}this.emit(i.EVENT_BEFORE_DRAW),TN.updateAllDirtyRenderers(),this._root.frameMove(e),this.emit(i.EVENT_AFTER_DRAW),Jp.resetHasChangedFlags(),Jp.clearNodeArray(),Th.update(e),this.emit(i.EVENT_END_FRAME),this._totalFrames++}}},{key:"buildRenderPipeline",value:function(){this._root&&(this._root.customPipeline.beginSetup(),B.rendering.getCustomPipeline(Lt.CUSTOM_PIPELINE_NAME).setup(this._root.cameraList,this._root.customPipeline),this._root.customPipeline.endSetup())}},{key:"setupRenderPipelineBuilder",value:function(){""!==Lt.CUSTOM_PIPELINE_NAME&&B.rendering&&this._root&&this._root.usesCustomPipeline&&this.on(i.EVENT_BEFORE_RENDER,this.buildRenderPipeline,this)}},{key:"init",value:function(){this._totalFrames=0,this._paused=!1,this.registerSystem(Ph.ID,this._scheduler,200),this._root=new AN(yf.gfxDevice),this._root.initialize({}),this.setupRenderPipelineBuilder();for(var e=0;e<this._systems.length;e++)this._systems[e].init();this.emit(i.EVENT_INIT)}},{key:"addPersistRootNode",value:function(e){if(Jp.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=this._scene;if(Ha(i))if(e.parent){if(!(e.parent instanceof LC))return void ae(3801);if(e.parent!==i)return void ae(3802);e._originalSceneId=i.uuid}else e.parent=i,e._originalSceneId=i.uuid;this._persistRootNodes[t]=e,e._persistNode=!0,NS._releaseManager._addPersistNodeRef(e)}}else ae(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",NS._releaseManager._removePersistNodeRef(e))}},{key:"isPersistRootNode",value:function(e){return!!e._persistNode}}]),i}(Hh));PN.EVENT_INIT="director_init",PN.EVENT_RESET="director_reset",PN.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",PN.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",PN.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",PN.EVENT_BEFORE_UPDATE="director_before_update",PN.EVENT_AFTER_UPDATE="director_after_update",PN.EVENT_BEFORE_DRAW="director_before_draw",PN.EVENT_AFTER_DRAW="director_after_draw",PN.EVENT_BEFORE_COMMIT="director_before_commit",PN.EVENT_BEFORE_RENDER="director_before_render",PN.EVENT_AFTER_RENDER="director_after_render",PN.EVENT_BEFORE_PHYSICS="director_before_physics",PN.EVENT_AFTER_PHYSICS="director_after_physics",PN.EVENT_BEGIN_FRAME="director_begin_frame",PN.EVENT_END_FRAME="director_end_frame",PN.instance=void 0,B.Director=PN;var MN,ON,DN=e("director",PN.instance=B.director=new PN),LN=function(){function e(){n(this,e),this._rafHandle=0,this._stHandle=0,this._onTick=null,this._targetFrameRate=60,this._frameTime=0,this._startTime=0,this._isPlaying=!1,this._rAF=void 0,this._cAF=void 0,this._rAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime.bind(this),this._cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime.bind(this)}return s(e,[{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){this._targetFrameRate!==e&&(this._targetFrameRate=e,this._frameTime=1e3/this._targetFrameRate,this._isPlaying&&(this.stop(),this.start()))}},{key:"onTick",get:function(){return this._onTick},set:function(e){this._onTick=e}},{key:"start",value:function(){var e=this;this._isPlaying||(60===this._targetFrameRate?this._rafHandle=this._rAF.call(window,(function t(){e._isPlaying&&(e._rafHandle=e._rAF.call(window,t)),e._onTick&&e._onTick()})):(this._startTime=performance.now(),this._stHandle=this._stTime((function t(){e._startTime=performance.now(),e._isPlaying&&(e._stHandle=e._stTime(t)),e._onTick&&e._onTick()}))),this._isPlaying=!0)}},{key:"stop",value:function(){this._isPlaying&&(this._cAF.call(window,this._rafHandle),this._ctTime(this._stHandle),this._rafHandle=this._stHandle=0,this._isPlaying=!1)}},{key:"_stTime",value:function(e){var t=performance.now(),i=Math.max(0,t-this._startTime),n=Math.max(0,this._frameTime-i);return setTimeout(e,n)}},{key:"_ctTime",value:function(e){clearTimeout(e)}}]),e}();!function(e){e[e.NONE=-1]="NONE",e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT"}(MN||(MN={})),function(e){e[e.SESSION_RUNNING=2]="SESSION_RUNNING",e[e.VIEW_COUNT=6]="VIEW_COUNT",e[e.SWAPCHAIN_WIDTH=7]="SWAPCHAIN_WIDTH",e[e.SWAPCHAIN_HEIGHT=8]="SWAPCHAIN_HEIGHT",e[e.DEVICE_IPD=37]="DEVICE_IPD",e[e.SPLIT_AR_GLASSES=42]="SPLIT_AR_GLASSES"}(ON||(ON={}));var NN=new In,FN=function(){function e(){n(this,e),this._curTime=0,this.isMobile=!1,this.bgWidth=1920,this.bgHeight=1080,this.bgRatio=16/9,this.logoWidthTemp=140,this.logoHeightTemp=200,this.logoWidth=0,this.logoHeight=0,this.logoXTrans=.5,this.logoYTrans=1/6+2.5/6,this.textSize=24,this.textHeight=24,this.textXTrans=.5,this.textYExtraTrans=32,this.textExpandSize=4,this.scaleSize=1}return s(e,[{key:"isFinished",get:function(){return this._curTime>=this.settings.totalTime}},{key:"curTime",get:function(){return this._curTime},set:function(e){this._curTime=e}},{key:"init",value:function(){var e,t,i,n,r,s,a,o,u=this;if(this.settings={displayRatio:null!==(e=Dt.querySettings(Ot.Category.SPLASH_SCREEN,"displayRatio"))&&void 0!==e?e:.4,totalTime:null!==(t=Dt.querySettings(Ot.Category.SPLASH_SCREEN,"totalTime"))&&void 0!==t?t:3e3,watermarkLocation:null!==(i=Dt.querySettings(Ot.Category.SPLASH_SCREEN,"watermarkLocation"))&&void 0!==i?i:"default",autoFit:null===(n=Dt.querySettings(Ot.Category.SPLASH_SCREEN,"autoFit"))||void 0===n||n,url:null!==(r=Dt.querySettings(Ot.Category.SPLASH_SCREEN,"url"))&&void 0!==r?r:"",type:null!==(s=Dt.querySettings(Ot.Category.SPLASH_SCREEN,"type"))&&void 0!==s?s:"default",bgBase64:null!==(a=Dt.querySettings(Ot.Category.SPLASH_SCREEN,"bgBase64"))&&void 0!==a?a:"",base64src:null!==(o=Dt.querySettings(Ot.Category.SPLASH_SCREEN,"base64src"))&&void 0!==o?o:""},this._curTime=0,!(""===this.settings.base64src||this.settings.totalTime<=0)){this.device=B.director.root.device,this.swapchain=B.director.root.mainWindow.swapchain,this.preInit(),this.initLayout(),this.initWaterMark();var h=new Promise((function(e,t){u.bgImage=new M.Image,u.bgImage.onload=function(){u.initBG(),e()},u.bgImage.onerror=function(){t()},u.bgImage.src=u.settings.bgBase64})),l=new Promise((function(e,t){u.logoImage=new M.Image,u.logoImage.onload=function(){u.initLogo(),e()},u.logoImage.onerror=function(){t()},u.logoImage.src=u.settings.base64src}));return Promise.all([h,l])}return this.settings.totalTime=0,Promise.resolve([])}},{key:"preInit",value:function(){this.clearColors=[new Dc(0,0,0,255)];var e=this.device,t=this.swapchain;this.renderArea=new xc(0,0,t.width,t.height),this.cmdBuff=e.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),n=4*Float32Array.BYTES_PER_ELEMENT,r=4*n;this.vertexBuffers=e.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE,r,n)),this.vertexBuffers.update(i);var s=new Uint16Array([0,1,2,1,3,2]),a=Uint16Array.BYTES_PER_ELEMENT,o=6*a;this.indicesBuffers=e.createBuffer(new Gc(Gl.INDEX|Gl.TRANSFER_DST,Hl.DEVICE,o,a)),this.indicesBuffers.update(s);var u=[new i_("a_position",Ll.RG32F),new i_("a_texCoord",Ll.RG32F)],h=new r_(u,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(h),this.projection=new Cn,Cn.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,t.surfaceTransform),this.isMobile=Sl.isMobile}},{key:"initLayout",value:function(){this.isMobile?(this.bgWidth=812,this.bgHeight=375,this.logoWidthTemp=70,this.logoHeightTemp=100,this.logoXTrans=.5,this.logoYTrans=2/3,this.textSize=12,this.textHeight=this.textSize+this.textExpandSize,this.textXTrans=.5,this.textYExtraTrans=16):(this.bgWidth=1920,this.bgHeight=1080,this.logoWidthTemp=140,this.logoHeightTemp=200,this.logoXTrans=.5,this.logoYTrans=1/6+2.5/6,this.textSize=24,this.textHeight=this.textSize+this.textExpandSize,this.textXTrans=.5,this.textYExtraTrans=32),this.initScale()}},{key:"initScale",value:function(){var e=this.swapchain.width,t=this.swapchain.height,i=this.isMobile?375:1080,n=this.isMobile?812:1920;if(e>t){var r=n;n=i,i=r}this.scaleSize=e/t>16/9?t/n:e/i}},{key:"update",value:function(e){var t=this.settings,i=this.device,n=this.swapchain;Cn.ortho(this.projection,-1,1,-1,1,-1,1,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY,n.surfaceTransform);var r=n.width,s=n.height;this.initScale(),this._curTime+=1e3*e;var a=to(Ni(this._curTime/t.totalTime)),o=1,u=1;r<s?(o=s*this.bgRatio,u=s):(o=r,u=r*this.bgRatio),this.bgMat.setProperty("resolution",NN.set(r,s),0),this.bgMat.setProperty("scale",NN.set(o,u),0),this.bgMat.setProperty("translate",NN.set(.5*r,.5*s),0),this.bgMat.setProperty("percent",1),this.bgMat.setProperty("u_projection",this.projection),this.bgMat.passes[0].update(),o=1,u=1,o=this.logoWidth*this.scaleSize*t.displayRatio,u=this.logoHeight*this.scaleSize*t.displayRatio;var h=s*this.logoYTrans;if(this.logoMat.setProperty("resolution",NN.set(r,s),0),this.logoMat.setProperty("scale",NN.set(o,u),0),this.logoMat.setProperty("translate",NN.set(r*this.logoXTrans,h),0),this.logoMat.setProperty("percent",a),this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update(),this.watermarkMat){var l=this.watermarkTexture.width,c=this.watermarkTexture.height;o=l,u=c;var _=h-(.5*this.logoHeight*t.displayRatio+this.textYExtraTrans)*this.scaleSize-.5*c;this.watermarkMat.setProperty("resolution",NN.set(r,s),0),this.watermarkMat.setProperty("scale",NN.set(o,u),0),this.watermarkMat.setProperty("translate",NN.set(r*this.textXTrans,_),0),this.watermarkMat.setProperty("percent",a),this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update()}this.frame()}},{key:"initBG",value:function(){var e=this.device;this.bgMat=new dA,this.bgMat.initialize({effectName:"util/splash-screen"});var t=new jc;t.addressU=Ql.CLAMP,t.addressV=Ql.CLAMP,t.addressW=Ql.CLAMP,this.sampler=e.getSampler(t),this.bgTexture=e.createTexture(new Wc(zl.TEX2D,Wl.SAMPLED|Wl.TRANSFER_DST,Ll.RGBA8,this.bgImage.width,this.bgImage.height));var i=this.bgMat.passes[0],n=i.getBinding("mainTexture");i.bindTexture(n,this.bgTexture),this.shader=i.getShaderVariant();var r=i.descriptorSet;r.bindSampler(n,this.sampler),r.update();var s=new Mc;s.texExtent.width=this.bgImage.width,s.texExtent.height=this.bgImage.height,s.texExtent.depth=1,e.copyTexImagesToTexture([this.bgImage],this.bgTexture,[s])}},{key:"initLogo",value:function(){var e=this.device;this.logoMat=new dA,this.logoMat.initialize({effectName:"util/splash-screen"});var t=new jc;t.addressU=Ql.CLAMP,t.addressV=Ql.CLAMP,t.addressW=Ql.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new Wc(zl.TEX2D,Wl.SAMPLED|Wl.TRANSFER_DST,Ll.RGBA8,this.logoImage.width,this.logoImage.height));var i=this.logoMat.passes[0],n=i.getBinding("mainTexture");i.bindTexture(n,this.logoTexture),this.shader=i.getShaderVariant();var r=i.descriptorSet;r.bindSampler(n,this.sampler),r.update();var s=new Mc;s.texExtent.width=this.logoImage.width,s.texExtent.height=this.logoImage.height,s.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[s]);var a=this.logoImage.width/this.logoImage.height;a<1?(this.logoWidth=this.logoWidthTemp,this.logoHeight=this.logoWidthTemp/a):(this.logoWidth=this.logoHeightTemp*a,this.logoHeight=this.logoHeightTemp)}},{key:"initWaterMark",value:function(){var e=M.document.createElement("canvas");e.height=this.textHeight*this.scaleSize,e.style.width="".concat(e.width),e.style.height="".concat(e.height);var t="Created with Cocos",i=e.getContext("2d");i.font="".concat(this.textSize*this.scaleSize,"px Arial"),i.textBaseline="top",i.textAlign="center",i.fillStyle="#707070";var n=i.measureText(t).width+10;e.width=n,i.font="".concat(this.textSize*this.scaleSize,"px Arial"),i.textBaseline="top",i.textAlign="center",i.fillStyle="#707070",i.fillText(t,e.width/2,0);var r=new Mc;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Wc(zl.TEX2D,Wl.SAMPLED|Wl.TRANSFER_DST,Ll.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new dA,this.watermarkMat.initialize({effectName:"util/splash-screen"});var s=this.watermarkMat.passes[0],a=s.getBinding("mainTexture");s.bindTexture(a,this.watermarkTexture),s.descriptorSet.update()}},{key:"frame",value:function(){var e=this.device,t=this.swapchain;if(!Sl.isXR||xr.entry.isRenderAllowable())for(var i=Sl.isXR?2:1,n=0;n<i;n++){if(Sl.isXR){xr.entry.renderLoopStart(n);var r=xr.entry.getEyeFov(n),s=1,a=1;n===MN.LEFT?s=Math.abs(Math.tan(r[0]))/Math.abs(Math.tan(r[1])):n===MN.RIGHT&&(a=Math.abs(Math.tan(r[1]))/Math.abs(Math.tan(r[0]))),Cn.ortho(this.projection,-s,a,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,t.surfaceTransform),this.projection.m00=bn[t.surfaceTransform][0],this.projection.m05=bn[t.surfaceTransform][3]*e.capabilities.clipSpaceSignY,this.bgMat.setProperty("u_projection",this.projection),this.bgMat.passes[0].update(),this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update(),this.watermarkMat&&(this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update())}e.enableAutoBarrier(!0),e.acquire([t]);var o=this.cmdBuff,u=B.director.root.mainWindow.framebuffer,h=this.renderArea;h.width=t.width,h.height=t.height,o.begin(),o.beginRenderPass(u.renderPass,u,h,this.clearColors,1,0);var l=this.bgMat.passes[0],c=JS.getOrCreatePipelineState(e,l,this.shader,u.renderPass,this.quadAssmebler);o.bindPipelineState(c),o.bindDescriptorSet(_v.MATERIAL,l.descriptorSet),o.bindInputAssembler(this.quadAssmebler),o.draw(this.quadAssmebler);var _=this.logoMat.passes[0],f=JS.getOrCreatePipelineState(e,_,this.shader,u.renderPass,this.quadAssmebler);if(o.bindPipelineState(f),o.bindDescriptorSet(_v.MATERIAL,_.descriptorSet),o.bindInputAssembler(this.quadAssmebler),o.draw(this.quadAssmebler),this.watermarkMat){var d=this.watermarkMat.passes[0],m=JS.getOrCreatePipelineState(e,d,this.shader,u.renderPass,this.quadAssmebler);o.bindPipelineState(m),o.bindDescriptorSet(_v.MATERIAL,d.descriptorSet),o.bindInputAssembler(this.quadAssmebler),o.draw(this.quadAssmebler)}o.endRenderPass(),o.end(),e.flushCommands([o]),e.queue.submit([o]),e.present(),e.enableAutoBarrier(!B.rendering),Sl.isXR&&xr.entry.renderLoopEnd(n)}}},{key:"destroy",value:function(){this.device=null,this.swapchain=null,this.clearColors=null,this.bgImage.destroy&&this.bgImage.destroy(),this.bgImage=null,this.bgMat.destroy(),this.bgMat=null,this.bgTexture.destroy(),this.bgTexture=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null}}],[{key:"instance",get:function(){return e._ins||(e._ins=new e),e._ins}}]),e}();FN._ins=void 0,B.internal.SplashScreen=FN;var GN=new(function(){function e(){n(this,e),this._data=null}return s(e,[{key:"init",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return B.rendering&&B.rendering.enableEffectImport&&t?new Promise((function(i,n){var r=new XMLHttpRequest;r.open("GET",t),r.responseType="arraybuffer",r.onload=function(){e._data=r.response,i()},r.onerror=function(){n(new Error("request effect settings failed!"))},r.send(null)})):Promise.resolve()}},{key:"data",get:function(){return this._data}}]),e}());B.effectSettings=GN;var VN=e("Game",function(e){h(r,e);var i=v(r);function r(){var e,t,s;n(this,r);for(var a=arguments.length,o=new Array(a),u=0;u<a;u++)o[u]=arguments[u];return(s=i.call.apply(i,[this].concat(o))).frame=null,s.container=null,s.canvas=null,s.renderType=-1,s.eventTargetOn=g((e=m(s),l(r.prototype)),"on",e),s.eventTargetOnce=g((t=m(s),l(r.prototype)),"once",t),s.config={},s.onStart=null,s.frameTime=1e3/60,s._isCloning=!1,s._inited=!1,s._engineInited=!1,s._rendererInitialized=!1,s._paused=!0,s._pausedByEngine=!1,s._frameRate=60,s._pacer=null,s._initTime=0,s._startTime=0,s._deltaTime=0,s._shouldLoadLaunchScene=!0,s.onPreBaseInitDelegate=new Kh,s.onPostBaseInitDelegate=new Kh,s.onPreInfrastructureInitDelegate=new Kh,s.onPostInfrastructureInitDelegate=new Kh,s.onPreSubsystemInitDelegate=new Kh,s.onPostSubsystemInitDelegate=new Kh,s.onPreProjectInitDelegate=new Kh,s.onPostProjectInitDelegate=new Kh,s}return s(r,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._pacer&&(this._pacer.targetFrameRate=this._frameRate)}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}},{key:"setFrameRate",value:function(e){this.frameRate=e}},{key:"getFrameRate",value:function(){return this.frameRate}},{key:"step",value:function(){DN.tick(this.frameTime/1e3)}},{key:"pauseByEngine",value:function(){this._paused||(this._pausedByEngine=!0,this.pause())}},{key:"resumeByEngine",value:function(){this._pausedByEngine&&(this.resume(),this._pausedByEngine=!1)}},{key:"pause",value:function(){var e;this._paused||(this._paused=!0,null===(e=this._pacer)||void 0===e||e.stop(),this.emit(r.EVENT_PAUSE))}},{key:"resume",value:function(){var e;this._paused&&(IR._clearEvents(),this._paused=!1,null===(e=this._pacer)||void 0===e||e.start(),this.emit(r.EVENT_RESUME))}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){var e=this;return new Promise((function(e){DN.once(PN.EVENT_END_FRAME,(function(){return e()}))})).then((function(){DN.reset(),B.Object._deferredDestroy(),e.pause(),e.resume(),e._shouldLoadLaunchScene=!0,FN.instance.curTime=0,e._safeEmit(r.EVENT_RESTART)}))}},{key:"end",value:function(){Qh.close()}},{key:"on",value:function(e,t,i,n){return(this._engineInited&&e===r.EVENT_ENGINE_INITED||this._inited&&e===r.EVENT_GAME_INITED||this._rendererInitialized&&e===r.EVENT_RENDERER_INITED)&&t.call(i),this.eventTargetOn(e,t,i,n)}},{key:"once",value:function(e,t,i){return this._engineInited&&e===r.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)}},{key:"init",value:function(e){var i=this;return this._compatibleWithOldParams(e),Promise.resolve().then((function(){return i.emit(r.EVENT_PRE_BASE_INIT),i.onPreBaseInitDelegate.dispatch()})).then((function(){ee(e.debugMode||he.NONE)})).then((function(){return Sl.init()})).then((function(){i._initEvents()})).then((function(){return Dt.init(e.settingsPath,e.overrideSettings)})).then((function(){return i.emit(r.EVENT_POST_BASE_INIT),i.onPostBaseInitDelegate.dispatch()})).then((function(){return i.emit(r.EVENT_PRE_INFRASTRUCTURE_INIT),i.onPreInfrastructureInitDelegate.dispatch()})).then((function(){Lt.init(),i._initXR();var e={frame:document.querySelector("#GameDiv"),container:document.querySelector("#Cocos3dGameContainer"),canvas:document.querySelector("#GameCanvas")};e&&(i.canvas=e.canvas,i.frame=e.frame,i.container=e.container),gl.init(),xl.init(),yf.init(i.canvas,pv),""===Lt.CUSTOM_PIPELINE_NAME&&(B.rendering=void 0),NS.init(),HS.init(),ep.init(),i.initPacer()})).then((function(){return i.emit(r.EVENT_POST_INFRASTRUCTURE_INIT),i.onPostInfrastructureInitDelegate.dispatch()})).then((function(){return i.emit(r.EVENT_PRE_SUBSYSTEM_INIT),i.onPreSubsystemInitDelegate.dispatch()})).then((function(){return GN.init(Dt.querySettings(Ot.Category.RENDERING,"effectSettingsPath"))})).then((function(){if(B.rendering&&B.rendering.enableEffectImport)if(Dt.querySettings(Ot.Category.RENDERING,"renderMode")!==_f.HEADLESS){var e=GN.data;null!==e?B.rendering.init(yf.gfxDevice,e):console.error("Effect settings not found, effects will not be imported.")}else B.rendering.init(yf.gfxDevice,null)})).then((function(){return DN.init(),HS.loadBuiltinAssets()})).then((function(){return i.emit(r.EVENT_POST_SUBSYSTEM_INIT),i.onPostSubsystemInitDelegate.dispatch()})).then((function(){console.log("Cocos Creator v".concat(P)),i.emit(r.EVENT_ENGINE_INITED),i._engineInited=!0})).then((function(){return i.emit(r.EVENT_PRE_PROJECT_INIT),i.onPreProjectInitDelegate.dispatch()})).then((function(){var e=Dt.querySettings(Ot.Category.PLUGINS,"jsList"),t=Promise.resolve();return e&&e.forEach((function(e){t=t.then((function(){return t="".concat("src","/").concat(e),new Promise((function(e,i){var n;function r(e){e.filename===t&&(n=e.error)}window.addEventListener("error",r);var s=document.createElement("script");s.charset="utf-8",s.async=!0,s.crossOrigin="anonymous",s.addEventListener("error",(function(){window.removeEventListener("error",r),i(Error("Error loading ".concat(t)))})),s.addEventListener("load",(function(){window.removeEventListener("error",r),document.head.removeChild(s),n?i(n):e()})),s.src=t.replace("#","%23"),document.head.appendChild(s)}));var t}))})),t})).then((function(){var e=Dt.querySettings(Ot.Category.SCRIPTING,"scriptPackages");return e?Promise.all(e.map((function(e){return t.import(e)}))):Promise.resolve([])})).then((function(){return i._loadProjectBundles()})).then((function(){return i._loadCCEScripts()})).then((function(){return i._setupRenderPipeline()})).then((function(){return i._loadPreloadAssets()})).then((function(){return HS.compileBuiltinMaterial(),FN.instance.init()})).then((function(){return i.emit(r.EVENT_POST_PROJECT_INIT),i.onPostProjectInitDelegate.dispatch()})).then((function(){i._inited=!0,i._safeEmit(r.EVENT_GAME_INITED)}))}},{key:"_initXR",value:function(){var e;if(void 0===globalThis.__globalXR&&(globalThis.__globalXR={}),globalThis.__globalXR.webxrCompatible=null!==(e=Dt.querySettings(Ot.Category.XR,"webxrCompatible"))&&void 0!==e&&e,Sl.isXR){var t,i;xr.entry=xr.XrEntry.getInstance();var n=null!==(t=Dt.querySettings(Ot.Category.RENDERING,"msaa"))&&void 0!==t?t:1,r=null!==(i=Dt.querySettings(Ot.Category.RENDERING,"renderingScale"))&&void 0!==i?i:1;xr.entry.setMultisamplesRTT(n),xr.entry.setRenderingScale(r)}}},{key:"_compatibleWithOldParams",value:function(e){var t=e.overrideSettings=e.overrideSettings||{};"showFPS"in e&&(t.profiling=t.profiling||{},t.profiling.showFPS=e.showFPS),"frameRate"in e&&(t.screen=t.screen||{},t.screen.frameRate=e.frameRate),"renderMode"in e&&(t.rendering=t.rendering||{},t.rendering.renderMode=e.renderMode),"renderPipeline"in e&&(t.rendering=t.rendering||{},t.rendering.renderPipeline=e.renderPipeline),"assetOptions"in e&&(t.assets=t.assets||{},Object.assign(t.assets,e.assetOptions)),"customJointTextureLayouts"in e&&(t.animation=t.animation||{},t.animation.customJointTextureLayouts=e.customJointTextureLayouts),"physics"in e&&(t.physics=t.physics||{},Object.assign(t.physics,e.physics)),"orientation"in e&&(t.screen=t.screen||{},t.screen.orientation=e.orientation),"exactFitScreen"in e&&(t.screen=t.screen||{},t.screen.exactFitScreen=e.exactFitScreen)}},{key:"_loadPreloadAssets",value:function(){var e=Dt.querySettings(Ot.Category.ASSETS,"preloadAssets");return e?Promise.all(e.map((function(e){return new Promise((function(t,i){NS.loadAny(e,(function(e){e?i(e):t()}))}))}))):Promise.resolve([])}},{key:"_loadCCEScripts",value:function(){return new Promise((function(e){e()}))}},{key:"_loadProjectBundles",value:function(){var e=Dt.querySettings(Ot.Category.ASSETS,"preloadBundles");return e?Promise.all(e.map((function(e){var t=e.bundle,i=e.version;return new Promise((function(e,n){var r={};i&&(r.version=i),NS.loadBundle(t,r,(function(t){t?n(t):e()}))}))}))):Promise.resolve([])}},{key:"run",value:function(e){e&&(this.onStart=e),this._inited&&this.resume()}},{key:"_calculateDT",value:function(){var e=performance.now();return this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>r.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime}},{key:"_updateCallback",value:function(){var e=this;if(this._inited)if(FN.instance.isFinished)if(this._shouldLoadLaunchScene){this._shouldLoadLaunchScene=!1;var t,i=Dt.querySettings(Ot.Category.LAUNCH,"launchScene");i?DN.loadScene(i,(function(){var t;console.log("Success to load scene: ".concat(i)),e._initTime=performance.now(),DN.startAnimation(),null===(t=e.onStart)||void 0===t||t.call(e)})):(this._initTime=performance.now(),DN.startAnimation(),null===(t=this.onStart)||void 0===t||t.call(this))}else DN.tick(this._calculateDT());else FN.instance.update(this._calculateDT())}},{key:"initPacer",value:function(){var e,t=null!==(e=Dt.querySettings(Ot.Category.SCREEN,"frameRate"))&&void 0!==e?e:60;Z("number"==typeof t),this._pacer=new LN,this._pacer.onTick=this._updateCallback.bind(this),this.frameRate=t}},{key:"_initEvents",value:function(){Qh.on("show",this._onShow,this),Qh.on("hide",this._onHide,this)}},{key:"_onHide",value:function(){this.emit(r.EVENT_HIDE),this.pauseByEngine()}},{key:"_onShow",value:function(){this.emit(r.EVENT_SHOW),this.resumeByEngine()}},{key:"addPersistRootNode",value:function(e){DN.addPersistRootNode(e)}},{key:"removePersistRootNode",value:function(e){DN.removePersistRootNode(e)}},{key:"isPersistRootNode",value:function(e){return DN.isPersistRootNode(e)}},{key:"_setupRenderPipeline",value:function(){var e=this,t=Dt.querySettings(Ot.Category.RENDERING,"renderPipeline");return t?new Promise((function(e,i){NS.loadAny(t,(function(t,n){return!t&&n instanceof YI?e(n):i(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(i){Q(i),Q("Failed load render pipeline: ".concat(t,", engine failed to initialize, will fallback to default pipeline")),e._setRenderPipeline()})):this._setRenderPipeline()}},{key:"_setRenderPipeline",value:function(e){DN.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(r.EVENT_RENDERER_INITED)}},{key:"_safeEmit",value:function(e){this.emit(e)}}]),r}(Hh));VN.EVENT_HIDE="game_on_hide",VN.EVENT_SHOW="game_on_show",VN.EVENT_LOW_MEMORY="game_on_low_memory",VN.EVENT_GAME_INITED="game_inited",VN.EVENT_ENGINE_INITED="engine_inited",VN.EVENT_RENDERER_INITED="renderer_inited",VN.EVENT_PRE_BASE_INIT="pre_base_init",VN.EVENT_POST_BASE_INIT="post_base_init",VN.EVENT_PRE_INFRASTRUCTURE_INIT="pre_infrastructure_init",VN.EVENT_POST_INFRASTRUCTURE_INIT="post_infrastructure_init",VN.EVENT_PRE_SUBSYSTEM_INIT="pre_subsystem_init",VN.EVENT_POST_SUBSYSTEM_INIT="post_subsystem_init",VN.EVENT_PRE_PROJECT_INIT="pre_project_init",VN.EVENT_POST_PROJECT_INIT="post_project_init",VN.EVENT_RESTART="game_on_restart",VN.EVENT_PAUSE="game_on_pause",VN.EVENT_RESUME="game_on_resume",VN.RENDER_TYPE_CANVAS=0,VN.RENDER_TYPE_WEBGL=1,VN.RENDER_TYPE_OPENGL=2,VN.RENDER_TYPE_HEADLESS=3,VN.DEBUG_DT_THRESHOLD=1,B.Game=VN;var UN=e("game",B.game=new VN);ve(PN.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),pe(PN.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]),me(DN,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return NS.main?null===(t=NS.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),ve(UN,"game",[{name:"collisionMatrix"},{name:"groupList"}]),me(UN,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return NS.main&&NS.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var HN=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._atlases=[],e._atlasIndex=-1,e._maxAtlasCount=5,e._textureSize=2048,e._maxFrameSize=512,e._textureBleeding=!0,e._enabled=!1,e}return s(i,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),B.director.on(B.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),B.director.off(B.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}},{key:"newAtlas",value:function(){var e=this._atlases[++this._atlasIndex];return e||(e=new Jm(this._textureSize,this._textureSize),this._atlases.push(e)),e}},{key:"beforeSceneLoad",value:function(){this.reset()}},{key:"init",value:function(){this.enabled=!Lt.CLEANUP_IMAGE_CACHE}},{key:"insertSpriteFrame",value:function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==nd.LINEAR||t.magFilter!==nd.LINEAR||t.mipFilter!==nd.NONE)return null;var i=this._atlases[this._atlasIndex];i||(i=this.newAtlas());var n=i.insertSpriteFrame(e);return n||this._atlasIndex===this._maxAtlasCount?n:(i=this.newAtlas()).insertSpriteFrame(e)}},{key:"reset",value:function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1}},{key:"deleteAtlasSpriteFrame",value:function(e){if(e._original){for(var t=this._atlases.length-1;t>=0;t--)At(this._atlases[t]._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}}},{key:"deleteAtlasTexture",value:function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)}},{key:"packToDynamicAtlas",value:function(e,t){if(this._enabled&&t&&!t._original&&t.packable&&t.texture&&t.texture.width>0&&t.texture.height>0){var i=this.insertSpriteFrame(t);i&&t._setDynamicAtlasFrame(i)}}}]),i}(Rh);HN.instance=void 0;var zN,WN=e("dynamicAtlasManager",HN.instance=new HN);DN.registerSystem("dynamicAtlasManager",WN,0),B.internal.dynamicAtlasManager=WN,function(e){e[e.positions=Tc.ATTR_POSITION]="positions",e[e.normals=Tc.ATTR_NORMAL]="normals",e[e.uvs=Tc.ATTR_TEX_COORD]="uvs",e[e.colors=Tc.ATTR_COLOR]="colors"}(zN||(zN={}));var XN=[new i_(Tc.ATTR_POSITION,Ll.RGB32F),new i_(Tc.ATTR_NORMAL,Ll.RGB32F),new i_(Tc.ATTR_TEX_COORD,Ll.RG32F),new i_(Tc.ATTR_TANGENT,Ll.RGBA32F),new i_(Tc.ATTR_COLOR,Ll.RGBA32F)],jN=new an;function qN(e,t,i){i=i||{};var n,r=[],s=0,a=[],o=0,u=e.positions.slice();if(u.length>0){if(n=null,e.attributes)for(var h,l=R(e.attributes);!(h=l()).done;){var c=h.value;if(c.name===Tc.ATTR_POSITION){n=c;break}}n||(n=XN[0]),r.push(n);var _=x_[n.format];o=Math.max(o,Math.floor(u.length/_.count)),a.push({offset:s,data:u,attribute:n}),s+=_.size}if(e.normals&&e.normals.length>0){if(n=null,e.attributes)for(var f,d=R(e.attributes);!(f=d()).done;){var m=f.value;if(m.name===Tc.ATTR_NORMAL){n=m;break}}n||(n=XN[1]);var p=x_[n.format];r.push(n),o=Math.max(o,Math.floor(e.normals.length/p.count)),a.push({offset:s,data:e.normals,attribute:n}),s+=p.size}if(e.uvs&&e.uvs.length>0){if(n=null,e.attributes)for(var v,y=R(e.attributes);!(v=y()).done;){var g=v.value;if(g.name===Tc.ATTR_TEX_COORD){n=g;break}}n||(n=XN[2]);var S=x_[n.format];r.push(n),o=Math.max(o,Math.floor(e.uvs.length/S.count)),a.push({offset:s,data:e.uvs,attribute:n}),s+=S.size}if(e.tangents&&e.tangents.length>0){if(n=null,e.attributes)for(var A,T=R(e.attributes);!(A=T()).done;){var E=A.value;if(E.name===Tc.ATTR_TANGENT){n=E;break}}n||(n=XN[3]);var b=x_[n.format];r.push(n),o=Math.max(o,Math.floor(e.tangents.length/b.count)),a.push({offset:s,data:e.tangents,attribute:n}),s+=b.size}if(e.colors&&e.colors.length>0){if(n=null,e.attributes)for(var C,x=R(e.attributes);!(C=x()).done;){var w=C.value;if(w.name===Tc.ATTR_COLOR){n=w;break}}n||(n=XN[4]);var k=x_[n.format];r.push(n),o=Math.max(o,Math.floor(e.colors.length/k.count)),a.push({offset:s,data:e.colors,attribute:n}),s+=k.size}if(e.customAttributes)for(var I=0;I<e.customAttributes.length;I++){var B=e.customAttributes[I],P=x_[B.attr.format];r.push(B.attr),o=Math.max(o,Math.floor(B.values.length/P.count)),a.push({offset:s,data:B.values,attribute:B.attr}),s+=P.size}for(var M=new WM,O=new ArrayBuffer(o*s),D=new DataView(O),L=0,N=a;L<N.length;L++){var F=N[L];hw(D,F.data,F.attribute.format,F.offset,s)}M.setNextAlignment(0);var G={attributes:r,view:{offset:M.getLength(),length:O.byteLength,count:o,stride:s}};M.addBuffer(O);var V=null,U=0;if(e.indices){var H=e.indices;U=H.length,V=new ArrayBuffer(2*U),hw(new DataView(V),H,Ll.R16UI)}var z={primitiveMode:e.primitiveMode||uc.TRIANGLE_LIST,vertexBundelIndices:[0]};V&&(M.setNextAlignment(2),z.indexView={offset:M.getLength(),length:V.byteLength,count:U,stride:2},M.addBuffer(V));var W=e.minPos;if(!W&&i.calculateBounds){W=an.set(new an,1/0,1/0,1/0);for(var X=0;X<o;++X)an.set(jN,u[3*X+0],u[3*X+1],u[3*X+2]),an.min(W,W,jN)}var j=e.maxPos;if(!j&&i.calculateBounds){j=an.set(new an,-1/0,-1/0,-1/0);for(var q=0;q<o;++q)an.set(jN,u[3*q+0],u[3*q+1],u[3*q+2]),an.max(j,j,jN)}var Y={vertexBundles:[G],primitives:[z]};return W&&(Y.minPosition=new an(W.x,W.y,W.z)),j&&(Y.maxPosition=new an(j.x,j.y,j.z)),t||(t=new iO),t.reset({struct:Y,data:new Uint8Array(M.getCombined())}),t}function YN(e,t){if(t>0){var i=e%t;if(0!==i)return t-i}return 0}s((function e(){n(this,e)}),null,[{key:"createMesh",value:function(e,t,i){return qN(e,t,i)}},{key:"createDynamicMesh",value:function(e,t,i,n){return function(e,t,i,n){n=n||{maxSubMeshes:1,maxSubMeshVertices:1024,maxSubMeshIndices:1024};var r=[],s=0;if(t.positions.length>0&&r.push(new i_(Tc.ATTR_POSITION,Ll.RGB32F,!1,s++,!1,0)),t.normals&&t.normals.length>0&&r.push(new i_(Tc.ATTR_NORMAL,Ll.RGB32F,!1,s++,!1,0)),t.uvs&&t.uvs.length>0&&r.push(new i_(Tc.ATTR_TEX_COORD,Ll.RG32F,!1,s++,!1,0)),t.tangents&&t.tangents.length>0&&r.push(new i_(Tc.ATTR_TANGENT,Ll.RGBA32F,!1,s++,!1,0)),t.colors&&t.colors.length>0&&r.push(new i_(Tc.ATTR_COLOR,Ll.RGBA32F,!1,s++,!1,0)),t.customAttributes)for(var a=0;a<t.customAttributes.length;a++){var o=t.customAttributes[a],u=new i_;u.copy(o.attr),u.stream=s++,r.push(u)}for(var h=[],l=[],c=0,_=0;_<n.maxSubMeshes;_++){for(var f,d={vertexBundelIndices:[],primitiveMode:t.primitiveMode||uc.TRIANGLE_LIST},m=R(r);!(f=m()).done;){var p=f.value,v=x_[p.format],y=n.maxSubMeshVertices*v.size,g={view:{offset:c,length:y,count:0,stride:v.size},attributes:[p]},S=h.length;d.vertexBundelIndices.push(S),h.push(g),c+=y}var A=0;if(t.indices16&&t.indices16.length>0?A=2:t.indices32&&t.indices32.length>0&&(A=4),A>0){c+=YN(c,A);var T=n.maxSubMeshIndices*A,E={offset:c,length:T,count:0,stride:A};d.indexView=E,c+=T}l.push(d)}var b={info:{maxSubMeshes:n.maxSubMeshes,maxSubMeshVertices:n.maxSubMeshVertices,maxSubMeshIndices:n.maxSubMeshIndices},bounds:[]};b.bounds.length=n.maxSubMeshes;var C={struct:{vertexBundles:h,primitives:l,dynamic:b},data:new Uint8Array(c)};return i||(i=new iO),i.reset(C),i.initialize(),i.updateSubMesh(e,t),i}(e,t,i,n)}}]);var KN,QN,JN,ZN,$N=new an,eF=new Cn;!function(e){e[e.RECT=0]="RECT",e[e.POLYGON=1]="POLYGON"}(ZN||(ZN={}));var tF,iF,nF,rF=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],sF=e("SpriteFrame",Hs("cc.SpriteFrame")((JN=QN=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this)).vertices=null,e.uv=[],e.unbiasUV=[],e.uvSliced=[],e._rect=new Dn,e._trimmedBorder=new en,e._offset=new In,e._originalSize=new Mn,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._isFlipUVY=!1,e._isFlipUVX=!1,e._original=null,e._packable=!0,e._pixelsToUnit=100,e._pivot=new In(.5,.5),e._meshType=ZN.RECT,e._extrude=0,e._customOutLine=[],e._minPos=new an,e._maxPos=new an,e}return s(i,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV(),this._calcTrimmedBorder())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV(),this._calcTrimmedBorder())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._calcTrimmedBorder()}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?e!==this._texture&&this.reset({texture:e},!0):ae(3122,this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){globalThis.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}},{key:"pixelsToUnit",get:function(){return this._pixelsToUnit}},{key:"pivot",get:function(){return this._pivot}},{key:"mesh",get:function(){return this._mesh}},{key:"trimmedBorder",get:function(){return this._trimmedBorder}},{key:"textureLoaded",value:function(){return!!this.texture}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this.rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this.rect=e}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this.originalSize=e}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this.offset=e}},{key:"getGFXTexture",value:function(){return this._texture.getGFXTexture()}},{key:"getGFXSampler",value:function(){return this._texture.getGFXSampler()}},{key:"getHash",value:function(){return this._texture.getHash()}},{key:"getSamplerInfo",value:function(){return this._texture.getSamplerInfo()}},{key:"reset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),i=!0),i&&this.texture&&this._calculateUV(),this._calcTrimmedBorder()}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(ue(3300,"".concat(this.name,"/").concat(e.name),i,e.width),!1):!(n>e.height&&(ue(3301,"".concat(this.name,"/").concat(e.name),n,e.height),1))}},{key:"_calcTrimmedBorder",value:function(){var e=this._originalSize.width,t=this._originalSize.height,i=.5*(e-this._rect.width),n=.5*(t-this._rect.height);this._trimmedBorder.x=this._offset.x+i,this._trimmedBorder.y=this._offset.x-i,this._trimmedBorder.z=this._offset.y+n,this._trimmedBorder.w=this._offset.y-n}},{key:"ensureMeshData",value:function(){this._mesh||(this._initVertices(),this._createMesh())}},{key:"destroy",value:function(){return this._packable&&WN&&WN.deleteAtlasSpriteFrame(this),g(l(i.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,n=t.width,r=t.height,s=this._capInsets[0],a=this._capInsets[2],o=e.width-s-a,u=this._capInsets[1],h=this._capInsets[3],l=e.height-u-h,c=this.uvSliced;if(c.length=0,this._rotated){rF[0].u=e.x/n,rF[1].u=(e.x+h)/n,rF[2].u=(e.x+h+l)/n,rF[3].u=(e.x+e.height)/n,rF[3].v=e.y/r,rF[2].v=(e.y+s)/r,rF[1].v=(e.y+s+o)/r,rF[0].v=(e.y+e.width)/r;for(var _=0;_<4;++_)for(var f=rF[_],d=0;d<4;++d){var m=rF[3-d];c.push({u:f.u,v:m.v})}}else{rF[0].u=e.x/n,rF[1].u=(e.x+s)/n,rF[2].u=(e.x+s+o)/n,rF[3].u=(e.x+e.width)/n,rF[3].v=e.y/r,rF[2].v=(e.y+u)/r,rF[1].v=(e.y+u+l)/r,rF[0].v=(e.y+e.height)/r;for(var p=0;p<4;++p)for(var v=rF[p],y=0;y<4;++y){var g=rF[y];c.push({u:g.u,v:v.v})}}this.emit(i.EVENT_UV_UPDATED,this)}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,i=this.unbiasUV,n=this.texture,r=n.width,s=n.height;if(this._rotated){var a=0===r?0:e.x/r,o=0===r?1:(e.x+e.height)/r,u=0===s?0:e.y/s,h=0===s?1:(e.y+e.width)/s;this._isFlipUVX&&this._isFlipUVY?(t[0]=o,t[1]=h,t[2]=o,t[3]=u,t[4]=a,t[5]=h,t[6]=a,t[7]=u):this._isFlipUVX?(t[0]=o,t[1]=u,t[2]=o,t[3]=h,t[4]=a,t[5]=u,t[6]=a,t[7]=h):this._isFlipUVY?(t[0]=a,t[1]=h,t[2]=a,t[3]=u,t[4]=o,t[5]=h,t[6]=o,t[7]=u):(t[0]=a,t[1]=u,t[2]=a,t[3]=h,t[4]=o,t[5]=u,t[6]=o,t[7]=h);var l=0===r?0:e.x/r,c=0===r?1:(e.x+e.height)/r,_=0===s?0:e.y/s,f=0===s?1:(e.y+e.width)/s;this._isFlipUVX&&this._isFlipUVY?(i[0]=c,i[1]=f,i[2]=c,i[3]=_,i[4]=l,i[5]=f,i[6]=l,i[7]=_):this._isFlipUVX?(i[0]=c,i[1]=_,i[2]=c,i[3]=f,i[4]=l,i[5]=_,i[6]=l,i[7]=f):this._isFlipUVY?(i[0]=l,i[1]=f,i[2]=l,i[3]=_,i[4]=c,i[5]=f,i[6]=c,i[7]=_):(i[0]=l,i[1]=_,i[2]=l,i[3]=f,i[4]=c,i[5]=_,i[6]=c,i[7]=f)}else{var d=0===r?0:e.x/r,m=0===r?1:(e.x+e.width)/r,p=0===s?1:(e.y+e.height)/s,v=0===s?0:e.y/s;this._isFlipUVX&&this._isFlipUVY?(t[0]=m,t[1]=v,t[2]=d,t[3]=v,t[4]=m,t[5]=p,t[6]=d,t[7]=p):this._isFlipUVX?(t[0]=m,t[1]=p,t[2]=d,t[3]=p,t[4]=m,t[5]=v,t[6]=d,t[7]=v):this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=m,t[3]=v,t[4]=d,t[5]=p,t[6]=m,t[7]=p):(t[0]=d,t[1]=p,t[2]=m,t[3]=p,t[4]=d,t[5]=v,t[6]=m,t[7]=v);var y=0===r?0:e.x/r,g=0===r?1:(e.x+e.width)/r,S=0===s?1:(e.y+e.height)/s,A=0===s?0:e.y/s;this._isFlipUVX&&this._isFlipUVY?(i[0]=g,i[1]=A,i[2]=y,i[3]=A,i[4]=g,i[5]=S,i[6]=y,i[7]=S):this._isFlipUVX?(i[0]=g,i[1]=S,i[2]=y,i[3]=S,i[4]=g,i[5]=A,i[6]=y,i[7]=A):this._isFlipUVY?(i[0]=y,i[1]=A,i[2]=g,i[3]=A,i[4]=y,i[5]=S,i[6]=g,i[7]=S):(i[0]=y,i[1]=S,i[2]=g,i[3]=S,i[4]=y,i[5]=A,i[6]=g,i[7]=A)}this._calculateSlicedUV()}},{key:"_setDynamicAtlasFrame",value:function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())}},{key:"_resetDynamicAtlasFrame",value:function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())}},{key:"_checkPackable",value:function(){var e=WN;if(e){var t=this._texture;if(t instanceof Qm&&!t.isCompressed){var i=this.width,n=this.height;if(!t.image||i>e.maxFrameSize||n>e.maxFrameSize)this._packable=!1;else{var r=M.HTMLCanvasElement;t.image&&t.image instanceof r&&(this._packable=!0)}}else this._packable=!1}}},{key:"_serialize",value:function(){return null}},{key:"_deserialize",value:function(e){var t=e,i=t.rect;i&&(this._rect=new Dn(i.x,i.y,i.width,i.height));var n=t.offset;t.offset&&(this._offset=new In(n.x,n.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new Mn(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable,this._pixelsToUnit=t.pixelsToUnit;var s=t.pivot;s&&(this._pivot=new In(s.x,s.y)),this._meshType=t.meshType;var a=t.capInsets;a&&(this._capInsets[0]=a[0],this._capInsets[1]=a[1],this._capInsets[2]=a[2],this._capInsets[3]=a[3]);var o=t.vertices;if(o){this.vertices||(this.vertices={rawPosition:[],positions:[],indexes:o.indexes,uv:o.uv,nuv:o.nuv,minPos:new an(o.minPos.x,o.minPos.y,o.minPos.z),maxPos:new an(o.maxPos.x,o.maxPos.y,o.maxPos.z)}),this.vertices.rawPosition.length=0;for(var u=o.rawPosition,h=0;h<u.length;h+=3)this.vertices.rawPosition.push(new an(u[h],u[h+1],u[h+2]));this._updateMeshVertices()}}},{key:"clone",value:function(){var e,t,n,r,s=new i,a=this.vertices;return s.vertices=a?{rawPosition:a.rawPosition.slice(0),positions:a.positions.slice(0),indexes:a.indexes.slice(0),uv:a.uv.slice(0),nuv:a.nuv.slice(0),minPos:a.minPos.clone(),maxPos:a.minPos.clone()}:null,(e=s.uv).splice.apply(e,[0,s.uv.length].concat(E(this.uv))),(t=s.unbiasUV).splice.apply(t,[0,s.unbiasUV.length].concat(E(this.unbiasUV))),(n=s.uvSliced).splice.apply(n,[0,s.uvSliced.length].concat(E(this.uvSliced))),s._rect.set(this._rect),s._offset.set(this._offset),s._originalSize.set(this._originalSize),s._rotated=this._rotated,(r=s._capInsets).splice.apply(r,[0,s._capInsets.length].concat(E(this._capInsets))),s._atlasUuid=this._atlasUuid,s._texture=this._texture,s._isFlipUVX=this._isFlipUVX,s._isFlipUVY=this._isFlipUVY,s._pixelsToUnit=this._pixelsToUnit,s._pivot.set(this._pivot),s._meshType=this._meshType,s}},{key:"_refreshTexture",value:function(e){this._texture=e;var t=this._texture,i={},n=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(i.rect=new Dn(0,0,t.width,t.height),n=!0),(0===this._originalSize.width||0===this._originalSize.height||n)&&(i.originalSize=new Mn(t.width,t.height),n=!0),n&&this.reset(i),this._checkPackable(),this._mesh&&this._updateMesh()}},{key:"onLoaded",value:function(){this._calcTrimmedBorder()}},{key:"initDefault",value:function(e){g(l(i.prototype),"initDefault",this).call(this,e);var t=new Qm;t.initDefault(),this._refreshTexture(t),this._calculateUV()}},{key:"validate",value:function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height}},{key:"_initVertices",value:function(){if(this.vertices?(this.vertices.rawPosition.length=0,this.vertices.positions.length=0,this.vertices.indexes.length=0,this.vertices.uv.length=0,this.vertices.nuv.length=0,this.vertices.minPos.set(0,0,0),this.vertices.maxPos.set(0,0,0)):this.vertices={rawPosition:[],positions:[],indexes:[],uv:[],nuv:[],minPos:new an,maxPos:new an},this._meshType===ZN.POLYGON);else{var e=this.texture,t=e.width,i=e.height,n=this.rect,r=n.width,s=n.height,a=n.x,o=i-n.y-s,u=r/2,h=s/2,l=0===t?0:a/t,c=0===t?1:(a+r)/t,_=0===i?1:(o+s)/i,f=0===i?0:n.y/i;$N.set(-u,-h,0),this.vertices.rawPosition.push($N.clone()),this.vertices.uv.push(a),this.vertices.uv.push(o+s),this.vertices.nuv.push(l),this.vertices.nuv.push(f),this.vertices.minPos.set($N),$N.set(u,-h,0),this.vertices.rawPosition.push($N.clone()),this.vertices.uv.push(a+r),this.vertices.uv.push(o+s),this.vertices.nuv.push(c),this.vertices.nuv.push(f),$N.set(-u,h,0),this.vertices.rawPosition.push($N.clone()),this.vertices.uv.push(a),this.vertices.uv.push(o),this.vertices.nuv.push(l),this.vertices.nuv.push(_),$N.set(u,h,0),this.vertices.rawPosition.push($N.clone()),this.vertices.uv.push(a+r),this.vertices.uv.push(o),this.vertices.nuv.push(c),this.vertices.nuv.push(_),this.vertices.maxPos.set($N),this.vertices.indexes.push(0),this.vertices.indexes.push(1),this.vertices.indexes.push(2),this.vertices.indexes.push(2),this.vertices.indexes.push(1),this.vertices.indexes.push(3)}this._updateMeshVertices()}},{key:"_updateMeshVertices",value:function(){eF.identity();var e=1/this._pixelsToUnit,t=new an(e,e,1);eF.scale(t);var i=-(this._pivot.x-.5)*this.rect.width*e,n=-(this._pivot.y-.5)*this.rect.height*e;t.set(i,n,0),eF.translate(t);for(var r=this.vertices,s=0;s<r.rawPosition.length;s++){var a=r.rawPosition[s];an.transformMat4(t,a,eF),an.toArray(r.positions,t,3*s)}an.transformMat4(this._minPos,r.minPos,eF),an.transformMat4(this._maxPos,r.maxPos,eF)}},{key:"_createMesh",value:function(){this._mesh=qN({primitiveMode:uc.TRIANGLE_LIST,positions:this.vertices.positions,uvs:this.vertices.nuv,indices:this.vertices.indexes,minPos:this._minPos,maxPos:this._maxPos,attributes:[new i_(Tc.ATTR_POSITION,Ll.RGB32F),new i_(Tc.ATTR_TEX_COORD,Ll.RG32F)]})}},{key:"_updateMesh",value:function(){this._mesh&&this._mesh.destroy(),this._initVertices(),this._createMesh()}}],[{key:"createWithImage",value:function(e){var t=e instanceof bd?e:new bd(e),n=new Qm;n.image=t;var r=new i;return r.texture=n,r}}]),i}(ed),QN.EVENT_UV_UPDATED="uv_updated",QN.MeshType=ZN,KN=JN))||KN);B.SpriteFrame=sF;var aF,oF=e("SpriteAtlas",Hs("cc.SpriteAtlas")((iF=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).spriteFrames=nF&&nF(),e}return s(i,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e}},{key:"_serialize",value:function(){}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=Ue();for(var r=0;r<n.length;r+=2)t.result.push(this.spriteFrames,n[r],n[r+1],mt(sF))}}]),i}(ed),nF=Ms(iF.prototype,"spriteFrames",[Js],(function(){return Ue()})),tF=iF))||tF);B.SpriteAtlas=oF;var uF,hF,lF,cF=e("Font",Hs("cc.Font")(aF=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(ed))||aF);B.Font=cF;var _F,fF,dF,mF,pF,vF,yF,gF,SF=e("TTFFont",Hs("cc.TTFFont")((hF=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._fontFamily=lF&&lF(),e}return s(i,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:tl(this._native),__isNative__:!0}}},{key:"initDefault",value:function(e){this._fontFamily="Arial",g(l(i.prototype),"initDefault",this).call(this,e)}}]),i}(cF),lF=Ms(hF.prototype,"_fontFamily",[Js],(function(){return null})),x(hF.prototype,"_nativeAsset",[Ta,Sa],Object.getOwnPropertyDescriptor(hF.prototype,"_nativeAsset"),hF.prototype),x(hF.prototype,"_nativeDep",[Ta],Object.getOwnPropertyDescriptor(hF.prototype,"_nativeDep"),hF.prototype),uF=hF))||uF);B.TTFFont=SF;var AF,TF=function e(){n(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},EF=function(){function e(t){n(this,e),this.letterDefinitions={},this.texture=t}return s(e,[{key:"addLetterDefinitions",value:function(e,t){this.letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this.letterDefinitions);t<i.length;t++){var n=i[t],r=new TF;Ze(r,this.letterDefinitions[n]),e[n]=r}return e}},{key:"getTexture",value:function(){return this.texture}},{key:"getLetter",value:function(e){return this.letterDefinitions[e]}},{key:"getLetterDefinitionForChar",value:function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null}},{key:"clear",value:function(){this.letterDefinitions={}}}]),e}(),bF=e("BitmapFont",(_F=Hs("cc.BitmapFont"),fF=Aa(sF),_F((mF=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).fntDataStr=pF&&pF(),e.spriteFrame=vF&&vF(),e.fontSize=yF&&yF(),e.fntConfig=gF&&gF(),e}return s(i,[{key:"onLoaded",value:function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new EF(e.texture));var t=this.fntConfig;if(t){var i=t.fontDefDictionary;for(var n in i){var r=new TF,s=i[n].rect;r.offsetX=i[n].xOffset,r.offsetY=i[n].yOffset,r.w=s.width,r.h=s.height,r.u=s.x,r.v=s.y,r.textureID=0,r.valid=!0,r.xAdvance=i[n].xAdvance,this.fontDefDictionary.addLetterDefinitions(n,r)}}else Q("The fnt config is not exists!")}}]),i}(cF),pF=Ms(mF.prototype,"fntDataStr",[Js],(function(){return""})),vF=Ms(mF.prototype,"spriteFrame",[fF],(function(){return null})),yF=Ms(mF.prototype,"fontSize",[Js],(function(){return-1})),gF=Ms(mF.prototype,"fntConfig",[Js],(function(){return null})),dF=mF))||dF));B.BitmapFont=bF;var CF=e("LabelAtlas",Hs("cc.LabelAtlas")(AF=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(bF))||AF);B.LabelAtlas=CF;var RF=e("BASELINE_RATIO",.26),xF=e("MIDDLE_RATIO",(RF+1)/2-RF);var wF=new pt(2);wF.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var kF,IF=new(function(){function e(t){n(this,e),this.count=0,this.limit=0,this.datas={},this.limit=t}return s(e,[{key:"moveToHead",value:function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e}},{key:"put",value:function(e,t){var i=wF.get();if(i.key=e,i.value=t,this.count>=this.limit){var n=this.tail;delete this.datas[n.key],this.count--,this.tail=n.prev,this.tail.next=null,n.prev=null,n.next=null,wF.put(n)}this.moveToHead(i)}},{key:"remove",value:function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--}},{key:"get",value:function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null}},{key:"clear",value:function(){this.count=0,this.datas={},this.head=null,this.tail=null}},{key:"has",value:function(e){return!!this.datas[e]}},{key:"delete",value:function(e){var t=this.datas[e];this.remove(t)}}]),e}())(100),BF=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,PF=/^[!,.:;'}\]%\?>、‘“》？。，！]/,MF=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁёáàảạãăắằẳẵặâấầẩẫậéèẻẽẹêếềểễệiíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵđÁÀẢẠÃĂẮẰẲẴẶÂẤẦẨẪẬÉÈẺẼẸÊẾỀỂỄỆIÍÌỈĨỊÓÒỎÕỌÔỐỒỔỖỘƠỚỜỞỠỢÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴĐ]+|\S)$/,OF=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁёáàảạãăắằẳẵặâấầẩẫậéèẻẽẹêếềểễệiíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵđÁÀẢẠÃĂẮẰẲẴẶÂẤẦẨẪẬÉÈẺẼẸÊẾỀỂỄỆIÍÌỈĨỊÓÒỎÕỌÔỐỒỔỖỘƠỚỜỞỠỢÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴĐ]+$/,DF=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁёáàảạãăắằẳẵặâấầẩẫậéèẻẽẹêếềểễệiíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵđÁÀẢẠÃĂẮẰẲẴẶÂẤẦẨẪẬÉÈẺẼẸÊẾỀỂỄỆIÍÌỈĨỊÓÒỎÕỌÔỐỒỔỖỘƠỚỜỞỠỢÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴĐ]/;function LF(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function NF(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function FF(e,t,i){var n=i||e.font,r="".concat(n,"🎮").concat(t),s=IF.get(r);if(null!==s)return s;var a=e.measureText(t),o=a&&a.width||0;return IF.put(r,o),o}function GF(e,t,i){var n=t,r=i,s=e[t];if(s>="\udc00"&&s<="\udfff"&&n--,void 0!==i)if(i-1!==t){var a=e[i-1];a>="\ud800"&&a<="\udbff"&&r--}else s>="\ud800"&&s<="\udbff"&&r++;return e.substring(n,r)}function VF(e){return DF.exec(e)}function UF(e){return OF.exec(e)}function HF(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var s=e;t>i&&s.length>1;){for(var a=s.length*(i/t)|0,o=GF(s,a),u=t-n(o),h=o,l=0,c=0;u>i&&c++<100;)a*=i/u,u=t-n(o=GF(s,a|=0));for(c=0;o&&u<=i&&c++<100;){var _=BF.exec(o);h=o,u=t-n(o=GF(s,a+=l=_?_[0].length:1))}0==(a-=l)?(a=1,h=GF(s,1)):1===a&&s[0]>="\ud800"&&s[0]<="\udbff"&&(a=2,h=GF(s,2));var f=GF(s,0,a),d=void 0;PF.test(h||o)&&(0==(a-=(d=MF.exec(f))?d[0].length:0)&&(a=1),h=GF(s,a),f=GF(s,0,a)),DF.test(h)&&(d=OF.exec(f))&&f!==d[0]&&(h=GF(s,a-=d[0].length),f=GF(s,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),t=n(s=h||o)}return(0===r.length||(s=s.trim()).length>0)&&r.push(s),r}var zF,WF=function(){function e(){n(this,e),this.pool=[]}return s(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=M.document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){this.pool.length>=Lt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)}}],[{key:"getInstance",value:function(){return kF||(kF=new e),kF}}]),e}(),XF=cn.WHITE.clone(),jF=function e(){n(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},qF="rgba(255, 255, 255, ".concat((1/255).toFixed(3),")"),YF=function(){function e(t,i){n(this,e),this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=i,this.hash="".concat(t.charCodeAt(0)).concat(i.hash)}return s(e,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.image=null,WF.getInstance().put(this.data)}},{key:"_updateProperties",value:function(){if(this.data=WF.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=FF(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+RF)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*RF/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new bd),this.image.reset(this.canvas)}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,i,n),e.fillStyle=qF,e.fillRect(0,0,i,n),e.font=t.fontDesc;var r=t.fontSize,s=i/2,a=n/2+r*xF+0*r,o=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ",1,")"),t.isOutlined){var u=t.out||XF;e.strokeStyle="rgba(".concat(u.r,", ").concat(u.g,", ").concat(u.b,", ").concat(u.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,s,a)}e.fillText(this.char,s,a)}}}]),e}(),KF=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"initWithSize",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:td.RGBA8888;this.reset({width:e,height:t,format:i})}},{key:"drawTextureAt",value:function(e,t,i){var n=this.getGFXTexture();if(e&&n){var r=this._getGFXDevice();if(r){var s=new Mc;s.texOffset.x=t,s.texOffset.y=i,s.texExtent.width=e.width,s.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],n,[s])}else console.warn("Unable to get device")}}}]),i}(Qm),QF=function(){function e(t,i){n(this,e),this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var r=new KF;r.initWithSize(t,i),this.fontDefDictionary=new EF(r),this._halfBleed=1,this._width=t,this._height=i,DN.on(PN.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return s(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"insertLetterTexture",value:function(e){var t=e.image,i=DN.root.device;if(!t||!this.fontDefDictionary||!i)return null;var n=t.width,r=t.height;if(this._x+n+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return ae(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var s=new jF;return s.u=this._x+this._halfBleed,s.v=this._y+this._halfBleed,s.texture=this.fontDefDictionary.texture,s.valid=!0,s.w=e.width-2,s.h=e.height-2,s.xAdvance=s.w,s.offsetY=e.offsetY,this._x+=n+0,this.fontDefDictionary.addLetterDefinitions(e.hash,s),s}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()}},{key:"destroy",value:function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)}},{key:"getTexture",value:function(){return this.fontDefDictionary.getTexture()}},{key:"beforeSceneLoad",value:function(){this.clearAllCache()}},{key:"clearAllCache",value:function(){this.destroy();var e=new KF;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e}},{key:"getLetter",value:function(e){return this.fontDefDictionary.letterDefinitions[e]}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,n=this.fontDefDictionary.letterDefinitions[i];if(!n){var r=new YF(e,t);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n}}]),e}(),JF={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:cn.WHITE.clone(),isOutlined:!1,out:cn.WHITE.clone(),margin:0},ZF=[new i_(Tc.ATTR_POSITION,Ll.RGB32F)],$F=[new i_(Tc.ATTR_POSITION,Ll.RGB32F),new i_(Tc.ATTR_COLOR,Ll.RGBA32F)],eG=[new i_(Tc.ATTR_POSITION,Ll.RGB32F),new i_(Tc.ATTR_TEX_COORD,Ll.RG32F),new i_(Tc.ATTR_COLOR,Ll.RGBA32F)],tG=[new i_(Tc.ATTR_POSITION,Ll.RGB32F),new i_(Tc.ATTR_TEX_COORD,Ll.RG32F),new i_(Tc.ATTR_COLOR,Ll.RGBA8,!0)],iG=[new i_(Tc.ATTR_POSITION,Ll.RGB32F),new i_(Tc.ATTR_TEX_COORD,Ll.RG32F),new i_(Tc.ATTR_COLOR,Ll.RGBA32F),new i_(Tc.ATTR_COLOR2,Ll.RGBA32F)],nG=[new i_(Tc.ATTR_POSITION,Ll.RGB32F),new i_(Tc.ATTR_TEX_COORD,Ll.RG32F),new i_(Tc.ATTR_COLOR,Ll.RGBA8,!0),new i_(Tc.ATTR_COLOR2,Ll.RGBA8,!0)];function rG(e){for(var t=0,i=0;i<e.length;i++){var n=e[i];t+=x_[n.format].count}return t}function sG(e){for(var t=0,i=0;i<e.length;i++){var n=e[i];t+=x_[n.format].size}return t}B.internal.vfmtPosUvColor=eG,B.internal.vfmtPosUvTwoColor=iG,B.internal.vfmtPosUvColor4B=tG,B.internal.vfmtPosUvTwoColor4B=nG,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:ZF,vfmtPosColor:$F,vfmtPosUvColor:eG,vfmtPosUvColor4B:tG,vfmtPosUvTwoColor:iG,vfmtPosUvTwoColor4B:nG,getComponentPerVertex:rG,getAttributeStride:sG})),function(e){e[e.byteOffset=0]="byteOffset",e[e.vertexOffset=1]="vertexOffset",e[e.indexOffset=2]="indexOffset",e[e.dirty=3]="dirty",e[e.count=4]="count"}(zF||(zF={}));var aG,oG,uG,hG,lG,cG,_G=e("MeshBuffer",function(){function e(){n(this,e),this._byteOffset=0,this._vertexOffset=0,this._indexOffset=0,this._dirty=!1,this._floatsPerVertex=0,this._vData=null,this._iData=null,this._vertexFormatBytes=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0,this.initSharedBuffer(),this.syncSharedBufferToNative()}return s(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"byteOffset",get:function(){return this._byteOffset},set:function(e){this._byteOffset=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"indexOffset",get:function(){return this._indexOffset},set:function(e){this._indexOffset=e}},{key:"dirty",get:function(){return this._dirty},set:function(e){this._dirty=e}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex},set:function(e){this._floatsPerVertex=e}},{key:"vData",get:function(){return this._vData},set:function(e){this._vData=e}},{key:"iData",get:function(){return this._iData},set:function(e){this._iData=e}},{key:"nativeObj",get:function(){return this._nativeObj}},{key:"sharedBuffer",get:function(){return this._sharedBuffer}},{key:"initSharedBuffer",value:function(){}},{key:"syncSharedBufferToNative",value:function(){}},{key:"initialize",value:function(e,t,i,n){this._initVDataCount=i,this._initIDataCount=n,this._attributes=t,this.floatsPerVertex=sG(t)>>2,this._initVDataCount,this._floatsPerVertex,_e(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))}},{key:"reset",value:function(){this._nextFreeIAHandle=0,this.dirty=!1}},{key:"destroy",value:function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0}},{key:"setDirty",value:function(){this.dirty=!0}},{key:"request",value:function(){return ae(9002),!1}},{key:"requireFreeIA",value:function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia}},{key:"recycleIA",value:function(e){for(var t=this._iaPool,i=0;i<this._nextFreeIAHandle;++i)if(e===t[i].ia){var n=t[i];return t[i]=t[--this._nextFreeIAHandle],void(t[this._nextFreeIAHandle]=n)}}},{key:"checkCapacity",value:function(e,t){var i=(this.vertexOffset+e)*this._floatsPerVertex,n=this.indexOffset+t;return!(i>this._initVDataCount||n>this._initIDataCount)}},{key:"uploadBuffers",value:function(){if(0!==this.byteOffset&&this._dirty){var e=Sl.__isWebIOS14OrIPadOS14Env,t=e?this._nextFreeIAHandle:1;if(e&&t/this._iaPool.length<.5){for(var i=t/.5,n=this._iaPool.length-1;n>=i;n--){var r=this._iaPool[n];r.vertexBuffers[0]&&r.vertexBuffers[0].destroy(),r.indexBuffer&&r.indexBuffer.destroy(),r.ia.destroy()}this._iaPool.length=i}for(var s=this.byteOffset,a=this.indexOffset,o=0;o<t;++o){var u=this._iaPool[o],h=new Float32Array(this.vData.buffer,0,s>>2),l=new Uint16Array(this.iData.buffer,0,a),c=u.vertexBuffers[0];s>c.size&&c.resize(s),c.update(h),2*a>u.indexBuffer.size&&u.indexBuffer.resize(2*a),u.indexBuffer.update(l)}this.dirty=!1}}},{key:"createNewIA",value:function(e){var t,i,n;if(Sl.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,s=Uint16Array.BYTES_PER_ELEMENT,a=e.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,r,r));n=e.createBuffer(new Gc(Gl.INDEX|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,s,s)),i=[a],this._iaInfo=new r_(this._attributes,i,n),t=e.createInputAssembler(this._iaInfo)}else t=e.createInputAssembler(this._iaInfo),i=this._iaInfo.vertexBuffers,n=this._iaInfo.indexBuffer;return{ia:t,vertexBuffers:i,indexBuffer:n}}}]),e}()),fG=function(){function e(t,i){n(this,e),this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=t,this._attributes=i,this._floatsPerVertex=sG(i)>>2,this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}return s(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}},{key:"initialize",value:function(){}},{key:"reset",value:function(){}},{key:"request",value:function(){}},{key:"appendBuffers",value:function(){}},{key:"uploadBuffers",value:function(){}},{key:"destroy",value:function(){this._attributes.length=0}}]),e}(),dG=new Eh((function(){return{offset:0,length:0}}),32),mG=function(){function e(t,i,r,s,a,o){n(this,e),this._ib=void 0,this.vertexAccessor=t,this.bufferId=i,this.meshBuffer=r,this.vertexOffset=s,this.vb=a,this.indexCount=o,this._ib=new Uint16Array(o),t.getMeshBuffer(i)}return s(e,[{key:"ib",get:function(){return this._ib}},{key:"setIndexBuffer",value:function(){}}]),e}(),pG=function(e){h(i,e);var t=v(i);function i(e,r,s,a){var o;return n(this,i),(o=t.call(this,e,r))._freeLists=[],o._vCount=0,o._iCount=0,o._id=0,o._vCount=s||Math.floor(1024*Lt.BATCHER2D_MEM_INCREMENT/o._vertexFormatBytes),o._iCount=a||o._vCount*i.IB_SCALE,o._id=i.generateID(),o._allocateBuffer(),o}return s(i,[{key:"id",get:function(){return this._id}},{key:"destroy",value:function(){for(var e=0;e<this._buffers.length;++e){this._buffers[e].destroy();for(var t=this._freeLists[e],n=0;n<t.length;++n)dG.free(t[n])}this._buffers.length=0,this._freeLists.length=0,g(l(i.prototype),"destroy",this).call(this)}},{key:"reset",value:function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}}},{key:"getVertexBuffer",value:function(e){return this._buffers[e].vData}},{key:"getIndexBuffer",value:function(e){return this._buffers[e].iData}},{key:"getMeshBuffer",value:function(e){return this._buffers[e]}},{key:"uploadBuffers",value:function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],i=this._buffers[e];(!t||t.length<i.vData.byteLength)&&i.uploadBuffers()}}},{key:"appendIndices",value:function(e,t){var i=this._buffers[e];if(t.length){var n=i.indexOffset+t.length;if(i.iData.length<n){var r=Math.floor(1.25*n),s=new Uint16Array(r);s.set(i.iData),i.iData=s}i.iData.set(t,i.indexOffset),i.indexOffset+=t.length}}},{key:"allocateChunk",value:function(e,t){for(var i,n=e*this.vertexFormatBytes,r=null,s=0,a=-1,o=null,u=0;u<this._buffers.length;++u){r=this._buffers[u],i=this._freeLists[u];for(var h=0;h<i.length;++h)if(i[h].length>=n){o=i[h],s=u,a=h;break}if(o)break}if(o||(s=this._allocateBuffer(),(r=this._buffers[s])&&r.checkCapacity(e,t)&&(a=0,o=this._freeLists[s][a])),o){var l=o.offset/this.vertexFormatBytes,c=new Float32Array(r.vData.buffer,o.offset,n>>2).fill(0);return this._allocateChunkFromEntry(s,a,o,n),new mG(this,s,r,l,c,t)}return ue(9004,n),null}},{key:"recycleChunk",value:function(e){var t=this._freeLists[e.bufferId],i=this._buffers[e.bufferId],n=e.vertexOffset*this.vertexFormatBytes,r=e.vb.byteLength;if(0!==r){for(var s=!1,a=0,o=null,u=t[a];u&&u.offset<n;)o=u,u=t[++a];if(o&&0==n-(o.offset+o.length)&&(o.length+=r,n=o.offset,r=o.length,u&&u.offset-(n+r)==0&&(o.length+=u.length,t.splice(a,1),dG.free(u),u=null),s=!0),!s&&u){if(0==u.offset-(n+r))u.offset=n,u.length+=r;else{var h=dG.alloc();h.offset=n,h.length=r,t.splice(a,0,h)}s=!0}if(s)n+r===i.byteOffset&&(i.byteOffset=n);else{var l=dG.alloc();l.offset=n,l.length=r,t.push(l)}}}},{key:"_allocateChunkFromEntry",value:function(e,t,i,n){var r=i.length-n,s=i.offset+n,a=this._buffers[e];a.byteOffset<s&&(a.byteOffset=s),ce(r>=0,9004,e,i.offset,i.length),0===r?(this._freeLists[e].splice(t,1),dG.free(i)):(i.offset+=n,i.length=r)}},{key:"_allocateBuffer",value:function(){ce(this._buffers.length===this._freeLists.length,9003);var e=new _G,t=this._vCount*this._floatsPerVertex;e.initialize(this._device,this._attributes,t,this._iCount),this._buffers.push(e);var i=dG.alloc();i.offset=0,i.length=e.vData.byteLength;var n=[i];return this._freeLists.push(n),DN.root.batcher2D.syncMeshBuffersToNative(this.id,this._buffers),this._buffers.length-1}}],[{key:"generateID",value:function(){return i.ID_COUNT++}}]),i}(fG);pG.IB_SCALE=4,pG.ID_COUNT=0,function(e){e[e.DrawInfoType=0]="DrawInfoType",e[e.VertDirty=1]="VertDirty",e[e.IsMeshBuffer=2]="IsMeshBuffer",e[e.Stride=3]="Stride",e[e.Count=4]="Count"}(aG||(aG={})),function(e){e[e.BufferID=0]="BufferID",e[e.AccessorID=1]="AccessorID",e[e.Count=2]="Count"}(oG||(oG={})),function(e){e[e.VertexOffset=0]="VertexOffset",e[e.IndexOffset=1]="IndexOffset",e[e.VBCount=2]="VBCount",e[e.IBCount=3]="IBCount",e[e.DataHash=4]="DataHash",e[e.Count=5]="Count"}(uG||(uG={})),function(e){e[e.COMP=0]="COMP",e[e.MODEL=1]="MODEL",e[e.MIDDLEWARE=2]="MIDDLEWARE",e[e.SUB_NODE=3]="SUB_NODE"}(hG||(hG={})),s((function e(t){n(this,e),this._accId=-1,this._bufferId=-1,this._vertexOffset=0,this._indexOffset=0,this._vb=null,this._ib=null,this._vData=null,this._iData=null,this._vertDirty=!1,this._vbCount=0,this._ibCount=0,this._dataHash=0,this._isMeshBuffer=!1,this._material=null,this._texture=null,this._sampler=null,this._stride=0,this._useLocal=!1,this._model=null,this._drawInfoType=hG.COMP,this._subNode=null,this._uint8SharedBuffer=void 0,this._uint16SharedBuffer=void 0,this._uint32SharedBuffer=void 0,this.init(t);var i=this._nativeObj.getAttrSharedBufferForJS(),r=0;this._uint8SharedBuffer=new Uint8Array(i,r,aG.Count),r+=aG.Count*Uint8Array.BYTES_PER_ELEMENT,this._uint16SharedBuffer=new Uint16Array(i,r,oG.Count),r+=oG.Count*Uint16Array.BYTES_PER_ELEMENT,this._uint32SharedBuffer=new Uint32Array(i,r,uG.Count)}),[{key:"nativeObj",get:function(){return this._nativeObj}},{key:"render2dBuffer",get:function(){return this._render2dBuffer}},{key:"init",value:function(){}},{key:"clear",value:function(){this._bufferId=0,this._vertexOffset=0,this._indexOffset=0,this._vertDirty=!1}},{key:"setAccId",value:function(e){this._accId=e}},{key:"setBufferId",value:function(e){this._bufferId=e}},{key:"setAccAndBuffer",value:function(e,t){this._bufferId=t,this._accId=e}},{key:"setVertexOffset",value:function(e){this._vertexOffset=e}},{key:"setIndexOffset",value:function(e){this._indexOffset=e}},{key:"setVB",value:function(){}},{key:"setIB",value:function(){}},{key:"setVData",value:function(){}},{key:"setIData",value:function(){}},{key:"setVBCount",value:function(e){this._vbCount=e}},{key:"setIBCount",value:function(){}},{key:"setVertDirty",value:function(e){this._vertDirty=e}},{key:"setDataHash",value:function(e){this._dataHash=e}},{key:"setIsMeshBuffer",value:function(e){this._isMeshBuffer=e}},{key:"setMaterial",value:function(e){this._material=e}},{key:"setTexture",value:function(e){this._texture=e}},{key:"setSampler",value:function(e){this._sampler=e}},{key:"setModel",value:function(){}},{key:"setDrawInfoType",value:function(e){this._drawInfoType=e}},{key:"setSubNode",value:function(e){this._subNode=e}},{key:"setStride",value:function(e){this._stride=e}},{key:"initRender2dBuffer",value:function(){}},{key:"fillRender2dBuffer",value:function(){}}]),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(lG||(lG={})),function(e){e[e.stencilTest=0]="stencilTest",e[e.func=1]="func",e[e.stencilMask=2]="stencilMask",e[e.writeMask=3]="writeMask",e[e.failOp=4]="failOp",e[e.zFailOp=5]="zFailOp",e[e.passOp=6]="passOp",e[e.ref=7]="ref",e[e.count=8]="count"}(cG||(cG={}));var vG,yG,gG,SG,AG,TG=e("StencilManager",function(){function e(){n(this,e),this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Jl.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Zl.KEEP,zFailOp:Zl.KEEP,passOp:Zl.KEEP,ref:1},this._stage=lG.DISABLED,this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}return s(e,[{key:"stage",get:function(){return this._stage},set:function(e){this._stage=e}},{key:"pattern",get:function(){return this._stencilPattern}},{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(e){return e.stencilStage!==lG.ENTER_LEVEL?lG.CLEAR_INVERTED:lG.CLEAR}},{key:"enableMask",value:function(){this.stage=lG.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=lG.DISABLED:this.stage=lG.ENABLED)}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"getMaskStackSize",value:function(){return this._maskStack.length}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=lG.DISABLED}},{key:"destroy",value:function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()}},{key:"getStencilStage",value:function(e,t){var i=0,n=!1,r=!1,s=Jl.LESS,a=this.stencilStateMap;if(t&&t.passes[0]){var o=t.passes[0].depthStencilState,u=0,h=0;o.depthTest&&(u=1),o.depthWrite&&(h=1),i=u|h<<1|o.depthFunc<<2|e<<6|this._maskStack.length<<9,n=o.depthTest,r=o.depthWrite,s=o.depthFunc,a=this.stencilStateMapWithDepth}else i=e<<16|this._maskStack.length;if(a&&a.has(i))return a.get(i);this.setStateFromStage(e);var l=new J_(n,r,s,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(i,l),l}},{key:"getStencilHash",value:function(e){return e<<8|this._maskStack.length}},{key:"setStateFromStage",value:function(e){var t=this._stencilPattern;e===lG.DISABLED?(t.stencilTest=!1,t.func=Jl.ALWAYS,t.failOp=Zl.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===lG.ENABLED?(t.func=Jl.EQUAL,t.failOp=Zl.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===lG.CLEAR?(t.func=Jl.NEVER,t.failOp=Zl.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===lG.CLEAR_INVERTED||e===lG.ENTER_LEVEL?(t.func=Jl.NEVER,t.failOp=Zl.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===lG.ENTER_LEVEL_INVERTED&&(t.func=Jl.NEVER,t.failOp=Zl.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))}}]),e}());TG.sharedManager=null,TG.sharedManager=new TG,function(e){e[e.STATIC=0]="STATIC",e[e.DYNAMIC=1]="DYNAMIC",e[e.CROSSED=2]="CROSSED"}(vG||(vG={})),function(e){e[e.localOpacity=0]="localOpacity",e[e.count=1]="count"}(yG||(yG={})),function(e){e[e.colorR=0]="colorR",e[e.colorG=1]="colorG",e[e.colorB=2]="colorB",e[e.colorA=3]="colorA",e[e.maskMode=4]="maskMode",e[e.count=5]="count"}(gG||(gG={})),function(e){e[e.colorDirty=0]="colorDirty",e[e.enabled=1]="enabled",e[e.useLocal=2]="useLocal",e[e.count=3]="count"}(SG||(SG={})),function(e){e[e.NONE=0]="NONE",e[e.MASK=1]="MASK",e[e.MASK_INVERTED=2]="MASK_INVERTED",e[e.MASK_NODE=3]="MASK_NODE",e[e.MASK_NODE_INVERTED=4]="MASK_NODE_INVERTED"}(AG||(AG={}));var EG,bG,CG,RG,xG,wG,kG,IG,BG,PG,MG,OG,DG,LG,NG,FG,GG,VG,UG,HG,zG=function(){function e(){n(this,e),this._renderEntityType=vG.STATIC,this._dynamicDrawInfoArr=[],this._node=null,this._renderTransform=null,this._stencilStage=lG.DISABLED,this._useLocal=!1,this._maskMode=AG.NONE,this._color=cn.WHITE,this._localOpacity=255,this._colorDirty=!0,this._enabled=!1}return s(e,[{key:"nativeObj",get:function(){return this._nativeObj}},{key:"renderDrawInfoArr",get:function(){return this._dynamicDrawInfoArr}},{key:"renderEntityType",get:function(){return this._renderEntityType}},{key:"color",get:function(){return this._color},set:function(e){this._color=e}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e}},{key:"colorDirty",get:function(){return this._colorDirty},set:function(e){this._colorDirty=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"addDynamicRenderDrawInfo",value:function(){}},{key:"removeDynamicRenderDrawInfo",value:function(){}},{key:"clearDynamicRenderDrawInfos",value:function(){}},{key:"clearStaticRenderDrawInfos",value:function(){}},{key:"setDynamicRenderDrawInfo",value:function(){}},{key:"setMaskMode",value:function(e){this._maskMode=e}},{key:"getStaticRenderDrawInfo",value:function(){return null}},{key:"setNode",value:function(e){this._node=e}},{key:"setRenderTransform",value:function(e){this._renderTransform=e}},{key:"setStencilStage",value:function(e){this._stencilStage=e}},{key:"setUseLocal",value:function(e){this._useLocal=e}},{key:"initSharedBuffer",value:function(){}}]),e}(),WG=sG(eG)>>2,XG=new Eh((function(){return{x:0,y:0,z:0,u:0,v:0,color:cn.WHITE.clone()}}),128),jG=e("BaseRenderData",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:eG;n(this,e),this.chunk=null,this._renderDrawInfo=null,this._material=null,this._dataHash=0,this._isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=eG,this._drawInfoType=hG.COMP,this._multiOwner=!1,this._batcher=null,this._floatStride=t===eG?WG:sG(t)>>2,this._vertexFormat=t}return s(e,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}},{key:"drawInfoType",get:function(){return this._drawInfoType},set:function(e){this._drawInfoType=e,this._renderDrawInfo&&this._renderDrawInfo.setDrawInfoType(e)}},{key:"renderDrawInfo",get:function(){return this._renderDrawInfo}},{key:"material",get:function(){return this._material},set:function(e){this._material=e,this._renderDrawInfo&&this._renderDrawInfo.setMaterial(e)}},{key:"dataHash",get:function(){return this._dataHash},set:function(e){this._dataHash=e,this._renderDrawInfo&&this._renderDrawInfo.setDataHash(e)}},{key:"multiOwner",get:function(){return this._multiOwner},set:function(e){this._multiOwner=e}},{key:"batcher",get:function(){return this._batcher||(this._batcher=DN.root.batcher2D),this._batcher}},{key:"isValid",value:function(){return this._ic>0&&this.chunk.vertexAccessor}},{key:"initRenderDrawInfo",value:function(e){arguments.length>1&&void 0!==arguments[1]||hG.COMP}},{key:"removeRenderDrawInfo",value:function(){}},{key:"setRenderDrawInfoAttributes",value:function(){}}]),e}()),qG=e("RenderData",function(e){h(i,e);var t=v(i);function i(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:eG,s=arguments.length>1?arguments[1]:void 0;return n(this,i),(e=t.call(this,r))._vertDirty=!0,e._textureHash=0,e.indices=null,e.layer=0,e.nodeDirty=!0,e.passDirty=!0,e.textureDirty=!0,e.hashDirty=!0,e._data=[],e._pivotX=0,e._pivotY=0,e._width=0,e._height=0,e._frame=null,e._accessor=null,e.vertexRow=1,e.vertexCol=1,s||(s=e.batcher.switchBufferAccessor(e._vertexFormat)),e._accessor=s,e}return s(i,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)XG.free(t[n]);for(n=i;n<e;n++)t[n]=XG.alloc();t.length=e}this.syncRender2dBuffer()}},{key:"data",get:function(){return this._data}},{key:"vertDirty",get:function(){return this._vertDirty},set:function(e){this._vertDirty=e,this._renderDrawInfo&&e&&this._renderDrawInfo.setVertDirty(e)}},{key:"textureHash",get:function(){return this._textureHash},set:function(e){this._textureHash=e}},{key:"frame",get:function(){return this._frame},set:function(e){this._frame=e,this._renderDrawInfo&&(this._frame?(this._renderDrawInfo.setTexture(this._frame.getGFXTexture()),this._renderDrawInfo.setSampler(this._frame.getGFXSampler())):(this._renderDrawInfo.setTexture(null),this._renderDrawInfo.setSampler(null)))}},{key:"accessor",get:function(){return this._accessor}},{key:"resize",value:function(e,t){e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(e,t),this.updateHash())}},{key:"setRenderDrawInfoAttributes",value:function(){}},{key:"fillDrawInfoAttributes",value:function(){}},{key:"syncRender2dBuffer",value:function(){}},{key:"resizeAndCopy",value:function(e,t){if(e!==this._vc||t!==this._ic||!this.chunk){this._vc=e,this._ic=t;var i=this.chunk;this.chunk=this._accessor.allocateChunk(e,t),i&&(this.chunk.vb.set(i.vb),this._accessor.recycleChunk(i)),this.updateHash()}}},{key:"getMeshBuffer",value:function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null}},{key:"updateNode",value:function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0}},{key:"updatePass",value:function(e){this.material=e.getRenderMaterial(0),this.passDirty=!1,this.hashDirty=!0}},{key:"updateTexture",value:function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0}},{key:"updateHash",value:function(){var e=this.chunk?this.chunk.bufferId:-1,t="".concat(e).concat(this.layer," ").concat(this.textureHash);this.dataHash=bl(t,666),this.hashDirty=!1}},{key:"updateRenderData",value:function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.passDirty=!1,this.hashDirty=!0,this._renderDrawInfo&&this._renderDrawInfo.setMaterial(this.material)),this.nodeDirty){var i=e.node.scene?e._getRenderScene():null;this.layer=e.node.layer,null!==i&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0,this._renderDrawInfo&&(this._renderDrawInfo.setTexture(this.frame?this.frame.getGFXTexture():null),this._renderDrawInfo.setSampler(this.frame?this.frame.getGFXSampler():null))),this.hashDirty&&(this.updateHash(),this._renderDrawInfo&&this._renderDrawInfo.setDataHash(this.dataHash))}},{key:"updateSizeNPivot",value:function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}},{key:"clear",value:function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.frame=null,this.textureHash=0,this.dataHash=0}}],[{key:"add",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:eG,t=arguments.length>1?arguments[1]:void 0,n=new i(e,t);if(!t){var r=DN.root.batcher2D;t=r.switchBufferAccessor(n._vertexFormat)}return n._accessor=t,n}},{key:"remove",value:function(e){e.clear(),e._accessor=null}},{key:"createStaticVBAccessor",value:function(e,t,i){var n=DN.root.device;return new pG(n,e,t,i)}}]),i}(jG)),YG=e("MeshRenderData",function(e){h(i,e);var t=v(i);function i(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:eG;return n(this,i),(e=t.call(this,r))._isMeshBuffer=!0,e.vData=void 0,e.iData=void 0,e.vertexStart=0,e.vertexRange=0,e.indexStart=0,e.indexRange=0,e.lastFilledIndex=0,e.lastFilledVertex=0,e.frame=void 0,e._byteLength=0,e._vertexBuffers=[],e._indexBuffer=null,e._iaPool=null,e._iaInfo=null,e.vData=new Float32Array(256*e.stride),e.iData=new Uint16Array(1536),e}return s(i,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}},{key:"request",value:function(e,t){var i=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=i,this.vertexRange=this._vc,this.indexRange=this._ic,!0)}},{key:"reserve",value:function(e,t){var i=this._byteLength+e*this.stride,n=this.indexCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,s=this.iData.length,a=this.vData.length,o=this.iData.length;if(i>r||n>s){for(;r<i||s<n;)r=4*(a*=2),s=o*=2;this._reallocBuffer(a,o)}return!0}},{key:"resize",value:function(e,t){var i=e*this.stride;e>=0&&t>=0&&i<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=i,this.updateRange(0,e,0,t)}},{key:"updateRange",value:function(e,t,i,n){t>=0&&n>=0&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=i,this.vertexRange=t,this.indexRange=n}},{key:"requestIA",value:function(e){this._initIAInfo(e);var t=this._iaPool.add();return t.firstIndex=this.indexStart,t.indexCount=this.indexRange,t}},{key:"uploadBuffers",value:function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),i=new Uint16Array(this.iData.buffer,0,e),n=this._vertexBuffers[0];this._byteLength>n.size&&n.resize(this._byteLength),n.update(t);var r=e<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(i)}}},{key:"freeIAPool",value:function(){this._iaPool&&this._iaPool.reset()}},{key:"reset",value:function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()}},{key:"clear",value:function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)}},{key:"_initIAInfo",value:function(e){var t=this;if(!this._iaInfo){var i=this.stride,n=this._vertexBuffers;n.length||n.push(e.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE,i,i)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=e.createBuffer(new Gc(Gl.INDEX|Gl.TRANSFER_DST,Hl.DEVICE,r,r))),this._iaInfo=new r_(this._vertexFormat,n,this._indexBuffer),this._iaPool=new bh((function(){return e.createInputAssembler(t._iaInfo)}),1,(function(e){e.destroy()}))}}},{key:"_reallocBuffer",value:function(e,t){var i=this.vData;this.vData=new Float32Array(e),i&&this.vData.set(i,0);var n=this.iData;this.iData=new Uint16Array(t),n&&this.iData.set(n,0)}},{key:"setRenderDrawInfoAttributes",value:function(){}},{key:"particleInitRenderDrawInfo",value:function(){}}],[{key:"add",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:eG,t=new i;return t._floatStride=e===eG?WG:sG(e)>>2,t._vertexFormat=e,t}},{key:"remove",value:function(e){e.clear()}}]),i}(jG)),KG=(new bh((function(){return new YG}),32),new In),QG=new In,JG=new an,ZG=new Cn,$G=new Cn,eV=new Cn,tV=new Cn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),iV=new Dn,nV=function(t){return e({UITransform:t,UITransformComponent:t}),t}(Hs("cc.UITransform")(EG=Ws(110)(EG=Xs((wG=xG=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._priority=0,e._contentSize=CG&&CG(),e._anchorPoint=RG&&RG(),e}return s(i,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(rp.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(rp.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(rp.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(rp.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(rp.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(rp.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?ae(6706):(this._priority=e,this.node.parent&&i.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=DN.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=DN.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}},{key:"__preload",value:function(){this.node._uiProps.uiTransformComp=this}},{key:"onLoad",value:function(){this.node.parent&&i.insertChangeMap(this.node.parent)}},{key:"onEnable",value:function(){this.node.on(rp.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()}},{key:"onDisable",value:function(){this.node.off(rp.PARENT_CHANGED,this._parentChanged,this)}},{key:"onDestroy",value:function(){this.node._uiProps.uiTransformComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if(Di((e=e).width,i.width,Mi)&&Di(e.height,i.height,Mi))return;i.width=e.width,i.height=e.height}else{if(Di(e=e,i.width,Mi)&&Di(t,i.height,Mi))return;i.width=e,i.height=t}this.node.emit(rp.SIZE_CHANGED),this._markRenderDataDirty()}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(rp.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()}},{key:"isHit",value:function(e){for(var t=this._contentSize.width,i=this._contentSize.height,n=KG,r=QG,s=this._getRenderScene().cameras,a=0;a<s.length;a++){var o=s[a];if(o.visibility&this.node.layer){o.node.getWorldRT(ZG);var u=ZG.m12,h=ZG.m13,l=Al.center;if(ZG.m12=l.x-(ZG.m00*u+ZG.m04*h),ZG.m13=l.y-(ZG.m01*u+ZG.m05*h),Cn.invert(ZG,ZG),In.transformMat4(n,e,ZG),this.node.getWorldMatrix(eV),Cn.invert(ZG,eV),!Cn.strictEquals(ZG,tV)){In.transformMat4(r,n,ZG),r.x+=this._anchorPoint.x*t,r.y+=this._anchorPoint.y*i;var c=!1;if(r.x>=0&&r.y>=0&&r.x<=t&&r.y<=i&&(c=this._maskTest(n)),c)return!0}}}return!1}},{key:"hitTest",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this._contentSize.width,n=this._contentSize.height,r=JG,s=KG,a=QG,o=this._getRenderScene().cameras,u=0;u<o.length;u++){var h=o[u];if(h.visibility&this.node.layer&&(!h.window||h.window.swapchain)&&h.systemWindowId===t&&(an.set(r,e.x,e.y,0),h.screenToWorld(r,r),In.set(s,r.x,r.y),this.node.getWorldMatrix(eV),Cn.invert(ZG,eV),!Cn.strictEquals(ZG,tV))){In.transformMat4(a,s,ZG),a.x+=this._anchorPoint.x*i,a.y+=this._anchorPoint.y*n;var l=!1;if(a.x>=0&&a.y>=0&&a.x<=i&&a.y<=n&&(l=this._maskTest(s)),l)return!0}}return!1}},{key:"_maskTest",value:function(e){var t,i,n=null===(t=this.node)||void 0===t||null===(i=t.eventProcessor)||void 0===i?void 0:i.maskList;if(n)for(var r=this.node,s=n.length,a=0,o=0;r&&o<s;++a,r=r.parent){var u=n[o];if(a===u.index){if(r!==u.comp.node){n.length=o;break}var h=u.comp;if(h&&h._enabled&&!h.isHit(e))return!1;o++}else if(a>u.index){n.length=o;break}}return!0}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(eV),Cn.invert(ZG,eV),t||(t=new an),an.transformMat4(t,e,ZG)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(eV),t||(t=new an),an.transformMat4(t,e,eV)}},{key:"getBoundingBox",value:function(){Cn.fromRTS($G,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new Dn(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4($G),i}},{key:"getBoundingBoxToWorld",value:function(){if(this.node.parent){var e=this.node.parent.getWorldMatrix();return this.getBoundingBoxTo(e)}return this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){Cn.fromRTS($G,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,n=this._contentSize.height,r=new Dn(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n);if(Cn.multiply(eV,e,$G),r.transformMat4(eV),!this.node.children||0===this.node.children.length)return r;for(var s,a=R(this.node.children);!(s=a()).done;){var o=s.value;if(o&&o.active){var u=o.getComponent(i);if(u){var h=u.getBoundingBoxTo(e);h&&Dn.union(r,r,h)}}}return r}},{key:"getComputeAABB",value:function(e){var t=this._contentSize.width,i=this._contentSize.height;iV.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),iV.transformMat4(this.node.worldMatrix);var n=iV.x+.5*iV.width,r=iV.y+.5*iV.height,s=this.node.worldPosition.z,a=iV.width/2,o=iV.height/2;return null!=e?(ms.set(e,n,r,s,a,o,.001),e):new ms(n,r,s,a,o,.001)}},{key:"_parentChanged",value:function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&i.insertChangeMap(this.node.parent)}},{key:"_markRenderDataDirty",value:function(){var e=this.node._uiProps.uiComp;e&&e.markForUpdateRenderData()}}],[{key:"insertChangeMap",value:function(e){var t=e.uuid;i.priorityChangeNodeMap.has(t)||i.priorityChangeNodeMap.set(t,e)}},{key:"_sortChildrenSibling",value:function(e){var t=e.children;t&&t.sort((function(e,t){var i=e._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp,r=(i?i._priority:0)-(n?n._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))}},{key:"_sortSiblings",value:function(){i.priorityChangeNodeMap.forEach((function(e){i._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),i.priorityChangeNodeMap.clear()}},{key:"_cleanChangeMap",value:function(){i.priorityChangeNodeMap.clear()}}]),i}(tm),xG.EventType=rp,xG.priorityChangeNodeMap=new Map,CG=Ms((bG=wG).prototype,"_contentSize",[Js],(function(){return new Mn(100,100)})),RG=Ms(bG.prototype,"_anchorPoint",[Js],(function(){return new In(.5,.5)})),EG=bG))||EG)||EG)||EG);DN.on(PN.EVENT_AFTER_UPDATE,nV._sortSiblings),DN.on(PN.EVENT_BEFORE_SCENE_LAUNCH,nV._cleanChangeMap),Bt($l),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(HG||(HG=e("InstanceMaterialType",{})));var rV,sV,aV,oV,uV,hV,lV,cV,_V,fV,dV,mV,pV,vV,yV,gV,SV,AV,TV,EV,bV,CV,RV,xV,wV,kV,IV,BV,PV,MV,OV,DV,LV=function(t){return e({UIRenderer:t,RenderComponent:t,UIRenderable:t,Renderable2D:t}),t}((kG=Hs("cc.UIRenderer"),IG=zs(nV),BG=Aa(dA),PG=Aa(dA),kG(MG=IG((UG=VG=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._renderData=null,e._materials=DG&&DG(),e._customMaterial=LG&&LG(),e._srcBlendFactor=NG&&NG(),e._dstBlendFactor=FG&&FG(),e._color=GG&&GG(),e._stencilStage=lG.DISABLED,e._assembler=null,e._postAssembler=null,e._renderDataFlag=!0,e._renderFlag=!0,e._renderEntity=void 0,e._instanceMaterialType=-1,e._srcBlendFactorCache=$l.SRC_ALPHA,e._dstBlendFactorCache=$l.ONE_MINUS_SRC_ALPHA,e._dirtyVersion=-1,e._internalId=-1,e._useVertexOpacity=!1,e._lastParent=null,e._renderEntity=e.createRenderEntity(),e}return s(i,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"useVertexOpacity",get:function(){return this._useVertexOpacity}},{key:"stencilStage",get:function(){return this._stencilStage},set:function(e){this._stencilStage=e,this._renderEntity.setStencilStage(e)}},{key:"batcher",get:function(){return DN.root.batcher2D}},{key:"renderEntity",get:function(){return this._renderEntity}},{key:"onLoad",value:function(){this._renderEntity.setNode(this.node)}},{key:"__preload",value:function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}},{key:"onEnable",value:function(){this.node.on(rp.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(rp.SIZE_CHANGED,this._nodeStateChange,this),this.node.on(rp.PARENT_CHANGED,this._colorDirty,this),this.updateMaterial(),this._colorDirty(),TN.addRenderer(this),this.markForUpdateRenderData()}},{key:"onRestore",value:function(){this.updateMaterial(),this.markForUpdateRenderData()}},{key:"onDisable",value:function(){this.node.off(rp.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(rp.SIZE_CHANGED,this._nodeStateChange,this),this.node.off(rp.PARENT_CHANGED,this._colorDirty,this),TN.removeRenderer(this),this._renderFlag=!1,this._renderEntity.enabled=!1}},{key:"onDestroy",value:function(){if(this._renderEntity.setNode(null),this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}}},{key:"markForUpdateRenderData",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(e){var t=this.renderData;t&&(t.vertDirty=!0),TN.markDirtyRenderer(this)}}},{key:"requestRenderData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:hG.COMP,t=qG.add();return t.initRenderDrawInfo(this,e),this._renderData=t,t}},{key:"destroyRenderData",value:function(){this.renderData&&(this.renderData.removeRenderDrawInfo(this),qG.remove(this.renderData),this._renderData=null)}},{key:"updateRenderer",value:function(){this._assembler&&this._assembler.updateRenderData(this),this._renderFlag=this._canRender(),this._renderEntity.enabled=this._renderFlag}},{key:"fillBuffers",value:function(e){this._renderFlag&&this._render(e)}},{key:"postUpdateAssembler",value:function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(){}},{key:"_postRender",value:function(){}},{key:"_canRender",value:function(){return null!==this.getMaterial(0)&&this._enabled&&this._color.a>0}},{key:"_postCanRender",value:function(){}},{key:"updateMaterial",value:function(){if(this._customMaterial)this.getMaterial(0)!==this._customMaterial&&this.setMaterial(this._customMaterial,0);else{var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this.stencilStage!==lG.ENTER_LEVEL&&this.stencilStage!==lG.ENTER_LEVEL_INVERTED||this.getMaterialInstance(0).recompileShaders({USE_ALPHA_TEST:!0}),this._updateBlendFunc()}}},{key:"_updateColor",value:function(){if(this.node._uiProps.colorDirty=!0,this.setEntityColorDirty(!0),this.setEntityColor(this._color),this.setEntityOpacity(this.node._uiProps.localOpacity),this._assembler){this._assembler.updateColor(this);var e=this._renderFlag;if(this._renderFlag=this._canRender(),this.setEntityEnabled(this._renderFlag),e!==this._renderFlag){var t=this.renderData;t&&(t.vertDirty=!0)}}}},{key:"setEntityColorDirty",value:function(){}},{key:"setEntityColor",value:function(){}},{key:"setEntityOpacity",value:function(){}},{key:"setEntityEnabled",value:function(){}},{key:"_updateBlendFunc",value:function(){var e=this.getRenderMaterial(0).passes[0].blendState.targets[0];if(this._dstBlendFactorCache=e.blendDst,this._srcBlendFactorCache=e.blendSrc,this._dstBlendFactorCache!==this._dstBlendFactor||this._srcBlendFactorCache!==this._srcBlendFactor){(e=this.getMaterialInstance(0).passes[0].blendState.targets[0]).blend=!0,e.blendDstAlpha=$l.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor;var t=this.getMaterialInstance(0).passes[0];t.blendState.setTarget(0,e),t._updatePassHash(),this._dstBlendFactorCache=this._dstBlendFactor,this._srcBlendFactorCache=this._srcBlendFactor}}},{key:"_nodeStateChange",value:function(){this.renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var t=this.node.children[e].getComponent(i);t&&t.markForUpdateRenderData()}}},{key:"_colorDirty",value:function(){this.node._uiProps.colorDirty=!0,this.setEntityColorDirty(!0)}},{key:"_onMaterialModified",value:function(e,t){this.renderData&&(this.markForUpdateRenderData(),this.renderData.passDirty=!0),g(l(i.prototype),"_onMaterialModified",this).call(this,e,t)}},{key:"_updateBuiltinMaterial",value:function(){var e;switch(this._instanceMaterialType){case HG.ADD_COLOR:e=HS.get("ui-base-material");break;case HG.GRAYSCALE:e=HS.get("ui-sprite-gray-material");break;case HG.USE_ALPHA_SEPARATED:e=HS.get("ui-sprite-alpha-sep-material");break;case HG.USE_ALPHA_SEPARATED_AND_GRAY:e=HS.get("ui-sprite-gray-alpha-sep-material");break;default:e=HS.get("ui-sprite-material")}return e}},{key:"setNodeDirty",value:function(){this.renderData&&(this.renderData.nodeDirty=!0)}},{key:"setTextureDirty",value:function(){this.renderData&&(this.renderData.textureDirty=!0)}},{key:"createRenderEntity",value:function(){return new zG(vG.STATIC)}}],[{key:"setEntityColorDirtyRecursively",value:function(e,t){var n=e._uiProps.uiComp;n&&n.color&&(n._renderEntity.colorDirty=t);for(var r=0;r<e.children.length;r++)i.setEntityColorDirtyRecursively(e.children[r],t)}}]),i}(rN),VG.BlendState=$l,VG.Assembler=null,VG.PostAssembler=null,x((OG=UG).prototype,"sharedMaterials",[Ta],Object.getOwnPropertyDescriptor(OG.prototype,"sharedMaterials"),OG.prototype),x(OG.prototype,"customMaterial",[BG],Object.getOwnPropertyDescriptor(OG.prototype,"customMaterial"),OG.prototype),DG=Ms(OG.prototype,"_materials",[Ta],(function(){return[]})),LG=Ms(OG.prototype,"_customMaterial",[PG],(function(){return null})),NG=Ms(OG.prototype,"_srcBlendFactor",[Js],(function(){return $l.SRC_ALPHA})),FG=Ms(OG.prototype,"_dstBlendFactor",[Js],(function(){return $l.ONE_MINUS_SRC_ALPHA})),GG=Ms(OG.prototype,"_color",[Js],(function(){return cn.WHITE.clone()})),MG=OG))||MG)||MG));B.internal.UIRenderer=LV,cn.WHITE.clone(),function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(PV||(PV=e("HorizontalTextAlignment",{}))),Bt(PV),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(MV||(MV=e("VerticalTextAlignment",{}))),Bt(MV),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(OV||(OV=e("Overflow",{}))),Bt(OV),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(DV||(DV=e("CacheMode",{}))),Bt(DV);var NV,FV,GV,VV=function(t){return e({Label:t,LabelComponent:t}),t}((rV=Hs("cc.Label"),sV=Ws(110),aV=Aa(PV),oV=Aa(MV),uV=Aa(OV),hV=Aa(cF),lV=Aa(DV),rV(cV=sV((BV=IV=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._string=fV&&fV(),e._horizontalAlign=dV&&dV(),e._verticalAlign=mV&&mV(),e._actualFontSize=pV&&pV(),e._fontSize=vV&&vV(),e._fontFamily=yV&&yV(),e._lineHeight=gV&&gV(),e._overflow=SV&&SV(),e._enableWrapText=AV&&AV(),e._font=TV&&TV(),e._isSystemFontUsed=EV&&EV(),e._spacingX=bV&&bV(),e._isItalic=CV&&CV(),e._isBold=RV&&RV(),e._isUnderline=xV&&xV(),e._underlineHeight=wV&&wV(),e._cacheMode=kV&&kV(),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._contentWidth=0,e._ttfSpriteFrame=null,e}return s(i,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.markForUpdateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.markForUpdateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.markForUpdateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.markForUpdateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.markForUpdateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.markForUpdateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.markForUpdateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.markForUpdateRenderData())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.markForUpdateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.markForUpdateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this.destroyRenderData(),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==DV.BITMAP||this._font instanceof bF||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===DV.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.markForUpdateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.markForUpdateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.markForUpdateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.markForUpdateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof bF?this._font.fontSize:-1}},{key:"contentWidth",get:function(){return this._contentWidth},set:function(e){this._contentWidth=e}},{key:"onEnable",value:function(){g(l(i.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()}},{key:"onDestroy",value:function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var e=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),e){var t=e;t.image&&t.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,g(l(i.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture()),this._assembler&&this._assembler.updateRenderData(this)}},{key:"_render",value:function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)}},{key:"_updateColor",value:function(){g(l(i.prototype),"_updateColor",this).call(this),this.markForUpdateRenderData()}},{key:"setEntityColor",value:function(){}},{key:"_canRender",value:function(){if(!g(l(i.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof bF){var t=e.spriteFrame;if(!t||!t.texture)return!1}return!0}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this.renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.renderData.material=this.material,this._updateColor())}},{key:"_applyFontTexture",value:function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof bF){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===DV.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new sF,this._assemblerData=this._assembler.getAssemblerData();var i=new bd(this._assemblerData.canvas),n=new Qm;n.image=i,this._ttfSpriteFrame.texture=n}this.cacheMode!==DV.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}}},{key:"changeMaterialForDefine",value:function(){if(this._texture){var e=!1;if(this.cacheMode!==DV.CHAR){var t=this._texture.texture;if(t instanceof kd){var i=t.getPixelFormat();e=i===td.RGBA_ETC1||i===td.RGB_A_PVRTC_4BPPV1||i===td.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?HG.USE_ALPHA_SEPARATED:HG.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}}},{key:"_updateBlendFunc",value:function(){g(l(i.prototype),"_updateBlendFunc",this).call(this)}}]),i}(LV),IV.HorizontalAlign=PV,IV.VerticalAlign=MV,IV.Overflow=OV,IV.CacheMode=DV,IV._canvasPool=WF.getInstance(),x((_V=BV).prototype,"horizontalAlign",[aV],Object.getOwnPropertyDescriptor(_V.prototype,"horizontalAlign"),_V.prototype),x(_V.prototype,"verticalAlign",[oV],Object.getOwnPropertyDescriptor(_V.prototype,"verticalAlign"),_V.prototype),x(_V.prototype,"overflow",[uV],Object.getOwnPropertyDescriptor(_V.prototype,"overflow"),_V.prototype),x(_V.prototype,"font",[hV],Object.getOwnPropertyDescriptor(_V.prototype,"font"),_V.prototype),x(_V.prototype,"cacheMode",[lV],Object.getOwnPropertyDescriptor(_V.prototype,"cacheMode"),_V.prototype),fV=Ms(_V.prototype,"_string",[Js],(function(){return"label"})),dV=Ms(_V.prototype,"_horizontalAlign",[Js],(function(){return PV.CENTER})),mV=Ms(_V.prototype,"_verticalAlign",[Js],(function(){return MV.CENTER})),pV=Ms(_V.prototype,"_actualFontSize",[Js],(function(){return 0})),vV=Ms(_V.prototype,"_fontSize",[Js],(function(){return 40})),yV=Ms(_V.prototype,"_fontFamily",[Js],(function(){return"Arial"})),gV=Ms(_V.prototype,"_lineHeight",[Js],(function(){return 40})),SV=Ms(_V.prototype,"_overflow",[Js],(function(){return OV.NONE})),AV=Ms(_V.prototype,"_enableWrapText",[Js],(function(){return!0})),TV=Ms(_V.prototype,"_font",[Js],(function(){return null})),EV=Ms(_V.prototype,"_isSystemFontUsed",[Js],(function(){return!0})),bV=Ms(_V.prototype,"_spacingX",[Js],(function(){return 0})),CV=Ms(_V.prototype,"_isItalic",[Js],(function(){return!1})),RV=Ms(_V.prototype,"_isBold",[Js],(function(){return!1})),xV=Ms(_V.prototype,"_isUnderline",[Js],(function(){return!1})),wV=Ms(_V.prototype,"_underlineHeight",[Js],(function(){return 2})),kV=Ms(_V.prototype,"_cacheMode",[Js],(function(){return DV.NONE})),cV=_V))||cV)||cV));B.Label=VV,function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(NV||(NV={})),Bt(NV),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(FV||(FV={})),Bt(FV),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(GV||(GV={})),Bt(GV);var UV=Math.PI,HV=Math.min,zV=Math.max,WV=Math.cos,XV=Math.sin,jV=Math.abs,qV=Math.sign,YV=.5522847493;function KV(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*YV,t-n*YV,i+r,t,i+r),e.bezierCurveTo(t+n*YV,i+r,t+n,i+r*YV,t+n,i),e.bezierCurveTo(t+n,i-r*YV,t+n*YV,i-r,t,i-r),e.bezierCurveTo(t-n*YV,i-r,t-n,i-r*YV,t-n,i),e.close()}function QV(e,t,i,n,r,s,a,o,u,h,l){var c,_,f,d,m,p,v,y,g,S,A,T,E,b,C,R;h>10||(m=.5*(s+o),p=.5*(a+u),v=.5*((c=.5*(t+n))+(f=.5*(n+s))),y=.5*((_=.5*(i+r))+(d=.5*(r+a))),((C=jV((n-o)*(b=u-i)-(r-u)*(E=o-t)))+(R=jV((s-o)*b-(a-u)*E)))*(C+R)<e.tessTol*(E*E+b*b)?e.addPoint(o,u,0===l?l|GV.PT_BEVEL:l):(QV(e,t,i,c,_,v,y,A=.5*(v+(g=.5*(f+m))),T=.5*(y+(S=.5*(d+p))),h+1,0),QV(e,A,T,g,S,m,p,o,u,h+1,l)))}var JV,ZV,$V,eU,tU,iU,nU,rU,sU,aU,oU,uU,hU,lU,cU,_U,fU,dU,mU,pU,vU,yU,gU,SU,AU,TU,EU,bU,CU,RU,xU,wU,kU,IU,BU,PU,MU,OU,DU,LU=function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this,e,r)).dx=0,s.dy=0,s.dmx=0,s.dmy=0,s.flags=0,s.len=0,s.reset(),s}return s(i,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),i}(In),NU=function(){function e(){n(this,e),this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return s(e,[{key:"reset",value:function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),FU=function(){function e(t){n(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=cn.WHITE.clone(),this.lineCap=NV.BUTT,this.strokeColor=cn.BLACK.clone(),this.lineJoin=FV.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null,this._comp=void 0,this._comp=t}return s(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,GV.PT_CORNER),this._commandX=e,this._commandY=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,GV.PT_CORNER),this._commandX=e,this._commandY=t}},{key:"bezierCurveTo",value:function(e,t,i,n,r,s){var a=this._curPath,o=a.points[a.points.length-1];o&&(o.x!==e||o.y!==t||i!==r||n!==s?(QV(this,o.x,o.y,e,t,i,n,r,s,0,GV.PT_CORNER),this._commandX=r,this._commandY=s):this.lineTo(r,s))}},{key:"quadraticCurveTo",value:function(e,t,i,n){var r=this._commandX,s=this._commandY;this.bezierCurveTo(r+2/3*(e-r),s+2/3*(t-s),i+2/3*(e-i),n+2/3*(t-n),i,n)}},{key:"arc",value:function(e,t,i,n,r,s){!function(e,t,i,n,r,s,a){var o,u,h=0,l=0,c=0,_=0,f=0,d=0,m=0,p=0,v=0,y=0,g=0,S=0,A=0,T=0;if(l=s-r,a=a||!1)if(jV(l)>=2*UV)l=2*UV;else for(;l<0;)l+=2*UV;else if(jV(l)>=2*UV)l=2*-UV;else for(;l>0;)l-=2*UV;for(u=0|zV(1,HV(jV(l)/(.5*UV)+.5,5)),c=jV(4/3*(1-WV(o=l/u/2))/XV(o)),a||(c=-c),T=0;T<=u;T++)d=t+(_=WV(h=r+l*(T/u)))*n,m=i+(f=XV(h))*n,p=-f*n*c,v=_*n*c,0===T?e.moveTo(d,m):e.bezierCurveTo(y+S,g+A,d-p,m-v,d,m),y=d,g=m,S=p,A=v}(this,e,t,i,n,r,s)}},{key:"ellipse",value:function(e,t,i,n){KV(this,e,t,i,n),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){KV(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,n,r){!function(e,t,i,n,r,s){if(s<.1)e.rect(t,i,n,r);else{var a=HV(s,.5*jV(n))*qV(n),o=HV(s,.5*jV(r))*qV(r);e.moveTo(t,i+o),e.lineTo(t,i+r-o),e.bezierCurveTo(t,i+r-o*(1-YV),t+a*(1-YV),i+r,t+a,i+r),e.lineTo(t+n-a,i+r),e.bezierCurveTo(t+n-a*(1-YV),i+r,t+n,i+r-o*(1-YV),t+n,i+r-o),e.lineTo(t+n,i+o),e.bezierCurveTo(t+n,i+o*(1-YV),t+n-a*(1-YV),i,t+n-a,i),e.lineTo(t+a,i),e.bezierCurveTo(t+a*(1-YV),i,t,i+o*(1-YV),t,i+o),e.close()}}(this,e,t,i,n,r),this._curPath.complex=!1}},{key:"clear",value:function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,i=e.length;t<i;t++){var n=e[t];n&&(YG.remove(n),n.removeRenderDrawInfo(this._comp))}this._renderDataList.length=0}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=YG.add();return this._renderDataList.push(e),e}},{key:"getRenderDataList",value:function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}},{key:"addPoint",value:function(e,t,i){var n=this._curPath;if(n){var r=this._points,s=n.points,a=r[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new LU(e,t),r.push(a)),a.flags=i,s.push(a)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new NU,this.paths.push(t)),this.pathLength++,this._curPath=t,t}}]),e}(),GU=$F.concat([new i_("a_dist",Ll.R32F)]),VU=rG(GU),UU=sG(GU),HU=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((JV=Hs("cc.Graphics"),ZV=Ws(110),$V=Aa(FV),eU=Aa(NV),JV(tU=ZV((lU=hU=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this)).impl=null,e.model=null,e._lineWidth=nU&&nU(),e._strokeColor=rU&&rU(),e._lineJoin=sU&&sU(),e._lineCap=aU&&aU(),e._fillColor=oU&&oU(),e._miterLimit=uU&&uU(),e._isDrawing=!1,e._isNeedUploadData=!0,e._graphicsUseSubMeshes=[],e._instanceMaterialType=HG.ADD_COLOR,e.impl=new FU(m(e)),e}return s(i,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"graphicsNativeProxy",get:function(){return this._graphicsNativeProxy}},{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"onLoad",value:function(){g(l(i.prototype),"onLoad",this).call(this),this.model=DN.root.createModel(Cx),this.model.node=this.model.transform=this.node,this._flushAssembler()}},{key:"onEnable",value:function(){g(l(i.prototype),"onEnable",this).call(this),this._updateMtlForGraphics()}},{key:"onDestroy",value:function(){this._sceneGetter=null,this.model&&(DN.root.destroyModel(this.model),this.model=null);var e=this._graphicsUseSubMeshes.length;if(e>0){for(var t=0;t<e;++t)this._graphicsUseSubMeshes[t].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),g(l(i.prototype),"onDestroy",this).call(this)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,n,r,s){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,s)}},{key:"quadraticCurveTo",value:function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}},{key:"arc",value:function(e,t,i,n,r,s){this.impl&&this.impl.arc(e,t,i,n,r,s)}},{key:"ellipse",value:function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}},{key:"roundRect",value:function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)}},{key:"fillRect",value:function(e,t,i,n){this.rect(e,t,i,n),this.fill()}},{key:"clear",value:function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)}},{key:"fill",value:function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)}},{key:"_updateMtlForGraphics",value:function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=HS.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))}},{key:"activeSubModel",value:function(e){if(this.model){if(this.model.subModels.length<=e){var t=yf.gfxDevice,i=t.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE,65535*UU,UU)),n=t.createBuffer(new Gc(Gl.INDEX|Gl.TRANSFER_DST,Hl.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new _w([i],GU,uc.TRIANGLE_LIST,n);r.subMeshIdx=0,this.model.initSubModel(e,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else ae(4500,this.node.name)}},{key:"_uploadData",value:function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var i=this.model.subModels,n=0;n<t.length;n++){var r=t[n],s=i[n].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*VU);s.vertexBuffers[0].update(a),s.vertexCount=r.vertexStart;var o=new Uint16Array(r.iData.buffer,0,r.indexStart);s.indexBuffer.update(o),s.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}}},{key:"_render",value:function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),i=this.model.subModels.length;if(t.length>i)for(var n=i;n<t.length;n++)this.activeSubModel(n)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!g(l(i.prototype),"_canRender",this).call(this)&&!!this.model&&this._isDrawing}},{key:"updateRenderer",value:function(){g(l(i.prototype),"updateRenderer",this).call(this)}},{key:"createRenderEntity",value:function(){return new zG(vG.DYNAMIC)}}]),i}(LV),hU.LineJoin=FV,hU.LineCap=NV,x((iU=lU).prototype,"lineJoin",[$V],Object.getOwnPropertyDescriptor(iU.prototype,"lineJoin"),iU.prototype),x(iU.prototype,"lineCap",[eU],Object.getOwnPropertyDescriptor(iU.prototype,"lineCap"),iU.prototype),x(iU.prototype,"color",[Ta],Object.getOwnPropertyDescriptor(iU.prototype,"color"),iU.prototype),nU=Ms(iU.prototype,"_lineWidth",[Js],(function(){return 1})),rU=Ms(iU.prototype,"_strokeColor",[Js],(function(){return cn.BLACK.clone()})),sU=Ms(iU.prototype,"_lineJoin",[Js],(function(){return FV.MITER})),aU=Ms(iU.prototype,"_lineCap",[Js],(function(){return NV.BUTT})),oU=Ms(iU.prototype,"_fillColor",[Js],(function(){return cn.WHITE.clone()})),uU=Ms(iU.prototype,"_miterLimit",[Js],(function(){return 10})),tU=iU))||tU)||tU));B.Graphics=HU,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(PU||(PU={})),Bt(PU),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(MU||(MU={})),Bt(MU),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(OU||(OU={})),Bt(OU),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(DU||(DU={}));var zU,WU,XU,jU,qU,YU,KU,QU,JU,ZU,$U,eH=function(t){return e({Sprite:t,SpriteComponent:t}),t}((cU=Hs("cc.Sprite"),_U=Ws(110),fU=Aa(oF),dU=Aa(sF),mU=Aa(PU),pU=Aa(MU),vU=Aa(OU),cU(yU=_U((BU=IU=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._spriteFrame=SU&&SU(),e._type=AU&&AU(),e._fillType=TU&&TU(),e._sizeMode=EU&&EU(),e._fillCenter=bU&&bU(),e._fillStart=CU&&CU(),e._fillRange=RU&&RU(),e._isTrimmedMode=xU&&xU(),e._useGrayscale=wU&&wU(),e._atlas=kU&&kU(),e}return s(i,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===MU.RADIAL||this._fillType===MU.RADIAL?this.destroyRenderData():this.renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===PU.FILLED&&this.renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=Li(e,0,1),this._type===PU.FILLED&&this.renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=Li(e,-1,1),this._type===PU.FILLED&&this.renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===PU.SIMPLE&&this.renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==OU.CUSTOM&&this._applySpriteSize())}},{key:"__preload",value:function(){this.changeMaterialForDefine(),g(l(i.prototype),"__preload",this).call(this)}},{key:"onEnable",value:function(){g(l(i.prototype),"onEnable",this).call(this),this._activateMaterial();var e=this._spriteFrame;e&&(this._updateUVs(),this._type===PU.SLICED&&e.on(sF.EVENT_UV_UPDATED,this._updateUVs,this))}},{key:"onDisable",value:function(){g(l(i.prototype),"onDisable",this).call(this),this._spriteFrame&&this._type===PU.SLICED&&this._spriteFrame.off(sF.EVENT_UV_UPDATED,this._updateUVs,this)}},{key:"onDestroy",value:function(){g(l(i.prototype),"onDestroy",this).call(this)}},{key:"changeSpriteFrameFromAtlas",value:function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")}},{key:"changeMaterialForDefine",value:function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var i=!1;if(e instanceof kd){var n=e.getPixelFormat();i=n===td.RGBA_ETC1||n===td.RGB_A_PVRTC_4BPPV1||n===td.RGB_A_PVRTC_2BPPV1}i&&this.grayscale?this._instanceMaterialType=HG.USE_ALPHA_SEPARATED_AND_GRAY:i?this._instanceMaterialType=HG.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=HG.GRAYSCALE:this._instanceMaterialType=HG.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()}},{key:"_updateBuiltinMaterial",value:function(){var e=g(l(i.prototype),"_updateBuiltinMaterial",this).call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof _x){var t=u({SAMPLE_FROM_RT:!0},e.passes[0].defines),n=new dA;n.initialize({effectAsset:e.effectAsset,defines:t}),e=n}return e}},{key:"_render",value:function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)}},{key:"_canRender",value:function(){if(!g(l(i.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.texture)}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this.renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===PU.SLICED?this._spriteFrame.on(sF.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(sF.EVENT_UV_UPDATED,this._updateUVs,this))}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame)if(OU.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(OU.TRIMMED===this._sizeMode){var t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this.renderData&&(this.renderData.material=t)}},{key:"_updateUVs",value:function(){this._assembler&&this._assembler.updateUVs(this)}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;e&&this._type===PU.SLICED&&e.off(sF.EVENT_UV_UPDATED,this._updateUVs,this);var i=!1;t&&(e&&e.texture===t.texture||(i=!0),i&&(this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===PU.SLICED&&t.on(sF.EVENT_UV_UPDATED,this._updateUVs,this))}}]),i}(LV),IU.FillType=MU,IU.Type=PU,IU.SizeMode=OU,IU.EventType=DU,x((gU=BU).prototype,"spriteAtlas",[fU],Object.getOwnPropertyDescriptor(gU.prototype,"spriteAtlas"),gU.prototype),x(gU.prototype,"spriteFrame",[dU],Object.getOwnPropertyDescriptor(gU.prototype,"spriteFrame"),gU.prototype),x(gU.prototype,"type",[mU],Object.getOwnPropertyDescriptor(gU.prototype,"type"),gU.prototype),x(gU.prototype,"fillType",[pU],Object.getOwnPropertyDescriptor(gU.prototype,"fillType"),gU.prototype),x(gU.prototype,"sizeMode",[vU],Object.getOwnPropertyDescriptor(gU.prototype,"sizeMode"),gU.prototype),SU=Ms(gU.prototype,"_spriteFrame",[Js],(function(){return null})),AU=Ms(gU.prototype,"_type",[Js],(function(){return PU.SIMPLE})),TU=Ms(gU.prototype,"_fillType",[Js],(function(){return MU.HORIZONTAL})),EU=Ms(gU.prototype,"_sizeMode",[Js],(function(){return OU.TRIMMED})),bU=Ms(gU.prototype,"_fillCenter",[Js],(function(){return new In(0,0)})),CU=Ms(gU.prototype,"_fillStart",[Js],(function(){return 0})),RU=Ms(gU.prototype,"_fillRange",[Js],(function(){return 0})),xU=Ms(gU.prototype,"_isTrimmedMode",[Js],(function(){return!0})),wU=Ms(gU.prototype,"_useGrayscale",[Js],(function(){return!1})),kU=Ms(gU.prototype,"_atlas",[Js],(function(){return null})),yU=gU))||yU)||yU));B.Sprite=eH;var tH,iH=new Cn,nH=new In,rH=new Cn,sH=[];!function(e){e[e.GRAPHICS_RECT=0]="GRAPHICS_RECT",e[e.GRAPHICS_ELLIPSE=1]="GRAPHICS_ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.SPRITE_STENCIL=3]="SPRITE_STENCIL"}(tH||(tH={})),Bt(tH);var aH=function(t){return e({Mask:t,MaskComponent:t}),t}((zU=Hs("cc.Mask"),WU=Ws(110),XU=Aa(tH),zU(jU=WU(($U=ZU=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._type=YU&&YU(),e._inverted=KU&&KU(),e._segments=QU&&QU(),e._alphaThreshold=JU&&JU(),e._sprite=null,e._graphics=null,e._stencilStage=lG.DISABLED,e}return s(i,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._type!==tH.SPRITE_STENCIL?(this._sprite&&(this.node.removeComponent(eH),this._sprite._destroyImmediate(),this._sprite=null),this._changeRenderType(),this._updateGraphics()):(this._graphics&&(this._graphics.clear(),this.node.removeComponent(HU),this._graphics._destroyImmediate(),this._graphics=null),this._changeRenderType()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.subComp.stencilStage=this.inverted?lG.ENTER_LEVEL_INVERTED:lG.ENTER_LEVEL}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=Li(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._sprite?this._sprite.spriteFrame:null},set:function(e){this._sprite?this._sprite.spriteFrame=e:console.error("please change type to sprite_stencil first")}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===tH.SPRITE_STENCIL&&this._sprite&&this._sprite.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"subComp",get:function(){return this._graphics||this._sprite}},{key:"onLoad",value:function(){this._changeRenderType()}},{key:"onEnable",value:function(){this._changeRenderType(),this._updateGraphics(),this._enableRender(),this.node.on(rp.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(rp.SIZE_CHANGED,this._nodeStateChange,this)}},{key:"onRestore",value:function(){this._changeRenderType(),this._updateGraphics()}},{key:"onDisable",value:function(){this._disableRender(),this.node.off(rp.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(rp.SIZE_CHANGED,this._nodeStateChange,this)}},{key:"onDestroy",value:function(){this._removeMaskNode()}},{key:"isHit",value:function(e){var t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=i.width,r=i.height,s=nH;this.node.getWorldMatrix(iH),Cn.invert(rH,iH),In.transformMat4(s,e,rH);var a=t.anchorPoint;s.x+=a.x*n,s.y+=a.y*r;var o=!1;if(this.type===tH.GRAPHICS_RECT||this.type===tH.GRAPHICS_STENCIL||this.type===tH.SPRITE_STENCIL)o=s.x>=0&&s.y>=0&&s.x<=n&&s.y<=r;else if(this.type===tH.GRAPHICS_ELLIPSE){var u=n/2,h=r/2,l=s.x-.5*n,c=s.y-.5*r;o=l*l/(u*u)+c*c/(h*h)<1}return this._inverted&&(o=!o),o}},{key:"_nodeStateChange",value:function(){this._updateGraphics()}},{key:"_changeRenderType",value:function(){this._type!==tH.SPRITE_STENCIL?this._createGraphics():this._createSprite()}},{key:"_createSprite",value:function(){if(!this._sprite){var e=this._sprite=this.node.getComponent(eH);if(!e){var t=this.node;e=this._sprite=t.addComponent(eH)}e.color=cn.WHITE.clone(),e.sizeMode=0}this._sprite.stencilStage=this.inverted?lG.ENTER_LEVEL_INVERTED:lG.ENTER_LEVEL,this._sprite.updateMaterial()}},{key:"_createGraphics",value:function(){if(!this._graphics){var e=this._graphics=this.node.getComponent(HU);if(!e){var t=this.node;e=this._graphics=t.addComponent(HU)}e.lineWidth=1;var i=cn.WHITE.clone();i.a=0,e.fillColor=i}this._graphics.stencilStage=this.inverted?lG.ENTER_LEVEL_INVERTED:lG.ENTER_LEVEL}},{key:"_updateGraphics",value:function(){if(this._graphics&&(this._type===tH.GRAPHICS_RECT||this._type===tH.GRAPHICS_ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var i=e.contentSize,n=i.width,r=i.height,s=e.anchorPoint,a=-n*s.x,o=-r*s.y;if(this._type===tH.GRAPHICS_RECT)t.rect(a,o,n,r);else if(this._type===tH.GRAPHICS_ELLIPSE){for(var u=function(e,t,i){sH.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)sH.push(new an(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return sH}(new an(a+n/2,o+r/2,0),new an(n/2,r/2,0),this._segments),h=0;h<u.length;++h){var l=u[h];0===h?t.moveTo(l.x,l.y):t.lineTo(l.x,l.y)}t.close()}t.fill()}}},{key:"_enableRender",value:function(){this.subComp&&(this.subComp.enabled=!0)}},{key:"_disableRender",value:function(){this.subComp&&(this.subComp.stencilStage=lG.DISABLED,this.subComp.updateMaterial(),this.node.activeInHierarchy&&(this.subComp.enabled=!1))}},{key:"_removeMaskNode",value:function(){this._sprite&&(this._sprite.destroy(),this._sprite=null),this._graphics&&(this._graphics.destroy(),this._graphics=null)}},{key:"customMaterial",get:function(){return ae(9007),this.subComp?this.subComp.customMaterial:null},set:function(e){ae(9007),this.subComp&&(this.subComp.customMaterial=e)}},{key:"color",get:function(){return ae(9007),this.subComp?this.subComp.color:null},set:function(e){ae(9007),this.subComp&&e&&(this.subComp.color=e)}},{key:"markForUpdateRenderData",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];ae(9007),this.subComp&&this.subComp.markForUpdateRenderData(e)}},{key:"requestRenderData",value:function(){ae(9007)}},{key:"destroyRenderData",value:function(){ae(9007)}},{key:"updateRenderer",value:function(){ae(9007),this.subComp&&this.subComp.updateRenderer()}},{key:"fillBuffers",value:function(){ae(9007)}},{key:"postUpdateAssembler",value:function(){ae(9007)}},{key:"setNodeDirty",value:function(){ae(9007),this.subComp&&this.subComp.setNodeDirty()}},{key:"setTextureDirty",value:function(){ae(9007),this.subComp&&this.subComp.setTextureDirty()}},{key:"sharedMaterial",get:function(){return ae(9007),this.subComp?this.subComp.sharedMaterial:null}},{key:"sharedMaterials",get:function(){return ae(9007),this.subComp?this.subComp.sharedMaterials:null},set:function(e){ae(9007),this.subComp&&e&&(this.subComp.sharedMaterials=e)}},{key:"material",get:function(){return ae(9007),this.subComp?this.subComp.material:null},set:function(e){ae(9007),this.subComp&&(this.subComp.material=e)}},{key:"materials",get:function(){return ae(9007),this.subComp?this.subComp.materials:[null]},set:function(e){ae(9007),this.subComp&&(this.subComp.materials=e)}},{key:"getMaterial",value:function(e){return ae(9007),this.subComp?this.subComp.getMaterial(e):null}},{key:"setMaterial",value:function(e,t){ae(9007),this.subComp&&this.subComp.setMaterial(e,t)}},{key:"getMaterialInstance",value:function(e){return ae(9007),this.subComp?this.subComp.getMaterialInstance(e):null}},{key:"setMaterialInstance",value:function(e,t){ae(9007),this.subComp&&this.subComp.setMaterialInstance(e,t)}},{key:"getRenderMaterial",value:function(e){return ae(9007),this.subComp?this.subComp.getRenderMaterial(e):null}}]),i}(tm),ZU.Type=tH,x((qU=$U).prototype,"type",[XU],Object.getOwnPropertyDescriptor(qU.prototype,"type"),qU.prototype),YU=Ms(qU.prototype,"_type",[Js],(function(){return tH.GRAPHICS_RECT})),KU=Ms(qU.prototype,"_inverted",[Js],(function(){return!1})),QU=Ms(qU.prototype,"_segments",[Js],(function(){return 64})),JU=Ms(qU.prototype,"_alphaThreshold",[Js],(function(){return.1})),jU=qU))||jU)||jU));rD._maskComp=aH,B.Mask=aH;var oH,uH,hH,lH,cH,_H,fH,dH,mH,pH,vH,yH,gH,SH,AH,TH,EH,bH,CH,RH,xH,wH,kH,IH,BH,PH,MH,OH,DH,LH,NH,FH,GH,VH,UH,HH,zH,WH=/^(click)(\s)*=|(param)(\s)*=/,XH=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,jH=e("HtmlTextParser",function(){function e(){n(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return s(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,i=e.length;t<i;){var n=e.indexOf(">",t),r=-1;if(n>=0&&(r=e.lastIndexOf("<",n))<t-1&&(r=e.indexOf("<",n+1),n=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{var s=e.substring(t,r),a=e.substring(r+1,n);""===a&&(s=e.substring(t,n+1)),this._processResult(s),-1===n?n=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=n+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){e=e.trim();var t={},i=/^(color|size)(\s)*=/.exec(e),n="",r=0,s="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(s=e.substring(r+1).trim(),t.event=this._processEventHandler(s)),t}if((i=/^(br(\s)*\/)/.exec(e))&&i[0].length>0&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="",o=-1;if((i=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&i[0].length>0&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var u;i=XH.exec(e);for(var h=!1;i;){var l=(n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length)).length;if(n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),a=e.substring(l).trim(),o="src"===n?this.getRightQuotationIndex(a):-1,u=(r=a.indexOf(" ",o+1>=a.length?-1:o+1))>-1?a.substr(0,r):a,e=a.substring(r).trim(),u.endsWith("/")&&(u=u.slice(0,-1)),"src"===n){switch(u.charCodeAt(0)){case 34:case 39:h=!0,u=u.slice(1,-1)}t.isImage=!0,t.src=u}else if("height"===n)t.imageHeight=parseInt(u);else if("width"===n)t.imageWidth=parseInt(u);else if("align"===n){switch(u.charCodeAt(0)){case 34:case 39:u=u.slice(1,-1)}t.imageAlign=u.toLowerCase()}else"offset"===n?t.imageOffset=u:"click"===n&&(t.event=this._processEventHandler("".concat(n,"=").concat(u)));t.event&&"param"===n&&(t.event[n]=u.replace(/^"|"$/g,"")),i=XH.exec(e)}return h&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=/^(outline(\s)*[^>]*)/.exec(e)){var c={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var _,f=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=f.exec(e);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),_=(r=(a=e.substring(n.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===n?t.event=this._processEventHandler("".concat(n,"=").concat(_)):"color"===n?c.color=_:"width"===n&&(c.width=parseInt(_)),t.event&&"param"===n&&(t.event[n]=_.replace(/^"|"$/g,"")),i=f.exec(e)}t.outline=c}if((i=/^(on|u|b|i)(\s)*/.exec(e))&&i[0].length>0){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"getRightQuotationIndex",value:function(e){var t=-1,i=-1,n=e.indexOf("'"),r=e.indexOf('"'),s=r>-1&&(r<n||-1===n);return n>-1&&(n<r||-1===r)?(t=n,i=e.indexOf("'",t+1>=e.length?-1:t+1)):s&&(t=r,i=e.indexOf('"',t+1>=e.length?-1:t+1)),i}},{key:"_processEventHandler",value:function(e){for(var t={},i=0,n=!1,r=WH.exec(e);r;){var s=r[0],a="";if(n=!1,'"'===(e=e.substring(s.length).trim()).charAt(0))(i=e.indexOf('"',1))>-1&&(a=e.substring(1,i).trim(),n=!0),i++;else if("'"===e.charAt(0))(i=e.indexOf("'",1))>-1&&(a=e.substring(1,i).trim(),n=!0),i++;else{var o=/(\S)+/.exec(e);i=(a=o?o[0]:"").length}n&&(t[s=s.substring(0,s.length-1).trim()]=a),e=e.substring(i).trim(),r=WH.exec(e)}return t}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){for(var t,i=R(this._specialSymbolArray);!(t=i()).done;){var n=t.value,r=n[0],s=n[1];e=e.replace(r,s)}return e}}]),e}()),qH=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}(Hs("cc.LabelOutline")(oH=Ws(110)(oH=zs(VV)((uH=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._color=hH&&hH(),e._width=lH&&lH(),e}return s(i,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}},{key:"onEnable",value:function(){this._updateRenderData()}},{key:"onDisable",value:function(){this._updateRenderData()}},{key:"_updateRenderData",value:function(){var e=this.node.getComponent(VV);e&&e.updateRenderData(!0)}}]),i}(tm),hH=Ms(uH.prototype,"_color",[Js],(function(){return new cn(0,0,0,255)})),lH=Ms(uH.prototype,"_width",[Js],(function(){return 2})),oH=uH))||oH)||oH)||oH);B.LabelOutline=qH,xe({RenderComponent:{newName:"UIRenderer",since:"1.2.0",removed:!0},UITransformComponent:{newName:"UITransform",since:"1.2.0",removed:!1},CanvasComponent:{newName:"Canvas",since:"1.2.0",removed:!1}}),xe({UIRenderable:{newName:"UIRenderer",since:"3.0.0",removed:!0}}),xe({Renderable2D:{newName:"UIRenderer",since:"3.6.0",removed:!1}});var YH,KH=new an,QH=wt(MR),JH=wt(PR),ZH=wt(OR),$H=wt(LR),ez=wt(DR),tz=wt({SKYBOX:qR|yc.DEPTH_STENCIL,SOLID_COLOR:yc.ALL,DEPTH_ONLY:yc.DEPTH_STENCIL,DONT_CLEAR:yc.NONE}),iz=function(t){return e({Camera:t,CameraComponent:t}),t}((cH=Hs("cc.Camera"),_H=Aa(ep.BitMask),fH=Aa(tz),dH=Aa(QH),mH=Aa(JH),pH=Aa(ZH),vH=Aa($H),yH=Aa(ez),gH=Aa(_x),cH((zH=HH=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._projection=TH&&TH(),e._priority=EH&&EH(),e._fov=bH&&bH(),e._fovAxis=CH&&CH(),e._orthoHeight=RH&&RH(),e._near=xH&&xH(),e._far=wH&&wH(),e._color=kH&&kH(),e._depth=IH&&IH(),e._stencil=BH&&BH(),e._clearFlags=PH&&PH(),e._rect=MH&&MH(),e._aperture=OH&&OH(),e._shutter=DH&&DH(),e._iso=LH&&LH(),e._screenScale=NH&&NH(),e._visibility=FH&&FH(),e._targetTexture=GH&&GH(),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e._cameraType=VH&&VH(),e._trackingType=UH&&UH(),e}return s(i,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===PR.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=Gi(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(i.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?B.director.root&&B.director.root.mainWindow:B.director.root&&B.director.root.tempWindow)}},{key:"cameraType",get:function(){return this._cameraType},set:function(e){this._cameraType!==e&&(this._cameraType=e,this.camera&&(this.camera.cameraType=e))}},{key:"trackingType",get:function(){return this._trackingType},set:function(e){this._trackingType!==e&&(this._trackingType=e,this.camera&&(this.camera.trackingType=e))}},{key:"onLoad",value:function(){this._createCamera()}},{key:"onEnable",value:function(){this.node.hasChangedFlags|=ip.POSITION,this._camera&&this._attachToScene()}},{key:"onDisable",value:function(){this._camera&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,i){return i||(i=er.create()),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t||(t=new an),this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"convertToUINode",value:function(e,t,i){if(i||(i=new an),!this._camera)return i;this.worldToScreen(e,KH);var n=t.getComponent("cc.UITransform"),r=B.view.getVisibleSize(),s=KH.x-.5*this._camera.width,a=KH.y-.5*this._camera.height;return KH.x=s/B.view.getScaleX()+.5*r.width,KH.y=a/B.view.getScaleY()+.5*r.height,n&&n.convertToNodeSpaceAR(KH,i),i}},{key:"_createCamera",value:function(){this._camera||(this._camera=B.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?B.director.root&&B.director.root.mainWindow:B.director.root&&B.director.root.tempWindow,priority:this._priority,cameraType:this.cameraType,trackingType:this.trackingType}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=Gi(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()}},{key:"_attachToScene",value:function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}},{key:"_detachFromScene",value:function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}},{key:"_checkTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)}},{key:"_updateTargetTexture",value:function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}}]),i}(tm),HH.ProjectionType=QH,HH.FOVAxis=JH,HH.ClearFlag=tz,HH.Aperture=ZH,HH.Shutter=$H,HH.ISO=ez,HH.TARGET_TEXTURE_CHANGE="tex-change",TH=Ms((AH=zH).prototype,"_projection",[Js],(function(){return QH.PERSPECTIVE})),EH=Ms(AH.prototype,"_priority",[Js],(function(){return 0})),bH=Ms(AH.prototype,"_fov",[Js],(function(){return 45})),CH=Ms(AH.prototype,"_fovAxis",[Js],(function(){return JH.VERTICAL})),RH=Ms(AH.prototype,"_orthoHeight",[Js],(function(){return 10})),xH=Ms(AH.prototype,"_near",[Js],(function(){return 1})),wH=Ms(AH.prototype,"_far",[Js],(function(){return 1e3})),kH=Ms(AH.prototype,"_color",[Js],(function(){return new cn("#333333")})),IH=Ms(AH.prototype,"_depth",[Js],(function(){return 1})),BH=Ms(AH.prototype,"_stencil",[Js],(function(){return 0})),PH=Ms(AH.prototype,"_clearFlags",[Js],(function(){return tz.SOLID_COLOR})),MH=Ms(AH.prototype,"_rect",[Js],(function(){return new Dn(0,0,1,1)})),OH=Ms(AH.prototype,"_aperture",[Js],(function(){return ZH.F16_0})),DH=Ms(AH.prototype,"_shutter",[Js],(function(){return $H.D125})),LH=Ms(AH.prototype,"_iso",[Js],(function(){return ez.ISO100})),NH=Ms(AH.prototype,"_screenScale",[Js],(function(){return 1})),FH=Ms(AH.prototype,"_visibility",[Js],(function(){return Py})),GH=Ms(AH.prototype,"_targetTexture",[Js],(function(){return null})),VH=Ms(AH.prototype,"_cameraType",[Js],(function(){return NR.DEFAULT})),UH=Ms(AH.prototype,"_trackingType",[Js],(function(){return FR.NO_TRACKING})),x(AH.prototype,"visibility",[_H],Object.getOwnPropertyDescriptor(AH.prototype,"visibility"),AH.prototype),x(AH.prototype,"clearFlags",[fH],Object.getOwnPropertyDescriptor(AH.prototype,"clearFlags"),AH.prototype),x(AH.prototype,"projection",[dH],Object.getOwnPropertyDescriptor(AH.prototype,"projection"),AH.prototype),x(AH.prototype,"fovAxis",[mH],Object.getOwnPropertyDescriptor(AH.prototype,"fovAxis"),AH.prototype),x(AH.prototype,"aperture",[pH],Object.getOwnPropertyDescriptor(AH.prototype,"aperture"),AH.prototype),x(AH.prototype,"shutter",[vH],Object.getOwnPropertyDescriptor(AH.prototype,"shutter"),AH.prototype),x(AH.prototype,"iso",[yH],Object.getOwnPropertyDescriptor(AH.prototype,"iso"),AH.prototype),x(AH.prototype,"targetTexture",[gH],Object.getOwnPropertyDescriptor(AH.prototype,"targetTexture"),AH.prototype),SH=AH))||SH));B.Camera=iz;var nz=new Mn,rz=(a(YH={},Lt.ORIENTATION_AUTO,fl.AUTO),a(YH,Lt.ORIENTATION_LANDSCAPE,fl.LANDSCAPE),a(YH,Lt.ORIENTATION_PORTRAIT,fl.PORTRAIT),YH),sz=e("View",function(e){h(i,e);var t=v(i);function i(){var e;n(this,i),(e=t.call(this))._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var r=az,s=oz;return e._designResolutionSize=new Mn(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Dn(0,0,0,0),e._visibleRect=new Dn(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new uz(r.EQUAL_TO_FRAME,s.EXACT_FIT),e._rpShowAll=new uz(r.EQUAL_TO_FRAME,s.SHOW_ALL),e._rpNoBorder=new uz(r.EQUAL_TO_FRAME,s.NO_BORDER),e._rpFixedHeight=new uz(r.EQUAL_TO_FRAME,s.FIXED_HEIGHT),e._rpFixedWidth=new uz(r.EQUAL_TO_FRAME,s.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}return s(i,[{key:"init",value:function(){var e=gl.windowSize,t=e.width,i=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=i,this._viewportRect.width=t,this._viewportRect.height=i,this._visibleRect.width=t,this._visibleRect.height=i,nz.width=this._visibleRect.width,nz.height=this._visibleRect.height,Al&&Al.init(this._visibleRect),this.resizeWithBrowserSize(!0);var n=Dt.querySettings(Ot.Category.SCREEN,"designResolution");n&&this.setDesignResolutionSize(Number(n.width),Number(n.height),n.policy||uz.FIXED_HEIGHT),vl.on("window-resize",this._updateAdaptResult,this),vl.on("orientation-change",this._updateAdaptResult,this),vl.on("fullscreen-change",this._updateAdaptResult,this)}},{key:"resizeWithBrowserSize",value:function(e){vl.handleResizeEvent=e}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){vl.orientation=rz[e]}},{key:"adjustViewportMeta",value:function(){}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAutoFullScreen",value:function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&gl.requestFullScreen().catch((function(){})))}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){vl.resolutionScale=1;var i=vl.devicePixelRatio,n=new Mn(e*i,t*i);gl.windowSize=n}},{key:"getCanvasSize",value:function(){return gl.windowSize}},{key:"getFrameSize",value:function(){var e=vl.devicePixelRatio,t=gl.windowSize;return t.width/=e,t.height/=e,t}},{key:"setFrameSize",value:function(e,t){var i=vl.devicePixelRatio;gl.windowSize=new Mn(e*i,t*i)}},{key:"getVisibleSize",value:function(){return new Mn(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return new Mn(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return new In(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return new In(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"_updateResolutionPolicy",value:function(e){if(e instanceof uz)this._resolutionPolicy=e;else{var t=uz;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}}},{key:"setResolutionPolicy",value:function(e){this._updateResolutionPolicy(e);var t=lz.getDesignResolutionSize();lz.setDesignResolutionSize(t.width,t.height,e)}},{key:"setDesignResolutionSize",value:function(e,t,i){if(e>0&&t>0){this._updateResolutionPolicy(i);var n=this._resolutionPolicy;n&&n.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var s=this._viewportRect,a=this._visibleRect,o=r.viewport;s.x=o.x,s.y=o.y,s.width=o.width,s.height=o.height,a.x=0,a.y=0,a.width=o.width/this._scaleX,a.height=o.height/this._scaleY}n.postApply(this),nz.width=this._visibleRect.width,nz.height=this._visibleRect.height,Al&&Al.init(this._visibleRect),this.emit("design-resolution-changed")}else ue(2200)}},{key:"getDesignResolutionSize",value:function(){return new Mn(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){document.documentElement.style.width="".concat(e,"px"),document.body.style.width="".concat(e,"px"),document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,i)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return vl.devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new In,r=vl.devicePixelRatio*(e-i.left),s=vl.devicePixelRatio*(i.top+i.height-t);return vl.isFrameRotated?(n.x=gl.windowSize.width-s,n.y=r):(n.x=r,n.y=s),n}},{key:"_convertToUISpace",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_updateAdaptResult",value:function(e,t,i){var n;B.director.root.resize(e,t,void 0===i?1:i);var r=this._designResolutionSize.width,s=this._designResolutionSize.height;e>0&&this.setDesignResolutionSize(r,s,this._resolutionPolicy),this.emit("canvas-resize"),null===(n=this._resizeCallback)||void 0===n||n.call(this)}}]),i}(Uh(Rh)));sz.instance=void 0;var az=function(){function e(){n(this,e),this.name="ContainerStrategy"}return s(e,[{key:"preApply",value:function(){}},{key:"apply",value:function(){}},{key:"postApply",value:function(){}},{key:"_setupCanvas",value:function(){var e=B.game.canvas;if(e){var t=gl.windowSize;e.width=t.width,e.height=t.height}}}]),e}();az.EQUAL_TO_FRAME=void 0,az.PROPORTION_TO_FRAME=void 0;var oz=function(){function e(){n(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return s(e,[{key:"preApply",value:function(){}},{key:"apply",value:function(){return{scale:[1,1]}}},{key:"postApply",value:function(){}},{key:"_buildResult",value:function(e,t,i,n,r,s){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var a=new Dn(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,s],this._result.viewport=a,this._result}}]),e}();oz.EXACT_FIT=void 0,oz.SHOW_ALL=void 0,oz.NO_BORDER=void 0,oz.FIXED_HEIGHT=void 0,oz.FIXED_WIDTH=void 0,function(){var e=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).name="EqualToFrame",e}return s(i,[{key:"apply",value:function(){vl.isProportionalToFrame=!1,this._setupCanvas()}}]),i}(az),t=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).name="ProportionalToFrame",e}return s(i,[{key:"apply",value:function(){vl.isProportionalToFrame=!0,this._setupCanvas()}}]),i}(az);az.EQUAL_TO_FRAME=new e,az.PROPORTION_TO_FRAME=new t;var i=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).name="ExactFit",e}return s(i,[{key:"apply",value:function(e,t){var i=gl.windowSize,n=i.width,r=i.height,s=n/t.width,a=r/t.height;return this._buildResult(n,r,n,r,s,a)}}]),i}(oz),r=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).name="ShowAll",e}return s(i,[{key:"apply",value:function(e,t){var i,n,r=gl.windowSize,s=r.width,a=r.height,o=t.width,u=t.height,h=s/o,l=a/u,c=0;return h<l?(i=s,n=u*(c=h)):(i=o*(c=l),n=a),this._buildResult(s,a,i,n,c,c)}}]),i}(oz),a=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).name="NoBorder",e}return s(i,[{key:"apply",value:function(e,t){var i,n,r,s=gl.windowSize,a=s.width,o=s.height,u=t.width,h=t.height,l=a/u,c=o/h;return l<c?(n=u*(i=c),r=o):(n=a,r=h*(i=l)),this._buildResult(a,o,n,r,i,i)}}]),i}(oz),o=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).name="FixedHeight",e}return s(i,[{key:"apply",value:function(e,t){var i=gl.windowSize,n=i.width,r=i.height,s=r/t.height,a=n,o=r;return this._buildResult(n,r,a,o,s,s)}}]),i}(oz),u=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).name="FixedWidth",e}return s(i,[{key:"apply",value:function(e,t){var i=gl.windowSize,n=i.width,r=i.height,s=n/t.width,a=n,o=r;return this._buildResult(n,r,a,o,s,s)}}]),i}(oz);oz.EXACT_FIT=new i,oz.SHOW_ALL=new r,oz.NO_BORDER=new a,oz.FIXED_HEIGHT=new o,oz.FIXED_WIDTH=new u}();var uz=e("ResolutionPolicy",function(){function e(t,i){n(this,e),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(i)}return s(e,[{key:"canvasSize",get:function(){return gl.windowSize}},{key:"preApply",value:function(e){this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof az&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof oz&&(this._contentStrategy=e)}}]),e}());uz.EXACT_FIT=0,uz.NO_BORDER=1,uz.SHOW_ALL=2,uz.FIXED_HEIGHT=3,uz.FIXED_WIDTH=4,uz.UNKNOWN=5,uz.ContainerStrategy=az,uz.ContentStrategy=oz,B.ResolutionPolicy=uz;var hz,lz=e("view",sz.instance=B.view=new sz);DN.registerSystem("view",lz,0),B.winSize=nz;var cz,_z,fz,dz,mz,pz,vz,yz,gz,Sz=e("RenderRoot2D",Hs("cc.RenderRoot2D")(hz=Ws(100)(hz=zs(nV)(hz=Xs(hz=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"onEnable",value:function(){B.director.root.batcher2D.addScreen(this)}},{key:"onDisable",value:function(){B.director.root.batcher2D.removeScreen(this)}},{key:"onDestroy",value:function(){B.director.root.batcher2D.removeScreen(this)}}]),i}(tm))||hz)||hz)||hz)||hz),Az=new an,Tz=wt({OVERLAY:0,INTERSPERSE:1}),Ez=function(t){return e({Canvas:t,CanvasComponent:t}),t}((cz=Hs("cc.Canvas"),_z=Ws(100),fz=Aa(iz),dz=Aa(iz),cz(mz=_z(mz=Xs((x((pz=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._cameraComponent=vz&&vz(),e._alignCanvasWithScreen=yz&&yz(),e._thisOnCameraResized=void 0,e._fitDesignResolution=void 0,e._pos=new an,e._renderMode=Tz.OVERLAY,e._thisOnCameraResized=e._onResizeCamera.bind(m(e)),e}return s(i,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}},{key:"__preload",value:function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(iz.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(rp.TRANSFORM_CHANGED,this._thisOnCameraResized)}},{key:"onEnable",value:function(){g(l(i.prototype),"onEnable",this).call(this),this._cameraComponent&&this._cameraComponent.node.on(iz.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}},{key:"onDisable",value:function(){g(l(i.prototype),"onDisable",this).call(this),this._cameraComponent&&this._cameraComponent.node.off(iz.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}},{key:"onDestroy",value:function(){g(l(i.prototype),"onDestroy",this).call(this),this.node.off(rp.TRANSFORM_CHANGED,this._thisOnCameraResized)}},{key:"_onResizeCamera",value:function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=Al.height/2;else{var e=gl.windowSize;this._cameraComponent.orthoHeight=e.height/lz.getScaleY()/2}this.node.getWorldPosition(Az),this._cameraComponent.node.setWorldPosition(Az.x,Az.y,1e3)}}},{key:"_getViewPriority",value:function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===Tz.OVERLAY?t|1<<30:t&~(1<<30)}return 0}}]),i}(Sz)).prototype,"cameraComponent",[fz],Object.getOwnPropertyDescriptor(pz.prototype,"cameraComponent"),pz.prototype),vz=Ms(pz.prototype,"_cameraComponent",[dz],(function(){return null})),yz=Ms(pz.prototype,"_alignCanvasWithScreen",[Js],(function(){return!0})),mz=pz))||mz)||mz)||mz));function bz(e,t,i){var n=e.o,r=e.d,s=1/r.x,a=1/r.y,o=1/r.z,u=(t.x-n.x)*s,h=(i.x-n.x)*s,l=(t.y-n.y)*a,c=(i.y-n.y)*a,_=(t.z-n.z)*o,f=(i.z-n.z)*o,d=Math.max(Math.max(Math.min(u,h),Math.min(l,c)),Math.min(_,f)),m=Math.min(Math.min(Math.max(u,h),Math.max(l,c)),Math.max(_,f));return m<0||d>m?0:d>0?d:m}B.Canvas=Ez,pe(e("UIComponent",Hs("cc.UIComponent")(gz=zs(nV)(gz=Ws(110)(gz=Xs(gz=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._lastParent=null,e.stencilStage=lG.DISABLED,e}return s(i,[{key:"__preload",value:function(){this.node._uiProps.uiComp=this}},{key:"onEnable",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}},{key:"postUpdateAssembler",value:function(){}},{key:"markForUpdateRenderData",value:function(){}},{key:"setNodeDirty",value:function(){}},{key:"setTextureDirty",value:function(){}}]),i}(tm))||gz)||gz)||gz)||gz).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),pe(LV.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor"},{name:"dstBlendFactor"}]),me(Ez.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:cn.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),ve(nV.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),B.UITransformComponent=nV,ht(nV,"cc.UITransformComponent"),ht(LV,"cc.RenderComponent"),B.CanvasComponent=Ez,ht(Ez,"cc.CanvasComponent"),B.internal.Renderable2D=LV,ht(LV,"cc.Renderable2D");var Cz,Rz,xz,wz,kz,Iz,Bz,Pz,Mz,Oz=(Cz=us.create(),Rz={distance:1/0,doubleSided:!1,mode:nh.ANY},xz=0,wz=function(e,t,i,n,r,s){e===nh.CLOSEST?(xz>t||0===xz)&&(xz=t,s&&(0===s.length?s.push({distance:t,vertexIndex0:i/3,vertexIndex1:n/3,vertexIndex2:r/3}):(s[0].distance=t,s[0].vertexIndex0=i/3,s[0].vertexIndex1=n/3,s[0].vertexIndex2=r/3))):(xz=t,s&&s.push({distance:t,vertexIndex0:i/3,vertexIndex1:n/3,vertexIndex2:r/3}))},function(e,t,i){if(xz=0,0===t.geometricInfo.positions.length)return xz;var n=void 0===i?Rz:i;if(bz(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,s=t.geometricInfo;!function(e,t,i,n,r){if(i===uc.TRIANGLE_LIST)for(var s=t.length,a=0;a<s;a+=3){var o=3*t[a],u=3*t[a+1],h=3*t[a+2];an.set(Cz.a,e[o],e[o+1],e[o+2]),an.set(Cz.b,e[u],e[u+1],e[u+2]),an.set(Cz.c,e[h],e[h+1],e[h+2]);var l=is.rayTriangle(n,Cz,r.doubleSided);if(!(0===l||l>r.distance)&&(wz(r.mode,l,o,u,h,r.result),r.mode===nh.ANY))return l}else if(i===uc.TRIANGLE_STRIP)for(var c=t.length-2,_=0,f=0;f<c;f+=1){var d=3*t[f-_],m=3*t[f+_+1],p=3*t[f+2];an.set(Cz.a,e[d],e[d+1],e[d+2]),an.set(Cz.b,e[m],e[m+1],e[m+2]),an.set(Cz.c,e[p],e[p+1],e[p+2]),_=~_;var v=is.rayTriangle(n,Cz,r.doubleSided);if(!(0===v||v>r.distance)&&(wz(r.mode,v,d,m,p,r.result),r.mode===nh.ANY))return v}else if(i===uc.TRIANGLE_FAN){var y=t.length-1,g=3*t[0];an.set(Cz.a,e[g],e[g+1],e[g+2]);for(var S=1;S<y;S+=1){var A=3*t[S],T=3*t[S+1];an.set(Cz.b,e[A],e[A+1],e[A+2]),an.set(Cz.c,e[T],e[T+1],e[T+2]);var E=is.rayTriangle(n,Cz,r.doubleSided);if(!(0===E||E>r.distance)&&(wz(r.mode,E,g,A,T,r.result),r.mode===nh.ANY))return E}}}(s.positions,s.indices,r,e,n)}return xz}),Dz=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:nh.ANY};return function(i,n,r){e=0;var s=void 0===r?t:r,a=n.renderingSubMeshes.length,o=n.struct.minPosition,u=n.struct.maxPosition;if(o&&u&&!bz(i,o,u))return e;for(var h=0;h<a;h++){var l=n.renderingSubMeshes[h],c=Oz(i,l,s);if(c)if(s.mode===nh.CLOSEST)(0===e||e>c)&&(e=c,s.subIndices&&(s.subIndices[0]=h));else if(e=c,s.subIndices&&s.subIndices.push(h),s.mode===nh.ANY)return c}return e&&s.mode===nh.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),Lz=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:nh.ANY},i=new er,n=new Cn;return function(r,s,a){e=0;var o=void 0===a?t:a,u=s.worldBounds;if(u&&!is.rayAABB(r,u))return e;er.copy(i,r),s.node&&(Cn.invert(n,s.node.getWorldMatrix(n)),an.transformMat4(i.o,r.o,n),an.transformMat4Normal(i.d,r.d,n));for(var h=s.subModels,l=0;l<h.length;l++){var c=h[l].subMesh,_=Oz(i,c,o);if(_)if(o.mode===nh.CLOSEST)(0===e||e>_)&&(e=_,o.subIndices&&(o.subIndices[0]=l));else if(e=_,o.subIndices&&o.subIndices.push(l),o.mode===nh.ANY)return _}return e&&o.mode===nh.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}();is.rayModel=Lz,is.raySubMesh=Oz,is.rayMesh=Dz;var Nz,Fz,Gz,Vz,Uz,Hz,zz,Wz,Xz,jz,qz,Yz,Kz=Js,Qz=Aa;e("PrefabLink",(kz=Hs("cc.PrefabLink"),Iz=Qz(hL),kz((Pz=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).prefab=Mz&&Mz(),e}return i}(tm),Mz=Ms(Pz.prototype,"prefab",[Iz,Kz],(function(){return null})),Bz=Pz))||Bz)),me(iz,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),me(iz.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),B.CameraComponent=iz,ht(iz,"cc.CameraComponent"),B.RenderableComponent=sN,ht(sN,"cc.RenderableComponent"),function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED"}(Yz||(Yz={})),e("SpriteRenderer",(Nz=Hs("cc.SpriteRenderer"),Fz=Ws(100),Gz=Aa(sF),Nz(Vz=Fz((x((Uz=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._spriteFrame=Hz&&Hz(),e._mode=zz&&zz(),e._color=Wz&&Wz(),e._flipX=Xz&&Xz(),e._flipY=jz&&jz(),e._size=qz&&qz(),e._model=null,e}return s(i,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame,this._spriteFrame=e,this._spriteFrame&&(this._spriteFrame.ensureMeshData(),this._spriteFrame.mesh.initialize()),this._updateModels(),this.enabledInHierarchy&&this._attachToScene())}},{key:"model",get:function(){return this._model}},{key:"onLoad",value:function(){this._spriteFrame&&(this._spriteFrame.mesh||this._spriteFrame.ensureMeshData(),this._spriteFrame.mesh.initialize()),this._updateModels()}},{key:"onRestore",value:function(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene()}},{key:"onEnable",value:function(){this._model||this._updateModels(),this._attachToScene()}},{key:"onDisable",value:function(){this._model&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(B.director.root.destroyModel(this._model),this._model=null,this._models.length=0)}},{key:"_updateModels",value:function(){if(this._spriteFrame){var e=this._model;if(e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model){var t=this._spriteFrame.mesh;this._model.createBoundingShape(t.struct.minPosition,t.struct.maxPosition),this._updateModelParams(),this._onUpdateLocalDescriptorSet()}}}},{key:"_createModel",value:function(){var e=this._model=B.director.root.createModel(Cx);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model)}},{key:"_updateModelParams",value:function(){if(this._spriteFrame&&this._model){this._spriteFrame.ensureMeshData();var e=this._spriteFrame.mesh;this.node.hasChangedFlags|=ip.POSITION,this._model.transform.hasChangedFlags|=ip.POSITION;var t=e?e.renderingSubMeshes.length:0,i=e.renderingSubMeshes;if(i)for(var n=0;n<t;++n){var r=this.getRenderMaterial(n);r&&!r.isValid&&(r=null);var s=i[n];s&&this._model.initSubModel(n,s,r||this._getBuiltinMaterial())}this._model.enabled=!0}}},{key:"_getBuiltinMaterial",value:function(){return HS.get("missing-material")}},{key:"_onMaterialModified",value:function(e,t){g(l(i.prototype),"_onMaterialModified",this).call(this,e,t),this._spriteFrame&&this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.inited&&(this._model.setSubModelMaterial(e,t),this._onUpdateLocalDescriptorSet())}},{key:"_onUpdateLocalDescriptorSet",value:function(){if(this._spriteFrame&&this._model&&this._model.inited)for(var e=this._spriteFrame.getGFXTexture(),t=this._spriteFrame.getGFXSampler(),i=this._model.subModels,n=hv.SAMPLER_SPRITE,r=0;r<i.length;r++){var s=i[r].descriptorSet;s.bindTexture(n,e),s.bindSampler(n,t),s.update()}}},{key:"_attachToScene",value:function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}}},{key:"_detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}}]),i}(sN)).prototype,"spriteFrame",[Gz],Object.getOwnPropertyDescriptor(Uz.prototype,"spriteFrame"),Uz.prototype),Hz=Ms(Uz.prototype,"_spriteFrame",[Js],(function(){return null})),zz=Ms(Uz.prototype,"_mode",[Js],(function(){return Yz.SIMPLE})),Wz=Ms(Uz.prototype,"_color",[Js],(function(){return cn.WHITE.clone()})),Xz=Ms(Uz.prototype,"_flipX",[Js],(function(){return!1})),jz=Ms(Uz.prototype,"_flipY",[Js],(function(){return!1})),qz=Ms(Uz.prototype,"_size",[Js],(function(){return new In})),Vz=Uz))||Vz)||Vz));var Jz,Zz,$z,eW,tW,iW,nW,rW,sW,aW,oW,uW,hW,lW,cW,_W,fW,dW,mW,pW,vW,yW,gW,SW,AW=new jH,TW="RICHTEXT_CHILD",EW="RICHTEXT_Image_CHILD",bW=new pt((function(e){if(!B.isValid(e.node))return!1;var t=e.node.getComponent(qH);return t&&(t.width=0),!0}),20),CW=new pt((function(e){return B.isValid(e.node)}),10);function RW(e){return{node:new Jp(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function xW(e,t){var i;e===TW?i=bW._get():e===EW&&(i=CW._get());var n=(i=i||RW(e)).node;return n||(n=new Jp(e)),n.hideFlags|=Ga.Flags.DontSave|Ga.Flags.HideInHierarchy,e===EW?(i.comp=n.getComponent(eH)||n.addComponent(eH),i.comp.spriteFrame=t,i.comp.type=eH.Type.SLICED,i.comp.sizeMode=eH.SizeMode.CUSTOM):(i.comp=n.getComponent(VV)||n.addComponent(VV),i.comp.string=t,i.comp.horizontalAlign=PV.LEFT,i.comp.verticalAlign=MV.TOP,i.comp.underlineHeight=2),n.setPosition(0,0,0),n._uiProps.uiTransformComp.setAnchorPoint(.5,.5),i.node=n,i.lineCount=0,i.styleIndex=0,i.imageOffset="",i.clickParam="",i.clickHandler="",i}var wW,kW=function(t){return e({RichText:t,RichTextComponent:t}),t}((Jz=Hs("cc.RichText"),Zz=Ws(110),$z=Aa(PV),eW=Aa(MV),tW=Aa(cF),iW=Aa(DV),nW=Aa(oF),Jz(rW=Zz((SW=gW=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._lineHeight=aW&&aW(),e._string=oW&&oW(),e._horizontalAlign=uW&&uW(),e._verticalAlign=hW&&hW(),e._fontSize=lW&&lW(),e._maxWidth=cW&&cW(),e._fontFamily=_W&&_W(),e._font=fW&&fW(),e._isSystemFontUsed=dW&&dW(),e._userDefinedFont=mW&&mW(),e._cacheMode=pW&&pW(),e._imageAtlas=vW&&vW(),e._handleTouchEvent=yW&&yW(),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._labelChildrenNum=0,e._updateRichTextStatus=e._updateRichText,e}return s(i,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}},{key:"onLoad",value:function(){this.node.on(rp.LAYER_CHANGED,this._applyLayer,this),this.node.on(rp.ANCHOR_CHANGED,this._updateRichTextPosition,this)}},{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){for(var e,t=R(this._segments);!(e=t()).done;){var i=e.value;i.node.removeFromParent(),i.type===TW?bW.put(i):i.type===EW&&CW.put(i)}this.node.off(rp.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(rp.LAYER_CHANGED,this._applyLayer,this)}},{key:"_addEventListeners",value:function(){this.node.on(rp.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(rp.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))}},{key:"_createFontLabel",value:function(e){return xW(TW,e)}},{key:"_createImage",value:function(e){return xW(EW,e)}},{key:"_onTTFLoaded",value:function(){this._font,this._layoutDirty=!0,this._updateRichText()}},{key:"splitLongStringApproximatelyIn2048",value:function(e,t){var i=[];if(e.length*this.fontSize<=1638.4)return i.push(e),i;if(this._calculateSize(t,e).x<2048)i.push(e);else for(var n=e.split("\n"),r=0;r<n.length;r++)if(this._calculateSize(t,n[r]).x<2048)i.push(n[r]);else{var s=this.splitLongStringOver2048(n[r],t);i.push.apply(i,E(s))}return i}},{key:"splitLongStringOver2048",value:function(e,t){for(var i=[],n=e,r=0,s=n.length/2,a=n.substring(r,s),o=n.substring(s),u=this._calculateSize(t,a),h=(this._calculateSize(t,o),1*this.maxWidth);u.x>h;){if((s/=2)<1){s*=2;break}a=a.substring(r,s),o=n.substring(s),u=this._calculateSize(t,a)}for(var l=1e3,c=1;l&&r<e.length;){for(;l&&u.x<h;){var _=VF(o);_&&_.length>0&&(c=_[0].length),s+=c,a=n.substring(r,s),o=n.substring(s),u=this._calculateSize(t,a),l--}for(;l&&a.length>=2&&u.x>h;)s-=c,a=n.substring(r,s),u=this._calculateSize(t,a),c=1,l--;if(a.length>=2){var f=UF(a);f&&f.length>0&&a!==f[0]&&(s-=f[0].length,a=n.substring(r,s))}if(i.push(a),r=s,s+=a.length,a=n.substring(r,s),o=n.substring(s),l--,this._calculateSize(t,o).x<2048){r=e.length,s=e.length,a=o,i.push(a);break}u=this._calculateSize(t,a)}return i}},{key:"_measureText",value:function(e,t){var i=this,n=function(t){return i._calculateSize(e,t).width};return t?n(t):n}},{key:"_calculateSize",value:function(e,t){var i;return 0===this._labelSegmentsCache.length?(i=this._createFontLabel(t),this._labelSegmentsCache.push(i)):(i=this._labelSegmentsCache[0]).node.getComponent(VV).string=t,i.styleIndex=e,this._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize}},{key:"_onTouchEnded",value:function(e){for(var t,i=this,n=this.node.getComponents(tm),r=function(){var r=t.value,s=r.clickHandler,a=r.clickParam;s&&i._containsTouchLocation(r,e.touch.getUILocation())&&(n.forEach((function(t){var i=t[s];t.enabledInHierarchy&&i&&i.call(t,e,a)})),e.propagationStopped=!0)},s=R(this._segments);!(t=s()).done;)r()}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(nV);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var i=e[t];if(i.name===TW||i.name===EW){i.parent=null;var n=RW(i.name);n.node=i,i.name===TW?(n.comp=i.getComponent(VV),bW.put(n)):(n.comp=i.getComponent(eH),CW.put(n)),this._labelChildrenNum--}}this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;t>=0;t--){var i=this.node.children[t];i.name!==TW&&i.name!==EW||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(VV);n&&(n.string=e)}var r=i.comp;return r.verticalAlign!==this._verticalAlign&&(r.verticalAlign=this._verticalAlign),i.styleIndex=t,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),i.node.layer=this.node.layer,this.node.insertChild(i.node,this._labelChildrenNum++),this._applyTextAttribute(i),this._segments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var n=t;if(this._lineOffsetX>0&&n+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var s=this._getFirstWordLen(e,r,e.length),a=e.substr(r,s),o=this._measureText(i,a);if(!(this._lineOffsetX+o<=this._maxWidth)){if(r>0){var u=e.substr(0,r);this._addLabelSegment(u,i),e=e.substr(r,e.length),n=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=o,r+=s}if(n>this._maxWidth)for(var h=HF(e,n,this._maxWidth,this._measureText(i)),l=0;l<h.length;++l){var c=h[l],_=this._addLabelSegment(c,i).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,h.length>1&&l<h.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;var r=i.style,s=n.style;if(r){if(s){if(!!s.outline!=!!r.outline)return!0;if(r.size!==s.size||r.italic!==s.italic||r.isImage!==s.isImage)return!0;if(r.src!==s.src||r.imageAlign!==s.imageAlign||r.imageHeight!==s.imageHeight||r.imageWidth!==s.imageWidth||r.imageOffset!==s.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(s&&(s.size||s.italic||s.isImage||s.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style,i=t.src,n=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(n){var r=this._createImage(n);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.insertChild(r.node,this._labelChildrenNum++),this._segments.push(r);var s=n.rect.clone(),a=1,o=s.width,u=s.height,h=t.imageWidth||0,l=t.imageHeight||0;l>0?(o*=a=l/u,u*=a):(o*=a=this._lineHeight/u,u*=a),h>0&&(o=h),this._maxWidth>0?(this._lineOffsetX+o>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=o):(this._lineOffsetX+=o,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(o,u),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var c=t.event;c&&(r.clickHandler=c.click,r.clickParam=c.param)}else ae(4400)}}},{key:"_updateRichText",value:function(){if(this.enabledInHierarchy){var e=AW.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],s=r.text;if(void 0!==s){if(""===s){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=(s=this.splitLongStringApproximatelyIn2048(s,n).join("\n")).split("\n"),o=0;o<a.length;++o){var u=a[o];if(""!==u)if(i=!1,this._maxWidth>0){var h=this._measureText(n,u);this._updateRichTextWithMaxWidth(u,h,n),a.length>1&&o<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(u,n),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&o<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(s)&&o===a.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+RF)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var n=e.charAt(t);if(LF(n)||NF(n))return 1;for(var r=1,s=t+1;s<i&&!NF(n=e.charAt(s))&&!LF(n);++s)r++;return r}},{key:"_updateRichTextPosition",value:function(){for(var e=0,t=1,i=this._lineCount,n=this.node._uiProps.uiTransformComp,r=n.anchorX,s=n.anchorY,a=0;a<this._segments.length;++a){var o=this._segments[a],u=o.lineCount;u>t&&(e=0,t=u);var h=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case PV.LEFT:break;case PV.CENTER:h-=this._linesWidth[u-1]/2;break;case PV.RIGHT:h-=this._linesWidth[u-1]}var l=o.node.position;if(o.node.setPosition(e+h,this._lineHeight*(i-u)-this._labelHeight*s,l.z),u===t&&(e+=o.node._uiProps.uiTransformComp.width),o.node.getComponent(eH)){var c=o.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+RF);switch(o.node._uiProps.uiTransformComp.anchorY){case 1:c.y+=_+(f-_)/2;break;case.5:c.y+=f/2;break;default:c.y+=(f-_)/2}if(o.imageOffset){var d=o.imageOffset.split(",");if(1===d.length&&d[0]){var m=parseFloat(d[0]);Number.isInteger(m)&&(c.y+=m)}else if(2===d.length){var p=parseFloat(d[0]),v=parseFloat(d[1]);Number.isInteger(p)&&(c.x+=p),Number.isInteger(v)&&(c.y+=v)}}o.node.position=c}var y=o.node.getComponent(qH);if(y){var g=o.node.position.clone();g.y-=y.width,o.node.position=g}}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return cn[t]?cn[t]:(new cn).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(VV);if(t){this._resetLabelState(t);var i,n=e.styleIndex;if(this._textArray[n]&&(i=this._textArray[n].style),i){if(t.color=this._convertLiteralColorValue(i.color||"white"),t.isBold=!!i.bold,t.isItalic=!!i.italic,t.isUnderline=!!i.underline,i.outline){var r=e.node.getComponent(qH);r||(r=e.node.addComponent(qH)),r.color=this._convertLiteralColorValue(i.outline.color),r.width=i.outline.width}t.fontSize=i.size||this._fontSize,e.clickHandler="",e.clickParam="";var s=i.event;s&&(e.clickHandler=s.click||"",e.clickParam=s.param||"")}t.cacheMode=this._cacheMode,this._font instanceof cF&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0)}}},{key:"_applyLayer",value:function(){for(var e,t=R(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer}},{key:"_resetLabelState",value:function(e){e.fontSize=this._fontSize,e.color=cn.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1}}]),i}(tm),gW.HorizontalAlign=PV,gW.VerticalAlign=MV,x((sW=SW).prototype,"horizontalAlign",[$z],Object.getOwnPropertyDescriptor(sW.prototype,"horizontalAlign"),sW.prototype),x(sW.prototype,"verticalAlign",[eW],Object.getOwnPropertyDescriptor(sW.prototype,"verticalAlign"),sW.prototype),x(sW.prototype,"font",[tW],Object.getOwnPropertyDescriptor(sW.prototype,"font"),sW.prototype),x(sW.prototype,"cacheMode",[iW],Object.getOwnPropertyDescriptor(sW.prototype,"cacheMode"),sW.prototype),x(sW.prototype,"imageAtlas",[nW],Object.getOwnPropertyDescriptor(sW.prototype,"imageAtlas"),sW.prototype),aW=Ms(sW.prototype,"_lineHeight",[Js],(function(){return 40})),oW=Ms(sW.prototype,"_string",[Js],(function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"})),uW=Ms(sW.prototype,"_horizontalAlign",[Js],(function(){return PV.LEFT})),hW=Ms(sW.prototype,"_verticalAlign",[Js],(function(){return MV.TOP})),lW=Ms(sW.prototype,"_fontSize",[Js],(function(){return 40})),cW=Ms(sW.prototype,"_maxWidth",[Js],(function(){return 0})),_W=Ms(sW.prototype,"_fontFamily",[Js],(function(){return"Arial"})),fW=Ms(sW.prototype,"_font",[Js],(function(){return null})),dW=Ms(sW.prototype,"_isSystemFontUsed",[Js],(function(){return!0})),mW=Ms(sW.prototype,"_userDefinedFont",[Js],(function(){return null})),pW=Ms(sW.prototype,"_cacheMode",[Js],(function(){return DV.NONE})),vW=Ms(sW.prototype,"_imageAtlas",[Js],(function(){return null})),yW=Ms(sW.prototype,"_handleTouchEvent",[Js],(function(){return!0})),rW=sW))||rW)||rW));B.RichText=kW;var IW=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(Hs("cc.UIMeshRenderer")(wW=Ws(110)(wW=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._modelComponent=null,e._dirtyVersion=-1,e._internalId=-1,e.stencilStage=lG.DISABLED,e._renderData=null,e._renderEntity=new zG(vG.DYNAMIC),e}return s(i,[{key:"modelComponent",get:function(){return this._modelComponent}},{key:"__preload",value:function(){this.node._uiProps.uiComp=this}},{key:"onEnable",value:function(){TN.addRenderer(this),this.markForUpdateRenderData()}},{key:"onDisable",value:function(){TN.removeRenderer(this),this.renderEntity.enabled=this._canRender()}},{key:"onLoad",value:function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.ModelRenderer"),this._modelComponent?this.renderEntity.setNode(this.node):console.warn("node '".concat(this.node&&this.node.name,"' doesn't have any renderable component"))}},{key:"onDestroy",value:function(){this.renderEntity.setNode(null),this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.ModelRenderer"),this._modelComponent&&(this._modelComponent._sceneGetter=null)}},{key:"_render",value:function(e){if(this._modelComponent){var t=this._modelComponent._collectModels();this._modelComponent._detachFromScene();for(var i=0;i<t.length;i++)t[i].enabled&&e.commitModel(this,t[i],this._modelComponent.material);return!0}return!1}},{key:"fillBuffers",value:function(e){this.enabled&&this._render(e)}},{key:"updateRenderer",value:function(){}},{key:"_uploadRenderData",value:function(){}},{key:"postUpdateAssembler",value:function(){}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterialInstance(t);if(null!=i)for(var n=i.passes,r=n.length,s=0;s<r;s++)n[s]._priority=iv.MAX-11,i.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},s)}}},{key:"markForUpdateRenderData",value:function(){TN.markDirtyRenderer(this)}},{key:"setNodeDirty",value:function(){}},{key:"setTextureDirty",value:function(){}},{key:"_canRender",value:function(){return this.enabled&&null!==this._modelComponent}},{key:"renderEntity",get:function(){return this._renderEntity}},{key:"renderData",get:function(){return this._renderData}}]),i}(tm))||wW)||wW);B.UIMeshRenderer=IW;var BW,PW,MW,OW,DW,LW,NW,FW,GW,VW,UW=ep.Enum.NONE|ep.Enum.UI_3D,HW=function(){function e(){n(this,e),this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=UW,this._inputAssembler=null,this._descriptorSet=null}return s(e,[{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}},{key:"destroy",value:function(){this._passes=[]}},{key:"clear",value:function(){this._inputAssembler=null,this._descriptorSet=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=UW}},{key:"fillPasses",value:function(e,t,i,n){if(e){var r=e.passes;if(!r)return;this._shaders.length=r.length;for(var s=0;s<r.length;s++){this._passes[s]||(this._passes[s]=new QS(B.director.root));var a=r[s],o=this._passes[s];a.update(),t||(t=a.depthStencilState,i=0),o._initPassFromTarget(a,t,i),this._shaders[s]=o.getShaderVariant(n)}}}}]),e}(),zW=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}(Hs("cc.UIStaticBatch")(BW=Ws(110)((x((PW=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._init=!1,e._bufferAccessor=null,e._dirty=!0,e._uiDrawBatchList=[],e}return s(i,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}},{key:"postUpdateAssembler",value:function(){}},{key:"markAsDirty",value:function(){}},{key:"_requireDrawBatch",value:function(){var e=new HW;return e.isStatic=!0,this._uiDrawBatchList.push(e),e}},{key:"_clearData",value:function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1}},{key:"_getBatcher",value:function(){return DN.root&&DN.root.batcher2D?DN.root.batcher2D:(ae(9301),null)}}]),i}(LV)).prototype,"color",[Ta],Object.getOwnPropertyDescriptor(PW.prototype,"color"),PW.prototype),BW=PW))||BW)||BW),WW=e("LabelShadow",Hs("cc.LabelShadow")(MW=Ws(110)(MW=zs(VV)((OW=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._color=DW&&DW(),e._offset=LW&&LW(),e._blur=NW&&NW(),e}return s(i,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}},{key:"onEnable",value:function(){this._updateRenderData()}},{key:"onDisable",value:function(){this._updateRenderData()}},{key:"_updateRenderData",value:function(){var e=this.node.getComponent(VV);e&&e.updateRenderData(!0)}}]),i}(tm),DW=Ms(OW.prototype,"_color",[Js],(function(){return new cn(0,0,0,255)})),LW=Ms(OW.prototype,"_offset",[Js],(function(){return new In(2,2)})),NW=Ms(OW.prototype,"_blur",[Js],(function(){return 2})),MW=OW))||MW)||MW)||MW),XW=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}(Hs("cc.UIOpacity")(FW=Ws(110)(FW=Xs((GW=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._opacity=VW&&VW(),e}return s(i,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=Yt(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255,this.setEntityLocalOpacityDirtyRecursively(!0))}},{key:"setEntityLocalOpacityDirtyRecursively",value:function(){}},{key:"onEnable",value:function(){this.node._uiProps.localOpacity=this._opacity/255,this.setEntityLocalOpacityDirtyRecursively(!0)}},{key:"onDisable",value:function(){this.node._uiProps.localOpacity=1,this.setEntityLocalOpacityDirtyRecursively(!0)}}],[{key:"setEntityLocalOpacityDirtyRecursively",value:function(e,t,n){if(e.isValid){var r=e._uiProps.uiComp,s=e.getComponent(i),a=n;r&&r.color?(r.renderEntity.colorDirty=t,r.renderEntity.localOpacity=s?a*s.opacity/255:a,a=1):s&&(a=a*s.opacity/255);for(var o=0;o<e.children.length;o++)i.setEntityLocalOpacityDirtyRecursively(e.children[o],t||a<1,a)}}}]),i}(tm),VW=Ms(GW.prototype,"_opacity",[Js],(function(){return 255})),FW=GW))||FW)||FW)||FW);B.MaskComponent=aH,ht(aH,"cc.MaskComponent"),B.LabelComponent=VV,ht(VV,"cc.LabelComponent"),B.LabelOutlineComponent=qH,ht(qH,"cc.LabelOutlineComponent"),B.RichTextComponent=kW,ht(kW,"cc.RichTextComponent"),B.SpriteComponent=eH,ht(eH,"cc.SpriteComponent"),B.UIModelComponent=IW,ht(IW,"cc.UIModelComponent"),B.GraphicsComponent=HU,ht(HU,"cc.GraphicsComponent"),ht(zW,"cc.UIStaticBatchComponent"),ht(XW,"cc.UIOpacityComponent"),me(aH.prototype,"Mask",[{name:"graphics",newName:"subComp",target:aH.prototype,targetName:"Mask"}]),me(tH,"MaskType",[{name:"RECT",newName:"GRAPHICS_RECT",target:tH,targetName:"MaskType"},{name:"ELLIPSE",newName:"GRAPHICS_ELLIPSE",target:tH,targetName:"MaskType"},{name:"IMAGE_STENCIL",newName:"SPRITE_STENCIL",target:tH,targetName:"MaskType"}]);var jW=function e(t,i,r){n(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=i,this.y=r};function qW(e,t,i,n,r){var s=0,a=null;if(r===function(e,t,i,n){for(var r=0,s=t,a=i-n;s<i;s+=n)r+=(e[a]-e[s])*(e[s+1]+e[a+1]),a=s;return r}(e,t,i,n)>0)for(s=t;s<i;s+=n)a=_X(s,e[s],e[s+1],a);else for(s=i-n;s>=t;s-=n)a=_X(s,e[s],e[s+1],a);return a&&uX(a,a.next)&&(fX(a),a=a.next),a}function YW(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)return e;t||(t=e);var i=e,n=!1;do{if(n=!1,i.steiner||!uX(i,i.next)&&0!==oX(i.prev,i,i.next))i=i.next;else{if(fX(i),(i=t=i.prev)===i.next)return null;n=!0}}while(n||i!==t);return t}function KW(e,t,i,n,r,s){var a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(e){!a&&s&&iX(e,n,r,s);for(var o=e,u=null,h=null;e.prev!==e.next;)if(u=e.prev,h=e.next,s?JW(e,n,r,s):QW(e))t.push(u.i/i),t.push(e.i/i),t.push(h.i/i),fX(e),e=h.next,o=h.next;else if((e=h)===o){a?1===a?KW(e=ZW(e,t,i),t,i,n,r,s,2):2===a&&$W(e,t,i,n,r,s):KW(YW(e),t,i,n,r,s,1);break}}}function QW(e){var t=e.prev,i=e,n=e.next;if(oX(t,i,n)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(sX(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&oX(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function JW(e,t,i,n){var r=e.prev,s=e,a=e.next;if(oX(r,s,a)>=0)return!1;for(var o=r.x<s.x?r.x<a.x?r.x:a.x:s.x<a.x?s.x:a.x,u=r.y<s.y?r.y<a.y?r.y:a.y:s.y<a.y?s.y:a.y,h=r.x>s.x?r.x>a.x?r.x:a.x:s.x>a.x?s.x:a.x,l=r.y>s.y?r.y>a.y?r.y:a.y:s.y>a.y?s.y:a.y,c=nX(o,u,t,i,n),_=nX(h,l,t,i,n),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&sX(r.x,r.y,s.x,s.y,a.x,a.y,f.x,f.y)&&oX(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=c;){if(f!==e.prev&&f!==e.next&&sX(r.x,r.y,s.x,s.y,a.x,a.y,f.x,f.y)&&oX(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function ZW(e,t,i){var n=e;do{var r=n.prev,s=n.next.next;!uX(r,s)&&hX(r,n,n.next,s)&&lX(r,s)&&lX(s,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(s.i/i),fX(n),fX(n.next),n=e=s),n=n.next}while(n!==e);return n}function $W(e,t,i,n,r,s){var a=e;do{for(var o=a.next.next;o!==a.prev;){if(a.i!==o.i&&aX(a,o)){var u=cX(a,o);return a=YW(a,a.next),u=YW(u,u.next),KW(a,t,i,n,r,s),void KW(u,t,i,n,r,s)}o=o.next}a=a.next}while(a!==e)}function eX(e,t){return e.x-t.x}function tX(e,t){if(t=function(e,t){var i=t,n=e.x,r=e.y,s=-1/0,a=null;do{if(r<=i.y&&r>=i.next.y){var o=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=n&&o>s){if(s=o,o===n){if(r===i.y)return i;if(r===i.next.y)return i.next}a=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!a)return null;if(n===s)return a.prev;var u,h=a,l=a.x,c=a.y,_=1/0;for(i=a.next;i!==h;)n>=i.x&&i.x>=l&&sX(r<c?n:s,r,l,c,r<c?s:n,r,i.x,i.y)&&((u=Math.abs(r-i.y)/(n-i.x))<_||u===_&&i.x>a.x)&&lX(i,e)&&(a=i,_=u),i=i.next;return a}(e,t)){var i=cX(t,e);YW(i,i.next)}}function iX(e,t,i,n){var r=e;do{null===r.z&&(r.z=nX(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,i=null,n=null,r=null,s=null,a=0,o=0,u=0,h=1;do{for(i=e,e=null,s=null,a=0;i;){for(a++,n=i,o=0,t=0;t<h&&(o++,n=n.nextZ);t++);for(u=h;o>0||u>0&&n;)0===o?(r=n,n=n.nextZ,u--):0!==u&&n?i.z<=n.z?(r=i,i=i.nextZ,o--):(r=n,n=n.nextZ,u--):(r=i,i=i.nextZ,o--),s?s.nextZ=r:e=r,r.prevZ=s,s=r;i=n}s.nextZ=null,h*=2}while(a>1)}(r)}function nX(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function rX(e){var t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}function sX(e,t,i,n,r,s,a,o){return(r-a)*(t-o)-(e-a)*(s-o)>=0&&(e-a)*(n-o)-(i-a)*(t-o)>=0&&(i-a)*(s-o)-(r-a)*(n-o)>=0}function aX(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&hX(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&lX(e,t)&&lX(t,e)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,s=(e.y+t.y)/2;do{i.y>s!=i.next.y>s&&r<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)}function oX(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function uX(e,t){return e.x===t.x&&e.y===t.y}function hX(e,t,i,n){return!!(uX(e,t)&&uX(i,n)||uX(e,n)&&uX(i,t))||oX(e,t,i)>0!=oX(e,t,n)>0&&oX(i,n,e)>0!=oX(i,n,t)>0}function lX(e,t){return oX(e.prev,e,e.next)<0?oX(e,t,e.next)>=0&&oX(e,e.prev,t)>=0:oX(e,t,e.prev)<0||oX(e,e.next,t)<0}function cX(e,t){var i=new jW(e.i,e.x,e.y),n=new jW(t.i,t.x,t.y),r=e.next,s=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,s.next=n,n.prev=s,n}function _X(e,t,i,n){var r=new jW(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function fX(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function dX(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,s=qW(e,0,r,i,!0),a=[];if(!s)return a;var o=0,u=0,h=0,l=0,c=0,_=0,f=0;if(n&&(s=function(e,t,i,n){var r,s=[],a=0,o=null;for(a=0,r=t.length;a<r;a++)(o=qW(e,t[a]*n,a<r-1?t[a+1]*n:e.length,n,!1))&&(o===o.next&&(o.steiner=!0),s.push(rX(o)));if(s.sort(eX),!i)return i;for(a=0;a<s.length;a++)tX(s[a],i),i=YW(i,i.next);return i}(e,t,s,i)),e.length>80*i){o=h=e[0],u=l=e[1];for(var d=i;d<r;d+=i)(c=e[d])<o&&(o=c),(_=e[d+1])<u&&(u=_),c>h&&(h=c),_>l&&(l=_);f=Math.max(h-o,l-u)}return KW(s,a,i,o,u,f),a}for(var mX=Math.PI,pX=Math.min,vX=Math.max,yX=Math.ceil,gX=Math.acos,SX=Math.cos,AX=Math.sin,TX=Math.atan2,EX=null,bX=null,CX=new cn,RX=[],xX=0;xX<4;xX++)RX.push(new an);function wX(e,t,i){return e<t?t:e>i?i:e}var kX={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!bX)return null;var i=bX.getRenderDataList(),n=i[bX.dataOffset];if(!n)return null;var r=n,s=r?r.vertexStart+t:0;return(s>65535||3*s>131070)&&(++bX.dataOffset,bX.dataOffset<i.length?n=i[bX.dataOffset]:(n=bX.requestRenderData(),i[bX.dataOffset]=n),r=n),r&&r.vertexCount<s&&r.request(t,3*t),n},stroke:function(e){cn.copy(CX,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){cn.copy(CX,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t,i,n,r,s=.5*e.lineWidth,a=e.lineCap,o=e.lineJoin,u=e.miterLimit;if(bX=e.impl){var h=(t=s,i=mX,n=bX.tessTol,r=2*gX(t/(t+n)),vX(2,yX(i/r)));this._calculateJoins(bX,s,o,u);for(var l=bX.paths,c=0,_=bX.pathOffset,f=bX.pathLength;_<f;_++){var d=l[_],m=d.points.length;o===FV.ROUND?c+=2*(m+d.bevel*(h+2)+1):c+=2*(m+5*d.bevel+1),d.closed||(a===NV.ROUND?c+=2*(2*h+2):c+=12)}var p=EX=this.getRenderData(e,c);if(p){for(var v=p.vData,y=p.iData,g=bX.pathOffset,S=bX.pathLength;g<S;g++){var A=l[g],T=A.points,E=T.length,b=p.vertexStart,C=void 0,R=void 0,x=0,w=0,k=A.closed;if(k?(C=T[E-1],R=T[0],x=0,w=E):(C=T[0],R=T[1],x=1,w=E-1),R=R||C,!k){var I=new LU(R.x,R.y);I.subtract(C),I.normalize();var B=I.x,P=I.y;a===NV.BUTT?this._buttCapStart(C,B,P,s,0):a===NV.SQUARE?this._buttCapStart(C,B,P,s,s):a===NV.ROUND&&this._roundCapStart(C,B,P,s,h)}for(var M=x;M<w;++M)o===FV.ROUND?this._roundJoin(C,R,s,s,h):0!=(R.flags&(GV.PT_BEVEL|GV.PT_INNERBEVEL))?this._bevelJoin(C,R,s,s):(this._vSet(R.x+R.dmx*s,R.y+R.dmy*s,1),this._vSet(R.x-R.dmx*s,R.y-R.dmy*s,-1)),C=R,R=T[M+1];if(k){var O=8*b;this._vSet(v[O],v[O+1],1),this._vSet(v[O+8],v[O+8+1],-1)}else{var D=new LU(R.x,R.y);D.subtract(C),D.normalize();var L=D.x,N=D.y;a===NV.BUTT?this._buttCapEnd(R,L,N,s,0):a===NV.SQUARE?this._buttCapEnd(R,L,N,s,s):a===NV.ROUND&&this._roundCapEnd(R,L,N,s,h)}for(var F=p.indexStart,G=b+2,V=p.vertexStart;G<V;G++)y[F++]=G-2,y[F++]=G-1,y[F++]=G;p.indexStart=F}EX=null,bX=null}}},_expandFill:function(e){if(bX=e.impl){for(var t=bX.paths,i=0,n=bX.pathOffset,r=bX.pathLength;n<r;n++)i+=t[n].points.length;var s=EX=this.getRenderData(e,i);if(s){for(var a=s,o=a.vData,u=a.iData,h=bX.pathOffset,l=bX.pathLength;h<l;h++){var c=t[h],_=c.points,f=_.length;if(0!==f){for(var d=s.vertexStart,m=0;m<f;++m)this._vSet(_[m].x,_[m].y);var p=s.indexStart;if(c.complex){for(var v=[],y=d,g=s.vertexStart;y<g;y++){var S=8*y;v.push(o[S++]),v.push(o[S++]),v.push(o[S++])}var A=dX(v,null,3);if(!A||0===A.length)continue;for(var T=0,E=A.length;T<E;T++)u[p++]=A[T]+d}else for(var b=d,C=d+2,R=a.vertexStart;C<R;C++)u[p++]=b,u[p++]=C-1,u[p++]=C;a.indexStart=p}}EX=null,bX=null}}},_calculateJoins:function(e,t,i,n){var r=0;t>0&&(r=1/t);for(var s=e.paths,a=e.pathOffset,o=e.pathLength;a<o;a++){var u=s[a],h=u.points,l=h.length,c=h[l-1],_=h[0];u.bevel=0;for(var f=0;f<l;f++){var d,m,p=c.dy,v=-c.dx,y=_.dy,g=-_.dx;if(_.dmx=.5*(p+y),_.dmy=.5*(v+g),(d=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var S=1/d;S>600&&(S=600),_.dmx*=S,_.dmy*=S}_.dx*c.dy-c.dx*_.dy>0&&(_.flags|=GV.PT_LEFT),d*(m=vX(11,pX(c.len,_.len)*r))*m<1&&(_.flags|=GV.PT_INNERBEVEL),_.flags&GV.PT_CORNER&&(d*n*n<1||i===FV.BEVEL||i===FV.ROUND)&&(_.flags|=GV.PT_BEVEL),0!=(_.flags&(GV.PT_BEVEL|GV.PT_INNERBEVEL))&&u.bevel++,c=_,_=h[f+1]}}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],s=r.points,a=s[s.length-1],o=s[0];s.length>2&&a.equals(o)&&(r.closed=!0,s.pop(),a=s[s.length-1]);for(var u=0,h=s.length;u<h;u++){var l=new LU(o.x,o.y);l.subtract(a),a.len=l.length(),(l.x||l.y)&&l.normalize(),a.dx=l.x,a.dy=l.y,a=o,o=s[u+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,s=i.y,a=0,o=0,u=0,h=0;return 0!==e?(a=r+t.dy*n,o=s-t.dx*n,u=r+i.dy*n,h=s-i.dx*n):(a=u=r+i.dmx*n,o=h=s+i.dmy*n),[a,o,u,h]},_buttCapStart:function(e,t,i,n,r){var s=e.x-t*r,a=e.y-i*r,o=i,u=-t;this._vSet(s+o*n,a+u*n,1),this._vSet(s-o*n,a-u*n,-1)},_buttCapEnd:function(e,t,i,n,r){var s=e.x+t*r,a=e.y+i*r,o=i,u=-t;this._vSet(s+o*n,a+u*n,1),this._vSet(s-o*n,a-u*n,-1)},_roundCapStart:function(e,t,i,n,r){for(var s=e.x,a=e.y,o=i,u=-t,h=0;h<r;h++){var l=h/(r-1)*mX,c=SX(l)*n,_=AX(l)*n;this._vSet(s-o*c-t*_,a-u*c-i*_,1),this._vSet(s,a,0)}this._vSet(s+o*n,a+u*n,1),this._vSet(s-o*n,a-u*n,-1)},_roundCapEnd:function(e,t,i,n,r){var s=e.x,a=e.y,o=i,u=-t;this._vSet(s+o*n,a+u*n,1),this._vSet(s-o*n,a-u*n,-1);for(var h=0;h<r;h++){var l=h/(r-1)*mX,c=SX(l)*n,_=AX(l)*n;this._vSet(s,a,0),this._vSet(s-o*c+t*_,a-u*c+i*_,1)}},_roundJoin:function(e,t,i,n,r){var s=e.dy,a=-e.dx,o=t.dy,u=-t.dx,h=t.x,l=t.y;if(0!=(t.flags&GV.PT_LEFT)){var c=this._chooseBevel(t.flags&GV.PT_INNERBEVEL,e,t,i),_=c[0],f=c[1],d=c[2],m=c[3],p=TX(-a,-s),v=TX(-u,-o);v>p&&(v-=2*mX),this._vSet(_,f,1),this._vSet(h-s*n,t.y-a*n,-1);for(var y=wX(yX((p-v)/mX)*r,2,r),g=0;g<y;g++){var S=p+g/(y-1)*(v-p),A=h+SX(S)*n,T=l+AX(S)*n;this._vSet(h,l,0),this._vSet(A,T,-1)}this._vSet(d,m,1),this._vSet(h-o*n,l-u*n,-1)}else{var E=this._chooseBevel(t.flags&GV.PT_INNERBEVEL,e,t,-n),b=E[0],C=E[1],R=E[2],x=E[3],w=TX(a,s),k=TX(u,o);k<w&&(k+=2*mX),this._vSet(h+s*n,l+a*n,1),this._vSet(b,C,-1);for(var I=wX(yX((k-w)/mX)*r,2,r),B=0;B<I;B++){var P=w+B/(I-1)*(k-w),M=h+SX(P)*i,O=l+AX(P)*i;this._vSet(M,O,1),this._vSet(h,l,0)}this._vSet(h+o*n,l+u*n,1),this._vSet(R,x,-1)}},_bevelJoin:function(e,t,i,n){var r=0,s=0,a=0,o=0,u=0,h=0,l=0,c=0,_=e.dy,f=-e.dx,d=t.dy,m=-t.dx;if(t.flags&GV.PT_LEFT){var p=this._chooseBevel(t.flags&GV.PT_INNERBEVEL,e,t,i);u=p[0],h=p[1],l=p[2],c=p[3],this._vSet(u,h,1),this._vSet(t.x-_*n,t.y-f*n,-1),this._vSet(l,c,1),this._vSet(t.x-d*n,t.y-m*n,-1)}else{var v=this._chooseBevel(t.flags&GV.PT_INNERBEVEL,e,t,-n);r=v[0],s=v[1],a=v[2],o=v[3],this._vSet(t.x+_*i,t.y+f*i,1),this._vSet(r,s,-1),this._vSet(t.x+d*i,t.y+m*i,1),this._vSet(a,o,-1)}},_vSet:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(EX){var n=EX,r=8*n.vertexStart,s=n.vData;s[r++]=e,s[r++]=t,s[r++]=0,cn.toArray(s,CX,r),r+=4,s[r++]=i,n.vertexStart++}}},IX=e("graphicsAssembler",{getAssembler:function(){return kX}});HU.Assembler=IX;var BX,PX=function e(){n(this,e),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},MX=new Dn,OX=new QF(64,64),DX=new EF(null),LX=null,NX=null,FX=[],GX=[],VX=[],UX=[],HX=new Mn,zX=new Mn,WX=new In,XX=null,jX=0,qX=0,YX=0,KX=0,QX=0,JX=1,ZX=null,$X="",ej=0,tj=0,ij=0,nj=0,rj=0,sj=0,aj=0,oj=!1,uj=0,hj=0,lj=0,cj={updateRenderData:function(e){e.renderData&&LX!==e&&(e.renderData.vertDirty&&(NX=(LX=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),LX.actualFontSize=ej,NX.setContentSize(zX),this.updateUVs(e),this.updateColor(e),LX.renderData.vertDirty=!1,LX=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var t=e.renderData,i=t.chunk.vb,n=t.vertexCount,r=t.data,s=3,a=0;a<n;a++){var o=r[a];i[s]=o.u,i[s+1]=o.v,s+=9}},updateColor:function(){},_updateFontScale:function(){JX=ej/tj},_updateFontFamily:function(e){var t=e.font;ZX=t.spriteFrame,XX=t.fntConfig,JF.fontAtlas=t.fontDefDictionary,JF.fontAtlas||(e.cacheMode===DV.CHAR?JF.fontAtlas=OX:JF.fontAtlas=DX),WN.packToDynamicAtlas(e,ZX)},_updateLabelInfo:function(){JF.hash="",JF.margin=0},_updateProperties:function(e){$X=e.string.toString(),ej=e.fontSize,tj=XX?XX.fontSize:e.fontSize,ij=e.horizontalAlign,nj=e.verticalAlign,rj=e.spacingX,aj=e.overflow,sj=e._lineHeight;var t=NX.contentSize;zX.width=t.width,zX.height=t.height,aj===OV.NONE?(oj=!1,zX.width+=2*JF.margin,zX.height+=2*JF.margin):aj===OV.RESIZE_HEIGHT?(oj=!0,zX.height+=2*JF.margin):oj=e.enableWrapText,JF.lineHeight=sj,JF.fontSize=ej,this._setupBMFontOverflowMetrics()},_resetProperties:function(){XX=null,ZX=null,JF.hash="",JF.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){var e=$X,t=e.length,i=XX.kerningDict,n=FX;if(i)for(var r=-1,s=0;s<t;++s){var a=e.charCodeAt(s),o=i[r<<16|65535&a]||0;n[s]=s<t-1?o:0,r=a}},_multilineTextWrap:function(e){for(var t=$X.length,i=0,n=0,r=0,s=0,a=0,o=0,u=0,h=null,l=0;l<t;){var c=$X.charAt(l);if("\n"!==c){for(var _=e($X,l,t),f=o,d=u,m=a,p=n,v=!1,y=0;y<_;++y){var g=l+y;if("\r"!==(c=$X.charAt(g)))if(h=JF.fontAtlas.getLetterDefinitionForChar(c,JF)){var S=p+h.offsetX*JX-JF.margin;if(oj&&lj>0&&n>0&&S+h.w*JX>lj&&!NF(c)){VX.push(a),a=0,i++,n=0,r-=sj*this._getFontScale()+0,v=!0;break}WX.x=S,WX.y=r-h.offsetY*JX,this._recordLetterInfo(WX,c,g,i),g+1<FX.length&&g<t-1&&(p+=FX[g+1]),p+=h.xAdvance*JX+rj,m=WX.x+h.w*JX,f<WX.y&&(f=WX.y),d>WX.y-h.h*JX&&(d=WX.y-h.h*JX)}else this._recordPlaceholderInfo(g,c),console.log("Can't find letter definition in texture atlas ".concat(XX.atlasName," for letter:").concat(c));else this._recordPlaceholderInfo(g,c)}v||(n=p,o<f&&(o=f),u>d&&(u=d),s<(a=m)&&(s=a),l+=_)}else VX.push(a),a=0,i++,n=0,r-=sj*this._getFontScale()+0,this._recordPlaceholderInfo(l,c),l++}return VX.push(a),qX=(jX=i+1)*sj*this._getFontScale(),jX>1&&(qX+=0*(jX-1)),zX.width=uj,zX.height=hj,uj<=0&&(zX.width=parseFloat(s.toFixed(2))+2*JF.margin),hj<=0&&(zX.height=parseFloat(qX.toFixed(2))+2*JF.margin),KX=zX.height,QX=0,o>0&&(KX=zX.height+o),u<-qX&&(QX=qX+u),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return aj===OV.SHRINK?JX:1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(LF(n)||"\n"===n||NF(n))return 1;var r=1,s=JF.fontAtlas.getLetterDefinitionForChar(n,JF);if(!s)return r;for(var a=s.xAdvance*JX+rj,o=t+1;o<i&&(n=e.charAt(o),s=JF.fontAtlas.getLetterDefinitionForChar(n,JF));++o){if(a+s.offsetX*JX+s.w*JX>lj&&!NF(n)&&lj>0)return r;if(a+=s.xAdvance*JX+rj,"\n"===n||NF(n)||LF(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=GX.length){var i=new PX;GX.push(i)}GX[e].char=t,GX[e].hash="".concat(t.charCodeAt(0)).concat(JF.hash),GX[e].valid=!1},_recordLetterInfo:function(e,t,i,n){if(i>=GX.length){var r=new PX;GX.push(r)}var s=t.charCodeAt(0),a="".concat(s).concat(JF.hash);GX[i].line=n,GX[i].char=t,GX[i].hash=a,GX[i].valid=JF.fontAtlas.getLetter(a).valid,GX[i].x=e.x,GX[i].y=e.y},_alignText:function(){qX=0,VX.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),aj===OV.SHRINK&&ej>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||aj===OV.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),ej=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,i=0|ej,n=0;t<i;){var r=n=t+i+1>>1;if(r<=0)break;JX=r/tj,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?i=n-1:t=n}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return qX>zX.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=$X.length;t<i;++t){var n=GX[t];if(n.valid){var r=JF.fontAtlas.getLetterDefinitionForChar(n.char,JF);if(!r)continue;var s=n.x+r.w*JX,a=n.line;if(uj>0)if(oj){if(VX[a]>zX.width&&(s>zX.width||s<0)){e=!0;break}}else if(s>zX.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=VX[t],n=e>zX.width||e<0;return oj?i>zX.width&&n:n},_updateQuads:function(){if(!LX)return!1;var e=ZX?ZX.texture:JF.fontAtlas.getTexture(),t=LX.renderData;t.dataLength=0,t.resize(0,0);for(var i=NX.anchorPoint,n=zX,r=i.x*n.width,s=i.y*n.height,a=!0,o=0,u=$X.length;o<u;++o){var h=GX[o];if(h.valid){var l=JF.fontAtlas.getLetter(h.hash);if(l){MX.height=l.h,MX.width=l.w,MX.x=l.u,MX.y=l.v;var c=h.y+YX;if(hj>0){if(c>KX){var _=c-KX;MX.y+=_,MX.height-=_,c-=_}c-MX.height*JX<QX&&aj===OV.CLAMP&&(MX.height=c<QX?0:(c-QX)/JX)}var f=h.line,d=h.x+l.w/2*JX+UX[f];if(uj>0&&this._isHorizontalClamped(d,f))if(aj===OV.CLAMP)MX.width=0;else if(aj===OV.SHRINK){if(zX.width>l.w){a=!1;break}MX.width=0}if(MX.height>0&&MX.width>0){var m=this._determineRect(),p=h.x+UX[h.line];this.appendQuad(LX,e,MX,m,p-r,c-s,JX)}}else console.warn("Can't find letter in this bitmap-font")}}var v=t.indexCount;return this.createQuadIndices(v),t.chunk.setIndexBuffer(BX),a},createQuadIndices:function(e){if(e%6==0){var t=e/6;BX=null,BX=new Uint16Array(e);for(var i=0,n=0;n<t;n++)BX[i++]=0+4*n,BX[i++]=1+4*n,BX[i++]=2+4*n,BX[i++]=1+4*n,BX[i++]=3+4*n,BX[i++]=2+4*n}else console.error("illegal index count!")},appendQuad:function(){},_determineRect:function(){var e=ZX.isRotated(),t=ZX.getOriginalSize(),i=ZX.getRect(),n=ZX.getOffset(),r=n.x+(t.width-i.width)/2,s=n.y-(t.height-i.height)/2;if(e){var a=MX.x;MX.x=i.x+i.height-MX.y-MX.height-s,MX.y=a+i.y-r,MX.y<0&&(MX.height+=s)}else MX.x+=i.x-r,MX.y+=i.y+s;return e},_computeAlignmentOffset:function(){switch(UX.length=0,ij){case PV.LEFT:for(var e=0;e<jX;++e)UX.push(0);break;case PV.CENTER:for(var t=0,i=VX.length;t<i;t++)UX.push((zX.width-VX[t])/2);break;case PV.RIGHT:for(var n=0,r=VX.length;n<r;n++)UX.push(zX.width-VX[n])}if(YX=zX.height,nj!==MV.TOP){var s=zX.height-qX+sj*this._getFontScale()-tj*JX;nj===MV.BOTTOM?YX-=s:YX-=s/2}},_setupBMFontOverflowMetrics:function(){var e=zX.width,t=zX.height;aj===OV.RESIZE_HEIGHT&&(t=0),aj===OV.NONE&&(e=0,t=0),uj=e,hj=t,HX.width=e,HX.height=t,lj=e}},_j=new cn(255,255,255,255),fj={createData:function(e){var t=e.requestRenderData();return t.resize(0,0),t},fillBuffers:function(e){var t=e.node;_j.set(e.color),_j.a=255*t._uiProps.opacity,Sf(t,0,e.renderData,_j)},appendQuad:function(e,t,i,n,r,s,a){var o=e.renderData;if(o){var u=o.dataLength;o.dataLength+=4,o.resize(o.dataLength,o.dataLength/2*3);var h=o.data,l=t.width,c=t.height,_=i.width,f=i.height,d=0,m=0,p=0,v=0;n?(d=i.x/l,v=(i.x+f)/l,m=(i.y+_)/c,p=i.y/c,h[u].u=d,h[u].v=p,h[u+1].u=d,h[u+1].v=m,h[u+2].u=v,h[u+2].v=p,h[u+3].u=v,h[u+3].v=m):(d=i.x/l,v=(i.x+_)/l,m=(i.y+f)/c,p=i.y/c,h[u].u=d,h[u].v=m,h[u+1].u=v,h[u+1].v=m,h[u+2].u=d,h[u+2].v=p,h[u+3].u=v,h[u+3].v=p),h[u].x=r,h[u].y=s-f*a,h[u+1].x=r+_*a,h[u+1].y=s-f*a,h[u+2].x=r,h[u+2].y=s,h[u+3].x=r+_*a,h[u+3].y=s}}};Je(fj,cj);var dj=null,mj=Ze(cj,{getAssemblerData:function(){return dj||(dj=new QF(1024,1024)),dj.getTexture()},_updateFontFamily:function(e){JF.fontAtlas=dj,JF.fontFamily=this._getFontFamily(e);var t=e.getComponent(qH);t&&t.enabled?(JF.isOutlined=!0,JF.margin=t.width,JF.out=t.color.clone(),JF.out.a=t.color.a*e.color.a/255):(JF.isOutlined=!1,JF.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){JF.fontDesc=this._getFontDesc(),JF.color=e.color,JF.hash=function(e){var t=e.color.toHEX(),i="";return e.isOutlined&&e.margin>0&&(i=i+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+i}(JF)},_getFontDesc:function(){return"".concat(JF.fontSize.toString(),"px ")+JF.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),pj=new cn(255,255,255,255),vj={createData:function(e){var t=e.requestRenderData();return t.resize(0,0),t},fillBuffers:function(e){if(e.renderData){var t=e.node;pj.a=255*t._uiProps.opacity,Sf(t,0,e.renderData,pj)}},appendQuad:fj.appendQuad,updateColor:function(){}};Je(vj,mj);var yj=VV.Overflow,gj=(1/255).toFixed(3),Sj=null,Aj=null,Tj=null,Ej="",bj="",Cj=0,Rj=0,xj=[],wj=new Mn,kj=0,Ij=0,Bj=0,Pj=new cn,Mj="",Oj=yj.NONE,Dj=!1,Lj=null,Nj=cn.BLACK.clone(),Fj=null,Gj=cn.BLACK.clone(),Vj=new Dn,Uj=Mn.ZERO.clone(),Hj=Mn.ZERO.clone(),zj=In.ZERO.clone(),Wj=In.ZERO.clone(),Xj=0,jj=0,qj=!1,Yj=!1,Kj=!1,Qj=["left","center","right"],Jj={getAssemblerData:function(){var e=VV._canvasPool.get();return e.canvas.width=e.canvas.height=1,e},resetAssemblerData:function(e){e&&VV._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=Cj,t.setContentSize(wj),this.updateVertexData(e),this.updateUVs(e),e.renderData.vertDirty=!1,e.contentWidth=Hj.width,Sj=null,Aj=null,Tj=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){Mj=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var i=e.assemblerData;i&&(Sj=i.context,Aj=i.canvas,Tj=e.spriteFrame,bj=e.string.toString(),Cj=e.fontSize,Rj=Cj,Oj=e.overflow,Hj.width=wj.width=t.width,Hj.height=wj.height=t.height,jj=e.underlineHeight,kj=e.lineHeight,Ij=e.horizontalAlign,Bj=e.verticalAlign,Pj=e.color,e.node._uiProps.opacity,qj=e.isBold,Yj=e.isItalic,Kj=e.isUnderline,Dj=Oj!==yj.NONE&&(Oj===yj.RESIZE_HEIGHT||e.enableWrapText),(Lj=(Lj=qH&&e.getComponent(qH))&&Lj.enabled&&Lj.width>0?Lj:null)&&Nj.set(Lj.color),(Fj=(Fj=WW&&e.getComponent(WW))&&Fj.enabled?Fj:null)&&Gj.set(Fj.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,i=0,n=0,r=0;if(Uj.width=Uj.height=0,Lj&&(e=t=i=n=r=Lj.width,Uj.width=Uj.height=2*r),Fj){var s=Fj.blur+r,a=Fj.offset.x,o=Fj.offset.y;i=Math.max(i,-a+s),n=Math.max(n,a+s),e=Math.max(e,o+s),t=Math.max(t,-o+s)}if(Yj){var u=Rj*Math.tan(.20943951);n+=u,Uj.width+=u}Vj.x=i,Vj.y=e,Vj.width=i+n,Vj.height=e+t},_calculateFillTextStartPosition:function(){var e=0;Ij===PV.RIGHT?e=wj.width-Vj.width:Ij===PV.CENTER&&(e=(wj.width-Vj.width)/2);var t=this._getLineHeight()*(xj.length-1),i=Cj*(1-RF/2);if(Bj!==MV.TOP){var n=t+Vj.height+Cj-wj.height;Bj===MV.BOTTOM?i-=n+=RF/2*Cj:i-=n/2}i+=0*Cj,zj.set(e+Vj.x,i+Vj.y)},_updateTexture:function(e){if(Sj&&Aj){Sj.clearRect(0,0,Aj.width,Aj.height),Sj.font=Ej,this._calculateFillTextStartPosition();var t=this._getLineHeight();Sj.lineJoin="round",Lj?(Sj.fillStyle="rgba(".concat(Nj.r,", ").concat(Nj.g,", ").concat(Nj.b,", ").concat(gj,")"),Sj.fillRect(0,0,Aj.width,Aj.height)):e._srcBlendFactor===$l.SRC_ALPHA&&(Sj.fillStyle="rgba(".concat(Pj.r,", ").concat(Pj.g,", ").concat(Pj.b,", ").concat(gj,")"),Sj.fillRect(0,0,Aj.width,Aj.height)),Sj.fillStyle="rgb(".concat(Pj.r,", ").concat(Pj.g,", ").concat(Pj.b,")");var i=zj.x,n=0;this._drawTextEffect(zj,t);for(var r=0;r<xj.length;++r)n=zj.y+r*t,Lj&&Sj.strokeText(xj[r],i,n),Sj.fillText(xj[r],i,n);Fj&&(Sj.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===VV.CacheMode.BITMAP){var t=e.ttfSpriteFrame;WN.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var i;Tj&&Aj&&(i=Tj instanceof sF?Tj.texture:Tj,0!==Aj.width&&0!==Aj.height&&(i.reset({width:Aj.width,height:Aj.height,mipmapLevel:1}),i.uploadData(Aj),i.setWrapMode(id.CLAMP_TO_EDGE,id.CLAMP_TO_EDGE),Tj instanceof sF&&(Tj.rect=new Dn(0,0,Aj.width,Aj.height),Tj._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),B.director.root&&B.director.root.batcher2D&&B.director.root.batcher2D._releaseDescriptorSetCache(i.getHash())))},_calDynamicAtlas:function(e){if(!(e.cacheMode!==VV.CacheMode.BITMAP||!Aj||Aj.width<=0||Aj.height<=0)){var t=e.ttfSpriteFrame;WN.packToDynamicAtlas(e,t)}},_setupOutline:function(){Sj.strokeStyle="rgba(".concat(Nj.r,", ").concat(Nj.g,", ").concat(Nj.b,", ").concat(Nj.a/255,")"),Sj.lineWidth=2*Lj.width},_setupShadow:function(){Sj.shadowColor="rgba(".concat(Gj.r,", ").concat(Gj.g,", ").concat(Gj.b,", ").concat(Gj.a/255,")"),Sj.shadowBlur=Fj.blur,Sj.shadowOffsetX=Fj.offset.x,Sj.shadowOffsetY=-Fj.offset.y},_drawTextEffect:function(e,t){if(Fj||Lj||Kj){var i=xj.length>1&&Fj,n=this._measureText(Sj,Ej),r=0,s=0;Fj&&this._setupShadow(),Lj&&this._setupOutline();for(var a=0;a<xj.length;++a)r=e.x,s=e.y+a*t,i&&(Lj&&Sj.strokeText(xj[a],r,s),Sj.fillText(xj[a],r,s)),Kj&&(Xj=n(xj[a]),Ij===PV.RIGHT?Wj.x=e.x-Xj:Ij===PV.CENTER?Wj.x=e.x-Xj/2:Wj.x=e.x,Wj.y=s+Rj/8,Sj.fillRect(Wj.x,Wj.y,Xj,jj));i&&(Sj.shadowColor="transparent")}},_updateLabelDimensions:function(){wj.width=Math.min(wj.width,2048),wj.height=Math.min(wj.height,2048);var e=!1;Aj.width!==wj.width&&(Aj.width=wj.width,e=!0),Aj.height!==wj.height&&(Aj.height=wj.height,e=!0),e&&(Sj.font=Ej),Sj.textAlign=Qj[Ij],Sj.textBaseline="alphabetic"},_getFontDesc:function(){var e="".concat(Cj.toString(),"px ");return e+=Mj,qj&&(e="bold ".concat(e)),Yj&&(e="italic ".concat(e)),e},_getLineHeight:function(){return 0|(0===kj?Cj:kj*Cj/Rj)},_calculateParagraphLength:function(e,t){for(var i,n=[],r=R(e);!(i=r()).done;){var s=FF(t,i.value,Ej);n.push(s)}return n},_measureText:function(e,t){return function(i){return FF(e,i,t)}},_calculateShrinkFont:function(e){if(Sj){var t=this._calculateParagraphLength(e,Sj),i=0,n=0,r=0;if(Dj){var s=Hj.width,a=Hj.height;if(s<0||a<0)return;n=a+1;for(var o=0,u=0|Cj+1,h=0;o<u;){if((h=o+u+1>>1)<=0){re(4003);break}Cj=h,Ej=this._getFontDesc(),Sj.font=Ej;var l=this._getLineHeight();for(n=0,i=0;i<e.length;++i){var c=FF(Sj,e[i],Ej);n+=HF(e[i],c,s,this._measureText(Sj,Ej)).length*l}n>a?u=h-1:o=h}0===o?re(4003):(Cj=o,Ej=this._getFontDesc(),Sj.font=Ej)}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var _=(wj.width-Vj.width)/r,f=wj.height/n;Cj=Rj*Math.min(1,_,f)|0,Ej=this._getFontDesc(),Sj.font=Ej}}},_calculateWrapText:function(e){if(Dj&&Sj){xj=[];for(var t=Hj.width,i=0;i<e.length;++i){var n=FF(Sj,e[i],Ej),r=HF(e[i],n,t,this._measureText(Sj,Ej));xj=xj.concat(r)}}},_calculateLabelFont:function(){if(Sj){var e=bj.split("\n");switch(xj=e,Ej=this._getFontDesc(),Sj.font=Ej,Oj){case yj.NONE:for(var t=0,i=0,n=0;n<e.length;++n){var r=FF(Sj,e[n],Ej);t=t>r?t:r}i=(xj.length+RF)*this._getLineHeight();var s=parseFloat(t.toFixed(2)),a=parseFloat(i.toFixed(2));wj.width=s+Vj.width,wj.height=a+Vj.height,Hj.width=s+Uj.width,Hj.height=a+Uj.height;break;case yj.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case yj.CLAMP:this._calculateWrapText(e);break;case yj.RESIZE_HEIGHT:this._calculateWrapText(e);var o=(xj.length+RF)*this._getLineHeight();wj.height=o+Vj.height,Hj.height=o+Uj.height}}}},Zj=cn.WHITE.clone(),$j=Uint16Array.from([0,1,2,1,3,2]),eq={createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6);var i=t.chunk.vb;i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var n=5,r=0;r<4;r++)cn.toArray(i,Zj,n),n+=9;return t.vertexRow=2,t.vertexCol=2,t.chunk.setIndexBuffer($j),t},fillBuffers:function(e){for(var t=e.renderData,i=t.chunk,n=t.data,r=e.node,s=i.vb,a=r.worldMatrix,o=t.floatStride,u=0,h=n.length,l=0;l<h;l++){var c=n[l],_=c.x,f=c.y,d=a.m03*_+a.m07*f+a.m15;d=d?Math.abs(1/d):1,s[0+(u=l*o)]=(a.m00*_+a.m04*f+a.m12)*d,s[u+1]=(a.m01*_+a.m05*f+a.m13)*d,s[u+2]=(a.m02*_+a.m06*f+a.m14)*d}var m=i.vertexOffset,p=i.meshBuffer,v=i.meshBuffer.iData,y=p.indexOffset;v[y++]=m,v[y++]=m+1,v[y++]=m+2,v[y++]=m+2,v[y++]=m+1,v[y++]=m+3,p.indexOffset+=6},updateVertexData:function(e){var t=e.renderData;if(t){var i=e.node._uiProps.uiTransformComp,n=i.width,r=i.height,s=i.anchorX*n,a=i.anchorY*r,o=t.data;o[0].x=-s,o[0].y=-a,o[1].x=n-s,o[1].y=-a,o[2].x=-s,o[2].y=r-a,o[3].x=n-s,o[3].y=r-a}},updateUVs:function(e){var t=e.renderData;if(t&&e.ttfSpriteFrame){var i=t.chunk.vb,n=e.ttfSpriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7]}},updateColor:function(){}};Je(eq,Jj);var tq=e("labelAssembler",{getAssembler:function(e){var t=eq;return e.font instanceof bF?t=fj:e.cacheMode===VV.CacheMode.CHAR&&(t=vj),t}});VV.Assembler=tq;var iq,nq=eH.FillType,rq=new Cn,sq=Uint16Array.from([0,1,2,1,3,2]),aq={updateRenderData:function(e){var t=e.spriteFrame;WN.packToDynamicAtlas(e,t);var i=e.renderData;if(i&&t){if(!i.vertDirty)return;var n=e.fillStart,r=e.fillRange;r<0&&(n+=r,r=-r),r=(r=(r=n+r)>1?1:r)<0?0:r;var s=(n=(n=n>1?1:n)<0?0:n)+(r=(r-=n)<0?0:r);s=s>1?1:s,this.updateUVs(e,n,s),this.updateVertexData(e,n,s),i.updateRenderData(e,t)}},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData.chunk.vb,s=n.width,a=n.height,o=n.rect,u=0,h=0,l=0,c=0,_=0,f=0,d=0,m=0,p=0,v=0;switch(n.isRotated()?(u=o.x/s,h=(o.y+o.width)/a,l=_=u,d=p=(o.x+o.height)/s,f=v=h,c=m=o.y/a):(u=o.x/s,h=(o.y+o.height)/a,l=d=u,_=p=(o.x+o.width)/s,c=f=h,m=v=o.y/a),e.fillType){case nq.HORIZONTAL:r[3]=l+(_-l)*t,r[4]=c+(f-c)*t,r[12]=l+(_-l)*i,r[13]=c+(f-c)*i,r[21]=d+(p-d)*t,r[22]=m+(v-m)*t,r[30]=d+(p-d)*i,r[31]=m+(v-m)*i;break;case nq.VERTICAL:r[3]=l+(d-l)*t,r[4]=c+(m-c)*t,r[12]=_+(p-_)*t,r[13]=f+(v-f)*t,r[21]=l+(d-l)*i,r[22]=c+(m-c)*i,r[30]=_+(p-_)*i,r[31]=f+(v-f)*i;break;default:ue(2626)}},updateVertexData:function(e,t,i){var n=e.renderData.data,r=e.node._uiProps.uiTransformComp,s=r.width,a=r.height,o=r.anchorX*s,u=r.anchorY*a,h=-o,l=-u,c=s-o,_=a-u,f=0;switch(e.fillType){case nq.HORIZONTAL:f=h+(c-h)*i,h+=(c-h)*t,c=f;break;case nq.VERTICAL:f=l+(_-l)*i,l+=(_-l)*t,_=f;break;default:ue(2626)}n[0].x=h,n[0].y=l,n[1].x=c,n[1].y=l,n[2].x=h,n[2].y=_,n[3].x=c,n[3].y=_},createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6),t.vertexRow=2,t.vertexCol=2,t.chunk.setIndexBuffer(sq);for(var i,n=R(t.data);!(i=n()).done;)i.value.z=0;return t},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(rq);for(var i=e.renderData.floatStride,n=e.renderData.data,r=t.vb,s=0,a=0;a<4;a++){var o=n[a],u=o.x,h=o.y,l=rq.m03*u+rq.m07*h+rq.m15;l=l?Math.abs(1/l):1,r[s=a*i]=(rq.m00*u+rq.m04*h+rq.m12)*l,r[s+1]=(rq.m01*u+rq.m05*h+rq.m13)*l,r[s+2]=(rq.m02*u+rq.m06*h+rq.m14)*l}},fillBuffers:function(e){var t=e.renderData,i=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,i),t.vertDirty=!1),i.bufferId;var n=i.vertexOffset,r=i.meshBuffer,s=i.meshBuffer.iData,a=r.indexOffset;s[a++]=n,s[a++]=n+1,s[a++]=n+2,s[a++]=n+2,s[a++]=n+1,s[a++]=n+3,r.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=5,s=e.color,a=s.r/255,o=s.g/255,u=s.b/255,h=e.node._uiProps.opacity,l=0;l<4;l++)i[r]=a,i[r+1]=o,i[r+2]=u,i[r+3]=h,r+=n}},oq=2*Math.PI,uq=1e-6,hq=new Cn,lq=[new In,new In,new In,new In],cq=new Array(4),_q=new Array(8),fq=[new In,new In,new In,new In],dq=[new In,new In,new In,new In],mq=new In,pq=[new In,new In,new In,new In];function vq(e,t,i,n,r,s,a){var o=Math.sin(s);o=Math.abs(o)>uq?o:0;var u=Math.cos(s),h=0,l=0;if(0!==(u=Math.abs(u)>uq?u:0)){if(h=o/u,(e-r.x)*u>0){var c=r.y+h*(e-r.x);a[0].x=e,a[0].y=c}if((t-r.x)*u>0){var _=r.y+h*(t-r.x);a[2].x=t,a[2].y=_}}if(0!==o){if(l=u/o,(n-r.y)*o>0){var f=r.x+l*(n-r.y);a[3].x=f,a[3].y=n}if((i-r.y)*o>0){var d=r.x+l*(i-r.y);a[1].x=d,a[1].y=i}}}function yq(e,t){var i=t.x-e.x,n=t.y-e.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function gq(e,t,i,n,r){var s=cq,a=s[0],o=s[1],u=s[2],h=s[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y,Sq((i.x-a)/(u-a),(i.y-o)/(h-o),e,t),Sq((n.x-a)/(u-a),(n.y-o)/(h-o),e,t+1),Sq((r.x-a)/(u-a),(r.y-o)/(h-o),e,t+2)}function Sq(e,t,i,n){var r=_q,s=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,o=r[1]+(r[3]-r[1])*e,u=r[5]+(r[7]-r[5])*e,h=i[n];h.u=s+(a-s)*t,h.v=o+(u-o)*t}for(var Aq={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;WN.packToDynamicAtlas(e,t),this.updateUVs(e);var i=e.renderData;if(i&&t){if(!i.vertDirty)return;var n=i.data,r=e.fillStart,s=e.fillRange;for(s<0&&(r+=s,s=-s);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=oq)+(s*=oq);!function(e){var t=e.node._uiProps.uiTransformComp,i=t.width,n=t.height,r=t.anchorX*i,s=t.anchorY*n,a=-r,o=-s,u=i-r,h=n-s,l=cq;l[0]=a,l[1]=o,l[2]=u,l[3]=h;var c=e.fillCenter,_=mq.x=Math.min(Math.max(0,c.x),1)*(u-a)+a,f=mq.y=Math.min(Math.max(0,c.y),1)*(h-o)+o;lq[0].x=lq[3].x=a,lq[1].x=lq[2].x=u,lq[0].y=lq[1].y=o,lq[2].y=lq[3].y=h;for(var d,m=R(pq);!(d=m()).done;){var p=d.value;In.set(p,0,0)}_!==l[0]&&In.set(pq[0],3,0),_!==l[2]&&In.set(pq[2],1,2),f!==l[1]&&In.set(pq[1],0,1),f!==l[3]&&In.set(pq[3],2,3)}(e),function(e){var t=e.width,i=e.height,n=e.getRect(),r=0,s=0,a=0,o=0,u=_q;e.isRotated()?(r=n.x/t,s=(n.x+n.height)/t,a=n.y/i,o=(n.y+n.width)/i,u[0]=u[2]=r,u[4]=u[6]=s,u[3]=u[7]=o,u[1]=u[5]=a):(r=n.x/t,s=(n.x+n.width)/t,a=n.y/i,o=(n.y+n.height)/i,u[0]=u[4]=r,u[2]=u[6]=s,u[1]=u[3]=o,u[5]=u[7]=a)}(t),vq(cq[0],cq[2],cq[1],cq[3],mq,r,fq),vq(cq[0],cq[2],cq[1],cq[3],mq,r+s,dq);for(var o=0,u=0;u<4;++u){var h=pq[u];if(h)if(s>=oq)i.dataLength=o+3,gq(n,o,mq,lq[h.x],lq[h.y]),o+=3;else{var l=yq(mq,lq[h.x]),c=yq(mq,lq[h.y]);c<l&&(c+=oq),l-=oq,c-=oq;for(var _=0;_<3;++_)l>=a||(l>=r?(i.dataLength=o+3,gq(n,o,mq,lq[h.x],c>=a?dq[u]:lq[h.y]),o+=3):c>r&&(c<=a?(i.dataLength=o+3,gq(n,o,mq,fq[u],lq[h.y]),o+=3):(i.dataLength=o+3,gq(n,o,mq,fq[u],dq[u]),o+=3))),l+=oq,c+=oq}}0===o&&(i.dataLength=0),i.resize(o,o),i.updateRenderData(e,t)}},createQuadIndices:function(e){iq=null,iq=new Uint16Array(e);for(var t=0,i=0;i<e;i++)iq[t++]=i},fillBuffers:function(e){var t=e.node,i=e.renderData,n=i.chunk;(t.hasChangedFlags||i.vertDirty)&&(this.updateWorldVertexAndUVData(e,n),i.vertDirty=!1),this.updateColorLate(e),n.bufferId;for(var r=n.vertexOffset,s=n.meshBuffer,a=n.meshBuffer.iData,o=s.indexOffset,u=0;u<i.indexCount;u++)a[o+u]=r+u;s.indexOffset+=i.indexCount,s.setDirty()},updateWorldUVData:function(e){for(var t=e.renderData,i=t.floatStride,n=t.data,r=t.chunk.vb,s=0;s<n.length;s++){var a=s*i;r[a+3]=n[s].u,r[a+4]=n[s].v}},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(hq);for(var i=e.renderData,n=i.floatStride,r=e.renderData.data,s=t.vb,a=i.vertexCount,o=0,u=0;u<a;u++){var h=r[u],l=h.x,c=h.y,_=hq.m03*l+hq.m07*c+hq.m15;_=_?Math.abs(1/_):1,s[o+0]=(hq.m00*l+hq.m04*c+hq.m12)*_,s[o+1]=(hq.m01*l+hq.m05*c+hq.m13)*_,s[o+2]=(hq.m02*l+hq.m06*c+hq.m14)*_,s[o+3]=h.u,s[o+4]=h.v,o+=n}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updateColorLate:function(e){for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=t.vertexCount,s=5,a=e.color,o=a.r/255,u=a.g/255,h=a.b/255,l=e.node._uiProps.opacity,c=0;c<r;c++)i[s]=o,i[s+1]=u,i[s+2]=h,i[s+3]=l,s+=n},updateColor:function(){}},Tq=Uint16Array.from([0,1,2,1,3,2]),Eq={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(4,6),t.vertexRow=2,t.vertexCol=2,t.chunk.setIndexBuffer(Tq),t},updateRenderData:function(e){var t=e.spriteFrame;WN.packToDynamicAtlas(e,t),this.updateUVs(e);var i=e.renderData;i&&t&&(i.vertDirty&&this.updateVertexData(e),i.updateRenderData(e,t))},updateWorldVerts:function(e,t){for(var i=e.renderData,n=t.vb,r=i.data,s=e.node.worldMatrix,a=i.floatStride,o=0,u=r.length,h=0;h<u;h++){var l=r[h],c=l.x,_=l.y,f=s.m03*c+s.m07*_+s.m15;f=f?Math.abs(1/f):1,n[0+(o=h*a)]=(s.m00*c+s.m04*_+s.m12)*f,n[o+1]=(s.m01*c+s.m05*_+s.m13)*f,n[o+2]=(s.m02*c+s.m06*_+s.m14)*f}},fillBuffers:function(e){if(null!==e){var t=e.renderData,i=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,i),t.vertDirty=!1),i.bufferId;for(var n=i.vertexOffset,r=i.meshBuffer,s=i.meshBuffer.iData,a=r.indexOffset,o=0;o<t.vertexRow-1;o++)for(var u=0;u<t.vertexCol-1;u++){var h=n+o*t.vertexCol+u;s[a++]=h,s[a++]=h+1,s[a++]=h+t.vertexCol,s[a++]=h+1,s[a++]=h+1+t.vertexCol,s[a++]=h+t.vertexCol,r.indexOffset+=6}}},updateVertexData:function(e){var t=e.renderData;if(t){var i=e.node._uiProps.uiTransformComp,n=t.data,r=i.width,s=i.height,a=i.anchorX*r,o=i.anchorY*s,u=0,h=0,l=0,c=0;if(e.trim)u=-a,h=-o,l=r-a,c=s-o;else{var _=e.spriteFrame,f=_.originalSize,d=r/f.width,m=s/f.height,p=_.trimmedBorder;u=p.x*d-a,h=p.z*m-o,l=r+p.y*d-a,c=s+p.w*m-o}n[0].x=u,n[0].y=h,n[1].x=l,n[1].y=h,n[2].x=u,n[2].y=c,n[3].x=l,n[3].y=c,t.vertDirty=!0}},updateUVs:function(e){if(e.spriteFrame){var t=e.renderData.chunk.vb,i=e.spriteFrame.uv;t[3]=i[0],t[4]=i[1],t[12]=i[2],t[13]=i[3],t[21]=i[4],t[22]=i[5],t[30]=i[6],t[31]=i[7]}},updateColor:function(e){for(var t=e.renderData,i=t.chunk.vb,n=5,r=e.color,s=r.r/255,a=r.g/255,o=r.b/255,u=r.a/255,h=0;h<4;h++,n+=t.floatStride)i[n]=s,i[n+1]=a,i[n+2]=o,i[n+3]=u}},bq=new Cn,Cq=[],Rq=0;Rq<4;Rq++)Cq.push({x:0,y:0,z:0,u:0,v:0,color:new cn});var xq,wq,kq,Iq,Bq,Pq,Mq,Oq,Dq={createData:function(e){var t=e.requestRenderData();return t.dataLength=16,t.resize(16,54),t.vertexRow=4,t.vertexCol=4,this.QUAD_INDICES=new Uint16Array(54),this.createQuadIndices(4,4),t.chunk.setIndexBuffer(this.QUAD_INDICES),t},createQuadIndices:function(e,t){for(var i=0,n=0;n<e-1;n++)for(var r=0;r<t-1;r++){var s=n*t+r;this.QUAD_INDICES[i++]=s,this.QUAD_INDICES[i++]=s+1,this.QUAD_INDICES[i++]=s+t,this.QUAD_INDICES[i++]=s+1,this.QUAD_INDICES[i++]=s+1+t,this.QUAD_INDICES[i++]=s+t}},updateRenderData:function(e){var t=e.spriteFrame;WN.packToDynamicAtlas(e,t),this.updateUVs(e);var i=e.renderData;i&&t&&(i.vertDirty&&this.updateVertexData(e),i.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData,i=t.data,n=e.node._uiProps.uiTransformComp,r=n.width,s=n.height,a=n.anchorX*r,o=n.anchorY*s,u=e.spriteFrame,h=u.insetLeft,l=u.insetRight,c=u.insetTop,_=u.insetBottom,f=r-h-l,d=s-c-_,m=r/(h+l),p=s/(c+_);m=Number.isNaN(m)||m>1?1:m,p=Number.isNaN(p)||p>1?1:p,f=f<0?0:f,d=d<0?0:d,Cq[0].x=-a,Cq[0].y=-o,Cq[1].x=h*m-a,Cq[1].y=_*p-o,Cq[2].x=Cq[1].x+f,Cq[2].y=Cq[1].y+d,Cq[3].x=r-a,Cq[3].y=s-o;for(var v=0;v<t.vertexRow;v++)for(var y=0;y<t.vertexCol;y++){var g=v*t.vertexCol+y;g<t.dataLength&&v<Cq.length&&y<Cq.length&&(i[g].x=Cq[y].x,i[g].y=Cq[v].y)}},fillBuffers:function(e){var t=e.renderData,i=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,i),t.vertDirty=!1),i.bufferId;for(var n=i.vertexOffset,r=i.meshBuffer,s=i.meshBuffer.iData,a=r.indexOffset,o=0;o<3;++o)for(var u=0;u<3;++u){var h=n+4*o+u;s[a++]=h,s[a++]=h+1,s[a++]=h+4,s[a++]=h+1,s[a++]=h+5,s[a++]=h+4}r.indexOffset=a},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(bq);for(var i=e.renderData,n=i.floatStride,r=i.data,s=t.vb,a=0,o=0;o<4;++o)for(var u=r[4*o],h=0;h<4;++h){var l=r[h].x,c=u.y,_=bq.m03*l+bq.m07*c+bq.m15;_=_?Math.abs(1/_):1,s[0+(a=(4*o+h)*n)]=(bq.m00*l+bq.m04*c+bq.m12)*_,s[a+1]=(bq.m01*l+bq.m05*c+bq.m13)*_,s[a+2]=(bq.m02*l+bq.m06*c+bq.m14)*_}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=e.spriteFrame.uvSliced,s=3,a=0;a<16;a++)i[s]=r[a].u,i[s+1]=r[a].v,s+=n},updateColor:function(e){for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=5,s=e.color,a=s.r/255,o=s.g/255,u=s.b/255,h=e.node._uiProps.opacity,l=0;l<16;l++)i[r]=a,i[r+1]=o,i[r+2]=u,i[r+3]=h,r+=n}},Lq=new Cn,Nq=0,Fq=[];function Gq(e){return e&&(e.insetTop>0||e.insetBottom>0||e.insetLeft>0||e.insetRight>0)?2:0}var Vq={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,i=e.spriteFrame;if(i&&t&&t.vertDirty){var n=e.node._uiProps.uiTransformComp,r=Math.abs(n.width),s=Math.abs(n.height),a=i.getRect(),o=i.insetLeft,u=i.insetRight,h=a.width-o-u,l=i.insetTop,c=i.insetBottom,_=a.height-l-c,f=r-o-u,d=s-l-c;f=f>0?f:0,d=d>0?d:0;var m=0===h?f:f/h,p=0===_?d:d/_,v=Gq(i),y=Math.ceil(p+v),g=Math.ceil(m+v);t.dataLength=4*y*g,this.updateVerts(e,f,d,y,g),t.vertexCount!==y*g*4&&(e.renderEntity.colorDirty=!0),t.resize(y*g*4,y*g*6),t.updateRenderData(e,i)}},createQuadIndices:function(e){if(e%6==0){var t=e/6;Oq=null,Oq=new Uint16Array(e);for(var i=0,n=0;n<t;n++)Oq[i++]=0+4*n,Oq[i++]=1+4*n,Oq[i++]=2+4*n,Oq[i++]=1+4*n,Oq[i++]=3+4*n,Oq[i++]=2+4*n}else console.error("illegal index count!")},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,i=e.renderData,n=i.chunk;(t.hasChangedFlags||i.vertDirty)&&(this.updateWorldVertexAndUVData(e,n),i.vertDirty=!1),this.updateColorLate(e),n.bufferId;for(var r=n.vertexOffset,s=n.meshBuffer,a=n.meshBuffer.iData,o=s.indexOffset,u=0;u<i.indexCount;u+=6)a[o++]=r,a[o++]=r+1,a[o++]=r+2,a[o++]=r+1,a[o++]=r+3,a[o++]=r+2,r+=4,s.indexOffset+=6;s.setDirty()},updateWorldUVData:function(e){for(var t=e.renderData,i=t.floatStride,n=t.data,r=t.chunk.vb,s=0;s<n.length;s++){var a=s*i;r[a+3]=n[s].u,r[a+4]=n[s].v}},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(Lq);for(var i=e.renderData,n=i.floatStride,r=i.data,s=t.vb,a=r.length,o=0;o<a;o++){var u=r[o].x,h=r[o].y,l=r[o].z,c=Lq.m03*u+Lq.m07*h+Lq.m11*l+Lq.m15;c=c?Math.abs(1/c):1;var _=o*n;s[_]=(Lq.m00*u+Lq.m04*h+Lq.m08*l+Lq.m12)*c,s[_+1]=(Lq.m01*u+Lq.m05*h+Lq.m09*l+Lq.m13)*c,s[_+2]=(Lq.m02*u+Lq.m06*h+Lq.m10*l+Lq.m14)*c}this.updateWorldUVData(e)},updateVerts:function(e,t,i,n,r){var s,a,o=e.node._uiProps.uiTransformComp,u=e.renderData.data,h=e.spriteFrame,l=h.rect,c=Math.abs(o.width),_=Math.abs(o.height),f=o.anchorX*c,d=o.anchorY*_,m=h.insetLeft,p=h.insetRight,v=l.width-m-p,y=h.insetTop,g=h.insetBottom,S=l.height-y-g,A=o.width/(m+p)>1?1:o.width/(m+p),T=o.height/(y+g)>1?1:o.height/(y+g);s=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,a=S>0?Math.floor(1e3*i)/1e3%S==0?S:i%S:i,Nq=Math.max(n+1,r+1);for(var E=0;E<Nq;E++)Fq.push({x:0,y:0,z:0,u:0,v:0,color:new cn});var b=Gq(h);if(0===b)for(var C=0;C<Nq;C++)Fq[C].x=C>=r?c-f:C*v-f,Fq[C].y=C>=n?_-d:C*S-d;else for(var R=0;R<Nq;R++)0===R?Fq[R].x=-f:1===R?Fq[R].x=m*A-f:R>1&&R<r-1?Fq[R].x=v>0?m*A-f+v*(R-1):m+t-f:R===r-1?Fq[R].x=m*A-f+s+v*(R-2):R>=r&&(Fq[R].x=Math.min(m+t+p,c)-f),0===R?Fq[R].y=-d:1===R?Fq[R].y=g*T-d:R>1&&R<n-1?Fq[R].y=S>0?g*T-d+S*(R-1):g+i-d:R===n-1?Fq[R].y=g*T-d+a+S*(R-2):R>=n&&(Fq[R].y=Math.min(g+i+y,_)-d);for(var x=0,w=0,k=0,I=0,B=0;B<n;++B){k=Fq[B].y,I=Fq[B+1].y;for(var P=0;P<r;++P){x=Fq[P].x,w=Fq[P+1].x;var M=4*(B*r+P);u[M].x=x,u[M].y=k,u[M+1].x=w,u[M+1].y=k,u[M+2].x=x,u[M+2].y=I,u[M+3].x=w,u[M+3].y=I}}var O=h.rotated,D=(h.uv,h.uvSliced);xq=D[0],wq=D[1],kq=D[2],Iq=D[3],Bq=D[4],Pq=D[8],Mq=D[12];for(var L=0,N=0,F=0===v?t:t/v,G=0===S?i:i/S,V=[],U=[],H=0;H<n;++H){N=i>S?i>=(b>0?H:H+1)*S?1:G%1:G;for(var z=0;z<r;++z){L=t>v?t>=(b>0?z:z+1)*v?1:F%1:F,O?(0===b?(V[0]=Bq.u,V[1]=Bq.u,V[2]=Bq.u+(Pq.u-Bq.u)*N,U[0]=wq.v,U[1]=wq.v+(kq.v-wq.v)*L,U[2]=wq.v):(0===H?(V[0]=xq.u,V[1]=xq.u,V[2]=Bq.u):H<n-1?(V[0]=Bq.u,V[1]=Bq.u,V[2]=Bq.u+(Pq.u-Bq.u)*N):H===n-1&&(V[0]=Pq.u,V[1]=Pq.u,V[2]=Mq.u),0===z?(U[0]=xq.v,U[1]=wq.v,U[2]=xq.v):z<r-1?(U[0]=wq.v,U[1]=wq.v+(kq.v-wq.v)*L,U[2]=wq.v):z===r-1&&(U[0]=kq.v,U[1]=Iq.v,U[2]=kq.v)),V[3]=V[2],U[3]=U[1]):(0===b?(V[0]=wq.u,V[1]=wq.u+(kq.u-wq.u)*L,V[2]=wq.u,U[0]=Bq.v,U[1]=Bq.v,U[2]=Bq.v+(Pq.v-Bq.v)*N):(0===z?(V[0]=xq.u,V[1]=wq.u,V[2]=xq.u):z<r-1?(V[0]=wq.u,V[1]=wq.u+(kq.u-wq.u)*L,V[2]=wq.u):z===r-1&&(V[0]=kq.u,V[1]=Iq.u,V[2]=kq.u),0===H?(U[0]=xq.v,U[1]=xq.v,U[2]=Bq.v):H<n-1?(U[0]=Bq.v,U[1]=Bq.v,U[2]=Bq.v+(Pq.v-Bq.v)*N):H===n-1&&(U[0]=Pq.v,U[1]=Pq.v,U[2]=Mq.v)),V[3]=V[1],U[3]=U[2]);var W=4*(H*r+z);u[W].u=V[0],u[W].v=U[0],u[W+1].u=V[1],u[W+1].v=U[1],u[W+2].u=V[2],u[W+2].v=U[2],u[W+3].u=V[3],u[W+3].v=U[3]}}},updateColorLate:function(e){for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=t.vertexCount,s=5,a=e.color,o=a.r/255,u=a.g/255,h=a.b/255,l=e.node._uiProps.opacity,c=0;c<r;c++)i[s]=o,i[s+1]=u,i[s+2]=h,i[s+3]=l,s+=n},updateColor:function(){}},Uq=eH.Type,Hq=eH.FillType,zq=e("spriteAssembler",{getAssembler:function(e){var t=Eq,i=e;switch(i.type){case Uq.SLICED:t=Dq;break;case Uq.TILED:t=Vq;break;case Uq.FILLED:t=i.fillType===Hq.RADIAL?Aq:aq}return t}});eH.Assembler=zq;var Wq=[kR.EventType.MOUSE_DOWN,kR.EventType.MOUSE_MOVE,kR.EventType.MOUSE_UP,kR.EventType.MOUSE_WHEEL],Xq=[kR.EventType.TOUCH_START,kR.EventType.TOUCH_MOVE,kR.EventType.TOUCH_END,kR.EventType.TOUCH_CANCEL],jq=(new(function(){function e(){n(this,e),this.priority=pR.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],IR._registerEventDispatcher(this),rD.callbacksInvoker.on(JO.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),rD.callbacksInvoker.on(JO.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),rD.callbacksInvoker.on(JO.MARK_LIST_DIRTY,this._markListDirty,this)}return s(e,[{key:"dispatchEvent",value:function(e){var t=e.type;return Xq.includes(t)?this.dispatchEventTouch(e):!Wq.includes(t)||this.dispatchEventMouse(e)}},{key:"addPointerEventProcessor",value:function(e){0===this._inDispatchCount?this._pointerEventProcessorList.includes(e)||(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.includes(e)||this._processorListToAdd.push(e),St(this._processorListToRemove,e)}},{key:"removePointerEventProcessor",value:function(e){0===this._inDispatchCount?(St(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.includes(e)||this._processorListToRemove.push(e),St(this._processorListToAdd,e)}},{key:"dispatchEventMouse",value:function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,i=t.length,n=!0,r=0;r<i;++r){var s=t[r];if(s.isEnabled&&s.shouldHandleEventMouse&&s._handleEventMouse(e)){if(n=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),n}},{key:"dispatchEventTouch",value:function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,i=t.length,n=e.touch,r=!0,s=0;s<i;++s){var a=t[s];if(a.isEnabled&&a.shouldHandleEventTouch)if(e.type===GC.TOUCH_START){if(a._handleEventTouch(e)){if(a.claimedTouchIdList.push(n.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var o=a.claimedTouchIdList.indexOf(n.getID());if(-1!==o){if(a._handleEventTouch(e),e.type!==GC.TOUCH_END&&e.type!==GC.TOUCH_CANCEL||yt(a.claimedTouchIdList,o),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r}},{key:"_updatePointerEventProcessorList",value:function(){for(var e=this._processorListToAdd,t=e.length,i=0;i<t;++i)this.addPointerEventProcessor(e[i]);e.length=0;for(var n=this._processorListToRemove,r=n.length,s=0;s<r;++s)this.removePointerEventProcessor(n[s]);n.length=0}},{key:"_sortPointerEventProcessorList",value:function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,i=0;i<t;++i){var n=e[i],r=n.node;if(r._uiProps){var s=r._uiProps.uiTransformComp;n.cachedCameraPriority=s.cameraPriority}}e.sort(this._sortByPriority),this._isListDirty=!1}}},{key:"_sortByPriority",value:function(e,t){var i=e.node,n=t.node;if(!(t&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(e&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=i,s=n,a=!1;(null===(o=r.parent)||void 0===o?void 0:o._id)!==(null===(u=s.parent)||void 0===u?void 0:u._id);){var o,u,h,l,c,_;r=null===(null===(h=r)||void 0===h||null===(l=h.parent)||void 0===l?void 0:l.parent)?(a=!0)&&n:r&&r.parent,s=null===(null===(c=s)||void 0===c||null===(_=c.parent)||void 0===_?void 0:_.parent)?(a=!0)&&i:s&&s.parent}if(r._id===s._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var f=r?r.getSiblingIndex():0,d=s?s.getSiblingIndex():0;return a?f-d:d-f}},{key:"_markListDirty",value:function(){this._isListDirty=!0}}]),e}()),new p_(null)),qq=new Cn,Yq=e("UI",function(){function e(t){var i=this;n(this,e),this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new dA,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._currIsMiddleware=!1,this._middlewareEnableBatch=!1,this._middlewareBuffer=null,this._middlewareIndexStart=0,this._middlewareIndexCount=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new Qq,this._meshDataArray=[],this._maskClearModel=null,this._maskClearMtl=null,this._maskModelMesh=null,this._root=t,this.device=t.device,this._batches=new Ch(64),this._drawBatchPool=new Eh((function(){return new HW}),128,(function(e){return e.destroy(i)}))}return s(e,[{key:"nativeObj",get:function(){return this._nativeObj}},{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}},{key:"initialize",value:function(){return!0}},{key:"destroy",value:function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy();for(var t,i=R(this._bufferAccessors.values());!(t=i()).done;)t.value.destroy();this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),TG.sharedManager.destroy(),this._maskClearModel&&this._maskModelMesh&&(B.director.root.destroyModel(this._maskClearModel),this._maskModelMesh.destroy()),this._maskClearMtl&&this._maskClearMtl.destroy()}},{key:"syncRootNodesToNative",value:function(){}},{key:"addScreen",value:function(e){this._screens.push(e),this._screens.sort(this._screenSort)}},{key:"removeScreen",value:function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)}},{key:"sortScreens",value:function(){this._screens.sort(this._screenSort)}},{key:"getFirstRenderCamera",value:function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,i=0;i<t.length;i++){var n=t[i];if(n.visibility&e.layer)return n}return null}},{key:"update",value:function(){for(var e=this._screens,t=0,i=0;i<e.length;++i){var n=e[i],r=n._getRenderScene();if(n.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(n.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var s=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var a=this._batches.array[t];if(a.model)for(var o=a.model.subModels,u=0;u<o.length;u++)o[u].priority=s++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}}},{key:"uploadBuffers",value:function(){if(this._batches.length>0){for(var e=this._meshDataArray.length,t=0;t<e;t++)this._meshDataArray[t].uploadBuffers();for(var i,n=R(this._bufferAccessors.values());!(i=n()).done;){var r=i.value;r.uploadBuffers(),r.reset()}this._descriptorSetCache.update()}}},{key:"reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}for(var i,n=R(this._bufferAccessors.values());!(i=n()).done;)i.value.reset();for(var r=this._meshDataArray.length,s=0;s<r;s++)this._meshDataArray[s].freeIAPool();this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),TG.sharedManager.reset()}},{key:"switchBufferAccessor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:eG,t=e===eG?36:sG(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var i=this._bufferAccessors.get(t);i||(i=new pG(this.device,e),this._bufferAccessors.set(t,i)),this._staticVBBuffer=i,this._currBID=-1}return this._staticVBBuffer}},{key:"registerBufferAccessor",value:function(e,t){this._bufferAccessors.set(e,t)}},{key:"updateBuffer",value:function(e,t){var i=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=i.getMeshBuffer(t).indexOffset)}},{key:"commitComp",value:function(e,t,i,n,r){var s,a=0,o=-1;if(t&&t.chunk){if(!t.isValid())return;a=t.dataHash,s=t.material,o=t.chunk.bufferId}e.stencilStage===lG.ENTER_LEVEL||e.stencilStage===lG.ENTER_LEVEL_INVERTED?this._insertMaskBatch(e):e.stencilStage=TG.sharedManager.stage;var u=e.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===s&&this._currDepthStencilStateStage===u||(this.autoMergeBatches(this._currComponent),t&&!t._isMeshBuffer&&this.updateBuffer(t.vertexFormat,o),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=u,this._currLayer=e.node.layer,i?(this._currTexture=i.getGFXTexture(),this._currSampler=i.getGFXSampler(),this._currTextureHash=i.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),n.fillBuffers(e,this)}},{key:"commitIA",value:function(e,t,i,n,r){var s;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var a=0;e&&(e.stencilStage=TG.sharedManager.stage,s=null!==e.customMaterial?TG.sharedManager.getStencilStage(e.stencilStage,n):TG.sharedManager.getStencilStage(e.stencilStage),a=TG.sharedManager.getStencilHash(e.stencilStage));var o=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();o.visFlags=e.node.layer,o.inputAssembler=t,o.useLocalData=r||null,i&&(o.texture=i.getGFXTexture(),o.sampler=i.getGFXSampler(),o.textureHash=i.getHash(),o.samplerHash=o.sampler.hash),o.fillPasses(n||null,s,a,null),this._batches.push(o)}},{key:"commitMiddleware",value:function(e,t,i,n,r,s,a){var o=r.getGFXTexture();a&&this._middlewareEnableBatch&&this._middlewareBuffer===t&&this._currTexture===o&&this._currMaterial.hash===s.hash&&this._middlewareIndexStart+this._middlewareIndexCount===i&&this._currLayer===e.node.layer?this._middlewareIndexCount+=n:(this.autoMergeBatches(this._currComponent),this.resetRenderStates(),this._currComponent=e,this._currTexture=o,this._currSampler=r.getGFXSampler(),this._currTextureHash=r.getHash(),this._currLayer=e.node.layer,this._currSamplerHash=this._currSampler.hash,this._currHash=0,this._currTransform=a?null:e.node,this._middlewareEnableBatch=a,this._middlewareBuffer=t,this._currMaterial=s,this._middlewareIndexStart=i,this._middlewareIndexCount=n),this._currIsMiddleware=!0}},{key:"commitModel",value:function(e,t,i){var n;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;i&&(e.stencilStage===lG.ENTER_LEVEL||e.stencilStage===lG.ENTER_LEVEL_INVERTED?this._insertMaskBatch(e):e.stencilStage=TG.sharedManager.stage,n=TG.sharedManager.getStencilStage(e.stencilStage,i),r=TG.sharedManager.getStencilHash(e.stencilStage));var s=B.director.getTotalFrames();t&&(t.updateTransform(s),t.updateUBOs(s));for(var a=0;a<t.subModels.length;a++){var o=this._drawBatchPool.alloc(),u=t.subModels[a];o.visFlags=e.node.layer,o.model=t,o.texture=null,o.sampler=null,o.useLocalData=null,n||(n=null),o.fillPasses(i,n,r,u.patches),o.inputAssembler=u.inputAssembler,o.model.visFlags=o.visFlags,o.descriptorSet=u.descriptorSet,this._batches.push(o)}}},{key:"setupStaticBatch",value:function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e}},{key:"endStaticBatch",value:function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()}},{key:"commitStaticBatch",value:function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()}},{key:"autoMergeBatches",value:function(e){if(this._currIsMiddleware)this.mergeBatchesForMiddleware(e);else{var t=this._currMaterial;if(t){var i,n=this._currRenderData,r=this._staticVBBuffer;if(n&&n._isMeshBuffer)i=n.requestIA(this.device),-1===this._meshDataArray.indexOf(n)&&this._meshDataArray.push(n);else if(r){var s=this._currBID,a=r.getMeshBuffer(s);if(!a)return;var o=a.indexOffset-this._indexStart;if(o<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(i=a.requireFreeIA(this.device)).firstIndex=this._indexStart,i.indexCount=o,this._indexStart=a.indexOffset}if(this._currBID=-1,i){var u,h=0;e&&(u=null!==e.customMaterial?TG.sharedManager.getStencilStage(e.stencilStage,t):TG.sharedManager.getStencilStage(e.stencilStage),h=TG.sharedManager.getStencilHash(e.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=this._currLayer,l.texture=this._currTexture,l.sampler=this._currSampler,l.inputAssembler=i,l.useLocalData=this._currTransform,l.textureHash=this._currTextureHash,l.samplerHash=this._currSamplerHash,l.fillPasses(t,u,h,null),this._batches.push(l)}}}}},{key:"mergeBatchesForMiddleware",value:function(e){var t,i;e.stencilStage=TG.sharedManager.stage,t=null!==e.customMaterial?TG.sharedManager.getStencilStage(e.stencilStage,this._currMaterial):TG.sharedManager.getStencilStage(e.stencilStage),i=TG.sharedManager.getStencilHash(e.stencilStage);var n=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();n.visFlags=e.node.layer;var r=this._middlewareBuffer.requireFreeIA(this.device);r.firstIndex=this._middlewareIndexStart,r.indexCount=this._middlewareIndexCount,n.inputAssembler=r,n.useLocalData=this._currTransform,n.texture=this._currTexture,n.sampler=this._currSampler,n.textureHash=this._currTextureHash,n.samplerHash=this._currSamplerHash,n.fillPasses(this._currMaterial||null,t,i,null),this._batches.push(n),this._currIsMiddleware=!1,this._middlewareBuffer=null}},{key:"forceMergeBatches",value:function(e,t,i){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=i.node.layer,this.autoMergeBatches(i)}},{key:"resetRenderStates",value:function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}},{key:"finishMergeBatches",value:function(){this.autoMergeBatches(),this.resetRenderStates()}},{key:"flushMaterial",value:function(e){this._currMaterial=e}},{key:"walk",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(e.activeInHierarchy){var i=e.children,n=e._uiProps,r=n.uiComp,s=this._pOpacity,a=s,o=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=o*n.localOpacity,n._opacity=a,!Di(a,0,Mi)){if(n.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.fillBuffers(this),this._opacityDirty&&r&&!r.useVertexOpacity&&r.renderData&&r.renderData.vertexCount>0){Af(r.renderData,a);var u=r.renderData.getMeshBuffer();u&&u.setDirty()}if(i.length>0&&!e._static)for(var h=0;h<i.length;++h){var l=i[h];this.walk(l,t)}n.colorDirty&&(this._opacityDirty--,n.colorDirty=!1)}this._pOpacity=s,r&&r.enabledInHierarchy&&(r.postUpdateAssembler(this),(r.stencilStage===lG.ENTER_LEVEL||r.stencilStage===lG.ENTER_LEVEL_INVERTED)&&TG.sharedManager.getMaskStackSize()>0&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates(),TG.sharedManager.exitMask())),t+=1}}},{key:"_screenSort",value:function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()}},{key:"_releaseDescriptorSetCache",value:function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)}},{key:"_createClearModel",value:function(){if(!this._maskClearModel){this._maskClearMtl=HS.get("default-clear-stencil"),this._maskClearModel=B.director.root.createModel(Cx);var e=sG(ZF),t=yf.gfxDevice,i=t.createBuffer(new Gc(Gl.VERTEX|Gl.TRANSFER_DST,Hl.DEVICE,4*e,e)),n=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(n);var r=t.createBuffer(new Gc(Gl.INDEX|Gl.TRANSFER_DST,Hl.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),s=new Uint16Array([0,1,2,2,1,3]);r.update(s),this._maskModelMesh=new _w([i],ZF,uc.TRIANGLE_LIST,r),this._maskModelMesh.subMeshIdx=0,this._maskClearModel.initSubModel(0,this._maskModelMesh,this._maskClearMtl)}}},{key:"_insertMaskBatch",value:function(e){this.autoMergeBatches(this._currComponent),this.resetRenderStates(),this._createClearModel(),this._maskClearModel.node=this._maskClearModel.transform=e.node;var t=TG.sharedManager;t.pushMask(1);var i,n=t.clear(e),r=0,s=this._maskClearMtl;s&&(i=t.getStencilStage(n,s),r=t.getStencilHash(n));var a=this._maskClearModel,o=B.director.getTotalFrames();a&&(a.updateTransform(o),a.updateUBOs(o));for(var u=0;u<a.subModels.length;u++){var h=this._drawBatchPool.alloc(),l=a.subModels[u];h.visFlags=e.node.layer,h.model=a,h.texture=null,h.sampler=null,h.useLocalData=null,i||(i=null),h.fillPasses(s,i,r,l.patches),h.inputAssembler=l.inputAssembler,h.model.visFlags=h.visFlags,h.descriptorSet=l.descriptorSet,this._batches.push(h)}t.enableMask()}},{key:"syncMeshBuffersToNative",value:function(){}}]),e}()),Kq=function(){function e(){n(this,e),this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var t=yf.gfxDevice;this._localData=new Float32Array(Mv.COUNT),this._localBuffer=t.createBuffer(new Gc(Gl.UNIFORM|Gl.TRANSFER_DST,Hl.HOST|Hl.DEVICE,Mv.SIZE,Mv.SIZE))}return s(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"initialize",value:function(e){var t=yf.gfxDevice;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,jq.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(jq),this._descriptorSet.bindBuffer(Mv.BINDING,this._localBuffer);var i=hv.SAMPLER_SPRITE;this._descriptorSet.bindTexture(i,e.texture),this._descriptorSet.bindSampler(i,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0}},{key:"updateTransform",value:function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())}},{key:"equals",value:function(e,t,i){return this._transform===e&&this._textureHash===t&&this._samplerHash===i}},{key:"reset",value:function(){this._transform=null,this._textureHash=0,this._samplerHash=0}},{key:"destroy",value:function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null}},{key:"isValid",value:function(){return this._transform&&this._transform.isValid}},{key:"uploadLocalData",value:function(){var e=this._transform;if((e.hasChangedFlags||e.isTransformDirty())&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;Cn.toArray(this._localData,t,Mv.MAT_WORLD_OFFSET),Cn.inverseTranspose(qq,t);var i=Cn.determinant(qq),n=1/Math.sqrt(i);Cn.multiplyScalar(qq,qq,n),Cn.toArray(this._localData,qq,Mv.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}}}]),e}(),Qq=function(){function e(){n(this,e),this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Eh((function(){return new Kq}),16,(function(e){return e.destroy()}))}return s(e,[{key:"getDescriptorSet",value:function(e){var t;if(B.director.root,e.useLocalData){for(var i=this._localDescriptorSetCache,n=0,r=i.length;n<r;n++){var s=i[n];if(s.equals(e.useLocalData,e.textureHash,e.samplerHash))return s.descriptorSet}var a=this._localCachePool.alloc();return a.initialize(e),this._localDescriptorSetCache.push(a),a.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);jq.layout=e.passes[0].localSetLayout;var o=yf.gfxDevice.createDescriptorSet(jq),u=hv.SAMPLER_SPRITE;return o.bindTexture(u,e.texture),o.bindSampler(u,e.sampler),o.update(),this._descriptorSetCache.set(t,o),this._dsCacheHashByTexture.set(e.textureHash,t),o}},{key:"update",value:function(){var e=this._localDescriptorSetCache,t=e.length;if(0!==t){for(var i=[],n=0;n<t;n++){var r=e[n];if(r.isValid())r.uploadLocalData();else{r.reset();var s=e.indexOf(r);i.push(s)}}for(var a=i.length-1;a>=0;a--){var o=i[a],u=e[o];e.splice(o,1),this._localCachePool.free(u)}}}},{key:"reset",value:function(){for(var e=this._localDescriptorSetCache,t=e.length,i=0;i<t;i++){var n=e[i];this._localCachePool.free(n)}this._localDescriptorSetCache.length=0}},{key:"releaseDescriptorSetCache",value:function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))}},{key:"destroy",value:function(){for(var e,t=R(this._descriptorSetCache.values());!(e=t()).done;)e.value.destroy();this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()}}]),e}();B.internal.Batcher2D=Yq,e("UIDrawBatch",function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(HW)),ve(_G.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(e){return{name:e,suggest:"please use meshBuffer.accessor.".concat(e," instead")}}))),me(_G.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),pe(_G.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),me(Yq.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),pe(YG.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),me(YG.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),e("QuadRenderData",function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),r=t.call(this,e),ae(9006),r}return i}(YG));var Jq,Zq=M.document,$q=null,eY=-1,tY="BES bswy:->@123丁ぁᄁ",iY=Object.create(null),nY=[],rY=3e3;function sY(){for(var e=!0,t=Date.now(),i=nY.length-1;i>=0;i--){var n=nY[i],r=n.fontFamilyName;if(t-n.startTime>rY)ae(4933,r),n.onComplete(null,r),nY.splice(i,1);else{var s=n.refWidth,a="40px ".concat(r);$q.font=a,s!==FF($q,tY,a)?(nY.splice(i,1),n.onComplete(null,r)):e=!1}}e&&(clearInterval(eY),eY=-1)}function aY(e,t,i){var n=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,n=e.lastIndexOf("/");return-1!==(i="".concat(-1===n?e.substring(0,t):e.substring(n+1,t),"_LABEL")).indexOf(" ")&&(i='"'.concat(i,'"')),i}(e);if(iY[n])i(null,n);else{if(!$q){var r=Zq.createElement("canvas");r.width=100,r.height=100,$q=r.getContext("2d")}var s="40px ".concat(n),a=FF($q,tY,s),o=Zq.createElement("style");o.type="text/css";var u="";Number.isNaN(n)?u+="@font-face { font-family:".concat(n,"; src:"):u+='@font-face { font-family:"'.concat(n,'"; src:'),u+='url("'.concat(e,'");'),o.textContent="".concat(u,"}"),Zq.body.appendChild(o);var h=Zq.createElement("div"),l=h.style;if(l.fontFamily=n,h.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",Zq.body.appendChild(h),function(){if(void 0===Jq)if("FontFace"in M){var e=/Gecko.*Firefox\/(\d+)/.exec(M.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(M.navigator.userAgent)&&/Apple/.exec(M.navigator.vendor);Jq=e?parseInt(e[1],10)>42:!t}else Jq=!1;return Jq}())!function(e,t,i){var n=new Promise((function(i,n){!function r(){Date.now()-e>=rY?n():Zq.fonts.load("40px ".concat(t)).then((function(e){e.length>=1?i():setTimeout(r,100)}),(function(){n()}))}()})),r=null,s=new Promise((function(e,t){r=setTimeout(t,rY)}));Promise.race([s,n]).then((function(){r&&(clearTimeout(r),r=null),i(null,t)}),(function(){ae(4933,t),i(null,t)}))}(Date.now(),n,i);else{var c={fontFamilyName:n,refWidth:a,onComplete:i,startTime:Date.now()};nY.push(c),-1===eY&&(eY=setInterval(sY,100))}iY[n]=o}}function oY(e,t,i,n){var r=new SF;r._nativeUrl=e,r._nativeAsset=t,n(null,r)}hS.register({".font":aY,".eot":aY,".ttf":aY,".woff":aY,".svg":aY,".ttc":aY}),AS.register({".font":oY,".eot":oY,".ttf":oY,".woff":oY,".svg":oY,".ttc":oY}),B.UI={MeshBuffer:_G,spriteAssembler:zq,graphicsAssembler:IX,labelAssembler:tq,RenderData:qG,MeshRenderData:YG},UN.on(VN.EVENT_POST_SUBSYSTEM_INIT,(function(){dY.init()}));var uY,hY,lY,cY,_Y,fY,dY=e("SortingLayers",function(){function e(){n(this,e)}return s(e,null,[{key:"getSortingPriority",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(e+32768<<16|t+32768)>>>0}},{key:"getLayerIndex",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=0;return this.indexMap.has(e)?t=this.indexMap.get(e):ue(2105),t}},{key:"getLayerIndexByName",value:function(e){var t=this.getLayerByName(e);return this.getLayerIndex(t)}},{key:"getLayerName",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t="";return this.nameMap.has(e)?t=this.nameMap.get(e):ue(2105),t}},{key:"getLayerByName",value:function(e){for(var t=this.nameMap.size,i=this.nameMap.keys(),n=0,r=0;r<t;r++)if(n=i.next().value,this.nameMap.get(n)===e)return n;return ue(2106),0}},{key:"isLayerValid",value:function(e){return!!this.indexMap.has(e)||(ue(2105),!1)}},{key:"getBuiltinLayers",value:function(){return[{id:0,name:"default",value:0}]}},{key:"init",value:function(){var t=Dt.querySettings(Ot.Category.ENGINE,"sortingLayers");t&&0!==t.length||(t=this.getBuiltinLayers()),e.resetState();for(var i=0;i<t.length;i++){var n=t[i];e.setLayer(n.id,n.name,n.value),e.Enum[n.name]=n.id}wt.update(e.Enum),wt.sortList(e.Enum,(function(t,i){return e.getLayerIndex(t.value)-e.getLayerIndex(i.value)}))}},{key:"setLayer",value:function(e,t,i){this.nameMap.set(e,t),this.indexMap.set(e,i)}},{key:"resetState",value:function(){for(var t=Object.keys(e.Enum),i=0;i<t.length;i++)delete e.Enum[e.Enum[t[i]]],delete e.Enum[t[i]];e.indexMap.clear(),e.nameMap.clear()}}]),e}());dY.nameMap=new Map,dY.indexMap=new Map,dY.Enum=wt({default:0}),e("Sorting",(uY=Hs("cc.Sorting"),hY=Aa(dY.Enum),uY(lY=Xs((x((cY=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._sortingLayer=_Y&&_Y(),e._sortingOrder=fY&&fY(),e._modelRenderer=null,e}return s(i,[{key:"sortingLayer",get:function(){return this._sortingLayer},set:function(e){e!==this._sortingLayer&&dY.isLayerValid(e)&&(this._sortingLayer=e,this._updateSortingPriority())}},{key:"sortingOrder",get:function(){return this._sortingOrder},set:function(e){e!==this._sortingOrder&&(this._sortingOrder=Li(e,-32768,32767),this._updateSortingPriority())}},{key:"__preload",value:function(){this._modelRenderer=this.getComponent("cc.ModelRenderer"),this._modelRenderer||ae(16301,this.node.name),this._updateSortingPriority()}},{key:"_updateSortingPriority",value:function(){var e=dY.getLayerIndex(this._sortingLayer),t=dY.getSortingPriority(e,this._sortingOrder);this._modelRenderer&&this._modelRenderer.isValid&&(this._modelRenderer.priority=t)}}]),i}(tm)).prototype,"sortingLayer",[hY],Object.getOwnPropertyDescriptor(cY.prototype,"sortingLayer"),cY.prototype),_Y=Ms(cY.prototype,"_sortingLayer",[Js],(function(){return dY.Enum.default})),fY=Ms(cY.prototype,"_sortingOrder",[Js],(function(){return 0})),lY=cY))||lY)||lY));var mY,pY,vY,yY,gY,SY,AY="cc.animation.",TY=Symbol("CreateEval"),EY=(Hs("".concat(AY,"EmbeddedPlayer"))((mY=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).begin=pY&&pY(),e.end=vY&&vY(),e.reconciledSpeed=yY&&yY(),e.playable=gY&&gY(),e}return i}(ba),pY=Ms(mY.prototype,"begin",[Js],(function(){return 0})),vY=Ms(mY.prototype,"end",[Js],(function(){return 0})),yY=Ms(mY.prototype,"reconciledSpeed",[Js],(function(){return!1})),gY=Ms(mY.prototype,"playable",[Js],(function(){return null})),mY)),function e(){n(this,e)}),bY=function(){function e(t){n(this,e),this._randomAccess=t}return s(e,[{key:"randomAccess",get:function(){return this._randomAccess}},{key:"setTime",value:function(){}}]),e}(),CY=function(){function e(){n(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return s(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}},{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(_e(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(){}}]),e}();!function(e){e[e.Default=Zu.Default]="Default",e[e.Normal=Zu.Normal]="Normal",e[e.Reverse=Zu.Reverse]="Reverse",e[e.Loop=Zu.Loop]="Loop",e[e.LoopReverse=Zu.Loop|Zu.Reverse]="LoopReverse",e[e.PingPong=Zu.PingPong]="PingPong",e[e.PingPongReverse=Zu.PingPong|Zu.Reverse]="PingPongReverse"}(SY||(SY={})),Bt(SY);var RY,xY=function(){function e(t){n(this,e),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return s(e,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),e}(),wY=function(){function e(t){n(this,e),this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}return s(e,[{key:"destroy",value:function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0}},{key:"createPoseWriter",value:function(e,t,i){var n=this._pose.createWriter(e,t,this,i);return this._blendStateWriters.push(n),n}}]),e}();function kY(){return B.director.getAnimationManager()}!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(RY||(RY={})),Bt(RY);var IY,BY,PY,MY=e("AnimationState",function(e){h(i,e);var t=v(i);function i(e){var r,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return n(this,i),(r=t.call(this)).duration=1,r.time=0,r.frameRate=0,r._targetNode=null,r._curveLoaded=!1,r._clip=void 0,r._speed=1,r._useSimpleProcess=!1,r._target=null,r._wrapMode=SY.Normal,r._repeatCount=1,r._delay=0,r._delayTime=0,r._currentFramePlayed=!1,r._name=void 0,r._lastIterations=NaN,r._lastWrapInfo=null,r._wrappedInfo=new xY,r._allowLastFrame=!1,r._blendStateWriterHost={weight:0},r._playbackDuration=0,r._invDuration=1,r._poseOutput=null,r._weight=1,r._clipEval=void 0,r._clipEventEval=void 0,r._clipEmbeddedPlayerEval=void 0,r._doNotCreateEval=!1,r._clip=e,r._name=s||e&&e.name,r._playbackRange={min:0,max:e.duration},r._playbackDuration=e.duration,e.duration||$("Clip ".concat(e.name," has zero duration.")),r}return s(i,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&Zu.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&Zu.ShouldWrap,i=(this.wrapMode&Zu.Reverse)===Zu.Reverse;this._useSimpleProcess=e===1/0&&!t&&!i}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"speed",get:function(){return this._speed},set:function(e){var t;this._speed=e,null===(t=this._clipEmbeddedPlayerEval)||void 0===t||t.notifyHostSpeedChanged(e)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return 0===this.duration?0:this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}},{key:"initialize",value:function(e,t,i){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._clipEventEval&&(this._clipEventEval=void 0),this._clipEmbeddedPlayerEval&&(this._clipEmbeddedPlayerEval.destroy(),this._clipEmbeddedPlayerEval=void 0),this._targetNode=e;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this._speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Zu.Loop)===Zu.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var r,s,a,o=null!==(r=null!=t?t:null===(s=kY())||void 0===s?void 0:s.blendState)&&void 0!==r?r:null;o&&(this._poseOutput=new wY(o)),this._clipEval=n.createEvaluator({target:e,pose:null!==(a=this._poseOutput)&&void 0!==a?a:void 0,mask:i})}n.containsAnyEvent()&&(this._clipEventEval=n.createEventEvaluator(this._targetNode)),n.containsAnyEmbeddedPlayer()&&(this._clipEmbeddedPlayerEval=n.createEmbeddedPlayerEvaluator(this._targetNode),this._clipEmbeddedPlayerEval.notifyHostSpeedChanged(this._speed))}}},{key:"destroy",value:function(){this.isMotionless||kY().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0}},{key:"emit",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];kY().pushDelayEvent(this._emit,this,t)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?this._target.on(e,t,i):null}},{key:"once",value:function(e,t,i){return this._target&&this._target.isValid?this._target.once(e,t,i):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&this._target.off(e,t,i)}},{key:"allowLastFrameEvent",value:function(e){this._allowLastFrame=e}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0;var t,i=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(i.ratio,i.direction)}},{key:"update",value:function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this._speed:this._currentFramePlayed=!0,this._process())}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),this._sampleEmbeddedPlayers(e),e}},{key:"onPlay",value:function(){var e;this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(RY.PLAY,this),null===(e=this._clipEmbeddedPlayerEval)||void 0===e||e.notifyHostPlay(this.current)}},{key:"onStop",value:function(){var e;this.isPaused||this._onPauseOrStop(),this.emit(RY.STOP,this),null===(e=this._clipEmbeddedPlayerEval)||void 0===e||e.notifyHostStop()}},{key:"onResume",value:function(){var e;this._onReplayOrResume(),this.emit(RY.RESUME,this),null===(e=this._clipEmbeddedPlayerEval)||void 0===e||e.notifyHostPlay(this.current)}},{key:"onPause",value:function(){var e;this._onPauseOrStop(),this.emit(RY.PAUSE,this),null===(e=this._clipEmbeddedPlayerEval)||void 0===e||e.notifyHostPause(this.current)}},{key:"_sampleCurves",value:function(e){var t=this._poseOutput,i=this._clipEval;t&&(t.weight=this.weight),i&&i.evaluate(e)}},{key:"_process",value:function(){this._useSimpleProcess?this.simpleProcess():this.process()}},{key:"process",value:function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new xY(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(RY.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(RY.FINISHED,this))}},{key:"simpleProcess",value:function(){var e=this._playbackRange.min,t=this._playbackDuration,i=0,n=0;if(0!==t&&((i=this.time%t)<0&&(i+=t),n=(e+i)*this._invDuration),this._sampleCurves(e+i),this._clipEventEval||this._clipEmbeddedPlayerEval){var r=this.getWrappedInfo(this.time,this._wrappedInfo);this._sampleEvents(r),this._sampleEmbeddedPlayers(r)}this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=n),(this.time>0&&this._lastIterations>n||this.time<0&&this._lastIterations<n)&&this.emit(RY.LASTFRAME,this),this._lastIterations=n)}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;return(t&Zu.PingPong)===Zu.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(i=!i)),(t&Zu.Reverse)===Zu.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new xY;var i=this._playbackRange.min,n=this._playbackDuration,r=this.repeatCount;if(0===n)return t.time=0,t.ratio=0,t.direction=1,t.stopped=!!Number.isFinite(r),t.iterations=0,t;var s=!1,a=(e-=i)>0?e/n:-e/n;if(a>=r){a=r,s=!0;var o=r-(0|r);0===o&&(o=1),e=o*n*(e>0?1:-1)}if(e>n){var u=e%n;e=0===u?n:u}else e<0&&0!=(e%=n)&&(e+=n);var h=!1,l=this._wrapMode&Zu.ShouldWrap;l&&(h=this._needReverse(a));var c=h?-1:1;return this.speed<0&&(c*=-1),l&&h&&(e=n-e),t.time=i+e,t.ratio=t.time/this.duration,t.direction=c,t.stopped=s,t.iterations=a,t}},{key:"_getPlaybackStart",value:function(){return this._playbackRange.min}},{key:"_sampleEvents",value:function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)}},{key:"_sampleEmbeddedPlayers",value:function(e){var t;null===(t=this._clipEmbeddedPlayerEval)||void 0===t||t.evaluate(e.time,Math.trunc(e.iterations))}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"_onReplayOrResume",value:function(){kY().addAnimation(this)}},{key:"_onPauseOrStop",value:function(){kY().removeAnimation(this)}}]),i}(CY));B.AnimationState=MY,Hs("".concat(AY,"EmbeddedAnimationClipPlayable"))((IY=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).path=BY&&BY(),e.clip=PY&&PY(),e}return s(i,[{key:"instantiate",value:function(e){var t=this.clip,i=this.path;if(!t)return null;var n=e.getChildByPath(i);if(!n)return ue(3938,i,e.getPathInHierarchy(),t.name),null;var r=new MY(t);return r.initialize(n),new HY(r)}}]),i}(EY),BY=Ms(IY.prototype,"path",[Js],(function(){return""})),PY=Ms(IY.prototype,"clip",[Js],(function(){return null})),IY));var OY,DY,LY,NY,FY,GY,VY,UY,HY=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this,!0))._animationState=void 0,r._animationState=e,r}return s(i,[{key:"destroy",value:function(){this._animationState.destroy()}},{key:"play",value:function(){this._animationState.play()}},{key:"pause",value:function(){this._animationState.pause()}},{key:"stop",value:function(){this._animationState.stop()}},{key:"setSpeed",value:function(e){this._animationState.speed=e}},{key:"setTime",value:function(e){this._animationState.time=e}}]),i}(bY),zY=(Hs("".concat(AY,"EmbeddedParticleSystemPlayable"))((OY=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).path=DY&&DY(),e}return s(i,[{key:"instantiate",value:function(e){var t=e.getChildByPath(this.path);if(!t)return Q("Hierarchy path ".concat(this.path," does not exists.")),null;var i=ft("cc.ParticleSystem");if(!i)return Q("Particle system is required for embedded particle system player."),null;var n=t.getComponent(i);return n?new zY(n):(Q("".concat(this.path," does not includes a particle system component.")),null)}}]),i}(EY),DY=Ms(OY.prototype,"path",[Js],(function(){return""})),OY)),function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this,!1))._particleSystem=void 0,r._particleSystem=e,r}return s(i,[{key:"destroy",value:function(){}},{key:"play",value:function(){this._particleSystem.play()}},{key:"pause",value:function(){this._particleSystem.stopEmitting()}},{key:"stop",value:function(){this._particleSystem.stopEmitting()}},{key:"setSpeed",value:function(e){this._particleSystem.simulationSpeed=e}}]),i}(bY));function WY(e){return"string"==typeof e||"number"==typeof e}var XY,jY,qY,YY,KY,QY,JY,ZY,$Y,eK,tK,iK,nK,rK,sK,aK,oK,uK,hK,lK,cK,_K,fK,dK,mK,pK,vK,yK,gK,SK,AK,TK,EK,bK,CK,RK,xK,wK,kK=Hs("cc.animation.HierarchyPath")((NY=function(){function e(t){n(this,e),this.path=FY&&FY(),this.path=t||""}return s(e,[{key:"get",value:function(e){return e instanceof Jp?e.getChildByPath(this.path)||(ae(3926,e.name,this.path),null):(ae(3925),null)}}]),e}(),FY=Ms(NY.prototype,"path",[Js],(function(){return""})),LY=NY))||LY,IK=Hs("cc.animation.ComponentPath")((VY=function(){function e(t){n(this,e),this.component=UY&&UY(),this.component=t||""}return s(e,[{key:"get",value:function(e){return e instanceof Jp?e.getComponent(this.component)||(ae(3928,e.name,this.component),null):(ae(3927),null)}}]),e}(),UY=Ms(VY.prototype,"component",[Js],(function(){return""})),GY=VY))||GY,BK=Symbol("NormalizedFollow"),PK=Symbol("ConvertAsTrsPath"),MK=Symbol("TrackBinding"),OK=Hs("".concat(AY,"TrackPath"))((jY=function(){function e(){n(this,e),this._paths=qY&&qY()}return s(e,[{key:"length",get:function(){return this._paths.length}},{key:"toProperty",value:function(e){return this._paths.push(e),this}},{key:"toElement",value:function(e){return this._paths.push(e),this}},{key:"toHierarchy",value:function(e){return this._paths.push(new kK(e)),this}},{key:"toComponent",value:function(e){var t=new IK("string"==typeof e?e:He(e));return this._paths.push(t),this}},{key:"toCustomized",value:function(e){return this._paths.push(e),this}},{key:"append",value:function(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];var r=(e=this._paths).concat.apply(e,E(i.map((function(e){return e._paths}))));return this._paths=r,this}},{key:"isPropertyAt",value:function(e){return"string"==typeof this._paths[e]}},{key:"parsePropertyAt",value:function(e){return this._paths[e]}},{key:"isElementAt",value:function(e){return"number"==typeof this._paths[e]}},{key:"parseElementAt",value:function(e){return this._paths[e]}},{key:"isHierarchyAt",value:function(e){return this._paths[e]instanceof kK}},{key:"parseHierarchyAt",value:function(e){return this.isHierarchyAt(e),this._paths[e].path}},{key:"isComponentAt",value:function(e){return this._paths[e]instanceof IK}},{key:"parseComponentAt",value:function(e){return this.isComponentAt(e),this._paths[e].component}},{key:"slice",value:function(t,i){var n=new e;return n._paths=this._paths.slice(t,i),n}},{key:"trace",value:function(e,t,i){var n,r;return null!==(n=t)&&void 0!==n||(t=0),null!==(r=i)&&void 0!==r||(i=this._paths.length),this[BK](e,t,i)}},{key:PK,value:function(){for(var e,t=this._paths,i=t.length,n=0,r="";n<i;++n){var s=t[n];if(!(s instanceof kK))break;s.path&&(r?r+="/".concat(s.path):r=s.path)}if(n===i)return null;if(n!==i-1)return null;switch(t[n]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[n];break;default:return null}return{node:r,property:e}}},{key:BK,value:function(e,t,i){for(var n=this._paths,r=e,s=t;s<i;++s){var a=n[s];if(WY(a)){if(!(a in r))return ae(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r}}]),e}(),qY=Ms(jY.prototype,"_paths",[Js],(function(){return[]})),XY=jY))||XY,DK=Hs("".concat(AY,"TrackBinding"))(YY=ta(($Y=ZY=function(){function e(){n(this,e),this.path=QY&&QY(),this.proxy=JY&&JY()}return s(e,[{key:"parseTrsPath",value:function(){return this.proxy?null:this.path[PK]()}},{key:"createRuntimeBinding",value:function(t,i,n){var r=this.path,s=this.proxy,a=r.length,o=a-1;if(0===a||!r.isPropertyAt(o)&&!r.isElementAt(o)||s){if(s){var u=r[BK](t,0,a);if(null===u)return null;var h=s.forTarget(u),l={setValue:function(e){h.set(e)}},c=h.get;return c&&(l.getValue=function(){return c.call(h)}),l}return ue(3921),null}var _=r.isPropertyAt(o)?r.parsePropertyAt(o):r.parseElementAt(o),f=r[BK](t,0,a-1);if(null===f)return null;if(i&&f instanceof Jp&&function(e){return"position"===e||"rotation"===e||"scale"===e||"eulerAngles"===e}(_))return i.createPoseWriter(f,_,n);var d=e._animationFunctions.get(f.constructor);d||(d=new Map,e._animationFunctions.set(f.constructor,d));var m=d.get(_);return m||(m={setValue:Function("value","this.target.".concat(_," = value;")),getValue:Function("return this.target.".concat(_,";"))},d.set(_,m)),{target:f,setValue:m.setValue,getValue:m.getValue}}},{key:"isMaskedOff",value:function(e){var t=this.parseTrsPath();if(!t)return!1;for(var i=e.joints[Symbol.iterator](),n=i.next();!n.done;n=i.next()){var r=n.value;if(r.path===t.node)return!r.enabled}return!1}}]),e}(),ZY._animationFunctions=new WeakMap,QY=Ms((KY=$Y).prototype,"path",[Js],(function(){return new OK})),JY=Ms(KY.prototype,"proxy",[Js],null),YY=KY))||YY)||YY,LK=Hs("".concat(AY,"Track"))((tK=function(){function e(){n(this,e),this._binding=iK&&iK()}return s(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:MK,get:function(){return this._binding}},{key:"channels",value:function(){return[]}},{key:"range",value:function(){for(var e,t={min:1/0,max:-1/0},i=R(this.channels());!(e=i()).done;){var n=e.value;t.min=Math.min(t.min,n.curve.rangeMin),t.max=Math.max(t.max,n.curve.rangeMax)}return t}}]),e}(),iK=Ms(tK.prototype,"_binding",[Js],(function(){return new DK})),eK=tK))||eK,NK=Hs("".concat(AY,"Channel"))((rK=function(){function e(t){n(this,e),this.name="",this._curve=sK&&sK(),this._curve=t}return s(e,[{key:"curve",get:function(){return this._curve}}]),e}(),sK=Ms(rK.prototype,"_curve",[Js],null),nK=rK))||nK,FK=Hs("".concat(AY,"SingleChannelTrack"))((oK=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._channel=uK&&uK(),e._channel=new NK(e.createCurve()),e}return s(i,[{key:"channel",get:function(){return this._channel}},{key:"channels",value:function(){return[this._channel]}},{key:"createCurve",value:function(){throw new Error("Not impl")}},{key:TY,value:function(){var e=this._channel.curve;return new GK(e)}}]),i}(LK),uK=Ms(oK.prototype,"_channel",[Js],null),aK=oK))||aK,GK=function(){function e(t){n(this,e),this._curve=t}return s(e,[{key:"evaluate",value:function(e){return this._curve.evaluate(e)}}]),e}(),VK=Js,UK=(Hs("".concat(AY,"RealArrayTrack"))((hK=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._channels=lK&&lK(),e}return s(i,[{key:"elementCount",get:function(){return this._channels.length},set:function(e){var t=this._channels.length;if(e<t)this._channels.splice(e);else if(e>t){var i;(i=this._channels).push.apply(i,E(Array.from({length:e-t},(function(){return new NK(new $o)}))))}}},{key:"channels",value:function(){return this._channels}},{key:TY,value:function(){return new UK(this._channels.map((function(e){return e.curve})))}}]),i}(LK),lK=Ms(hK.prototype,"_channels",[VK],(function(){return[]})),hK)),function(){function e(t){n(this,e),this._curves=t,this._result=new Array(t.length).fill(0)}return s(e,[{key:"evaluate",value:function(e){for(var t=this._result,i=t.length,n=0;n<i;++n)t[n]=this._curves[n].evaluate(e);return this._result}}]),e}()),HK=Hs("cc.animation.UniformProxyFactory")((_K=function(){function e(t,i){n(this,e),this.passIndex=fK&&fK(),this.uniformName=dK&&dK(),function(e,t,i,n){i&&Object.defineProperty(e,"channelIndex",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,mK,this),this.passIndex=i||0,this.uniformName=t||""}return s(e,[{key:"forTarget",value:function(e){var t=e.passes[this.passIndex],i=t.getHandle(this.uniformName);if(!i)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));if(QS.getTypeFromHandle(i)<Fl.SAMPLER1D){var n=void 0===this.channelIndex?i:t.getHandle(this.uniformName,this.channelIndex,Fl.FLOAT);if(!n)throw new Error('Uniform "'.concat(this.uniformName," (in material ").concat(e.name,") has no channel ").concat(this.channelIndex,'"'));return function(e,t){for(var i,n=R(e.shaderInfo.blocks);!(i=n()).done;)for(var r,s=R(i.value.members);!(r=s()).done;){var a=r.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(n,e)}}:{set:function(e){t.setUniform(n,e)}}}var r=QS.getBindingFromHandle(i),s=t.properties[this.uniformName],a=s&&s.value?"".concat(s.value).concat(Zy(s.type)):Jy(s.type),o=HS.get(a);return o||(Q("Illegal texture default value: ".concat(a,".")),o=HS.get("default-texture")),{set:function(e){e||(e=o);var i=e.getGFXTexture();i&&i.width&&i.height&&(t.bindTexture(r,i),e instanceof kd&&t.bindSampler(r,yf.gfxDevice.getSampler(e.getSamplerInfo())))}}}}]),e}(),fK=Ms(_K.prototype,"passIndex",[Js],(function(){return 0})),dK=Ms(_K.prototype,"uniformName",[Js],(function(){return""})),mK=x(_K.prototype,"channelIndex",[ya],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),cK=_K))||cK,zK=Hs("cc.animation.MorphWeightValueProxy")((vK=function(){function e(){n(this,e),this.subMeshIndex=yK&&yK(),this.shapeIndex=gK&&gK()}return s(e,[{key:"forTarget",value:function(e){var t=this;return{set:function(i){e.setWeight(i,t.subMeshIndex,t.shapeIndex)}}}}]),e}(),yK=Ms(vK.prototype,"subMeshIndex",[Js],(function(){return 0})),gK=Ms(vK.prototype,"shapeIndex",[Js],(function(){return 0})),pK=vK))||pK,WK=Hs("cc.animation.MorphWeightsValueProxy")((AK=function(){function e(){n(this,e),this.subMeshIndex=TK&&TK()}return s(e,[{key:"forTarget",value:function(e){var t=this;return{set:function(i){e.setWeights(i,t.subMeshIndex)}}}}]),e}(),TK=Ms(AK.prototype,"subMeshIndex",[Js],(function(){return 0})),SK=AK))||SK,XK=Hs("cc.animation.MorphWeightsAllValueProxy")(EK=function(){function e(){n(this,e)}return s(e,[{key:"forTarget",value:function(e){return{set:function(t){for(var i,n,r=null!==(i=null===(n=e.mesh)||void 0===n?void 0:n.struct.primitives.length)&&void 0!==i?i:0,s=0;s<r;++s)e.setWeights(t,s)}}}}]),e}())||EK;function jK(e,t,i,r){var a,o,u,h,l,c=new t,_=new t,f=new t,d=Hs(e)((o=function(){function e(i,r,s){n(this,e),this.dataPoint=u&&u(),this.inTangent=h&&h(),this.outTangent=l&&l(),this.dataPoint=i||new t,this.inTangent=r||new t,this.outTangent=s||new t}return s(e,[{key:"lerp",value:function(e,t,n){var s=this.dataPoint,a=e.dataPoint;_=i(_,this.inTangent,n),f=i(f,e.outTangent,n);var o=t*t*t,u=t*t,h=o-2*u+t,l=-2*o+3*u,d=o-u;return c=i(c,s,2*o-3*u+1),c=r(c,c,_,h),c=r(c,c,a,l),c=r(c,c,f,d)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}(),u=Ms(o.prototype,"dataPoint",[Js],(function(){return new t})),h=Ms(o.prototype,"inTangent",[Js],(function(){return new t})),l=Ms(o.prototype,"outTangent",[Js],(function(){return new t})),a=o))||a;if(t===vn){var m=d.prototype.lerp;d.prototype.lerp=function(e,t,i){var n=m.call(this,e,t,i);return vn.normalize(n,n),n}}return d}var qK,YK,KK,QK,JK,ZK=jK("cc.CubicSplineVec2Value",In,In.multiplyScalar,In.scaleAndAdd),$K=jK("cc.CubicSplineVec3Value",an,an.multiplyScalar,an.scaleAndAdd),eQ=jK("cc.CubicSplineVec4Value",en,en.multiplyScalar,en.scaleAndAdd),tQ=jK("cc.CubicSplineQuatValue",vn,vn.multiplyScalar,vn.scaleAndAdd),iQ=Hs("cc.CubicSplineNumberValue")((CK=function(){function e(t,i,r){n(this,e),this.dataPoint=RK&&RK(),this.inTangent=xK&&xK(),this.outTangent=wK&&wK(),this.dataPoint=t,this.inTangent=i,this.outTangent=r}return s(e,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint,s=t*t*t,a=t*t;return n*(2*s-3*a+1)+this.outTangent*i*(s-2*a+t)+r*(-2*s+3*a)+e.inTangent*i*(s-a)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}(),RK=Ms(CK.prototype,"dataPoint",[Js],(function(){return 0})),xK=Ms(CK.prototype,"inTangent",[Js],(function(){return 0})),wK=Ms(CK.prototype,"outTangent",[Js],(function(){return 0})),bK=CK))||bK,nQ=Hs("".concat(AY,"RealTrack"))(qK=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"createCurve",value:function(){return new $o}}]),i}(FK))||qK;function rQ(e){return 0===e.keyFramesCount?void 0:e}var sQ,aQ,oQ,uQ,hQ,lQ,cQ,_Q,fQ=["X","Y","Z","W"],dQ=Hs("".concat(AY,"VectorTrack"))((KK=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i),(e=t.call(this))._channels=QK&&QK(),e._nComponents=JK&&JK(),e._channels=new Array(4);for(var r=0;r<e._channels.length;++r){var s=new NK(new $o);s.name=fQ[r],e._channels[r]=s}return e}return s(i,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}},{key:"channels",value:function(){return this._channels}},{key:TY,value:function(){switch(this._nComponents){default:case 2:return new mQ(rQ(this._channels[0].curve),rQ(this._channels[1].curve));case 3:return new pQ(rQ(this._channels[0].curve),rQ(this._channels[1].curve),rQ(this._channels[2].curve));case 4:return new vQ(rQ(this._channels[0].curve),rQ(this._channels[1].curve),rQ(this._channels[2].curve),rQ(this._channels[3].curve))}}}]),i}(LK),QK=Ms(KK.prototype,"_channels",[Js],null),JK=Ms(KK.prototype,"_nComponents",[Js],(function(){return 4})),YK=KK))||YK,mQ=function(){function e(t,i){n(this,e),this._result=new In,this._x=t,this._y=i}return s(e,[{key:"evaluate",value:function(e,t){return this._x&&this._y||!t.getValue||In.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result}}]),e}(),pQ=function(){function e(t,i,r){n(this,e),this._result=new an,this._x=t,this._y=i,this._z=r}return s(e,[{key:"evaluate",value:function(e,t){return this._x&&this._y&&this._z||!t.getValue||an.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result}}]),e}(),vQ=function(){function e(t,i,r,s){n(this,e),this._result=new en,this._x=t,this._y=i,this._z=r,this._w=s}return s(e,[{key:"evaluate",value:function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||en.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result}}]),e}(),yQ=Hs("".concat(AY,"QuatTrack"))(sQ=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"createCurve",value:function(){return new Fu}},{key:TY,value:function(){return new gQ(this.channels()[0].curve)}}]),i}(FK))||sQ,gQ=function(){function e(t){n(this,e),this._result=new vn,this._curve=t}return s(e,[{key:"evaluate",value:function(e){return this._curve.evaluate(e,this._result),this._result}}]),e}(),SQ=["Red","Green","Blue","Alpha"],AQ=Hs("".concat(AY,"ColorTrack"))((oQ=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i),(e=t.call(this))._channels=uQ&&uQ(),e._channels=new Array(4);for(var r=0;r<e._channels.length;++r){var s=new NK(new $o);s.name=SQ[r],e._channels[r]=s}return e}return s(i,[{key:"channels",value:function(){return this._channels}},{key:TY,value:function(){return new TQ(rQ(this._channels[0].curve),rQ(this._channels[1].curve),rQ(this._channels[2].curve),rQ(this._channels[3].curve))}}]),i}(LK),uQ=Ms(oQ.prototype,"_channels",[Js],null),aQ=oQ))||aQ,TQ=function(){function e(t,i,r,s){n(this,e),this._result=new cn,this._x=t,this._y=i,this._z=r,this._w=s}return s(e,[{key:"evaluate",value:function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||cn.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result}}]),e}(),EQ=["Width","Height"],bQ=Hs("".concat(AY,"SizeTrack"))((lQ=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i),(e=t.call(this))._channels=cQ&&cQ(),e._channels=new Array(2);for(var r=0;r<e._channels.length;++r){var s=new NK(new $o);s.name=EQ[r],e._channels[r]=s}return e}return s(i,[{key:"channels",value:function(){return this._channels}},{key:TY,value:function(){return new CQ(rQ(this._channels[0].curve),rQ(this._channels[1].curve))}}]),i}(LK),cQ=Ms(lQ.prototype,"_channels",[Js],null),hQ=lQ))||hQ,CQ=function(){function e(t,i){n(this,e),this._result=new Mn,this._width=t,this._height=i}return s(e,[{key:"evaluate",value:function(e,t){if((!this._width||!this._height)&&t.getValue){var i=t.getValue();this._result.x=i.x,this._result.y=i.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result}}]),e}(),RQ=Hs("".concat(AY,"ObjectTrack"))(_Q=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"createCurve",value:function(){return new Yu}}]),i}(FK))||_Q;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:HK,MorphWeightValueProxy:zK,MorphWeightsValueProxy:WK,MorphWeightsAllValueProxy:XK,Track:LK,TrackPath:OK,RealTrack:nQ,VectorTrack:dQ,QuatTrack:yQ,ColorTrack:AQ,SizeTrack:bQ,ObjectTrack:RQ,isPropertyPath:WY,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:kK,ComponentPath:IK,CubicSplineVec2Value:ZK,CubicSplineVec3Value:$K,CubicSplineVec4Value:eQ,CubicSplineQuatValue:tQ,CubicSplineNumberValue:iQ}));var xQ=e("RatioSampler",function(){function e(t){var i,r;n(this,e),this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var s=!0,a=1,o=t.length;a<o;a++)if(i=t[a]-t[a-1],1===a)r=i;else if(Math.abs(i-r)>1e-6){s=!1;break}this._findRatio=s?BQ:xs}return s(e,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),e}());B.RatioSampler=xQ;var wQ=e("AnimCurve",function(){function e(t,i){n(this,e),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=i,this._values=t.values;var r=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=r(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(r);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var s=0,a=Object.keys(t.easingMethods);s<a.length;s++){var o=a[s];this.types[o]=r(t.easingMethods[o])}}else this.type=null;var u=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=FQ(u)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}return s(e,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var i=0;i<this._array.length;++i)this._array[i]=this._values[this._array.length*e+i];return this._array}},{key:"valueBetween",value:function(e,t,i,n,r){if(this._lerp){var s=this.types?this.types[t]:this.type,a=r-i,o=(e-i)/a;if(s&&(o=IQ(o,s)),void 0===this._array){var u=this._values[t],h=this._values[n];return this._lerp(u,h,o,a*this._duration)}for(var l=0;l<this._array.length;++l){var c=this._values[this._array.length*t+l],_=this._values[this._array.length*n+l];this._array[l]=this._lerp(c,_,o,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array}},{key:"empty",value:function(){return 0===this._values.length}},{key:"constant",value:function(){return 1===this._values.length}}],[{key:"Bezier",value:function(e){return e}}]),e}());function kQ(e,t,i){var n=t.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function IQ(e,t){if("string"==typeof t){var i=zo[t];i?e=i(e):ue(3906,t)}else Array.isArray(t)&&(e=Ou(t,e));return e}function BQ(e,t){var i=e.length-1;if(0===i)return 0;var n=e[0];if(t<n)return 0;var r=e[i];if(t>r)return i;var s=(t=(t-n)/(r-n))/(1/i),a=0|s,o=1e-6;return s-a<o?a:a+1-s<o?a+1:~(a+1)}wQ.Linear=null,B.AnimCurve=wQ,e("EventInfo",function(){function e(){n(this,e),this.events=[]}return s(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}()),B.sampleAnimationCurve=kQ;var PQ,MQ,OQ,DQ,LQ,NQ,FQ=function(){function e(e,t,i,n){return e.lerp(t,i,n)}return function(t){if(null!==t){if("number"==typeof t)return Fi;if("object"===i(t)&&t.constructor){if(t instanceof vn)return n=new vn,function(e,t,i){return vn.slerp(n,e,t,i)};if(t instanceof Mt)return function(e){var t=new e;return function(i,n,r){return e.lerp(t,i,n,r),t}}(t.constructor);if(t.constructor===Number)return Fi;if("function"==typeof t.lerp)return e}var n}}}(),GQ=Symbol("BakeNodeCurves"),VQ=function(){function e(){n(this,e)}return s(e,null,[{key:"getOrExtract",value:function(t){var i=e.pool.get(t);if(!i||i.samples!==t.sample){i&&B.director.root.dataPoolManager.releaseAnimationClip(t);var n=Math.ceil(t.sample*t.duration)+1,r=t.sample;i=t[GQ](0,r,n),e.pool.set(t,i)}return i}},{key:"destroy",value:function(t){e.pool.delete(t)}}]),e}();VQ.pool=new Map;var UQ=Hs("".concat(AY,"UntypedTrackChannel"))((MQ=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,new $o)).property=OQ&&OQ(),e}return i}(NK),OQ=Ms(MQ.prototype,"property",[Js],(function(){return""})),PQ=MQ))||PQ,HQ=Hs("".concat(AY,"UntypedTrack"))((LQ=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._channels=NQ&&NQ(),e}return s(i,[{key:"channels",value:function(){return this._channels}},{key:TY,value:function(e){var t=this;if(!e.getValue)throw new Error(_e(3930));var i=function(e){var i;return null===(i=t._channels.find((function(t){return t.property===e})))||void 0===i?void 0:i.curve},n=e.getValue();switch(!0){default:throw new Error(_e(3931));case n instanceof In:return new mQ(i("x"),i("y"));case n instanceof an:return new pQ(i("x"),i("y"),i("z"));case n instanceof en:return new vQ(i("x"),i("y"),i("z"),i("w"));case n instanceof cn:return new TQ(i("r"),i("g"),i("b"),i("a"));case n instanceof Mn:return new CQ(i("width"),i("height"))}}},{key:"addChannel",value:function(e){var t=new UQ;return t.property=e,this._channels.push(t),t}},{key:"upgrade",value:function(e){var t=this,i=function(e,i){var n=t.channels().find((function(t){return t.property===e}));n&&(i.name=n.name,i.curve.assignSorted(Array.from(n.curve.times()),Array.from(n.curve.values())))},n=e(this.path,this.proxy);switch(n){default:break;case"vec2":case"vec3":case"vec4":var r=new dQ;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===n?2:"vec3"===n?3:4;var s=T(r.channels(),4),a=s[0],o=s[1],u=s[2],h=s[3];switch(n){case"vec4":i("w",h);case"vec3":i("z",u);default:case"vec2":i("x",a),i("y",o)}return r;case"color":var l=new AQ,c=T(l.channels(),4),_=c[0],f=c[1],d=c[2],m=c[3];return i("r",_),i("g",f),i("b",d),i("a",m),i("x",_),i("y",f),i("z",d),i("w",m),l;case"size":}return null}}]),i}(LK),NQ=Ms(LQ.prototype,"_channels",[Js],(function(){return[]})),DQ=LQ))||DQ,zQ=function(){function e(t){n(this,e),this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}return s(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}},{key:"getPropertyCurves",value:function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"toTracks",value:function(){for(var e,t=[],n=this.keys,r=this.curves,s=this.commonTargets,a=function(e,t,i){for(var n,r=new OK,s=R(t);!(n=s()).done;){var a=n.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof kK?r.toHierarchy(a.path):a instanceof IK?r.toComponent(a.component):r.toCustomized(a)}e.path=r,e.proxy=i},o=s.map((function(e){var i=new HQ;return a(i,e.modifiers,e.valueAdapter),t.push(i),i})),u=function(){var r,s=e.value,u=s.data,h=u.values;if(0===h.length)return"continue";var l=u.keys<0?[0]:n[u.keys],c=h[0],_=null===(r=u.interpolate)||void 0===r||r;u._arrayLength;var f=new XQ(u,l.length),d=function(e){a(e,s.modifiers,s.valueAdapter)},m=void 0;if("number"==typeof s.commonTarget){if(!h.every((function(e){return"number"==typeof e})))return ae(3932),"continue";if(s.valueAdapter||1!==s.modifiers.length||"string"!=typeof s.modifiers[0])return ae(3933),"continue";var p=s.modifiers[0],v=o[s.commonTarget].addChannel(p).curve;m=v}!function(){if("number"==typeof c){if(!h.every((function(e){return"number"==typeof e})))return void ae(3934);var e;if(m)e=m;else{var n=new nQ;d(n),t.push(n),e=n.channel.curve}var r=_?ws.LINEAR:ws.CONSTANT;return e.assignSorted(l,h.map((function(e){return{value:e,interpolationMode:r}}))),void f.convert(e)}if("object"===i(c))switch(!0){default:break;case WQ(h,In):case WQ(h,an):case WQ(h,en):var s=c instanceof In?2:c instanceof an?3:4,a=new dQ;d(a),a.componentsCount=s;var o=T(a.channels(),4),u=o[0].curve,p=o[1].curve,v=o[2].curve,y=o[3].curve,g=_?ws.LINEAR:ws.CONSTANT,S=function(e){return{value:e,interpolationMode:g}};switch(s){case 4:y.assignSorted(l,h.map((function(e){return S(e.w)}))),f.convert(y);case 3:v.assignSorted(l,h.map((function(e){return S(e.z)}))),f.convert(v);default:u.assignSorted(l,h.map((function(e){return S(e.x)}))),f.convert(u),p.assignSorted(l,h.map((function(e){return S(e.y)}))),f.convert(p)}return void t.push(a);case WQ(h,vn):var A=new yQ;d(A);var E=_?xu.SLERP:xu.CONSTANT;return A.channel.curve.assignSorted(l,h.map((function(e){return{value:vn.clone(e),interpolationMode:E}}))),f.convertQuatCurve(A.channel.curve),void t.push(A);case WQ(h,cn):var b=new AQ;d(b);var C=T(b.channels(),4),R=C[0].curve,x=C[1].curve,w=C[2].curve,k=C[3].curve,I=_?ws.LINEAR:ws.CONSTANT,B=function(e){return{value:e,interpolationMode:I}};return R.assignSorted(l,h.map((function(e){return B(e.r)}))),f.convert(R),x.assignSorted(l,h.map((function(e){return B(e.g)}))),f.convert(x),w.assignSorted(l,h.map((function(e){return B(e.b)}))),f.convert(w),k.assignSorted(l,h.map((function(e){return B(e.a)}))),f.convert(k),void t.push(b);case WQ(h,Mn):var P=new bQ;d(P);var M=T(P.channels(),2),O=M[0].curve,D=M[1].curve,L=_?ws.LINEAR:ws.CONSTANT,N=function(e){return{value:e,interpolationMode:L}};return O.assignSorted(l,h.map((function(e){return N(e.width)}))),f.convert(O),D.assignSorted(l,h.map((function(e){return N(e.height)}))),f.convert(D),void t.push(P);case WQ(h,iQ):var F=new nQ;d(F);var G=_?ws.CUBIC:ws.CONSTANT;return F.channel.curve.assignSorted(l,h.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:G}}))),void t.push(F);case WQ(h,ZK):case WQ(h,$K):case WQ(h,eQ):var V=c instanceof ZK?2:c instanceof $K?3:4,U=new dQ;d(U),U.componentsCount=V;var H=T(U.channels(),4),z=H[0],W=H[1],X=H[2],j=H[3],q=_?ws.LINEAR:ws.CONSTANT,Y=function(e,t,i){return{value:e,leftTangent:t,rightTangent:i,interpolationMode:q}};switch(V){case 4:j.curve.assignSorted(l,h.map((function(e){return Y(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:X.curve.assignSorted(l,h.map((function(e){return Y(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:z.curve.assignSorted(l,h.map((function(e){return Y(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),W.curve.assignSorted(l,h.map((function(e){return Y(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(U);case h.every((function(e){return e instanceof tQ})):ae(3935)}var K=new RQ;d(K),K.channel.curve.assignSorted(l,h),t.push(K)}()},h=R(r);!(e=h()).done;)u();return t}},{key:"_createPropertyCurves",value:function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new xQ(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new wQ(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))}}]),e}();function WQ(e,t){return e.every((function(e){return e instanceof t}))}var XQ=function(){function e(t,i){n(this,e),this._easingMethods=void 0;var r=t.easingMethods;Array.isArray(r)?0===r.length&&0!==i?this._easingMethods=new Array(i).fill(null):this._easingMethods=r:this._easingMethods=void 0===r?new Array(i).fill(t.easingMethod):Array.from({length:i},(function(e,t){var i;return null!==(i=r[t])&&void 0!==i?i:null}))}return s(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}},{key:"convert",value:function(e){var t,i,n,r,s,a,o,u,h,l,c,_,f,d,m,p,v,y,g,S,A,E,b,C=this._easingMethods;if(C){var R=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(C)&&C.length;for(var x=R-1,w=0;w<x;++w){var k=C[w];k&&(Array.isArray(k)?(t=k,i=e.getKeyframeTime(w),n=e.getKeyframeValue(w),r=e.getKeyframeTime(w+1),s=e.getKeyframeValue(w+1),a=void 0,o=void 0,u=void 0,h=void 0,l=void 0,c=void 0,_=void 0,f=void 0,d=void 0,m=void 0,p=void 0,v=void 0,y=void 0,g=void 0,S=void 0,A=void 0,E=void 0,b=void 0,o=T(t,4),u=o[0],h=o[1],l=o[2],c=o[3],_=n.value,f=3*(r-i),d=3*(s.value-_),v=(1-l)*f,y=(1-c)*d,g=1/3,S=(p=h*d)/(m=u*f),A=Math.sqrt(m*m+p*p)*g,E=y/v,b=Math.sqrt(v*v+y*y)*g,n.interpolationMode=ws.CUBIC,n.tangentWeightMode=(a=n.tangentWeightMode)===Is.NONE?Is.RIGHT:a===Is.LEFT?Is.BOTH:a,n.rightTangent=S,n.rightTangentWeight=A,s.tangentWeightMode=function(e){return e===Is.NONE?Is.LEFT:e===Is.RIGHT?Is.BOTH:e}(s.tangentWeightMode),s.leftTangent=E,s.leftTangentWeight=b):jQ(k,e,w))}}}}},{key:"convertQuatCurve",value:function(e){var t=this._easingMethods;if(t){var i=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var n=i-1,r=0;r<n;++r){var s=t[r];s&&(Array.isArray(s)?e.getKeyframeValue(r).easingMethod=s.slice():qQ(s,e,r))}}}}}]),e}();function jQ(e,t,i){t.keyFramesCount;var n=t.getKeyframeValue(i),r=yJ[e];r===Ho.CONSTANT?n.interpolationMode=ws.CONSTANT:(n.interpolationMode=ws.LINEAR,n.easingMethod=r)}function qQ(e,t,i){t.keyFramesCount;var n=t.getKeyframeValue(i),r=yJ[e];n.easingMethod=r}var YQ,KQ,QQ,JQ,ZQ,$Q,eJ,tJ,iJ,nJ,rJ,sJ,aJ,oJ,uJ,hJ,lJ,cJ,_J,fJ,dJ,mJ,pJ,vJ,yJ={constant:Ho.CONSTANT,linear:Ho.LINEAR,quadIn:Ho.QUAD_IN,quadOut:Ho.QUAD_OUT,quadInOut:Ho.QUAD_IN_OUT,quadOutIn:Ho.QUAD_OUT_IN,cubicIn:Ho.CUBIC_IN,cubicOut:Ho.CUBIC_OUT,cubicInOut:Ho.CUBIC_IN_OUT,cubicOutIn:Ho.CUBIC_OUT_IN,quartIn:Ho.QUART_IN,quartOut:Ho.QUART_OUT,quartInOut:Ho.QUART_IN_OUT,quartOutIn:Ho.QUART_OUT_IN,quintIn:Ho.QUINT_IN,quintOut:Ho.QUINT_OUT,quintInOut:Ho.QUINT_IN_OUT,quintOutIn:Ho.QUINT_OUT_IN,sineIn:Ho.SINE_IN,sineOut:Ho.SINE_OUT,sineInOut:Ho.SINE_IN_OUT,sineOutIn:Ho.SINE_OUT_IN,expoIn:Ho.EXPO_IN,expoOut:Ho.EXPO_OUT,expoInOut:Ho.EXPO_IN_OUT,expoOutIn:Ho.EXPO_OUT_IN,circIn:Ho.CIRC_IN,circOut:Ho.CIRC_OUT,circInOut:Ho.CIRC_IN_OUT,circOutIn:Ho.CIRC_OUT_IN,elasticIn:Ho.ELASTIC_IN,elasticOut:Ho.ELASTIC_OUT,elasticInOut:Ho.ELASTIC_IN_OUT,elasticOutIn:Ho.ELASTIC_OUT_IN,backIn:Ho.BACK_IN,backOut:Ho.BACK_OUT,backInOut:Ho.BACK_IN_OUT,backOutIn:Ho.BACK_OUT_IN,bounceIn:Ho.BOUNCE_IN,bounceOut:Ho.BOUNCE_OUT,bounceInOut:Ho.BOUNCE_IN_OUT,bounceOutIn:Ho.BOUNCE_OUT_IN,smooth:Ho.SMOOTH,fade:Ho.FADE};var gJ=Hs,SJ=Js;function AJ(){throw new Error("split() only valid in Editor.")}gJ("".concat(AY,"ExoticAnimation"))((YQ=function(){function e(){n(this,e),this._nodeAnimations=KQ&&KQ()}return s(e,[{key:"createEvaluator",value:function(e){return new BJ(this._nodeAnimations,e)}},{key:"addNodeAnimation",value:function(e){var t=new TJ(e);return this._nodeAnimations.push(t),t}},{key:"collectAnimatedJoints",value:function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))}},{key:"split",value:function(){return AJ()}},{key:"toHashString",value:function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")}}]),e}(),KQ=Ms(YQ.prototype,"_nodeAnimations",[SJ],(function(){return[]})),YQ));var TJ=gJ("".concat(AY,"ExoticNodeAnimation"))((JQ=function(){function e(t){n(this,e),this._path=ZQ&&ZQ(),this._position=$Q&&$Q(),this._rotation=eJ&&eJ(),this._scale=tJ&&tJ(),this._path=t}return s(e,[{key:"createPosition",value:function(e,t){this._position=new wJ(e,new RJ(t))}},{key:"createRotation",value:function(e,t){this._rotation=new wJ(e,new xJ(t))}},{key:"createScale",value:function(e,t){this._scale=new wJ(e,new RJ(t))}},{key:"createEvaluator",value:function(e){return new PJ(this._path,this._position,this._rotation,this._scale,e)}},{key:"split",value:function(){return AJ()}},{key:"path",get:function(){return this._path}},{key:"toHashString",value:function(){var e,t,i,n,r,s;return"".concat(this._path,"\n").concat(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"").concat(null!==(i=null===(n=this._scale)||void 0===n?void 0:n.toHashString())&&void 0!==i?i:"").concat(null!==(r=null===(s=this._rotation)||void 0===s?void 0:s.toHashString())&&void 0!==r?r:"")}}]),e}(),ZQ=Ms(JQ.prototype,"_path",[SJ],(function(){return""})),$Q=Ms(JQ.prototype,"_position",[SJ],(function(){return null})),eJ=Ms(JQ.prototype,"_rotation",[SJ],(function(){return null})),tJ=Ms(JQ.prototype,"_scale",[SJ],(function(){return null})),QQ=JQ))||QQ;function EJ(e){return e.toPrecision(2)}function bJ(e){return e.map(EJ).join(" ")}var CJ=gJ("".concat(AY,"ExoticVectorLikeTrackValues"))((nJ=function(){function e(t){n(this,e),this._values=rJ&&rJ(),this._isQuantized=sJ&&sJ(),this._values=t,this._isQuantized=!1}return s(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:DJ(this._values)}},{key:"quantize",value:function(e){this._isQuantized,this._values=function(e,t){var i=OJ[t],n=1<<i.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),s=Math.max(e,s)}));var a=s-r,o=i.from(e,(function(e){return(e-r)/a*n}));return new QJ(DJ(e),o,a,r)}(this._values,e),this._isQuantized=!0}},{key:"toHashString",value:function(){var e=this._isQuantized,t=this._values;return"".concat(e," ").concat(e?t.toHashString():bJ(t))}}]),e}(),rJ=Ms(nJ.prototype,"_values",[SJ],null),sJ=Ms(nJ.prototype,"_isQuantized",[SJ],null),iJ=nJ))||iJ,RJ=gJ("".concat(AY,"ExoticVec3TrackValues"))(aJ=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"get",value:function(e,t){var i=this._values;this._isQuantized?$J(i,e,t):an.fromArray(t,i,3*e)}},{key:"lerp",value:function(e,t,i,n,r,s){var a=this._values;this._isQuantized?($J(a,e,n),$J(a,t,r)):(an.fromArray(n,a,3*e),an.fromArray(r,a,3*t)),an.lerp(s,n,r,i)}}],[{key:"imitate",value:function(e,t){var n=new i(e);return t._isQuantized&&n.quantize(t._values.quantizationType),n}}]),i}(CJ))||aJ,xJ=gJ("".concat(AY,"ExoticQuatTrackValues"))(oJ=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"get",value:function(e,t){var i=this._values;this._isQuantized?eZ(i,e,t):vn.fromArray(t,i,4*e)}},{key:"lerp",value:function(e,t,i,n,r,s){var a=this._values;this._isQuantized?(eZ(a,e,n),eZ(a,t,r)):(vn.fromArray(n,a,4*e),vn.fromArray(r,a,4*t)),vn.slerp(s,n,r,i)}}],[{key:"imitate",value:function(e,t){var n=new i(e);return t._isQuantized&&n.quantize(t._values.quantizationType),n}}]),i}(CJ))||oJ,wJ=gJ("".concat(AY,"ExoticTrack"))((hJ=function(){function e(t,i){n(this,e),this.times=lJ&&lJ(),this.values=cJ&&cJ(),this.times=t,this.values=i}return s(e,[{key:"toHashString",value:function(){var e=this.times,t=this.values;return"times: ".concat(bJ(e),"; values: ").concat(t.toHashString())}}]),e}(),lJ=Ms(hJ.prototype,"times",[SJ],null),cJ=Ms(hJ.prototype,"values",[SJ],null),uJ=hJ))||uJ;function kJ(e,t){e.length,e.length;var i=0,n=0,r=xs(e,t);if(r>=0)i=r;else{var s=~r,a=s-1;i=a;var o=e[s],u=e[a];n=(t-u)/(o-u)}return{index:i,ratio:n}}s((function e(){n(this,e),this._reset()}),[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}},{key:"transformTime",value:function(e){return e-this._timeOffset}},{key:"calculate",value:function(e,t,i){this._reset();var n=e.length;if(n){var r=e[0],s=e[n-1],a=Li(t,r,s),o=Li(i,r,s);this._timeOffset=a;var u=function(e,t,i){var n=e.length;i>=t&&t>=e[0]&&e[n-1];var r=kJ(e,t),s=r.index,a=r.ratio,o=kJ(e,i);return{fromIndex:s,fromRatio:a,toIndex:o.index,toRatio:o.ratio}}(e,a,o),h=u.fromIndex,l=u.fromRatio,c=u.toIndex,_=u.toRatio,f=!l,d=!_;h!==c||l!==_?(f||(this.preLerpIndex=h,this.preLerpRatio=l),this.directKeyframesBegin=f?h:h+1,this.directKeyframesEnd=c+1,d||(this.postLerpIndex=c,this.postLerpRatio=_)):f?(this.directKeyframesBegin=h,this.directKeyframesEnd=h+1):(this.preLerpIndex=h,this.preLerpRatio=l)}}},{key:"_reset",value:function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0}}]);var IJ,BJ=function(){function e(t,i){n(this,e),this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((function(e){return e.createEvaluator(i)}))}return s(e,[{key:"evaluate",value:function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))}}]),e}(),PJ=function(){function e(t,i,r,s,a){n(this,e),this._position=null,this._rotation=null,this._scale=null,i&&(this._position=ZJ(i.times,i.values,an,t,"position",a)),r&&(this._rotation=ZJ(r.times,r.values,vn,t,"rotation",a)),s&&(this._scale=ZJ(s.times,s.values,an,t,"scale",a))}return s(e,[{key:"evaluate",value:function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var i=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(i)}if(this._scale){var n=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(n)}}}]),e}(),MJ=function(){function e(t,i,r){n(this,e),this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=i,this._prevValue=new r,this._nextValue=new r,this._resultValue=new r}return s(e,[{key:"evaluate",value:function(e){var t=this._times,i=this._values,n=this._resultValue;if(0===t.length)return n;var r=function(e,t,i){var n=e.length,r=e[0],s=e[n-1];if(t<r)i.just=!0,i.index=0;else if(t>s)i.just=!0,i.index=n-1;else{var a=xs(e,t);if(a>=0)i.just=!0,i.index=a;else{var o=~a,u=o-1,h=e[u],l=e[o],c=(t-e[u])/(l-h);i.just=!1,i.index=u,i.nextIndex=o,i.ratio=c}}return i}(t,e,this._inputSampleResultCache);return r.just?i.get(r.index,n):i.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,n),n}}]),e}(),OJ={uint8:Uint8Array,uint16:Uint16Array};function DJ(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return IJ.FLOAT_32;case 8:return IJ.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(IJ||(IJ={}));var LJ,NJ,FJ,GJ,VJ,UJ,HJ,zJ,WJ,XJ,jJ,qJ,YJ,KJ,QJ=gJ("".concat(AY,"QuantizedFloatArray"))((fJ=function(){function e(t,i,r){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;n(this,e),this.originalPrecision=dJ&&dJ(),this.min=mJ&&mJ(),this.extent=pJ&&pJ(),this.values=vJ&&vJ(),this.originalPrecision=t,this.values=i,this.extent=r,this.min=s}return s(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}},{key:"toHashString",value:function(){var e=this.originalPrecision,t=this.min,i=this.extent,n=this.values;return"".concat(e," ").concat(EJ(t)," ").concat(EJ(i)," ").concat(n.join(" "))}}]),e}(),dJ=Ms(fJ.prototype,"originalPrecision",[SJ],null),mJ=Ms(fJ.prototype,"min",[SJ],null),pJ=Ms(fJ.prototype,"extent",[SJ],null),vJ=Ms(fJ.prototype,"values",[SJ],null),_J=fJ))||_J;function JJ(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function ZJ(e,t,i,n,r,s){var a=new DK;a.path=(new OK).toHierarchy(n).toProperty(r);var o=s(a);return o?{runtimeBinding:o,evaluator:new MJ(e,t,i)}:null}function $J(e,t,i){an.set(i,JJ(e,3*t+0),JJ(e,3*t+1),JJ(e,3*t+2))}function eZ(e,t,i){vn.set(i,JJ(e,4*t+0),JJ(e,4*t+1),JJ(e,4*t+2),JJ(e,4*t+3))}var tZ=Symbol("SearchForRootBonePath"),iZ=Symbol("ExoticAnimation"),nZ=Symbol("[[EmbeddedPlayerCount]]"),rZ=Symbol("[[GetEmbeddedPlayers]]"),sZ=Symbol("[[AddEmbeddedPlayer]]"),aZ=Symbol("[[RemoveEmbeddedPlayer]]"),oZ=Symbol("[[ClearEmbeddedPlayers]]"),uZ=e("AnimationClip",Hs("cc.AnimationClip")((KJ=YJ=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).sample=FJ&&FJ(),e.speed=GJ&&GJ(),e.wrapMode=VJ&&VJ(),e.enableTrsBlending=UJ&&UJ(),e._duration=HJ&&HJ(),e._hash=zJ&&zJ(),e.frameRate=0,e._tracks=WJ&&WJ(),e._exoticAnimation=XJ&&XJ(),e._legacyData=void 0,e._legacyDataDirty=!1,e._events=jJ&&jJ(),e._embeddedPlayers=qJ&&qJ(),e._runtimeEvents={ratios:[],eventGroups:[]},e}return s(i,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var i="Exotic:".concat(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=bl(i,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var i=[],n=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),s=r.length,a=function(e){var s=r[e],a=s.frame/t._duration,o=i.findIndex((function(e){return e===a}));o<0&&(o=i.length,i.push(a),n.push({events:[]})),n[o].events.push({functionName:s.func,parameters:s.params})},o=0;o<s;++o)a(o);this._runtimeEvents={ratios:i,eventGroups:n}}},{key:iZ,get:function(){return this._exoticAnimation}},{key:iZ,set:function(e){this._exoticAnimation=e}},{key:"onLoaded",value:function(){this.frameRate=this.sample,this.events=this._events}},{key:"range",value:function(){for(var e={min:1/0,max:-1/0},t=this._tracks,i=t.length,n=0;n<i;++n){var r=t[n].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e}},{key:"getTrack",value:function(e){return this._tracks[e]}},{key:"addTrack",value:function(e){var t=this._tracks.length;return this._tracks.push(e),t}},{key:"removeTrack",value:function(e){this._tracks.splice(e,1)}},{key:"clearTracks",value:function(){this._tracks.length=0}},{key:"containsAnyEvent",value:function(){return 0!==this._events.length}},{key:"createEventEvaluator",value:function(e){return new vZ(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)}},{key:"containsAnyEmbeddedPlayer",value:function(){return 0!==this._embeddedPlayers.length}},{key:"createEmbeddedPlayerEvaluator",value:function(e){return new hZ(this._embeddedPlayers,e)}},{key:"createEvaluator",value:function(e){var t=this,i=e.target;return this._createEvalWithBinder(i,(function(n){if(!e.mask||!n.isMaskedOff(e.mask)){var r=n.createRuntimeBinding(i,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}}),e.rootMotion)}},{key:"destroy",value:function(){var e;return null!==(e=B.director.root)&&void 0!==e&&e.dataPoolManager&&B.director.root.dataPoolManager.releaseAnimationClip(this),VQ.destroy(this),g(l(i.prototype),"destroy",this).call(this)}},{key:GQ,value:function(e,t,i){for(var n=1/t,r=this._collectAnimatedJoints(),s=r.length,a={},o=0;o<s;++o)a[r[o]]={transforms:Array.from({length:i},(function(){return new Cn}))};var u=r.reduce((function(e,t){return e[t]=new _Z,e}),{});for(var h in u){var l=u[h],c=h.lastIndexOf("/");if(c>=0){var _=h.substring(0,c),f=u[_];f&&(l.parent=f)}}for(var d=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var i=u[t.node];if(i)return pZ(i,t.property)}}),void 0),m=0;m<i;++m){var p=e+n*m;d.evaluate(p);for(var v=0;v<s;++v){var y=r[v];Cn.copy(a[y].transforms[m],u[y].globalTransform)}for(var g=0;g<s;++g){var S=r[g];u[S].invalidate()}}return{samples:t,frames:i,joints:a}}},{key:"upgradeUntypedTracks",value:function(e){for(var t=[],i=[],n=this._tracks,r=n.length,s=0;s<r;++s){var a=n[s];if(a instanceof HQ){var o=a.upgrade(e);o&&(t.push(o),i.push(a))}}for(var u=i.length,h=0;h<u;++h)St(n,i[h]);n.push.apply(n,t)}},{key:tZ,value:function(){return this._searchForRootBonePath()}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"getPropertyCurves",value:function(){return this._getLegacyData().getPropertyCurves()}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}},{key:"updateEventDatas",value:function(){this.events=this._events}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"syncLegacyData",value:function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)}},{key:nZ,get:function(){return this._embeddedPlayers.length}},{key:rZ,value:function(){return this._embeddedPlayers}},{key:sZ,value:function(e){this._embeddedPlayers.push(e)}},{key:aZ,value:function(e){var t=this._embeddedPlayers.indexOf(e);t>=0&&this._embeddedPlayers.splice(t,1)}},{key:oZ,value:function(){this._embeddedPlayers.length=0}},{key:"_createEvalWithBinder",value:function(e,t,i){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var n,r=[];i&&(n=this._createRootMotionEvaluation(e,i,r));for(var s,a=[],o=this._tracks,u=o.length,h=0;h<u;++h){var l=o[h];if(!r.includes(l)&&!Array.from(l.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var c=t(l[MK]);if(c){var _=l[TY](c);a.push({binding:c,trackEval:_})}}}return this._exoticAnimation&&(s=this._exoticAnimation.createEvaluator(t)),new lZ(a,s,n)}},{key:"_createRootMotionEvaluation",value:function(e,t,i){if(e instanceof Jp){var n=this._searchForRootBonePath();if(n){var r=e.getChildByPath(n);if(r){for(var s=new cZ,a=[],o=this._tracks,u=o.length,h=0;h<u;++h){var l=o[h],c=l[MK].parseTrsPath();if(c&&c.node===n){i.push(l);var _=pZ(s,c.property);if(_){var f=l[TY](_);a.push({binding:_,trackEval:f})}}}return new dZ(r,this._duration,s,a)}ae(3924)}else ae(3923)}else ue(3920)}},{key:"_searchForRootBonePath",value:function(){var e=this._tracks.map((function(e){var t=e[MK].parseTrsPath();if(t){var i=t.node;return{path:i,rank:i.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var i=e.length,n=e[t],r=!0,s=t+1;s<i;++s){var a=e[s];if(a.rank!==n.rank)break;if(a.path!==n.path){r=!1;break}}return r?n.path:""}},{key:"_getLegacyData",value:function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData}},{key:"_toLegacy",value:function(){var e=new zQ(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e}},{key:"_fromLegacy",value:function(e){for(var t=e.toTracks(),i=t.length,n=0;n<i;++n)this.addTrack(t[n])}},{key:"_collectAnimatedJoints",value:function(){for(var e=new Set,t=this._tracks,i=t.length,n=0;n<i;++n){var r=t[n][MK].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var s=this._exoticAnimation.collectAnimatedJoints(),a=s.length,o=0;o<a;++o)e.add(s[o]);return Array.from(e)}}],[{key:"createWithSpriteFrames",value:function(e,t){var n=new i;n.sample=t||n.sample,n.duration=e.length/n.sample;var r=1/n.sample,s=new RQ;return s.path=(new OK).toComponent("cc.Sprite").toProperty("spriteFrame"),s.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),n.addTrack(s),n}}]),i}(ed),YJ.WrapMode=SY,FJ=Ms((NJ=KJ).prototype,"sample",[Js],(function(){return 60})),GJ=Ms(NJ.prototype,"speed",[Js],(function(){return 1})),VJ=Ms(NJ.prototype,"wrapMode",[Js],(function(){return SY.Normal})),UJ=Ms(NJ.prototype,"enableTrsBlending",[Js],(function(){return!1})),HJ=Ms(NJ.prototype,"_duration",[Js],(function(){return 0})),zJ=Ms(NJ.prototype,"_hash",[Js],(function(){return 0})),WJ=Ms(NJ.prototype,"_tracks",[Js],(function(){return[]})),XJ=Ms(NJ.prototype,"_exoticAnimation",[Js],(function(){return null})),jJ=Ms(NJ.prototype,"_events",[Js],(function(){return[]})),qJ=Ms(NJ.prototype,"_embeddedPlayers",[Js],(function(){return[]})),LJ=NJ))||LJ);B.AnimationClip=uZ;var hZ=function(){function e(t,i){n(this,e),this._embeddedPlayers=t,this._embeddedPlayerEvaluationInfos=t.map((function(e){var t=e.playable;if(!t)return null;var n=t.instantiate(i);return n?{instantiatedPlayer:n,entered:!1,hostPauseTime:0,lastIterations:0}:null}))}return s(e,[{key:"destroy",value:function(){for(var e=this._embeddedPlayerEvaluationInfos,t=e.length,i=0;i<t;++i){var n;null===(n=e[i])||void 0===n||n.instantiatedPlayer.destroy()}this._embeddedPlayerEvaluationInfos.length=0}},{key:"evaluate",value:function(e,t){for(var i=this._embeddedPlayers,n=this._embeddedPlayerEvaluationInfos,r=i.length,s=0;s<r;++s){var a=n[s];if(a){var o=a.entered,u=a.instantiatedPlayer,h=a.lastIterations,l=i[s],c=l.begin,_=l.end;if(e>=c&&e<=_?o?t!==h&&(u.stop(),u.play(),a.entered=!0):(u.play(),a.entered=!0):o&&(u.stop(),a.entered=!1),a.lastIterations=t,a.entered){var f=e-c;a.instantiatedPlayer.setTime(f)}}}}},{key:"notifyHostSpeedChanged",value:function(e){for(var t=this._embeddedPlayers,i=this._embeddedPlayerEvaluationInfos,n=t.length,r=0;r<n;++r){var s=i[r];if(s){var a=s.instantiatedPlayer;t[r].reconciledSpeed&&a.setSpeed(e)}}}},{key:"notifyHostPlay",value:function(e){for(var t=this._embeddedPlayers,i=this._embeddedPlayerEvaluationInfos,n=t.length,r=0;r<n;++r){var s=i[r];if(s){var a=t[r],o=a.begin,u=a.end,h=s.instantiatedPlayer;if(s.entered){var l=s.hostPauseTime;if(h.randomAccess||Di(l,e,1e-5)){var c=Li(e,o,u);h.play(),h.setTime(c-o)}else h.stop()}}}}},{key:"notifyHostPause",value:function(e){for(var t=this._embeddedPlayers,i=this._embeddedPlayerEvaluationInfos,n=t.length,r=0;r<n;++r){var s=i[r];if(s){var a=s.instantiatedPlayer;s.entered&&(a.pause(),s.hostPauseTime=e)}}}},{key:"notifyHostStop",value:function(){for(var e=this._embeddedPlayers,t=this._embeddedPlayerEvaluationInfos,i=e.length,n=0;n<i;++n){var r=t[n];if(r){var s=r.instantiatedPlayer;r.entered&&(r.entered=!1,s.stop())}}}}]),e}(),lZ=function(){function e(t,i,r){n(this,e),this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=i,this._rootMotionEvaluation=r}return s(e,[{key:"evaluate",value:function(e){for(var t=this._trackEvalStatues,i=this._exoticAnimationEvaluator,n=t.length,r=0;r<n;++r){var s=t[r],a=s.trackEval,o=s.binding,u=a.evaluate(e,o);o.setValue(u)}i&&i.evaluate(e)}},{key:"evaluateRootMotion",value:function(e,t){var i=this._rootMotionEvaluation;i&&i.evaluate(e,t)}}]),e}(),cZ=function(){function e(){n(this,e),this.position=new an,this.scale=new an(1,1,1),this.rotation=new vn,this.eulerAngles=new an}return s(e,[{key:"getTransform",value:function(e){Cn.fromRTS(e,this.rotation,this.position,this.scale)}}]),e}(),_Z=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).parent=null,e._dirty=!0,e._transform=new Cn,e}return s(i,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,Cn.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&Cn.multiply(e,this.parent.globalTransform,e)),this._transform}},{key:"invalidate",value:function(){this._dirty=!0}}]),i}(cZ),fZ=new Cn,dZ=function(){function e(t,i,r,s){n(this,e),this._initialTransformCache=new Cn,this._clipEndTransformCache=new Cn,this._startTransformCache=new Cn,this._endTransformCache=new Cn,this._motionTransformCache=new Cn,this._translationMotionCache=new an,this._rotationMotionCache=new vn,this._scaleMotionCache=new an,this._rootBone=t,this._duration=i,this._boneTransform=r,this._trackEvalStatuses=s}return s(e,[{key:"evaluate",value:function(e,t){var i=this._calcMotionTransform(e,t,this._motionTransformCache),n=this._translationMotionCache,r=this._rotationMotionCache,s=this._scaleMotionCache,a=this._rootBone;Cn.toRTS(i,r,n,s),an.add(n,n,a.position),a.setPosition(n),vn.multiply(r,r,a.rotation),a.setRotation(r),an.multiply(s,s,a.scale),a.setScale(s)}},{key:"_calcMotionTransform",value:function(e,t,i){var n=this._duration,r=n-e,s=this._evaluateAt(e,this._startTransformCache);if(t<r){var a=this._evaluateAt(e+t,this._endTransformCache);mZ(i,s,a)}else{Cn.identity(i);var o=function(e,t){mZ(fZ,e,t),Cn.multiply(i,i,fZ)},u=t-r,h=Math.floor(u/n),l=u-h*n,c=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(n,this._clipEndTransformCache),f=this._evaluateAt(l,this._endTransformCache);o(s,_),mZ(fZ,c,_);for(var d=0;d<h;++d)Cn.multiply(i,i,fZ);o(c,f)}return i}},{key:"_evaluateAt",value:function(e,t){for(var i=this._trackEvalStatuses,n=i.length,r=0;r<n;++r){var s=i[r],a=s.trackEval,o=s.binding,u=a.evaluate(e,o);o.setValue(u)}return this._boneTransform.getTransform(t),t}}]),e}();function mZ(e,t,i){Cn.invert(e,t),Cn.multiply(e,i,e)}function pZ(e,t){switch(t){default:return;case"position":return{setValue:function(t){an.copy(e.position,t)}};case"rotation":return{setValue:function(t){vn.copy(e.rotation,t)}};case"scale":return{setValue:function(t){an.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){an.copy(e.eulerAngles,t)}}}}var vZ=function(){function e(t,i,r,s){n(this,e),this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=i,this._eventGroups=r,this._wrapMode=s}return s(e,[{key:"setWrapMode",value:function(e){this._wrapMode=e}},{key:"ignore",value:function(e,t){this._ignoreIndex=-1,this._sampled=!1;var i=gZ(e,this._ratios);i<0&&(i=~i-1,t<0&&(i+=1),this._ignoreIndex=i)}},{key:"sample",value:function(e,t,i){var n=this._eventGroups.length,r=gZ(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=i,void(this._lastDirection=t);var s=this._wrapMode,a=yZ(i),o=yZ(this._lastIterations),u=this._lastFrameIndex,h=this._lastDirection,l=-1!==o&&a!==o;if(u===r&&l&&1===n)this._doFire(0,!1);else if(u!==r||l){t=h;do{if(u!==r){if(-1===t&&0===u&&r>0?((s&Zu.PingPong)===Zu.PingPong?t*=-1:u=n,o++):1===t&&u===n-1&&r<n-1&&((s&Zu.PingPong)===Zu.PingPong?t*=-1:u=-1,o++),u===r)break;if(o>a)break}u+=t,this._doFire(u,!0)}while(u!==r&&u>-1&&u<n)}this._lastFrameIndex=r,this._lastIterations=i,this._lastDirection=t}},{key:"_doFire",value:function(e,t){t?kY().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)}},{key:"_checkAndFire",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var i=t[e],n=this._targetNode.components,r=i.events.length,s=0;s<r;++s)for(var a=i.events[s],o=a.functionName,u=n.length,h=0;h<u;++h){var l=n[h],c=l[o];"function"==typeof c&&c.apply(l,a.parameters)}}}}]),e}();function yZ(e){return e-(0|e)==0&&(e-=1),0|e}function gZ(e,t){return xs(t,e)}var SZ,AZ=function(){function e(){n(this,e),this._nodeBlendStates=new Map}return s(e,[{key:"createWriter",value:function(e,t,i,n){var r=this.ref(e,t);return new TZ(e,t,r,i,n)}},{key:"destroyWriter",value:function(e){var t=e;this.deRef(t.node,t.property)}},{key:"ref",value:function(e,t){var i=this._nodeBlendStates.get(e);return i||(i=this.createNodeBlendState(),this._nodeBlendStates.set(e,i)),i.refProperty(e,t)}},{key:"deRef",value:function(e,t){var i=this._nodeBlendStates.get(e);i&&(i.deRefProperty(t),i.empty&&this._nodeBlendStates.delete(e))}},{key:"apply",value:function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))}}]),e}(),TZ=function(){function e(t,i,r,s,a){n(this,e),this._node=t,this._property=i,this._propertyBlendState=r,this._host=s,this._constants=a}return s(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}},{key:"getValue",value:function(){return this._node[this._property]}},{key:"setValue",value:function(e){var t=this._propertyBlendState,i=this._host.weight;t.blend(e,i)}}]),e}();!function(e){e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.EULER_ANGLES=8]="EULER_ANGLES"}(SZ||(SZ={}));var EZ=SZ.POSITION|SZ.ROTATION|SZ.SCALE|SZ.EULER_ANGLES,bZ=function(){function e(){n(this,e),this.refCount=0,this.accumulatedWeight=0,this.result=new an}return s(e,[{key:"blend",value:function(e,t){this.accumulatedWeight=PZ(this.result,this.result,this.accumulatedWeight,e,t)}},{key:"reset",value:function(){this.accumulatedWeight=0,an.zero(this.result)}}]),e}(),CZ=function(){function e(){n(this,e),this.refCount=0,this.accumulatedWeight=0,this.result=new vn}return s(e,[{key:"blend",value:function(e,t){this.accumulatedWeight=MZ(this.result,this.result,this.accumulatedWeight,e,t)}},{key:"reset",value:function(){this.accumulatedWeight=0,vn.identity(this.result)}}]),e}(),RZ=function(){function e(){n(this,e),this._transformApplyFlags=0,this._properties={}}return s(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}},{key:"refProperty",value:function(e,t){var i,n,r,s=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":r=null!==(i=s[t])&&void 0!==i?i:s[t]=this._createVec3BlendState(e[t]);break;case"rotation":r=null!==(n=s[t])&&void 0!==n?n:s[t]=this._createQuatBlendState(e.rotation)}return++r.refCount,r}},{key:"deRefProperty",value:function(e){var t=this._properties,i=t[e];i&&(--i.refCount,i.refCount>0||delete t[e])}},{key:"apply",value:function(e){var t,i,n,r=this._transformApplyFlags,s=this._properties,a=s.position,o=s.scale,u=s.rotation,h=s.eulerAngles;r&&(a&&r&SZ.POSITION&&(t=a.result),o&&r&SZ.SCALE&&(i=o.result),h&&r&SZ.EULER_ANGLES&&(n=h.result),u&&r&SZ.ROTATION&&(n=u.result),(n||t||i)&&e.setRTS(n,t,i),this._transformApplyFlags=0)}}]),e}(),xZ=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"apply",value:function(e){var t=this._properties,n=t.position,r=t.scale,s=t.rotation,a=t.eulerAngles;n&&n.accumulatedWeight&&(this._transformApplyFlags|=SZ.POSITION,n.accumulatedWeight<1&&n.blend(e.position,1-n.accumulatedWeight)),r&&r.accumulatedWeight&&(this._transformApplyFlags|=SZ.SCALE,r.accumulatedWeight<1&&r.blend(e.scale,1-r.accumulatedWeight)),a&&a.accumulatedWeight&&(this._transformApplyFlags|=SZ.EULER_ANGLES,a.accumulatedWeight<1&&a.blend(e.eulerAngles,1-a.accumulatedWeight)),s&&s.accumulatedWeight&&(this._transformApplyFlags|=SZ.ROTATION,s.accumulatedWeight<1&&s.blend(e.rotation,1-s.accumulatedWeight)),g(l(i.prototype),"apply",this).call(this,e),null==n||n.reset(),null==r||r.reset(),null==s||s.reset(),null==a||a.reset()}},{key:"_createVec3BlendState",value:function(){return new bZ}},{key:"_createQuatBlendState",value:function(){return new CZ}}]),i}(RZ),wZ=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"createNodeBlendState",value:function(){return new xZ}}]),i}(AZ),kZ=function(){function e(t){n(this,e),this.refCount=0,this.result=new an,this._defaultValue=new an,this._clipBlendResult=new an,this._accumulatedWeight=0,an.copy(this._defaultValue,t),an.copy(this.result,t)}return s(e,[{key:"blend",value:function(e,t){this._accumulatedWeight=PZ(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)}},{key:"commitLayerChange",value:function(e){var t=this.result,i=this._clipBlendResult,n=this._accumulatedWeight;n<1&&this.blend(this._defaultValue,1-n),an.lerp(t,t,i,e),an.zero(this._clipBlendResult),this._accumulatedWeight=0}},{key:"reset",value:function(){an.copy(this.result,this._defaultValue)}}]),e}(),IZ=function(){function e(t){n(this,e),this.refCount=0,this.result=new vn,this._defaultValue=new vn,this._clipBlendResult=new vn,this._accumulatedWeight=0,vn.copy(this._defaultValue,t),vn.copy(this.result,t)}return s(e,[{key:"blend",value:function(e,t){this._accumulatedWeight=MZ(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)}},{key:"commitLayerChange",value:function(e){var t=this.result,i=this._clipBlendResult,n=this._accumulatedWeight;n<1&&this.blend(this._defaultValue,1-n),vn.slerp(t,t,i,e),vn.identity(this._clipBlendResult),this._accumulatedWeight=0}},{key:"reset",value:function(){vn.copy(this.result,this._defaultValue)}}]),e}(),BZ=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._layerMask=-1>>>0,e}return s(i,[{key:"setLayerMask",value:function(e){this._layerMask&=~(1<<e)}},{key:"commitLayerChanges",value:function(e,t){if(this._layerMask&1<<e){var i=this._properties,n=i.position,r=i.scale,s=i.rotation,a=i.eulerAngles;n&&n.commitLayerChange(t),r&&r.commitLayerChange(t),s&&s.commitLayerChange(t),a&&a.commitLayerChange(t)}}},{key:"apply",value:function(e){this._transformApplyFlags=EZ,g(l(i.prototype),"apply",this).call(this,e);var t=this._properties,n=t.position,r=t.scale,s=t.rotation,a=t.eulerAngles;null==n||n.reset(),null==r||r.reset(),null==s||s.reset(),null==a||a.reset()}},{key:"_createVec3BlendState",value:function(e){return new kZ(e)}},{key:"_createQuatBlendState",value:function(e){return new IZ(e)}}]),i}(RZ);function PZ(e,t,i,n,r){var s=i+r;if(1!==r||i){if(s){var a=r/s;an.lerp(e,e,n,a)}}else an.copy(e,n);return s}function MZ(e,t,i,n,r){var s=i+r;if(1!==r||i){if(s){var a=r/s;vn.slerp(e,t,n,a)}}else vn.copy(e,n);return s}!function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}s(i,[{key:"setMask",value:function(e,t){this._nodeBlendStates.forEach((function(i,n){t.has(n)&&i.setLayerMask(e)}))}},{key:"commitLayerChanges",value:function(e,t){this._nodeBlendStates.forEach((function(i){i.commitLayerChanges(e,t)}))}},{key:"createNodeBlendState",value:function(){return new BZ}}])}(AZ);var OZ,DZ,LZ,NZ=[],FZ=new Map;function GZ(e,t){for(var i=0,n=Cn.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){n=e.world,e.stamp=t;break}e.stamp=t,NZ[i++]=e,e=e.parent}for(;i>0;){e=NZ[--i],NZ[i]=null;var r=e.node;Cn.fromRTS(e.local,r.rotation,r.position,r.scale),n=Cn.multiply(e.world,n,e.local)}return n}function VZ(e){for(var t=FZ.get(e.uuid)||null;t;)FZ.delete(t.node.uuid),t=t.parent}var UZ=e("AnimationManager",Hs((LZ=DZ=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._anims=new vt([]),e._crossFades=new vt([]),e._delayEvents=[],e._blendStateBuffer=new wZ,e._sockets=[],e}return s(i,[{key:"blendState",get:function(){return this._blendStateBuffer}},{key:"addCrossFade",value:function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):ue(3907)}},{key:"update",value:function(e){var t=this._delayEvents,i=this._crossFades,n=this._sockets,r=i.array;for(i.i=0;i.i<r.length;++i.i)r[i.i].update(e);var s=this._anims,a=s.array;for(s.i=0;s.i<a.length;++s.i){var o=a[s.i];o.isMotionless||o.update(e)}this._blendStateBuffer.apply();for(var u=DN.getTotalFrames(),h=0,l=n.length;h<l;h++){var c=n[h],_=c.target,f=c.transform;_.matrix=GZ(f,u)}for(var d=0,m=t.length;d<m;d++){var p=t[d];p.fn.apply(p.thisArg,p.args)}t.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):ue(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({fn:e,thisArg:t,args:i})}},{key:"addSockets",value:function(e,t){for(var i=this,n=function(n){var r=t[n];if(i._sockets.find((function(e){return e.target===r.target})))return"continue";var s=e.getChildByPath(r.path),a=r.target&&s&&function(e,t){for(var i,n=null,r=0;e!==t;){var s=e.uuid;if(FZ.has(s)){n=FZ.get(s);break}n={node:e,local:new Cn,world:new Cn,stamp:-1,parent:null},FZ.set(s,n),NZ[r++]=n,e=e.parent,n=null}for(;r>0;)i=NZ[--r],NZ[r]=null,i.parent=n,n=i;return n}(s,e);a&&i._sockets.push({target:r.target,transform:a})},r=0;r<t.length;++r)n(r)}},{key:"removeSockets",value:function(e,t){for(var i=0;i<t.length;++i)for(var n=t[i],r=0;r<this._sockets.length;++r){var s=this._sockets[r];if(s.target===n.target){VZ(s.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}]),i}(Rh),DZ.ID="animation",OZ=LZ))||OZ);DN.on(PN.EVENT_INIT,(function(){var e=new UZ;DN.registerSystem(UZ.ID,e,Rh.Priority.HIGH)})),B.AnimationManager=UZ;var HZ,zZ,WZ,XZ,jZ,qZ,YZ,KZ,QZ,JZ,ZZ,$Z,e$=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this))._managedStates=[],r._fadings=[],r._scheduled=!1,r._scheduler=null!=e?e:kY(),r}return s(i,[{key:"update",value:function(e){if(!this.isMotionless){var t=this._managedStates,i=this._fadings;if(1===t.length&&1===i.length){var n=t[0].state;n&&(n.weight=1)}else this._calculateWeights(e);1===t.length&&1===i.length&&this._unscheduleThis()}}},{key:"crossFade",value:function(e,t){var i;0===this._managedStates.length&&(t=0),0===t&&this.clear();var n=this._managedStates.find((function(t){return t.state===e}));n?null!==(i=n.state)&&void 0!==i&&i.isMotionless&&n.state.play():(n={state:e,reference:0},e&&e.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:n}),this.isMotionless||this._scheduleThis()}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}},{key:"onPlay",value:function(){g(l(i.prototype),"onPlay",this).call(this),this._scheduleThis()}},{key:"onPause",value:function(){g(l(i.prototype),"onPause",this).call(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.pause()}this._unscheduleThis()}},{key:"onResume",value:function(){g(l(i.prototype),"onResume",this).call(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.resume()}this._scheduleThis()}},{key:"onStop",value:function(){g(l(i.prototype),"onStop",this).call(this),this.clear()}},{key:"_calculateWeights",value:function(e){for(var t=this._managedStates,i=this._fadings,n=0;n<t.length;++n){var r=t[n].state;r&&(r.weight=0)}for(var s=1,a=i.length,o=0;o<i.length;++o){var u=i[o];u.easeTime+=e;var h=0===u.easeDuration?1:Ni(u.easeTime/u.easeDuration),l=h*s;if(s*=1-h,u.target.state&&(u.target.state.weight+=l),u.easeTime>=u.easeDuration){a=o+1,u.easeTime=u.easeDuration;break}}if(a!==i.length){for(var c=a;c<i.length;++c){var _=i[c];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),St(this._managedStates,_.target))}i.splice(a)}}},{key:"_scheduleThis",value:function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)}},{key:"_unscheduleThis",value:function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)}}]),i}(CY),t$=function(t){return e({Animation:t,AnimationComponent:t}),t}((HZ=Hs("cc.Animation"),zZ=Ws(99),WZ=Aa([uZ]),XZ=Aa(uZ),jZ=Aa([uZ]),HZ(qZ=zZ(($Z=ZZ=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).playOnLoad=KZ&&KZ(),e._crossFade=new e$,e._nameToState=Ue(!0),e._clips=QZ&&QZ(),e._defaultClip=JZ&&JZ(),e._hasBeenPlayed=!1,e}return s(i,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var i,n=R(this._clips);!(i=n()).done;){var r=i.value;r&&this._removeStateOfAutomaticClip(r)}for(var s,a=R(e);!(s=a()).done;){var o=s.value;o&&this.createState(o)}var u=e.find((function(e){return i$(e,t._defaultClip)}));this._defaultClip=u||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return i$(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}},{key:"onLoad",value:function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)}},{key:"start",value:function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=Ue(!0)}},{key:"play",value:function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3;this._hasBeenPlayed=!0;var i=this._nameToState[e];i&&this.doPlayOrCrossFade(i,t)}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return Tt(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(e,t){var i;for(var n in this._nameToState){var r=this._nameToState[n];if(r.clip===e){i=r;break}}if(e===this._defaultClip){if(!t)return void ae(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!t)return void ae(3903);i.stop()}this._clips=this._clips.filter((function(t){return t!==e})),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,t,n,r){var s=g(l(i.prototype),"on",this).call(this,e,t,n,r);return e===RY.LASTFRAME&&this._syncAllowLastFrameEvent(),s}},{key:"once",value:function(e,t,n){var r=g(l(i.prototype),"once",this).call(this,e,t,n);return e===RY.LASTFRAME&&this._syncAllowLastFrameEvent(),r}},{key:"off",value:function(e,t,n){g(l(i.prototype),"off",this).call(this,e,t,n),e===RY.LASTFRAME&&this._syncDisallowLastFrameEvent()}},{key:"_createState",value:function(e,t){return new MY(e,t)}},{key:"_doCreateState",value:function(e,t){var i=this._createState(e,t);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener(RY.LASTFRAME)),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}},{key:"doPlayOrCrossFade",value:function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];i$(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"_syncAllowLastFrameEvent",value:function(){if(this.hasEventListener(RY.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)}},{key:"_syncDisallowLastFrameEvent",value:function(){if(!this.hasEventListener(RY.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)}}]),i}(Uh(tm)),ZZ.EventType=RY,x((YZ=$Z).prototype,"clips",[WZ],Object.getOwnPropertyDescriptor(YZ.prototype,"clips"),YZ.prototype),x(YZ.prototype,"defaultClip",[XZ],Object.getOwnPropertyDescriptor(YZ.prototype,"defaultClip"),YZ.prototype),KZ=Ms(YZ.prototype,"playOnLoad",[Js],(function(){return!1})),QZ=Ms(YZ.prototype,"_clips",[jZ],(function(){return[]})),JZ=Ms(YZ.prototype,"_defaultClip",[Js],(function(){return null})),qZ=YZ))||qZ)||qZ));function i$(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}B.Animation=t$,B.AnimationComponent=t$,ht(t$,"cc.AnimationComponent");var n$,r$,s$,a$=new Cn;!function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(n$||(n$={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(r$||(r$={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(s$||(s$={}));var o$,u$=e("AudioPCMDataView",function(){function e(){if(n(this,e),this._bufferView=void 0,this._normalizeFactor=1,2===arguments.length)this._bufferView=arguments.length<=0?void 0:arguments[0],this._normalizeFactor=arguments.length<=1?void 0:arguments[1];else{var t=arguments.length<=0?void 0:arguments[0],i=arguments.length<=1?void 0:arguments[1],r=arguments.length<=2?void 0:arguments[2];this._bufferView=new i(t),this._normalizeFactor=r}}return s(e,[{key:"length",get:function(){return this._bufferView.length}},{key:"getData",value:function(e){return this._bufferView[e]*this._normalizeFactor}}]),e}()),h$=0;function l$(e,t){var i;t.invoking||(t.invoking=!0,(i=t.func).call.apply(i,[e].concat(E(t.args))).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var i=e._operationQueue[0];i&&l$(e,i)})).catch((function(){})))}function c$(e,t,i){var n=i.value;i.value=function(){for(var e=this,t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return new Promise((function(t){var r=h$++,s=e;s._operationQueue.push({id:r,func:n,args:i,invoking:!1}),s._eventTarget.once(r.toString(),t),l$(s,s._operationQueue[0])}))}}function _$(e){return new Promise((function(t){var i=e.play();return void 0===i?t():(i.then(t).catch((function(){var i=function i(){e.play().then((function(){null==n||n.removeEventListener("touchend",i,{capture:!0}),null==n||n.removeEventListener("mouseup",i,{capture:!0})})).catch((function(){})),t()},n=document.getElementById("GameCanvas");null==n||n.addEventListener("touchend",i,{capture:!0}),null==n||n.addEventListener("mouseup",i,{capture:!0})})),null)}))}var f$,d$,m$=function(){function e(t,i){n(this,e),this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=t,t.volume=i}return s(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}},{key:"play",value:function(){var e=this;_$(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))}},{key:"stop",value:function(){this._domAudio.pause()}}]),e}(),p$=(x((o$=function(){function e(t){var i=this;n(this,e),this._domAudio=void 0,this._state=s$.INIT,this._onEnded=void 0,this._eventTarget=new Hh,this._operationQueue=[],this._domAudio=t,UN.on(VN.EVENT_PAUSE,this._onInterruptedBegin,this),UN.on(VN.EVENT_RESUME,this._onInterruptedEnd,this),this._onEnded=function(){i.seek(0).catch((function(){})),i._state=s$.INIT,i._eventTarget.emit(n$.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}return s(e,[{key:"destroy",value:function(){UN.off(VN.EVENT_PAUSE,this._onInterruptedBegin,this),UN.off(VN.EVENT_RESUME,this._onInterruptedEnd,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null}},{key:"_onInterruptedBegin",value:function(){var e=this;this._state===s$.PLAYING&&this.pause().then((function(){e._state=s$.INTERRUPTED,e._eventTarget.emit(n$.INTERRUPTION_BEGIN)})).catch((function(){}))}},{key:"_onInterruptedEnd",value:function(){var e=this;this._state===s$.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(n$.INTERRUPTION_END)})).catch((function(){}))}},{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return r$.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=Ni(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}},{key:"sampleRate",get:function(){return 0}},{key:"getPCMData",value:function(){}},{key:"seek",value:function(e){return e=Li(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()}},{key:"play",value:function(){var e=this;return new Promise((function(t){_$(e._domAudio).then((function(){e._state=s$.PLAYING,t()})).catch((function(){}))}))}},{key:"pause",value:function(){return this._domAudio.pause(),this._state=s$.PAUSED,Promise.resolve()}},{key:"stop",value:function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=s$.STOPPED,t()}))}},{key:"onInterruptionBegin",value:function(e){this._eventTarget.on(n$.INTERRUPTION_BEGIN,e)}},{key:"offInterruptionBegin",value:function(e){this._eventTarget.off(n$.INTERRUPTION_BEGIN,e)}},{key:"onInterruptionEnd",value:function(e){this._eventTarget.on(n$.INTERRUPTION_END,e)}},{key:"offInterruptionEnd",value:function(e){this._eventTarget.off(n$.INTERRUPTION_END,e)}},{key:"onEnded",value:function(e){this._eventTarget.on(n$.ENDED,e)}},{key:"offEnded",value:function(e){this._eventTarget.off(n$.ENDED,e)}}],[{key:"load",value:function(t){return new Promise((function(i){e.loadNative(t).then((function(t){i(new e(t))})).catch((function(){}))}))}},{key:"loadNative",value:function(e){return new Promise((function(t,i){var n=document.createElement("audio"),r="canplaythrough";Qh.os===jh.IOS?r="loadedmetadata":Qh.browserType===zh.FIREFOX&&(r="canplay");var s=setTimeout((function(){0===n.readyState?u():o()}),8e3),a=function(){clearTimeout(s),n.removeEventListener(r,o,!1),n.removeEventListener("error",u,!1)},o=function(){a(),t(n)},u=function(){a();var t="load audio failure - ".concat(e);i(t)};n.addEventListener(r,o,!1),n.addEventListener("error",u,!1),n.src=e}))}},{key:"loadOneShotAudio",value:function(t,i){return new Promise((function(n,r){e.loadNative(t).then((function(e){var t=new m$(e,i);n(t)})).catch(r)}))}}]),e}()).prototype,"seek",[c$],Object.getOwnPropertyDescriptor(o$.prototype,"seek"),o$.prototype),x(o$.prototype,"play",[c$],Object.getOwnPropertyDescriptor(o$.prototype,"play"),o$.prototype),x(o$.prototype,"pause",[c$],Object.getOwnPropertyDescriptor(o$.prototype,"pause"),o$.prototype),x(o$.prototype,"stop",[c$],Object.getOwnPropertyDescriptor(o$.prototype,"stop"),o$.prototype),o$),v$=function(){function e(t){n(this,e),this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=t}return s(e,[{key:"destroy",value:function(){this._nativeAudio=void 0}},{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}},{key:"_now",value:function(){return performance.now()/1e3}},{key:"_calculateCurrentTime",value:function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration}},{key:"start",value:function(){this._isPaused=!1,this._startTime=this._now()}},{key:"pause",value:function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())}},{key:"stop",value:function(){this._isPaused=!0,this._startOffset=0}},{key:"seek",value:function(e){this._startTime=this._now(),this._startOffset=Li(e,0,this.duration)}}]),e}(),y$=new(function(){function e(){n(this,e),this._audioBufferDataMap={}}return s(e,[{key:"addCache",value:function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer ".concat(e," has been cached")):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}}},{key:"retainCache",value:function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache ".concat(e," has not been added."))}},{key:"getCache",value:function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer}},{key:"tryReleasingCache",value:function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache ".concat(e," has not been added."))}}]),e}()),g$=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,S$="on-context-running",A$=function(){function e(){var t=this;n(this,e),this._eventTarget=void 0,this._context=void 0,this._isRunning=!1,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),this._eventTarget=new Hh,this._context.onstatechange=function(){"running"===t._context.state?(t._isRunning=!0,t._eventTarget.emit(S$)):t._isRunning=!1}}return s(e,[{key:"isRunning",get:function(){return this._isRunning}},{key:"currentTime",get:function(){return this._context.currentTime}},{key:"onceRunning",value:function(e,t){this._eventTarget.once(S$,e,t)}},{key:"offRunning",value:function(e,t){this._eventTarget.off(S$,e,t)}},{key:"decodeAudioData",value:function(e){var t=this;return new Promise((function(i){var n=t._context.decodeAudioData(e,(function(e){i(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==n||n.catch((function(){}))}))}},{key:"runContext",value:function(){var e=this;return new Promise((function(t){if(e.isRunning)t();else{var i=e._context;if(i.resume)if(i.resume().catch((function(){})),"running"!==i.state){var n=document.getElementById("GameCanvas"),r=function e(){i.resume().then((function(){null==n||n.removeEventListener("touchend",e,{capture:!0}),null==n||n.removeEventListener("mouseup",e,{capture:!0}),t()})).catch((function(){}))};null==n||n.addEventListener("touchend",r,{capture:!0}),null==n||n.addEventListener("mouseup",r,{capture:!0})}else t();else t()}}))}},{key:"createBufferSource",value:function(e,t){var i=this._context.createBufferSource();return void 0!==e&&(i.buffer=e),void 0!==t&&(i.loop=t),i}},{key:"createGain",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=this._context.createGain();return this.setGainValue(t,e),t}},{key:"setGainValue",value:function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(i){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t}},{key:"connectContext",value:function(e){this._context&&e.connect(this._context.destination)}}]),e}();A$.support=!!g$,A$.support&&(d$=new A$);var T$,E$,b$,C$,R$,x$=function(){function e(t,i,r){n(this,e),this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=t.duration,this._url=r,this._bufferSourceNode=d$.createBufferSource(t,!1);var s=d$.createGain(i);this._bufferSourceNode.connect(s),d$.connectContext(s)}return s(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}},{key:"play",value:function(){var e=this;this._bufferSourceNode.start(),d$.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;y$.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))}},{key:"stop",value:function(){clearTimeout(this._currentTimer),y$.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null}}]),e}(),w$=(x((f$=function(){function e(t,i){n(this,e),this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=s$.INIT,this._audioTimer=void 0,this._runningCallback=void 0,this._eventTarget=new Hh,this._operationQueue=[],this._audioBuffer=t,this._audioTimer=new v$(t),this._gainNode=d$.createGain(),d$.connectContext(this._gainNode),this._src=i,UN.on(VN.EVENT_PAUSE,this._onInterruptedBegin,this),UN.on(VN.EVENT_RESUME,this._onInterruptedEnd,this)}return s(e,[{key:"destroy",value:function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),y$.tryReleasingCache(this._src),UN.off(VN.EVENT_PAUSE,this._onInterruptedBegin,this),UN.off(VN.EVENT_RESUME,this._onInterruptedEnd,this)}},{key:"sampleRate",get:function(){return this._audioBuffer.sampleRate}},{key:"getPCMData",value:function(e){return new u$(this._audioBuffer.getChannelData(e),1)}},{key:"_onInterruptedBegin",value:function(){var e=this;this._state===s$.PLAYING&&this.pause().then((function(){e._state=s$.INTERRUPTED,e._eventTarget.emit(n$.INTERRUPTION_BEGIN)})).catch((function(){}))}},{key:"_onInterruptedEnd",value:function(){var e=this;this._state===s$.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(n$.INTERRUPTION_END)})).catch((function(){}))}},{key:"src",get:function(){return this._src}},{key:"type",get:function(){return r$.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=Ni(e),this._volume=e,d$.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}},{key:"offRunning",value:function(){this._runningCallback&&(d$.offRunning(this._runningCallback),this._runningCallback=void 0)}},{key:"seek",value:function(e){var t=this;return new Promise((function(i){t.offRunning(),t._audioTimer.seek(e),t._state===s$.PLAYING?t._doPlay().then(i).catch((function(){})):i()}))}},{key:"play",value:function(){return this.offRunning(),this._doPlay()}},{key:"_doPlay",value:function(){var e=this;return new Promise((function(t){d$.isRunning?(e._startSourceNode(),t()):(e.offRunning(),e._runningCallback=function(){e._startSourceNode(),t()},d$.onceRunning(e._runningCallback),d$.runContext().catch((function(){})))}))}},{key:"_startSourceNode",value:function(){var e=this;this._stopSourceNode(),this._sourceNode=d$.createBufferSource(this._audioBuffer,this.loop),this._sourceNode.connect(this._gainNode),this._sourceNode.start(0,this._audioTimer.currentTime),this._state=s$.PLAYING,this._audioTimer.start(),window.clearTimeout(this._currentTimer),this._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(n$.ENDED),e._state=s$.INIT)}),1e3*(this._audioBuffer.duration-this._audioTimer.currentTime))}},{key:"_stopSourceNode",value:function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(e){}}},{key:"pause",value:function(){return this.offRunning(),this._state===s$.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=s$.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()}},{key:"stop",value:function(){return this.offRunning(),this._sourceNode?(this._audioTimer.stop(),this._state=s$.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()}},{key:"onInterruptionBegin",value:function(e){this._eventTarget.on(n$.INTERRUPTION_BEGIN,e)}},{key:"offInterruptionBegin",value:function(e){this._eventTarget.off(n$.INTERRUPTION_BEGIN,e)}},{key:"onInterruptionEnd",value:function(e){this._eventTarget.on(n$.INTERRUPTION_END,e)}},{key:"offInterruptionEnd",value:function(e){this._eventTarget.off(n$.INTERRUPTION_END,e)}},{key:"onEnded",value:function(e){this._eventTarget.on(n$.ENDED,e)}},{key:"offEnded",value:function(e){this._eventTarget.off(n$.ENDED,e)}}],[{key:"load",value:function(t){return new Promise((function(i){e.loadNative(t).then((function(n){i(new e(n,t))})).catch((function(){}))}))}},{key:"loadNative",value:function(e){return new Promise((function(t,i){var n=y$.getCache(e);if(n)return y$.retainCache(e),void t(n);var r=new XMLHttpRequest,s="load audio failed: ".concat(e,", status: ");r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?d$.decodeAudioData(r.response).then((function(i){y$.addCache(e,i),t(i)})).catch((function(){})):i(new Error("".concat(s).concat(r.status,"(no response)")))},r.onerror=function(){i(new Error("".concat(s).concat(r.status,"(error)")))},r.ontimeout=function(){i(new Error("".concat(s).concat(r.status,"(time out)")))},r.onabort=function(){i(new Error("".concat(s).concat(r.status,"(abort)")))},r.send(null)}))}},{key:"loadOneShotAudio",value:function(t,i){return new Promise((function(n,r){e.loadNative(t).then((function(e){var r=new x$(e,i,t);n(r)})).catch(r)}))}}]),e}()).prototype,"seek",[c$],Object.getOwnPropertyDescriptor(f$.prototype,"seek"),f$.prototype),x(f$.prototype,"play",[c$],Object.getOwnPropertyDescriptor(f$.prototype,"play"),f$.prototype),x(f$.prototype,"pause",[c$],Object.getOwnPropertyDescriptor(f$.prototype,"pause"),f$.prototype),x(f$.prototype,"stop",[c$],Object.getOwnPropertyDescriptor(f$.prototype,"stop"),f$.prototype),f$),k$=function(){function e(t){n(this,e),this._audio=void 0,this._audio=t}return s(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}},{key:"play",value:function(){this._audio.play()}},{key:"stop",value:function(){this._audio.stop()}}]),e}(),I$=function(){function e(t){n(this,e),this._player=void 0,this._player=t}return s(e,[{key:"destroy",value:function(){this._player.destroy()}},{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}},{key:"sampleRate",get:function(){return this._player.sampleRate}},{key:"getPCMData",value:function(e){return this._player.getPCMData(e)}},{key:"seek",value:function(e){return this._player.seek(e)}},{key:"play",value:function(){return this._player.play()}},{key:"pause",value:function(){return this._player.pause()}},{key:"stop",value:function(){return this._player.stop()}},{key:"onInterruptionBegin",value:function(e){this._player.onInterruptionBegin(e)}},{key:"offInterruptionBegin",value:function(e){this._player.offInterruptionBegin(e)}},{key:"onInterruptionEnd",value:function(e){this._player.onInterruptionEnd(e)}},{key:"offInterruptionEnd",value:function(e){this._player.offInterruptionEnd(e)}},{key:"onEnded",value:function(e){this._player.onEnded(e)}},{key:"offEnded",value:function(e){this._player.offEnded(e)}}],[{key:"load",value:function(t,i){return new Promise((function(n){(null==i?void 0:i.audioLoadMode)!==r$.DOM_AUDIO&&A$.support?w$.load(t).then((function(t){n(new e(t))})).catch((function(){})):(A$.support||ae(5201),p$.load(t).then((function(t){n(new e(t))})).catch((function(){})))}))}},{key:"loadNative",value:function(e,t){return(null==t?void 0:t.audioLoadMode)!==r$.DOM_AUDIO&&A$.support?w$.loadNative(e):(A$.support||ae(5201),p$.loadNative(e))}},{key:"loadOneShotAudio",value:function(e,t,i){return new Promise((function(n,r){(null==i?void 0:i.audioLoadMode)!==r$.DOM_AUDIO&&A$.support?w$.loadOneShotAudio(e,t).then((function(e){n(new k$(e))})).catch(r):(A$.support||ae(5201),p$.loadOneShotAudio(e,t).then((function(e){n(new k$(e))})).catch(r))}))}}]),e}();I$.maxAudioChannel=24;var B$=e("AudioClip",Hs("cc.AudioClip")((R$=C$=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._duration=b$&&b$(),e._loadMode=r$.UNKNOWN_AUDIO,e._meta=null,e._player=null,e}return s(i,[{key:"destroy",value:function(){var e,t=g(l(i.prototype),"destroy",this).call(this);return null===(e=this._player)||void 0===e||e.destroy(),this._player=null,this._meta&&(this._meta.player=null),t}},{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=r$.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"validate",value:function(){return!!this._meta}},{key:"getDuration",value:function(){return this._duration?this._duration:this._meta?this._meta.duration:0}},{key:"state",get:function(){return this._player?this._player.state:s$.INIT}},{key:"getCurrentTime",value:function(){return this._player?this._player.currentTime:0}},{key:"getVolume",value:function(){return this._player?this._player.volume:0}},{key:"getLoop",value:function(){return!!this._player&&this._player.loop}},{key:"setCurrentTime",value:function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))}},{key:"setVolume",value:function(e){this._player&&(this._player.volume=e)}},{key:"setLoop",value:function(e){this._player&&(this._player.loop=e)}},{key:"play",value:function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))}},{key:"pause",value:function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))}},{key:"stop",value:function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))}},{key:"playOneShot",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._nativeAsset&&I$.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))}}]),i}(ed),C$.AudioType=r$,b$=Ms((E$=R$).prototype,"_duration",[Js],(function(){return 0})),x(E$.prototype,"_nativeDep",[Ta],Object.getOwnPropertyDescriptor(E$.prototype,"_nativeDep"),E$.prototype),T$=E$))||T$);function P$(e,t,i){I$.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var n={player:t,url:e,duration:t.duration,type:t.type};i(null,n)})).catch((function(e){i(e)}))}function M$(e,t,i,n){var r=new B$;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,n(null,r)}B.AudioClip=B$,hS.register({".mp3":P$,".ogg":P$,".wav":P$,".m4a":P$}),AS.register({".mp3":M$,".ogg":M$,".wav":M$,".m4a":M$});var O$,D$,L$,N$,F$,G$,V$,U$,H$,z$,W$,X$,j$=new(function(){function e(){n(this,e),this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}return s(e,[{key:"_findIndex",value:function(e,t){return e.findIndex((function(e){return e.audio===t}))}},{key:"_tryAddPlaying",value:function(e,t){var i=this._findIndex(e,t);return i>-1?(e[i].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)}},{key:"addPlaying",value:function(e){e instanceof I$?this._tryAddPlaying(this._audioPlayerInfoList,e):this._tryAddPlaying(this._oneShotAudioInfoList,e)}},{key:"_tryRemovePlaying",value:function(e,t){var i=this._findIndex(e,t);return-1!==i&&(gt(e,i),!0)}},{key:"removePlaying",value:function(e){e instanceof I$?this._tryRemovePlaying(this._audioPlayerInfoList,e):this._tryRemovePlaying(this._oneShotAudioInfoList,e)}},{key:"discardOnePlayingIfNeeded",value:function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<I$.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))}},{key:"pause",value:function(){this._oneShotAudioInfoList.forEach((function(e){e.audio.stop()})),this._audioPlayerInfoList.forEach((function(e){e.audio.pause().catch((function(){}))}))}},{key:"resume",value:function(){this._audioPlayerInfoList.forEach((function(e){e.audio.play().catch((function(){}))}))}}]),e}()),q$="audiosource-loaded";!function(e){e.STARTED="started",e.ENDED="ended"}(X$||(X$={}));var Y$=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((O$=Hs("cc.AudioSource"),D$=Aa(B$),L$=Aa(B$),O$((W$=z$=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._clip=G$&&G$(),e._player=null,e._loop=V$&&V$(),e._playOnAwake=U$&&U$(),e._volume=H$&&H$(),e._cachedCurrentTime=0,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}return s(i,[{key:"_resetPlayer",value:function(){this._player&&(j$.removePlaying(this._player),this._player.offEnded(),this._player.offInterruptionBegin(),this._player.offInterruptionEnd(),this._player.destroy(),this._player=null)}},{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"_syncPlayer",value:function(){var e=this,t=this._clip;if(this._lastSetClip!==t)return t?void(t._nativeAsset?(this._isLoaded=!1,this._lastSetClip=t,this._operationsBeforeLoading.length=0,I$.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(i){var n;e._lastSetClip===t?(e._isLoaded=!0,e._resetPlayer(),e._player=i,i.onEnded((function(){var t;j$.removePlaying(i),null===(t=e.node)||void 0===t||t.emit(X$.ENDED,e)})),i.onInterruptionBegin((function(){j$.removePlaying(i)})),i.onInterruptionEnd((function(){j$.addPlaying(i)})),e._syncStates(),null===(n=e.node)||void 0===n||n.emit(q$)):i.destroy()})).catch((function(){}))):console.error("Invalid audio clip")):(this._lastSetClip=null,void this._resetPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=Li(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"onLoad",value:function(){this._syncPlayer()}},{key:"onEnable",value:function(){this._playOnAwake&&!this.playing&&this.play()}},{key:"onDisable",value:function(){var e=this._getRootNode();null!=e&&e._persistNode||this.pause()}},{key:"onDestroy",value:function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy(),this._player=null}},{key:"getPCMData",value:function(e){var t=this;return new Promise((function(i){if(0!==e&&1!==e)return console.warn("Only support channel index 0 or 1 to get buffer"),void i(void 0);var n;t._player?i(t._player.getPCMData(e)):null===(n=t.node)||void 0===n||n.once(q$,(function(){var n;i(null===(n=t._player)||void 0===n?void 0:n.getPCMData(e))}))}))}},{key:"getSampleRate",value:function(){var e=this;return new Promise((function(t){var i;e._player?t(e._player.sampleRate):null===(i=e.node)||void 0===i||i.once(q$,(function(){t(e._player.sampleRate)}))}))}},{key:"_getRootNode",value:function(){for(var e,t,i=this.node,n=null===(e=i)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;n;){var r,s,a;n=null===(s=i=null===(r=i)||void 0===r?void 0:r.parent)||void 0===s||null===(a=s.parent)||void 0===a?void 0:a.parent}return i}},{key:"play",value:function(){var e,t=this;if(this._isLoaded||!this.clip){var i;j$.discardOnePlayingIfNeeded(),this.state===s$.PLAYING&&(null===(i=this._player)||void 0===i||i.stop().catch((function(){})));var n=this._player;null===(e=this._player)||void 0===e||e.play().then((function(){var e;j$.addPlaying(n),null===(e=t.node)||void 0===e||e.emit(X$.STARTED,t)})).catch((function(){}))}else this._operationsBeforeLoading.push("play")}},{key:"pause",value:function(){var e;if(this._isLoaded||!this.clip){var t=this._player;null===(e=this._player)||void 0===e||e.pause().then((function(){j$.removePlaying(t)})).catch((function(){}))}else this._operationsBeforeLoading.push("pause")}},{key:"stop",value:function(){var e;if(this._isLoaded||!this.clip){var t=this._player;null===(e=this._player)||void 0===e||e.stop().then((function(){j$.removePlaying(t)})).catch((function(){}))}else this._operationsBeforeLoading.push("stop")}},{key:"playOneShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;e._nativeAsset?I$.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){j$.discardOnePlayingIfNeeded(),e.onPlay=function(){j$.addPlaying(e)},e.onEnd=function(){j$.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")}},{key:"_syncStates",value:function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var i;null===(i=e[t])||void 0===i||i.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=Li(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.duration:0}},{key:"state",get:function(){return this._player?this._player.state:s$.INIT}},{key:"playing",get:function(){return this.state===i.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return I$.maxAudioChannel}}]),i}(tm),z$.AudioState=s$,z$.EventType=X$,G$=Ms((F$=W$).prototype,"_clip",[D$],(function(){return null})),V$=Ms(F$.prototype,"_loop",[Js],(function(){return!1})),U$=Ms(F$.prototype,"_playOnAwake",[Js],(function(){return!0})),H$=Ms(F$.prototype,"_volume",[Js],(function(){return 1})),x(F$.prototype,"clip",[L$],Object.getOwnPropertyDescriptor(F$.prototype,"clip"),F$.prototype),N$=F$))||N$));function K$(e){for(var t=e.scene.batches,i=0;i<t.length;i++){var n=t[i];if(e.visibility&n.visFlags)return!0}return!1}me(B$,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:Y$,targetName:"AudioSource"}]),ve(B$.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(e){return{name:e,suggest:"please use AudioSource.prototype.".concat(e," instead")}}))),B.AudioSourceComponent=Y$,ht(Y$,"cc.AudioSourceComponent"),B.log=K,B.warn=Q,B.error=J,B.assert=Z,B._throw=te,B.logID=re,B.warnID=ae,B.errorID=ue,B.assertID=ce,B.debug=Ae,B.path={join:el,extname:tl,mainFileName:il,basename:nl,dirname:rl,changeExtname:sl,changeBasename:al,_normalize:ol,stripSep:ul,get sep(){return hl()}},e("ForwardPipelineBuilder",function(){function e(){n(this,e)}return s(e,[{key:"setup",value:function(e,t){for(var i=0;i<e.length;i++){var n=e[i];null!==n.scene&&Sw(n,t,!1)}}}]),e}()),e("DeferredPipelineBuilder",function(){function e(){n(this,e)}return s(e,[{key:"setup",value:function(e,t){for(var i=0;i<e.length;++i){var n=e[i];n.scene&&(n.cameraUsage===GR.GAME||n.cameraUsage===GR.GAME_VIEW?K$(n)?kw(n,t):gw(n,t,ww(n,t,Cw(n,t)).rtName):Sw(n,t,!1))}}}]),e}());var Q$=Ga.Flags.Destroyed,J$=Ga.Flags.PersistentMask,Z$=[];function $$(e){var t;if(Ua(e)){if(e._instantiate)return B.game._isCloning=!0,t=e._instantiate(null,!0),B.game._isCloning=!1,t;if(e instanceof B.Asset)throw new TypeError(_e(6903))}return B.game._isCloning=!0,t=e0(e),B.game._isCloning=!1,t}function e0(e,t){var i;t0(e,i=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var n=0,r=Z$.length;n<r;++n)Z$[n]._iN$t=null;return Z$.length=0,i}function t0(e,t,n){Ne(e,"_iN$t",t,!0),Z$.push(e);var r=e.constructor;if(Ri(r))!function(e,t,n,r){for(var s=e.__values__,a=0;a<s.length;a++){var o=s[a],u=t[o];if("object"===i(u)&&u){var h=n[o];h instanceof Mt&&h.constructor===u.constructor?h.set(u):n[o]=u._iN$t||i0(u,r)}else n[o]=u}}(r,e,t,n);else for(var s in e)if(e.hasOwnProperty(s)&&(95!==s.charCodeAt(0)||95!==s.charCodeAt(1)||"__type__"===s||"__prefab"===s)){var a=e[s];if("object"===i(a)&&a){if(a===t)continue;t[s]=a._iN$t||i0(a,n)}else t[s]=a}Ua(e)&&(t._objFlags&=J$)}function i0(e,t){if(e instanceof Mt)return e.clone();if(e instanceof B.Asset)return e;var n;if(ArrayBuffer.isView(e)){var r=e.length;n=new e.constructor(r),e._iN$t=n,Z$.push(e);for(var s=0;s<r;++s)n[s]=e[s];return n}if(Array.isArray(e)){var a=e.length;n=new Array(a),e._iN$t=n,Z$.push(e);for(var o=0;o<a;++o){var u=e[o];"object"===i(u)&&u?n[o]=u._iN$t||i0(u,t):n[o]=u}return n}if(e._objFlags&Q$)return null;var h=e.constructor;if(Ri(h)){if(t)if(t instanceof B.Component){if(e instanceof B.Node||e instanceof B.Component)return e}else if(t instanceof B.Node)if(e instanceof B.Node){if(!e.isChildOf(t))return e}else if(e instanceof B.Component&&e.node&&!e.node.isChildOf(t))return e;n=new h}else if(h===Object)n={};else{if(h)return e;n=Object.create(null)}return t0(e,n,t),n}$$._clone=e0,B.instantiate=$$;var n0,r0,s0=e("NodePool",function(){function e(t){n(this,e),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}return s(e,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=this._pool.length-1;if(n<0)return null;var r=this._pool[n];this._pool.length=n;var s=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return s&&s.reuse&&s.reuse(arguments),r}}]),e}());B.NodePool=s0;var a0=null!==(n0=globalThis.jsb)&&void 0!==n0?n0:{};e("native",{DownloaderHints:a0.DownloaderHints,Downloader:a0.Downloader,zipUtils:a0.zipUtils,fileUtils:a0.fileUtils,DebugRenderer:a0.DebugRenderer,copyTextToClipboard:null===(r0=a0.copyTextToClipboard)||void 0===r0?void 0:r0.bind(a0),garbageCollect:a0.garbageCollect,reflection:a0.reflection,bridge:a0.bridge,jsbBridgeWrapper:a0.jsbBridgeWrapper,AssetsManager:a0.AssetsManager,EventAssetsManager:a0.EventAssetsManager,Manifest:a0.Manifest,saveImageData:a0.saveImageData,process:a0.process}),B.renderer=KO;var o0,u0=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuDescriptorSet=null,e}return s(i,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}},{key:"initialize",value:function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,i=t.bindings,n=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:n};for(var a=0;a<i.length;++a)for(var o=i[a],u=0;u<o.count;u++)s.push({type:o.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}},{key:"destroy",value:function(){this._layout=null,this._gpuDescriptorSet=null}},{key:"update",value:function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&w_){var i=this._buffers[t];i&&(e[t].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else e[t].type&k_&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}}]),i}(q_);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(o0||(o0={}));var h0=function(){function e(){n(this,e)}return s(e,null,[{key:"instance",get:function(){return e._instance}},{key:"setInstance",value:function(t){e._instance=t}}]),e}();function l0(e,t){switch(e){case Ll.R8:return t.UNSIGNED_BYTE;case Ll.R8SN:return t.BYTE;case Ll.R8UI:return t.UNSIGNED_BYTE;case Ll.R8I:return t.BYTE;case Ll.R16F:return o0.HALF_FLOAT_OES;case Ll.R16UI:return t.UNSIGNED_SHORT;case Ll.R16I:return t.SHORT;case Ll.R32F:return t.FLOAT;case Ll.R32UI:return t.UNSIGNED_INT;case Ll.R32I:return t.INT;case Ll.RG8:return t.UNSIGNED_BYTE;case Ll.RG8SN:return t.BYTE;case Ll.RG8UI:return t.UNSIGNED_BYTE;case Ll.RG8I:return t.BYTE;case Ll.RG16F:return o0.HALF_FLOAT_OES;case Ll.RG16UI:return t.UNSIGNED_SHORT;case Ll.RG16I:return t.SHORT;case Ll.RG32F:return t.FLOAT;case Ll.RG32UI:return t.UNSIGNED_INT;case Ll.RG32I:return t.INT;case Ll.RGB8:case Ll.SRGB8:return t.UNSIGNED_BYTE;case Ll.RGB8SN:return t.BYTE;case Ll.RGB8UI:return t.UNSIGNED_BYTE;case Ll.RGB8I:return t.BYTE;case Ll.RGB16F:return o0.HALF_FLOAT_OES;case Ll.RGB16UI:return t.UNSIGNED_SHORT;case Ll.RGB16I:return t.SHORT;case Ll.RGB32F:return t.FLOAT;case Ll.RGB32UI:return t.UNSIGNED_INT;case Ll.RGB32I:return t.INT;case Ll.BGRA8:case Ll.RGBA8:case Ll.SRGB8_A8:return t.UNSIGNED_BYTE;case Ll.RGBA8SN:return t.BYTE;case Ll.RGBA8UI:return t.UNSIGNED_BYTE;case Ll.RGBA8I:return t.BYTE;case Ll.RGBA16F:return o0.HALF_FLOAT_OES;case Ll.RGBA16UI:return t.UNSIGNED_SHORT;case Ll.RGBA16I:return t.SHORT;case Ll.RGBA32F:return t.FLOAT;case Ll.RGBA32UI:return t.UNSIGNED_INT;case Ll.RGBA32I:return t.INT;case Ll.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Ll.R11G11B10F:return t.FLOAT;case Ll.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Ll.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Ll.RGB10A2:return t.UNSIGNED_BYTE;case Ll.RGB10A2UI:return t.UNSIGNED_INT;case Ll.RGB9E5:return t.UNSIGNED_BYTE;case Ll.DEPTH:return t.UNSIGNED_INT;case Ll.DEPTH_STENCIL:return o0.UNSIGNED_INT_24_8_WEBGL;case Ll.BC1:case Ll.BC1_SRGB:case Ll.BC2:case Ll.BC2_SRGB:case Ll.BC3:case Ll.BC3_SRGB:case Ll.BC4:return t.UNSIGNED_BYTE;case Ll.BC4_SNORM:return t.BYTE;case Ll.BC5:return t.UNSIGNED_BYTE;case Ll.BC5_SNORM:return t.BYTE;case Ll.BC6H_SF16:case Ll.BC6H_UF16:return t.FLOAT;case Ll.BC7:case Ll.BC7_SRGB:case Ll.ETC_RGB8:case Ll.ETC2_RGB8:case Ll.ETC2_SRGB8:case Ll.ETC2_RGB8_A1:case Ll.ETC2_SRGB8_A1:case Ll.EAC_R11:return t.UNSIGNED_BYTE;case Ll.EAC_R11SN:return t.BYTE;case Ll.EAC_RG11:return t.UNSIGNED_BYTE;case Ll.EAC_RG11SN:return t.BYTE;case Ll.PVRTC_RGB2:case Ll.PVRTC_RGBA2:case Ll.PVRTC_RGB4:case Ll.PVRTC_RGBA4:case Ll.PVRTC2_2BPP:case Ll.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Ll.ASTC_RGBA_4X4:case Ll.ASTC_RGBA_5X4:case Ll.ASTC_RGBA_5X5:case Ll.ASTC_RGBA_6X5:case Ll.ASTC_RGBA_6X6:case Ll.ASTC_RGBA_8X5:case Ll.ASTC_RGBA_8X6:case Ll.ASTC_RGBA_8X8:case Ll.ASTC_RGBA_10X5:case Ll.ASTC_RGBA_10X6:case Ll.ASTC_RGBA_10X8:case Ll.ASTC_RGBA_10X10:case Ll.ASTC_RGBA_12X10:case Ll.ASTC_RGBA_12X12:case Ll.ASTC_SRGBA_4X4:case Ll.ASTC_SRGBA_5X4:case Ll.ASTC_SRGBA_5X5:case Ll.ASTC_SRGBA_6X5:case Ll.ASTC_SRGBA_6X6:case Ll.ASTC_SRGBA_8X5:case Ll.ASTC_SRGBA_8X6:case Ll.ASTC_SRGBA_8X8:case Ll.ASTC_SRGBA_10X5:case Ll.ASTC_SRGBA_10X6:case Ll.ASTC_SRGBA_10X8:case Ll.ASTC_SRGBA_10X10:case Ll.ASTC_SRGBA_12X10:case Ll.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function c0(e,t){switch(e){case Fl.BOOL:return t.BOOL;case Fl.BOOL2:return t.BOOL_VEC2;case Fl.BOOL3:return t.BOOL_VEC3;case Fl.BOOL4:return t.BOOL_VEC4;case Fl.INT:return t.INT;case Fl.INT2:return t.INT_VEC2;case Fl.INT3:return t.INT_VEC3;case Fl.INT4:return t.INT_VEC4;case Fl.UINT:return t.UNSIGNED_INT;case Fl.FLOAT:return t.FLOAT;case Fl.FLOAT2:return t.FLOAT_VEC2;case Fl.FLOAT3:return t.FLOAT_VEC3;case Fl.FLOAT4:return t.FLOAT_VEC4;case Fl.MAT2:return t.FLOAT_MAT2;case Fl.MAT3:return t.FLOAT_MAT3;case Fl.MAT4:return t.FLOAT_MAT4;case Fl.SAMPLER2D:return t.SAMPLER_2D;case Fl.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Fl.UNKNOWN}}function _0(e){switch(e){case Fl.BOOL:case Fl.BOOL2:case Fl.BOOL3:case Fl.BOOL4:case Fl.INT:case Fl.INT2:case Fl.INT3:case Fl.INT4:case Fl.UINT:return Int32Array;case Fl.FLOAT:case Fl.FLOAT2:case Fl.FLOAT3:case Fl.FLOAT4:case Fl.MAT2:case Fl.MAT3:case Fl.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function f0(e,t){switch(e){case t.BOOL:return Fl.BOOL;case t.BOOL_VEC2:return Fl.BOOL2;case t.BOOL_VEC3:return Fl.BOOL3;case t.BOOL_VEC4:return Fl.BOOL4;case t.INT:return Fl.INT;case t.INT_VEC2:return Fl.INT2;case t.INT_VEC3:return Fl.INT3;case t.INT_VEC4:return Fl.INT4;case t.UNSIGNED_INT:return Fl.UINT;case t.FLOAT:return Fl.FLOAT;case t.FLOAT_VEC2:return Fl.FLOAT2;case t.FLOAT_VEC3:return Fl.FLOAT3;case t.FLOAT_VEC4:return Fl.FLOAT4;case t.FLOAT_MAT2:return Fl.MAT2;case t.FLOAT_MAT3:return Fl.MAT3;case t.FLOAT_MAT4:return Fl.MAT4;case t.SAMPLER_2D:return Fl.SAMPLER2D;case t.SAMPLER_CUBE:return Fl.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Fl.UNKNOWN}}function d0(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function m0(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}h0._instance=null;var p0,v0=[512,513,514,515,516,517,518,519],y0=[0,7680,7681,7682,7683,5386,34055,34056],g0=[32774,32778,32779,32775,32776],S0=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.BLIT_TEXTURE=6]="BLIT_TEXTURE",e[e.COUNT=7]="COUNT"}(p0||(p0={}));var A0=function e(t){n(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},T0=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,p0.BEGIN_RENDER_PASS)).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new xc,e.clearFlag=yc.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return s(i,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),i}(A0),E0=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,p0.BIND_STATES)).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new C_,e}return s(i,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0}}]),i}(A0),b0=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,p0.DRAW)).drawInfo=new Uc,e}return s(i,[{key:"clear",value:function(){}}]),i}(A0),C0=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,p0.UPDATE_BUFFER)).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return s(i,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),i}(A0),R0=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,p0.COPY_BUFFER_TO_TEXTURE)).gpuTexture=null,e.buffers=[],e.regions=[],e}return s(i,[{key:"clear",value:function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}]),i}(A0),x0=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,p0.BLIT_TEXTURE)).srcTexture=null,e.dstTexture=null,e.regions=[],e.filter=Kl.LINEAR,e}return s(i,[{key:"clear",value:function(){this.srcTexture=null,this.dstTexture=null,this.regions.length=0}}]),i}(A0),w0=function(){function e(){n(this,e),this.cmds=new Ch(1),this.beginRenderPassCmds=new Ch(1),this.bindStatesCmds=new Ch(1),this.drawCmds=new Ch(1),this.updateBufferCmds=new Ch(1),this.copyBufferToTextureCmds=new Ch(1),this.blitTextureCmds=new Ch(1)}return s(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.blitTextureCmds.length&&(e.blitTextureCmdPool.freeCmds(this.blitTextureCmds),this.blitTextureCmds.clear()),this.cmds.clear()}}]),e}();function k0(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Hl.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&Gl.VERTEX){t.glTarget=i.ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,t.size>0&&(e.extensions.useVAO&&n.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),L0.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Gl.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&n.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),L0.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&Gl.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&Gl.INDIRECT||t.usage&Gl.TRANSFER_DST||t.usage&Gl.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=i.NONE)}function I0(e,t){var i=e.gl,n=e.stateCache;if(t.glBuffer){switch(t.glTarget){case i.ARRAY_BUFFER:e.extensions.useVAO&&n.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),L0.gpuInputAssembler=null,i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&n.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),L0.gpuInputAssembler=null,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}i.deleteBuffer(t.glBuffer),t.glBuffer=null}}function B0(e,t,i,n,r){if(t.usage&Gl.UNIFORM)ArrayBuffer.isView(i)?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&Gl.INDIRECT){t.indirects.clearDraws();for(var s=i.drawInfos,a=0;a<s.length;++a)t.indirects.setDrawInfo(n+a,s[a])}else{var o=i,u=e.gl,h=e.stateCache;switch(t.glTarget){case u.ARRAY_BUFFER:e.extensions.useVAO&&h.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),h.glVAO=null),L0.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(u.bindBuffer(u.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case u.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&h.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),h.glVAO=null),L0.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===o.byteLength?u.bufferSubData(t.glTarget,n,o):u.bufferSubData(t.glTarget,n,o.slice(0,r))}}function P0(e,t){for(var n=e.gl,r=function(e){var i=t.gpuStages[e],r=0,s="",a=1;switch(i.type){case ic.VERTEX:s="VertexShader",r=n.VERTEX_SHADER;break;case ic.FRAGMENT:s="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var o=n.createShader(r);if(o&&(i.glShader=o,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error("".concat(s," in '").concat(t.name,"' compilation failed.")),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n".concat(a++," ")}))),console.error(n.getShaderInfoLog(i.glShader));for(var u=0;u<t.gpuStages.length;u++){var h=t.gpuStages[e];h.glShader&&(n.deleteShader(h.glShader),h.glShader=null)}return{v:void 0}}},s=0;s<t.gpuStages.length;s++){var a=r(s);if("object"===i(a))return a.v}var o=n.createProgram();if(o){t.glProgram=o;for(var u=0;u<t.gpuStages.length;u++){var h=t.gpuStages[u];n.attachShader(t.glProgram,h.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var c=t.gpuStages[l];c.glShader&&(n.detachShader(t.glProgram,c.glShader),n.deleteShader(c.glShader),c.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '".concat(t.name,"'.")),void console.error(n.getProgramInfoLog(t.glProgram));$("Shader '".concat(t.name,"' compilation succeeded."));var _=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(_);for(var f=0;f<_;++f){var d=n.getActiveAttrib(t.glProgram,f);if(d){var m,p=d.name.indexOf("[");m=-1!==p?d.name.substr(0,p):d.name;var v=n.getAttribLocation(t.glProgram,m),y=f0(d.type,n),g=d0(d.type,n);t.glInputs[f]={binding:v,name:m,type:y,stride:g,count:d.size,size:g*d.size,glType:d.type,glLoc:v}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var S=0;S<t.blocks.length;++S){var A=t.blocks[S],T={set:A.set,binding:A.binding,name:A.name,size:0,glUniforms:new Array(A.members.length),glActiveUniforms:[]};t.glBlocks[S]=T;for(var E=0;E<A.members.length;++E){var b=A.members[E],C=c0(b.type,n),R=d0(C,n),x=R*b.count;T.glUniforms[E]={binding:-1,name:b.name,type:b.type,stride:R,count:b.count,size:x,offset:0,glType:C,glLoc:null,array:null}}}}for(var w=0;w<t.subpassInputs.length;++w){var k=t.subpassInputs[w];t.samplerTextures.push(new Kc(k.set,k.binding,k.name,Fl.SAMPLER2D,k.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var I=0;I<t.samplerTextures.length;++I){var P=t.samplerTextures[I];t.glSamplerTextures[I]={set:P.set,binding:P.binding,name:P.name,type:P.type,count:P.count,units:[],glUnits:null,glType:c0(P.type,n),glLoc:null}}}for(var M=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),O=0;O<M;++O){var D=n.getActiveUniform(t.glProgram,O);if(D&&D.type!==n.SAMPLER_2D&&D.type!==n.SAMPLER_CUBE){var L=n.getUniformLocation(t.glProgram,D.name);if(e.extensions.isLocationActive(L)){var N,F=D.name.indexOf("[");N=-1!==F?D.name.substr(0,F):D.name;for(var G=0;G<t.glBlocks.length;G++)for(var V=t.glBlocks[G],U=0;U<V.glUniforms.length;U++){var H=V.glUniforms[U];if(H.name===N){H.glLoc=L,H.count=D.size,H.size=H.stride*H.count,H.array=new(_0(H.type))(H.size/4),V.glActiveUniforms.push(H);break}}}}}for(var z=0;z<t.glBlocks.length;z++)for(var W=t.glBlocks[z],X=0;X<W.glUniforms.length;X++){var j=W.glUniforms[X];j.offset=W.size/4,W.size+=j.size}var q=[],Y=[],K=e.bindingMappings,Q=e.stateCache.texUnitCacheMap;if(B.rendering&&B.rendering.enableEffectImport)for(var J=0;J<t.samplerTextures.length;++J){var Z=t.samplerTextures[J],ee=n.getUniformLocation(t.glProgram,Z.name);e.extensions.isLocationActive(ee)&&(q.push(t.glSamplerTextures[J]),Y.push(ee)),void 0===Q[Z.name]&&(Q[Z.name]=Z.flattened)}else{for(var te=0,ie=0;ie<t.blocks.length;++ie)t.blocks[ie].set===K.flexibleSet&&te++;for(var ne=0,re=0;re<t.samplerTextures.length;++re){var se=t.samplerTextures[re],ae=n.getUniformLocation(t.glProgram,se.name);if(e.extensions.isLocationActive(ae)&&(q.push(t.glSamplerTextures[re]),Y.push(ae)),void 0===Q[se.name]){var oe=se.binding+K.samplerTextureOffsets[se.set]+ne;se.set===K.flexibleSet&&(oe-=te),Q[se.name]=oe%e.capabilities.maxTextureUnits,ne+=se.count-1}}}if(q.length){for(var ue=[],he=0;he<q.length;++he){var le=q[he],ce=Q[le.name];if(void 0!==ce){le.glLoc=Y[he];for(var _e=0;_e<le.count;++_e){for(;ue[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;le.units.push(ce),ue[ce]=!0}}}for(var fe=0,de=0;de<q.length;++de){var me=q[de];if(!e.extensions.isLocationActive(me.glLoc)){me.glLoc=Y[de];for(var pe=0;pe<me.count;++pe){for(;ue[fe];)fe=(fe+1)%e.capabilities.maxTextureUnits;void 0===Q[me.name]&&(Q[me.name]=fe),me.units.push(fe),ue[fe]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var ve=0;ve<q.length;ve++){var ye=q[ve];ye.glUnits=new Int32Array(ye.units),n.uniform1iv(ye.glLoc,ye.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var ge=0;ge<t.glBlocks.length;)t.glBlocks[ge].glActiveUniforms.length?ge++:(t.glBlocks[ge]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}function M0(e,t){if(t.glProgram){var i=e.gl;if(!e.extensions.destroyShadersImmediately)for(var n=0;n<t.gpuStages.length;n++){var r=t.gpuStages[n];r.glShader&&(i.detachShader(t.glProgram,r.glShader),i.deleteShader(r.glShader),r.glShader=null)}i.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}function O0(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var s=t.attributes[r],a=void 0!==s.stream?s.stream:0,o=t.gpuVertexBuffers[a],u=l0(s.format,i),h=x_[s.format].size;t.glAttribs[r]={name:s.name,glBuffer:o.glBuffer,glType:u,size:h,count:x_[s.format].count,stride:o.stride,componentCount:m0(u,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[a]},n[a]+=h}}function D0(e,t){for(var i=t.glVAOs.values(),n=i.next(),r=e.extensions.OES_vertex_array_object,s=e.stateCache.glVAO;!n.done;)r.deleteVertexArrayOES(n.value),s===n.value&&(r.bindVertexArrayOES(null),s=null),n=i.next();e.stateCache.glVAO=s,t.glVAOs.clear()}var L0={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},N0=new xc;function F0(e,t,i,n,r,s,a){var o=e.gl,u=e.stateCache,h=0;if(i&&(N0.x=n.x<<i.lodLevel,N0.y=n.y<<i.lodLevel,N0.width=n.width<<i.lodLevel,N0.height=n.height<<i.lodLevel),i&&t){u.glFramebuffer!==i.glFramebuffer&&(o.bindFramebuffer(o.FRAMEBUFFER,i.glFramebuffer),u.glFramebuffer=i.glFramebuffer),u.viewport.left===N0.x&&u.viewport.top===N0.y&&u.viewport.width===N0.width&&u.viewport.height===N0.height||(o.viewport(N0.x,N0.y,N0.width,N0.height),u.viewport.left=N0.x,u.viewport.top=N0.y,u.viewport.width=N0.width,u.viewport.height=N0.height),u.scissorRect.x===N0.x&&u.scissorRect.y===N0.y&&u.scissorRect.width===N0.width&&u.scissorRect.height===N0.height||(o.scissor(N0.x,N0.y,N0.width,N0.height),u.scissorRect.x=N0.x,u.scissorRect.y=N0.y,u.scissorRect.width=N0.width,u.scissorRect.height=N0.height);var l=r.length;e.extensions.WEBGL_draw_buffers||(l=1);for(var c=0;c<l;++c){var _=t.colorAttachments[c];if(_.format!==Ll.UNKNOWN)switch(_.loadOp){case nc.LOAD:break;case nc.CLEAR:u.bs.targets[0].blendColorMask!==tc.ALL&&o.colorMask(!0,!0,!0,!0);var f=r[0];o.clearColor(f.x,f.y,f.z,f.w),h|=o.COLOR_BUFFER_BIT;break;case nc.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Ll.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case nc.LOAD:break;case nc.CLEAR:u.dss.depthWrite||o.depthMask(!0),o.clearDepth(s),h|=o.DEPTH_BUFFER_BIT;break;case nc.DISCARD:}if(x_[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case nc.LOAD:break;case nc.CLEAR:u.dss.stencilWriteMaskFront||o.stencilMaskSeparate(o.FRONT,65535),u.dss.stencilWriteMaskBack||o.stencilMaskSeparate(o.BACK,65535),o.clearStencil(a),h|=o.STENCIL_BUFFER_BIT;break;case nc.DISCARD:}}if(h&&o.clear(h),h&o.COLOR_BUFFER_BIT){var d=u.bs.targets[0].blendColorMask;if(d!==tc.ALL){var m=(d&tc.R)!==tc.NONE,p=(d&tc.G)!==tc.NONE,v=(d&tc.B)!==tc.NONE,y=(d&tc.A)!==tc.NONE;o.colorMask(m,p,v,y)}}h&o.DEPTH_BUFFER_BIT&&!u.dss.depthWrite&&o.depthMask(!1),h&o.STENCIL_BUFFER_BIT&&(u.dss.stencilWriteMaskFront||o.stencilMaskSeparate(o.FRONT,0),u.dss.stencilWriteMaskBack||o.stencilMaskSeparate(o.BACK,0))}}function G0(e,t,i,n,r,s){var a,o,u,h=e.gl,l=e.stateCache,c=t&&t.gpuShader,_=!1;if(t&&L0.gpuPipelineState!==t){if(L0.gpuPipelineState=t,L0.glPrimitive=t.glPrimitive,t.gpuShader){var f=t.gpuShader.glProgram;l.glProgram!==f&&(h.useProgram(f),l.glProgram=f,_=!0)}var d=t.rs;if(d){if(l.rs.cullMode!==d.cullMode){switch(d.cullMode){case cc.NONE:h.disable(h.CULL_FACE);break;case cc.FRONT:h.enable(h.CULL_FACE),h.cullFace(h.FRONT);break;case cc.BACK:h.enable(h.CULL_FACE),h.cullFace(h.BACK)}l.rs.cullMode=d.cullMode}var m=d.isFrontFaceCCW;l.rs.isFrontFaceCCW!==m&&(h.frontFace(m?h.CCW:h.CW),l.rs.isFrontFaceCCW=m),l.rs.depthBias===d.depthBias&&l.rs.depthBiasSlop===d.depthBiasSlop||(h.polygonOffset(d.depthBias,d.depthBiasSlop),l.rs.depthBias=d.depthBias,l.rs.depthBiasSlop=d.depthBiasSlop),l.rs.lineWidth!==d.lineWidth&&(h.lineWidth(d.lineWidth),l.rs.lineWidth=d.lineWidth)}var p=t.dss;p&&(l.dss.depthTest!==p.depthTest&&(p.depthTest?h.enable(h.DEPTH_TEST):h.disable(h.DEPTH_TEST),l.dss.depthTest=p.depthTest),l.dss.depthWrite!==p.depthWrite&&(h.depthMask(p.depthWrite),l.dss.depthWrite=p.depthWrite),l.dss.depthFunc!==p.depthFunc&&(h.depthFunc(v0[p.depthFunc]),l.dss.depthFunc=p.depthFunc),l.dss.stencilTestFront===p.stencilTestFront&&l.dss.stencilTestBack===p.stencilTestBack||(p.stencilTestFront||p.stencilTestBack?h.enable(h.STENCIL_TEST):h.disable(h.STENCIL_TEST),l.dss.stencilTestFront=p.stencilTestFront,l.dss.stencilTestBack=p.stencilTestBack),l.dss.stencilFuncFront===p.stencilFuncFront&&l.dss.stencilRefFront===p.stencilRefFront&&l.dss.stencilReadMaskFront===p.stencilReadMaskFront||(h.stencilFuncSeparate(h.FRONT,v0[p.stencilFuncFront],p.stencilRefFront,p.stencilReadMaskFront),l.dss.stencilFuncFront=p.stencilFuncFront,l.dss.stencilRefFront=p.stencilRefFront,l.dss.stencilReadMaskFront=p.stencilReadMaskFront),l.dss.stencilFailOpFront===p.stencilFailOpFront&&l.dss.stencilZFailOpFront===p.stencilZFailOpFront&&l.dss.stencilPassOpFront===p.stencilPassOpFront||(h.stencilOpSeparate(h.FRONT,y0[p.stencilFailOpFront],y0[p.stencilZFailOpFront],y0[p.stencilPassOpFront]),l.dss.stencilFailOpFront=p.stencilFailOpFront,l.dss.stencilZFailOpFront=p.stencilZFailOpFront,l.dss.stencilPassOpFront=p.stencilPassOpFront),l.dss.stencilWriteMaskFront!==p.stencilWriteMaskFront&&(h.stencilMaskSeparate(h.FRONT,p.stencilWriteMaskFront),l.dss.stencilWriteMaskFront=p.stencilWriteMaskFront),l.dss.stencilFuncBack===p.stencilFuncBack&&l.dss.stencilRefBack===p.stencilRefBack&&l.dss.stencilReadMaskBack===p.stencilReadMaskBack||(h.stencilFuncSeparate(h.BACK,v0[p.stencilFuncBack],p.stencilRefBack,p.stencilReadMaskBack),l.dss.stencilFuncBack=p.stencilFuncBack,l.dss.stencilRefBack=p.stencilRefBack,l.dss.stencilReadMaskBack=p.stencilReadMaskBack),l.dss.stencilFailOpBack===p.stencilFailOpBack&&l.dss.stencilZFailOpBack===p.stencilZFailOpBack&&l.dss.stencilPassOpBack===p.stencilPassOpBack||(h.stencilOpSeparate(h.BACK,y0[p.stencilFailOpBack],y0[p.stencilZFailOpBack],y0[p.stencilPassOpBack]),l.dss.stencilFailOpBack=p.stencilFailOpBack,l.dss.stencilZFailOpBack=p.stencilZFailOpBack,l.dss.stencilPassOpBack=p.stencilPassOpBack),l.dss.stencilWriteMaskBack!==p.stencilWriteMaskBack&&(h.stencilMaskSeparate(h.BACK,p.stencilWriteMaskBack),l.dss.stencilWriteMaskBack=p.stencilWriteMaskBack));var v=t.bs;if(v){l.bs.isA2C!==v.isA2C&&(v.isA2C?h.enable(h.SAMPLE_ALPHA_TO_COVERAGE):h.disable(h.SAMPLE_ALPHA_TO_COVERAGE),l.bs.isA2C=v.isA2C),l.bs.blendColor.x===v.blendColor.x&&l.bs.blendColor.y===v.blendColor.y&&l.bs.blendColor.z===v.blendColor.z&&l.bs.blendColor.w===v.blendColor.w||(h.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),l.bs.blendColor.x=v.blendColor.x,l.bs.blendColor.y=v.blendColor.y,l.bs.blendColor.z=v.blendColor.z,l.bs.blendColor.w=v.blendColor.w);var y=v.targets[0],g=l.bs.targets[0];g.blend!==y.blend&&(y.blend?h.enable(h.BLEND):h.disable(h.BLEND),g.blend=y.blend),g.blendEq===y.blendEq&&g.blendAlphaEq===y.blendAlphaEq||(h.blendEquationSeparate(g0[y.blendEq],g0[y.blendAlphaEq]),g.blendEq=y.blendEq,g.blendAlphaEq=y.blendAlphaEq),g.blendSrc===y.blendSrc&&g.blendDst===y.blendDst&&g.blendSrcAlpha===y.blendSrcAlpha&&g.blendDstAlpha===y.blendDstAlpha||(h.blendFuncSeparate(S0[y.blendSrc],S0[y.blendDst],S0[y.blendSrcAlpha],S0[y.blendDstAlpha]),g.blendSrc=y.blendSrc,g.blendDst=y.blendDst,g.blendSrcAlpha=y.blendSrcAlpha,g.blendDstAlpha=y.blendDstAlpha),g.blendColorMask!==y.blendColorMask&&(h.colorMask((y.blendColorMask&tc.R)!==tc.NONE,(y.blendColorMask&tc.G)!==tc.NONE,(y.blendColorMask&tc.B)!==tc.NONE,(y.blendColorMask&tc.A)!==tc.NONE),g.blendColorMask=y.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var S=c.glBlocks.length,A=t.gpuPipelineLayout.dynamicOffsetIndices,T=0;T<S;T++){var E=c.glBlocks[T],b=n[E.set],C=b&&b.descriptorIndices[E.binding],R=C>=0&&b.gpuDescriptors[C],x=null,w=0;if(R&&R.gpuBuffer){var k=R.gpuBuffer,I=A[E.set],B=I&&I[E.binding];B>=0&&(w=r[B]),"vf32"in k?x=k.vf32:(w+=k.offset,x=k.gpuBuffer.vf32),w>>=2}if(x)for(var P=E.glActiveUniforms.length,M=0;M<P;M++){var O=E.glActiveUniforms[M];switch(O.glType){case h.BOOL:case h.INT:for(var D=0;D<O.array.length;++D){var L=O.offset+w+D;if(x[L]!==O.array[D]){for(var N=D,F=L;N<O.array.length;++N,++F)O.array[N]=x[F];h.uniform1iv(O.glLoc,O.array);break}}break;case h.BOOL_VEC2:case h.INT_VEC2:for(var G=0;G<O.array.length;++G){var V=O.offset+w+G;if(x[V]!==O.array[G]){for(var U=G,H=V;U<O.array.length;++U,++H)O.array[U]=x[H];h.uniform2iv(O.glLoc,O.array);break}}break;case h.BOOL_VEC3:case h.INT_VEC3:for(var z=0;z<O.array.length;++z){var W=O.offset+w+z;if(x[W]!==O.array[z]){for(var X=z,j=W;X<O.array.length;++X,++j)O.array[X]=x[j];h.uniform3iv(O.glLoc,O.array);break}}break;case h.BOOL_VEC4:case h.INT_VEC4:for(var q=0;q<O.array.length;++q){var Y=O.offset+w+q;if(x[Y]!==O.array[q]){for(var K=q,Q=Y;K<O.array.length;++K,++Q)O.array[K]=x[Q];h.uniform4iv(O.glLoc,O.array);break}}break;case h.FLOAT:for(var Z=0;Z<O.array.length;++Z){var $=O.offset+w+Z;if(x[$]!==O.array[Z]){for(var ee=Z,te=$;ee<O.array.length;++ee,++te)O.array[ee]=x[te];h.uniform1fv(O.glLoc,O.array);break}}break;case h.FLOAT_VEC2:for(var ie=0;ie<O.array.length;++ie){var ne=O.offset+w+ie;if(x[ne]!==O.array[ie]){for(var re=ie,se=ne;re<O.array.length;++re,++se)O.array[re]=x[se];h.uniform2fv(O.glLoc,O.array);break}}break;case h.FLOAT_VEC3:for(var ae=0;ae<O.array.length;++ae){var oe=O.offset+w+ae;if(x[oe]!==O.array[ae]){for(var ue=ae,he=oe;ue<O.array.length;++ue,++he)O.array[ue]=x[he];h.uniform3fv(O.glLoc,O.array);break}}break;case h.FLOAT_VEC4:for(var le=0;le<O.array.length;++le){var ce=O.offset+w+le;if(x[ce]!==O.array[le]){for(var _e=le,fe=ce;_e<O.array.length;++_e,++fe)O.array[_e]=x[fe];h.uniform4fv(O.glLoc,O.array);break}}break;case h.FLOAT_MAT2:for(var de=0;de<O.array.length;++de){var me=O.offset+w+de;if(x[me]!==O.array[de]){for(var pe=de,ve=me;pe<O.array.length;++pe,++ve)O.array[pe]=x[ve];h.uniformMatrix2fv(O.glLoc,!1,O.array);break}}break;case h.FLOAT_MAT3:for(var ye=0;ye<O.array.length;++ye){var ge=O.offset+w+ye;if(x[ge]!==O.array[ye]){for(var Se=ye,Ae=ge;Se<O.array.length;++Se,++Ae)O.array[Se]=x[Ae];h.uniformMatrix3fv(O.glLoc,!1,O.array);break}}break;case h.FLOAT_MAT4:for(var Te=0;Te<O.array.length;++Te){var Ee=O.offset+w+Te;if(x[Ee]!==O.array[Te]){for(var be=Te,Ce=Ee;be<O.array.length;++be,++Ce)O.array[be]=x[Ce];h.uniformMatrix4fv(O.glLoc,!1,O.array);break}}}}else J("Buffer binding '".concat(E.name,"' at set ").concat(E.set," binding ").concat(E.binding," is not bounded"))}for(var Re=c.glSamplerTextures.length,xe=0;xe<Re;xe++)for(var we=c.glSamplerTextures[xe],ke=n[we.set],Ie=ke&&ke.descriptorIndices[we.binding],Be=Ie>=0&&ke.gpuDescriptors[Ie],Pe=we.units.length,Me=0;Me<Pe;Me++){var Oe=we.units[Me];if(Be&&Be.gpuSampler){if(Be.gpuTexture&&Be.gpuTexture.size>0){var De=Be.gpuTexture,Le=l.glTexUnits[Oe];Le.glTexture!==De.glTexture&&(l.texUnit!==Oe&&(h.activeTexture(h.TEXTURE0+Oe),l.texUnit=Oe),De.glTexture?h.bindTexture(De.glTarget,De.glTexture):h.bindTexture(De.glTarget,e.nullTex2D.gpuTexture.glTexture),Le.glTexture=De.glTexture);var Ne=Be.gpuSampler;De.isPowerOf2?(a=Ne.glWrapS,o=Ne.glWrapT):(a=h.CLAMP_TO_EDGE,o=h.CLAMP_TO_EDGE),u=De.isPowerOf2?De.mipLevel<=1&&(Ne.glMinFilter===h.LINEAR_MIPMAP_NEAREST||Ne.glMinFilter===h.LINEAR_MIPMAP_LINEAR)?h.LINEAR:Ne.glMinFilter:Ne.glMinFilter===h.LINEAR||Ne.glMinFilter===h.LINEAR_MIPMAP_NEAREST||Ne.glMinFilter===h.LINEAR_MIPMAP_LINEAR?h.LINEAR:h.NEAREST,De.glWrapS!==a&&(l.texUnit!==Oe&&(h.activeTexture(h.TEXTURE0+Oe),l.texUnit=Oe),h.texParameteri(De.glTarget,h.TEXTURE_WRAP_S,a),De.glWrapS=a),De.glWrapT!==o&&(l.texUnit!==Oe&&(h.activeTexture(h.TEXTURE0+Oe),l.texUnit=Oe),h.texParameteri(De.glTarget,h.TEXTURE_WRAP_T,o),De.glWrapT=o),De.glMinFilter!==u&&(l.texUnit!==Oe&&(h.activeTexture(h.TEXTURE0+Oe),l.texUnit=Oe),h.texParameteri(De.glTarget,h.TEXTURE_MIN_FILTER,u),De.glMinFilter=u),De.glMagFilter!==Ne.glMagFilter&&(l.texUnit!==Oe&&(h.activeTexture(h.TEXTURE0+Oe),l.texUnit=Oe),h.texParameteri(De.glTarget,h.TEXTURE_MAG_FILTER,Ne.glMagFilter),De.glMagFilter=Ne.glMagFilter)}Be=ke.gpuDescriptors[++Ie]}else J("Sampler binding '".concat(we.name,"' at set ").concat(we.set," binding ").concat(we.binding," index ").concat(Me," is not bounded"))}}if(i&&c&&(_||L0.gpuInputAssembler!==i)){L0.gpuInputAssembler=i;var Fe=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ge=e.extensions.OES_vertex_array_object,Ve=i.glVAOs.get(c.glProgram);if(!Ve){var Ue;Ve=Ge.createVertexArrayOES(),i.glVAOs.set(c.glProgram,Ve),Ge.bindVertexArrayOES(Ve),h.bindBuffer(h.ARRAY_BUFFER,null),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null),l.glArrayBuffer=null,l.glElementArrayBuffer=null;for(var He=c.glInputs.length,ze=0;ze<He;ze++){var We=c.glInputs[ze];Ue=null;for(var Xe=i.glAttribs.length,je=0;je<Xe;je++){var qe=i.glAttribs[je];if(qe.name===We.name){Ue=qe;break}}if(Ue){l.glArrayBuffer!==Ue.glBuffer&&(h.bindBuffer(h.ARRAY_BUFFER,Ue.glBuffer),l.glArrayBuffer=Ue.glBuffer);for(var Ye=0;Ye<Ue.componentCount;++Ye){var Ke=We.glLoc+Ye,Qe=Ue.offset+Ue.size*Ye;h.enableVertexAttribArray(Ke),l.glCurrentAttribLocs[Ke]=!0,h.vertexAttribPointer(Ke,Ue.count,Ue.glType,Ue.isNormalized,Ue.stride,Qe),Fe&&Fe.vertexAttribDivisorANGLE(Ke,Ue.isInstanced?1:0)}}}var Je=i.gpuIndexBuffer;Je&&h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,Je.glBuffer),Ge.bindVertexArrayOES(null),h.bindBuffer(h.ARRAY_BUFFER,null),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null),l.glArrayBuffer=null,l.glElementArrayBuffer=null}l.glVAO!==Ve&&(Ge.bindVertexArrayOES(Ve),l.glVAO=Ve)}else{for(var Ze=0;Ze<e.capabilities.maxVertexAttributes;++Ze)l.glCurrentAttribLocs[Ze]=!1;for(var $e=c.glInputs.length,et=0;et<$e;et++){for(var tt=c.glInputs[et],it=null,nt=i.glAttribs.length,rt=0;rt<nt;rt++){var st=i.glAttribs[rt];if(st.name===tt.name){it=st;break}}if(it){l.glArrayBuffer!==it.glBuffer&&(h.bindBuffer(h.ARRAY_BUFFER,it.glBuffer),l.glArrayBuffer=it.glBuffer);for(var at=0;at<it.componentCount;++at){var ot=tt.glLoc+at,ut=it.offset+it.size*at;!l.glEnabledAttribLocs[ot]&&ot>=0&&(h.enableVertexAttribArray(ot),l.glEnabledAttribLocs[ot]=!0),l.glCurrentAttribLocs[ot]=!0,h.vertexAttribPointer(ot,it.count,it.glType,it.isNormalized,it.stride,ut),Fe&&Fe.vertexAttribDivisorANGLE(ot,it.isInstanced?1:0)}}}var ht=i.gpuIndexBuffer;ht&&l.glElementArrayBuffer!==ht.glBuffer&&(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,ht.glBuffer),l.glElementArrayBuffer=ht.glBuffer);for(var lt=0;lt<e.capabilities.maxVertexAttributes;++lt)l.glEnabledAttribLocs[lt]!==l.glCurrentAttribLocs[lt]&&(h.disableVertexAttribArray(lt),l.glEnabledAttribLocs[lt]=!1)}}if(t&&t.dynamicStates.length)for(var ct=t.dynamicStates.length,_t=0;_t<ct;_t++)switch(t.dynamicStates[_t]){case _c.LINE_WIDTH:l.rs.lineWidth!==s.lineWidth&&(h.lineWidth(s.lineWidth),l.rs.lineWidth=s.lineWidth);break;case _c.DEPTH_BIAS:l.rs.depthBias===s.depthBiasConstant&&l.rs.depthBiasSlop===s.depthBiasSlope||(h.polygonOffset(s.depthBiasConstant,s.depthBiasSlope),l.rs.depthBias=s.depthBiasConstant,l.rs.depthBiasSlop=s.depthBiasSlope);break;case _c.BLEND_CONSTANTS:var ft=s.blendConstant;l.bs.blendColor.x===ft.x&&l.bs.blendColor.y===ft.y&&l.bs.blendColor.z===ft.z&&l.bs.blendColor.w===ft.w||(h.blendColor(ft.x,ft.y,ft.z,ft.w),l.bs.blendColor.copy(ft));break;case _c.STENCIL_WRITE_MASK:var dt=s.stencilStatesFront,mt=s.stencilStatesBack;l.dss.stencilWriteMaskFront!==dt.writeMask&&(h.stencilMaskSeparate(h.FRONT,dt.writeMask),l.dss.stencilWriteMaskFront=dt.writeMask),l.dss.stencilWriteMaskBack!==mt.writeMask&&(h.stencilMaskSeparate(h.BACK,mt.writeMask),l.dss.stencilWriteMaskBack=mt.writeMask);break;case _c.STENCIL_COMPARE_MASK:var pt=s.stencilStatesFront,vt=s.stencilStatesBack;l.dss.stencilRefFront===pt.reference&&l.dss.stencilReadMaskFront===pt.compareMask||(h.stencilFuncSeparate(h.FRONT,v0[l.dss.stencilFuncFront],pt.reference,pt.compareMask),l.dss.stencilRefFront=pt.reference,l.dss.stencilReadMaskFront=pt.compareMask),l.dss.stencilRefBack===vt.reference&&l.dss.stencilReadMaskBack===vt.compareMask||(h.stencilFuncSeparate(h.BACK,v0[l.dss.stencilFuncBack],vt.reference,vt.compareMask),l.dss.stencilRefBack=vt.reference,l.dss.stencilReadMaskBack=vt.compareMask)}}function V0(e,t){var i=e.gl,n=e.extensions,r=n.ANGLE_instanced_arrays,s=n.WEBGL_multi_draw,a=L0.gpuInputAssembler,o=L0.glPrimitive;if(a){var u=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var h=a.gpuIndirectBuffer.indirects;if(h.drawByIndex){for(var l=0;l<h.drawCount;l++)h.byteOffsets[l]=h.offsets[l]*u.stride;if(s)h.instancedDraw?s.multiDrawElementsInstancedWEBGL(o,h.counts,0,a.glIndexType,h.byteOffsets,0,h.instances,0,h.drawCount):s.multiDrawElementsWEBGL(o,h.counts,0,a.glIndexType,h.byteOffsets,0,h.drawCount);else for(var c=0;c<h.drawCount;c++)h.instances[c]&&r?r.drawElementsInstancedANGLE(o,h.counts[c],a.glIndexType,h.byteOffsets[c],h.instances[c]):i.drawElements(o,h.counts[c],a.glIndexType,h.byteOffsets[c])}else if(s)h.instancedDraw?s.multiDrawArraysInstancedWEBGL(o,h.offsets,0,h.counts,0,h.instances,0,h.drawCount):s.multiDrawArraysWEBGL(o,h.offsets,0,h.counts,0,h.drawCount);else for(var _=0;_<h.drawCount;_++)h.instances[_]&&r?r.drawArraysInstancedANGLE(o,h.offsets[_],h.counts[_],h.instances[_]):i.drawArrays(o,h.offsets[_],h.counts[_])}else if(t.instanceCount&&r)if(u){if(t.indexCount>0){var f=t.firstIndex*u.stride;r.drawElementsInstancedANGLE(o,t.indexCount,a.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(o,t.firstVertex,t.vertexCount,t.instanceCount);else if(u){if(t.indexCount>0){var d=t.firstIndex*u.stride;i.drawElements(o,t.indexCount,a.glIndexType,d)}}else t.vertexCount>0&&i.drawArrays(o,t.firstVertex,t.vertexCount)}}var U0=new Array(p0.COUNT);function H0(e,t){U0.fill(0);for(var i=0;i<t.cmds.length;++i){var n=t.cmds.array[i],r=U0[n]++;switch(n){case p0.BEGIN_RENDER_PASS:var s=t.beginRenderPassCmds.array[r];F0(e,s.gpuRenderPass,s.gpuFramebuffer,s.renderArea,s.clearColors,s.clearDepth,s.clearStencil);break;case p0.BIND_STATES:var a=t.bindStatesCmds.array[r];G0(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case p0.DRAW:V0(e,t.drawCmds.array[r].drawInfo);break;case p0.UPDATE_BUFFER:var o=t.updateBufferCmds.array[r];B0(e,o.gpuBuffer,o.buffer,o.offset,o.size);break;case p0.COPY_BUFFER_TO_TEXTURE:var u=t.copyBufferToTextureCmds.array[r];X0(e,u.buffers,u.gpuTexture,u.regions);break;case p0.BLIT_TEXTURE:var h=t.blitTextureCmds.array[r];j0(e,h.srcTexture,h.dstTexture,h.regions,h.filter)}}}var z0=new Uint8Array(1);function W0(e,t,i,n,r){var s=N_(t).height,a=P_(t,r.width,r.height,r.depth),o=P_(t,n.width,1,1),u=P_(t,n.width,n.height,1),h=P_(t,r.width,1,1),l=L_(x_[t]);z0.byteLength<a&&(z0=new Uint8Array(a));for(var c=0,_=i,f=0;f<r.depth;f++){_=i+u*f;for(var d=0;d<r.height;d+=s)z0.subarray(c,c+h).set(new Uint8Array(e.buffer,e.byteOffset+_,h)),c+=h,_+=o}return new l(z0.buffer)}function X0(e,t,i,n){var r=e.gl,s=e.stateCache.glTexUnits[e.stateCache.texUnit];s.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),s.glTexture=i.glTexture);var a=0,o=0,u=x_[i.format],h=L_(u),l=u.isCompressed,c=N_(i.format),_=new wc,f=new Rc,d=new wc;switch(i.glTarget){case r.TEXTURE_2D:for(var m=0;m<n.length;m++){var p=n[m],v=p.texSubres.mipLevel;f.x=0===p.texOffset.x?0:F_(p.texOffset.x,c.width),f.y=0===p.texOffset.y?0:F_(p.texOffset.y,c.height),_.width=p.texExtent.width<c.width?p.texExtent.width:F_(p.texExtent.width,c.width),_.height=p.texExtent.height<c.height?p.texExtent.width:F_(p.texExtent.height,c.height),d.width=p.buffStride>0?p.buffStride:_.width,d.height=p.buffTexHeight>0?p.buffTexHeight:_.height;var y,g=p.texExtent.width+f.x===i.width>>v?p.texExtent.width:_.width,S=p.texExtent.height+f.y===i.height>>v?p.texExtent.height:_.height,A=t[a++];y=d.width===_.width&&d.height===_.height?new h(A.buffer,A.byteOffset+p.buffOffset):W0(A,i.format,p.buffOffset,d,_),l?i.glInternalFmt===o0.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,v,i.glInternalFmt,g,S,0,y):r.compressedTexSubImage2D(r.TEXTURE_2D,v,f.x,f.y,g,S,i.glFormat,y):r.texSubImage2D(r.TEXTURE_2D,v,f.x,f.y,g,S,i.glFormat,i.glType,y)}break;case r.TEXTURE_CUBE_MAP:for(var T=0;T<n.length;T++){var E=n[T],b=E.texSubres.mipLevel;f.x=0===E.texOffset.x?0:F_(E.texOffset.x,c.width),f.y=0===E.texOffset.y?0:F_(E.texOffset.y,c.height),_.width=E.texExtent.width<c.width?E.texExtent.width:F_(E.texExtent.width,c.width),_.height=E.texExtent.height<c.height?E.texExtent.width:F_(E.texExtent.height,c.height),d.width=E.buffStride>0?E.buffStride:_.width,d.height=E.buffTexHeight>0?E.buffTexHeight:_.height;var C=E.texExtent.width+f.x===i.width>>b?E.texExtent.width:_.width,R=E.texExtent.height+f.y===i.height>>b?E.texExtent.height:_.height,x=E.texSubres.baseArrayLayer+E.texSubres.layerCount;for(o=E.texSubres.baseArrayLayer;o<x;++o){var w,k=t[a++];w=d.width===_.width&&d.height===_.height?new h(k.buffer,k.byteOffset+E.buffOffset):W0(k,i.format,E.buffOffset,d,_),l?i.glInternalFmt===o0.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,b,i.glInternalFmt,C,R,0,w):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,b,f.x,f.y,C,R,i.glFormat,w):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,b,f.x,f.y,C,R,i.glFormat,i.glType,w)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Xl.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}function j0(e,t,i,n,r){e.blitManager.draw(t,i,n,r)}var q0=function(){function e(){n(this,e),this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}return s(e,[{key:"clearDraws",value:function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1}},{key:"setDrawInfo",value:function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)}},{key:"_ensureCapacity",value:function(e){if(!(this._capacity>e)){this._capacity=qi(e);var t=new Int32Array(this._capacity),i=new Int32Array(this._capacity),n=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),i.set(this.offsets),n.set(this.instances),this.counts=t,this.offsets=i,this.instances=n}}}]),e}(),Y0=function(){function e(){n(this,e),this._gpuShader=null,this._gpuDescriptorSetLayout=null,this._gpuPipelineLayout=null,this._gpuPipelineState=null,this._gpuVertexBuffer=null,this._gpuInputAssembler=null,this._gpuPointSampler=null,this._gpuLinearSampler=null,this._gpuDescriptorSet=null,this._gpuUniformBuffer=null,this._drawInfo=null,this._glFramebuffer=null,this._uniformBuffer=null;var t=h0.instance.gl,i=h0.instance.bindingMappingInfo.maxBlockCounts[0];this._gpuShader={name:"Blit Pass",blocks:[new Yc(0,0,"BlitParams",[new qc("tilingOffsetSrc",Fl.FLOAT4,1),new qc("tilingOffsetDst",Fl.FLOAT4,1)],1)],samplerTextures:[new Kc(0,i,"textureSrc",Fl.SAMPLER2D,1)],subpassInputs:[],gpuStages:[{type:ic.VERTEX,source:"\n                    precision mediump float;\n\n                    attribute vec2 a_position;\n                    attribute vec2 a_texCoord;\n            \n                    uniform vec4 tilingOffsetSrc;\n                    uniform vec4 tilingOffsetDst;\n            \n                    varying vec2 v_texCoord;\n            \n                    void main() {\n                        v_texCoord = a_texCoord * tilingOffsetSrc.xy + tilingOffsetSrc.zw;\n                        gl_Position = vec4((a_position + 1.0) * tilingOffsetDst.xy - 1.0 + tilingOffsetDst.zw * 2.0, 0, 1);\n                    }",glShader:null},{type:ic.FRAGMENT,source:"\n                    precision mediump float;\n                    uniform sampler2D textureSrc;\n\n                    varying vec2 v_texCoord;\n                    \n                    void main() {\n                        gl_FragColor = texture2D(textureSrc, v_texCoord);\n                    }",glShader:null}],glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]},P0(h0.instance,this._gpuShader),this._gpuDescriptorSetLayout={bindings:[new d_(0,dc.UNIFORM_BUFFER,1,ic.VERTEX),new d_(i,dc.SAMPLER_TEXTURE,1,ic.FRAGMENT)],dynamicBindings:[],descriptorIndices:[],descriptorCount:i+1};for(var r=0;r<i;r++)this._gpuDescriptorSetLayout.descriptorIndices[r]=0;this._gpuDescriptorSetLayout.descriptorIndices.push(1),this._gpuPipelineLayout={gpuSetLayouts:[this._gpuDescriptorSetLayout],dynamicOffsetCount:0,dynamicOffsetOffsets:[0],dynamicOffsetIndices:[[]]},this._gpuPipelineState={glPrimitive:t.TRIANGLE_STRIP,gpuShader:this._gpuShader,gpuPipelineLayout:this._gpuPipelineLayout,rs:null,dss:new J_(!1,!1),bs:null,dynamicStates:[],gpuRenderPass:null},this._gpuVertexBuffer={usage:Gl.VERTEX,memUsage:Hl.DEVICE,size:16*Float32Array.BYTES_PER_ELEMENT,stride:4*Float32Array.BYTES_PER_ELEMENT,buffer:null,vf32:null,indirects:new q0,glTarget:0,glBuffer:null},k0(h0.instance,this._gpuVertexBuffer),h0.instance.memoryStatus.bufferSize+=this._gpuVertexBuffer.size;var s=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]);B0(h0.instance,this._gpuVertexBuffer,s,0,s.length),this._gpuInputAssembler={attributes:[new i_("a_position",Ll.RG32F),new i_("a_texCoord",Ll.RG32F)],gpuVertexBuffers:[this._gpuVertexBuffer],gpuIndexBuffer:null,gpuIndirectBuffer:null,glAttribs:[],glIndexType:0,glVAOs:new Map},O0(h0.instance,this._gpuInputAssembler),this._gpuPointSampler={glMinFilter:9728,glMagFilter:9728,glWrapS:10497,glWrapT:10497,glWrapR:10497},this._gpuLinearSampler={glMinFilter:9729,glMagFilter:9729,glWrapS:10497,glWrapT:10497,glWrapR:10497},this._uniformBuffer=new Float32Array(8),this._gpuUniformBuffer={usage:Gl.UNIFORM,memUsage:Hl.DEVICE,size:8*Float32Array.BYTES_PER_ELEMENT,stride:8*Float32Array.BYTES_PER_ELEMENT,buffer:this._uniformBuffer,vf32:null,indirects:new q0,glTarget:0,glBuffer:null},k0(h0.instance,this._gpuUniformBuffer),h0.instance.memoryStatus.bufferSize+=this._gpuUniformBuffer.size,this._gpuDescriptorSet={gpuDescriptors:[{type:dc.UNIFORM_BUFFER,gpuBuffer:this._gpuUniformBuffer,gpuTexture:null,gpuSampler:null},{type:dc.SAMPLER_TEXTURE,gpuBuffer:null,gpuTexture:null,gpuSampler:null}],descriptorIndices:this._gpuDescriptorSetLayout.descriptorIndices},this._drawInfo=new Uc(4,0,0,0,0,0,0),this._glFramebuffer=h0.instance.gl.createFramebuffer()}return s(e,[{key:"destroy",value:function(){this._glFramebuffer&&(h0.instance.gl.deleteFramebuffer(this._glFramebuffer),this._glFramebuffer=null),this._gpuVertexBuffer&&(h0.instance.memoryStatus.bufferSize-=this._gpuVertexBuffer.size,I0(h0.instance,this._gpuVertexBuffer)),this._gpuUniformBuffer&&(h0.instance.memoryStatus.bufferSize-=this._gpuUniformBuffer.size,I0(h0.instance,this._gpuUniformBuffer)),this._gpuShader&&M0(h0.instance,this._gpuShader),this._gpuInputAssembler&&D0(h0.instance,this._gpuInputAssembler)}},{key:"draw",value:function(e,t,i,n){var r=h0.instance,s=r.gl,a=r.stateCache,o=a.glFramebuffer;if(s.viewport(0,0,t.width,t.height),s.scissor(0,0,t.width,t.height),this._uniformBuffer&&this._gpuUniformBuffer&&this._gpuPipelineState&&this._gpuInputAssembler&&this._gpuDescriptorSet&&this._drawInfo){var u=this._gpuDescriptorSet.gpuDescriptors[1];u.gpuTexture=e,u.gpuSampler=n===Kl.POINT?this._gpuPointSampler:this._gpuLinearSampler;var h=x_[t.format],l=s.COLOR_ATTACHMENT0;h.hasStencil?l=s.DEPTH_STENCIL_ATTACHMENT:h.hasDepth&&(l=s.DEPTH_ATTACHMENT);var c=i.map((function(e,t){return t}));c.sort((function(e,t){return i[e].srcSubres.mipLevel-i[t].srcSubres.mipLevel})),a.glFramebuffer!==this._glFramebuffer&&(r.gl.bindFramebuffer(r.gl.FRAMEBUFFER,this._glFramebuffer),a.glFramebuffer=this._glFramebuffer);var _=i[0].dstSubres.mipLevel;t.glTexture?s.framebufferTexture2D(s.FRAMEBUFFER,l,t.glTarget,t.glTexture,_):s.framebufferRenderbuffer(s.FRAMEBUFFER,l,s.RENDERBUFFER,t.glRenderbuffer);for(var f=0;f<c.length;++f){var d=i[c[f]];e.glTexture&&_!==d.srcSubres.mipLevel&&(_=d.srcSubres.mipLevel,s.framebufferTexture2D(s.FRAMEBUFFER,l,t.glTarget,t.glTexture,_));var m=e.width,p=e.height,v=t.width,y=t.height;this._uniformBuffer[0]=d.srcExtent.width/m,this._uniformBuffer[1]=d.srcExtent.height/p,this._uniformBuffer[2]=d.srcOffset.x/m,this._uniformBuffer[3]=d.srcOffset.y/p,this._uniformBuffer[4]=d.dstExtent.width/v,this._uniformBuffer[5]=d.dstExtent.height/y,this._uniformBuffer[6]=d.dstOffset.x/v,this._uniformBuffer[7]=d.dstOffset.y/y,B0(r,this._gpuUniformBuffer,this._uniformBuffer,0,this._uniformBuffer.length*Float32Array.BYTES_PER_ELEMENT),G0(r,this._gpuPipelineState,this._gpuInputAssembler,[this._gpuDescriptorSet],[],null),V0(r,this._drawInfo)}a.glFramebuffer!==o&&(r.gl.bindFramebuffer(r.gl.FRAMEBUFFER,o),a.glFramebuffer=o);var g=a.viewport;s.viewport(g.left,g.top,g.width,g.height);var S=a.scissorRect;s.scissor(S.x,S.y,S.width,S.height)}}}]),e}(),K0=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}return s(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}},{key:"initialize",value:function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&Gl.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new q0,glTarget:0,glBuffer:null},this._usage&Gl.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),k0(h0.instance,this._gpuBuffer),h0.instance.memoryStatus.bufferSize+=this._size}},{key:"destroy",value:function(){this._gpuBuffer&&(I0(h0.instance,this._gpuBuffer),h0.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)}},{key:"resize",value:function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Hl.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&Gl.VERTEX?(e.extensions.useVAO&&n.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),L0.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&Gl.INDEX?(e.extensions.useVAO&&n.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),L0.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Gl.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&Gl.INDIRECT||t.usage&Gl.TRANSFER_DST||t.usage&Gl.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=i.NONE)}(h0.instance,this._gpuBuffer),h0.instance.memoryStatus.bufferSize-=t,h0.instance.memoryStatus.bufferSize+=e)))}}},{key:"update",value:function(e,t){var i;this._isBufferView?console.warn("cannot update through buffer views!"):(i=void 0!==t?t:this._usage&Gl.INDIRECT?0:e.byteLength,B0(h0.instance,this._gpuBuffer,e,0,i))}}]),i}(V_),Q0=function(){function e(t,i){n(this,e),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(i),this._freeCmds=new Ch(i);for(var r=0;r<i;++r)this._frees[r]=new t;this._freeIdx=i-1}return s(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var s=n,a=0;s<t;++s,++a)this._frees[s]=i[a];this._freeIdx+=n}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),J0=function(){function e(){n(this,e),this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.blitTextureCmdPool=void 0,this.beginRenderPassCmdPool=new Q0(T0,1),this.bindStatesCmdPool=new Q0(E0,1),this.drawCmdPool=new Q0(b0,1),this.updateBufferCmdPool=new Q0(C0,1),this.copyBufferToTextureCmdPool=new Q0(R0,1),this.blitTextureCmdPool=new Q0(x0,1)}return s(e,[{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.blitTextureCmds.length&&(this.blitTextureCmdPool.freeCmds(e.blitTextureCmds),e.blitTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release(),this.blitTextureCmdPool.release()}}]),e}(),Z0=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).cmdPackage=new w0,e._cmdAllocator=new J0,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new C_,e._isStateInvalied=!1,e}return s(i,[{key:"initialize",value:function(e){this._type=e.type,this._queue=e.queue;for(var t=h0.instance.bindingMappings.blockOffsets.length,i=0;i<t;i++)this._curGPUDescriptorSets.push(null)}},{key:"destroy",value:function(){this._cmdAllocator.clearCmds(this.cmdPackage)}},{key:"begin",value:function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,s){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(T0);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea.copy(i),a.clearColors.length=n.length;for(var o=0;o<n.length;++o)a.clearColors[o]=n[o];a.clearDepth=r,a.clearStencil=s,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(p0.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}},{key:"bindDescriptorSet",value:function(e,t,i){var n=t.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=n,this._isStateInvalied=!0),i){var r,s=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(s){for(var a=this._curDynamicOffsets,o=s.dynamicOffsetOffsets[e],u=0;u<i.length;u++)a[o+u]=i[u];this._isStateInvalied=!0}}}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)}},{key:"setLineWidth",value:function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){var n=this._curDynamicStates;n.depthBiasConstant===e&&n.depthBiasClamp===t&&n.depthBiasSlope===i||(n.depthBiasConstant=e,n.depthBiasClamp=t,n.depthBiasSlope=i,this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){var i=this._curDynamicStates;i.depthMinBounds===e&&i.depthMaxBounds===t||(i.depthMinBounds=e,i.depthMaxBounds=t,this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){var i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;e&fc.FRONT&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0),e&fc.BACK&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){var n=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&fc.FRONT&&(n.compareMask===i&&n.reference===t||(n.reference=t,n.compareMask=i,this._isStateInvalied=!0)),e&fc.BACK&&(r.compareMask===i&&r.reference===t||(r.reference=t,r.compareMask=i,this._isStateInvalied=!0))}},{key:"draw",value:function(e){if(this._type===vc.PRIMARY&&this._isInRenderPass||this._type===vc.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,i=this._cmdAllocator.drawCmdPool.alloc(b0);i.drawInfo.copy(t),this.cmdPackage.drawCmds.push(i),this.cmdPackage.cmds.push(p0.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i){if(this._type===vc.PRIMARY&&!this._isInRenderPass||this._type===vc.SECONDARY){var n=e.gpuBuffer;if(n){var r,s=this._cmdAllocator.updateBufferCmdPool.alloc(C0),a=0;e.usage&Gl.INDIRECT||(a=void 0!==i?i:t.byteLength),r=t,s.gpuBuffer=n,s.buffer=r,s.offset=0,s.size=a,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(p0.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBuffersToTexture",value:function(e,t,i){if(this._type===vc.PRIMARY&&!this._isInRenderPass||this._type===vc.SECONDARY){var n=t.gpuTexture;if(n){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(R0);r&&(r.gpuTexture=n,r.regions=i,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(p0.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var s=n.cmdPackage.beginRenderPassCmds.array[r];++s.refCount,this.cmdPackage.beginRenderPassCmds.push(s)}for(var a=0;a<n.cmdPackage.bindStatesCmds.length;++a){var o=n.cmdPackage.bindStatesCmds.array[a];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var u=0;u<n.cmdPackage.drawCmds.length;++u){var h=n.cmdPackage.drawCmds.array[u];++h.refCount,this.cmdPackage.drawCmds.push(h)}for(var l=0;l<n.cmdPackage.updateBufferCmds.length;++l){var c=n.cmdPackage.updateBufferCmds.array[l];++c.refCount,this.cmdPackage.updateBufferCmds.push(c)}for(var _=0;_<n.cmdPackage.copyBufferToTextureCmds.length;++_){var f=n.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}for(var d=0;d<n.cmdPackage.blitTextureCmds.length;++d){var m=n.cmdPackage.blitTextureCmds.array[d];++m.refCount,this.cmdPackage.blitTextureCmds.push(m)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"pipelineBarrier",value:function(){}},{key:"bindStates",value:function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(E0);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(p0.BIND_STATES),this._isStateInvalied=!1)}},{key:"blitTexture",value:function(e,t,i,n){var r=this._cmdAllocator.blitTextureCmdPool.alloc(x0);r.srcTexture=e.gpuTexture,r.dstTexture=t.gpuTexture,r.regions=i,r.filter=n,++this._numDrawCalls,this.cmdPackage.blitTextureCmds.push(r),this.cmdPackage.cmds.push(p0.BLIT_TEXTURE)}}]),i}(U_),$0=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuFramebuffer=null,e}return s(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}},{key:"initialize",value:function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=0,i=[],n=0;n<e.colorTextures.length;++n){var r=e.colorTextures[n];r&&(i.push(r.gpuTexture),t=r.lodLevel)}var s=null;e.depthStencilTexture&&(s=e.depthStencilTexture.gpuTexture,t=e.depthStencilTexture.lodLevel);var a=Number.MAX_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:i,gpuDepthStencilTexture:s,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorTextures[0].width},set width(e){a=e},get height(){return this.isOffscreen?o:this.gpuColorTextures[0].height},set height(e){o=e},lodLevel:t},function(e,t){for(var i=0;i<t.gpuColorTextures.length;++i)if(t.gpuColorTextures[i].isSwapchainTexture)return void(t.isOffscreen=!1);var n=e.gl,r=[],s=n.createFramebuffer();if(s){t.glFramebuffer=s,e.stateCache.glFramebuffer!==t.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var o=t.gpuColorTextures[a];o&&(o.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+a,o.glTarget,o.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+a,n.RENDERBUFFER,o.glRenderbuffer),r.push(n.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,o.width),t.height=Math.min(t.height,o.height))}var u=t.gpuDepthStencilTexture;if(u){var h=x_[u.format].hasStencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;u.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,h,u.glTarget,u.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,h,n.RENDERBUFFER,u.glRenderbuffer),t.width=Math.min(t.width,u.width),t.height=Math.min(t.height,u.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var l=n.checkFramebufferStatus(n.FRAMEBUFFER);if(l!==n.FRAMEBUFFER_COMPLETE)switch(l){case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case n.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(h0.instance,this._gpuFramebuffer)}},{key:"destroy",value:function(){var e,t;this._gpuFramebuffer&&(e=h0.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)}}]),i}(X_),e1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuInputAssembler=null,e}return s(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}},{key:"initialize",value:function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var s=null,a=0;if(e.indexBuffer&&(s=e.indexBuffer.gpuBuffer))switch(s.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var o=null;e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:s,gpuIndirectBuffer:o,glAttribs:[],glIndexType:a,glVAOs:new Map},O0(h0.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")}},{key:"destroy",value:function(){var e=h0.instance;this._gpuInputAssembler&&e.extensions.useVAO&&D0(e,this._gpuInputAssembler),this._gpuInputAssembler=null}}]),i}(j_),t1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuDescriptorSetLayout=null,e}return s(i,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}},{key:"initialize",value:function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,i=-1,n=[],r=0;r<this._bindings.length;r++){var s=this._bindings[r];n.push(t),t+=s.count,s.binding>i&&(i=s.binding)}this._bindingIndices=Array(i+1).fill(-1);for(var a=this._descriptorIndices=Array(i+1).fill(-1),o=0;o<this._bindings.length;o++){var u=this._bindings[o];this._bindingIndices[u.binding]=o,a[u.binding]=n[o]}for(var h=[],l=0;l<this._bindings.length;l++){var c=this._bindings[l];if(c.descriptorType&I_)for(var _=0;_<c.count;_++)h.push(c.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:h,descriptorIndices:a,descriptorCount:t}}},{key:"destroy",value:function(){this._bindings.length=0}}]),i}(Y_),i1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuPipelineLayout=null,e}return s(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}},{key:"initialize",value:function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],i=[],n=0,r=[],s=0;s<this._setLayouts.length;s++){for(var a=this._setLayouts[s],o=a.gpuDescriptorSetLayout.dynamicBindings,u=Array(a.bindingIndices.length).fill(-1),h=0;h<o.length;h++){var l=o[h];u[l]<0&&(u[l]=n+h)}i.push(a.gpuDescriptorSetLayout),t.push(u),r.push(n),n+=o.length}this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:t,dynamicOffsetCount:n,dynamicOffsetOffsets:r}}},{key:"destroy",value:function(){this._setLayouts.length=0}}]),i}(K_),n1=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],r1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuPipelineState=null,e}return s(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}},{key:"initialize",value:function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var i=e.blendState,n=i.targets;n&&n.forEach((function(e,i){t.setTarget(i,e)})),void 0!==i.isA2C&&(t.isA2C=i.isA2C),void 0!==i.isIndepend&&(t.isIndepend=i.isIndepend),void 0!==i.blendColor&&(t.blendColor=i.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],s=0;s<31;s++)this._dynamicStates&1<<s&&r.push(1<<s);this._gpuPipelineState={glPrimitive:n1[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}}},{key:"destroy",value:function(){this._gpuPipelineState=null}}]),i}(tf),s1=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"beginRenderPass",value:function(e,t,i,n,r,s){F0(h0.instance,e.gpuRenderPass,t.gpuFramebuffer,i,n,r,s),this._isInRenderPass=!0}},{key:"draw",value:function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;V0(h0.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"setViewport",value:function(e){var t=h0.instance,i=t.stateCache,n=t.gl;i.viewport.left===e.left&&i.viewport.top===e.top&&i.viewport.width===e.width&&i.viewport.height===e.height||(n.viewport(e.left,e.top,e.width,e.height),i.viewport.left=e.left,i.viewport.top=e.top,i.viewport.width=e.width,i.viewport.height=e.height)}},{key:"setScissor",value:function(e){var t=h0.instance,i=t.stateCache,n=t.gl;i.scissorRect.x===e.x&&i.scissorRect.y===e.y&&i.scissorRect.width===e.width&&i.scissorRect.height===e.height||(n.scissor(e.x,e.y,e.width,e.height),i.scissorRect.x=e.x,i.scissorRect.y=e.y,i.scissorRect.width=e.width,i.scissorRect.height=e.height)}},{key:"updateBuffer",value:function(e,t,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var n,r=e.gpuBuffer;r&&(n=void 0!==i?i:e.usage&Gl.INDIRECT?0:t.byteLength,B0(h0.instance,r,t,0,n))}}},{key:"copyBuffersToTexture",value:function(e,t,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var n=t.gpuTexture;n&&X0(h0.instance,e,n,i)}}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){var n=e[i];H0(h0.instance,n.cmdPackage),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){G0(h0.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}},{key:"blitTexture",value:function(e,t,i,n){var r=e.gpuTexture,s=t.gpuTexture;j0(h0.instance,r,s,i,n)}}]),i}(Z0),a1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}return s(i,[{key:"initialize",value:function(e){this._type=e.type}},{key:"destroy",value:function(){}},{key:"submit",value:function(e){for(var t=e.length,i=0;i<t;i++){var n=e[i];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}]),i}(nf),o1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuRenderPass=null,e}return s(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}},{key:"initialize",value:function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()}},{key:"destroy",value:function(){this._gpuRenderPass=null}}]),i}(rf),u1=[10497,33648,33071,33071],h1=function(e){h(i,e);var t=v(i);function i(e,r){var s;n(this,i),(s=t.call(this,e,r))._gpuSampler=null;var a,o,u=s._info.minFilter,h=s._info.magFilter,l=s._info.mipFilter;a=u===Kl.LINEAR||u===Kl.ANISOTROPIC?l===Kl.LINEAR||l===Kl.ANISOTROPIC?9987:l===Kl.POINT?9985:9729:l===Kl.LINEAR||l===Kl.ANISOTROPIC?9986:l===Kl.POINT?9984:9728,o=h===Kl.LINEAR||h===Kl.ANISOTROPIC?9729:9728;var c=u1[s._info.addressU],_=u1[s._info.addressV],f=u1[s._info.addressW];return s._gpuSampler={glMinFilter:a,glMagFilter:o,glWrapS:c,glWrapT:_,glWrapR:f},s}return s(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),i}(sf),l1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuShader=null,e}return s(i,[{key:"gpuShader",get:function(){return null===this._gpuShader.glProgram&&P0(h0.instance,this._gpuShader),this._gpuShader}},{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.stage,source:i.source,glShader:null}}}},{key:"destroy",value:function(){this._gpuShader&&(M0(h0.instance,this._gpuShader),this._gpuShader=null)}}]),i}(af),c1=function(){function e(){n(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new Oc,this.scissorRect=new xc(0,0,0,0),this.rs=new Q_,this.dss=new J_,this.bs=new $_,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return s(e,[{key:"initialize",value:function(e,t){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)}}]),e}(),_1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuTexture=null,e._lodLevel=0,e}return s(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}},{key:"initialize",value:function(e,t){var i=e,n=e;"texture"in e&&(i=n.texture.info,this._isTextureView=!0),this._info.copy(i),this._isPowerOf2=B_(this._info.width)&&B_(this._info.height),this._size=M_(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(n),this._lodLevel=n.baseLevel,this._gpuTexture=n.texture._gpuTexture):(this._gpuTexture={type:i.type,format:i.format,usage:i.usage,width:i.width,height:i.height,depth:i.depth,size:this._size,arrayLayer:i.layerCount,mipLevel:i.levelCount,samples:i.samples,flags:i.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},this._gpuTexture.isSwapchainTexture||(function(e,t){var i=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case Ll.A8:return t.ALPHA;case Ll.L8:return t.LUMINANCE;case Ll.LA8:return t.LUMINANCE_ALPHA;case Ll.RGB8:case Ll.RGB16F:case Ll.RGB32F:return t.RGB;case Ll.BGRA8:case Ll.RGBA8:case Ll.SRGB8_A8:case Ll.RGBA16F:case Ll.RGBA32F:return t.RGBA;case Ll.R5G6B5:return t.RGB;case Ll.RGB5A1:case Ll.RGBA4:return t.RGBA;case Ll.DEPTH:return t.DEPTH_COMPONENT;case Ll.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Ll.BC1:return o0.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ll.BC1_ALPHA:return o0.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ll.BC1_SRGB:return o0.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ll.BC1_SRGB_ALPHA:return o0.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ll.BC2:return o0.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ll.BC2_SRGB:return o0.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ll.BC3:return o0.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ll.BC3_SRGB:return o0.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ll.ETC_RGB8:return o0.COMPRESSED_RGB_ETC1_WEBGL;case Ll.ETC2_RGB8:return o0.COMPRESSED_RGB8_ETC2;case Ll.ETC2_SRGB8:return o0.COMPRESSED_SRGB8_ETC2;case Ll.ETC2_RGB8_A1:return o0.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ll.ETC2_SRGB8_A1:return o0.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ll.ETC2_RGBA8:return o0.COMPRESSED_RGBA8_ETC2_EAC;case Ll.ETC2_SRGB8_A8:return o0.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ll.EAC_R11:return o0.COMPRESSED_R11_EAC;case Ll.EAC_R11SN:return o0.COMPRESSED_SIGNED_R11_EAC;case Ll.EAC_RG11:return o0.COMPRESSED_RG11_EAC;case Ll.EAC_RG11SN:return o0.COMPRESSED_SIGNED_RG11_EAC;case Ll.PVRTC_RGB2:return o0.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ll.PVRTC_RGBA2:return o0.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ll.PVRTC_RGB4:return o0.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ll.PVRTC_RGBA4:return o0.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Ll.ASTC_RGBA_4X4:return o0.COMPRESSED_RGBA_ASTC_4x4_KHR;case Ll.ASTC_RGBA_5X4:return o0.COMPRESSED_RGBA_ASTC_5x4_KHR;case Ll.ASTC_RGBA_5X5:return o0.COMPRESSED_RGBA_ASTC_5x5_KHR;case Ll.ASTC_RGBA_6X5:return o0.COMPRESSED_RGBA_ASTC_6x5_KHR;case Ll.ASTC_RGBA_6X6:return o0.COMPRESSED_RGBA_ASTC_6x6_KHR;case Ll.ASTC_RGBA_8X5:return o0.COMPRESSED_RGBA_ASTC_8x5_KHR;case Ll.ASTC_RGBA_8X6:return o0.COMPRESSED_RGBA_ASTC_8x6_KHR;case Ll.ASTC_RGBA_8X8:return o0.COMPRESSED_RGBA_ASTC_8x8_KHR;case Ll.ASTC_RGBA_10X5:return o0.COMPRESSED_RGBA_ASTC_10x5_KHR;case Ll.ASTC_RGBA_10X6:return o0.COMPRESSED_RGBA_ASTC_10x6_KHR;case Ll.ASTC_RGBA_10X8:return o0.COMPRESSED_RGBA_ASTC_10x8_KHR;case Ll.ASTC_RGBA_10X10:return o0.COMPRESSED_RGBA_ASTC_10x10_KHR;case Ll.ASTC_RGBA_12X10:return o0.COMPRESSED_RGBA_ASTC_12x10_KHR;case Ll.ASTC_RGBA_12X12:return o0.COMPRESSED_RGBA_ASTC_12x12_KHR;case Ll.ASTC_SRGBA_4X4:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Ll.ASTC_SRGBA_5X4:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Ll.ASTC_SRGBA_5X5:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Ll.ASTC_SRGBA_6X5:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Ll.ASTC_SRGBA_6X6:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Ll.ASTC_SRGBA_8X5:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Ll.ASTC_SRGBA_8X6:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Ll.ASTC_SRGBA_8X8:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Ll.ASTC_SRGBA_10X5:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Ll.ASTC_SRGBA_10X6:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Ll.ASTC_SRGBA_10X8:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Ll.ASTC_SRGBA_10X10:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Ll.ASTC_SRGBA_12X10:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Ll.ASTC_SRGBA_12X12:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,i),t.glType=l0(t.format,i);var n=t.width,r=t.height;switch(t.type){case zl.TEX2D:t.glTarget=i.TEXTURE_2D;var s=Math.max(n,r);if(s>e.capabilities.maxTextureSize&&ue(9100,s,e.capabilities.maxTextureSize),e.textureExclusive[t.format]||e.extensions.WEBGL_depth_texture||!x_[t.format].hasDepth){if(t.glTexture=i.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),x_[t.format].isCompressed)for(var o=0;o<t.mipLevel;++o){var u=P_(t.format,n,r,1),h=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternalFmt,n,r,0,h),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else for(var l=0;l<t.mipLevel;++l)i.texImage2D(i.TEXTURE_2D,l,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}}else t.glInternalFmt=function(e,t){switch(e){case Ll.R5G6B5:return t.RGB565;case Ll.RGB5A1:return t.RGB5_A1;case Ll.RGBA4:return t.RGBA4;case Ll.RGBA16F:return o0.RGBA16F_EXT;case Ll.RGBA32F:return o0.RGBA32F_EXT;case Ll.SRGB8_A8:return o0.SRGB8_ALPHA8_EXT;case Ll.DEPTH:return t.DEPTH_COMPONENT16;case Ll.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,i),t.glRenderbuffer=i.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,t.glInternalFmt,n,r));break;case zl.CUBE:t.glTarget=i.TEXTURE_CUBE_MAP;var c=Math.max(n,r);if(c>e.capabilities.maxCubeMapTextureSize&&ue(9100,c,e.capabilities.maxTextureSize),t.glTexture=i.createTexture(),t.size>0){var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),x_[t.format].isCompressed)for(var f=0;f<6;++f){n=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var m=P_(t.format,n,r,1),p=new Uint8Array(m);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,n,r,0,p),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+v,y,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=zl.TEX2D,t.glTarget=i.TEXTURE_2D}}(h0.instance,this._gpuTexture),h0.instance.memoryStatus.textureSize+=this._size),this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount)}},{key:"destroy",value:function(){!this._isTextureView&&this._gpuTexture&&(function(e,t){var i=e.gl;if(t.glTexture){var n=e.stateCache.glTexUnits,r=e.stateCache.texUnit;i.deleteTexture(t.glTexture);for(var s=0;s<n.length;s++)n[s].glTexture===t.glTexture&&(i.activeTexture(i.TEXTURE0+s),r=s,i.bindTexture(t.glTarget,null),n[s].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;i.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}(h0.instance,this._gpuTexture),h0.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}},{key:"getGLTextureHandle",value:function(){var e=this._gpuTexture;return e?e.glTexture?e.glTexture:e.glRenderbuffer?e.glRenderbuffer:0:0}},{key:"resize",value:function(e,t){if(this._info.width!==e||this._info.height!==t){this._info.levelCount===i.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=i.getLevelCount(e,t):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,i.getLevelCount(e,t)));var n=this._size;this._info.width=e,this._info.height=t,this._size=M_(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,this._gpuTexture.isSwapchainTexture||(function(e,t){if(t.size){var i=e.gl,n=t.width,r=t.height;switch(t.type){case zl.TEX2D:t.glTarget=i.TEXTURE_2D;var s=Math.max(n,r);if(s>e.capabilities.maxTextureSize&&ue(9100,s,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,t.glInternalFmt,n,r);else if(t.glTexture){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),x_[t.format].isCompressed)for(var o=0;o<t.mipLevel;++o){var u=P_(t.format,n,r,1),h=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternalFmt,n,r,0,h),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else for(var l=0;l<t.mipLevel;++l)i.texImage2D(i.TEXTURE_2D,l,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;case zl.CUBE:t.glTarget=i.TEXTURE_CUBE_MAP;var c=Math.max(n,r);c>e.capabilities.maxCubeMapTextureSize&&ue(9100,c,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),x_[t.format].isCompressed)for(var f=0;f<6;++f){n=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var m=P_(t.format,n,r,1),p=new Uint8Array(m);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,n,r,0,p),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+v,y,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=zl.TEX2D,t.glTarget=i.TEXTURE_2D}}}(h0.instance,this._gpuTexture),h0.instance.memoryStatus.textureSize-=n,h0.instance.memoryStatus.textureSize+=this._size))}}},{key:"initAsSwapchainTexture",value:function(e){var t=new Wc;t.format=e.format,t.usage=x_[e.format].hasDepth?Wl.DEPTH_STENCIL_ATTACHMENT:Wl.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)}}]),i}(of),f1="webglcontextlost";function d1(e,t){for(var i=["","WEBKIT_","MOZ_"],n=0;n<i.length;++n){var r=e.getExtension(i[n]+t);if(r)return r}return null}function m1(e){var t={EXT_texture_filter_anisotropic:d1(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:d1(e,"EXT_blend_minmax"),EXT_frag_depth:d1(e,"EXT_frag_depth"),EXT_shader_texture_lod:d1(e,"EXT_shader_texture_lod"),EXT_sRGB:d1(e,"EXT_sRGB"),OES_vertex_array_object:d1(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:d1(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:d1(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:d1(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:d1(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:d1(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:d1(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:d1(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:d1(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:d1(e,"WEBGL_draw_buffers"),WEBGL_lose_context:d1(e,"WEBGL_lose_context"),WEBGL_depth_texture:d1(e,"WEBGL_depth_texture"),OES_texture_half_float:d1(e,"OES_texture_half_float"),OES_texture_half_float_linear:d1(e,"OES_texture_half_float_linear"),OES_texture_float:d1(e,"OES_texture_float"),OES_texture_float_linear:d1(e,"OES_texture_float_linear"),OES_standard_derivatives:d1(e,"OES_standard_derivatives"),OES_element_index_uint:d1(e,"OES_element_index_uint"),ANGLE_instanced_arrays:d1(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:d1(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return Qh.os===jh.IOS&&14===Qh.osMainVersion&&Qh.isBrowser||(t.WEBGL_compressed_texture_astc=d1(e,"WEBGL_compressed_texture_astc")),Qh.os!==jh.ANDROID&&Qh.os!==jh.IOS&&(t.WEBGL_multi_draw=d1(e,"WEBGL_multi_draw")),Qh.browserType===zh.UC&&(t.ANGLE_instanced_arrays=null),Qh.os===jh.IOS&&Qh.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var p1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).stateCache=new c1,e.cmdAllocator=new J0,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e._blitManager=null,e}return s(i,[{key:"extensions",get:function(){return this._extensions}},{key:"blitManager",get:function(){return this._blitManager}},{key:"initialize",value:function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(f1,this._onWebGLContextLost);var t=h0.instance.gl;this.stateCache.initialize(h0.instance.capabilities.maxTextureUnits,h0.instance.capabilities.maxVertexAttributes),this._extensions=m1(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var i=Ll.RGBA8,n=Ll.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),s=t.getParameter(t.STENCIL_BITS);r&&s?n=Ll.DEPTH_STENCIL:r&&(n=Ll.DEPTH),this._colorTexture=new _1,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this._depthStencilTexture=new _1,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this.nullTex2D=h0.instance.createTexture(new Wc(zl.TEX2D,Wl.SAMPLED,Ll.RGBA8,2,2,Xl.GEN_MIPMAP)),this.nullTexCube=h0.instance.createTexture(new Wc(zl.CUBE,Wl.SAMPLED,Ll.RGBA8,2,2,Xl.GEN_MIPMAP,6));var a=new Mc;a.texExtent.width=2,a.texExtent.height=2;var o=new Uint8Array(this.nullTex2D.size);o.fill(0),h0.instance.copyBuffersToTexture([o],this.nullTex2D,[a]),a.texSubres.layerCount=6,h0.instance.copyBuffersToTexture([o,o,o,o,o,o],this.nullTexCube,[a]),this._blitManager=new Y0}},{key:"destroy",value:function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(f1,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._blitManager&&(this._blitManager.destroy(),this._blitManager=null),this._extensions=null,this._canvas=null}},{key:"resize",value:function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||($("Resizing swapchain: ".concat(e,"x").concat(t)),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))}},{key:"_onWebGLContextLost",value:function(e){ae(11e3),Q(e)}}]),i}(W_),v1=e("WebGLDevice",function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._swapchain=null,e._context=null,e._bindingMappings=null,e._textureExclusive=new Array(Ll.COUNT),e}return s(i,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}},{key:"blitManager",get:function(){return this._swapchain.blitManager}},{key:"initialize",value:function(e){h0.setInstance(this),this._gfxAPI=Ml.WEBGL;var t=this._bindingMappingInfo=e.bindingMappingInfo,i=[],n=[],r=t.setIndices[0];i[r]=0,n[r]=0;for(var s=1;s<t.setIndices.length;++s){var a=t.setIndices[s],o=t.setIndices[s-1];i[a]=t.maxBlockCounts[o]+i[o],n[a]=t.maxSamplerTextureCounts[o]+n[o]}for(var u=0;u<t.setIndices.length;++u){var h=t.setIndices[u];n[h]-=t.maxBlockCounts[h]}this._bindingMappings={blockOffsets:i,samplerTextureOffsets:n,flexibleSet:t.setIndices[t.setIndices.length-1]};var l=this._context=function(e){var t=null;try{var i={alpha:Lt.ENABLE_TRANSPARENT_CANVAS,antialias:Lt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",i)}catch(e){return null}return t}(H_.canvas);if(!l)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new S_(mc.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new g_(this._queue)),this._caps.maxVertexAttributes=l.getParameter(l.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=l.getParameter(l.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=l.getParameter(l.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=l.getParameter(l.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=l.getParameter(l.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=l.getParameter(l.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxArrayTextureLayers=0,this._caps.max3DTextureSize=0,this._caps.maxUniformBufferBindings=16;var c=l.getSupportedExtensions(),_="";if(c)for(var f,d=R(c);!(f=d()).done;){var m=f.value;_+="".concat(m," ")}var p=m1(l);p.WEBGL_debug_renderer_info?(this._renderer=l.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=l.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=l.getParameter(l.RENDERER),this._vendor=l.getParameter(l.VENDOR));var v=l.getParameter(l.VERSION);this._features.fill(!1),this.initFormatFeatures(p),p.EXT_blend_minmax&&(this._features[Dl.BLEND_MINMAX]=!0),p.OES_element_index_uint&&(this._features[Dl.ELEMENT_INDEX_UINT]=!0),p.ANGLE_instanced_arrays&&(this._features[Dl.INSTANCED_ARRAYS]=!0),p.WEBGL_draw_buffers&&(this._features[Dl.MULTIPLE_RENDER_TARGETS]=!0);var y="";return this.getFormatFeatures(Ll.ETC_RGB8)&&(y+="etc1 "),this.getFormatFeatures(Ll.ETC2_RGB8)&&(y+="etc2 "),this.getFormatFeatures(Ll.BC1)&&(y+="dxt "),this.getFormatFeatures(Ll.PVRTC_RGB2)&&(y+="pvrtc "),this.getFormatFeatures(Ll.ASTC_RGBA_4X4)&&(y+="astc "),$("WebGL device initialized."),$("RENDERER: ".concat(this._renderer)),$("VENDOR: ".concat(this._vendor)),$("VERSION: ".concat(v)),$("COMPRESSED_FORMAT: ".concat(y)),$("EXTENSIONS: ".concat(_)),!0}},{key:"destroy",value:function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._swapchain=null}},{key:"flushCommands",value:function(){}},{key:"acquire",value:function(){}},{key:"present",value:function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}},{key:"initFormatFeatures",value:function(e){this._formatFeatures.fill(jl.NONE),this._textureExclusive.fill(!0);var t=jl.RENDER_TARGET|jl.SAMPLED_TEXTURE|jl.LINEAR_FILTER;this._formatFeatures[Ll.RGB8]=t,this._formatFeatures[Ll.R5G6B5]=t,this._textureExclusive[Ll.R5G6B5]=!1,this._formatFeatures[Ll.RGBA8]=t,this._formatFeatures[Ll.RGBA4]=t,this._textureExclusive[Ll.RGBA4]=!1,this._formatFeatures[Ll.RGB5A1]=t,this._textureExclusive[Ll.RGB5A1]=!1,this._formatFeatures[Ll.DEPTH]=jl.RENDER_TARGET,this._textureExclusive[Ll.DEPTH]=!1,this._formatFeatures[Ll.DEPTH_STENCIL]=jl.RENDER_TARGET,this._textureExclusive[Ll.DEPTH_STENCIL]=!1,this._formatFeatures[Ll.R8I]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RG8I]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGB8I]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGBA8I]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.R8UI]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RG8UI]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGB8UI]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGBA8UI]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.R8I]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RG8I]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGB8I]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGBA8I]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.R8UI]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RG8UI]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGB8UI]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGBA8UI]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.R32F]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RG32F]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGB32F]|=jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.RGBA32F]|=jl.VERTEX_ATTRIBUTE,e.EXT_sRGB&&(this._formatFeatures[Ll.SRGB8]=t,this._formatFeatures[Ll.SRGB8_A8]=t,this._textureExclusive[Ll.SRGB8_A8]=!1),e.WEBGL_depth_texture&&(this._formatFeatures[Ll.DEPTH]|=t,this._formatFeatures[Ll.DEPTH_STENCIL]|=t),e.WEBGL_color_buffer_float&&(this._formatFeatures[Ll.RGB32F]|=jl.RENDER_TARGET,this._formatFeatures[Ll.RGBA32F]|=jl.RENDER_TARGET,this._textureExclusive[Ll.RGB32F]=!1,this._textureExclusive[Ll.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._formatFeatures[Ll.RGB16F]|=jl.RENDER_TARGET,this._formatFeatures[Ll.RGBA16F]|=jl.RENDER_TARGET,this._textureExclusive[Ll.RGB16F]=!1,this._textureExclusive[Ll.RGBA16F]=!1),e.OES_texture_float&&(this._formatFeatures[Ll.RGB32F]|=jl.RENDER_TARGET|jl.SAMPLED_TEXTURE,this._formatFeatures[Ll.RGBA32F]|=jl.RENDER_TARGET|jl.SAMPLED_TEXTURE),e.OES_texture_half_float&&(this._formatFeatures[Ll.RGB16F]|=jl.RENDER_TARGET|jl.SAMPLED_TEXTURE,this._formatFeatures[Ll.RGBA16F]|=jl.RENDER_TARGET|jl.SAMPLED_TEXTURE),e.OES_texture_float_linear&&(this._formatFeatures[Ll.RGB32F]|=jl.LINEAR_FILTER,this._formatFeatures[Ll.RGBA32F]|=jl.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[Ll.RGB16F]|=jl.LINEAR_FILTER,this._formatFeatures[Ll.RGBA16F]|=jl.LINEAR_FILTER);var i=jl.SAMPLED_TEXTURE|jl.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[Ll.ETC_RGB8]=i),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[Ll.ETC2_RGB8]=i,this._formatFeatures[Ll.ETC2_RGBA8]=i,this._formatFeatures[Ll.ETC2_SRGB8]=i,this._formatFeatures[Ll.ETC2_SRGB8_A8]=i,this._formatFeatures[Ll.ETC2_RGB8_A1]=i,this._formatFeatures[Ll.ETC2_SRGB8_A1]=i),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[Ll.BC1]=i,this._formatFeatures[Ll.BC1_ALPHA]=i,this._formatFeatures[Ll.BC1_SRGB]=i,this._formatFeatures[Ll.BC1_SRGB_ALPHA]=i,this._formatFeatures[Ll.BC2]=i,this._formatFeatures[Ll.BC2_SRGB]=i,this._formatFeatures[Ll.BC3]=i,this._formatFeatures[Ll.BC3_SRGB]=i),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[Ll.PVRTC_RGB2]|=i,this._formatFeatures[Ll.PVRTC_RGBA2]|=i,this._formatFeatures[Ll.PVRTC_RGB4]|=i,this._formatFeatures[Ll.PVRTC_RGBA4]|=i),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[Ll.ASTC_RGBA_4X4]|=i,this._formatFeatures[Ll.ASTC_RGBA_5X4]|=i,this._formatFeatures[Ll.ASTC_RGBA_5X5]|=i,this._formatFeatures[Ll.ASTC_RGBA_6X5]|=i,this._formatFeatures[Ll.ASTC_RGBA_6X6]|=i,this._formatFeatures[Ll.ASTC_RGBA_8X5]|=i,this._formatFeatures[Ll.ASTC_RGBA_8X6]|=i,this._formatFeatures[Ll.ASTC_RGBA_8X8]|=i,this._formatFeatures[Ll.ASTC_RGBA_10X5]|=i,this._formatFeatures[Ll.ASTC_RGBA_10X6]|=i,this._formatFeatures[Ll.ASTC_RGBA_10X8]|=i,this._formatFeatures[Ll.ASTC_RGBA_10X10]|=i,this._formatFeatures[Ll.ASTC_RGBA_12X10]|=i,this._formatFeatures[Ll.ASTC_RGBA_12X12]|=i,this._formatFeatures[Ll.ASTC_SRGBA_4X4]|=i,this._formatFeatures[Ll.ASTC_SRGBA_5X4]|=i,this._formatFeatures[Ll.ASTC_SRGBA_5X5]|=i,this._formatFeatures[Ll.ASTC_SRGBA_6X5]|=i,this._formatFeatures[Ll.ASTC_SRGBA_6X6]|=i,this._formatFeatures[Ll.ASTC_SRGBA_8X5]|=i,this._formatFeatures[Ll.ASTC_SRGBA_8X6]|=i,this._formatFeatures[Ll.ASTC_SRGBA_8X8]|=i,this._formatFeatures[Ll.ASTC_SRGBA_10X5]|=i,this._formatFeatures[Ll.ASTC_SRGBA_10X6]|=i,this._formatFeatures[Ll.ASTC_SRGBA_10X8]|=i,this._formatFeatures[Ll.ASTC_SRGBA_10X10]|=i,this._formatFeatures[Ll.ASTC_SRGBA_12X10]|=i,this._formatFeatures[Ll.ASTC_SRGBA_12X12]|=i)}},{key:"createCommandBuffer",value:function(e){var t=new(e.type===vc.PRIMARY?s1:Z0);return t.initialize(e),t}},{key:"createSwapchain",value:function(e){var t=new p1;return this._swapchain=t,t.initialize(e),t}},{key:"createBuffer",value:function(e){var t=new K0;return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new _1;return t.initialize(e),t}},{key:"createDescriptorSet",value:function(e){var t=new u0;return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new l1;return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new e1;return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new o1;return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new $0;return t.initialize(e),t}},{key:"createDescriptorSetLayout",value:function(e){var t=new t1;return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new i1;return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new r1;return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new a1;return t.initialize(e),t}},{key:"getSampler",value:function(e){var t=sf.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new h1(e,t)),this._samplers.get(t)}},{key:"getSwapchains",value:function(){return[this._swapchain]}},{key:"getGeneralBarrier",value:function(e){var t=uf.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new uf(e,t)),this._generalBarrierss.get(t)}},{key:"getTextureBarrier",value:function(e){var t=hf.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new hf(e,t)),this._textureBarriers.get(t)}},{key:"getBufferBarrier",value:function(e){var t=lf.computeHash(e);return this._bufferBarriers.has(t)||this._bufferBarriers.set(t,new lf(e,t)),this._bufferBarriers.get(t)}},{key:"copyBuffersToTexture",value:function(e,t,i){X0(this,e,t.gpuTexture,i)}},{key:"copyTextureToBuffers",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,s=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var o=0,u=0,h=1,l=1;switch(t.glTarget){case r.TEXTURE_2D:for(var c=0;c<n.length;c++){var _=n[c];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),o=_.texOffset.x,u=_.texOffset.y,h=_.texExtent.width,l=_.texExtent.height,r.readPixels(o,u,h,l,t.glFormat,t.glType,i[c])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),s.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,s=e.stateCache.glTexUnits[e.stateCache.texUnit];s.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),s.glTexture=i.glTexture);var a=0,o=0;switch(i.glTarget){case r.TEXTURE_2D:for(var u=0;u<n.length;u++){var h=n[u];r.texSubImage2D(r.TEXTURE_2D,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,i.glFormat,i.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var l=0;l<n.length;l++){var c=n[l],_=c.texSubres.baseArrayLayer+c.texSubres.layerCount;for(o=c.texSubres.baseArrayLayer;o<_;++o)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,i.glFormat,i.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Xl.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}}]),i}(H_));B.WebGLDevice=v1;var y1,g1=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuDescriptorSet=null,e}return s(i,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}},{key:"initialize",value:function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,i=t.bindings,n=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:n};for(var a=0;a<i.length;++a)for(var o=i[a],u=0;u<o.count;u++)s.push({type:o.descriptorType,gpuBuffer:null,gpuTextureView:null,gpuSampler:null})}},{key:"destroy",value:function(){this._layout=null,this._gpuDescriptorSet=null}},{key:"update",value:function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&w_?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&k_&&(this._textures[t]&&(e[t].gpuTextureView=this._textures[t].gpuTextureView),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}}]),i}(q_);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(y1||(y1={}));var S1=function(){function e(){n(this,e)}return s(e,null,[{key:"instance",get:function(){return e._instance}},{key:"setInstance",value:function(t){e._instance=t}}]),e}();S1._instance=null;var A1=[10497,33648,33071,33071],T1=new Float32Array(4);function E1(e,t){switch(e){case Ll.R8:return t.UNSIGNED_BYTE;case Ll.R8SN:return t.BYTE;case Ll.R8UI:return t.UNSIGNED_BYTE;case Ll.R8I:return t.BYTE;case Ll.R16F:return t.HALF_FLOAT;case Ll.R16UI:return t.UNSIGNED_SHORT;case Ll.R16I:return t.SHORT;case Ll.R32F:return t.FLOAT;case Ll.R32UI:return t.UNSIGNED_INT;case Ll.R32I:return t.INT;case Ll.RG8:return t.UNSIGNED_BYTE;case Ll.RG8SN:return t.BYTE;case Ll.RG8UI:return t.UNSIGNED_BYTE;case Ll.RG8I:return t.BYTE;case Ll.RG16F:return t.HALF_FLOAT;case Ll.RG16UI:return t.UNSIGNED_SHORT;case Ll.RG16I:return t.SHORT;case Ll.RG32F:return t.FLOAT;case Ll.RG32UI:return t.UNSIGNED_INT;case Ll.RG32I:return t.INT;case Ll.RGB8:case Ll.SRGB8:return t.UNSIGNED_BYTE;case Ll.RGB8SN:return t.BYTE;case Ll.RGB8UI:return t.UNSIGNED_BYTE;case Ll.RGB8I:return t.BYTE;case Ll.RGB16F:return t.HALF_FLOAT;case Ll.RGB16UI:return t.UNSIGNED_SHORT;case Ll.RGB16I:return t.SHORT;case Ll.RGB32F:return t.FLOAT;case Ll.RGB32UI:return t.UNSIGNED_INT;case Ll.RGB32I:return t.INT;case Ll.BGRA8:case Ll.RGBA8:case Ll.SRGB8_A8:return t.UNSIGNED_BYTE;case Ll.RGBA8SN:return t.BYTE;case Ll.RGBA8UI:return t.UNSIGNED_BYTE;case Ll.RGBA8I:return t.BYTE;case Ll.RGBA16F:return t.HALF_FLOAT;case Ll.RGBA16UI:return t.UNSIGNED_SHORT;case Ll.RGBA16I:return t.SHORT;case Ll.RGBA32F:return t.FLOAT;case Ll.RGBA32UI:return t.UNSIGNED_INT;case Ll.RGBA32I:return t.INT;case Ll.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Ll.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case Ll.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Ll.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Ll.RGB10A2:case Ll.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case Ll.RGB9E5:case Ll.DEPTH:return t.FLOAT;case Ll.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case Ll.BC1:case Ll.BC1_SRGB:case Ll.BC2:case Ll.BC2_SRGB:case Ll.BC3:case Ll.BC3_SRGB:case Ll.BC4:return t.UNSIGNED_BYTE;case Ll.BC4_SNORM:return t.BYTE;case Ll.BC5:return t.UNSIGNED_BYTE;case Ll.BC5_SNORM:return t.BYTE;case Ll.BC6H_SF16:case Ll.BC6H_UF16:return t.FLOAT;case Ll.BC7:case Ll.BC7_SRGB:case Ll.ETC_RGB8:case Ll.ETC2_RGB8:case Ll.ETC2_SRGB8:case Ll.ETC2_RGB8_A1:case Ll.ETC2_SRGB8_A1:case Ll.EAC_R11:return t.UNSIGNED_BYTE;case Ll.EAC_R11SN:return t.BYTE;case Ll.EAC_RG11:return t.UNSIGNED_BYTE;case Ll.EAC_RG11SN:return t.BYTE;case Ll.PVRTC_RGB2:case Ll.PVRTC_RGBA2:case Ll.PVRTC_RGB4:case Ll.PVRTC_RGBA4:case Ll.PVRTC2_2BPP:case Ll.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Ll.ASTC_RGBA_4X4:case Ll.ASTC_RGBA_5X4:case Ll.ASTC_RGBA_5X5:case Ll.ASTC_RGBA_6X5:case Ll.ASTC_RGBA_6X6:case Ll.ASTC_RGBA_8X5:case Ll.ASTC_RGBA_8X6:case Ll.ASTC_RGBA_8X8:case Ll.ASTC_RGBA_10X5:case Ll.ASTC_RGBA_10X6:case Ll.ASTC_RGBA_10X8:case Ll.ASTC_RGBA_10X10:case Ll.ASTC_RGBA_12X10:case Ll.ASTC_RGBA_12X12:case Ll.ASTC_SRGBA_4X4:case Ll.ASTC_SRGBA_5X4:case Ll.ASTC_SRGBA_5X5:case Ll.ASTC_SRGBA_6X5:case Ll.ASTC_SRGBA_6X6:case Ll.ASTC_SRGBA_8X5:case Ll.ASTC_SRGBA_8X6:case Ll.ASTC_SRGBA_8X8:case Ll.ASTC_SRGBA_10X5:case Ll.ASTC_SRGBA_10X6:case Ll.ASTC_SRGBA_10X8:case Ll.ASTC_SRGBA_10X10:case Ll.ASTC_SRGBA_12X10:case Ll.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function b1(e,t){switch(e){case Fl.BOOL:return t.BOOL;case Fl.BOOL2:return t.BOOL_VEC2;case Fl.BOOL3:return t.BOOL_VEC3;case Fl.BOOL4:return t.BOOL_VEC4;case Fl.INT:return t.INT;case Fl.INT2:return t.INT_VEC2;case Fl.INT3:return t.INT_VEC3;case Fl.INT4:return t.INT_VEC4;case Fl.UINT:return t.UNSIGNED_INT;case Fl.FLOAT:return t.FLOAT;case Fl.FLOAT2:return t.FLOAT_VEC2;case Fl.FLOAT3:return t.FLOAT_VEC3;case Fl.FLOAT4:return t.FLOAT_VEC4;case Fl.MAT2:return t.FLOAT_MAT2;case Fl.MAT2X3:return t.FLOAT_MAT2x3;case Fl.MAT2X4:return t.FLOAT_MAT2x4;case Fl.MAT3X2:return t.FLOAT_MAT3x2;case Fl.MAT3:return t.FLOAT_MAT3;case Fl.MAT3X4:return t.FLOAT_MAT3x4;case Fl.MAT4X2:return t.FLOAT_MAT4x2;case Fl.MAT4X3:return t.FLOAT_MAT4x3;case Fl.MAT4:return t.FLOAT_MAT4;case Fl.SAMPLER2D:return t.SAMPLER_2D;case Fl.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case Fl.SAMPLER3D:return t.SAMPLER_3D;case Fl.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Fl.UNKNOWN}}function C1(e,t){switch(e){case t.BOOL:return Fl.BOOL;case t.BOOL_VEC2:return Fl.BOOL2;case t.BOOL_VEC3:return Fl.BOOL3;case t.BOOL_VEC4:return Fl.BOOL4;case t.INT:return Fl.INT;case t.INT_VEC2:return Fl.INT2;case t.INT_VEC3:return Fl.INT3;case t.INT_VEC4:return Fl.INT4;case t.UNSIGNED_INT:return Fl.UINT;case t.UNSIGNED_INT_VEC2:return Fl.UINT2;case t.UNSIGNED_INT_VEC3:return Fl.UINT3;case t.UNSIGNED_INT_VEC4:return Fl.UINT4;case t.FLOAT:return Fl.FLOAT;case t.FLOAT_VEC2:return Fl.FLOAT2;case t.FLOAT_VEC3:return Fl.FLOAT3;case t.FLOAT_VEC4:return Fl.FLOAT4;case t.FLOAT_MAT2:return Fl.MAT2;case t.FLOAT_MAT2x3:return Fl.MAT2X3;case t.FLOAT_MAT2x4:return Fl.MAT2X4;case t.FLOAT_MAT3x2:return Fl.MAT3X2;case t.FLOAT_MAT3:return Fl.MAT3;case t.FLOAT_MAT3x4:return Fl.MAT3X4;case t.FLOAT_MAT4x2:return Fl.MAT4X2;case t.FLOAT_MAT4x3:return Fl.MAT4X3;case t.FLOAT_MAT4:return Fl.MAT4;case t.SAMPLER_2D:return Fl.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return Fl.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return Fl.SAMPLER3D;case t.SAMPLER_CUBE:return Fl.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Fl.UNKNOWN}}function R1(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function x1(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var w1,k1=[512,513,514,515,516,517,518,519],I1=[0,7680,7681,7682,7683,5386,34055,34056],B1=[32774,32778,32779,32775,32776],P1=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.BLIT_TEXTURE=6]="BLIT_TEXTURE",e[e.COUNT=7]="COUNT"}(w1||(w1={}));var M1=function e(t){n(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},O1=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,w1.BEGIN_RENDER_PASS)).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new xc,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return s(i,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),i}(M1),D1=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,w1.BIND_STATES)).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new C_,e}return s(i,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0}}]),i}(M1),L1=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,w1.DRAW)).drawInfo=new Uc,e}return s(i,[{key:"clear",value:function(){}}]),i}(M1),N1=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,w1.UPDATE_BUFFER)).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return s(i,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),i}(M1),F1=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,w1.COPY_BUFFER_TO_TEXTURE)).gpuTexture=null,e.buffers=[],e.regions=[],e}return s(i,[{key:"clear",value:function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}]),i}(M1),G1=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this,w1.BLIT_TEXTURE)).srcTexture=null,e.dstTexture=null,e.regions=[],e.filter=Kl.LINEAR,e}return s(i,[{key:"clear",value:function(){this.srcTexture=null,this.dstTexture=null,this.regions.length=0}}]),i}(M1),V1=function(){function e(){n(this,e),this.cmds=new Ch(1),this.beginRenderPassCmds=new Ch(1),this.bindStatesCmds=new Ch(1),this.drawCmds=new Ch(1),this.updateBufferCmds=new Ch(1),this.copyBufferToTextureCmds=new Ch(1),this.blitTextureCmds=new Ch(1)}return s(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.blitTextureCmds.length&&(e.blitTextureCmdPool.freeCmds(this.blitTextureCmds),this.blitTextureCmds.clear()),this.cmds.clear()}}]),e}();function U1(e,t,i,n,r){if(t.usage&Gl.INDIRECT){t.indirects.clearDraws();for(var s=i.drawInfos,a=0;a<s.length;++a)t.indirects.setDrawInfo(n+a,s[a])}else{var o=i,u=e.gl,h=e.stateCache;switch(t.glTarget){case u.ARRAY_BUFFER:e.extensions.useVAO&&h.glVAO&&(u.bindVertexArray(null),h.glVAO=null),W1.gpuInputAssembler=null,h.glArrayBuffer!==t.glBuffer&&(u.bindBuffer(u.ARRAY_BUFFER,t.glBuffer),h.glArrayBuffer=t.glBuffer),r===o.byteLength?u.bufferSubData(t.glTarget,n,o):u.bufferSubData(t.glTarget,n,o.slice(0,r));break;case u.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&h.glVAO&&(u.bindVertexArray(null),h.glVAO=null),W1.gpuInputAssembler=null,h.glElementArrayBuffer!==t.glBuffer&&(u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,t.glBuffer),h.glElementArrayBuffer=t.glBuffer),r===o.byteLength?u.bufferSubData(t.glTarget,n,o):u.bufferSubData(t.glTarget,n,o.slice(0,r));break;case u.UNIFORM_BUFFER:h.glUniformBuffer!==t.glBuffer&&(u.bindBuffer(u.UNIFORM_BUFFER,t.glBuffer),h.glUniformBuffer=t.glBuffer),r===o.byteLength?u.bufferSubData(t.glTarget,n,o):u.bufferSubData(t.glTarget,n,new Float32Array(o,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function H1(e,t){var i=e.gl;t.glInternalFmt=function(e,t){switch(e){case Ll.A8:return t.ALPHA;case Ll.L8:return t.LUMINANCE;case Ll.LA8:return t.LUMINANCE_ALPHA;case Ll.R8:return t.R8;case Ll.R8SN:return t.R8_SNORM;case Ll.R8UI:return t.R8UI;case Ll.R8I:return t.R8I;case Ll.RG8:return t.RG8;case Ll.RG8SN:return t.RG8_SNORM;case Ll.RG8UI:return t.RG8UI;case Ll.RG8I:return t.RG8I;case Ll.RGB8:return t.RGB8;case Ll.RGB8SN:return t.RGB8_SNORM;case Ll.RGB8UI:return t.RGB8UI;case Ll.RGB8I:return t.RGB8I;case Ll.BGRA8:case Ll.RGBA8:return t.RGBA8;case Ll.RGBA8SN:return t.RGBA8_SNORM;case Ll.RGBA8UI:return t.RGBA8UI;case Ll.RGBA8I:return t.RGBA8I;case Ll.R16I:return t.R16I;case Ll.R16UI:return t.R16UI;case Ll.R16F:return t.R16F;case Ll.RG16I:return t.RG16I;case Ll.RG16UI:return t.RG16UI;case Ll.RG16F:return t.RG16F;case Ll.RGB16I:return t.RGB16I;case Ll.RGB16UI:return t.RGB16UI;case Ll.RGB16F:return t.RGB16F;case Ll.RGBA16I:return t.RGBA16I;case Ll.RGBA16UI:return t.RGBA16UI;case Ll.RGBA16F:return t.RGBA16F;case Ll.R32I:return t.R32I;case Ll.R32UI:return t.R32UI;case Ll.R32F:return t.R32F;case Ll.RG32I:return t.RG32I;case Ll.RG32UI:return t.RG32UI;case Ll.RG32F:return t.RG32F;case Ll.RGB32I:return t.RGB32I;case Ll.RGB32UI:return t.RGB32UI;case Ll.RGB32F:return t.RGB32F;case Ll.RGBA32I:return t.RGBA32I;case Ll.RGBA32UI:return t.RGBA32UI;case Ll.RGBA32F:return t.RGBA32F;case Ll.R5G6B5:return t.RGB565;case Ll.RGB5A1:return t.RGB5_A1;case Ll.RGBA4:return t.RGBA4;case Ll.SRGB8:return t.SRGB8;case Ll.SRGB8_A8:return t.SRGB8_ALPHA8;case Ll.RGB10A2:return t.RGB10_A2;case Ll.RGB10A2UI:return t.RGB10_A2UI;case Ll.R11G11B10F:return t.R11F_G11F_B10F;case Ll.DEPTH:return t.DEPTH_COMPONENT32F;case Ll.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case Ll.BC1:return y1.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ll.BC1_ALPHA:return y1.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ll.BC1_SRGB:return y1.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ll.BC1_SRGB_ALPHA:return y1.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ll.BC2:return y1.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ll.BC2_SRGB:return y1.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ll.BC3:return y1.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ll.BC3_SRGB:return y1.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ll.ETC_RGB8:return y1.COMPRESSED_RGB_ETC1_WEBGL;case Ll.ETC2_RGB8:return y1.COMPRESSED_RGB8_ETC2;case Ll.ETC2_SRGB8:return y1.COMPRESSED_SRGB8_ETC2;case Ll.ETC2_RGB8_A1:return y1.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ll.ETC2_SRGB8_A1:return y1.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ll.ETC2_RGBA8:return y1.COMPRESSED_RGBA8_ETC2_EAC;case Ll.ETC2_SRGB8_A8:return y1.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ll.EAC_R11:return y1.COMPRESSED_R11_EAC;case Ll.EAC_R11SN:return y1.COMPRESSED_SIGNED_R11_EAC;case Ll.EAC_RG11:return y1.COMPRESSED_RG11_EAC;case Ll.EAC_RG11SN:return y1.COMPRESSED_SIGNED_RG11_EAC;case Ll.PVRTC_RGB2:return y1.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ll.PVRTC_RGBA2:return y1.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ll.PVRTC_RGB4:return y1.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ll.PVRTC_RGBA4:return y1.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Ll.ASTC_RGBA_4X4:return y1.COMPRESSED_RGBA_ASTC_4x4_KHR;case Ll.ASTC_RGBA_5X4:return y1.COMPRESSED_RGBA_ASTC_5x4_KHR;case Ll.ASTC_RGBA_5X5:return y1.COMPRESSED_RGBA_ASTC_5x5_KHR;case Ll.ASTC_RGBA_6X5:return y1.COMPRESSED_RGBA_ASTC_6x5_KHR;case Ll.ASTC_RGBA_6X6:return y1.COMPRESSED_RGBA_ASTC_6x6_KHR;case Ll.ASTC_RGBA_8X5:return y1.COMPRESSED_RGBA_ASTC_8x5_KHR;case Ll.ASTC_RGBA_8X6:return y1.COMPRESSED_RGBA_ASTC_8x6_KHR;case Ll.ASTC_RGBA_8X8:return y1.COMPRESSED_RGBA_ASTC_8x8_KHR;case Ll.ASTC_RGBA_10X5:return y1.COMPRESSED_RGBA_ASTC_10x5_KHR;case Ll.ASTC_RGBA_10X6:return y1.COMPRESSED_RGBA_ASTC_10x6_KHR;case Ll.ASTC_RGBA_10X8:return y1.COMPRESSED_RGBA_ASTC_10x8_KHR;case Ll.ASTC_RGBA_10X10:return y1.COMPRESSED_RGBA_ASTC_10x10_KHR;case Ll.ASTC_RGBA_12X10:return y1.COMPRESSED_RGBA_ASTC_12x10_KHR;case Ll.ASTC_RGBA_12X12:return y1.COMPRESSED_RGBA_ASTC_12x12_KHR;case Ll.ASTC_SRGBA_4X4:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Ll.ASTC_SRGBA_5X4:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Ll.ASTC_SRGBA_5X5:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Ll.ASTC_SRGBA_6X5:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Ll.ASTC_SRGBA_6X6:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Ll.ASTC_SRGBA_8X5:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Ll.ASTC_SRGBA_8X6:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Ll.ASTC_SRGBA_8X8:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Ll.ASTC_SRGBA_10X5:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Ll.ASTC_SRGBA_10X6:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Ll.ASTC_SRGBA_10X8:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Ll.ASTC_SRGBA_10X10:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Ll.ASTC_SRGBA_12X10:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Ll.ASTC_SRGBA_12X12:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,i),t.glFormat=function(e,t){switch(e){case Ll.A8:return t.ALPHA;case Ll.L8:return t.LUMINANCE;case Ll.LA8:return t.LUMINANCE_ALPHA;case Ll.R8:case Ll.R8SN:return t.RED;case Ll.R8UI:case Ll.R8I:return t.RED;case Ll.RG8:case Ll.RG8SN:case Ll.RG8UI:case Ll.RG8I:return t.RG;case Ll.RGB8:case Ll.RGB8SN:case Ll.RGB8UI:case Ll.RGB8I:return t.RGB;case Ll.BGRA8:case Ll.RGBA8:case Ll.RGBA8SN:case Ll.RGBA8UI:case Ll.RGBA8I:return t.RGBA;case Ll.R16UI:case Ll.R16I:case Ll.R16F:return t.RED;case Ll.RG16UI:case Ll.RG16I:case Ll.RG16F:return t.RG;case Ll.RGB16UI:case Ll.RGB16I:case Ll.RGB16F:return t.RGB;case Ll.RGBA16UI:case Ll.RGBA16I:case Ll.RGBA16F:return t.RGBA;case Ll.R32UI:case Ll.R32I:case Ll.R32F:return t.RED;case Ll.RG32UI:case Ll.RG32I:case Ll.RG32F:return t.RG;case Ll.RGB32UI:case Ll.RGB32I:case Ll.RGB32F:return t.RGB;case Ll.RGBA32UI:case Ll.RGBA32I:case Ll.RGBA32F:case Ll.RGB10A2:return t.RGBA;case Ll.R11G11B10F:case Ll.R5G6B5:return t.RGB;case Ll.RGB5A1:case Ll.RGBA4:return t.RGBA;case Ll.SRGB8:return t.RGB;case Ll.SRGB8_A8:return t.RGBA;case Ll.DEPTH:return t.DEPTH_COMPONENT;case Ll.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Ll.BC1:return y1.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ll.BC1_ALPHA:return y1.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ll.BC1_SRGB:return y1.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ll.BC1_SRGB_ALPHA:return y1.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ll.BC2:return y1.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ll.BC2_SRGB:return y1.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ll.BC3:return y1.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ll.BC3_SRGB:return y1.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ll.ETC_RGB8:return y1.COMPRESSED_RGB_ETC1_WEBGL;case Ll.ETC2_RGB8:return y1.COMPRESSED_RGB8_ETC2;case Ll.ETC2_SRGB8:return y1.COMPRESSED_SRGB8_ETC2;case Ll.ETC2_RGB8_A1:return y1.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ll.ETC2_SRGB8_A1:return y1.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ll.ETC2_RGBA8:return y1.COMPRESSED_RGBA8_ETC2_EAC;case Ll.ETC2_SRGB8_A8:return y1.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ll.EAC_R11:return y1.COMPRESSED_R11_EAC;case Ll.EAC_R11SN:return y1.COMPRESSED_SIGNED_R11_EAC;case Ll.EAC_RG11:return y1.COMPRESSED_RG11_EAC;case Ll.EAC_RG11SN:return y1.COMPRESSED_SIGNED_RG11_EAC;case Ll.PVRTC_RGB2:return y1.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ll.PVRTC_RGBA2:return y1.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ll.PVRTC_RGB4:return y1.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ll.PVRTC_RGBA4:return y1.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Ll.ASTC_RGBA_4X4:return y1.COMPRESSED_RGBA_ASTC_4x4_KHR;case Ll.ASTC_RGBA_5X4:return y1.COMPRESSED_RGBA_ASTC_5x4_KHR;case Ll.ASTC_RGBA_5X5:return y1.COMPRESSED_RGBA_ASTC_5x5_KHR;case Ll.ASTC_RGBA_6X5:return y1.COMPRESSED_RGBA_ASTC_6x5_KHR;case Ll.ASTC_RGBA_6X6:return y1.COMPRESSED_RGBA_ASTC_6x6_KHR;case Ll.ASTC_RGBA_8X5:return y1.COMPRESSED_RGBA_ASTC_8x5_KHR;case Ll.ASTC_RGBA_8X6:return y1.COMPRESSED_RGBA_ASTC_8x6_KHR;case Ll.ASTC_RGBA_8X8:return y1.COMPRESSED_RGBA_ASTC_8x8_KHR;case Ll.ASTC_RGBA_10X5:return y1.COMPRESSED_RGBA_ASTC_10x5_KHR;case Ll.ASTC_RGBA_10X6:return y1.COMPRESSED_RGBA_ASTC_10x6_KHR;case Ll.ASTC_RGBA_10X8:return y1.COMPRESSED_RGBA_ASTC_10x8_KHR;case Ll.ASTC_RGBA_10X10:return y1.COMPRESSED_RGBA_ASTC_10x10_KHR;case Ll.ASTC_RGBA_12X10:return y1.COMPRESSED_RGBA_ASTC_12x10_KHR;case Ll.ASTC_RGBA_12X12:return y1.COMPRESSED_RGBA_ASTC_12x12_KHR;case Ll.ASTC_SRGBA_4X4:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Ll.ASTC_SRGBA_5X4:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Ll.ASTC_SRGBA_5X5:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Ll.ASTC_SRGBA_6X5:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Ll.ASTC_SRGBA_6X6:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Ll.ASTC_SRGBA_8X5:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Ll.ASTC_SRGBA_8X6:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Ll.ASTC_SRGBA_8X8:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Ll.ASTC_SRGBA_10X5:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Ll.ASTC_SRGBA_10X6:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Ll.ASTC_SRGBA_10X8:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Ll.ASTC_SRGBA_10X10:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Ll.ASTC_SRGBA_12X10:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Ll.ASTC_SRGBA_12X12:return y1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,i),t.glType=E1(t.format,i);var n=t.width,r=t.height,s=t.depth,a=t.arrayLayer;switch(t.type){case zl.TEX2D:t.glTarget=i.TEXTURE_2D;var o=Math.max(n,r);if(o>e.capabilities.maxTextureSize&&ue(9100,o,e.capabilities.maxTextureSize),t.samples===ql.ONE){if(t.glTexture=i.createTexture(),t.size>0){var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),x_[t.format].isCompressed)for(var h=0;h<t.mipLevel;++h){var l=P_(t.format,n,r,1),c=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,h,t.glInternalFmt,n,r,0,c),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else i.texStorage2D(i.TEXTURE_2D,t.mipLevel,t.glInternalFmt,n,r)}}else t.glRenderbuffer=i.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case zl.TEX2D_ARRAY:t.glTarget=i.TEXTURE_2D_ARRAY;var _=Math.max(n,r);if(_>e.capabilities.maxTextureSize&&ue(9100,_,e.capabilities.maxTextureSize),a>e.capabilities.maxArrayTextureLayers&&ue(9100,a,e.capabilities.maxArrayTextureLayers),t.glTexture=i.createTexture(),t.size>0){var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D_ARRAY,t.glTexture),f.glTexture=t.glTexture),x_[t.format].isCompressed)for(var d=0;d<t.mipLevel;++d){var m=P_(t.format,n,r,a),p=new Uint8Array(m);i.compressedTexImage3D(i.TEXTURE_2D_ARRAY,d,t.glInternalFmt,n,r,a,0,p),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else i.texStorage3D(i.TEXTURE_2D_ARRAY,t.mipLevel,t.glInternalFmt,n,r,a)}break;case zl.TEX3D:t.glTarget=i.TEXTURE_3D;var v=Math.max(Math.max(n,r),s);if(v>e.capabilities.max3DTextureSize&&ue(9100,v,e.capabilities.max3DTextureSize),t.glTexture=i.createTexture(),t.size>0){var y=e.stateCache.glTexUnits[e.stateCache.texUnit];if(y.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_3D,t.glTexture),y.glTexture=t.glTexture),x_[t.format].isCompressed)for(var g=0;g<t.mipLevel;++g){var S=P_(t.format,n,r,s),A=new Uint8Array(S);i.compressedTexImage3D(i.TEXTURE_3D,g,t.glInternalFmt,n,r,s,0,A),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else i.texStorage3D(i.TEXTURE_3D,t.mipLevel,t.glInternalFmt,n,r,s)}break;case zl.CUBE:t.glTarget=i.TEXTURE_CUBE_MAP;var T=Math.max(n,r);if(T>e.capabilities.maxCubeMapTextureSize&&ue(9100,T,e.capabilities.maxTextureSize),t.glTexture=i.createTexture(),t.size>0){var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),E.glTexture=t.glTexture),x_[t.format].isCompressed)for(var b=0;b<t.mipLevel;++b){for(var C=P_(t.format,n,r,1),R=new Uint8Array(C),x=0;x<6;++x)i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+x,b,t.glInternalFmt,n,r,0,R);n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else i.texStorage2D(i.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,n,r)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=zl.TEX2D,t.glTarget=i.TEXTURE_2D}}function z1(e,t){var i=e.gl;if(t.glTexture){var n=e.stateCache.glTexUnits,r=e.stateCache.texUnit;i.deleteTexture(t.glTexture);for(var s=0;s<n.length;++s)n[s].glTexture===t.glTexture&&(i.activeTexture(i.TEXTURE0+s),r=s,i.bindTexture(t.glTarget,null),n[s].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;i.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}var W1={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function X1(e,t,i,n,r,s,a){var o=e.gl,u=e.stateCache,h=0;if(i&&t){u.glFramebuffer!==i.glFramebuffer&&(o.bindFramebuffer(o.FRAMEBUFFER,i.glFramebuffer),u.glFramebuffer=i.glFramebuffer),u.viewport.left===n.x&&u.viewport.top===n.y&&u.viewport.width===n.width&&u.viewport.height===n.height||(o.viewport(n.x,n.y,n.width,n.height),u.viewport.left=n.x,u.viewport.top=n.y,u.viewport.width=n.width,u.viewport.height=n.height),u.scissorRect.x===n.x&&u.scissorRect.y===n.y&&u.scissorRect.width===n.width&&u.scissorRect.height===n.height||(o.scissor(n.x,n.y,n.width,n.height),u.scissorRect.x=n.x,u.scissorRect.y=n.y,u.scissorRect.width=n.width,u.scissorRect.height=n.height),W1.invalidateAttachments.length=0;for(var l=0;l<r.length;++l){var c=t.colorAttachments[l];if(c.format!==Ll.UNKNOWN)switch(c.loadOp){case nc.LOAD:break;case nc.CLEAR:if(u.bs.targets[0].blendColorMask!==tc.ALL&&o.colorMask(!0,!0,!0,!0),i.isOffscreen)T1[0]=r[l].x,T1[1]=r[l].y,T1[2]=r[l].z,T1[3]=r[l].w,o.clearBufferfv(o.COLOR,l,T1);else{var _=r[0];o.clearColor(_.x,_.y,_.z,_.w),h|=o.COLOR_BUFFER_BIT}break;case nc.DISCARD:W1.invalidateAttachments.push(o.COLOR_ATTACHMENT0+l)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Ll.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case nc.LOAD:break;case nc.CLEAR:u.dss.depthWrite||o.depthMask(!0),o.clearDepth(s),h|=o.DEPTH_BUFFER_BIT;break;case nc.DISCARD:W1.invalidateAttachments.push(o.DEPTH_ATTACHMENT)}if(x_[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case nc.LOAD:break;case nc.CLEAR:u.dss.stencilWriteMaskFront||o.stencilMaskSeparate(o.FRONT,65535),u.dss.stencilWriteMaskBack||o.stencilMaskSeparate(o.BACK,65535),o.clearStencil(a),h|=o.STENCIL_BUFFER_BIT;break;case nc.DISCARD:W1.invalidateAttachments.push(o.STENCIL_ATTACHMENT)}}if(i.glFramebuffer&&W1.invalidateAttachments.length&&o.invalidateFramebuffer(o.FRAMEBUFFER,W1.invalidateAttachments),h&&o.clear(h),h&o.COLOR_BUFFER_BIT){var f=u.bs.targets[0].blendColorMask;if(f!==tc.ALL){var d=(f&tc.R)!==tc.NONE,m=(f&tc.G)!==tc.NONE,p=(f&tc.B)!==tc.NONE,v=(f&tc.A)!==tc.NONE;o.colorMask(d,m,p,v)}}h&o.DEPTH_BUFFER_BIT&&!u.dss.depthWrite&&o.depthMask(!1),h&o.STENCIL_BUFFER_BIT&&(u.dss.stencilWriteMaskFront||o.stencilMaskSeparate(o.FRONT,0),u.dss.stencilWriteMaskBack||o.stencilMaskSeparate(o.BACK,0))}}function j1(e,t,i,n,r,s){var a=e.gl,o=e.stateCache,u=t&&t.gpuShader,h=!1;if(t&&W1.gpuPipelineState!==t){if(W1.gpuPipelineState=t,W1.glPrimitive=t.glPrimitive,u){var l=u.glProgram;o.glProgram!==l&&(a.useProgram(l),o.glProgram=l,h=!0)}var c=t.rs;if(c){if(o.rs.cullMode!==c.cullMode){switch(c.cullMode){case cc.NONE:a.disable(a.CULL_FACE);break;case cc.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case cc.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}e.stateCache.rs.cullMode=c.cullMode}var _=c.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==_&&(a.frontFace(_?a.CCW:a.CW),e.stateCache.rs.isFrontFaceCCW=_),e.stateCache.rs.depthBias===c.depthBias&&e.stateCache.rs.depthBiasSlop===c.depthBiasSlop||(a.polygonOffset(c.depthBias,c.depthBiasSlop),e.stateCache.rs.depthBias=c.depthBias,e.stateCache.rs.depthBiasSlop=c.depthBiasSlop),e.stateCache.rs.lineWidth!==c.lineWidth&&(a.lineWidth(c.lineWidth),e.stateCache.rs.lineWidth=c.lineWidth)}var f=t.dss;f&&(o.dss.depthTest!==f.depthTest&&(f.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),o.dss.depthTest=f.depthTest),o.dss.depthWrite!==f.depthWrite&&(a.depthMask(f.depthWrite),o.dss.depthWrite=f.depthWrite),o.dss.depthFunc!==f.depthFunc&&(a.depthFunc(k1[f.depthFunc]),o.dss.depthFunc=f.depthFunc),o.dss.stencilTestFront===f.stencilTestFront&&o.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),o.dss.stencilTestFront=f.stencilTestFront,o.dss.stencilTestBack=f.stencilTestBack),o.dss.stencilFuncFront===f.stencilFuncFront&&o.dss.stencilRefFront===f.stencilRefFront&&o.dss.stencilReadMaskFront===f.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,k1[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),o.dss.stencilFuncFront=f.stencilFuncFront,o.dss.stencilRefFront=f.stencilRefFront,o.dss.stencilReadMaskFront=f.stencilReadMaskFront),o.dss.stencilFailOpFront===f.stencilFailOpFront&&o.dss.stencilZFailOpFront===f.stencilZFailOpFront&&o.dss.stencilPassOpFront===f.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,I1[f.stencilFailOpFront],I1[f.stencilZFailOpFront],I1[f.stencilPassOpFront]),o.dss.stencilFailOpFront=f.stencilFailOpFront,o.dss.stencilZFailOpFront=f.stencilZFailOpFront,o.dss.stencilPassOpFront=f.stencilPassOpFront),o.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,f.stencilWriteMaskFront),o.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),o.dss.stencilFuncBack===f.stencilFuncBack&&o.dss.stencilRefBack===f.stencilRefBack&&o.dss.stencilReadMaskBack===f.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,k1[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),o.dss.stencilFuncBack=f.stencilFuncBack,o.dss.stencilRefBack=f.stencilRefBack,o.dss.stencilReadMaskBack=f.stencilReadMaskBack),o.dss.stencilFailOpBack===f.stencilFailOpBack&&o.dss.stencilZFailOpBack===f.stencilZFailOpBack&&o.dss.stencilPassOpBack===f.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,I1[f.stencilFailOpBack],I1[f.stencilZFailOpBack],I1[f.stencilPassOpBack]),o.dss.stencilFailOpBack=f.stencilFailOpBack,o.dss.stencilZFailOpBack=f.stencilZFailOpBack,o.dss.stencilPassOpBack=f.stencilPassOpBack),o.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,f.stencilWriteMaskBack),o.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var d=t.bs;if(d){o.bs.isA2C!==d.isA2C&&(d.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),o.bs.isA2C=d.isA2C),o.bs.blendColor.x===d.blendColor.x&&o.bs.blendColor.y===d.blendColor.y&&o.bs.blendColor.z===d.blendColor.z&&o.bs.blendColor.w===d.blendColor.w||(a.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),o.bs.blendColor.x=d.blendColor.x,o.bs.blendColor.y=d.blendColor.y,o.bs.blendColor.z=d.blendColor.z,o.bs.blendColor.w=d.blendColor.w);var m=d.targets[0],p=o.bs.targets[0];p.blend!==m.blend&&(m.blend?a.enable(a.BLEND):a.disable(a.BLEND),p.blend=m.blend),p.blendEq===m.blendEq&&p.blendAlphaEq===m.blendAlphaEq||(a.blendEquationSeparate(B1[m.blendEq],B1[m.blendAlphaEq]),p.blendEq=m.blendEq,p.blendAlphaEq=m.blendAlphaEq),p.blendSrc===m.blendSrc&&p.blendDst===m.blendDst&&p.blendSrcAlpha===m.blendSrcAlpha&&p.blendDstAlpha===m.blendDstAlpha||(a.blendFuncSeparate(P1[m.blendSrc],P1[m.blendDst],P1[m.blendSrcAlpha],P1[m.blendDstAlpha]),p.blendSrc=m.blendSrc,p.blendDst=m.blendDst,p.blendSrcAlpha=m.blendSrcAlpha,p.blendDstAlpha=m.blendDstAlpha),p.blendColorMask!==m.blendColorMask&&(a.colorMask((m.blendColorMask&tc.R)!==tc.NONE,(m.blendColorMask&tc.G)!==tc.NONE,(m.blendColorMask&tc.B)!==tc.NONE,(m.blendColorMask&tc.A)!==tc.NONE),p.blendColorMask=m.blendColorMask)}}if(t&&t.gpuPipelineLayout&&u){for(var v=u.glBlocks.length,y=t.gpuPipelineLayout.dynamicOffsetIndices,g=0;g<v;g++){var S=u.glBlocks[g],A=n[S.set],T=A&&A.descriptorIndices[S.binding],E=T>=0&&A.gpuDescriptors[T];if(E&&E.gpuBuffer){var b=y[S.set],C=b&&b[S.binding],R=E.gpuBuffer.glOffset;C>=0&&(R+=r[C]),o.glBindUBOs[S.glBinding]===E.gpuBuffer.glBuffer&&o.glBindUBOOffsets[S.glBinding]===R||(R?a.bindBufferRange(a.UNIFORM_BUFFER,S.glBinding,E.gpuBuffer.glBuffer,R,E.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,S.glBinding,E.gpuBuffer.glBuffer),o.glUniformBuffer=o.glBindUBOs[S.glBinding]=E.gpuBuffer.glBuffer,o.glBindUBOOffsets[S.glBinding]=R)}else J("Buffer binding '".concat(S.name,"' at set ").concat(S.set," binding ").concat(S.binding," is not bounded"))}for(var x=u.glSamplerTextures.length,w=0;w<x;w++)for(var k=u.glSamplerTextures[w],I=n[k.set],B=I&&I.descriptorIndices[k.binding],P=B>=0&&I.gpuDescriptors[B],M=0;M<k.units.length;M++){var O=k.units[M],D=o.glTexUnits[O];if(P&&P.gpuTextureView&&P.gpuTextureView.gpuTexture&&P.gpuSampler){var L=P.gpuTextureView,N=L.gpuTexture,F=L.baseLevel,G=F+L.levelCount;if(N.size>0){D.glTexture!==N.glTexture&&(o.texUnit!==O&&(a.activeTexture(a.TEXTURE0+O),o.texUnit=O),N.glTexture?a.bindTexture(N.glTarget,N.glTexture):a.bindTexture(N.glTarget,e.nullTex2D.gpuTexture.glTexture),D.glTexture=N.glTexture);var V=P.gpuSampler.getGLSampler(e,F,G);o.glSamplerUnits[O]!==V&&(a.bindSampler(O,V),o.glSamplerUnits[O]=V)}P=I.gpuDescriptors[++B]}else J("Sampler binding '".concat(k.name,"' at set ").concat(k.set," binding ").concat(k.binding," index ").concat(M," is not bounded"))}}if(i&&u&&(h||W1.gpuInputAssembler!==i))if(W1.gpuInputAssembler=i,e.extensions.useVAO){var U=i.glVAOs.get(u.glProgram);if(!U){var H;U=a.createVertexArray(),i.glVAOs.set(u.glProgram,U),a.bindVertexArray(U),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),o.glArrayBuffer=null,o.glElementArrayBuffer=null;for(var z=0;z<u.glInputs.length;z++){var W=u.glInputs[z];H=null;for(var X=0;X<i.glAttribs.length;X++){var j=i.glAttribs[X];if(j.name===W.name){H=j;break}}if(H){o.glArrayBuffer!==H.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,H.glBuffer),o.glArrayBuffer=H.glBuffer);for(var q=0;q<H.componentCount;++q){var Y=W.glLoc+q,K=H.offset+H.size*q;a.enableVertexAttribArray(Y),o.glCurrentAttribLocs[Y]=!0,a.vertexAttribPointer(Y,H.count,H.glType,H.isNormalized,H.stride,K),a.vertexAttribDivisor(Y,H.isInstanced?1:0)}}}var Q=i.gpuIndexBuffer;Q&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Q.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),o.glArrayBuffer=null,o.glElementArrayBuffer=null}o.glVAO!==U&&(a.bindVertexArray(U),o.glVAO=U)}else{for(var Z=0;Z<e.capabilities.maxVertexAttributes;++Z)o.glCurrentAttribLocs[Z]=!1;for(var $=0;$<u.glInputs.length;$++){for(var ee=u.glInputs[$],te=null,ie=0;ie<i.glAttribs.length;ie++){var ne=i.glAttribs[ie];if(ne.name===ee.name){te=ne;break}}if(te){o.glArrayBuffer!==te.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,te.glBuffer),o.glArrayBuffer=te.glBuffer);for(var re=0;re<te.componentCount;++re){var se=ee.glLoc+re,ae=te.offset+te.size*re;!o.glEnabledAttribLocs[se]&&se>=0&&(a.enableVertexAttribArray(se),o.glEnabledAttribLocs[se]=!0),o.glCurrentAttribLocs[se]=!0,a.vertexAttribPointer(se,te.count,te.glType,te.isNormalized,te.stride,ae),a.vertexAttribDivisor(se,te.isInstanced?1:0)}}}var oe=i.gpuIndexBuffer;oe&&o.glElementArrayBuffer!==oe.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,oe.glBuffer),o.glElementArrayBuffer=oe.glBuffer);for(var ue=0;ue<e.capabilities.maxVertexAttributes;++ue)o.glEnabledAttribLocs[ue]!==o.glCurrentAttribLocs[ue]&&(a.disableVertexAttribArray(ue),o.glEnabledAttribLocs[ue]=!1)}if(t&&t.dynamicStates.length)for(var he=t.dynamicStates.length,le=0;le<he;le++)switch(t.dynamicStates[le]){case _c.LINE_WIDTH:o.rs.lineWidth!==s.lineWidth&&(a.lineWidth(s.lineWidth),o.rs.lineWidth=s.lineWidth);break;case _c.DEPTH_BIAS:o.rs.depthBias===s.depthBiasConstant&&o.rs.depthBiasSlop===s.depthBiasSlope||(a.polygonOffset(s.depthBiasConstant,s.depthBiasSlope),o.rs.depthBias=s.depthBiasConstant,o.rs.depthBiasSlop=s.depthBiasSlope);break;case _c.BLEND_CONSTANTS:var ce=s.blendConstant;o.bs.blendColor.x===ce.x&&o.bs.blendColor.y===ce.y&&o.bs.blendColor.z===ce.z&&o.bs.blendColor.w===ce.w||(a.blendColor(ce.x,ce.y,ce.z,ce.w),o.bs.blendColor.copy(ce));break;case _c.STENCIL_WRITE_MASK:var _e=s.stencilStatesFront,fe=s.stencilStatesBack;o.dss.stencilWriteMaskFront!==_e.writeMask&&(a.stencilMaskSeparate(a.FRONT,_e.writeMask),o.dss.stencilWriteMaskFront=_e.writeMask),o.dss.stencilWriteMaskBack!==fe.writeMask&&(a.stencilMaskSeparate(a.BACK,fe.writeMask),o.dss.stencilWriteMaskBack=fe.writeMask);break;case _c.STENCIL_COMPARE_MASK:var de=s.stencilStatesFront,me=s.stencilStatesBack;o.dss.stencilRefFront===de.reference&&o.dss.stencilReadMaskFront===de.compareMask||(a.stencilFuncSeparate(a.FRONT,k1[o.dss.stencilFuncFront],de.reference,de.compareMask),o.dss.stencilRefFront=de.reference,o.dss.stencilReadMaskFront=de.compareMask),o.dss.stencilRefBack===me.reference&&o.dss.stencilReadMaskBack===me.compareMask||(a.stencilFuncSeparate(a.BACK,k1[o.dss.stencilFuncBack],me.reference,me.compareMask),o.dss.stencilRefBack=me.reference,o.dss.stencilReadMaskBack=me.compareMask)}}function q1(e,t){var i=e.gl,n=W1.gpuInputAssembler,r=W1.glPrimitive,s=e.extensions.WEBGL_multi_draw;if(n){var a=n.gpuIndexBuffer;if(n.gpuIndirectBuffer){var o=n.gpuIndirectBuffer.indirects;if(o.drawByIndex){for(var u=0;u<o.drawCount;u++)o.byteOffsets[u]=o.offsets[u]*a.stride;if(s)o.instancedDraw?s.multiDrawElementsInstancedWEBGL(r,o.counts,0,n.glIndexType,o.byteOffsets,0,o.instances,0,o.drawCount):s.multiDrawElementsWEBGL(r,o.counts,0,n.glIndexType,o.byteOffsets,0,o.drawCount);else for(var h=0;h<o.drawCount;h++)o.instances[h]?i.drawElementsInstanced(r,o.counts[h],n.glIndexType,o.byteOffsets[h],o.instances[h]):i.drawElements(r,o.counts[h],n.glIndexType,o.byteOffsets[h])}else if(s)o.instancedDraw?s.multiDrawArraysInstancedWEBGL(r,o.offsets,0,o.counts,0,o.instances,0,o.drawCount):s.multiDrawArraysWEBGL(r,o.offsets,0,o.counts,0,o.drawCount);else for(var l=0;l<o.drawCount;l++)o.instances[l]?i.drawArraysInstanced(r,o.offsets[l],o.counts[l],o.instances[l]):i.drawArrays(r,o.offsets[l],o.counts[l])}else if(t.instanceCount)if(a){if(t.indexCount>0){var c=t.firstIndex*a.stride;i.drawElementsInstanced(r,t.indexCount,n.glIndexType,c,t.instanceCount)}}else t.vertexCount>0&&i.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(a){if(t.indexCount>0){var _=t.firstIndex*a.stride;i.drawElements(r,t.indexCount,n.glIndexType,_)}}else t.vertexCount>0&&i.drawArrays(r,t.firstVertex,t.vertexCount)}}var Y1=new Array(w1.COUNT);function K1(e,t){Y1.fill(0);for(var i=0;i<t.cmds.length;++i){var n=t.cmds.array[i],r=Y1[n]++;switch(n){case w1.BEGIN_RENDER_PASS:var s=t.beginRenderPassCmds.array[r];X1(e,s.gpuRenderPass,s.gpuFramebuffer,s.renderArea,s.clearColors,s.clearDepth,s.clearStencil);break;case w1.BIND_STATES:var a=t.bindStatesCmds.array[r];j1(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case w1.DRAW:q1(e,t.drawCmds.array[r].drawInfo);break;case w1.UPDATE_BUFFER:var o=t.updateBufferCmds.array[r];U1(e,o.gpuBuffer,o.buffer,o.offset,o.size);break;case w1.COPY_BUFFER_TO_TEXTURE:var u=t.copyBufferToTextureCmds.array[r];Z1(e,u.buffers,u.gpuTexture,u.regions);break;case w1.BLIT_TEXTURE:var h=t.blitTextureCmds.array[r];$1(e,h.srcTexture,h.dstTexture,h.regions,h.filter)}}}var Q1=new Uint8Array(1);function J1(e,t,i,n,r){var s=N_(t).height,a=P_(t,r.width,r.height,r.depth),o=P_(t,n.width,1,1),u=P_(t,n.width,n.height,1),h=P_(t,r.width,1,1),l=L_(x_[t]);Q1.byteLength<a&&(Q1=new Uint8Array(a));for(var c=0,_=i,f=0;f<r.depth;f++){_=i+u*f;for(var d=0;d<r.height;d+=s)Q1.subarray(c,c+h).set(new Uint8Array(e.buffer,e.byteOffset+_,h)),c+=h,_+=o}return new l(Q1.buffer)}function Z1(e,t,i,n){var r=e.gl,s=e.stateCache.glTexUnits[e.stateCache.texUnit];s.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),s.glTexture=i.glTexture);var a=0,o=0,u=x_[i.format],h=L_(u),l=u.isCompressed,c=N_(i.format),_=new wc,f=new Rc,d=new wc;switch(i.glTarget){case r.TEXTURE_2D:for(var m=0;m<n.length;m++){var p=n[m],v=p.texSubres.mipLevel;f.x=0===p.texOffset.x?0:F_(p.texOffset.x,c.width),f.y=0===p.texOffset.y?0:F_(p.texOffset.y,c.height),_.width=p.texExtent.width<c.width?p.texExtent.width:F_(p.texExtent.width,c.width),_.height=p.texExtent.height<c.height?p.texExtent.width:F_(p.texExtent.height,c.height),d.width=p.buffStride>0?p.buffStride:_.width,d.height=p.buffTexHeight>0?p.buffTexHeight:_.height;var y,g=p.texExtent.width+f.x===i.width>>v?p.texExtent.width:_.width,S=p.texExtent.height+f.y===i.height>>v?p.texExtent.height:_.height,A=t[a++];y=d.width===_.width&&d.height===_.height?new h(A.buffer,A.byteOffset+p.buffOffset):J1(A,i.format,p.buffOffset,d,_),l?i.glInternalFmt!==y1.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,v,f.x,f.y,g,S,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_2D,v,i.glInternalFmt,g,S,0,y):r.texSubImage2D(r.TEXTURE_2D,v,f.x,f.y,g,S,i.glFormat,i.glType,y)}break;case r.TEXTURE_2D_ARRAY:for(var T=0;T<n.length;T++){var E=n[T],b=E.texSubres.mipLevel;f.x=0===E.texOffset.x?0:F_(E.texOffset.x,c.width),f.y=0===E.texOffset.y?0:F_(E.texOffset.y,c.height),_.width=E.texExtent.width<c.width?E.texExtent.width:F_(E.texExtent.width,c.width),_.height=E.texExtent.height<c.height?E.texExtent.width:F_(E.texExtent.height,c.height),_.depth=1,d.width=E.buffStride>0?E.buffStride:_.width,d.height=E.buffTexHeight>0?E.buffTexHeight:_.height;var C=E.texExtent.width+f.x===i.width>>b?E.texExtent.width:_.width,R=E.texExtent.height+f.y===i.height>>b?E.texExtent.height:_.height,x=E.texSubres.baseArrayLayer+E.texSubres.layerCount;for(o=E.texSubres.baseArrayLayer;o<x;++o){f.z=o;var w,k=t[a++];w=d.width===_.width&&d.height===_.height?new h(k.buffer,k.byteOffset+E.buffOffset):J1(k,i.format,E.buffOffset,d,_),l?i.glInternalFmt!==y1.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage3D(r.TEXTURE_2D_ARRAY,b,f.x,f.y,f.z,C,R,_.depth,i.glFormat,w):r.compressedTexImage3D(r.TEXTURE_2D_ARRAY,b,i.glInternalFmt,C,R,_.depth,0,w):r.texSubImage3D(r.TEXTURE_2D_ARRAY,b,f.x,f.y,f.z,C,R,_.depth,i.glFormat,i.glType,w)}}break;case r.TEXTURE_3D:for(var I=0;I<n.length;I++){var B=n[I],P=B.texSubres.mipLevel;f.x=0===B.texOffset.x?0:F_(B.texOffset.x,c.width),f.y=0===B.texOffset.y?0:F_(B.texOffset.y,c.height),f.z=B.texOffset.z,_.width=B.texExtent.width<c.width?B.texExtent.width:F_(B.texExtent.width,c.width),_.height=B.texExtent.height<c.height?B.texExtent.width:F_(B.texExtent.height,c.height),_.depth=B.texExtent.depth,d.width=B.buffStride>0?B.buffStride:_.width,d.height=B.buffTexHeight>0?B.buffTexHeight:_.height;var M,O=B.texExtent.width+f.x===i.width>>P?B.texExtent.width:_.width,D=B.texExtent.height+f.y===i.height>>P?B.texExtent.height:_.height,L=t[a++];M=d.width===_.width&&d.height===_.height?new h(L.buffer,L.byteOffset+B.buffOffset):J1(L,i.format,B.buffOffset,d,_),l?i.glInternalFmt!==y1.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage3D(r.TEXTURE_2D_ARRAY,P,f.x,f.y,f.z,O,D,_.depth,i.glFormat,M):r.compressedTexImage3D(r.TEXTURE_2D_ARRAY,P,i.glInternalFmt,O,D,_.depth,0,M):r.texSubImage3D(r.TEXTURE_2D_ARRAY,P,f.x,f.y,f.z,O,D,_.depth,i.glFormat,i.glType,M)}break;case r.TEXTURE_CUBE_MAP:for(var N=0;N<n.length;N++){var F=n[N],G=F.texSubres.mipLevel;f.x=0===F.texOffset.x?0:F_(F.texOffset.x,c.width),f.y=0===F.texOffset.y?0:F_(F.texOffset.y,c.height),_.width=F.texExtent.width<c.width?F.texExtent.width:F_(F.texExtent.width,c.width),_.height=F.texExtent.height<c.height?F.texExtent.width:F_(F.texExtent.height,c.height),d.width=F.buffStride>0?F.buffStride:_.width,d.height=F.buffTexHeight>0?F.buffTexHeight:_.height;var V=F.texExtent.width+f.x===i.width>>G?F.texExtent.width:_.width,U=F.texExtent.height+f.y===i.height>>G?F.texExtent.height:_.height,H=F.texSubres.baseArrayLayer+F.texSubres.layerCount;for(o=F.texSubres.baseArrayLayer;o<H;++o){var z,W=t[a++];z=d.width===_.width&&d.height===_.height?new h(W.buffer,W.byteOffset+F.buffOffset):J1(W,i.format,F.buffOffset,d,_),l?i.glInternalFmt!==y1.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,G,f.x,f.y,V,U,i.glFormat,z):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,G,i.glInternalFmt,V,U,0,z):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,G,f.x,f.y,V,U,i.glFormat,i.glType,z)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Xl.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}function $1(e,t,i,n,r){var s=e.gl,a=e.stateCache,o=e.blitManager;if(o){var u=r===Kl.LINEAR||r===Kl.ANISOTROPIC?s.LINEAR:s.NEAREST,h=o.srcFramebuffer,l=o.dstFramebuffer,c=a.glReadFramebuffer,_=a.glFramebuffer,f=n[0].srcSubres.mipLevel,d=n[0].dstSubres.mipLevel,m=function(e){var t=0,i=s.COLOR_ATTACHMENT0;return e.hasStencil?i=s.DEPTH_STENCIL_ATTACHMENT:e.hasDepth&&(i=s.DEPTH_ATTACHMENT),e.hasDepth||e.hasStencil?(e.hasDepth&&(t|=s.DEPTH_BUFFER_BIT),e.hasStencil&&(t|=s.STENCIL_BUFFER_BIT)):t|=s.COLOR_BUFFER_BIT,{mask:t,attachment:i}},p=n.map((function(e,t){return t}));p.sort((function(e,t){return n[e].srcSubres.mipLevel-n[t].srcSubres.mipLevel}));var v=m(x_[t.format]),y=v.mask,g=v.attachment,S=m(x_[i.format]).attachment;a.glReadFramebuffer!==h&&(s.bindFramebuffer(s.READ_FRAMEBUFFER,h),a.glReadFramebuffer=h),a.glFramebuffer!==l&&(s.bindFramebuffer(s.DRAW_FRAMEBUFFER,l),a.glFramebuffer=l),t.glTexture?s.framebufferTexture2D(s.READ_FRAMEBUFFER,g,t.glTarget,t.glTexture,f):s.framebufferRenderbuffer(s.READ_FRAMEBUFFER,g,s.RENDERBUFFER,t.glRenderbuffer),i.glTexture?s.framebufferTexture2D(s.DRAW_FRAMEBUFFER,S,i.glTarget,i.glTexture,d):s.framebufferRenderbuffer(s.DRAW_FRAMEBUFFER,S,s.RENDERBUFFER,i.glRenderbuffer);for(var A=0;A<p.length;A++){var T=n[p[A]];t.glTexture&&f!==T.srcSubres.mipLevel&&(f=T.srcSubres.mipLevel,s.framebufferTexture2D(s.READ_FRAMEBUFFER,g,t.glTarget,t.glTexture,f)),i.glTexture&&d!==T.dstSubres.mipLevel&&(d=T.dstSubres.mipLevel,s.framebufferTexture2D(s.DRAW_FRAMEBUFFER,S,i.glTarget,i.glTexture,d)),s.blitFramebuffer(T.srcOffset.x,T.srcOffset.y,T.srcOffset.x+T.srcExtent.width,T.srcOffset.y+T.srcExtent.height,T.dstOffset.x,T.dstOffset.y,T.dstOffset.x+T.dstExtent.width,T.dstOffset.y+T.dstExtent.height,y,u)}a.glReadFramebuffer!==c&&(s.bindFramebuffer(s.READ_FRAMEBUFFER,c),a.glReadFramebuffer=c),a.glFramebuffer!==_&&(s.bindFramebuffer(s.DRAW_FRAMEBUFFER,_),a.glFramebuffer=_)}}var e2=function(){function e(){n(this,e),this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}return s(e,[{key:"clearDraws",value:function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1}},{key:"setDrawInfo",value:function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)}},{key:"_ensureCapacity",value:function(e){if(!(this._capacity>e)){this._capacity=qi(e);var t=new Int32Array(this._capacity),i=new Int32Array(this._capacity),n=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),i.set(this.offsets),n.set(this.instances),this.counts=t,this.offsets=i,this.instances=n}}}]),e}(),t2=function(){function e(){n(this,e),this._srcFramebuffer=void 0,this._dstFramebuffer=void 0;var t=S1.instance.gl;this._srcFramebuffer=t.createFramebuffer(),this._dstFramebuffer=t.createFramebuffer()}return s(e,[{key:"srcFramebuffer",get:function(){return this._srcFramebuffer}},{key:"dstFramebuffer",get:function(){return this._dstFramebuffer}},{key:"destroy",value:function(){var e=S1.instance.gl;e.deleteFramebuffer(this._srcFramebuffer),e.deleteFramebuffer(this._dstFramebuffer)}}]),e}(),i2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuBuffer=null,e}return s(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"initialize",value:function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new e2,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Hl.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&Gl.VERTEX){t.glTarget=i.ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,t.size>0&&(e.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),W1.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Gl.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),W1.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&Gl.UNIFORM){t.glTarget=i.UNIFORM_BUFFER;var o=i.createBuffer();o&&t.size>0&&(t.glBuffer=o,e.stateCache.glUniformBuffer!==t.glBuffer&&(i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,r),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&Gl.INDIRECT||t.usage&Gl.TRANSFER_DST||t.usage&Gl.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=i.NONE}(S1.instance,this._gpuBuffer),S1.instance.memoryStatus.bufferSize+=this._size}},{key:"destroy",value:function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var i=e.gl,n=e.stateCache;if(t.glBuffer){switch(t.glTarget){case i.ARRAY_BUFFER:e.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),e.stateCache.glVAO=null),W1.gpuInputAssembler=null,i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),e.stateCache.glVAO=null),W1.gpuInputAssembler=null,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case i.UNIFORM_BUFFER:i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}i.deleteBuffer(t.glBuffer),t.glBuffer=null}}(S1.instance,this._gpuBuffer),S1.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)}},{key:"resize",value:function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Hl.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&Gl.VERTEX?(e.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),W1.gpuInputAssembler=null,n.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),n.glArrayBuffer=null):t.usage&Gl.INDEX?(e.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),W1.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Gl.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,r),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&Gl.INDIRECT||t.usage&Gl.TRANSFER_DST||t.usage&Gl.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=i.NONE)}(S1.instance,this._gpuBuffer),S1.instance.memoryStatus.bufferSize-=t,S1.instance.memoryStatus.bufferSize+=e)))}}},{key:"update",value:function(e,t){var i;this._isBufferView?console.warn("cannot update through buffer views!"):(i=void 0!==t?t:this._usage&Gl.INDIRECT?0:e.byteLength,U1(S1.instance,this._gpuBuffer,e,0,i))}}]),i}(V_),n2=function(){function e(t,i){n(this,e),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(i),this._freeCmds=new Ch(i);for(var r=0;r<i;++r)this._frees[r]=new t;this._freeIdx=i-1}return s(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var s=n,a=0;s<t;++s,++a)this._frees[s]=i[a];this._freeIdx+=n}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),r2=function(){function e(){n(this,e),this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.blitTextureCmdPool=void 0,this.beginRenderPassCmdPool=new n2(O1,1),this.bindStatesCmdPool=new n2(D1,1),this.drawCmdPool=new n2(L1,1),this.updateBufferCmdPool=new n2(N1,1),this.copyBufferToTextureCmdPool=new n2(F1,1),this.blitTextureCmdPool=new n2(G1,1)}return s(e,[{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.blitTextureCmds.length&&(this.blitTextureCmdPool.freeCmds(e.blitTextureCmds),e.blitTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release(),this.blitTextureCmdPool.release()}}]),e}(),s2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).cmdPackage=new V1,e._cmdAllocator=new r2,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUDescriptorSets=[],e._curGPUInputAssembler=null,e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new C_,e._isStateInvalied=!1,e}return s(i,[{key:"initialize",value:function(e){this._type=e.type,this._queue=e.queue;for(var t=S1.instance.bindingMappings.blockOffsets.length,i=0;i<t;i++)this._curGPUDescriptorSets.push(null)}},{key:"destroy",value:function(){this._cmdAllocator.clearCmds(this.cmdPackage)}},{key:"begin",value:function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,s){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(O1);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea.copy(i);for(var o=0;o<n.length;++o)a.clearColors[o]=n[o];a.clearDepth=r,a.clearStencil=s,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(w1.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}},{key:"bindDescriptorSet",value:function(e,t,i){var n=t.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=n,this._isStateInvalied=!0),i){var r,s=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(s){for(var a=this._curDynamicOffsets,o=s.dynamicOffsetOffsets[e],u=0;u<i.length;u++)a[o+u]=i[u];this._isStateInvalied=!0}}}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)}},{key:"setLineWidth",value:function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){var n=this._curDynamicStates;n.depthBiasConstant===e&&n.depthBiasClamp===t&&n.depthBiasSlope===i||(n.depthBiasConstant=e,n.depthBiasClamp=t,n.depthBiasSlope=i,this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){var i=this._curDynamicStates;i.depthMinBounds===e&&i.depthMaxBounds===t||(i.depthMinBounds=e,i.depthMaxBounds=t,this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){var i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;e&fc.FRONT&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0),e&fc.BACK&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){var n=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&fc.FRONT&&(n.compareMask===i&&n.reference===t||(n.reference=t,n.compareMask=i,this._isStateInvalied=!0)),e&fc.BACK&&(r.compareMask===i&&r.reference===t||(r.reference=t,r.compareMask=i,this._isStateInvalied=!0))}},{key:"draw",value:function(e){if(this._type===vc.PRIMARY&&this._isInRenderPass||this._type===vc.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,i=this._cmdAllocator.drawCmdPool.alloc(L1);i.drawInfo.copy(t),this.cmdPackage.drawCmds.push(i),this.cmdPackage.cmds.push(w1.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i){if(this._type===vc.PRIMARY&&!this._isInRenderPass||this._type===vc.SECONDARY){var n=e.gpuBuffer;if(n){var r,s=this._cmdAllocator.updateBufferCmdPool.alloc(N1),a=0;e.usage&Gl.INDIRECT||(a=void 0!==i?i:t.byteLength),r=t,s.gpuBuffer=n,s.buffer=r,s.offset=0,s.size=a,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(w1.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBuffersToTexture",value:function(e,t,i){if(this._type===vc.PRIMARY&&!this._isInRenderPass||this._type===vc.SECONDARY){var n=t.gpuTexture;if(n){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(F1);r.gpuTexture=n,r.regions=i,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(w1.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var s=n.cmdPackage.beginRenderPassCmds.array[r];++s.refCount,this.cmdPackage.beginRenderPassCmds.push(s)}for(var a=0;a<n.cmdPackage.bindStatesCmds.length;++a){var o=n.cmdPackage.bindStatesCmds.array[a];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var u=0;u<n.cmdPackage.drawCmds.length;++u){var h=n.cmdPackage.drawCmds.array[u];++h.refCount,this.cmdPackage.drawCmds.push(h)}for(var l=0;l<n.cmdPackage.updateBufferCmds.length;++l){var c=n.cmdPackage.updateBufferCmds.array[l];++c.refCount,this.cmdPackage.updateBufferCmds.push(c)}for(var _=0;_<n.cmdPackage.copyBufferToTextureCmds.length;++_){var f=n.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}for(var d=0;d<n.cmdPackage.blitTextureCmds.length;++d){var m=n.cmdPackage.blitTextureCmds.array[d];++m.refCount,this.cmdPackage.blitTextureCmds.push(m)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"pipelineBarrier",value:function(){}},{key:"bindStates",value:function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(D1);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(w1.BIND_STATES),this._isStateInvalied=!1}},{key:"blitTexture",value:function(e,t,i,n){var r=this._cmdAllocator.blitTextureCmdPool.alloc(G1);r.srcTexture=e.gpuTexture,r.dstTexture=t.gpuTexture,r.regions=i,r.filter=n,++this._numDrawCalls,this.cmdPackage.blitTextureCmds.push(r),this.cmdPackage.cmds.push(w1.BLIT_TEXTURE)}}]),i}(U_),a2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuFramebuffer=null,e}return s(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}},{key:"initialize",value:function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],i=0;i<e.colorTextures.length;i++){var n=e.colorTextures[i];n&&t.push(n.gpuTextureView)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTextureView);var s=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?s:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.width:this.gpuDepthStencilView.gpuTexture.width},set width(e){s=e},get height(){return this.isOffscreen?s:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.height:this.gpuDepthStencilView.gpuTexture.height},set height(e){}},function(e,t){for(var i=0;i<t.gpuColorViews.length;++i)if(t.gpuColorViews[i].gpuTexture.isSwapchainTexture)return void(t.isOffscreen=!1);var n=e.gl,r=[],s=n.createFramebuffer();if(s){t.glFramebuffer=s,e.stateCache.glFramebuffer!==t.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var o=t.gpuColorViews[a],u=o.gpuTexture;u&&(u.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+a,u.glTarget,u.glTexture,o.baseLevel):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+a,n.RENDERBUFFER,u.glRenderbuffer),r.push(n.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,u.width>>o.baseLevel),t.height=Math.min(t.height,u.height>>o.baseLevel))}var h=t.gpuDepthStencilView;if(h){var l=h.gpuTexture,c=x_[l.format].hasStencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;l.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,c,l.glTarget,l.glTexture,t.gpuDepthStencilView.baseLevel):n.framebufferRenderbuffer(n.FRAMEBUFFER,c,n.RENDERBUFFER,l.glRenderbuffer),t.width=Math.min(t.width,l.width>>h.baseLevel),t.height=Math.min(t.height,l.height>>h.baseLevel)}n.drawBuffers(r);var _=n.checkFramebufferStatus(n.FRAMEBUFFER);if(_!==n.FRAMEBUFFER_COMPLETE)switch(_){case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case n.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(S1.instance,this._gpuFramebuffer)}},{key:"destroy",value:function(){var e,t;this._gpuFramebuffer&&(e=S1.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)}}]),i}(X_),o2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuInputAssembler=null,e}return s(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}},{key:"initialize",value:function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var s=null,a=0;if(e.indexBuffer&&(s=e.indexBuffer.gpuBuffer))switch(s.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var o=null;e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:s,gpuIndirectBuffer:o,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var s=t.attributes[r],a=void 0!==s.stream?s.stream:0,o=t.gpuVertexBuffers[a],u=E1(s.format,i),h=x_[s.format].size;t.glAttribs[r]={name:s.name,glBuffer:o.glBuffer,glType:u,size:h,count:x_[s.format].count,stride:o.stride,componentCount:x1(u,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[a]},n[a]+=h}}(S1.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")}},{key:"destroy",value:function(){var e=S1.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var i=t.glVAOs.values(),n=i.next(),r=e.gl,s=e.stateCache.glVAO;!n.done;)r.deleteVertexArray(n.value),s===n.value&&(r.bindVertexArray(null),s=null),n=i.next();e.stateCache.glVAO=s,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}}]),i}(j_),u2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuDescriptorSetLayout=null,e}return s(i,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}},{key:"initialize",value:function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,i=-1,n=[],r=0;r<this._bindings.length;r++){var s=this._bindings[r];n.push(t),t+=s.count,s.binding>i&&(i=s.binding)}this._bindingIndices=Array(i+1).fill(-1);for(var a=this._descriptorIndices=Array(i+1).fill(-1),o=0;o<this._bindings.length;o++){var u=this._bindings[o];this._bindingIndices[u.binding]=o,a[u.binding]=n[o]}for(var h=[],l=0;l<this._bindings.length;l++){var c=this._bindings[l];if(c.descriptorType&I_)for(var _=0;_<c.count;_++)h.push(c.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:h,descriptorIndices:a,descriptorCount:t}}},{key:"destroy",value:function(){this._bindings.length=0}}]),i}(Y_),h2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuPipelineLayout=null,e}return s(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}},{key:"initialize",value:function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],i=[],n=0,r=[],s=0;s<this._setLayouts.length;s++){for(var a=this._setLayouts[s],o=a.gpuDescriptorSetLayout.dynamicBindings,u=Array(a.bindingIndices.length).fill(-1),h=0;h<o.length;h++){var l=o[h];u[l]<0&&(u[l]=n+h)}i.push(a.gpuDescriptorSetLayout),t.push(u),r.push(n),n+=o.length}this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:t,dynamicOffsetCount:n,dynamicOffsetOffsets:r}}},{key:"destroy",value:function(){this._setLayouts.length=0}}]),i}(K_),l2=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],c2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuPipelineState=null,e}return s(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}},{key:"initialize",value:function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var i=e.blendState,n=i.targets;n&&n.forEach((function(e,i){t.setTarget(i,e)})),void 0!==i.isA2C&&(t.isA2C=i.isA2C),void 0!==i.isIndepend&&(t.isIndepend=i.isIndepend),void 0!==i.blendColor&&(t.blendColor=i.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],s=0;s<31;s++)this._dynamicStates&1<<s&&r.push(1<<s);this._gpuPipelineState={glPrimitive:l2[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}}},{key:"destroy",value:function(){this._gpuPipelineState=null}}]),i}(tf),_2=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"beginRenderPass",value:function(e,t,i,n,r,s){X1(S1.instance,e.gpuRenderPass,t.gpuFramebuffer,i,n,r,s),this._isInRenderPass=!0}},{key:"draw",value:function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;q1(S1.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"setViewport",value:function(e){var t=S1.instance,i=t.stateCache,n=t.gl;i.viewport.left===e.left&&i.viewport.top===e.top&&i.viewport.width===e.width&&i.viewport.height===e.height||(n.viewport(e.left,e.top,e.width,e.height),i.viewport.left=e.left,i.viewport.top=e.top,i.viewport.width=e.width,i.viewport.height=e.height)}},{key:"setScissor",value:function(e){var t=S1.instance,i=t.stateCache,n=t.gl;i.scissorRect.x===e.x&&i.scissorRect.y===e.y&&i.scissorRect.width===e.width&&i.scissorRect.height===e.height||(n.scissor(e.x,e.y,e.width,e.height),i.scissorRect.x=e.x,i.scissorRect.y=e.y,i.scissorRect.width=e.width,i.scissorRect.height=e.height)}},{key:"updateBuffer",value:function(e,t,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var n,r=e.gpuBuffer;r&&(n=void 0!==i?i:e.usage&Gl.INDIRECT?0:t.byteLength,U1(S1.instance,r,t,0,n))}}},{key:"copyBuffersToTexture",value:function(e,t,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var n=t.gpuTexture;n&&Z1(S1.instance,e,n,i)}}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){var n=e[i];K1(S1.instance,n.cmdPackage),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){j1(S1.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}},{key:"blitTexture",value:function(e,t,i,n){var r=e.gpuTexture,s=t.gpuTexture;$1(S1.instance,r,s,i,n)}}]),i}(s2),f2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}return s(i,[{key:"initialize",value:function(e){this._type=e.type}},{key:"destroy",value:function(){}},{key:"submit",value:function(e){for(var t=0;t<e.length;t++){var i=e[t];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}]),i}(nf),d2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuRenderPass=null,e}return s(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}},{key:"initialize",value:function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()}},{key:"destroy",value:function(){this._gpuRenderPass=null}}]),i}(rf),m2=function(e){h(i,e);var t=v(i);function i(e,r){var s,a,o,u;return n(this,i),(s=t.call(this,e,r))._gpuSampler=null,s._gpuSampler={glSamplers:new Map,minFilter:s._info.minFilter,magFilter:s._info.magFilter,mipFilter:s._info.mipFilter,addressU:s._info.addressU,addressV:s._info.addressV,addressW:s._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0,getGLSampler:function(e,t,i){var n=e.gl,r=t<<16|i;if(!this.glSamplers.has(r)){var s=n.createSampler();s&&(this.glSamplers.set(r,s),n.samplerParameteri(s,n.TEXTURE_MIN_FILTER,this.glMinFilter),n.samplerParameteri(s,n.TEXTURE_MAG_FILTER,this.glMagFilter),n.samplerParameteri(s,n.TEXTURE_WRAP_S,this.glWrapS),n.samplerParameteri(s,n.TEXTURE_WRAP_T,this.glWrapT),n.samplerParameteri(s,n.TEXTURE_WRAP_R,this.glWrapR),n.samplerParameterf(s,n.TEXTURE_MIN_LOD,t),n.samplerParameterf(s,n.TEXTURE_MAX_LOD,i))}return this.glSamplers.get(r)}},a=S1.instance,o=s._gpuSampler,u=a.gl,o.minFilter===Kl.LINEAR||o.minFilter===Kl.ANISOTROPIC?o.mipFilter===Kl.LINEAR||o.mipFilter===Kl.ANISOTROPIC?o.glMinFilter=u.LINEAR_MIPMAP_LINEAR:o.mipFilter===Kl.POINT?o.glMinFilter=u.LINEAR_MIPMAP_NEAREST:o.glMinFilter=u.LINEAR:o.mipFilter===Kl.LINEAR||o.mipFilter===Kl.ANISOTROPIC?o.glMinFilter=u.NEAREST_MIPMAP_LINEAR:o.mipFilter===Kl.POINT?o.glMinFilter=u.NEAREST_MIPMAP_NEAREST:o.glMinFilter=u.NEAREST,o.magFilter===Kl.LINEAR||o.magFilter===Kl.ANISOTROPIC?o.glMagFilter=u.LINEAR:o.glMagFilter=u.NEAREST,o.glWrapS=A1[o.addressU],o.glWrapT=A1[o.addressV],o.glWrapR=A1[o.addressW],s}return s(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}},{key:"destroy",value:function(){this._gpuSampler&&(function(e,t){for(var i=e.gl,n=t.glSamplers.values().next();!n.done;){i.deleteSampler(n.value);for(var r=e.stateCache.glSamplerUnits,s=0;s<r.length;++s)r[s]===n.value&&(i.bindSampler(s,null),r[s]=null)}t.glSamplers.clear()}(S1.instance,this._gpuSampler),this._gpuSampler=null)}}]),i}(sf),p2=function(e){h(r,e);var t=v(r);function r(){var e;n(this,r);for(var i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuShader=null,e}return s(r,[{key:"gpuShader",get:function(){return null===this._gpuShader.glProgram&&function(e,t){for(var n=e.gl,r=function(e){var i=t.gpuStages[e],r=0,s="",a=1;switch(i.type){case ic.VERTEX:s="VertexShader",r=n.VERTEX_SHADER;break;case ic.FRAGMENT:s="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var o=n.createShader(r);if(o&&(i.glShader=o,n.shaderSource(i.glShader,"#version 300 es\n".concat(i.source)),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error("".concat(s," in '").concat(t.name,"' compilation failed.")),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n".concat(a++," ")}))),console.error(n.getShaderInfoLog(i.glShader));for(var u=0;u<t.gpuStages.length;u++){var h=t.gpuStages[e];h.glShader&&(n.deleteShader(h.glShader),h.glShader=null)}return{v:void 0}}},s=0;s<t.gpuStages.length;s++){var a=r(s);if("object"===i(a))return a.v}var o=n.createProgram();if(o){t.glProgram=o;for(var u=!(!B.rendering||!B.rendering.enableEffectImport),h=0;h<t.gpuStages.length;h++){var l=t.gpuStages[h];n.attachShader(t.glProgram,l.glShader)}n.linkProgram(t.glProgram);for(var c=0;c<t.gpuStages.length;c++){var _=t.gpuStages[c];_.glShader&&(n.detachShader(t.glProgram,_.glShader),n.deleteShader(_.glShader),_.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '".concat(t.name,"'.")),void console.error(n.getProgramInfoLog(t.glProgram));$("Shader '".concat(t.name,"' compilation succeeded."));var f=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(f);for(var d=0;d<f;++d){var m=n.getActiveAttrib(t.glProgram,d);if(m){var p,v=m.name.indexOf("[");p=-1!==v?m.name.substr(0,v):m.name;var y=n.getAttribLocation(t.glProgram,p),g=C1(m.type,n),S=R1(m.type,n);t.glInputs[d]={name:p,type:g,stride:S,count:m.size,size:S*m.size,glType:m.type,glLoc:y}}}var A,T,E,b,C=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(C){t.glBlocks=new Array(C);for(var R=0;R<C;++R){var x=(A=n.getActiveUniformBlockName(t.glProgram,R)).indexOf("[");-1!==x&&(A=A.substr(0,x)),b=null;for(var w=0;w<t.blocks.length;w++)if(t.blocks[w].name===A){b=t.blocks[w];break}if(b){T=R,E=n.getActiveUniformBlockParameter(t.glProgram,T,n.UNIFORM_BLOCK_DATA_SIZE);var k=u?b.flattened:b.binding+(e.bindingMappings.blockOffsets[b.set]||0);n.uniformBlockBinding(t.glProgram,T,k),t.glBlocks[R]={set:b.set,binding:b.binding,idx:T,name:A,size:E,glBinding:k}}else J("Block '".concat(A,"' does not bound"))}}for(var I=0;I<t.subpassInputs.length;++I){var P=t.subpassInputs[I];t.samplerTextures.push(new Kc(P.set,P.binding,P.name,Fl.SAMPLER2D,P.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var M=0;M<t.samplerTextures.length;++M){var O=t.samplerTextures[M];t.glSamplerTextures[M]={set:O.set,binding:O.binding,name:O.name,type:O.type,count:O.count,units:[],glUnits:null,glType:b1(O.type,n),glLoc:null}}}var D=[],L=[],N=e.stateCache.texUnitCacheMap;if(u)for(var F=0;F<t.samplerTextures.length;++F){var G=t.samplerTextures[F],V=n.getUniformLocation(t.glProgram,G.name);V&&-1!==V.id&&(D.push(t.glSamplerTextures[F]),L.push(V)),void 0===N[G.name]&&(N[G.name]=G.flattened%e.capabilities.maxTextureUnits)}else{for(var U=0,H=0;H<t.blocks.length;++H)t.blocks[H].set===e.bindingMappings.flexibleSet&&U++;for(var z=0,W=0;W<t.samplerTextures.length;++W){var X=t.samplerTextures[W],j=n.getUniformLocation(t.glProgram,X.name);if(j&&-1!==j.id&&(D.push(t.glSamplerTextures[W]),L.push(j)),void 0===N[X.name]){var q=X.binding+e.bindingMappings.samplerTextureOffsets[X.set]+z;X.set===e.bindingMappings.flexibleSet&&(q-=U),N[X.name]=q%e.capabilities.maxTextureUnits,z+=X.count-1}}}if(D.length){for(var Y=[],K=0;K<D.length;++K){var Q=D[K],Z=N[Q.name];if(void 0!==Z){Q.glLoc=L[K];for(var ee=0;ee<Q.count;++ee){for(;Y[Z];)Z=(Z+1)%e.capabilities.maxTextureUnits;Q.units.push(Z),Y[Z]=!0}}}for(var te=0,ie=0;ie<D.length;++ie){var ne=D[ie];if(!ne.glLoc){for(ne.glLoc=L[ie];Y[te];)te++;for(var re=0;re<ne.count;++re){for(;Y[te];)te=(te+1)%e.capabilities.maxTextureUnits;void 0===N[ne.name]&&(N[ne.name]=te),ne.units.push(te),Y[te]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var se=0;se<D.length;se++){var ae=D[se];ae.glUnits=new Int32Array(ae.units),n.uniform1iv(ae.glLoc,ae.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=D}}(S1.instance,this._gpuShader),this._gpuShader}},{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.stage,source:i.source,glShader:null}}}},{key:"destroy",value:function(){var e,t;this._gpuShader&&(e=S1.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null),this._gpuShader=null)}}]),r}(af),v2=function(){function e(){n(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new Oc,this.scissorRect=new xc(0,0,0,0),this.rs=new Q_,this.dss=new J_,this.bs=new $_,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return s(e,[{key:"initialize",value:function(e,t,i){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=i,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=i,this.glCurrentAttribLocs.fill(!1)}}]),e}(),y2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._gpuTexture=null,e._gpuTextureView=null,e}return s(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"gpuTextureView",get:function(){return this._gpuTextureView}},{key:"initialize",value:function(e,t){var i=e,n=e;if("texture"in e&&(i=n.texture.info,this._isTextureView=!0),this._info.copy(i),this._isPowerOf2=B_(this._info.width)&&B_(this._info.height),this._size=M_(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView){var r;if(this._viewInfo.copy(n),this._gpuTexture=n.texture._gpuTexture,(null===(r=this._gpuTexture)||void 0===r?void 0:r.format)!==i.format)return void console.log("GPU memory alias is not supported");this._gpuTextureView={gpuTexture:this._gpuTexture,type:n.type,format:n.format,baseLevel:n.baseLevel,levelCount:n.levelCount}}else this._gpuTexture={type:i.type,format:i.format,usage:i.usage,width:i.width,height:i.height,depth:i.depth,size:this._size,arrayLayer:i.layerCount,mipLevel:i.levelCount,samples:i.samples,flags:i.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},!this._gpuTexture.isSwapchainTexture&&this._gpuTexture&&(H1(S1.instance,this._gpuTexture),S1.instance.memoryStatus.textureSize+=this._size),this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount,this._gpuTextureView={gpuTexture:this._gpuTexture,type:this._viewInfo.type,format:this._viewInfo.format,baseLevel:this._viewInfo.baseLevel,levelCount:this._viewInfo.levelCount}}},{key:"destroy",value:function(){!this._isTextureView&&this._gpuTexture&&(z1(S1.instance,this._gpuTexture),S1.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}},{key:"getGLTextureHandle",value:function(){var e=this._gpuTexture;return e?e.glTexture?e.glTexture:e.glRenderbuffer?e.glRenderbuffer:0:0}},{key:"resize",value:function(e,t){if(this._info.width!==e||this._info.height!==t){this._info.levelCount===i.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=i.getLevelCount(e,t):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,i.getLevelCount(e,t)));var n=this._size;this._info.width=e,this._info.height=t,this._size=M_(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,this._gpuTexture.isSwapchainTexture||(function(e,t){if(t.size){var i=e.gl,n=t.width,r=t.height,s=t.depth,a=t.arrayLayer;switch(t.type){case zl.TEX2D:t.glTarget=i.TEXTURE_2D;var o=Math.max(n,r);if(o>e.capabilities.maxTextureSize&&ue(9100,o,e.capabilities.maxTextureSize),t.samples===ql.ONE){var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),x_[t.format].isCompressed)for(var h=0;h<t.mipLevel;++h){var l=P_(t.format,n,r,1),c=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,h,t.glInternalFmt,n,r,0,c),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else z1(e,t),H1(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case zl.TEX2D_ARRAY:t.glTarget=i.TEXTURE_2D_ARRAY;var _=Math.max(n,r);if(_>e.capabilities.maxTextureSize&&ue(9100,_,e.capabilities.maxTextureSize),a>e.capabilities.maxArrayTextureLayers&&ue(9100,a,e.capabilities.maxArrayTextureLayers),t.glTexture=i.createTexture(),t.size>0){var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D_ARRAY,t.glTexture),f.glTexture=t.glTexture),x_[t.format].isCompressed)for(var d=0;d<t.mipLevel;++d){var m=P_(t.format,n,r,a),p=new Uint8Array(m);i.compressedTexImage3D(i.TEXTURE_2D_ARRAY,d,t.glInternalFmt,n,r,a,0,p),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else i.texStorage3D(i.TEXTURE_2D_ARRAY,t.mipLevel,t.glInternalFmt,n,r,a)}break;case zl.TEX3D:t.glTarget=i.TEXTURE_3D;var v=Math.max(Math.max(n,r),s);if(v>e.capabilities.max3DTextureSize&&ue(9100,v,e.capabilities.max3DTextureSize),t.glTexture=i.createTexture(),t.size>0){var y=e.stateCache.glTexUnits[e.stateCache.texUnit];if(y.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_3D,t.glTexture),y.glTexture=t.glTexture),x_[t.format].isCompressed)for(var g=0;g<t.mipLevel;++g){var S=P_(t.format,n,r,s),A=new Uint8Array(S);i.compressedTexImage3D(i.TEXTURE_3D,g,t.glInternalFmt,n,r,s,0,A),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else i.texStorage3D(i.TEXTURE_3D,t.mipLevel,t.glInternalFmt,n,r,s)}break;case zl.CUBE:t.type=zl.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var T=Math.max(n,r);T>e.capabilities.maxCubeMapTextureSize&&ue(9100,T,e.capabilities.maxTextureSize);var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),E.glTexture=t.glTexture),x_[t.format].isCompressed)for(var b=0;b<6;++b){n=t.width,r=t.height;for(var C=0;C<t.mipLevel;++C){var R=P_(t.format,n,r,1),x=new Uint8Array(R);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+b,C,t.glInternalFmt,n,r,0,x),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else z1(e,t),H1(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=zl.TEX2D,t.glTarget=i.TEXTURE_2D}}}(S1.instance,this._gpuTexture),S1.instance.memoryStatus.textureSize-=n,S1.instance.memoryStatus.textureSize+=this._size))}}},{key:"initAsSwapchainTexture",value:function(e){var t=new Wc;t.format=e.format,t.usage=x_[e.format].hasDepth?Wl.DEPTH_STENCIL_ATTACHMENT:Wl.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)}}]),i}(of),g2="webglcontextlost";function S2(e,t){for(var i=["","WEBKIT_","MOZ_"],n=0;n<i.length;++n){var r=e.getExtension(i[n]+t);if(r)return r}return null}function A2(e){var t={EXT_texture_filter_anisotropic:S2(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:S2(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:S2(e,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:S2(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:S2(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:S2(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:S2(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:S2(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:S2(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:S2(e,"WEBGL_debug_shaders"),WEBGL_lose_context:S2(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:S2(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:S2(e,"OES_texture_half_float_linear"),OES_texture_float_linear:S2(e,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return Qh.os!==jh.ANDROID&&Qh.os!==jh.IOS&&(t.WEBGL_multi_draw=S2(e,"WEBGL_multi_draw")),t}var T2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).stateCache=new v2,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGL2ContextLostHandler=null,e._extensions=null,e._blitManager=null,e}return s(i,[{key:"extensions",get:function(){return this._extensions}},{key:"blitManager",get:function(){return this._blitManager}},{key:"initialize",value:function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(g2,this._onWebGLContextLost);var t=S1.instance.gl;this.stateCache.initialize(S1.instance.capabilities.maxTextureUnits,S1.instance.capabilities.maxUniformBufferBindings,S1.instance.capabilities.maxVertexAttributes),this._extensions=A2(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var i=Ll.RGBA8,n=Ll.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),s=t.getParameter(t.STENCIL_BITS);r&&s?n=Ll.DEPTH_STENCIL:r&&(n=Ll.DEPTH),this._colorTexture=new y2,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this._depthStencilTexture=new y2,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this.nullTex2D=S1.instance.createTexture(new Wc(zl.TEX2D,Wl.SAMPLED,Ll.RGBA8,2,2,Xl.NONE)),this.nullTexCube=S1.instance.createTexture(new Wc(zl.CUBE,Wl.SAMPLED,Ll.RGBA8,2,2,Xl.NONE,6));var a=new Mc;a.texExtent.width=2,a.texExtent.height=2;var o=new Uint8Array(this.nullTex2D.size);o.fill(0),S1.instance.copyBuffersToTexture([o],this.nullTex2D,[a]),a.texSubres.layerCount=6,S1.instance.copyBuffersToTexture([o,o,o,o,o,o],this.nullTexCube,[a]),this._blitManager=new t2}},{key:"destroy",value:function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(g2,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._blitManager&&(this._blitManager.destroy(),this._blitManager=null),this._extensions=null,this._canvas=null}},{key:"resize",value:function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||($("Resizing swapchain: ".concat(e,"x").concat(t)),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))}},{key:"_onWebGLContextLost",value:function(e){ae(11e3),Q(e)}}]),i}(W_),E2=e("WebGL2Device",function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._swapchain=null,e._context=null,e._bindingMappings=null,e._textureExclusive=new Array(Ll.COUNT),e}return s(i,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}},{key:"blitManager",get:function(){return this._swapchain.blitManager}},{key:"initialize",value:function(e){S1.setInstance(this),this._gfxAPI=Ml.WEBGL2;var t=this._bindingMappingInfo=e.bindingMappingInfo,i=[],n=[],r=t.setIndices[0];i[r]=0,n[r]=0;for(var s=1;s<t.setIndices.length;++s){var a=t.setIndices[s],o=t.setIndices[s-1];i[a]=t.maxBlockCounts[o]+i[o],n[a]=t.maxSamplerTextureCounts[o]+n[o]}for(var u=0;u<t.setIndices.length;++u){var h=t.setIndices[u];n[h]-=t.maxBlockCounts[h]}this._bindingMappings={blockOffsets:i,samplerTextureOffsets:n,flexibleSet:t.setIndices[t.setIndices.length-1]};var l=this._context=function(e){var t=null;try{if(globalThis.__globalXR.webxrCompatible){var i={alpha:Lt.ENABLE_TRANSPARENT_CANVAS,antialias:Lt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1,xrCompatible:!0};return e.getContext("webgl2",i)}var n={alpha:Lt.ENABLE_TRANSPARENT_CANVAS,antialias:Lt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",n)}catch(e){return null}return t}(H_.canvas);if(!l)return console.error("This device does not support WebGL."),!1;if(this._queue=this.createQueue(new S_(mc.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new g_(this._queue)),this._caps.maxVertexAttributes=l.getParameter(l.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=l.getParameter(l.MAX_VERTEX_UNIFORM_VECTORS),Qh.os===jh.IOS){var c=this._caps.maxVertexUniformVectors;Sl.browserType===zh.WECHAT?this._caps.maxVertexUniformVectors=c<256?c:256:Sl.browserType===zh.SAFARI&&(this._caps.maxVertexUniformVectors=c<512?c:512)}this._caps.maxFragmentUniformVectors=l.getParameter(l.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=l.getParameter(l.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=l.getParameter(l.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=l.getParameter(l.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=l.getParameter(l.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=l.getParameter(l.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxArrayTextureLayers=l.getParameter(l.MAX_ARRAY_TEXTURE_LAYERS),this._caps.max3DTextureSize=l.getParameter(l.MAX_3D_TEXTURE_SIZE),this._caps.uboOffsetAlignment=l.getParameter(l.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var _=l.getSupportedExtensions(),f="";if(_)for(var d,m=R(_);!(d=m()).done;){var p=d.value;f+="".concat(p," ")}var v=A2(l);v.WEBGL_debug_renderer_info?(this._renderer=l.getParameter(v.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=l.getParameter(v.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=l.getParameter(l.RENDERER),this._vendor=l.getParameter(l.VENDOR));var y=l.getParameter(l.VERSION);this._features.fill(!1),this.initFormatFeatures(v),this._features[Dl.ELEMENT_INDEX_UINT]=!0,this._features[Dl.INSTANCED_ARRAYS]=!0,this._features[Dl.MULTIPLE_RENDER_TARGETS]=!0,this._features[Dl.BLEND_MINMAX]=!0;var g="";return this.getFormatFeatures(Ll.ETC_RGB8)&&(g+="etc1 "),this.getFormatFeatures(Ll.ETC2_RGB8)&&(g+="etc2 "),this.getFormatFeatures(Ll.BC1)&&(g+="dxt "),this.getFormatFeatures(Ll.PVRTC_RGB2)&&(g+="pvrtc "),this.getFormatFeatures(Ll.ASTC_RGBA_4X4)&&(g+="astc "),$("WebGL2 device initialized."),$("RENDERER: ".concat(this._renderer)),$("VENDOR: ".concat(this._vendor)),$("VERSION: ".concat(y)),$("COMPRESSED_FORMAT: ".concat(g)),$("EXTENSIONS: ".concat(f)),!0}},{key:"destroy",value:function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null}},{key:"flushCommands",value:function(){}},{key:"acquire",value:function(){}},{key:"present",value:function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}},{key:"initFormatFeatures",value:function(e){this._formatFeatures.fill(jl.NONE),this._textureExclusive.fill(!0);var t=jl.RENDER_TARGET|jl.SAMPLED_TEXTURE|jl.STORAGE_TEXTURE|jl.LINEAR_FILTER|jl.VERTEX_ATTRIBUTE;this._formatFeatures[Ll.R8]=t,this._formatFeatures[Ll.RG8]=t,this._formatFeatures[Ll.RGB8]=t,this._formatFeatures[Ll.RGBA8]=t,t=jl.RENDER_TARGET|jl.SAMPLED_TEXTURE|jl.STORAGE_TEXTURE|jl.LINEAR_FILTER,this._formatFeatures[Ll.R8SN]=t,this._formatFeatures[Ll.RG8SN]=t,this._formatFeatures[Ll.RGB8SN]=t,this._formatFeatures[Ll.RGBA8SN]=t,this._formatFeatures[Ll.R5G6B5]=t,this._formatFeatures[Ll.RGBA4]=t,this._formatFeatures[Ll.RGB5A1]=t,this._formatFeatures[Ll.RGB10A2]=t,this._formatFeatures[Ll.SRGB8]=t,this._formatFeatures[Ll.SRGB8_A8]=t,this._formatFeatures[Ll.R11G11B10F]=t,this._formatFeatures[Ll.RGB9E5]=t,this._formatFeatures[Ll.DEPTH]=t,this._formatFeatures[Ll.DEPTH_STENCIL]=t,this._formatFeatures[Ll.RGB10A2UI]=jl.RENDER_TARGET|jl.STORAGE_TEXTURE|jl.SAMPLED_TEXTURE|jl.LINEAR_FILTER,t=jl.RENDER_TARGET|jl.SAMPLED_TEXTURE|jl.STORAGE_TEXTURE|jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.R16F]=t,this._formatFeatures[Ll.RG16F]=t,this._formatFeatures[Ll.RGB16F]=t,this._formatFeatures[Ll.RGBA16F]=t,t=jl.STORAGE_TEXTURE|jl.SAMPLED_TEXTURE|jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.R32F]=t,this._formatFeatures[Ll.RG32F]=t,this._formatFeatures[Ll.RGB32F]=t,this._formatFeatures[Ll.RGBA32F]=t,this._formatFeatures[Ll.RGB10A2UI]=jl.RENDER_TARGET|jl.STORAGE_TEXTURE|jl.SAMPLED_TEXTURE|jl.LINEAR_FILTER,t=jl.RENDER_TARGET|jl.STORAGE_TEXTURE|jl.SAMPLED_TEXTURE|jl.LINEAR_FILTER|jl.VERTEX_ATTRIBUTE,this._formatFeatures[Ll.R8I]=t,this._formatFeatures[Ll.R8UI]=t,this._formatFeatures[Ll.R16I]=t,this._formatFeatures[Ll.R16UI]=t,this._formatFeatures[Ll.R32I]=t,this._formatFeatures[Ll.R32UI]=t,this._formatFeatures[Ll.RG8I]=t,this._formatFeatures[Ll.RG8UI]=t,this._formatFeatures[Ll.RG16I]=t,this._formatFeatures[Ll.RG16UI]=t,this._formatFeatures[Ll.RG32I]=t,this._formatFeatures[Ll.RG32UI]=t,this._formatFeatures[Ll.RGB8I]=t,this._formatFeatures[Ll.RGB8UI]=t,this._formatFeatures[Ll.RGB16I]=t,this._formatFeatures[Ll.RGB16UI]=t,this._formatFeatures[Ll.RGB32I]=t,this._formatFeatures[Ll.RGB32UI]=t,this._formatFeatures[Ll.RGBA8I]=t,this._formatFeatures[Ll.RGBA8UI]=t,this._formatFeatures[Ll.RGBA16I]=t,this._formatFeatures[Ll.RGBA16UI]=t,this._formatFeatures[Ll.RGBA32I]=t,this._formatFeatures[Ll.RGBA32UI]=t,this._textureExclusive[Ll.R8]=!1,this._textureExclusive[Ll.RG8]=!1,this._textureExclusive[Ll.RGB8]=!1,this._textureExclusive[Ll.R5G6B5]=!1,this._textureExclusive[Ll.RGBA4]=!1,this._textureExclusive[Ll.RGB5A1]=!1,this._textureExclusive[Ll.RGBA8]=!1,this._textureExclusive[Ll.RGB10A2]=!1,this._textureExclusive[Ll.RGB10A2UI]=!1,this._textureExclusive[Ll.SRGB8_A8]=!1,this._textureExclusive[Ll.R8I]=!1,this._textureExclusive[Ll.R8UI]=!1,this._textureExclusive[Ll.R16I]=!1,this._textureExclusive[Ll.R16UI]=!1,this._textureExclusive[Ll.R32I]=!1,this._textureExclusive[Ll.R32UI]=!1,this._textureExclusive[Ll.RG8I]=!1,this._textureExclusive[Ll.RG8UI]=!1,this._textureExclusive[Ll.RG16I]=!1,this._textureExclusive[Ll.RG16UI]=!1,this._textureExclusive[Ll.RG32I]=!1,this._textureExclusive[Ll.RG32UI]=!1,this._textureExclusive[Ll.RGBA8I]=!1,this._textureExclusive[Ll.RGBA8UI]=!1,this._textureExclusive[Ll.RGBA16I]=!1,this._textureExclusive[Ll.RGBA16UI]=!1,this._textureExclusive[Ll.RGBA32I]=!1,this._textureExclusive[Ll.RGBA32UI]=!1,this._textureExclusive[Ll.DEPTH]=!1,this._textureExclusive[Ll.DEPTH_STENCIL]=!1,e.EXT_color_buffer_float&&(this._formatFeatures[Ll.R32F]|=jl.RENDER_TARGET,this._formatFeatures[Ll.RG32F]|=jl.RENDER_TARGET,this._formatFeatures[Ll.RGBA32F]|=jl.RENDER_TARGET,this._textureExclusive[Ll.R32F]=!1,this._textureExclusive[Ll.RG32F]=!1,this._textureExclusive[Ll.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._textureExclusive[Ll.R16F]=!1,this._textureExclusive[Ll.RG16F]=!1,this._textureExclusive[Ll.RGBA16F]=!1),e.OES_texture_float_linear&&(this._formatFeatures[Ll.RGB32F]|=jl.LINEAR_FILTER,this._formatFeatures[Ll.RGBA32F]|=jl.LINEAR_FILTER,this._formatFeatures[Ll.R32F]|=jl.LINEAR_FILTER,this._formatFeatures[Ll.RG32F]|=jl.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[Ll.RGB16F]|=jl.LINEAR_FILTER,this._formatFeatures[Ll.RGBA16F]|=jl.LINEAR_FILTER,this._formatFeatures[Ll.R16F]|=jl.LINEAR_FILTER,this._formatFeatures[Ll.RG16F]|=jl.LINEAR_FILTER);var i=jl.SAMPLED_TEXTURE|jl.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[Ll.ETC_RGB8]=i),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[Ll.ETC2_RGB8]=i,this._formatFeatures[Ll.ETC2_RGBA8]=i,this._formatFeatures[Ll.ETC2_SRGB8]=i,this._formatFeatures[Ll.ETC2_SRGB8_A8]=i,this._formatFeatures[Ll.ETC2_RGB8_A1]=i,this._formatFeatures[Ll.ETC2_SRGB8_A1]=i),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[Ll.BC1]=i,this._formatFeatures[Ll.BC1_ALPHA]=i,this._formatFeatures[Ll.BC1_SRGB]=i,this._formatFeatures[Ll.BC1_SRGB_ALPHA]=i,this._formatFeatures[Ll.BC2]=i,this._formatFeatures[Ll.BC2_SRGB]=i,this._formatFeatures[Ll.BC3]=i,this._formatFeatures[Ll.BC3_SRGB]=i),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[Ll.PVRTC_RGB2]=i,this._formatFeatures[Ll.PVRTC_RGBA2]=i,this._formatFeatures[Ll.PVRTC_RGB4]=i,this._formatFeatures[Ll.PVRTC_RGBA4]=i),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[Ll.ASTC_RGBA_4X4]=i,this._formatFeatures[Ll.ASTC_RGBA_5X4]=i,this._formatFeatures[Ll.ASTC_RGBA_5X5]=i,this._formatFeatures[Ll.ASTC_RGBA_6X5]=i,this._formatFeatures[Ll.ASTC_RGBA_6X6]=i,this._formatFeatures[Ll.ASTC_RGBA_8X5]=i,this._formatFeatures[Ll.ASTC_RGBA_8X6]=i,this._formatFeatures[Ll.ASTC_RGBA_8X8]=i,this._formatFeatures[Ll.ASTC_RGBA_10X5]=i,this._formatFeatures[Ll.ASTC_RGBA_10X6]=i,this._formatFeatures[Ll.ASTC_RGBA_10X8]=i,this._formatFeatures[Ll.ASTC_RGBA_10X10]=i,this._formatFeatures[Ll.ASTC_RGBA_12X10]=i,this._formatFeatures[Ll.ASTC_RGBA_12X12]=i,this._formatFeatures[Ll.ASTC_SRGBA_4X4]=i,this._formatFeatures[Ll.ASTC_SRGBA_5X4]=i,this._formatFeatures[Ll.ASTC_SRGBA_5X5]=i,this._formatFeatures[Ll.ASTC_SRGBA_6X5]=i,this._formatFeatures[Ll.ASTC_SRGBA_6X6]=i,this._formatFeatures[Ll.ASTC_SRGBA_8X5]=i,this._formatFeatures[Ll.ASTC_SRGBA_8X6]=i,this._formatFeatures[Ll.ASTC_SRGBA_8X8]=i,this._formatFeatures[Ll.ASTC_SRGBA_10X5]=i,this._formatFeatures[Ll.ASTC_SRGBA_10X6]=i,this._formatFeatures[Ll.ASTC_SRGBA_10X8]=i,this._formatFeatures[Ll.ASTC_SRGBA_10X10]=i,this._formatFeatures[Ll.ASTC_SRGBA_12X10]=i,this._formatFeatures[Ll.ASTC_SRGBA_12X12]=i)}},{key:"createCommandBuffer",value:function(e){var t=new(e.type===vc.PRIMARY?_2:s2);return t.initialize(e),t}},{key:"createSwapchain",value:function(e){var t=new T2;return this._swapchain=t,t.initialize(e),t}},{key:"createBuffer",value:function(e){var t=new i2;return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new y2;return t.initialize(e),t}},{key:"createDescriptorSet",value:function(e){var t=new g1;return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new p2;return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new o2;return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new d2;return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new a2;return t.initialize(e),t}},{key:"createDescriptorSetLayout",value:function(e){var t=new u2;return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new h2;return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new c2;return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new f2;return t.initialize(e),t}},{key:"getSampler",value:function(e){var t=sf.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new m2(e,t)),this._samplers.get(t)}},{key:"getSwapchains",value:function(){return[this._swapchain]}},{key:"getGeneralBarrier",value:function(e){var t=uf.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new uf(e,t)),this._generalBarrierss.get(t)}},{key:"getTextureBarrier",value:function(e){var t=hf.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new hf(e,t)),this._textureBarriers.get(t)}},{key:"getBufferBarrier",value:function(e){var t=lf.computeHash(e);return this._bufferBarriers.has(t)||this._bufferBarriers.set(t,new lf(e,t)),this._bufferBarriers.get(t)}},{key:"copyBuffersToTexture",value:function(e,t,i){Z1(this,e,t.gpuTexture,i)}},{key:"copyTextureToBuffers",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,s=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var o=0,u=0,h=1,l=1;switch(t.glTarget){case r.TEXTURE_2D:for(var c=0;c<n.length;c++){var _=n[c];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),o=_.texOffset.x,u=_.texOffset.y,h=_.texExtent.width,l=_.texExtent.height,r.readPixels(o,u,h,l,t.glFormat,t.glType,i[c])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),s.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,s=e.stateCache.glTexUnits[e.stateCache.texUnit];s.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),s.glTexture=i.glTexture);var a=0,o=0;switch(i.glTarget){case r.TEXTURE_2D:for(var u=0;u<n.length;u++){var h=n[u];r.texSubImage2D(r.TEXTURE_2D,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,i.glFormat,i.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var l=0;l<n.length;l++){var c=n[l],_=c.texSubres.baseArrayLayer+c.texSubres.layerCount;for(o=c.texSubres.baseArrayLayer;o<_;++o)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,i.glFormat,i.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Xl.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}}]),i}(H_));function b2(e,t,i,n){var r=(n.x-i.x)*(e.y-i.y)-(n.y-i.y)*(e.x-i.x),s=(t.x-e.x)*(e.y-i.y)-(t.y-e.y)*(e.x-i.x),a=(n.y-i.y)*(t.x-e.x)-(n.x-i.x)*(t.y-e.y);if(0!==a){var o=r/a,u=s/a;if(o>=0&&o<=1&&u>=0&&u<=1)return!0}return!1}B.WebGL2Device=E2;var C2=new In,R2=new In,x2=new In,w2=new In;function k2(e,t,i){for(var n=i.length,r=0;r<n;++r)if(b2(e,t,i[r],i[(r+1)%n]))return!0;return!1}function I2(e,t){for(var i=!1,n=e.x,r=e.y,s=t.length,a=0,o=s-1;a<s;o=a++){var u=t[a].x,h=t[a].y,l=t[o].x,c=t[o].y;h>r!=c>r&&n<(l-u)*(r-h)/(c-h)+u&&(i=!i)}return i}function B2(e,t,i,n){var r,s=i.x-t.x,a=i.y-t.y,o=s*s+a*a,u=((e.x-t.x)*s+(e.y-t.y)*a)/o;return r=n?o?u<0?t:u>1?i:C2.set(t.x+u*s,t.y+u*a):t:C2.set(t.x+u*s,t.y+u*a),s=e.x-r.x,a=e.y-r.y,Math.sqrt(s*s+a*a)}var P2=e("Intersection2D",(function e(){n(this,e)}));P2.lineLine=b2,P2.lineRect=function(e,t,i){var n=C2.set(i.x,i.y),r=R2.set(i.x,i.yMax),s=x2.set(i.xMax,i.yMax),a=w2.set(i.xMax,i.y);return!!(b2(e,t,n,r)||b2(e,t,r,s)||b2(e,t,s,a)||b2(e,t,a,n))},P2.linePolygon=k2,P2.rectRect=function(e,t){var i=e.x,n=e.y,r=e.x+e.width,s=e.y+e.height,a=t.x,o=t.y,u=t.x+t.width,h=t.y+t.height;return i<=u&&r>=a&&n<=h&&s>=o},P2.rectPolygon=function(e,t){var i=C2.set(e.x,e.y),n=R2.set(e.x,e.yMax),r=x2.set(e.xMax,e.yMax),s=w2.set(e.xMax,e.y);if(k2(i,n,t))return!0;if(k2(n,r,t))return!0;if(k2(r,s,t))return!0;if(k2(s,i,t))return!0;for(var a=0,o=t.length;a<o;++a)if(e.contains(t[a]))return!0;return!!(I2(i,t)||I2(n,t)||I2(r,t)||I2(s,t))},P2.rectCircle=function(e,t,i){var n=t.x,r=t.y,s=e.x,a=e.y,o=e.width,u=e.height,h=n,l=r;n<s?h=s:n>s+o&&(h=s+o),r<a?l=a:r>a+u&&(l=a+u);var c=n-h,_=r-l;return Math.sqrt(c*c+_*_)<=i},P2.polygonPolygon=function(e,t){var i,n;for(i=0,n=e.length;i<n;++i)if(k2(e[i],e[(i+1)%n],t))return!0;for(i=0,n=t.length;i<n;++i)if(I2(t[i],e))return!0;for(i=0,n=e.length;i<n;++i)if(I2(e[i],t))return!0;return!1},P2.circleCircle=function(e,t,i,n){return In.distance(e,i)<t+n},P2.polygonCircle=function(e,t,i){var n=t;if(I2(n,e))return!0;for(var r=0,s=e.length;r<s;r++)if(B2(n,0===r?e[e.length-1]:e[r-1],e[r],!0)<i)return!0;return!1},P2.pointInPolygon=I2,P2.pointLineDistance=B2;var M2,O2,D2,L2=wt({GRAVITY:0,RADIUS:1}),N2=wt({FREE:0,RELATIVE:1,GROUPED:2}),F2=new In(0,0),G2=new In,V2=new In,U2=new In,H2=new In,z2=rG(eG),W2=function e(){n(this,e),this.pos=new In(0,0),this.startPos=new In(0,0),this.color=new cn(0,0,0,255),this.deltaColor={r:0,g:0,b:0,a:255},this.size=0,this.deltaSize=0,this.rotation=0,this.deltaRotation=0,this.timeToLive=0,this.drawPos=new In(0,0),this.aspectRatio=1,this.dir=new In(0,0),this.radialAccel=0,this.tangentialAccel=0,this.angle=0,this.degreesPerSecond=0,this.radius=0,this.deltaRadius=0},X2=new(function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"get",value:function(){return this._get()||new W2}}]),i}(pt))((function(e){e.pos.set(F2),e.startPos.set(F2),e.color._val=4278190080,e.deltaColor.r=e.deltaColor.g=e.deltaColor.b=0,e.deltaColor.a=255,e.size=0,e.deltaSize=0,e.rotation=0,e.deltaRotation=0,e.timeToLive=0,e.drawPos.set(F2),e.aspectRatio=1,e.dir.set(F2),e.radialAccel=0,e.tangentialAccel=0,e.angle=0,e.degreesPerSecond=0,e.radius=0,e.deltaRadius=0}),1024),j2=function(){function e(t){n(this,e),this.particles=[],this.active=!1,this.uvFilled=0,this.finished=!1,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this._worldRotation=0,this.sys=t,this.particles=[],this.active=!1,this.readyToPlay=!0,this.finished=!1,this.elapsed=0,this.emitCounter=0,this.uvFilled=0,this._worldRotation=0}return s(e,[{key:"stop",value:function(){this.active=!1,this.readyToPlay=!1,this.elapsed=this.sys.duration,this.emitCounter=0}},{key:"reset",value:function(){this.active=!0,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this.finished=!1;for(var e=this.particles,t=0;t<e.length;++t)X2.put(e[t]);e.length=0}},{key:"emitParticle",value:function(e){var t=this.sys,i=X2.get();this.particles.push(i),i.timeToLive=t.life+t.lifeVar*(Math.random()-.5)*2;var n=i.timeToLive=Math.max(0,i.timeToLive);i.pos.x=t.sourcePos.x+t.posVar.x*(Math.random()-.5)*2,i.pos.y=t.sourcePos.y+t.posVar.y*(Math.random()-.5)*2;var r,s,a,o,u=t.startColor,h=t.startColorVar,l=t.endColor,c=t.endColorVar;i.color.r=r=Yt(u.r+h.r*(Math.random()-.5)*2,0,255),i.color.g=s=Yt(u.g+h.g*(Math.random()-.5)*2,0,255),i.color.b=a=Yt(u.b+h.b*(Math.random()-.5)*2,0,255),i.color.a=o=Yt(u.a+h.a*(Math.random()-.5)*2,0,255),i.deltaColor.r=(Yt(l.r+c.r*(Math.random()-.5)*2,0,255)-r)/n,i.deltaColor.g=(Yt(l.g+c.g*(Math.random()-.5)*2,0,255)-s)/n,i.deltaColor.b=(Yt(l.b+c.b*(Math.random()-.5)*2,0,255)-a)/n,i.deltaColor.a=(Yt(l.a+c.a*(Math.random()-.5)*2,0,255)-o)/n;var _=t.startSize+t.startSizeVar*(Math.random()-.5)*2;if(_=Math.max(0,_),i.size=_,-1===t.endSize)i.deltaSize=0;else{var f=t.endSize+t.endSizeVar*(Math.random()-.5)*2;f=Math.max(0,f),i.deltaSize=(f-_)/n}var d=t.startSpin+t.startSpinVar*(Math.random()-.5)*2,m=t.endSpin+t.endSpinVar*(Math.random()-.5)*2;i.rotation=d,i.deltaRotation=(m-d)/n,i.startPos.x=e.x,i.startPos.y=e.y,i.aspectRatio=t.aspectRatio||1;var p=Kt(t.angle+this._worldRotation+t.angleVar*(Math.random()-.5)*2);if(t.emitterMode===L2.GRAVITY){var v=t.speed+t.speedVar*(Math.random()-.5)*2;i.dir.x=Math.cos(p),i.dir.y=Math.sin(p),i.dir.multiplyScalar(v),i.radialAccel=t.radialAccel+t.radialAccelVar*(Math.random()-.5)*2,i.tangentialAccel=t.tangentialAccel+t.tangentialAccelVar*(Math.random()-.5)*2,t.rotationIsDir&&(i.rotation=-Qt(Math.atan2(i.dir.y,i.dir.x)))}else{var y=t.startRadius+t.startRadiusVar*(Math.random()-.5)*2,g=t.endRadius+t.endRadiusVar*(Math.random()-.5)*2;i.radius=y,i.deltaRadius=-1===t.endRadius?0:(g-y)/n,i.angle=p,i.degreesPerSecond=Kt(t.rotatePerS+t.rotatePerSVar*(Math.random()-.5)*2)}}},{key:"updateUVs",value:function(e){var t=this.renderData;if(t&&this.sys._renderSpriteFrame){for(var i=t.vData,n=this.sys._renderSpriteFrame.uv,r=e?0:this.uvFilled,s=this.particles.length,a=r;a<s;a++){var o=a*z2*4;i[o+3]=n[0],i[o+4]=n[1],i[o+12]=n[2],i[o+13]=n[3],i[o+21]=n[4],i[o+22]=n[5],i[o+30]=n[6],i[o+31]=n[7]}this.uvFilled=s}}},{key:"updateParticleBuffer",value:function(e,t,i,n){var r=i.vData,s=t.x,a=t.y,o=e.size,u=o,h=e.aspectRatio;h>1?u=o/h:o=u*h;var l=o/2,c=u/2;if(e.rotation){var _=-l,f=-c,d=l,m=c,p=-Kt(e.rotation),v=Math.cos(p),y=Math.sin(p);r[n]=_*v-f*y+s,r[n+1]=_*y+f*v+a,r[n+2]=0,r[n+9]=d*v-f*y+s,r[n+10]=d*y+f*v+a,r[n+11]=0,r[n+18]=_*v-m*y+s,r[n+19]=_*y+m*v+a,r[n+20]=0,r[n+27]=d*v-m*y+s,r[n+28]=d*y+m*v+a,r[n+29]=0}else r[n]=s-l,r[n+1]=a-c,r[n+2]=0,r[n+9]=s+l,r[n+10]=a-c,r[n+11]=0,r[n+18]=s-l,r[n+19]=a+c,r[n+20]=0,r[n+27]=s+l,r[n+28]=a+c,r[n+29]=0;cn.toArray(r,e.color,n+5),cn.toArray(r,e.color,n+14),cn.toArray(r,e.color,n+23),cn.toArray(r,e.color,n+32)}},{key:"step",value:function(e){var t=this.sys.assembler,i=this.sys,n=i.node,r=this.particles;if(e=e>t.maxParticleDeltaTime?t.maxParticleDeltaTime:e,n.updateWorldTransform(),i.positionType===N2.FREE){this._worldRotation=function(e){for(var t=0,i=e;i;)t+=i.eulerAngles.z,i=i.parent;return t}(n);var s=n.worldMatrix;G2.x=s.m12,G2.y=s.m13}else i.positionType===N2.RELATIVE?(this._worldRotation=n.eulerAngles.z,G2.x=n.position.x,G2.y=n.position.y):this._worldRotation=0;if(this.active&&i.emissionRate){var a=1/i.emissionRate;for(r.length<i.totalParticles&&(this.emitCounter+=e);r.length<i.totalParticles&&this.emitCounter>a;)this.emitParticle(G2),this.emitCounter-=a;this.elapsed+=e,-1!==i.duration&&i.duration<this.elapsed&&i.stopSystem()}var o=this.renderData,u=r.length;o.reset(),this.requestData(4*u,6*u),u>this.uvFilled&&this.updateUVs();for(var h=0;h<r.length;){V2.x=V2.y=U2.x=U2.y=H2.x=H2.y=0;var l=r[h];if(l.timeToLive-=e,l.timeToLive>0){if(i.emitterMode===L2.GRAVITY){var c=H2,_=V2,f=U2;(l.pos.x||l.pos.y)&&(_.set(l.pos),_.normalize()),f.set(_),_.multiplyScalar(l.radialAccel);var d=f.x;f.x=-f.y,f.y=d,f.multiplyScalar(l.tangentialAccel),c.set(_),c.add(f),c.add(i.gravity),c.multiplyScalar(e),l.dir.add(c),c.set(l.dir),c.multiplyScalar(e),l.pos.add(c)}else l.angle+=l.degreesPerSecond*e,l.radius+=l.deltaRadius*e,l.pos.x=-Math.cos(l.angle)*l.radius,l.pos.y=-Math.sin(l.angle)*l.radius;l.color.r+=l.deltaColor.r*e,l.color.g+=l.deltaColor.g*e,l.color.b+=l.deltaColor.b*e,l.color.a+=l.deltaColor.a*e,l.size+=l.deltaSize*e,l.size<0&&(l.size=0),l.rotation+=l.deltaRotation*e;var m=V2;m.set(l.pos),i.positionType!==N2.GROUPED&&m.add(l.startPos);var p=z2*h*4;this.updateParticleBuffer(l,m,o,p),++h}else{var v=r[h];h!==r.length-1&&(r[h]=r[r.length-1]),X2.put(v),r.length--,o.resize(o.vertexCount-4,o.indexCount-6)}}this.renderData.material=this.sys.getRenderMaterial(0),this.renderData.frame=this.sys._renderSpriteFrame,o.setRenderDrawInfoAttributes(),0!==r.length||this.active||this.readyToPlay||(this.finished=!0,i._finishedSimulation())}},{key:"requestData",value:function(e,t){var i=this.renderData.indexCount;this.renderData.request(e,t);for(var n=this.renderData.indexCount/6,r=this.renderData.iData,s=i;s<n;s++){var a=4*s;r[i++]=a,r[i++]=a+1,r[i++]=a+2,r[i++]=a+1,r[i++]=a+3,r[i++]=a+2}}},{key:"initDrawInfo",value:function(){this.renderData.setRenderDrawInfoAttributes()}}]),e}(),q2=Js,Y2=e("ParticleAsset",Hs("cc.ParticleAsset")((O2=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).spriteFrame=D2&&D2(),e}return i}(ed),D2=Ms(O2.prototype,"spriteFrame",[q2],(function(){return null})),M2=O2))||M2);B.ParticleAsset=Y2;
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
var K2={};(function(){function e(e){throw e}var t=void 0,i=!0,n=this;function r(e,i){var r,s=e.split("."),a=n;!(s[0]in a)&&a.execScript&&a.execScript("var "+s[0]);for(;s.length&&(r=s.shift());)s.length||i===t?a=a[r]?a[r]:a[r]={}:a[r]=i}var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;function a(e){if("string"==typeof e){var t,i,n=e.split("");for(t=0,i=n.length;t<i;t++)n[t]=(255&n[t].charCodeAt(0))>>>0;e=n}for(var r,s=1,a=0,o=e.length,u=0;0<o;){o-=r=1024<o?1024:o;do{a+=s+=e[u++]}while(--r);s%=65521,a%=65521}return(a<<16|s)>>>0}function o(t,i){this.index="number"==typeof i?i:0,this.i=0,this.buffer=t instanceof(s?Uint8Array:Array)?t:new(s?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&e(Error("invalid index")),this.buffer.length<=this.index&&this.f()}o.prototype.f=function(){var e,t=this.buffer,i=t.length,n=new(s?Uint8Array:Array)(i<<1);if(s)n.set(t);else for(e=0;e<i;++e)n[e]=t[e];return this.buffer=n},o.prototype.d=function(e,t,i){var n,r=this.buffer,s=this.index,a=this.i,o=r[s];if(i&&1<t&&(e=8<t?(f[255&e]<<24|f[e>>>8&255]<<16|f[e>>>16&255]<<8|f[e>>>24&255])>>32-t:f[e]>>8-t),8>t+a)o=o<<t|e,a+=t;else for(n=0;n<t;++n)o=o<<1|e>>t-n-1&1,8==++a&&(a=0,r[s++]=f[o],o=0,s===r.length&&(r=this.f()));r[s]=o,this.buffer=r,this.i=a,this.index=s},o.prototype.finish=function(){var e,t=this.buffer,i=this.index;return 0<this.i&&(t[i]<<=8-this.i,t[i]=f[t[i]],i++),s?e=t.subarray(0,i):(t.length=i,e=t),e};var u,h=new(s?Uint8Array:Array)(256);for(u=0;256>u;++u){for(var l=_=u,c=7,_=_>>>1;_;_>>>=1)l<<=1,l|=1&_,--c;h[u]=(l<<c&255)>>>0}var f=h;function d(e){this.buffer=new(s?Uint16Array:Array)(2*e),this.length=0}function m(e){var t,i,n,r,a,o,u,h,l,c=e.length,_=0,f=Number.POSITIVE_INFINITY;for(h=0;h<c;++h)e[h]>_&&(_=e[h]),e[h]<f&&(f=e[h]);for(t=1<<_,i=new(s?Uint32Array:Array)(t),n=1,r=0,a=2;n<=_;){for(h=0;h<c;++h)if(e[h]===n){for(o=0,u=r,l=0;l<n;++l)o=o<<1|1&u,u>>=1;for(l=o;l<t;l+=a)i[l]=n<<16|h;++r}++n,r<<=1,a<<=1}return[i,_,f]}function p(e,t){this.h=y,this.w=0,this.input=e,this.b=0,t&&(t.lazy&&(this.w=t.lazy),"number"==typeof t.compressionType&&(this.h=t.compressionType),t.outputBuffer&&(this.a=s&&t.outputBuffer instanceof Array?new Uint8Array(t.outputBuffer):t.outputBuffer),"number"==typeof t.outputIndex&&(this.b=t.outputIndex)),this.a||(this.a=new(s?Uint8Array:Array)(32768))}d.prototype.getParent=function(e){return 2*((e-2)/4|0)},d.prototype.push=function(e,t){var i,n,r,s=this.buffer;for(i=this.length,s[this.length++]=t,s[this.length++]=e;0<i&&(n=this.getParent(i),s[i]>s[n]);)r=s[i],s[i]=s[n],s[n]=r,r=s[i+1],s[i+1]=s[n+1],s[n+1]=r,i=n;return this.length},d.prototype.pop=function(){var e,t,i,n,r,s=this.buffer;for(t=s[0],e=s[1],this.length-=2,s[0]=s[this.length],s[1]=s[this.length+1],r=0;!((n=2*r+2)>=this.length)&&(n+2<this.length&&s[n+2]>s[n]&&(n+=2),s[n]>s[r]);)i=s[r],s[r]=s[n],s[n]=i,i=s[r+1],s[r+1]=s[n+1],s[n+1]=i,r=n;return{index:e,value:t,length:this.length}};var v,y=2,g={NONE:0,r:1,j:y,N:3},S=[];for(v=0;288>v;v++)switch(i){case 143>=v:S.push([v+48,8]);break;case 255>=v:S.push([v-144+400,9]);break;case 279>=v:S.push([v-256+0,7]);break;case 287>=v:S.push([v-280+192,8]);break;default:e("invalid literal: "+v)}function A(e,t){this.length=e,this.G=t}function T(){var t=E;switch(i){case 3===t:return[257,t-3,0];case 4===t:return[258,t-4,0];case 5===t:return[259,t-5,0];case 6===t:return[260,t-6,0];case 7===t:return[261,t-7,0];case 8===t:return[262,t-8,0];case 9===t:return[263,t-9,0];case 10===t:return[264,t-10,0];case 12>=t:return[265,t-11,1];case 14>=t:return[266,t-13,1];case 16>=t:return[267,t-15,1];case 18>=t:return[268,t-17,1];case 22>=t:return[269,t-19,2];case 26>=t:return[270,t-23,2];case 30>=t:return[271,t-27,2];case 34>=t:return[272,t-31,2];case 42>=t:return[273,t-35,3];case 50>=t:return[274,t-43,3];case 58>=t:return[275,t-51,3];case 66>=t:return[276,t-59,3];case 82>=t:return[277,t-67,4];case 98>=t:return[278,t-83,4];case 114>=t:return[279,t-99,4];case 130>=t:return[280,t-115,4];case 162>=t:return[281,t-131,5];case 194>=t:return[282,t-163,5];case 226>=t:return[283,t-195,5];case 257>=t:return[284,t-227,5];case 258===t:return[285,t-258,0];default:e("invalid length: "+t)}}p.prototype.n=function(){var n,r,a,u,h=this.input;switch(this.h){case 0:for(a=0,u=h.length;a<u;){var l,c,_,f=r=s?h.subarray(a,a+65535):h.slice(a,a+65535),d=(a+=r.length)===u,m=t,p=t,v=this.a,g=this.b;if(s){for(v=new Uint8Array(this.a.buffer);v.length<=g+f.length+5;)v=new Uint8Array(v.length<<1);v.set(this.a)}if(l=d?1:0,v[g++]=0|l,_=65536+~(c=f.length)&65535,v[g++]=255&c,v[g++]=c>>>8&255,v[g++]=255&_,v[g++]=_>>>8&255,s)v.set(f,g),g+=f.length,v=v.subarray(0,g);else{for(m=0,p=f.length;m<p;++m)v[g++]=f[m];v.length=g}this.b=g,this.a=v}break;case 1:var A=new o(new Uint8Array(this.a.buffer),this.b);A.d(1,1,i),A.d(1,2,i);var T,E,b,C=x(this,h);for(T=0,E=C.length;T<E;T++)if(b=C[T],o.prototype.d.apply(A,S[b]),256<b)A.d(C[++T],C[++T],i),A.d(C[++T],5),A.d(C[++T],C[++T],i);else if(256===b)break;this.a=A.finish(),this.b=this.a.length;break;case y:var R,I,B,P,M,O,D,L,N,F,G,V,U,H,z,W=new o(new Uint8Array(this.a),this.b),X=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],j=Array(19);for(R=y,W.d(1,1,i),W.d(R,2,i),I=x(this,h),D=k(O=w(this.L,15)),N=k(L=w(this.K,7)),B=286;257<B&&0===O[B-1];B--);for(P=30;1<P&&0===L[P-1];P--);var q,Y,K,Q,J,Z,$=B,ee=P,te=new(s?Uint32Array:Array)($+ee),ie=new(s?Uint32Array:Array)(316),ne=new(s?Uint8Array:Array)(19);for(q=Y=0;q<$;q++)te[Y++]=O[q];for(q=0;q<ee;q++)te[Y++]=L[q];if(!s)for(q=0,Q=ne.length;q<Q;++q)ne[q]=0;for(q=J=0,Q=te.length;q<Q;q+=Y){for(Y=1;q+Y<Q&&te[q+Y]===te[q];++Y);if(K=Y,0===te[q])if(3>K)for(;0<K--;)ie[J++]=0,ne[0]++;else for(;0<K;)(Z=138>K?K:138)>K-3&&Z<K&&(Z=K-3),10>=Z?(ie[J++]=17,ie[J++]=Z-3,ne[17]++):(ie[J++]=18,ie[J++]=Z-11,ne[18]++),K-=Z;else if(ie[J++]=te[q],ne[te[q]]++,3>--K)for(;0<K--;)ie[J++]=te[q],ne[te[q]]++;else for(;0<K;)(Z=6>K?K:6)>K-3&&Z<K&&(Z=K-3),ie[J++]=16,ie[J++]=Z-3,ne[16]++,K-=Z}for(n=s?ie.subarray(0,J):ie.slice(0,J),F=w(ne,7),H=0;19>H;H++)j[H]=F[X[H]];for(M=19;4<M&&0===j[M-1];M--);for(G=k(F),W.d(B-257,5,i),W.d(P-1,5,i),W.d(M-4,4,i),H=0;H<M;H++)W.d(j[H],3,i);for(H=0,z=n.length;H<z;H++)if(V=n[H],W.d(G[V],F[V],i),16<=V){switch(H++,V){case 16:U=2;break;case 17:U=3;break;case 18:U=7;break;default:e("invalid code: "+V)}W.d(n[H],U,i)}var re,se,ae,oe,ue,he,le,ce,_e=[D,O],fe=[N,L];for(ue=_e[0],he=_e[1],le=fe[0],ce=fe[1],re=0,se=I.length;re<se;++re)if(ae=I[re],W.d(ue[ae],he[ae],i),256<ae)W.d(I[++re],I[++re],i),oe=I[++re],W.d(le[oe],ce[oe],i),W.d(I[++re],I[++re],i);else if(256===ae)break;this.a=W.finish(),this.b=this.a.length;break;default:e("invalid compression type")}return this.a};var E,b,C=[];for(E=3;258>=E;E++)b=T(),C[E]=b[2]<<24|b[1]<<16|b[0];var R=s?new Uint32Array(C):C;function x(n,r){function a(t,n){var r,s,a,o,u=t.G,h=[],l=0;switch(r=R[t.length],h[l++]=65535&r,h[l++]=r>>16&255,h[l++]=r>>24,i){case 1===u:s=[0,u-1,0];break;case 2===u:s=[1,u-2,0];break;case 3===u:s=[2,u-3,0];break;case 4===u:s=[3,u-4,0];break;case 6>=u:s=[4,u-5,1];break;case 8>=u:s=[5,u-7,1];break;case 12>=u:s=[6,u-9,2];break;case 16>=u:s=[7,u-13,2];break;case 24>=u:s=[8,u-17,3];break;case 32>=u:s=[9,u-25,3];break;case 48>=u:s=[10,u-33,4];break;case 64>=u:s=[11,u-49,4];break;case 96>=u:s=[12,u-65,5];break;case 128>=u:s=[13,u-97,5];break;case 192>=u:s=[14,u-129,6];break;case 256>=u:s=[15,u-193,6];break;case 384>=u:s=[16,u-257,7];break;case 512>=u:s=[17,u-385,7];break;case 768>=u:s=[18,u-513,8];break;case 1024>=u:s=[19,u-769,8];break;case 1536>=u:s=[20,u-1025,9];break;case 2048>=u:s=[21,u-1537,9];break;case 3072>=u:s=[22,u-2049,10];break;case 4096>=u:s=[23,u-3073,10];break;case 6144>=u:s=[24,u-4097,11];break;case 8192>=u:s=[25,u-6145,11];break;case 12288>=u:s=[26,u-8193,12];break;case 16384>=u:s=[27,u-12289,12];break;case 24576>=u:s=[28,u-16385,13];break;case 32768>=u:s=[29,u-24577,13];break;default:e("invalid distance")}for(r=s,h[l++]=r[0],h[l++]=r[1],h[l++]=r[2],a=0,o=h.length;a<o;++a)v[y++]=h[a];S[h[0]]++,T[h[3]]++,g=t.length+n-1,d=null}var o,u,h,l,c,_,f,d,m,p={},v=s?new Uint16Array(2*r.length):[],y=0,g=0,S=new(s?Uint32Array:Array)(286),T=new(s?Uint32Array:Array)(30),E=n.w;if(!s){for(h=0;285>=h;)S[h++]=0;for(h=0;29>=h;)T[h++]=0}for(S[256]=1,o=0,u=r.length;o<u;++o){for(h=c=0,l=3;h<l&&o+h!==u;++h)c=c<<8|r[o+h];if(p[c]===t&&(p[c]=[]),_=p[c],!(0<g--)){for(;0<_.length&&32768<o-_[0];)_.shift();if(o+3>=u){for(d&&a(d,-1),h=0,l=u-o;h<l;++h)m=r[o+h],v[y++]=m,++S[m];break}if(0<_.length){var b=t,C=t,x=0,w=t,k=t,I=t,B=r.length,P=(k=0,_.length);e:for(;k<P;k++){if(b=_[P-k-1],w=3,3<x){for(I=x;3<I;I--)if(r[b+I-1]!==r[o+I-1])continue e;w=x}for(;258>w&&o+w<B&&r[b+w]===r[o+w];)++w;if(w>x&&(C=b,x=w),258===w)break}f=new A(x,o-C),d?d.length<f.length?(m=r[o-1],v[y++]=m,++S[m],a(f,0)):a(d,-1):f.length<E?d=f:a(f,0)}else d?a(d,-1):(m=r[o],v[y++]=m,++S[m])}_.push(o)}return v[y++]=256,S[256]++,n.L=S,n.K=T,s?v.subarray(0,y):v}function w(e,t){function i(e){var t=E[e][b[e]];t===y?(i(e+1),i(e+1)):--A[t],++b[e]}var n,r,a,o,u,h=e.length,l=new d(572),c=new(s?Uint8Array:Array)(h);if(!s)for(o=0;o<h;o++)c[o]=0;for(o=0;o<h;++o)0<e[o]&&l.push(o,e[o]);if(n=Array(l.length/2),r=new(s?Uint32Array:Array)(l.length/2),1===n.length)return c[l.pop().index]=1,c;for(o=0,u=l.length/2;o<u;++o)n[o]=l.pop(),r[o]=n[o].value;var _,f,m,p,v,y=r.length,g=new(s?Uint16Array:Array)(t),S=new(s?Uint8Array:Array)(t),A=new(s?Uint8Array:Array)(y),T=Array(t),E=Array(t),b=Array(t),C=(1<<t)-y,R=1<<t-1;for(g[t-1]=y,f=0;f<t;++f)C<R?S[f]=0:(S[f]=1,C-=R),C<<=1,g[t-2-f]=(g[t-1-f]/2|0)+y;for(g[0]=S[0],T[0]=Array(g[0]),E[0]=Array(g[0]),f=1;f<t;++f)g[f]>2*g[f-1]+S[f]&&(g[f]=2*g[f-1]+S[f]),T[f]=Array(g[f]),E[f]=Array(g[f]);for(_=0;_<y;++_)A[_]=t;for(m=0;m<g[t-1];++m)T[t-1][m]=r[m],E[t-1][m]=m;for(_=0;_<t;++_)b[_]=0;for(1===S[t-1]&&(--A[0],++b[t-1]),f=t-2;0<=f;--f){for(p=_=0,v=b[f+1],m=0;m<g[f];m++)(p=T[f+1][v]+T[f+1][v+1])>r[_]?(T[f][m]=p,E[f][m]=y,v+=2):(T[f][m]=r[_],E[f][m]=_,++_);b[f]=0,1===S[f]&&i(f)}for(a=A,o=0,u=n.length;o<u;++o)c[n[o].index]=a[o];return c}function k(t){var i,n,r,a,o=new(s?Uint16Array:Array)(t.length),u=[],h=[],l=0;for(i=0,n=t.length;i<n;i++)u[t[i]]=1+(0|u[t[i]]);for(i=1,n=16;i<=n;i++)h[i]=l,(l+=0|u[i])>1<<i&&e("overcommitted"),l<<=1;for(65536>l&&e("undercommitted"),i=0,n=t.length;i<n;i++)for(l=h[t[i]],h[t[i]]+=1,r=o[i]=0,a=t[i];r<a;r++)o[i]=o[i]<<1|1&l,l>>>=1;return o}function I(e,t){this.input=e,this.a=new(s?Uint8Array:Array)(32768),this.h=B.j;var i,n={};for(i in!t&&(t={})||"number"!=typeof t.compressionType||(this.h=t.compressionType),t)n[i]=t[i];n.outputBuffer=this.a,this.z=new p(this.input,n)}var B=g;function P(t,i){switch(this.k=[],this.l=32768,this.e=this.g=this.c=this.q=0,this.input=s?new Uint8Array(t):t,this.s=!1,this.m=O,this.B=!1,!i&&(i={})||(i.index&&(this.c=i.index),i.bufferSize&&(this.l=i.bufferSize),i.bufferType&&(this.m=i.bufferType),i.resize&&(this.B=i.resize)),this.m){case M:this.b=32768,this.a=new(s?Uint8Array:Array)(32768+this.l+258);break;case O:this.b=0,this.a=new(s?Uint8Array:Array)(this.l),this.f=this.J,this.t=this.H,this.o=this.I;break;default:e(Error("invalid inflate mode"))}}I.prototype.n=function(){var t,i,n,r,o,u,h,l=0;switch(h=this.a,t=le){case le:i=Math.LOG2E*Math.log(32768)-8;break;default:e(Error("invalid compression method"))}switch(n=i<<4|t,h[l++]=n,t){case le:switch(this.h){case B.NONE:o=0;break;case B.r:o=1;break;case B.j:o=2;break;default:e(Error("unsupported compression type"))}break;default:e(Error("invalid compression method"))}return r=o<<6|0,h[l++]=r|31-(256*n+r)%31,u=a(this.input),this.z.b=l,l=(h=this.z.n()).length,s&&((h=new Uint8Array(h.buffer)).length<=l+4&&(this.a=new Uint8Array(h.length+4),this.a.set(h),h=this.a),h=h.subarray(0,l+4)),h[l++]=u>>24&255,h[l++]=u>>16&255,h[l++]=u>>8&255,h[l++]=255&u,h},r("Zlib.Deflate",I),r("Zlib.Deflate.compress",(function(e,t){return new I(e,t).n()})),r("Zlib.Deflate.CompressionType",B),r("Zlib.Deflate.CompressionType.NONE",B.NONE),r("Zlib.Deflate.CompressionType.FIXED",B.r),r("Zlib.Deflate.CompressionType.DYNAMIC",B.j);var M=0,O=1,D={D:M,C:O};P.prototype.p=function(){for(;!this.s;){var n=ee(this,3);switch(1&n&&(this.s=i),n>>>=1){case 0:var r=this.input,a=this.c,o=this.a,u=this.b,h=t,l=t,c=t,_=o.length,f=t;switch(this.e=this.g=0,(h=r[a++])===t&&e(Error("invalid uncompressed block header: LEN (first byte)")),l=h,(h=r[a++])===t&&e(Error("invalid uncompressed block header: LEN (second byte)")),l|=h<<8,(h=r[a++])===t&&e(Error("invalid uncompressed block header: NLEN (first byte)")),c=h,(h=r[a++])===t&&e(Error("invalid uncompressed block header: NLEN (second byte)")),l===~(c|=h<<8)&&e(Error("invalid uncompressed block header: length verify")),a+l>r.length&&e(Error("input buffer is broken")),this.m){case M:for(;u+l>o.length;){if(l-=f=_-u,s)o.set(r.subarray(a,a+f),u),u+=f,a+=f;else for(;f--;)o[u++]=r[a++];this.b=u,o=this.f(),u=this.b}break;case O:for(;u+l>o.length;)o=this.f({v:2});break;default:e(Error("invalid inflate mode"))}if(s)o.set(r.subarray(a,a+l),u),u+=l,a+=l;else for(;l--;)o[u++]=r[a++];this.c=a,this.b=u,this.a=o;break;case 1:this.o(J,$);break;case 2:ie(this);break;default:e(Error("unknown BTYPE: "+n))}}return this.t()};var L,N,F=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],G=s?new Uint16Array(F):F,V=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],U=s?new Uint16Array(V):V,H=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],z=s?new Uint8Array(H):H,W=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],X=s?new Uint16Array(W):W,j=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],q=s?new Uint8Array(j):j,Y=new(s?Uint8Array:Array)(288);for(L=0,N=Y.length;L<N;++L)Y[L]=143>=L?8:255>=L?9:279>=L?7:8;var K,Q,J=m(Y),Z=new(s?Uint8Array:Array)(30);for(K=0,Q=Z.length;K<Q;++K)Z[K]=5;var $=m(Z);function ee(i,n){for(var r,s=i.g,a=i.e,o=i.input,u=i.c;a<n;)(r=o[u++])===t&&e(Error("input buffer is broken")),s|=r<<a,a+=8;return r=s&(1<<n)-1,i.g=s>>>n,i.e=a-n,i.c=u,r}function te(i,n){for(var r,s,a,o=i.g,u=i.e,h=i.input,l=i.c,c=n[0],_=n[1];u<_;)(r=h[l++])===t&&e(Error("input buffer is broken")),o|=r<<u,u+=8;return a=(s=c[o&(1<<_)-1])>>>16,i.g=o>>a,i.e=u-a,i.c=l,65535&s}function ie(e){function t(e,t,i){var n,r,s,a;for(a=0;a<e;)switch(n=te(this,t)){case 16:for(s=3+ee(this,2);s--;)i[a++]=r;break;case 17:for(s=3+ee(this,3);s--;)i[a++]=0;r=0;break;case 18:for(s=11+ee(this,7);s--;)i[a++]=0;r=0;break;default:r=i[a++]=n}return i}var i,n,r,a,o=ee(e,5)+257,u=ee(e,5)+1,h=ee(e,4)+4,l=new(s?Uint8Array:Array)(G.length);for(a=0;a<h;++a)l[G[a]]=ee(e,3);i=m(l),n=new(s?Uint8Array:Array)(o),r=new(s?Uint8Array:Array)(u),e.o(m(t.call(e,o,i,n)),m(t.call(e,u,i,r)))}function ne(t,i){var n,r;switch(this.input=t,this.c=0,!i&&(i={})||(i.index&&(this.c=i.index),i.verify&&(this.M=i.verify)),n=t[this.c++],r=t[this.c++],15&n){case le:this.method=le;break;default:e(Error("unsupported compression method"))}0!=((n<<8)+r)%31&&e(Error("invalid fcheck flag:"+((n<<8)+r)%31)),32&r&&e(Error("fdict flag is not supported")),this.A=new P(t,{index:this.c,bufferSize:i.bufferSize,bufferType:i.bufferType,resize:i.resize})}P.prototype.o=function(e,t){var i=this.a,n=this.b;this.u=e;for(var r,s,a,o,u=i.length-258;256!==(r=te(this,e));)if(256>r)n>=u&&(this.b=n,i=this.f(),n=this.b),i[n++]=r;else for(o=U[s=r-257],0<z[s]&&(o+=ee(this,z[s])),r=te(this,t),a=X[r],0<q[r]&&(a+=ee(this,q[r])),n>=u&&(this.b=n,i=this.f(),n=this.b);o--;)i[n]=i[n++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},P.prototype.I=function(e,t){var i=this.a,n=this.b;this.u=e;for(var r,s,a,o,u=i.length;256!==(r=te(this,e));)if(256>r)n>=u&&(u=(i=this.f()).length),i[n++]=r;else for(o=U[s=r-257],0<z[s]&&(o+=ee(this,z[s])),r=te(this,t),a=X[r],0<q[r]&&(a+=ee(this,q[r])),n+o>u&&(u=(i=this.f()).length);o--;)i[n]=i[n++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},P.prototype.f=function(){var e,t,i=new(s?Uint8Array:Array)(this.b-32768),n=this.b-32768,r=this.a;if(s)i.set(r.subarray(32768,i.length));else for(e=0,t=i.length;e<t;++e)i[e]=r[e+32768];if(this.k.push(i),this.q+=i.length,s)r.set(r.subarray(n,n+32768));else for(e=0;32768>e;++e)r[e]=r[n+e];return this.b=32768,r},P.prototype.J=function(e){var t,i,n,r=this.input.length/this.c+1|0,a=this.input,o=this.a;return e&&("number"==typeof e.v&&(r=e.v),"number"==typeof e.F&&(r+=e.F)),i=2>r?(n=(a.length-this.c)/this.u[2]/2*258|0)<o.length?o.length+n:o.length<<1:o.length*r,s?(t=new Uint8Array(i)).set(o):t=o,this.a=t},P.prototype.t=function(){var e,t,i,n,r,a=0,o=this.a,u=this.k,h=new(s?Uint8Array:Array)(this.q+(this.b-32768));if(0===u.length)return s?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(t=0,i=u.length;t<i;++t)for(n=0,r=(e=u[t]).length;n<r;++n)h[a++]=e[n];for(t=32768,i=this.b;t<i;++t)h[a++]=o[t];return this.k=[],this.buffer=h},P.prototype.H=function(){var e,t=this.b;return s?this.B?(e=new Uint8Array(t)).set(this.a.subarray(0,t)):e=this.a.subarray(0,t):(this.a.length>t&&(this.a.length=t),e=this.a),this.buffer=e},ne.prototype.p=function(){var t,i=this.input;return t=this.A.p(),this.c=this.A.c,this.M&&(i[this.c++]<<24|i[this.c++]<<16|i[this.c++]<<8|i[this.c++])>>>0!==a(t)&&e(Error("invalid adler-32 checksum")),t},r("Zlib.Inflate",ne),r("Zlib.Inflate.BufferType",D),D.ADAPTIVE=D.C,D.BLOCK=D.D,r("Zlib.Inflate.prototype.decompress",ne.prototype.p);var re,se,ae=new(s?Uint8Array:Array)(288);for(re=0,se=ae.length;re<se;++re)ae[re]=143>=re?8:255>=re?9:279>=re?7:8;m(ae);var oe,ue,he=new(s?Uint8Array:Array)(30);for(oe=0,ue=he.length;oe<ue;++oe)he[oe]=5;m(he);var le=8}).call(K2);var Q2=K2.Zlib;Q2.Deflate=Q2.Deflate,Q2.Deflate.compress=Q2.Deflate.compress,Q2.Inflate=Q2.Inflate,Q2.Inflate.BufferType=Q2.Inflate.BufferType,Q2.Inflate.prototype.decompress=Q2.Inflate.prototype.decompress;for(var J2=function(){function e(t){var i,r=this;n(this,e),this.pos=8,this.palette=[],this.imgData=[],this.text={},this.width=0,this.height=0,this.bits=0,this.colorType=0,this.compressionMethod=0,this.filterMethod=0,this.interlaceMethod=0,this.colors=0,this.hasAlphaChannel=!1,this.pixelBitlength=0,this.data=t,this.transparency={indexed:[],rgb:0,grayscale:0};for(var s=0,a=0,o=0;;){o=this.readUInt32();var u=function(){var e=[];for(s=0;s<4;++s)e.push(String.fromCharCode(r.data[r.pos++]));return e}.call(this).join("");switch(u){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(o);break;case"fcTL":i&&this.animation.frames.push(i),this.pos+=4,i={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};var h=this.readUInt16(),l=this.readUInt16()||100;i.delay=1e3*h/l,i.disposeOp=this.data[this.pos++],i.blendOp=this.data[this.pos++],i.data=[];break;case"IDAT":case"fdAT":for("fdAT"===u&&(this.pos+=4,o-=4),t=(null!=i?i.data:void 0)||this.imgData,s=0;o>=0?s<o:s>o;o>=0?++s:--s)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(o);var c=255-this.transparency.indexed.length;if(c>0)for(a=0;c>=0?a<c:a>c;c>=0?++a:--a)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(o)[0];break;case 2:this.transparency.rgb=this.read(o)}break;case"tEXt":var _=this.read(o),f=_.indexOf(0),d=String.fromCharCode.apply(String,_.slice(0,f));this.text[d]=String.fromCharCode.apply(String,_.slice(f+1));break;case"IEND":i&&this.animation.frames.push(i),this.colors=function(){switch(r.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this);var m=this.colorType;this.hasAlphaChannel=4===m||6===m;var p=this.colors+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bits*p,this.colorSpace=function(){switch(r.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData instanceof Uint8Array||(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=o}if(this.pos+=4,this.pos>this.data.length)throw new Error(_e(6017))}}return s(e,[{key:"read",value:function(e){var t=0,i=[];for(t=0;e>=0?t<e:t>e;e>=0?++t:--t)i.push(this.data[this.pos++]);return i}},{key:"readUInt32",value:function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]}},{key:"readUInt16",value:function(){return this.data[this.pos++]<<8|this.data[this.pos++]}},{key:"decodePixels",value:function(e){if(null==e&&(e=this.imgData),0===e.length)return new Uint8Array(0);e=new Q2.Inflate(e,{index:0,verify:!1}).decompress();for(var t=this.pixelBitlength/8,i=t*this.width,n=new Uint8Array(i*this.height),r=e.length,s=0,a=0,o=0,u=0,h=0,l=0,c=0,_=0,f=0,d=0,m=0,p=0,v=0,y=0,g=0,S=0,A=0,T=0,E=0;a<r;){switch(e[a++]){case 0:for(l=c=0;c<i;l=c+=1)n[o++]=e[a++];break;case 1:for(l=_=0;_<i;l=_+=1)u=e[a++],p=l<t?0:n[o-t],n[o++]=(u+p)%256;break;case 2:for(l=f=0;f<i;l=f+=1)u=e[a++],h=(l-l%t)/t,T=s&&n[(s-1)*i+h*t+l%t],n[o++]=(T+u)%256;break;case 3:for(l=d=0;d<i;l=d+=1)u=e[a++],h=(l-l%t)/t,p=l<t?0:n[o-t],T=s&&n[(s-1)*i+h*t+l%t],n[o++]=(u+Math.floor((p+T)/2))%256;break;case 4:for(l=m=0;m<i;l=m+=1)u=e[a++],h=(l-l%t)/t,p=l<t?0:n[o-t],0===s?T=E=0:(T=n[(s-1)*i+h*t+l%t],E=h&&n[(s-1)*i+(h-1)*t+l%t]),v=p+T-E,y=Math.abs(v-p),S=Math.abs(v-T),A=Math.abs(v-E),g=y<=S&&y<=A?p:S<=A?T:E,n[o++]=(u+g)%256;break;default:throw new Error(_e(6018,e[a-1]))}s++}return n}},{key:"copyToImageData",value:function(e,t){var i,n=this.hasAlphaChannel,r=this.colors;this.palette.length&&(i=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),r=4,n=!0);var s=e.data||e,a=s.length,o=i||t,u=0,h=0,l=0,c=0;if(1===r)for(;u<a;)l=i?4*t[u/4]:h,c=o[l++],s[u++]=c,s[u++]=c,s[u++]=c,s[u++]=n?o[l++]:255,h=l;else for(;u<a;)l=i?4*t[u/4]:h,s[u++]=o[l++],s[u++]=o[l++],s[u++]=o[l++],s[u++]=n?o[l++]:255,h=l}},{key:"decodePalette",value:function(){for(var e=this.palette,t=this.transparency.indexed||[],i=new Uint8Array((t.length||0)+e.length),n=0,r=0,s=0,a=0,o=0,u=e.length;o<u;a=o+=3)i[n++]=e[a],i[n++]=e[a+1],i[n++]=e[a+2],s=t[r++],i[n++]=null!=s?s:255;return i}},{key:"render",value:function(e){e.width=this.width,e.height=this.height;var t=e.getContext("2d"),i=t.createImageData(this.width,this.height);return this.copyToImageData(i,this.decodePixels(null)),t.putImageData(i,0,0)}}]),e}(),Z2=function(){function e(){n(this,e),this._littleEndian=!1,this._tiffData=[],this._fileDirectories=[]}return s(e,[{key:"getUint8",value:function(e){return this._tiffData[e]}},{key:"getUint16",value:function(e){return this._littleEndian?this._tiffData[e+1]<<8|this._tiffData[e]:this._tiffData[e]<<8|this._tiffData[e+1]}},{key:"getUint32",value:function(e){var t=this._tiffData;return this._littleEndian?t[e+3]<<24|t[e+2]<<16|t[e+1]<<8|t[e]:t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]}},{key:"checkLittleEndian",value:function(){var e=this.getUint16(0);if(18761===e)this._littleEndian=!0;else{if(19789!==e)throw console.log(e),TypeError(_e(6019));this._littleEndian=!1}return this._littleEndian}},{key:"hasTowel",value:function(){if(42!==this.getUint16(2))throw RangeError(_e(6020));return!0}},{key:"getFieldTypeName",value:function(e){return e in e3?e3[e]:null}},{key:"getFieldTagName",value:function(e){return e in $2?$2[e]:(re(6021,e),"Tag".concat(e))}},{key:"getFieldTypeLength",value:function(e){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(e)?1:-1!==["SHORT","SSHORT"].indexOf(e)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(e)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(e)?8:0}},{key:"getFieldValues",value:function(e,t,i,n){var r=[],s=this.getFieldTypeLength(t);if(s*i<=4)!1===this._littleEndian?r.push(n>>>8*(4-s)):r.push(n);else for(var a=0;a<i;a++){var o=s*a;s>=8?-1!==["RATIONAL","SRATIONAL"].indexOf(t)?(r.push(this.getUint32(n+o)),r.push(this.getUint32(n+o+4))):re(8e3):r.push(this.getBytes(s,n+o))}return"ASCII"===t&&r.forEach((function(e,t,i){i[t]=String.fromCharCode(e)})),r}},{key:"getBytes",value:function(e,t){if(e<=0)re(8001);else{if(e<=1)return this.getUint8(t);if(e<=2)return this.getUint16(t);if(e<=3)return this.getUint32(t)>>>8;if(e<=4)return this.getUint32(t);re(8002)}return 0}},{key:"getBits",value:function(e,t,i){i=i||0;var n=t+Math.floor(i/8),r=i+e,s=32-e,a=0,o=0;return r<=0?re(6023):r<=8?(a=24+i,o=this.getUint8(n)):r<=16?(a=16+i,o=this.getUint16(n)):r<=32?(a=i,o=this.getUint32(n)):re(6022),{bits:o<<a>>>s,byteOffset:n+Math.floor(r/8),bitOffset:r%8}}},{key:"parseFileDirectory",value:function(e){var t=this.getUint16(e),i=[],n=0,r=0;for(n=e+2,r=0;r<t;n+=12,r++){var s=this.getUint16(n),a=this.getUint16(n+2),o=this.getUint32(n+4),u=this.getUint32(n+8),h=this.getFieldTagName(s),l=this.getFieldTypeName(a),c=this.getFieldValues(h,l,o,u);i[h]={type:l,values:c}}this._fileDirectories.push(i);var _=this.getUint32(n);0!==_&&this.parseFileDirectory(_)}},{key:"clampColorSample",value:function(e,t){var i=Math.pow(2,8-t);return Math.floor(e*i+(i-1))}},{key:"parseTIFF",value:function(e,t){var i=this;if(t=t||M.document.createElement("canvas"),this._tiffData=e,this._canvas=t,this.checkLittleEndian(),this.hasTowel()){var n=this.getUint32(4);this._fileDirectories.length=0,this.parseFileDirectory(n);var r=this._fileDirectories[0],s=r.ImageWidth.values[0],a=r.ImageLength.values[0];this._canvas.width=s,this._canvas.height=a;var o=[],u=r.Compression?r.Compression.values[0]:1,h=r.SamplesPerPixel.values[0],l=[],c=0,_=!1;r.BitsPerSample.values.forEach((function(e,t){l[t]={bitsPerSample:e,hasBytesPerSample:!1,bytesPerSample:void 0},e%8==0&&(l[t].hasBytesPerSample=!0,l[t].bytesPerSample=e/8),c+=e}),this);var f=0;c%8==0&&(_=!0,f=c/8);var d,m=r.StripOffsets.values,p=m.length;if(r.StripByteCounts)d=r.StripByteCounts.values;else{if(re(8003),1!==p)throw Error(_e(6024));d=[Math.ceil(s*a*c/8)]}for(var v=1,y=1,g=0;g<p;g++){var S=m[g];o[g]=[];for(var A=d[g],T=0,E=0,b=1,C=!0,R=[],x=0,w=0,k=0;T<A;T+=b)switch(u){case 1:R=[];for(var I=0;I<h;I++){var B=l[I];if(!B.hasBytesPerSample){var P=this.getBits(B.bitsPerSample,S+T,E);throw R.push(P.bits),T=P.byteOffset-S,E=P.bitOffset,RangeError(_e(6025))}var O=B.bytesPerSample*I;R.push(this.getBytes(B.bytesPerSample,S+T+O))}if(o[g].push(R),!_)throw b=0,RangeError(_e(6026));b=f;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(C){C=!1;var D=this.getUint8(S+T);D>=0&&D<=127?v=D+1:D>=-127&&D<=-1?y=1-D:C=!0}else{for(var L=this.getUint8(S+T),N=0;N<y;N++){var F=l[w];if(!F.hasBytesPerSample)throw RangeError(_e(6025));k=k<<8*x|L,++x===F.bytesPerSample&&(R.push(k),k=x=0,w++),w===h&&(o[g].push(R),R=[],w=0)}0==--v&&(C=!0)}b=1}}if(t.getContext){var G=this._canvas.getContext("2d");G.fillStyle="rgba(255, 255, 255, 0)";var V=r.RowsPerStrip?r.RowsPerStrip.values[0]:a,U=o.length,H=a%V,z=0===H?V:H,W=V,X=0,j=r.PhotometricInterpretation.values[0],q=[],Y=0;r.ExtraSamples&&(Y=(q=r.ExtraSamples.values).length);var K=[],Q=0;r.ColorMap&&(K=r.ColorMap.values,Q=Math.pow(2,l[0].bitsPerSample));for(var J=0;J<U;J++){J+1===U&&(W=z);for(var Z=o[J].length,$=X*J,ee=0,te=0;ee<W&&te<Z;ee++)for(var ie=0;ie<s;ie++,te++){var ne=o[J][te],se=0,ae=0,oe=0,ue=1;if(Y>0)for(var he=0;he<Y;he++)if(1===q[he]||2===q[he]){ue=ne[3+he]/256;break}!function(){switch(j){case 0:var e=0;l[0].hasBytesPerSample&&(e=Math.pow(16,2*l[0].bytesPerSample)),ne.forEach((function(t,i,n){n[i]=e-t}));case 1:se=ae=oe=i.clampColorSample(ne[0],l[0].bitsPerSample);break;case 2:se=i.clampColorSample(ne[0],l[0].bitsPerSample),ae=i.clampColorSample(ne[1],l[1].bitsPerSample),oe=i.clampColorSample(ne[2],l[2].bitsPerSample);break;case 3:if(void 0===K)throw Error(_e(6027));var t=ne[0];se=i.clampColorSample(K[t],16),ae=i.clampColorSample(K[Q+t],16),oe=i.clampColorSample(K[2*Q+t],16);break;default:throw RangeError(_e(6028,j))}}(),G.fillStyle="rgba(".concat(se,", ").concat(ae,", ").concat(oe,", ").concat(ue,")"),G.fillRect(ie,$+ee,1,1)}X=W}}return this._canvas}}}]),e}(),$2={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},e3={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},t3=new Array(123),i3=0;i3<123;++i3)t3[i3]=64;for(var n3=0;n3<64;++n3)t3["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(n3)]=n3;var r3={name:"Jacob__Codec__Base64",decode:function(e){var t,i,n,r,s,a,o=[],u=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<e.length;)t=t3[e.charCodeAt(u++)]<<2|(r=t3[e.charCodeAt(u++)])>>4,i=(15&r)<<4|(s=t3[e.charCodeAt(u++)])>>2,n=(3&s)<<6|(a=t3[e.charCodeAt(u++)]),o.push(String.fromCharCode(t)),64!==s&&o.push(String.fromCharCode(i)),64!==a&&o.push(String.fromCharCode(n));return o.join("")},decodeAsArray:function(e,t){var i,n,r,s=this.decode(e),a=[];for(i=0,r=s.length/t;i<r;i++)for(a[i]=0,n=t-1;n>=0;--n)a[i]+=s.charCodeAt(i*t+n)<<8*n;return a}},s3=function(e){this.data=e,this.debug=!1,this.gpflags=void 0,this.files=0,this.unzipped=[],this.buf32k=new Array(32768),this.bIdx=0,this.modeZIP=!1,this.bytepos=0,this.bb=1,this.bits=0,this.nameBuf=[],this.fileout=void 0,this.literalTree=new Array(s3.LITERALS),this.distanceTree=new Array(32),this.treepos=0,this.Places=null,this.len=0,this.fpos=new Array(17),this.fpos[0]=0,this.flens=void 0,this.fmax=void 0};s3.gunzip=function(e){return e.constructor===Array||e.constructor,new s3(e).gunzip()[0][0]},s3.HufNode=function(){this.b0=0,this.b1=0,this.jump=null,this.jumppos=-1},s3.LITERALS=288,s3.NAMEMAX=256,s3.bitReverse=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255],s3.cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s3.cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],s3.cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],s3.cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],s3.border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],s3.prototype.gunzip=function(){return this.outputArr=[],this.nextFile(),this.unzipped},s3.prototype.readByte=function(){return this.bits+=8,this.bytepos<this.data.length?this.data.charCodeAt(this.bytepos++):-1},s3.prototype.byteAlign=function(){this.bb=1},s3.prototype.readBit=function(){var e;return this.bits++,e=1&this.bb,this.bb>>=1,0===this.bb&&(this.bb=this.readByte(),e=1&this.bb,this.bb=this.bb>>1|128),e},s3.prototype.readBits=function(e){for(var t=0,i=e;i--;)t=t<<1|this.readBit();return e&&(t=s3.bitReverse[t]>>8-e),t},s3.prototype.flushBuffer=function(){this.bIdx=0},s3.prototype.addBuffer=function(e){this.buf32k[this.bIdx++]=e,this.outputArr.push(String.fromCharCode(e)),32768===this.bIdx&&(this.bIdx=0)},s3.prototype.IsPat=function(){for(;;){if(this.fpos[this.len]>=this.fmax)return-1;if(this.flens[this.fpos[this.len]]===this.len)return this.fpos[this.len]++;this.fpos[this.len]++}},s3.prototype.Rec=function(){var e,t=this.Places[this.treepos];if(17===this.len)return-1;if(this.treepos++,this.len++,(e=this.IsPat())>=0)t.b0=e;else if(t.b0=32768,this.Rec())return-1;if((e=this.IsPat())>=0)t.b1=e,t.jump=null;else if(t.b1=32768,t.jump=this.Places[this.treepos],t.jumppos=this.treepos,this.Rec())return-1;return this.len--,0},s3.prototype.CreateTree=function(e,t,i){var n;for(this.Places=e,this.treepos=0,this.flens=i,this.fmax=t,n=0;n<17;n++)this.fpos[n]=0;return this.len=0,this.Rec()?-1:0},s3.prototype.DecodeValue=function(e){for(var t,i,n=0,r=e[n];;)if(this.readBit()){if(!(32768&r.b1))return r.b1;for(r=r.jump,t=e.length,i=0;i<t;i++)if(e[i]===r){n=i;break}}else{if(!(32768&r.b0))return r.b0;r=e[++n]}return-1},s3.prototype.DeflateLoop=function(){var e,t,i;do{var n,r;if(e=this.readBit(),0===(t=this.readBits(2)))for(this.byteAlign(),n=this.readByte(),n|=this.readByte()<<8,r=this.readByte(),65535&(n^~(r|=this.readByte()<<8))&&document.write("BlockLen checksum mismatch\n");n--;)s=this.readByte(),this.addBuffer(s);else if(1===t)for(;;)if((a=s3.bitReverse[this.readBits(7)]>>1)>23?(a=a<<1|this.readBit())>199?a=(a-=128)<<1|this.readBit():(a-=48)>143&&(a+=136):a+=256,a<256)this.addBuffer(a);else{if(256===a)break;for(a-=257,d=this.readBits(s3.cplext[a])+s3.cplens[a],a=s3.bitReverse[this.readBits(5)]>>3,s3.cpdext[a]>8?(m=this.readBits(8),m|=this.readBits(s3.cpdext[a]-8)<<8):m=this.readBits(s3.cpdext[a]),m+=s3.cpdist[a],a=0;a<d;a++){var s=this.buf32k[this.bIdx-m&32767];this.addBuffer(s)}}else if(2===t){var a,o,u,h,l,c=new Array(320);for(u=257+this.readBits(5),h=1+this.readBits(5),l=4+this.readBits(4),a=0;a<19;a++)c[a]=0;for(a=0;a<l;a++)c[s3.border[a]]=this.readBits(3);for(d=this.distanceTree.length,i=0;i<d;i++)this.distanceTree[i]=new s3.HufNode;if(this.CreateTree(this.distanceTree,19,c,0))return this.flushBuffer(),1;for(o=u+h,i=0;i<o;)if((a=this.DecodeValue(this.distanceTree))<16)c[i++]=a;else if(16===a){var _;if(i+(a=3+this.readBits(2))>o)return this.flushBuffer(),1;for(_=i?c[i-1]:0;a--;)c[i++]=_}else{if(i+(a=17===a?3+this.readBits(3):11+this.readBits(7))>o)return this.flushBuffer(),1;for(;a--;)c[i++]=0}for(d=this.literalTree.length,i=0;i<d;i++)this.literalTree[i]=new s3.HufNode;if(this.CreateTree(this.literalTree,u,c,0))return this.flushBuffer(),1;for(d=this.literalTree.length,i=0;i<d;i++)this.distanceTree[i]=new s3.HufNode;var f=new Array;for(i=u;i<c.length;i++)f[i-u]=c[i];if(this.CreateTree(this.distanceTree,h,f,0))return this.flushBuffer(),1;for(;;)if((a=this.DecodeValue(this.literalTree))>=256){var d,m;if(0==(a-=256))break;for(a--,d=this.readBits(s3.cplext[a])+s3.cplens[a],a=this.DecodeValue(this.distanceTree),s3.cpdext[a]>8?(m=this.readBits(8),m|=this.readBits(s3.cpdext[a]-8)<<8):m=this.readBits(s3.cpdext[a]),m+=s3.cpdist[a];d--;)s=this.buf32k[this.bIdx-m&32767],this.addBuffer(s)}else this.addBuffer(a)}}while(!e);return this.flushBuffer(),this.byteAlign(),0},s3.prototype.unzipFile=function(e){var t;for(this.gunzip(),t=0;t<this.unzipped.length;t++)if(this.unzipped[t][1]===e)return this.unzipped[t][0]},s3.prototype.nextFile=function(){this.outputArr=[],this.modeZIP=!1;var e=[];if(e[0]=this.readByte(),e[1]=this.readByte(),120===e[0]&&218===e[1]&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),"geonext.gxt"],this.files++),31===e[0]&&139===e[1]&&(this.skipdir(),this.unzipped[this.files]=[this.outputArr.join(""),"file"],this.files++),80===e[0]&&75===e[1]&&(this.modeZIP=!0,e[2]=this.readByte(),e[3]=this.readByte(),3===e[2]&&4===e[3])){e[0]=this.readByte(),e[1]=this.readByte(),this.gpflags=this.readByte(),this.gpflags|=this.readByte()<<8;var t=this.readByte();t|=this.readByte()<<8,this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte();var i=this.readByte();i|=this.readByte()<<8;var n=this.readByte();for(n|=this.readByte()<<8,s=0,this.nameBuf=[];i--;){var r=this.readByte();"/"===r|":"===r?s=0:s<s3.NAMEMAX-1&&(this.nameBuf[s++]=String.fromCharCode(r))}this.fileout||(this.fileout=this.nameBuf);for(var s=0;s<n;)r=this.readByte(),s++;8===t&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),this.nameBuf.join("")],this.files++),this.skipdir()}},s3.prototype.skipdir=function(){var e,t,i=[];if(8&this.gpflags&&(i[0]=this.readByte(),i[1]=this.readByte(),i[2]=this.readByte(),i[3]=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),this.modeZIP&&this.nextFile(),i[0]=this.readByte(),8!==i[0])return 0;if(this.gpflags=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),4&this.gpflags)for(i[0]=this.readByte(),i[2]=this.readByte(),this.len=i[0]+256*i[1],e=0;e<this.len;e++)this.readByte();if(8&this.gpflags)for(e=0,this.nameBuf=[];t=this.readByte();)"7"!==t&&":"!==t||(e=0),e<s3.NAMEMAX-1&&(this.nameBuf[e++]=t);if(16&this.gpflags)for(;t=this.readByte(););2&this.gpflags&&(this.readByte(),this.readByte()),this.DeflateLoop(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.modeZIP&&this.nextFile()};var a3,o3,u3,h3,l3,c3,_3,f3,d3,m3,p3,v3,y3,g3,S3,A3,T3,E3,b3,C3,R3,x3,w3,k3,I3,B3,P3,M3,O3,D3,L3,N3,F3,G3,V3,U3,H3,z3,W3,X3,j3,q3,Y3,K3,Q3,J3,Z3,$3,e5,t5,i5,n5,r5,s5,a5={name:"Jacob__Codec"};function o5(e){var t=e.parent,i=e.getComponent(A5);return t&&i?o5(t):e.getComponentsInChildren(A5)}a5.Base64=r3,a5.GZip=s3,a5.unzip=function(){return a5.GZip.gunzip.apply(a5.GZip,arguments)},a5.unzipBase64=function(){var e=a5.Base64.decode.apply(a5.Base64,arguments);try{return a5.GZip.gunzip.call(a5.GZip,e)}catch(t){return e.slice(7)}},a5.unzipBase64AsArray=function(e,t){t=t||1;var i,n,r,s=this.unzipBase64(e),a=[];for(i=0,r=s.length/t;i<r;i++)for(a[i]=0,n=t-1;n>=0;--n)a[i]+=s.charCodeAt(i*t+n)<<8*n;return a},a5.unzipAsArray=function(e,t){t=t||1;var i,n,r,s=this.unzip(e),a=[];for(i=0,r=s.length/t;i<r;i++)for(a[i]=0,n=t-1;n>=0;--n)a[i]+=s.charCodeAt(i*t+n)<<8*n;return a},function(e){e[e.JPG=0]="JPG",e[e.PNG=1]="PNG",e[e.TIFF=2]="TIFF",e[e.WEBP=3]="WEBP",e[e.PVR=4]="PVR",e[e.ETC=5]="ETC",e[e.S3TC=6]="S3TC",e[e.ATITC=7]="ATITC",e[e.TGA=8]="TGA",e[e.RAWDATA=9]="RAWDATA",e[e.UNKNOWN=10]="UNKNOWN"}(s5||(s5={}));var u5,h5,l5,c5,_5,f5,d5,m5,p5,v5,y5,g5,S5,A5=e("ParticleSystem2D",(a3=Hs("cc.ParticleSystem2D"),o3=Aa(Y2),u3=Aa(sF),h3=Aa(N2),l3=Aa(L2),c3=Zs("preview"),a3((r5=n5=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this)).duration=d3&&d3(),e.emissionRate=m3&&m3(),e.life=p3&&p3(),e.lifeVar=v3&&v3(),e.angle=y3&&y3(),e.angleVar=g3&&g3(),e.startSize=S3&&S3(),e.startSizeVar=A3&&A3(),e.endSize=T3&&T3(),e.endSizeVar=E3&&E3(),e.startSpin=b3&&b3(),e.startSpinVar=C3&&C3(),e.endSpin=R3&&R3(),e.endSpinVar=x3&&x3(),e.sourcePos=w3&&w3(),e.posVar=k3&&k3(),e.emitterMode=I3&&I3(),e.gravity=B3&&B3(),e.speed=P3&&P3(),e.speedVar=M3&&M3(),e.tangentialAccel=O3&&O3(),e.tangentialAccelVar=D3&&D3(),e.radialAccel=L3&&L3(),e.radialAccelVar=N3&&N3(),e.rotationIsDir=F3&&F3(),e.startRadius=G3&&G3(),e.startRadiusVar=V3&&V3(),e.endRadius=U3&&U3(),e.endRadiusVar=H3&&H3(),e.rotatePerS=z3&&z3(),e.rotatePerSVar=W3&&W3(),e.aspectRatio=1,e.playOnLoad=X3&&X3(),e.autoRemoveOnFinish=j3&&j3(),e._preview=q3&&q3(),e._custom=Y3&&Y3(),e._file=K3&&K3(),e._spriteFrame=Q3&&Q3(),e._totalParticles=J3&&J3(),e._startColor=Z3&&Z3(),e._startColorVar=$3&&$3(),e._endColor=e5&&e5(),e._endColorVar=t5&&t5(),e._positionType=i5&&i5(),e._stopped=!0,e._useFile=void 0,e.initProperties(),e._useFile=!1,e}return s(i,[{key:"custom",get:function(){return this._custom},set:function(e){this._custom!==e&&(this._custom=e,this._applyFile(),this._updateMaterial())}},{key:"file",get:function(){return this._file},set:function(e){this._file!==e&&(this._file=e,e?this._applyFile():this.custom=!0)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._renderSpriteFrame!==e&&(this._renderSpriteFrame=e,e&&!e._uuid||(this._spriteFrame=e),this._applySpriteFrame())}},{key:"particleCount",get:function(){return this._simulator.particles.length}},{key:"totalParticles",get:function(){return this._totalParticles},set:function(e){this._totalParticles!==e&&(this._totalParticles=e)}},{key:"startColor",get:function(){return this._startColor},set:function(e){this._startColor.r=e.r,this._startColor.g=e.g,this._startColor.b=e.b,this._startColor.a=e.a}},{key:"startColorVar",get:function(){return this._startColorVar},set:function(e){this._startColorVar.r=e.r,this._startColorVar.g=e.g,this._startColorVar.b=e.b,this._startColorVar.a=e.a}},{key:"color",get:function(){return this._color},set:function(){}},{key:"endColor",get:function(){return this._endColor},set:function(e){this._endColor.r=e.r,this._endColor.g=e.g,this._endColor.b=e.b,this._endColor.a=e.a}},{key:"endColorVar",get:function(){return this._endColorVar},set:function(e){this._endColorVar.r=e.r,this._endColorVar.g=e.g,this._endColorVar.b=e.b,this._endColorVar.a=e.a}},{key:"positionType",get:function(){return this._positionType},set:function(e){this._positionType=e,this._updateMaterial(),this._updatePositionType()}},{key:"preview",get:function(){return this._preview},set:function(e){e?this._startPreview():this._stopPreview(),this._preview=e}},{key:"stopped",get:function(){return this._stopped}},{key:"active",get:function(){return this._simulator.active}},{key:"assembler",get:function(){return this._assembler}},{key:"onEnable",value:function(){g(l(i.prototype),"onEnable",this).call(this),this._updateMaterial(),this._updatePositionType()}},{key:"onDestroy",value:function(){g(l(i.prototype),"onDestroy",this).call(this),this.autoRemoveOnFinish&&(this.autoRemoveOnFinish=!1),this._simulator.uvFilled=0,this._simulator.renderData&&this._assembler&&this._assembler.removeData(this._simulator.renderData)}},{key:"initProperties",value:function(){this._previewTimer=null,this._focused=!1,this.aspectRatio=1,this._simulator=new j2(this)}},{key:"onFocusInEditor",value:function(){this._focused=!0;for(var e=o5(this.node),t=0;t<e.length;++t)e[t]._startPreview()}},{key:"onLostFocusInEditor",value:function(){this._focused=!1;for(var e=o5(this.node),t=0;t<e.length;++t)e[t]._stopPreview()}},{key:"_startPreview",value:function(){this._preview&&this.resetSystem()}},{key:"_stopPreview",value:function(){this._preview&&(this.resetSystem(),this.stopSystem()),this._previewTimer&&clearInterval(this._previewTimer)}},{key:"__preload",value:function(){g(l(i.prototype),"__preload",this).call(this),this._custom&&this.spriteFrame&&!this._renderSpriteFrame?this._applySpriteFrame():this._file&&(this._custom?!this._getTexture()&&this._applyFile():this._applyFile()),this.playOnLoad&&this.resetSystem()}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._assembler&&this._assembler.createData&&(this._simulator.renderData=this._assembler.createData(this),this._simulator.renderData.particleInitRenderDrawInfo(this.renderEntity),this._simulator.initDrawInfo())}},{key:"lateUpdate",value:function(e){this._simulator.finished||this._simulator.step(e)}},{key:"addParticle",value:function(){}},{key:"stopSystem",value:function(){this._stopped=!0,this._simulator.stop()}},{key:"resetSystem",value:function(){this._stopped=!1,this._simulator.reset(),this.markForUpdateRenderData()}},{key:"isFull",value:function(){return this.particleCount>=this.totalParticles}},{key:"_applyFile",value:function(){var e=this._file;if(e){if(!e)return void ue(6029);if(!this.isValid)return;this._plistFile=e.nativeUrl,this._custom||(this._spriteFrame!==e.spriteFrame&&(this.spriteFrame=e.spriteFrame),this._initWithDictionary(e._nativeAsset)),this._spriteFrame?!this._renderSpriteFrame&&this._spriteFrame&&this._applySpriteFrame():e.spriteFrame?this.spriteFrame=e.spriteFrame:this._custom&&this._initTextureWithDictionary(e._nativeAsset)}}},{key:"_initTextureWithDictionary",value:function(e){var t,i=this;if(e.spriteFrameUuid){var n=e.spriteFrameUuid;NS.loadAny(n,(function(t,n){t?(e.spriteFrameUuid=void 0,i._initTextureWithDictionary(e),J(t)):i.spriteFrame=n}))}else{var r=al(this._plistFile,e.textureFileName||"");if(e.textureFileName)NS.loadRemote(r,(function(t,n){t?(e.textureFileName=void 0,i._initTextureWithDictionary(e),J(t)):i.spriteFrame=n?sF.createWithImage(n):sF.createWithImage(HS.get("white-texture"))}));else if(e.textureImageData){var s=e.textureImageData;if(!(s&&s.length>0))return!1;var a=r;this.file&&(a+="-".concat(this.file.uuid));var o=NS.assets.get(a);if(!o){var u=a5.unzipBase64AsArray(s,1);if(!u)return ae(6030,this._file.name),!1;var h=(t=u).length>8&&137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]&&13===t[4]&&10===t[5]&&26===t[6]&&10===t[7]?s5.PNG:t.length>2&&(73===t[0]&&73===t[1]||77===t[0]&&77===t[1]||255===t[0]&&216===t[1])?s5.TIFF:s5.UNKNOWN;if(h!==s5.TIFF&&h!==s5.PNG)return ae(6031,this._file.name),!1;var l=M.document.createElement("canvas");h===s5.PNG?new J2(u).render(l):(this._tiffReader||(this._tiffReader=new Z2),this._tiffReader.parseTIFF(u,l)),o=new bd(l),NS.assets.add(a,o)}o||ae(6032,this._file.name),this.spriteFrame=o?sF.createWithImage(o):sF.createWithImage(HS.get("white-texture"))}}return!0}},{key:"_initWithDictionary",value:function(e){this._useFile=!0,this.totalParticles=parseInt(e.maxParticles||0),this.life=parseFloat(e.particleLifespan||0),this.lifeVar=parseFloat(e.particleLifespanVariance||0);var t=e.emissionRate;this.emissionRate=t||Math.min(this.totalParticles/this.life,Number.MAX_VALUE),this.duration=parseFloat(e.duration||0),this._srcBlendFactor=parseInt(e.blendFuncSource||$l.SRC_ALPHA),this._dstBlendFactor=parseInt(e.blendFuncDestination||$l.ONE_MINUS_SRC_ALPHA);var i=this._startColor;i.r=255*parseFloat(e.startColorRed||0),i.g=255*parseFloat(e.startColorGreen||0),i.b=255*parseFloat(e.startColorBlue||0),i.a=255*parseFloat(e.startColorAlpha||0);var n=this._startColorVar;n.r=255*parseFloat(e.startColorVarianceRed||0),n.g=255*parseFloat(e.startColorVarianceGreen||0),n.b=255*parseFloat(e.startColorVarianceBlue||0),n.a=255*parseFloat(e.startColorVarianceAlpha||0);var r=this._endColor;r.r=255*parseFloat(e.finishColorRed||0),r.g=255*parseFloat(e.finishColorGreen||0),r.b=255*parseFloat(e.finishColorBlue||0),r.a=255*parseFloat(e.finishColorAlpha||0);var s=this._endColorVar;if(s.r=255*parseFloat(e.finishColorVarianceRed||0),s.g=255*parseFloat(e.finishColorVarianceGreen||0),s.b=255*parseFloat(e.finishColorVarianceBlue||0),s.a=255*parseFloat(e.finishColorVarianceAlpha||0),this.startSize=parseFloat(e.startParticleSize||0),this.startSizeVar=parseFloat(e.startParticleSizeVariance||0),this.endSize=parseFloat(e.finishParticleSize||0),this.endSizeVar=parseFloat(e.finishParticleSizeVariance||0),this.positionType=parseFloat(void 0!==e.positionType?e.positionType:N2.FREE),this.sourcePos.set(0,0),this.posVar.set(parseFloat(e.sourcePositionVariancex||0),parseFloat(e.sourcePositionVariancey||0)),this.angle=parseFloat(e.angle||0),this.angleVar=parseFloat(e.angleVariance||0),this.startSpin=parseFloat(e.rotationStart||0),this.startSpinVar=parseFloat(e.rotationStartVariance||0),this.endSpin=parseFloat(e.rotationEnd||0),this.endSpinVar=parseFloat(e.rotationEndVariance||0),this.emitterMode=parseInt(e.emitterType||L2.GRAVITY),this.emitterMode===L2.GRAVITY){this.gravity.set(parseFloat(e.gravityx||0),parseFloat(e.gravityy||0)),this.speed=parseFloat(e.speed||0),this.speedVar=parseFloat(e.speedVariance||0),this.radialAccel=parseFloat(e.radialAcceleration||0),this.radialAccelVar=parseFloat(e.radialAccelVariance||0),this.tangentialAccel=parseFloat(e.tangentialAcceleration||0),this.tangentialAccelVar=parseFloat(e.tangentialAccelVariance||0);var a=e.rotationIsDir||"";null!==a?(a=a.toString().toLowerCase(),this.rotationIsDir="true"===a||"1"===a):this.rotationIsDir=!1}else{if(this.emitterMode!==L2.RADIUS)return ae(6009),!1;this.startRadius=parseFloat(e.maxRadius||0),this.startRadiusVar=parseFloat(e.maxRadiusVariance||0),this.endRadius=parseFloat(e.minRadius||0),this.endRadiusVar=parseFloat(e.minRadiusVariance||0),this.rotatePerS=parseFloat(e.rotatePerSecond||0),this.rotatePerSVar=parseFloat(e.rotatePerSecondVariance||0)}return this._initTextureWithDictionary(e),!0}},{key:"_syncAspect",value:function(){if(this._renderSpriteFrame){var e=this._renderSpriteFrame.rect;this.aspectRatio=e.width/e.height}}},{key:"_applySpriteFrame",value:function(){this._renderSpriteFrame=this._renderSpriteFrame||this._spriteFrame,this._renderSpriteFrame?this._renderSpriteFrame.texture&&(this._simulator&&this._simulator.updateUVs(!0),this._syncAspect(),this._updateMaterial(),this._stopped=!1,this.markForUpdateRenderData()):this.resetSystem()}},{key:"_getTexture",value:function(){return this._renderSpriteFrame&&this._renderSpriteFrame.texture}},{key:"_updateMaterial",value:function(){if(this._customMaterial){this.setMaterial(this._customMaterial,0);var e=this.getRenderMaterial(0).passes[0].blendState.targets[0];this._dstBlendFactor=e.blendDst,this._srcBlendFactor=e.blendSrc}var t=this.getMaterialInstance(0);t&&t.recompileShaders({USE_LOCAL:this._positionType!==N2.FREE}),t&&t.passes.length>0&&this._updateBlendFunc()}},{key:"_finishedSimulation",value:function(){this.resetSystem(),this.stopSystem(),this.markForUpdateRenderData(),this.autoRemoveOnFinish&&this._stopped&&this.node.destroy()}},{key:"_canRender",value:function(){return g(l(i.prototype),"_canRender",this).call(this)&&!this._stopped&&null!==this._renderSpriteFrame&&void 0!==this._renderSpriteFrame}},{key:"_render",value:function(e){this._positionType===N2.RELATIVE?e.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node.parent):this.positionType===N2.GROUPED?e.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node):e.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,null)}},{key:"_updatePositionType",value:function(){this._positionType===N2.RELATIVE?(this._renderEntity.setRenderTransform(this.node.parent),this._renderEntity.setUseLocal(!0)):this.positionType===N2.GROUPED?(this._renderEntity.setRenderTransform(this.node),this._renderEntity.setUseLocal(!0)):(this._renderEntity.setRenderTransform(null),this._renderEntity.setUseLocal(!1))}}]),i}(LV),n5.EmitterMode=L2,n5.PositionType=N2,n5.DURATION_INFINITY=-1,n5.START_SIZE_EQUAL_TO_END_SIZE=-1,n5.START_RADIUS_EQUAL_TO_END_RADIUS=-1,x((f3=r5).prototype,"file",[o3],Object.getOwnPropertyDescriptor(f3.prototype,"file"),f3.prototype),x(f3.prototype,"spriteFrame",[u3],Object.getOwnPropertyDescriptor(f3.prototype,"spriteFrame"),f3.prototype),d3=Ms(f3.prototype,"duration",[Js],(function(){return-1})),m3=Ms(f3.prototype,"emissionRate",[Js],(function(){return 10})),p3=Ms(f3.prototype,"life",[Js],(function(){return 1})),v3=Ms(f3.prototype,"lifeVar",[Js],(function(){return 0})),x(f3.prototype,"color",[Ta],Object.getOwnPropertyDescriptor(f3.prototype,"color"),f3.prototype),y3=Ms(f3.prototype,"angle",[Js],(function(){return 90})),g3=Ms(f3.prototype,"angleVar",[Js],(function(){return 20})),S3=Ms(f3.prototype,"startSize",[Js],(function(){return 50})),A3=Ms(f3.prototype,"startSizeVar",[Js],(function(){return 0})),T3=Ms(f3.prototype,"endSize",[Js],(function(){return 0})),E3=Ms(f3.prototype,"endSizeVar",[Js],(function(){return 0})),b3=Ms(f3.prototype,"startSpin",[Js],(function(){return 0})),C3=Ms(f3.prototype,"startSpinVar",[Js],(function(){return 0})),R3=Ms(f3.prototype,"endSpin",[Js],(function(){return 0})),x3=Ms(f3.prototype,"endSpinVar",[Js],(function(){return 0})),w3=Ms(f3.prototype,"sourcePos",[Js],(function(){return In.ZERO.clone()})),k3=Ms(f3.prototype,"posVar",[Js],(function(){return In.ZERO.clone()})),x(f3.prototype,"positionType",[h3],Object.getOwnPropertyDescriptor(f3.prototype,"positionType"),f3.prototype),I3=Ms(f3.prototype,"emitterMode",[Js,l3],(function(){return L2.GRAVITY})),B3=Ms(f3.prototype,"gravity",[Js],(function(){return In.ZERO.clone()})),P3=Ms(f3.prototype,"speed",[Js],(function(){return 180})),M3=Ms(f3.prototype,"speedVar",[Js],(function(){return 50})),O3=Ms(f3.prototype,"tangentialAccel",[Js],(function(){return 80})),D3=Ms(f3.prototype,"tangentialAccelVar",[Js],(function(){return 0})),L3=Ms(f3.prototype,"radialAccel",[Js],(function(){return 0})),N3=Ms(f3.prototype,"radialAccelVar",[Js],(function(){return 0})),F3=Ms(f3.prototype,"rotationIsDir",[Js],(function(){return!1})),G3=Ms(f3.prototype,"startRadius",[Js],(function(){return 0})),V3=Ms(f3.prototype,"startRadiusVar",[Js],(function(){return 0})),U3=Ms(f3.prototype,"endRadius",[Js],(function(){return 0})),H3=Ms(f3.prototype,"endRadiusVar",[Js],(function(){return 0})),z3=Ms(f3.prototype,"rotatePerS",[Js],(function(){return 0})),W3=Ms(f3.prototype,"rotatePerSVar",[Js],(function(){return 0})),X3=Ms(f3.prototype,"playOnLoad",[Js],(function(){return!0})),j3=Ms(f3.prototype,"autoRemoveOnFinish",[Js],(function(){return!1})),q3=Ms(f3.prototype,"_preview",[c3],(function(){return!0})),Y3=Ms(f3.prototype,"_custom",[Js],(function(){return!1})),K3=Ms(f3.prototype,"_file",[Js],(function(){return null})),Q3=Ms(f3.prototype,"_spriteFrame",[Js],(function(){return null})),J3=Ms(f3.prototype,"_totalParticles",[Js],(function(){return 150})),Z3=Ms(f3.prototype,"_startColor",[Js],(function(){return new cn(255,255,255,255)})),$3=Ms(f3.prototype,"_startColorVar",[Js],(function(){return new cn(0,0,0,0)})),e5=Ms(f3.prototype,"_endColor",[Js],(function(){return new cn(255,255,255,0)})),t5=Ms(f3.prototype,"_endColorVar",[Js],(function(){return new cn(0,0,0,0)})),i5=Ms(f3.prototype,"_positionType",[Js],(function(){return N2.FREE})),_3=f3))||_3)),T5=function(){function e(t,i){n(this,e),this.point=new In,this.dir=new In,this.distance=0,this.time=0,t&&this.point.set(t),i&&this.dir.set(i)}return s(e,[{key:"setPoint",value:function(e,t){this.point.x=e,this.point.y=t}},{key:"setDir",value:function(e,t){this.dir.x=e,this.dir.y=t}}]),e}(),E5=e("MotionStreak",(u5=Hs("cc.MotionStreak"),h5=Aa(Qm),u5((g5=y5=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._preview=_5&&_5(),e._fadeTime=f5&&f5(),e._minSeg=d5&&d5(),e._stroke=m5&&m5(),e._texture=p5&&p5(),e._fastMode=v5&&v5(),e._points=[],e}return s(i,[{key:"preview",get:function(){return this._preview},set:function(e){this._preview=e,this.reset()}},{key:"fadeTime",get:function(){return this._fadeTime},set:function(e){this._fadeTime=e,this.reset()}},{key:"minSeg",get:function(){return this._minSeg},set:function(e){this._minSeg=e}},{key:"stroke",get:function(){return this._stroke},set:function(e){this._stroke=e}},{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e)}},{key:"fastMode",get:function(){return this._fastMode},set:function(e){this._fastMode=e}},{key:"points",get:function(){return this._points}},{key:"onEnable",value:function(){g(l(i.prototype),"onEnable",this).call(this),this.reset()}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this.renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.renderData.material=this.material,this._updateColor())}},{key:"onFocusInEditor",value:function(){this._preview&&this.reset()}},{key:"onLostFocusInEditor",value:function(){this._preview&&this.reset()}},{key:"reset",value:function(){this._points.length=0,this.renderData&&this.renderData.clear()}},{key:"lateUpdate",value:function(e){this._assembler&&this._assembler.update(this,e)}},{key:"_render",value:function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)}}]),i}(LV),y5.Point=T5,x((c5=g5).prototype,"texture",[h5],Object.getOwnPropertyDescriptor(c5.prototype,"texture"),c5.prototype),_5=Ms(c5.prototype,"_preview",[Js],(function(){return!1})),f5=Ms(c5.prototype,"_fadeTime",[Js],(function(){return 1})),d5=Ms(c5.prototype,"_minSeg",[Js],(function(){return 1})),m5=Ms(c5.prototype,"_stroke",[Js],(function(){return 64})),p5=Ms(c5.prototype,"_texture",[Js],(function(){return null})),v5=Ms(c5.prototype,"_fastMode",[Js],(function(){return!1})),l5=c5))||l5)),b5=(new In,new In),C5=new In;function R5(e,t){return e.x=-t.y,e.y=t.x,e}var x5={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,42),t},update:function(e,t){var i,n=e.stroke/2,r=e.node.worldMatrix,s=r.m12,a=r.m13,o=e.points;if(o.length>1){var u=o[0],h=u.point.x-s,l=u.point.y-a;h*h+l*l<e.minSeg&&(i=u)}i||(i=new E5.Point,o.unshift(i)),i.setPoint(s,a),i.time=e.fadeTime+t;var c,_=0;if(!(o.length<2)){var f=e.renderData;this.updateRenderDataCache(e,f);var d=e.color,m=d.r,p=d.g,v=d.b,y=d.a,g=o[1];g.distance=In.subtract(C5,i.point,g.point).length(),C5.normalize(),g.setDir(C5.x,C5.y),i.setDir(C5.x,C5.y),f.dataLength=2*o.length;for(var S=f.data,A=e.fadeTime,T=!1,E=o.length-1;E>=0;E--){var b=o[E],C=b.point,R=b.dir;if(b.time-=t,b.time<0)o.splice(E,1);else{var x=b.time/A,w=o[E-1];if(!T){if(!w){o.splice(E,1);continue}C.x=w.point.x-R.x*x,C.y=w.point.y-R.y*x}T=!0,R5(b5,R);var k=(x*y<<24>>>0)+(v<<16)+(p<<8)+m,I=_;S[I].x=C.x+b5.x*n,S[I].y=C.y+b5.y*n,S[I].u=1,S[I].v=x,S[I].color._val=k,S[I+=1].x=C.x-b5.x*n,S[I].y=C.y-b5.y*n,S[I].u=0,S[I].v=x,S[I].color._val=k,_+=2}}c=_<=2?0:3*(_-2),f.resize(_,c)}},updateWorldVertexAllData:function(e){for(var t=e.renderData,i=t.floatStride,n=t.data,r=t.chunk.vb,s=0;s<n.length;s++){var a=s*i;r[a+0]=n[s].x,r[a+1]=n[s].y,r[a+2]=n[s].z,r[a+3]=n[s].u,r[a+4]=n[s].v,cn.toArray(r,n[s].color,a+5)}},createQuadIndices:function(e,t){var i=e.renderData.chunk.meshBuffer.indexOffset;S5=null,S5=new Uint16Array(t);for(var n=0,r=t;n<r;n+=2){var s=0+n;S5[i++]=s,S5[i++]=s+2,S5[i++]=s+1,S5[i++]=s+1,S5[i++]=s+2,S5[i++]=s+3}},updateRenderDataCache:function(e,t){t.passDirty&&t.updatePass(e),t.nodeDirty&&t.updateNode(e),t.textureDirty&&e.texture&&(t.updateTexture(e.texture),t.material=e.getRenderMaterial(0)),t.hashDirty&&t.updateHash()},updateRenderData:function(){},updateColor:function(){},fillBuffers:function(e){for(var t=e.renderData,i=t.chunk,n=t.data,r=t.vertexCount,s=t.indexCount,a=i.vb,o=0,u=0;u<r;u++){var h=n[u];a[o++]=h.x,a[o++]=h.y,a[o++]=h.z,a[o++]=h.u,a[o++]=h.v,cn.toArray(a,h.color,o),o+=4}i.bufferId;for(var l=i.vertexOffset,c=i.meshBuffer,_=i.meshBuffer.iData,f=c.indexOffset,d=0,m=s;d<m;d+=2){var p=l+d;_[f++]=p,_[f++]=p+2,_[f++]=p+1,_[f++]=p+1,_[f++]=p+2,_[f++]=p+3}c.indexOffset+=t.indexCount,c.setDirty()}},w5=e("MotionStreakAssemblerManager",{getAssembler:function(){return x5}});E5.Assembler=w5;var k5,I5,B5,P5,M5,O5={maxParticleDeltaTime:0,createData:function(){return YG.add()},removeData:function(e){YG.remove(e)},updateRenderData:function(){},fillBuffers:function(){}},D5=e("ParticleSystem2DAssembler",{getAssembler:function(){return O5.maxParticleDeltaTime||(O5.maxParticleDeltaTime=B.game.frameTime/1e3*2),O5}});A5.Assembler=D5,function(e){e[e.Static=0]="Static",e[e.Kinematic=1]="Kinematic",e[e.Dynamic=2]="Dynamic",e[e.Animated=3]="Animated"}(k5||(k5=e("ERigidBody2DType",{}))),wt(k5),function(e){e[e.None=0]="None",e[e.BOX=1]="BOX",e[e.CIRCLE=2]="CIRCLE",e[e.POLYGON=3]="POLYGON"}(I5||(I5=e("ECollider2DType",{}))),wt(I5),function(e){e[e.None=0]="None",e[e.DISTANCE=1]="DISTANCE",e[e.SPRING=2]="SPRING",e[e.WHEEL=3]="WHEEL",e[e.MOUSE=4]="MOUSE",e[e.FIXED=5]="FIXED",e[e.SLIDER=6]="SLIDER",e[e.RELATIVE=7]="RELATIVE",e[e.HINGE=8]="HINGE"}(B5||(B5=e("EJoint2DType",{}))),wt(B5),function(e){e[e.DEFAULT=1]="DEFAULT"}(P5||(P5=e("PhysicsGroup",{}))),wt(P5),function(e){e[e.Closest=0]="Closest",e[e.Any=1]="Any",e[e.AllClosest=2]="AllClosest",e[e.All=3]="All"}(M5||(M5=e("ERaycast2DType",{})));var L5,N5=e("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",STAY_CONTACT:"stay-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});!function(e){e[e.None=0]="None",e[e.Shape=1]="Shape",e[e.Joint=2]="Joint",e[e.Aabb=4]="Aabb",e[e.Pair=8]="Pair",e[e.CenterOfMass=16]="CenterOfMass",e[e.Particle=32]="Particle",e[e.Controller=64]="Controller",e[e.All=63]="All"}(L5||(L5=e("EPhysics2DDrawFlags",{})));var F5=e("PHYSICS_2D_PTM_RATIO",32),G5={id:"",switchTo:function(e){var t=G5;G5.physicsWorld&&e!==G5.id&&null!=G5.backend[e]?(console.info("[PHYSICS2D]: switch from ".concat(G5.id," to ").concat(e,".")),t.id=e,t.wrapper=G5.backend[e],t.physicsWorld=U5()):(console.info("[PHYSICS2D]: using ".concat(t.id,".")),t.physicsWorld=U5())},register:function(e,t){if(console.info("[PHYSICS2D]: register ".concat(e,".")),G5.backend[e]=t,!G5.physicsWorld||G5.id===e){var i=G5;i.id=e,i.wrapper=t}},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0},V5=function(){return 0};function U5(){return new G5.wrapper.PhysicsWorld}var H5={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:V5,setType:V5,setLinearDamping:V5,setAngularDamping:V5,setGravityScale:V5,setFixedRotation:V5,setAllowSleep:V5,isActive:V5,setActive:V5,wakeUp:V5,sleep:V5,getMass:V5,getInertia:V5,getLinearVelocity:V5,setLinearVelocity:V5,getLinearVelocityFromWorldPoint:V5,getAngularVelocity:V5,setAngularVelocity:V5,getLocalVector:V5,getWorldVector:V5,getLocalPoint:V5,getWorldPoint:V5,getLocalCenter:V5,getWorldCenter:V5,applyForce:V5,applyForceToCenter:V5,applyTorque:V5,applyLinearImpulse:V5,applyLinearImpulseToCenter:V5,applyAngularImpulse:V5,onEnable:V5,onDisable:V5,onDestroy:V5},z5={INITED:!1};var W5={INITED:!1},X5={impl:null,initialize:V5,setDampingRatio:V5,setFrequency:V5,setMaxForce:V5,setTarget:V5,setDistance:V5,setAngularOffset:V5,setCorrectionFactor:V5,setLinearOffset:V5,setMaxLength:V5,setMaxTorque:V5,setLowerLimit:V5,setUpperLimit:V5,setMaxMotorForce:V5,setMaxMotorTorque:V5,setMotorSpeed:V5,enableLimit:V5,enableMotor:V5,setLowerAngle:V5,setUpperAngle:V5};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var j5,q5=function(e,t){return function(e,t){!function(e){function t(e){if(!e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];throw f(Error,i)}}function i(e,t){return void 0!==e?e:t}var r=1e37,a=1e-5,o=a*a,u=3.14159265359,c=2,_=8,d=.1,m=2,p=.008,y=2/180*u,S=2*p,A=8,T=32,E=1,b=.2,C=8/180*u,x=2,w=x*x,k=.5*u,I=k*k,B=.2,P=.75,M=-1,O=2147483647,D=.75,L=1,N=.25,F=.5,G=2,V=G*G,U=256,H=2.5,z=.5,W=.01,X=2/180*u;function j(){return null}function q(){}function Y(){}var K=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(this,e),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=i,this.revision=r}return s(e,[{key:"toString",value:function(){return this.major+"."+this.minor+"."+this.revision}}]),e}(),Q=new K(2,3,2),J="master",Z="fbf51801d80fc389d43dc46524520e89043b6faf";function $(e){return parseInt(e,10)}function ee(e){return Math.abs(parseInt(e,10))}function te(e,t){for(var i=new Array(e),n=0;n<e;++n)i[n]=t(n);return i}function ie(e){for(var t=new Array(e),i=0;i<e;++i)t[i]=null;return t}function ne(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=new Array(e),n=0;n<e;++n)i[n]=t;return i}var re=u/180,se=180/u,ae=2*u,oe=Math.abs;function ue(e,t){return e<t?e:t}function he(e,t){return e>t?e:t}function le(e,t,i){return e<t?t:e>i?i:e}function ce(e,t){var i=e[0];e[0]=t[0],t[0]=i}var _e=isFinite;function fe(e){return e*e}function de(e){return 1/Math.sqrt(e)}var me=Math.sqrt,pe=Math.pow;function ve(e){return e*re}function ye(e){return e*se}var ge=Math.cos,Se=Math.sin,Ae=Math.acos,Te=Math.asin,Ee=Math.atan2;function be(e){return e|=e>>1&2147483647,e|=e>>2&1073741823,e|=e>>4&268435455,1+((e|=e>>8&16777215)|e>>16&65535)}function Ce(e){return e>0&&0==(e&e-1)}function Re(){return 2*Math.random()-1}function xe(e,t){return(t-e)*Math.random()+e}var we=function(){function e(){n(this,e);for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];if(i[0]instanceof Float32Array){if(2!==i[0].length)throw new Error;this.data=i[0]}else{var s="number"==typeof i[0]?i[0]:0,a="number"==typeof i[1]?i[1]:0;this.data=new Float32Array([s,a])}}return s(e,[{key:"x",get:function(){return this.data[0]},set:function(e){this.data[0]=e}},{key:"y",get:function(){return this.data[1]},set:function(e){this.data[1]=e}},{key:"Clone",value:function(){return new e(this.x,this.y)}},{key:"SetZero",value:function(){return this.x=0,this.y=0,this}},{key:"Set",value:function(e,t){return this.x=e,this.y=t,this}},{key:"Copy",value:function(e){return this.x=e.x,this.y=e.y,this}},{key:"SelfAdd",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"SelfAddXY",value:function(e,t){return this.x+=e,this.y+=t,this}},{key:"SelfSub",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"SelfSubXY",value:function(e,t){return this.x-=e,this.y-=t,this}},{key:"SelfMul",value:function(e){return this.x*=e,this.y*=e,this}},{key:"SelfMulAdd",value:function(e,t){return this.x+=e*t.x,this.y+=e*t.y,this}},{key:"SelfMulSub",value:function(e,t){return this.x-=e*t.x,this.y-=e*t.y,this}},{key:"Dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"Cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"Length",value:function(){var e=this.x,t=this.y;return Math.sqrt(e*e+t*t)}},{key:"LengthSquared",value:function(){var e=this.x,t=this.y;return e*e+t*t}},{key:"Normalize",value:function(){var e=this.Length();if(e>=a){var t=1/e;this.x*=t,this.y*=t}return e}},{key:"SelfNormalize",value:function(){var e=this.Length();if(e>=a){var t=1/e;this.x*=t,this.y*=t}return this}},{key:"SelfRotate",value:function(e){var t=Math.cos(e),i=Math.sin(e),n=this.x;return this.x=t*n-i*this.y,this.y=i*n+t*this.y,this}},{key:"SelfRotateCosSin",value:function(e,t){var i=this.x;return this.x=e*i-t*this.y,this.y=t*i+e*this.y,this}},{key:"IsValid",value:function(){return isFinite(this.x)&&isFinite(this.y)}},{key:"SelfCrossVS",value:function(e){var t=this.x;return this.x=e*this.y,this.y=-e*t,this}},{key:"SelfCrossSV",value:function(e){var t=this.x;return this.x=-e*this.y,this.y=e*t,this}},{key:"SelfMinV",value:function(e){return this.x=ue(this.x,e.x),this.y=ue(this.y,e.y),this}},{key:"SelfMaxV",value:function(e){return this.x=he(this.x,e.x),this.y=he(this.y,e.y),this}},{key:"SelfAbs",value:function(){return this.x=oe(this.x),this.y=oe(this.y),this}},{key:"SelfNeg",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"SelfSkew",value:function(){var e=this.x;return this.x=-this.y,this.y=e,this}}],[{key:"MakeArray",value:function(t){return te(t,(function(){return new e}))}},{key:"AbsV",value:function(e,t){return t.x=oe(e.x),t.y=oe(e.y),t}},{key:"MinV",value:function(e,t,i){return i.x=ue(e.x,t.x),i.y=ue(e.y,t.y),i}},{key:"MaxV",value:function(e,t,i){return i.x=he(e.x,t.x),i.y=he(e.y,t.y),i}},{key:"ClampV",value:function(e,t,i,n){return n.x=le(e.x,t.x,i.x),n.y=le(e.y,t.y,i.y),n}},{key:"RotateV",value:function(e,t,i){var n=e.x,r=e.y,s=Math.cos(t),a=Math.sin(t);return i.x=s*n-a*r,i.y=a*n+s*r,i}},{key:"DotVV",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"CrossVV",value:function(e,t){return e.x*t.y-e.y*t.x}},{key:"CrossVS",value:function(e,t,i){var n=e.x;return i.x=t*e.y,i.y=-t*n,i}},{key:"CrossVOne",value:function(e,t){var i=e.x;return t.x=e.y,t.y=-i,t}},{key:"CrossSV",value:function(e,t,i){var n=t.x;return i.x=-e*t.y,i.y=e*n,i}},{key:"CrossOneV",value:function(e,t){var i=e.x;return t.x=-e.y,t.y=i,t}},{key:"AddVV",value:function(e,t,i){return i.x=e.x+t.x,i.y=e.y+t.y,i}},{key:"SubVV",value:function(e,t,i){return i.x=e.x-t.x,i.y=e.y-t.y,i}},{key:"MulSV",value:function(e,t,i){return i.x=t.x*e,i.y=t.y*e,i}},{key:"MulVS",value:function(e,t,i){return i.x=e.x*t,i.y=e.y*t,i}},{key:"AddVMulSV",value:function(e,t,i,n){return n.x=e.x+t*i.x,n.y=e.y+t*i.y,n}},{key:"SubVMulSV",value:function(e,t,i,n){return n.x=e.x-t*i.x,n.y=e.y-t*i.y,n}},{key:"AddVCrossSV",value:function(e,t,i,n){var r=i.x;return n.x=e.x-t*i.y,n.y=e.y+t*r,n}},{key:"MidVV",value:function(e,t,i){return i.x=.5*(e.x+t.x),i.y=.5*(e.y+t.y),i}},{key:"ExtVV",value:function(e,t,i){return i.x=.5*(t.x-e.x),i.y=.5*(t.y-e.y),i}},{key:"IsEqualToV",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"DistanceVV",value:function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}},{key:"DistanceSquaredVV",value:function(e,t){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n}},{key:"NegV",value:function(e,t){return t.x=-e.x,t.y=-e.y,t}}]),e}();we.ZERO=new we(0,0),we.UNITX=new we(1,0),we.UNITY=new we(0,1),we.s_t0=new we,we.s_t1=new we,we.s_t2=new we,we.s_t3=new we;var ke=new we(0,0),Ie=function(){function e(){n(this,e);for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];if(i[0]instanceof Float32Array){if(3!==i[0].length)throw new Error;this.data=i[0]}else{var s="number"==typeof i[0]?i[0]:0,a="number"==typeof i[1]?i[1]:0,o="number"==typeof i[2]?i[2]:0;this.data=new Float32Array([s,a,o])}}return s(e,[{key:"x",get:function(){return this.data[0]},set:function(e){this.data[0]=e}},{key:"y",get:function(){return this.data[1]},set:function(e){this.data[1]=e}},{key:"z",get:function(){return this.data[2]},set:function(e){this.data[2]=e}},{key:"Clone",value:function(){return new e(this.x,this.y,this.z)}},{key:"SetZero",value:function(){return this.x=0,this.y=0,this.z=0,this}},{key:"SetXYZ",value:function(e,t,i){return this.x=e,this.y=t,this.z=i,this}},{key:"Copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}},{key:"SelfNeg",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"SelfAdd",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}},{key:"SelfAddXYZ",value:function(e,t,i){return this.x+=e,this.y+=t,this.z+=i,this}},{key:"SelfSub",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}},{key:"SelfSubXYZ",value:function(e,t,i){return this.x-=e,this.y-=t,this.z-=i,this}},{key:"SelfMul",value:function(e){return this.x*=e,this.y*=e,this.z*=e,this}}],[{key:"DotV3V3",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"CrossV3V3",value:function(e,t,i){var n=e.x,r=e.y,s=e.z,a=t.x,o=t.y,u=t.z;return i.x=r*u-s*o,i.y=s*a-n*u,i.z=n*o-r*a,i}}]),e}();Ie.ZERO=new Ie(0,0,0),Ie.s_t0=new Ie;var Be=function(){function e(){n(this,e),this.data=new Float32Array([1,0,0,1]),this.ex=new we(this.data.subarray(0,2)),this.ey=new we(this.data.subarray(2,4))}return s(e,[{key:"Clone",value:function(){return(new e).Copy(this)}},{key:"SetSSSS",value:function(e,t,i,n){return this.ex.Set(e,i),this.ey.Set(t,n),this}},{key:"SetVV",value:function(e,t){return this.ex.Copy(e),this.ey.Copy(t),this}},{key:"SetAngle",value:function(e){var t=Math.cos(e),i=Math.sin(e);return this.ex.Set(t,i),this.ey.Set(-i,t),this}},{key:"Copy",value:function(e){return this.ex.Copy(e.ex),this.ey.Copy(e.ey),this}},{key:"SetIdentity",value:function(){return this.ex.Set(1,0),this.ey.Set(0,1),this}},{key:"SetZero",value:function(){return this.ex.SetZero(),this.ey.SetZero(),this}},{key:"GetAngle",value:function(){return Math.atan2(this.ex.y,this.ex.x)}},{key:"GetInverse",value:function(e){var t=this.ex.x,i=this.ey.x,n=this.ex.y,r=this.ey.y,s=t*r-i*n;return 0!==s&&(s=1/s),e.ex.x=s*r,e.ey.x=-s*i,e.ex.y=-s*n,e.ey.y=s*t,e}},{key:"Solve",value:function(e,t,i){var n=this.ex.x,r=this.ey.x,s=this.ex.y,a=this.ey.y,o=n*a-r*s;return 0!==o&&(o=1/o),i.x=o*(a*e-r*t),i.y=o*(n*t-s*e),i}},{key:"SelfAbs",value:function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this}},{key:"SelfInv",value:function(){return this.GetInverse(this),this}},{key:"SelfAddM",value:function(e){return this.ex.SelfAdd(e.ex),this.ey.SelfAdd(e.ey),this}},{key:"SelfSubM",value:function(e){return this.ex.SelfSub(e.ex),this.ey.SelfSub(e.ey),this}}],[{key:"FromVV",value:function(t,i){return(new e).SetVV(t,i)}},{key:"FromSSSS",value:function(t,i,n,r){return(new e).SetSSSS(t,i,n,r)}},{key:"FromAngle",value:function(t){return(new e).SetAngle(t)}},{key:"AbsM",value:function(e,t){var i=e.ex,n=e.ey;return t.ex.x=oe(i.x),t.ex.y=oe(i.y),t.ey.x=oe(n.x),t.ey.y=oe(n.y),t}},{key:"MulMV",value:function(e,t,i){var n=e.ex,r=e.ey,s=t.x,a=t.y;return i.x=n.x*s+r.x*a,i.y=n.y*s+r.y*a,i}},{key:"MulTMV",value:function(e,t,i){var n=e.ex,r=e.ey,s=t.x,a=t.y;return i.x=n.x*s+n.y*a,i.y=r.x*s+r.y*a,i}},{key:"AddMM",value:function(e,t,i){var n=e.ex,r=e.ey,s=t.ex,a=t.ey;return i.ex.x=n.x+s.x,i.ex.y=n.y+s.y,i.ey.x=r.x+a.x,i.ey.y=r.y+a.y,i}},{key:"MulMM",value:function(e,t,i){var n=e.ex.x,r=e.ex.y,s=e.ey.x,a=e.ey.y,o=t.ex.x,u=t.ex.y,h=t.ey.x,l=t.ey.y;return i.ex.x=n*o+s*u,i.ex.y=r*o+a*u,i.ey.x=n*h+s*l,i.ey.y=r*h+a*l,i}},{key:"MulTMM",value:function(e,t,i){var n=e.ex.x,r=e.ex.y,s=e.ey.x,a=e.ey.y,o=t.ex.x,u=t.ex.y,h=t.ey.x,l=t.ey.y;return i.ex.x=n*o+r*u,i.ex.y=s*o+a*u,i.ey.x=n*h+r*l,i.ey.y=s*h+a*l,i}}]),e}();Be.IDENTITY=new Be;var Pe=function(){function e(){n(this,e),this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new Ie(this.data.subarray(0,3)),this.ey=new Ie(this.data.subarray(3,6)),this.ez=new Ie(this.data.subarray(6,9))}return s(e,[{key:"Clone",value:function(){return(new e).Copy(this)}},{key:"SetVVV",value:function(e,t,i){return this.ex.Copy(e),this.ey.Copy(t),this.ez.Copy(i),this}},{key:"Copy",value:function(e){return this.ex.Copy(e.ex),this.ey.Copy(e.ey),this.ez.Copy(e.ez),this}},{key:"SetIdentity",value:function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this}},{key:"SetZero",value:function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}},{key:"SelfAddM",value:function(e){return this.ex.SelfAdd(e.ex),this.ey.SelfAdd(e.ey),this.ez.SelfAdd(e.ez),this}},{key:"Solve33",value:function(e,t,i,n){var r=this.ex.x,s=this.ex.y,a=this.ex.z,o=this.ey.x,u=this.ey.y,h=this.ey.z,l=this.ez.x,c=this.ez.y,_=this.ez.z,f=r*(u*_-h*c)+s*(h*l-o*_)+a*(o*c-u*l);return 0!==f&&(f=1/f),n.x=f*(e*(u*_-h*c)+t*(h*l-o*_)+i*(o*c-u*l)),n.y=f*(r*(t*_-i*c)+s*(i*l-e*_)+a*(e*c-t*l)),n.z=f*(r*(u*i-h*t)+s*(h*e-o*i)+a*(o*t-u*e)),n}},{key:"Solve22",value:function(e,t,i){var n=this.ex.x,r=this.ey.x,s=this.ex.y,a=this.ey.y,o=n*a-r*s;return 0!==o&&(o=1/o),i.x=o*(a*e-r*t),i.y=o*(n*t-s*e),i}},{key:"GetInverse22",value:function(e){var t=this.ex.x,i=this.ey.x,n=this.ex.y,r=this.ey.y,s=t*r-i*n;0!==s&&(s=1/s),e.ex.x=s*r,e.ey.x=-s*i,e.ex.z=0,e.ex.y=-s*n,e.ey.y=s*t,e.ey.z=0,e.ez.x=0,e.ez.y=0,e.ez.z=0}},{key:"GetSymInverse33",value:function(e){var t=Ie.DotV3V3(this.ex,Ie.CrossV3V3(this.ey,this.ez,Ie.s_t0));0!==t&&(t=1/t);var i=this.ex.x,n=this.ey.x,r=this.ez.x,s=this.ey.y,a=this.ez.y,o=this.ez.z;e.ex.x=t*(s*o-a*a),e.ex.y=t*(r*a-n*o),e.ex.z=t*(n*a-r*s),e.ey.x=e.ex.y,e.ey.y=t*(i*o-r*r),e.ey.z=t*(r*n-i*a),e.ez.x=e.ex.z,e.ez.y=e.ey.z,e.ez.z=t*(i*s-n*n)}}],[{key:"MulM33V3",value:function(e,t,i){var n=t.x,r=t.y,s=t.z;return i.x=e.ex.x*n+e.ey.x*r+e.ez.x*s,i.y=e.ex.y*n+e.ey.y*r+e.ez.y*s,i.z=e.ex.z*n+e.ey.z*r+e.ez.z*s,i}},{key:"MulM33XYZ",value:function(e,t,i,n,r){return r.x=e.ex.x*t+e.ey.x*i+e.ez.x*n,r.y=e.ex.y*t+e.ey.y*i+e.ez.y*n,r.z=e.ex.z*t+e.ey.z*i+e.ez.z*n,r}},{key:"MulM33V2",value:function(e,t,i){var n=t.x,r=t.y;return i.x=e.ex.x*n+e.ey.x*r,i.y=e.ex.y*n+e.ey.y*r,i}},{key:"MulM33XY",value:function(e,t,i,n){return n.x=e.ex.x*t+e.ey.x*i,n.y=e.ex.y*t+e.ey.y*i,n}}]),e}();Pe.IDENTITY=new Pe;var Me=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;n(this,e),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}return s(e,[{key:"Clone",value:function(){return(new e).Copy(this)}},{key:"Copy",value:function(e){return this.s=e.s,this.c=e.c,this}},{key:"SetAngle",value:function(e){return this.s=Math.sin(e),this.c=Math.cos(e),this}},{key:"SetIdentity",value:function(){return this.s=0,this.c=1,this}},{key:"GetAngle",value:function(){return Math.atan2(this.s,this.c)}},{key:"GetXAxis",value:function(e){return e.x=this.c,e.y=this.s,e}},{key:"GetYAxis",value:function(e){return e.x=-this.s,e.y=this.c,e}}],[{key:"MulRR",value:function(e,t,i){var n=e.c,r=e.s,s=t.c,a=t.s;return i.s=r*s+n*a,i.c=n*s-r*a,i}},{key:"MulTRR",value:function(e,t,i){var n=e.c,r=e.s,s=t.c,a=t.s;return i.s=n*a-r*s,i.c=n*s+r*a,i}},{key:"MulRV",value:function(e,t,i){var n=e.c,r=e.s,s=t.x,a=t.y;return i.x=n*s-r*a,i.y=r*s+n*a,i}},{key:"MulTRV",value:function(e,t,i){var n=e.c,r=e.s,s=t.x,a=t.y;return i.x=n*s+r*a,i.y=-r*s+n*a,i}}]),e}();Me.IDENTITY=new Me;var Oe=function(){function e(){n(this,e),this.p=new we,this.q=new Me}return s(e,[{key:"Clone",value:function(){return(new e).Copy(this)}},{key:"Copy",value:function(e){return this.p.Copy(e.p),this.q.Copy(e.q),this}},{key:"SetIdentity",value:function(){return this.p.SetZero(),this.q.SetIdentity(),this}},{key:"SetPositionRotation",value:function(e,t){return this.p.Copy(e),this.q.Copy(t),this}},{key:"SetPositionAngle",value:function(e,t){return this.p.Copy(e),this.q.SetAngle(t),this}},{key:"SetPosition",value:function(e){return this.p.Copy(e),this}},{key:"SetPositionXY",value:function(e,t){return this.p.Set(e,t),this}},{key:"SetRotation",value:function(e){return this.q.Copy(e),this}},{key:"SetRotationAngle",value:function(e){return this.q.SetAngle(e),this}},{key:"GetPosition",value:function(){return this.p}},{key:"GetRotation",value:function(){return this.q}},{key:"GetRotationAngle",value:function(){return this.q.GetAngle()}},{key:"GetAngle",value:function(){return this.q.GetAngle()}}],[{key:"MulXV",value:function(e,t,i){var n=e.q.c,r=e.q.s,s=t.x,a=t.y;return i.x=n*s-r*a+e.p.x,i.y=r*s+n*a+e.p.y,i}},{key:"MulTXV",value:function(e,t,i){var n=e.q.c,r=e.q.s,s=t.x-e.p.x,a=t.y-e.p.y;return i.x=n*s+r*a,i.y=-r*s+n*a,i}},{key:"MulXX",value:function(e,t,i){return Me.MulRR(e.q,t.q,i.q),we.AddVV(Me.MulRV(e.q,t.p,i.p),e.p,i.p),i}},{key:"MulTXX",value:function(e,t,i){return Me.MulTRR(e.q,t.q,i.q),Me.MulTRV(e.q,we.SubVV(t.p,e.p,i.p),i.p),i}}]),e}();Oe.IDENTITY=new Oe;var De,Le=function(){function e(){n(this,e),this.localCenter=new we,this.c0=new we,this.c=new we,this.a0=0,this.a=0,this.alpha0=0}return s(e,[{key:"Clone",value:function(){return(new e).Copy(this)}},{key:"Copy",value:function(e){return this.localCenter.Copy(e.localCenter),this.c0.Copy(e.c0),this.c.Copy(e.c),this.a0=e.a0,this.a=e.a,this.alpha0=e.alpha0,this}},{key:"GetTransform",value:function(e,t){var i=1-t;e.p.x=i*this.c0.x+t*this.c.x,e.p.y=i*this.c0.y+t*this.c.y;var n=i*this.a0+t*this.a;return e.q.SetAngle(n),e.p.SelfSub(Me.MulRV(e.q,this.localCenter,we.s_t0)),e}},{key:"Advance",value:function(e){var t=(e-this.alpha0)/(1-this.alpha0),i=1-t;this.c0.x=i*this.c0.x+t*this.c.x,this.c0.y=i*this.c0.y+t*this.c.y,this.a0=i*this.a0+t*this.a,this.alpha0=e}},{key:"Normalize",value:function(){var e=ae*Math.floor(this.a0/ae);this.a0-=e,this.a-=e}}]),e}(),Ne=function(){function e(){n(this,e);for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];if(i[0]instanceof Float32Array){if(4!==i[0].length)throw new Error;this.data=i[0]}else{var s="number"==typeof i[0]?i[0]:.5,a="number"==typeof i[1]?i[1]:.5,o="number"==typeof i[2]?i[2]:.5,u="number"==typeof i[3]?i[3]:1;this.data=new Float32Array([s,a,o,u])}}return s(e,[{key:"r",get:function(){return this.data[0]},set:function(e){this.data[0]=e}},{key:"g",get:function(){return this.data[1]},set:function(e){this.data[1]=e}},{key:"b",get:function(){return this.data[2]},set:function(e){this.data[2]=e}},{key:"a",get:function(){return this.data[3]},set:function(e){this.data[3]=e}},{key:"Clone",value:function(){return(new e).Copy(this)}},{key:"Copy",value:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}},{key:"IsEqual",value:function(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}},{key:"IsZero",value:function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a}},{key:"Set",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.a;this.SetRGBA(e,t,i,n)}},{key:"SetByteRGB",value:function(e,t,i){return this.r=e/255,this.g=t/255,this.b=i/255,this}},{key:"SetByteRGBA",value:function(e,t,i,n){return this.r=e/255,this.g=t/255,this.b=i/255,this.a=n/255,this}},{key:"SetRGB",value:function(e,t,i){return this.r=e,this.g=t,this.b=i,this}},{key:"SetRGBA",value:function(e,t,i,n){return this.r=e,this.g=t,this.b=i,this.a=n,this}},{key:"SelfAdd",value:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}},{key:"Add",value:function(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}},{key:"SelfSub",value:function(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}},{key:"Sub",value:function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}},{key:"SelfMul",value:function(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}},{key:"Mul",value:function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}},{key:"Mix",value:function(t,i){e.MixColors(this,t,i)}},{key:"MakeStyleString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.a;return e.MakeStyleString(this.r,this.g,this.b,t)}}],[{key:"MixColors",value:function(e,t,i){var n=i*(t.r-e.r),r=i*(t.g-e.g),s=i*(t.b-e.b),a=i*(t.a-e.a);e.r+=n,e.g+=r,e.b+=s,e.a+=a,t.r-=n,t.g-=r,t.b-=s,t.a-=a}},{key:"MakeStyleString",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return e*=255,t*=255,i*=255,n<1?"rgba(".concat(e,",").concat(t,",").concat(i,",").concat(n,")"):"rgb(".concat(e,",").concat(t,",").concat(i,")")}}]),e}();Ne.ZERO=new Ne(0,0,0,0),Ne.RED=new Ne(1,0,0),Ne.GREEN=new Ne(0,1,0),Ne.BLUE=new Ne(0,0,1),(De=e.b2DrawFlags||(e.b2DrawFlags={}))[De.e_none=0]="e_none",De[De.e_shapeBit=1]="e_shapeBit",De[De.e_jointBit=2]="e_jointBit",De[De.e_aabbBit=4]="e_aabbBit",De[De.e_pairBit=8]="e_pairBit",De[De.e_centerOfMassBit=16]="e_centerOfMassBit",De[De.e_particleBit=32]="e_particleBit",De[De.e_controllerBit=64]="e_controllerBit",De[De.e_all=63]="e_all";var Fe=function(){function e(){n(this,e),this.m_drawFlags=0}return s(e,[{key:"SetFlags",value:function(e){this.m_drawFlags=e}},{key:"GetFlags",value:function(){return this.m_drawFlags}},{key:"AppendFlags",value:function(e){this.m_drawFlags|=e}},{key:"ClearFlags",value:function(e){this.m_drawFlags&=~e}}]),e}(),Ge=function(){function e(){n(this,e),this.m_start=Date.now()}return s(e,[{key:"Reset",value:function(){return this.m_start=Date.now(),this}},{key:"GetMilliseconds",value:function(){return Date.now()-this.m_start}}]),e}(),Ve=function(){function e(){n(this,e),this.m_count=0,this.m_min_count=0,this.m_max_count=0}return s(e,[{key:"GetCount",value:function(){return this.m_count}},{key:"GetMinCount",value:function(){return this.m_min_count}},{key:"GetMaxCount",value:function(){return this.m_max_count}},{key:"ResetCount",value:function(){var e=this.m_count;return this.m_count=0,e}},{key:"ResetMinCount",value:function(){this.m_min_count=0}},{key:"ResetMaxCount",value:function(){this.m_max_count=0}},{key:"Increment",value:function(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)}},{key:"Decrement",value:function(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)}}]),e}(),Ue=function(){function e(t){n(this,e),this.m_stack=[],this.m_count=0,this.m_stack=te(t,(function(){return null})),this.m_count=0}return s(e,[{key:"Reset",value:function(){return this.m_count=0,this}},{key:"Push",value:function(e){this.m_stack[this.m_count]=e,this.m_count++}},{key:"Pop",value:function(){this.m_count--;var e=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===e)throw new Error;return e}},{key:"GetCount",value:function(){return this.m_count}}]),e}(),He=function e(){n(this,e)},ze=function e(){n(this,e)},We=function(){function e(){n(this,e),this.m_buffer=we.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}return s(e,[{key:"Copy",value:function(e){return e.m_vertices===e.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(e.m_buffer[0]),this.m_buffer[1].Copy(e.m_buffer[1])):this.m_vertices=e.m_vertices,this.m_count=e.m_count,this.m_radius=e.m_radius,this}},{key:"Reset",value:function(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}},{key:"SetShape",value:function(e,t){e.SetupDistanceProxy(this,t)}},{key:"SetVerticesRadius",value:function(e,t,i){this.m_vertices=e,this.m_count=t,this.m_radius=i}},{key:"GetSupport",value:function(e){for(var t=0,i=we.DotVV(this.m_vertices[0],e),n=1;n<this.m_count;++n){var r=we.DotVV(this.m_vertices[n],e);r>i&&(t=n,i=r)}return t}},{key:"GetSupportVertex",value:function(e){for(var t=0,i=we.DotVV(this.m_vertices[0],e),n=1;n<this.m_count;++n){var r=we.DotVV(this.m_vertices[n],e);r>i&&(t=n,i=r)}return this.m_vertices[t]}},{key:"GetVertexCount",value:function(){return this.m_count}},{key:"GetVertex",value:function(e){return this.m_vertices[e]}}]),e}(),Xe=function(){function e(){n(this,e),this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}return s(e,[{key:"Reset",value:function(){return this.metric=0,this.count=0,this}}]),e}(),je=function(){function e(){n(this,e),this.proxyA=new We,this.proxyB=new We,this.transformA=new Oe,this.transformB=new Oe,this.useRadii=!1}return s(e,[{key:"Reset",value:function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}]),e}(),qe=function(){function e(){n(this,e),this.pointA=new we,this.pointB=new we,this.distance=0,this.iterations=0}return s(e,[{key:"Reset",value:function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}]),e}(),Ye=function e(){n(this,e),this.proxyA=new We,this.proxyB=new We,this.transformA=new Oe,this.transformB=new Oe,this.translationB=new we},Ke=function e(){n(this,e),this.point=new we,this.normal=new we,this.lambda=0,this.iterations=0};function Qe(){e.b2_gjkCalls=0,e.b2_gjkIters=0,e.b2_gjkMaxIters=0}e.b2_gjkCalls=0,e.b2_gjkIters=0,e.b2_gjkMaxIters=0;var Je=function(){function e(){n(this,e),this.wA=new we,this.wB=new we,this.w=new we,this.a=0,this.indexA=0,this.indexB=0}return s(e,[{key:"Copy",value:function(e){return this.wA.Copy(e.wA),this.wB.Copy(e.wB),this.w.Copy(e.w),this.a=e.a,this.indexA=e.indexA,this.indexB=e.indexB,this}}]),e}(),Ze=function(){function e(){n(this,e),this.m_v1=new Je,this.m_v2=new Je,this.m_v3=new Je,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}return s(e,[{key:"ReadCache",value:function(e,t,i,n,r){this.m_count=e.count;for(var s=this.m_vertices,o=0;o<this.m_count;++o){var u=s[o];u.indexA=e.indexA[o],u.indexB=e.indexB[o];var h=t.GetVertex(u.indexA),l=n.GetVertex(u.indexB);Oe.MulXV(i,h,u.wA),Oe.MulXV(r,l,u.wB),we.SubVV(u.wB,u.wA,u.w),u.a=0}if(this.m_count>1){var c=e.metric,_=this.GetMetric();(_<.5*c||2*c<_||_<a)&&(this.m_count=0)}if(0===this.m_count){var f=s[0];f.indexA=0,f.indexB=0;var d=t.GetVertex(0),m=n.GetVertex(0);Oe.MulXV(i,d,f.wA),Oe.MulXV(r,m,f.wB),we.SubVV(f.wB,f.wA,f.w),f.a=1,this.m_count=1}}},{key:"WriteCache",value:function(e){e.metric=this.GetMetric(),e.count=this.m_count;for(var t=this.m_vertices,i=0;i<this.m_count;++i)e.indexA[i]=t[i].indexA,e.indexB[i]=t[i].indexB}},{key:"GetSearchDirection",value:function(e){switch(this.m_count){case 1:return we.NegV(this.m_v1.w,e);case 2:var t=we.SubVV(this.m_v2.w,this.m_v1.w,e);return we.CrossVV(t,we.NegV(this.m_v1.w,we.s_t0))>0?we.CrossOneV(t,e):we.CrossVOne(t,e);default:return e.SetZero()}}},{key:"GetClosestPoint",value:function(e){switch(this.m_count){case 0:return e.SetZero();case 1:return e.Copy(this.m_v1.w);case 2:return e.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return e.SetZero()}}},{key:"GetWitnessPoints",value:function(e,t){switch(this.m_count){case 0:break;case 1:e.Copy(this.m_v1.wA),t.Copy(this.m_v1.wB);break;case 2:e.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,e.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,t.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,t.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:t.x=e.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,t.y=e.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}}},{key:"GetMetric",value:function(){switch(this.m_count){case 0:case 1:return 0;case 2:return we.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return we.CrossVV(we.SubVV(this.m_v2.w,this.m_v1.w,we.s_t0),we.SubVV(this.m_v3.w,this.m_v1.w,we.s_t1));default:return 0}}},{key:"Solve2",value:function(){var t=this.m_v1.w,i=this.m_v2.w,n=we.SubVV(i,t,e.s_e12),r=-we.DotVV(t,n);if(r<=0)return this.m_v1.a=1,void(this.m_count=1);var s=we.DotVV(i,n);if(s<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);var a=1/(s+r);this.m_v1.a=s*a,this.m_v2.a=r*a,this.m_count=2}},{key:"Solve3",value:function(){var t=this.m_v1.w,i=this.m_v2.w,n=this.m_v3.w,r=we.SubVV(i,t,e.s_e12),s=we.DotVV(t,r),a=we.DotVV(i,r),o=-s,u=we.SubVV(n,t,e.s_e13),h=we.DotVV(t,u),l=we.DotVV(n,u),c=-h,_=we.SubVV(n,i,e.s_e23),f=we.DotVV(i,_),d=we.DotVV(n,_),m=-f,p=we.CrossVV(r,u),v=p*we.CrossVV(i,n),y=p*we.CrossVV(n,t),g=p*we.CrossVV(t,i);if(o<=0&&c<=0)return this.m_v1.a=1,void(this.m_count=1);if(a>0&&o>0&&g<=0){var S=1/(a+o);return this.m_v1.a=a*S,this.m_v2.a=o*S,void(this.m_count=2)}if(l>0&&c>0&&y<=0){var A=1/(l+c);return this.m_v1.a=l*A,this.m_v3.a=c*A,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(a<=0&&m<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(l<=0&&d<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(d>0&&m>0&&v<=0){var T=1/(d+m);return this.m_v2.a=d*T,this.m_v3.a=m*T,this.m_count=2,void this.m_v1.Copy(this.m_v3)}var E=1/(v+y+g);this.m_v1.a=v*E,this.m_v2.a=y*E,this.m_v3.a=g*E,this.m_count=3}}]),e}();Ze.s_e12=new we,Ze.s_e13=new we,Ze.s_e23=new we;var $e=new Ze,et=[0,0,0],tt=[0,0,0],it=new we,nt=new we,rt=new we,st=new we,at=new we;function ot(t,i,n){++e.b2_gjkCalls;var r=n.proxyA,s=n.proxyB,u=n.transformA,h=n.transformB,l=$e;l.ReadCache(i,r,u,s,h);for(var c=l.m_vertices,_=20,f=et,d=tt,m=0,p=0;p<_;){m=l.m_count;for(var v=0;v<m;++v)f[v]=c[v].indexA,d[v]=c[v].indexB;switch(l.m_count){case 1:break;case 2:l.Solve2();break;case 3:l.Solve3()}if(3===l.m_count)break;var y=l.GetSearchDirection(nt);if(y.LengthSquared()<o)break;var g=c[l.m_count];g.indexA=r.GetSupport(Me.MulTRV(u.q,we.NegV(y,we.s_t0),st)),Oe.MulXV(u,r.GetVertex(g.indexA),g.wA),g.indexB=s.GetSupport(Me.MulTRV(h.q,y,at)),Oe.MulXV(h,s.GetVertex(g.indexB),g.wB),we.SubVV(g.wB,g.wA,g.w),++p,++e.b2_gjkIters;for(var S=!1,A=0;A<m;++A)if(g.indexA===f[A]&&g.indexB===d[A]){S=!0;break}if(S)break;++l.m_count}if(e.b2_gjkMaxIters=he(e.b2_gjkMaxIters,p),l.GetWitnessPoints(t.pointA,t.pointB),t.distance=we.DistanceVV(t.pointA,t.pointB),t.iterations=p,l.WriteCache(i),n.useRadii){var T=r.m_radius,E=s.m_radius;if(t.distance>T+E&&t.distance>a){t.distance-=T+E;var b=we.SubVV(t.pointB,t.pointA,rt);b.Normalize(),t.pointA.SelfMulAdd(T,b),t.pointB.SelfMulSub(E,b)}else{var C=we.MidVV(t.pointA,t.pointB,it);t.pointA.Copy(C),t.pointB.Copy(C),t.distance=0}}}var ut,ht=new we,lt=new Ze,ct=new we,_t=new we,ft=new we,dt=new we,mt=new we,pt=new we;function vt(e,t){e.iterations=0,e.lambda=1,e.normal.SetZero(),e.point.SetZero();var i=t.proxyA,n=t.proxyB,r=he(i.m_radius,S)+he(n.m_radius,S),s=t.transformA,a=t.transformB,o=t.translationB,u=ht.Set(0,0),h=0,l=lt;l.m_count=0;for(var c=l.m_vertices,_=i.GetSupport(Me.MulTRV(s.q,we.NegV(o,we.s_t1),we.s_t0)),f=Oe.MulXV(s,i.GetVertex(_),ct),d=n.GetSupport(Me.MulTRV(a.q,o,we.s_t0)),m=Oe.MulXV(a,n.GetVertex(d),_t),v=we.SubVV(f,m,ft),y=he(S,r-S),g=.5*p,A=20,T=0;T<A&&oe(v.Length()-y)>g;){e.iterations+=1,_=i.GetSupport(Me.MulTRV(s.q,we.NegV(v,we.s_t1),we.s_t0)),f=Oe.MulXV(s,i.GetVertex(_),ct),d=n.GetSupport(Me.MulTRV(a.q,v,we.s_t0)),m=Oe.MulXV(a,n.GetVertex(d),_t);var E=we.SubVV(f,m,dt);v.Normalize();var b=we.DotVV(v,E),C=we.DotVV(v,o);if(b-y>h*C){if(C<=0)return!1;if((h=(b-y)/C)>1)return!1;u.Copy(v).SelfNeg(),l.m_count=0}var R=c[l.m_count];switch(R.indexA=d,R.wA.Copy(m).SelfMulAdd(h,o),R.indexB=_,R.wB.Copy(f),R.w.Copy(R.wB).SelfSub(R.wA),R.a=1,l.m_count+=1,l.m_count){case 1:break;case 2:l.Solve2();break;case 3:l.Solve3()}if(3===l.m_count)return!1;l.GetClosestPoint(v),++T}var x=mt,w=pt;return l.GetWitnessPoints(x,w),v.LengthSquared()>0&&(u.Copy(v).SelfNeg(),u.Normalize()),e.normal.Copy(u),e.lambda=h,e.iterations=T,!0}(ut=e.b2ContactFeatureType||(e.b2ContactFeatureType={}))[ut.e_vertex=0]="e_vertex",ut[ut.e_face=1]="e_face";var yt,gt=function(){function e(){n(this,e),this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}return s(e,[{key:"key",get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(e){this._key=e,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}},{key:"indexA",get:function(){return this._indexA},set:function(e){this._indexA=e,this._key_invalid=!0}},{key:"indexB",get:function(){return this._indexB},set:function(e){this._indexB=e,this._key_invalid=!0}},{key:"typeA",get:function(){return this._typeA},set:function(e){this._typeA=e,this._key_invalid=!0}},{key:"typeB",get:function(){return this._typeB},set:function(e){this._typeB=e,this._key_invalid=!0}}]),e}(),St=function(){function e(){n(this,e),this.cf=new gt}return s(e,[{key:"Copy",value:function(e){return this.key=e.key,this}},{key:"Clone",value:function(){return(new e).Copy(this)}},{key:"key",get:function(){return this.cf.key},set:function(e){this.cf.key=e}}]),e}(),At=function(){function e(){n(this,e),this.localPoint=new we,this.normalImpulse=0,this.tangentImpulse=0,this.id=new St}return s(e,[{key:"Reset",value:function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}},{key:"Copy",value:function(e){return this.localPoint.Copy(e.localPoint),this.normalImpulse=e.normalImpulse,this.tangentImpulse=e.tangentImpulse,this.id.Copy(e.id),this}}],[{key:"MakeArray",value:function(t){return te(t,(function(){return new e}))}}]),e}();(yt=e.b2ManifoldType||(e.b2ManifoldType={}))[yt.e_unknown=-1]="e_unknown",yt[yt.e_circles=0]="e_circles",yt[yt.e_faceA=1]="e_faceA",yt[yt.e_faceB=2]="e_faceB";var Tt,Et=function(){function t(){n(this,t),this.points=At.MakeArray(c),this.localNormal=new we,this.localPoint=new we,this.type=e.b2ManifoldType.e_unknown,this.pointCount=0}return s(t,[{key:"Reset",value:function(){for(var t=0;t<c;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=e.b2ManifoldType.e_unknown,this.pointCount=0}},{key:"Copy",value:function(e){this.pointCount=e.pointCount;for(var t=0;t<c;++t)this.points[t].Copy(e.points[t]);return this.localNormal.Copy(e.localNormal),this.localPoint.Copy(e.localPoint),this.type=e.type,this}},{key:"Clone",value:function(){return(new t).Copy(this)}}]),t}(),bt=function(){function t(){n(this,t),this.normal=new we,this.points=we.MakeArray(c),this.separations=ne(c)}return s(t,[{key:"Initialize",value:function(i,n,r,s,a){if(0!==i.pointCount)switch(i.type){case e.b2ManifoldType.e_circles:this.normal.Set(1,0);var u=Oe.MulXV(n,i.localPoint,t.Initialize_s_pointA),h=Oe.MulXV(s,i.points[0].localPoint,t.Initialize_s_pointB);we.DistanceSquaredVV(u,h)>o&&we.SubVV(h,u,this.normal).SelfNormalize();var l=we.AddVMulSV(u,r,this.normal,t.Initialize_s_cA),c=we.SubVMulSV(h,a,this.normal,t.Initialize_s_cB);we.MidVV(l,c,this.points[0]),this.separations[0]=we.DotVV(we.SubVV(c,l,we.s_t0),this.normal);break;case e.b2ManifoldType.e_faceA:Me.MulRV(n.q,i.localNormal,this.normal);for(var _=Oe.MulXV(n,i.localPoint,t.Initialize_s_planePoint),f=0;f<i.pointCount;++f){var d=Oe.MulXV(s,i.points[f].localPoint,t.Initialize_s_clipPoint),m=r-we.DotVV(we.SubVV(d,_,we.s_t0),this.normal),p=we.AddVMulSV(d,m,this.normal,t.Initialize_s_cA),v=we.SubVMulSV(d,a,this.normal,t.Initialize_s_cB);we.MidVV(p,v,this.points[f]),this.separations[f]=we.DotVV(we.SubVV(v,p,we.s_t0),this.normal)}break;case e.b2ManifoldType.e_faceB:Me.MulRV(s.q,i.localNormal,this.normal);for(var y=Oe.MulXV(s,i.localPoint,t.Initialize_s_planePoint),g=0;g<i.pointCount;++g){var S=Oe.MulXV(n,i.points[g].localPoint,t.Initialize_s_clipPoint),A=a-we.DotVV(we.SubVV(S,y,we.s_t0),this.normal),T=we.AddVMulSV(S,A,this.normal,t.Initialize_s_cB),E=we.SubVMulSV(S,r,this.normal,t.Initialize_s_cA);we.MidVV(E,T,this.points[g]),this.separations[g]=we.DotVV(we.SubVV(E,T,we.s_t0),this.normal)}this.normal.SelfNeg()}}}]),t}();function Ct(t,i,n,r){var s;for(s=0;s<n.pointCount;++s){var a=n.points[s].id.key;t[s]=e.b2PointState.b2_removeState;for(var o=0,u=r.pointCount;o<u;++o)if(r.points[o].id.key===a){t[s]=e.b2PointState.b2_persistState;break}}for(;s<c;++s)t[s]=e.b2PointState.b2_nullState;for(s=0;s<r.pointCount;++s){var h=r.points[s].id.key;i[s]=e.b2PointState.b2_addState;for(var l=0,_=n.pointCount;l<_;++l)if(n.points[l].id.key===h){i[s]=e.b2PointState.b2_persistState;break}}for(;s<c;++s)i[s]=e.b2PointState.b2_nullState}bt.Initialize_s_pointA=new we,bt.Initialize_s_pointB=new we,bt.Initialize_s_cA=new we,bt.Initialize_s_cB=new we,bt.Initialize_s_planePoint=new we,bt.Initialize_s_clipPoint=new we,(Tt=e.b2PointState||(e.b2PointState={}))[Tt.b2_nullState=0]="b2_nullState",Tt[Tt.b2_addState=1]="b2_addState",Tt[Tt.b2_persistState=2]="b2_persistState",Tt[Tt.b2_removeState=3]="b2_removeState";var Rt=function(){function e(){n(this,e),this.v=new we,this.id=new St}return s(e,[{key:"Copy",value:function(e){return this.v.Copy(e.v),this.id.Copy(e.id),this}}],[{key:"MakeArray",value:function(t){return te(t,(function(){return new e}))}}]),e}(),xt=function(){function e(){n(this,e),this.p1=new we,this.p2=new we,this.maxFraction=1}return s(e,[{key:"Copy",value:function(e){return this.p1.Copy(e.p1),this.p2.Copy(e.p2),this.maxFraction=e.maxFraction,this}}]),e}(),wt=function(){function e(){n(this,e),this.normal=new we,this.fraction=0}return s(e,[{key:"Copy",value:function(e){return this.normal.Copy(e.normal),this.fraction=e.fraction,this}}]),e}(),kt=function(){function e(){n(this,e),this.lowerBound=new we,this.upperBound=new we,this.m_cache_center=new we,this.m_cache_extent=new we}return s(e,[{key:"Copy",value:function(e){return this.lowerBound.Copy(e.lowerBound),this.upperBound.Copy(e.upperBound),this}},{key:"IsValid",value:function(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)}},{key:"GetCenter",value:function(){return we.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)}},{key:"GetExtents",value:function(){return we.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)}},{key:"GetPerimeter",value:function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))}},{key:"Combine1",value:function(e){return this.lowerBound.x=ue(this.lowerBound.x,e.lowerBound.x),this.lowerBound.y=ue(this.lowerBound.y,e.lowerBound.y),this.upperBound.x=he(this.upperBound.x,e.upperBound.x),this.upperBound.y=he(this.upperBound.y,e.upperBound.y),this}},{key:"Combine2",value:function(e,t){return this.lowerBound.x=ue(e.lowerBound.x,t.lowerBound.x),this.lowerBound.y=ue(e.lowerBound.y,t.lowerBound.y),this.upperBound.x=he(e.upperBound.x,t.upperBound.x),this.upperBound.y=he(e.upperBound.y,t.upperBound.y),this}},{key:"Contains",value:function(e){return!(this.lowerBound.x<=e.lowerBound.x||this.lowerBound.y<=e.lowerBound.y||e.upperBound.x<=this.upperBound.x||e.upperBound.y<=this.upperBound.y)}},{key:"RayCast",value:function(e,t){var i=-r,n=r,s=t.p1.x,o=t.p1.y,u=t.p2.x-t.p1.x,h=t.p2.y-t.p1.y,l=oe(u),c=oe(h),_=e.normal;if(l<a){if(s<this.lowerBound.x||this.upperBound.x<s)return!1}else{var f=1/u,d=(this.lowerBound.x-s)*f,m=(this.upperBound.x-s)*f,p=-1;if(d>m){var v=d;d=m,m=v,p=1}if(d>i&&(_.x=p,_.y=0,i=d),i>(n=ue(n,m)))return!1}if(c<a){if(o<this.lowerBound.y||this.upperBound.y<o)return!1}else{var y=1/h,g=(this.lowerBound.y-o)*y,S=(this.upperBound.y-o)*y,A=-1;if(g>S){var T=g;g=S,S=T,A=1}if(g>i&&(_.x=0,_.y=A,i=g),i>(n=ue(n,S)))return!1}return!(i<0||t.maxFraction<i||(e.fraction=i,0))}},{key:"TestContain",value:function(e){return!(e.x<this.lowerBound.x||this.upperBound.x<e.x||e.y<this.lowerBound.y||this.upperBound.y<e.y)}},{key:"TestOverlap",value:function(e){return!(this.upperBound.x<e.lowerBound.x||this.upperBound.y<e.lowerBound.y||e.upperBound.x<this.lowerBound.x||e.upperBound.y<this.lowerBound.y)}}],[{key:"Combine",value:function(e,t,i){return i.Combine2(e,t),i}}]),e}();function It(e,t){return!(e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y||t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y)}function Bt(t,i,n,r,s){var a=0,o=i[0],u=i[1],h=we.DotVV(n,o.v)-r,l=we.DotVV(n,u.v)-r;if(h<=0&&t[a++].Copy(o),l<=0&&t[a++].Copy(u),h*l<0){var c=h/(h-l),_=t[a].v;_.x=o.v.x+c*(u.v.x-o.v.x),_.y=o.v.y+c*(u.v.y-o.v.y);var f=t[a].id;f.cf.indexA=s,f.cf.indexB=o.id.cf.indexB,f.cf.typeA=e.b2ContactFeatureType.e_vertex,f.cf.typeB=e.b2ContactFeatureType.e_face,++a}return a}var Pt=new je,Mt=new Xe,Ot=new qe;function Dt(e,t,i,n,r,s){var o=Pt.Reset();o.proxyA.SetShape(e,t),o.proxyB.SetShape(i,n),o.transformA.Copy(r),o.transformB.Copy(s),o.useRadii=!0;var u=Mt.Reset();u.count=0;var h=Ot.Reset();return ot(h,u,o),h.distance<10*a}function Lt(e){if(null===e)throw new Error;return e}var Nt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;n(this,e),this.m_id=0,this.aabb=new kt,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}return s(e,[{key:"userData",get:function(){if(null===this._userData)throw new Error;return this._userData},set:function(e){if(null!==this._userData)throw new Error;this._userData=e}},{key:"Reset",value:function(){this._userData=null}},{key:"IsLeaf",value:function(){return null===this.child1}}]),e}(),Ft=function(){function e(){n(this,e),this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Ue(256)}return s(e,[{key:"Query",value:function(e,t){var i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){var n=i.Pop();if(null!==n&&n.aabb.TestOverlap(e))if(n.IsLeaf()){if(!t(n))return}else i.Push(n.child1),i.Push(n.child2)}}},{key:"QueryPoint",value:function(e,t){var i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){var n=i.Pop();if(null!==n&&n.aabb.TestContain(e))if(n.IsLeaf()){if(!t(n))return}else i.Push(n.child1),i.Push(n.child2)}}},{key:"RayCast",value:function(t,i){var n=t.p1,r=t.p2,s=we.SubVV(r,n,e.s_r);s.Normalize();var a=we.CrossOneV(s,e.s_v),o=we.AbsV(a,e.s_abs_v),u=t.maxFraction,h=e.s_segmentAABB,l=n.x+u*(r.x-n.x),c=n.y+u*(r.y-n.y);h.lowerBound.x=ue(n.x,l),h.lowerBound.y=ue(n.y,c),h.upperBound.x=he(n.x,l),h.upperBound.y=he(n.y,c);var _=this.m_stack.Reset();for(_.Push(this.m_root);_.GetCount()>0;){var f=_.Pop();if(null!==f&&It(f.aabb,h)){var d=f.aabb.GetCenter(),m=f.aabb.GetExtents();if(!(oe(we.DotVV(a,we.SubVV(n,d,we.s_t0)))-we.DotVV(o,m)>0))if(f.IsLeaf()){var p=e.s_subInput;p.p1.Copy(t.p1),p.p2.Copy(t.p2),p.maxFraction=u;var v=i(p,f);if(0===v)return;v>0&&(u=v,l=n.x+u*(r.x-n.x),c=n.y+u*(r.y-n.y),h.lowerBound.x=ue(n.x,l),h.lowerBound.y=ue(n.y,c),h.upperBound.x=he(n.x,l),h.upperBound.y=he(n.y,c))}else _.Push(f.child1),_.Push(f.child2)}}}},{key:"AllocateNode",value:function(){if(null!==this.m_freeList){var t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t}return new Nt(e.s_node_id++)}},{key:"FreeNode",value:function(e){e.parent=this.m_freeList,e.child1=null,e.child2=null,e.height=-1,e.Reset(),this.m_freeList=e}},{key:"CreateProxy",value:function(e,t){var i=this.AllocateNode(),n=d,r=d;return i.aabb.lowerBound.x=e.lowerBound.x-n,i.aabb.lowerBound.y=e.lowerBound.y-r,i.aabb.upperBound.x=e.upperBound.x+n,i.aabb.upperBound.y=e.upperBound.y+r,i.userData=t,i.height=0,this.InsertLeaf(i),i}},{key:"DestroyProxy",value:function(e){this.RemoveLeaf(e),this.FreeNode(e)}},{key:"MoveProxy",value:function(e,t,i){if(e.aabb.Contains(t))return!1;this.RemoveLeaf(e);var n=d,r=d;e.aabb.lowerBound.x=t.lowerBound.x-n,e.aabb.lowerBound.y=t.lowerBound.y-r,e.aabb.upperBound.x=t.upperBound.x+n,e.aabb.upperBound.y=t.upperBound.y+r;var s=m*i.x,a=m*i.y;return s<0?e.aabb.lowerBound.x+=s:e.aabb.upperBound.x+=s,a<0?e.aabb.lowerBound.y+=a:e.aabb.upperBound.y+=a,this.InsertLeaf(e),!0}},{key:"InsertLeaf",value:function(t){if(++this.m_insertionCount,null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);for(var i=t.aabb,n=this.m_root;!n.IsLeaf();){var r=Lt(n.child1),s=Lt(n.child2),a=n.aabb.GetPerimeter(),o=e.s_combinedAABB;o.Combine2(n.aabb,i);var u=o.GetPerimeter(),h=2*u,l=2*(u-a),c=void 0,_=e.s_aabb,f=void 0;r.IsLeaf()?(_.Combine2(i,r.aabb),c=_.GetPerimeter()+l):(_.Combine2(i,r.aabb),f=r.aabb.GetPerimeter(),c=_.GetPerimeter()-f+l);var d=void 0;if(s.IsLeaf()?(_.Combine2(i,s.aabb),d=_.GetPerimeter()+l):(_.Combine2(i,s.aabb),f=s.aabb.GetPerimeter(),d=_.GetPerimeter()-f+l),h<c&&h<d)break;n=c<d?r:s}var m=n.parent,p=this.AllocateNode();p.parent=m,p.aabb.Combine2(i,n.aabb),p.height=n.height+1,null!==m?(m.child1===n?m.child1=p:m.child2=p,p.child1=n,p.child2=t,n.parent=p,t.parent=p):(p.child1=n,p.child2=t,n.parent=p,t.parent=p,this.m_root=p);for(var v=t.parent;null!==v;){var y=Lt((v=this.Balance(v)).child1),g=Lt(v.child2);v.height=1+he(y.height,g.height),v.aabb.Combine2(y.aabb,g.aabb),v=v.parent}}},{key:"RemoveLeaf",value:function(e){if(e!==this.m_root){var t=Lt(e.parent),i=t&&t.parent,n=Lt(t.child1===e?t.child2:t.child1);if(null!==i){i.child1===t?i.child1=n:i.child2=n,n.parent=i,this.FreeNode(t);for(var r=i;null!==r;){var s=Lt((r=this.Balance(r)).child1),a=Lt(r.child2);r.aabb.Combine2(s.aabb,a.aabb),r.height=1+he(s.height,a.height),r=r.parent}}else this.m_root=n,n.parent=null,this.FreeNode(t)}else this.m_root=null}},{key:"Balance",value:function(e){if(e.IsLeaf()||e.height<2)return e;var t=Lt(e.child1),i=Lt(e.child2),n=i.height-t.height;if(n>1){var r=Lt(i.child1),s=Lt(i.child2);return i.child1=e,i.parent=e.parent,e.parent=i,null!==i.parent?i.parent.child1===e?i.parent.child1=i:i.parent.child2=i:this.m_root=i,r.height>s.height?(i.child2=r,e.child2=s,s.parent=e,e.aabb.Combine2(t.aabb,s.aabb),i.aabb.Combine2(e.aabb,r.aabb),e.height=1+he(t.height,s.height),i.height=1+he(e.height,r.height)):(i.child2=s,e.child2=r,r.parent=e,e.aabb.Combine2(t.aabb,r.aabb),i.aabb.Combine2(e.aabb,s.aabb),e.height=1+he(t.height,r.height),i.height=1+he(e.height,s.height)),i}if(n<-1){var a=Lt(t.child1),o=Lt(t.child2);return t.child1=e,t.parent=e.parent,e.parent=t,null!==t.parent?t.parent.child1===e?t.parent.child1=t:t.parent.child2=t:this.m_root=t,a.height>o.height?(t.child2=a,e.child1=o,o.parent=e,e.aabb.Combine2(i.aabb,o.aabb),t.aabb.Combine2(e.aabb,a.aabb),e.height=1+he(i.height,o.height),t.height=1+he(e.height,a.height)):(t.child2=o,e.child1=a,a.parent=e,e.aabb.Combine2(i.aabb,a.aabb),t.aabb.Combine2(e.aabb,o.aabb),e.height=1+he(i.height,a.height),t.height=1+he(e.height,o.height)),t}return e}},{key:"GetHeight",value:function(){return null===this.m_root?0:this.m_root.height}},{key:"GetAreaRatio",value:function(){if(null===this.m_root)return 0;var t=this.m_root.aabb.GetPerimeter();return e.GetAreaNode(this.m_root)/t}},{key:"ComputeHeight",value:function(){return e.ComputeHeightNode(this.m_root)}},{key:"ValidateStructure",value:function(e){if(null!==e&&(this.m_root,!e.IsLeaf())){var t=Lt(e.child1),i=Lt(e.child2);this.ValidateStructure(t),this.ValidateStructure(i)}}},{key:"ValidateMetrics",value:function(t){if(null!==t&&!t.IsLeaf()){var i=Lt(t.child1),n=Lt(t.child2);e.s_aabb.Combine2(i.aabb,n.aabb),this.ValidateMetrics(i),this.ValidateMetrics(n)}}},{key:"Validate",value:function(){}},{key:"GetMaxBalance",value:function(){return e.GetMaxBalanceNode(this.m_root,0)}},{key:"RebuildBottomUp",value:function(){this.Validate()}},{key:"ShiftOrigin",value:function(t){e.ShiftOriginNode(this.m_root,t)}}],[{key:"GetAreaNode",value:function(t){if(null===t)return 0;if(t.IsLeaf())return 0;var i=t.aabb.GetPerimeter();return(i+=e.GetAreaNode(t.child1))+e.GetAreaNode(t.child2)}},{key:"ComputeHeightNode",value:function(t){return null===t||t.IsLeaf()?0:1+he(e.ComputeHeightNode(t.child1),e.ComputeHeightNode(t.child2))}},{key:"GetMaxBalanceNode",value:function(e,t){if(null===e)return t;if(e.height<=1)return t;var i=Lt(e.child1),n=Lt(e.child2);return he(t,oe(n.height-i.height))}},{key:"ShiftOriginNode",value:function(t,i){if(null!==t&&!(t.height<=1)){var n=t.child1,r=t.child2;e.ShiftOriginNode(n,i),e.ShiftOriginNode(r,i),t.aabb.lowerBound.SelfSub(i),t.aabb.upperBound.SelfSub(i)}}}]),e}();function Gt(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function Vt(e,t){return e<t}function Ut(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length-t,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Vt,r=t,s=[],a=0;;){for(;r+1<i;i++){var o=e[r+Math.floor(Math.random()*(i-r))];s[a++]=i;for(var u=r-1;;){for(;n(e[++u],o););for(;n(o,e[--i]););if(u>=i)break;Gt(e,u,i)}}if(0===a)break;r=i,i=s[--a]}return e}Ft.s_r=new we,Ft.s_v=new we,Ft.s_abs_v=new we,Ft.s_segmentAABB=new kt,Ft.s_subInput=new xt,Ft.s_combinedAABB=new kt,Ft.s_aabb=new kt,Ft.s_node_id=0;var Ht=function e(t,i){n(this,e),this.proxyA=t,this.proxyB=i},zt=function(){function e(){n(this,e),this.m_tree=new Ft,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}return s(e,[{key:"CreateProxy",value:function(e,t){var i=this.m_tree.CreateProxy(e,t);return++this.m_proxyCount,this.BufferMove(i),i}},{key:"DestroyProxy",value:function(e){this.UnBufferMove(e),--this.m_proxyCount,this.m_tree.DestroyProxy(e)}},{key:"MoveProxy",value:function(e,t,i){this.m_tree.MoveProxy(e,t,i)&&this.BufferMove(e)}},{key:"TouchProxy",value:function(e){this.BufferMove(e)}},{key:"GetProxyCount",value:function(){return this.m_proxyCount}},{key:"UpdatePairs",value:function(e){var t=this;this.m_pairCount=0;for(var i=function(e){var i=t.m_moveBuffer[e];if(null===i)return"continue";var n=i.aabb;t.m_tree.Query(n,(function(e){if(e.m_id===i.m_id)return!0;var n,r;if(e.m_id<i.m_id?(n=e,r=i):(n=i,r=e),t.m_pairCount===t.m_pairBuffer.length)t.m_pairBuffer[t.m_pairCount]=new Ht(n,r);else{var s=t.m_pairBuffer[t.m_pairCount];s.proxyA=n,s.proxyB=r}return++t.m_pairCount,!0}))},n=0;n<this.m_moveCount;++n)i(n);this.m_moveCount=0,Ut(this.m_pairBuffer,0,this.m_pairCount,Wt);for(var r=0;r<this.m_pairCount;){var s=this.m_pairBuffer[r];for(e(s.proxyA.userData,s.proxyB.userData),++r;r<this.m_pairCount;){var a=this.m_pairBuffer[r];if(a.proxyA.m_id!==s.proxyA.m_id||a.proxyB.m_id!==s.proxyB.m_id)break;++r}}}},{key:"Query",value:function(e,t){this.m_tree.Query(e,t)}},{key:"QueryPoint",value:function(e,t){this.m_tree.QueryPoint(e,t)}},{key:"RayCast",value:function(e,t){this.m_tree.RayCast(e,t)}},{key:"GetTreeHeight",value:function(){return this.m_tree.GetHeight()}},{key:"GetTreeBalance",value:function(){return this.m_tree.GetMaxBalance()}},{key:"GetTreeQuality",value:function(){return this.m_tree.GetAreaRatio()}},{key:"ShiftOrigin",value:function(e){this.m_tree.ShiftOrigin(e)}},{key:"BufferMove",value:function(e){this.m_moveBuffer[this.m_moveCount]=e,++this.m_moveCount}},{key:"UnBufferMove",value:function(e){var t=this.m_moveBuffer.indexOf(e);this.m_moveBuffer[t]=null}}]),e}();function Wt(e,t){return e.proxyA.m_id<t.proxyA.m_id||e.proxyA.m_id===t.proxyA.m_id&&e.proxyB.m_id<t.proxyB.m_id}function Xt(){e.b2_toiTime=0,e.b2_toiMaxTime=0,e.b2_toiCalls=0,e.b2_toiIters=0,e.b2_toiMaxIters=0,e.b2_toiRootIters=0,e.b2_toiMaxRootIters=0}e.b2_toiTime=0,e.b2_toiMaxTime=0,e.b2_toiCalls=0,e.b2_toiIters=0,e.b2_toiMaxIters=0,e.b2_toiRootIters=0,e.b2_toiMaxRootIters=0;var jt,qt=new Oe,Yt=new Oe,Kt=new we,Qt=new we,Jt=new we,Zt=new we,$t=new we,ei=function e(){n(this,e),this.proxyA=new We,this.proxyB=new We,this.sweepA=new Le,this.sweepB=new Le,this.tMax=0};(jt=e.b2TOIOutputState||(e.b2TOIOutputState={}))[jt.e_unknown=0]="e_unknown",jt[jt.e_failed=1]="e_failed",jt[jt.e_overlapped=2]="e_overlapped",jt[jt.e_touching=3]="e_touching",jt[jt.e_separated=4]="e_separated";var ti,ii=function t(){n(this,t),this.state=e.b2TOIOutputState.e_unknown,this.t=0};(ti=e.b2SeparationFunctionType||(e.b2SeparationFunctionType={}))[ti.e_unknown=-1]="e_unknown",ti[ti.e_points=0]="e_points",ti[ti.e_faceA=1]="e_faceA",ti[ti.e_faceB=2]="e_faceB";var ni=function(){function t(){n(this,t),this.m_sweepA=new Le,this.m_sweepB=new Le,this.m_type=e.b2SeparationFunctionType.e_unknown,this.m_localPoint=new we,this.m_axis=new we}return s(t,[{key:"Initialize",value:function(t,i,n,r,s,a){this.m_proxyA=i,this.m_proxyB=r;var o=t.count;this.m_sweepA.Copy(n),this.m_sweepB.Copy(s);var u=qt,h=Yt;if(this.m_sweepA.GetTransform(u,a),this.m_sweepB.GetTransform(h,a),1===o){this.m_type=e.b2SeparationFunctionType.e_points;var l=this.m_proxyA.GetVertex(t.indexA[0]),c=this.m_proxyB.GetVertex(t.indexB[0]),_=Oe.MulXV(u,l,Kt),f=Oe.MulXV(h,c,Qt);we.SubVV(f,_,this.m_axis);var d=this.m_axis.Normalize();return this.m_localPoint.SetZero(),d}if(t.indexA[0]===t.indexA[1]){this.m_type=e.b2SeparationFunctionType.e_faceB;var m=this.m_proxyB.GetVertex(t.indexB[0]),p=this.m_proxyB.GetVertex(t.indexB[1]);we.CrossVOne(we.SubVV(p,m,we.s_t0),this.m_axis).SelfNormalize();var v=Me.MulRV(h.q,this.m_axis,Jt);we.MidVV(m,p,this.m_localPoint);var y=Oe.MulXV(h,this.m_localPoint,Qt),g=this.m_proxyA.GetVertex(t.indexA[0]),S=Oe.MulXV(u,g,Kt),A=we.DotVV(we.SubVV(S,y,we.s_t0),v);return A<0&&(this.m_axis.SelfNeg(),A=-A),A}this.m_type=e.b2SeparationFunctionType.e_faceA;var T=this.m_proxyA.GetVertex(t.indexA[0]),E=this.m_proxyA.GetVertex(t.indexA[1]);we.CrossVOne(we.SubVV(E,T,we.s_t0),this.m_axis).SelfNormalize();var b=Me.MulRV(u.q,this.m_axis,Jt);we.MidVV(T,E,this.m_localPoint);var C=Oe.MulXV(u,this.m_localPoint,Kt),R=this.m_proxyB.GetVertex(t.indexB[0]),x=Oe.MulXV(h,R,Qt),w=we.DotVV(we.SubVV(x,C,we.s_t0),b);return w<0&&(this.m_axis.SelfNeg(),w=-w),w}},{key:"FindMinSeparation",value:function(t,i,n){var r=qt,s=Yt;switch(this.m_sweepA.GetTransform(r,n),this.m_sweepB.GetTransform(s,n),this.m_type){case e.b2SeparationFunctionType.e_points:var a=Me.MulTRV(r.q,this.m_axis,Zt),o=Me.MulTRV(s.q,we.NegV(this.m_axis,we.s_t0),$t);t[0]=this.m_proxyA.GetSupport(a),i[0]=this.m_proxyB.GetSupport(o);var u=this.m_proxyA.GetVertex(t[0]),h=this.m_proxyB.GetVertex(i[0]),l=Oe.MulXV(r,u,Kt),c=Oe.MulXV(s,h,Qt);return we.DotVV(we.SubVV(c,l,we.s_t0),this.m_axis);case e.b2SeparationFunctionType.e_faceA:var _=Me.MulRV(r.q,this.m_axis,Jt),f=Oe.MulXV(r,this.m_localPoint,Kt),d=Me.MulTRV(s.q,we.NegV(_,we.s_t0),$t);t[0]=-1,i[0]=this.m_proxyB.GetSupport(d);var m=this.m_proxyB.GetVertex(i[0]),p=Oe.MulXV(s,m,Qt);return we.DotVV(we.SubVV(p,f,we.s_t0),_);case e.b2SeparationFunctionType.e_faceB:var v=Me.MulRV(s.q,this.m_axis,Jt),y=Oe.MulXV(s,this.m_localPoint,Qt),g=Me.MulTRV(r.q,we.NegV(v,we.s_t0),Zt);i[0]=-1,t[0]=this.m_proxyA.GetSupport(g);var S=this.m_proxyA.GetVertex(t[0]),A=Oe.MulXV(r,S,Kt);return we.DotVV(we.SubVV(A,y,we.s_t0),v);default:return t[0]=-1,i[0]=-1,0}}},{key:"Evaluate",value:function(t,i,n){var r=qt,s=Yt;switch(this.m_sweepA.GetTransform(r,n),this.m_sweepB.GetTransform(s,n),this.m_type){case e.b2SeparationFunctionType.e_points:var a=this.m_proxyA.GetVertex(t),o=this.m_proxyB.GetVertex(i),u=Oe.MulXV(r,a,Kt),h=Oe.MulXV(s,o,Qt);return we.DotVV(we.SubVV(h,u,we.s_t0),this.m_axis);case e.b2SeparationFunctionType.e_faceA:var l=Me.MulRV(r.q,this.m_axis,Jt),c=Oe.MulXV(r,this.m_localPoint,Kt),_=this.m_proxyB.GetVertex(i),f=Oe.MulXV(s,_,Qt);return we.DotVV(we.SubVV(f,c,we.s_t0),l);case e.b2SeparationFunctionType.e_faceB:var d=Me.MulRV(s.q,this.m_axis,Jt),m=Oe.MulXV(s,this.m_localPoint,Qt),p=this.m_proxyA.GetVertex(t),v=Oe.MulXV(r,p,Kt);return we.DotVV(we.SubVV(v,m,we.s_t0),d);default:return 0}}}]),t}(),ri=new Ge,si=new Xe,ai=new je,oi=new qe,ui=new ni,hi=[0],li=[0],ci=new Le,_i=new Le;function fi(t,i){var n=ri.Reset();++e.b2_toiCalls,t.state=e.b2TOIOutputState.e_unknown,t.t=i.tMax;var r=i.proxyA,s=i.proxyB,a=he(_,he(r.m_count,s.m_count)),o=ci.Copy(i.sweepA),u=_i.Copy(i.sweepB);o.Normalize(),u.Normalize();var h=i.tMax,l=r.m_radius+s.m_radius,c=he(p,l-3*p),f=.25*p,d=0,m=20,v=0,y=si;y.count=0;var g=ai;for(g.proxyA.Copy(i.proxyA),g.proxyB.Copy(i.proxyB),g.useRadii=!1;;){var S=qt,A=Yt;o.GetTransform(S,d),u.GetTransform(A,d),g.transformA.Copy(S),g.transformB.Copy(A);var T=oi;if(ot(T,y,g),T.distance<=0){t.state=e.b2TOIOutputState.e_overlapped,t.t=0;break}if(T.distance<c+f){t.state=e.b2TOIOutputState.e_touching,t.t=d;break}var E=ui;E.Initialize(y,r,o,s,u,d);for(var b=!1,C=h,R=0;;){var x=hi,w=li,k=E.FindMinSeparation(x,w,C);if(k>c+f){t.state=e.b2TOIOutputState.e_separated,t.t=h,b=!0;break}if(k>c-f){d=C;break}var I=E.Evaluate(x[0],w[0],d);if(I<c-f){t.state=e.b2TOIOutputState.e_failed,t.t=d,b=!0;break}if(I<=c+f){t.state=e.b2TOIOutputState.e_touching,t.t=d,b=!0;break}for(var B=0,P=d,M=C;;){var O=0;O=1&B?P+(c-I)*(M-P)/(k-I):.5*(P+M),++B,++e.b2_toiRootIters;var D=E.Evaluate(x[0],w[0],O);if(oe(D-c)<f){C=O;break}if(D>c?(P=O,I=D):(M=O,k=D),50===B)break}if(e.b2_toiMaxRootIters=he(e.b2_toiMaxRootIters,B),++R===a)break}if(++v,++e.b2_toiIters,b)break;if(v===m){t.state=e.b2TOIOutputState.e_failed,t.t=d;break}}e.b2_toiMaxIters=he(e.b2_toiMaxIters,v);var L=n.GetMilliseconds();e.b2_toiMaxTime=he(e.b2_toiMaxTime,L),e.b2_toiTime+=L}var di=new we,mi=new we;function pi(t,i,n,r,s){t.pointCount=0;var a=Oe.MulXV(n,i.m_p,di),o=Oe.MulXV(s,r.m_p,mi),u=we.DistanceSquaredVV(a,o),h=i.m_radius+r.m_radius;u>h*h||(t.type=e.b2ManifoldType.e_circles,t.localPoint.Copy(i.m_p),t.localNormal.SetZero(),t.pointCount=1,t.points[0].localPoint.Copy(r.m_p),t.points[0].id.key=0)}var vi=new we,yi=new we,gi=new we;function Si(t,i,n,s,o){t.pointCount=0;for(var u=Oe.MulXV(o,s.m_p,vi),h=Oe.MulTXV(n,u,yi),l=0,c=-r,_=i.m_radius+s.m_radius,f=i.m_count,d=i.m_vertices,m=i.m_normals,p=0;p<f;++p){var v=we.DotVV(m[p],we.SubVV(h,d[p],we.s_t0));if(v>_)return;v>c&&(c=v,l=p)}var y=l,g=(y+1)%f,S=d[y],A=d[g];if(c<a)return t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,t.localNormal.Copy(m[l]),we.MidVV(S,A,t.localPoint),t.points[0].localPoint.Copy(s.m_p),void(t.points[0].id.key=0);var T=we.DotVV(we.SubVV(h,S,we.s_t0),we.SubVV(A,S,we.s_t1)),E=we.DotVV(we.SubVV(h,A,we.s_t0),we.SubVV(S,A,we.s_t1));if(T<=0){if(we.DistanceSquaredVV(h,S)>_*_)return;t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,we.SubVV(h,S,t.localNormal).SelfNormalize(),t.localPoint.Copy(S),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}else if(E<=0){if(we.DistanceSquaredVV(h,A)>_*_)return;t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,we.SubVV(h,A,t.localNormal).SelfNormalize(),t.localPoint.Copy(A),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}else{var b=we.MidVV(S,A,gi);if(we.DotVV(we.SubVV(h,b,we.s_t1),m[y])>_)return;t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,t.localNormal.Copy(m[y]).SelfNormalize(),t.localPoint.Copy(b),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}}var Ai=new we,Ti=new we,Ei=new we,bi=new we;function Ci(e,t,i,n,s){for(var a=e.m_vertices,o=e.m_normals,u=n.m_count,h=n.m_vertices,l=Me.MulRV(t.q,o[i],Ai),c=Me.MulTRV(s.q,l,Ti),_=0,f=r,d=0;d<u;++d){var m=we.DotVV(h[d],c);m<f&&(f=m,_=d)}var p=Oe.MulXV(t,a[i],Ei),v=Oe.MulXV(s,h[_],bi);return we.DotVV(we.SubVV(v,p,we.s_t0),l)}var Ri=new we,xi=new we;function wi(e,t,i,n,s){for(var a=t.m_count,o=t.m_normals,u=we.SubVV(Oe.MulXV(s,n.m_centroid,we.s_t0),Oe.MulXV(i,t.m_centroid,we.s_t1),Ri),h=Me.MulTRV(i.q,u,xi),l=0,c=-r,_=0;_<a;++_){var f=we.DotVV(o[_],h);f>c&&(c=f,l=_)}var d=Ci(t,i,l,n,s),m=(l+a-1)%a,p=Ci(t,i,m,n,s),v=(l+1)%a,y=Ci(t,i,v,n,s),g=0,S=0,A=0;if(p>d&&p>y)A=-1,g=m,S=p;else{if(!(y>d))return e[0]=l,d;A=1,g=v,S=y}for(;(d=Ci(t,i,l=-1===A?(g+a-1)%a:(g+1)%a,n,s))>S;)g=l,S=d;return e[0]=g,S}var ki=new we;function Ii(t,i,n,s,a,o){for(var u=i.m_normals,h=a.m_count,l=a.m_vertices,c=a.m_normals,_=Me.MulTRV(o.q,Me.MulRV(n.q,u[s],we.s_t0),ki),f=0,d=r,m=0;m<h;++m){var p=we.DotVV(_,c[m]);p<d&&(d=p,f=m)}var v=f,y=(v+1)%h,g=t[0];Oe.MulXV(o,l[v],g.v);var S=g.id.cf;S.indexA=s,S.indexB=v,S.typeA=e.b2ContactFeatureType.e_face,S.typeB=e.b2ContactFeatureType.e_vertex;var A=t[1];Oe.MulXV(o,l[y],A.v);var T=A.id.cf;T.indexA=s,T.indexB=y,T.typeA=e.b2ContactFeatureType.e_face,T.typeB=e.b2ContactFeatureType.e_vertex}var Bi=Rt.MakeArray(2),Pi=Rt.MakeArray(2),Mi=Rt.MakeArray(2),Oi=[0],Di=[0],Li=new we,Ni=new we,Fi=new we,Gi=new we,Vi=new we,Ui=new we,Hi=new we,zi=new we;function Wi(t,i,n,r,s){t.pointCount=0;var a=i.m_radius+r.m_radius,o=Oi;o[0]=0;var u=wi(o,i,n,r,s);if(!(u>a)){var h=Di;h[0]=0;var l=wi(h,r,s,i,n);if(!(l>a)){var _,f,d,m,p=0,v=0;l>.98*u+.001?(_=r,f=i,d=s,m=n,p=h[0],t.type=e.b2ManifoldType.e_faceB,v=1):(_=i,f=r,d=n,m=s,p=o[0],t.type=e.b2ManifoldType.e_faceA,v=0);var y=Bi;Ii(y,_,d,p,f,m);var g=_.m_count,S=_.m_vertices,A=p,T=(p+1)%g,E=S[A],b=S[T],C=we.SubVV(b,E,Li);C.Normalize();var R=we.CrossVOne(C,Ni),x=we.MidVV(E,b,Fi),w=Me.MulRV(d.q,C,Vi),k=we.CrossVOne(w,Gi),I=Oe.MulXV(d,E,Hi),B=Oe.MulXV(d,b,zi),P=we.DotVV(k,I),M=-we.DotVV(w,I)+a,O=we.DotVV(w,B)+a,D=Pi,L=Mi;if(!(Bt(D,y,we.NegV(w,Ui),M,A)<2||Bt(L,D,w,O,T)<2)){t.localNormal.Copy(R),t.localPoint.Copy(x);for(var N=0,F=0;F<c;++F){var G=L[F];if(we.DotVV(k,G.v)-P<=a){var V=t.points[N];if(Oe.MulTXV(m,G.v,V.localPoint),V.id.Copy(G.id),v){var U=V.id.cf;V.id.cf.indexA=U.indexB,V.id.cf.indexB=U.indexA,V.id.cf.typeA=U.typeB,V.id.cf.typeB=U.typeA}++N}}t.pointCount=N}}}}var Xi,ji=new we,qi=new we,Yi=new we,Ki=new we,Qi=new we,Ji=new we,Zi=new we,$i=new St;function en(t,i,n,r,s){t.pointCount=0;var a=Oe.MulTXV(n,Oe.MulXV(s,r.m_p,we.s_t0),ji),o=i.m_vertex1,u=i.m_vertex2,h=we.SubVV(u,o,qi),l=we.DotVV(h,we.SubVV(u,a,we.s_t0)),c=we.DotVV(h,we.SubVV(a,o,we.s_t0)),_=i.m_radius+r.m_radius,f=$i;if(f.cf.indexB=0,f.cf.typeB=e.b2ContactFeatureType.e_vertex,c<=0){var d=o,m=we.SubVV(a,d,Yi);if(we.DotVV(m,m)>_*_)return;if(i.m_hasVertex0){var p=i.m_vertex0,v=o,y=we.SubVV(v,p,Ki);if(we.DotVV(y,we.SubVV(v,a,we.s_t0))>0)return}return f.cf.indexA=0,f.cf.typeA=e.b2ContactFeatureType.e_vertex,t.pointCount=1,t.type=e.b2ManifoldType.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(d),t.points[0].id.Copy(f),void t.points[0].localPoint.Copy(r.m_p)}if(l<=0){var g=u,S=we.SubVV(a,g,Yi);if(we.DotVV(S,S)>_*_)return;if(i.m_hasVertex3){var A=i.m_vertex3,T=u,E=we.SubVV(A,T,Qi);if(we.DotVV(E,we.SubVV(a,T,we.s_t0))>0)return}return f.cf.indexA=1,f.cf.typeA=e.b2ContactFeatureType.e_vertex,t.pointCount=1,t.type=e.b2ManifoldType.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(g),t.points[0].id.Copy(f),void t.points[0].localPoint.Copy(r.m_p)}var b=we.DotVV(h,h),C=Ji;C.x=1/b*(l*o.x+c*u.x),C.y=1/b*(l*o.y+c*u.y);var R=we.SubVV(a,C,Yi);if(!(we.DotVV(R,R)>_*_)){var x=Zi.Set(-h.y,h.x);we.DotVV(x,we.SubVV(a,o,we.s_t0))<0&&x.Set(-x.x,-x.y),x.Normalize(),f.cf.indexA=0,f.cf.typeA=e.b2ContactFeatureType.e_face,t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,t.localNormal.Copy(x),t.localPoint.Copy(o),t.points[0].id.Copy(f),t.points[0].localPoint.Copy(r.m_p)}}!function(e){e[e.e_unknown=0]="e_unknown",e[e.e_edgeA=1]="e_edgeA",e[e.e_edgeB=2]="e_edgeB"}(Xi||(Xi={}));var tn,nn=function e(){n(this,e),this.type=Xi.e_unknown,this.index=0,this.separation=0},rn=function e(){n(this,e),this.vertices=[],this.normals=[],this.count=0},sn=function e(){n(this,e),this.i1=0,this.i2=0,this.v1=new we,this.v2=new we,this.normal=new we,this.sideNormal1=new we,this.sideOffset1=0,this.sideNormal2=new we,this.sideOffset2=0};!function(e){e[e.e_isolated=0]="e_isolated",e[e.e_concave=1]="e_concave",e[e.e_convex=2]="e_convex"}(tn||(tn={}));var an=function(){function t(){n(this,t),this.m_polygonB=new rn,this.m_xf=new Oe,this.m_centroidB=new we,this.m_v0=new we,this.m_v1=new we,this.m_v2=new we,this.m_v3=new we,this.m_normal0=new we,this.m_normal1=new we,this.m_normal2=new we,this.m_normal=new we,this.m_type1=tn.e_isolated,this.m_type2=tn.e_isolated,this.m_lowerLimit=new we,this.m_upperLimit=new we,this.m_radius=0,this.m_front=!1}return s(t,[{key:"Collide",value:function(i,n,r,s,a){Oe.MulTXX(r,a,this.m_xf),Oe.MulXV(this.m_xf,s.m_centroid,this.m_centroidB),this.m_v0.Copy(n.m_vertex0),this.m_v1.Copy(n.m_vertex1),this.m_v2.Copy(n.m_vertex2),this.m_v3.Copy(n.m_vertex3);var o=n.m_hasVertex0,u=n.m_hasVertex3,h=we.SubVV(this.m_v2,this.m_v1,t.s_edge1);h.Normalize(),this.m_normal1.Set(h.y,-h.x);var l=we.DotVV(this.m_normal1,we.SubVV(this.m_centroidB,this.m_v1,we.s_t0)),_=0,f=0,d=!1,m=!1;if(o){var p=we.SubVV(this.m_v1,this.m_v0,t.s_edge0);p.Normalize(),this.m_normal0.Set(p.y,-p.x),d=we.CrossVV(p,h)>=0,_=we.DotVV(this.m_normal0,we.SubVV(this.m_centroidB,this.m_v0,we.s_t0))}if(u){var v=we.SubVV(this.m_v3,this.m_v2,t.s_edge2);v.Normalize(),this.m_normal2.Set(v.y,-v.x),m=we.CrossVV(h,v)>0,f=we.DotVV(this.m_normal2,we.SubVV(this.m_centroidB,this.m_v2,we.s_t0))}o&&u?d&&m?(this.m_front=_>=0||l>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):d?(this.m_front=_>=0||l>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):m?(this.m_front=f>=0||_>=0&&l>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&l>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):o?d?(this.m_front=_>=0||l>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&l>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):u?m?(this.m_front=l>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=l>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=l>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=s.m_count;for(var y=0;y<s.m_count;++y)this.m_polygonB.vertices.length<=y&&this.m_polygonB.vertices.push(new we),this.m_polygonB.normals.length<=y&&this.m_polygonB.normals.push(new we),Oe.MulXV(this.m_xf,s.m_vertices[y],this.m_polygonB.vertices[y]),Me.MulRV(this.m_xf.q,s.m_normals[y],this.m_polygonB.normals[y]);this.m_radius=s.m_radius+n.m_radius,i.pointCount=0;var g=this.ComputeEdgeSeparation(t.s_edgeAxis);if(g.type!==Xi.e_unknown&&!(g.separation>this.m_radius)){var S=this.ComputePolygonSeparation(t.s_polygonAxis);if(!(S.type!==Xi.e_unknown&&S.separation>this.m_radius)){var A,T=.98,E=.001;A=S.type===Xi.e_unknown?g:S.separation>T*g.separation+E?S:g;var b=t.s_ie,C=t.s_rf;if(A.type===Xi.e_edgeA){i.type=e.b2ManifoldType.e_faceA;for(var R=0,x=we.DotVV(this.m_normal,this.m_polygonB.normals[0]),w=1;w<this.m_polygonB.count;++w){var k=we.DotVV(this.m_normal,this.m_polygonB.normals[w]);k<x&&(x=k,R=w)}var I=R,B=(I+1)%this.m_polygonB.count,P=b[0];P.v.Copy(this.m_polygonB.vertices[I]),P.id.cf.indexA=0,P.id.cf.indexB=I,P.id.cf.typeA=e.b2ContactFeatureType.e_face,P.id.cf.typeB=e.b2ContactFeatureType.e_vertex;var M=b[1];M.v.Copy(this.m_polygonB.vertices[B]),M.id.cf.indexA=0,M.id.cf.indexB=B,M.id.cf.typeA=e.b2ContactFeatureType.e_face,M.id.cf.typeB=e.b2ContactFeatureType.e_vertex,this.m_front?(C.i1=0,C.i2=1,C.v1.Copy(this.m_v1),C.v2.Copy(this.m_v2),C.normal.Copy(this.m_normal1)):(C.i1=1,C.i2=0,C.v1.Copy(this.m_v2),C.v2.Copy(this.m_v1),C.normal.Copy(this.m_normal1).SelfNeg())}else{i.type=e.b2ManifoldType.e_faceB;var O=b[0];O.v.Copy(this.m_v1),O.id.cf.indexA=0,O.id.cf.indexB=A.index,O.id.cf.typeA=e.b2ContactFeatureType.e_vertex,O.id.cf.typeB=e.b2ContactFeatureType.e_face;var D=b[1];D.v.Copy(this.m_v2),D.id.cf.indexA=0,D.id.cf.indexB=A.index,D.id.cf.typeA=e.b2ContactFeatureType.e_vertex,D.id.cf.typeB=e.b2ContactFeatureType.e_face,C.i1=A.index,C.i2=(C.i1+1)%this.m_polygonB.count,C.v1.Copy(this.m_polygonB.vertices[C.i1]),C.v2.Copy(this.m_polygonB.vertices[C.i2]),C.normal.Copy(this.m_polygonB.normals[C.i1])}C.sideNormal1.Set(C.normal.y,-C.normal.x),C.sideNormal2.Copy(C.sideNormal1).SelfNeg(),C.sideOffset1=we.DotVV(C.sideNormal1,C.v1),C.sideOffset2=we.DotVV(C.sideNormal2,C.v2);var L=t.s_clipPoints1,N=t.s_clipPoints2;if(!(Bt(L,b,C.sideNormal1,C.sideOffset1,C.i1)<c||Bt(N,L,C.sideNormal2,C.sideOffset2,C.i2)<c)){A.type===Xi.e_edgeA?(i.localNormal.Copy(C.normal),i.localPoint.Copy(C.v1)):(i.localNormal.Copy(s.m_normals[C.i1]),i.localPoint.Copy(s.m_vertices[C.i1]));for(var F=0,G=0;G<c;++G)if(we.DotVV(C.normal,we.SubVV(N[G].v,C.v1,we.s_t0))<=this.m_radius){var V=i.points[F];A.type===Xi.e_edgeA?(Oe.MulTXV(this.m_xf,N[G].v,V.localPoint),V.id.Copy(N[G].id)):(V.localPoint.Copy(N[G].v),V.id.cf.typeA=N[G].id.cf.typeB,V.id.cf.typeB=N[G].id.cf.typeA,V.id.cf.indexA=N[G].id.cf.indexB,V.id.cf.indexB=N[G].id.cf.indexA),++F}i.pointCount=F}}}}},{key:"ComputeEdgeSeparation",value:function(e){var t=e;t.type=Xi.e_edgeA,t.index=this.m_front?0:1,t.separation=r;for(var i=0;i<this.m_polygonB.count;++i){var n=we.DotVV(this.m_normal,we.SubVV(this.m_polygonB.vertices[i],this.m_v1,we.s_t0));n<t.separation&&(t.separation=n)}return t}},{key:"ComputePolygonSeparation",value:function(e){var i=e;i.type=Xi.e_unknown,i.index=-1,i.separation=-r;for(var n=t.s_perp.Set(-this.m_normal.y,this.m_normal.x),s=0;s<this.m_polygonB.count;++s){var a=we.NegV(this.m_polygonB.normals[s],t.s_n),o=ue(we.DotVV(a,we.SubVV(this.m_polygonB.vertices[s],this.m_v1,we.s_t0)),we.DotVV(a,we.SubVV(this.m_polygonB.vertices[s],this.m_v2,we.s_t0)));if(o>this.m_radius)return i.type=Xi.e_edgeB,i.index=s,i.separation=o,i;if(we.DotVV(a,n)>=0){if(we.DotVV(we.SubVV(a,this.m_upperLimit,we.s_t0),this.m_normal)<-y)continue}else if(we.DotVV(we.SubVV(a,this.m_lowerLimit,we.s_t0),this.m_normal)<-y)continue;o>i.separation&&(i.type=Xi.e_edgeB,i.index=s,i.separation=o)}return i}}]),t}();an.s_edge1=new we,an.s_edge0=new we,an.s_edge2=new we,an.s_ie=Rt.MakeArray(2),an.s_rf=new sn,an.s_clipPoints1=Rt.MakeArray(2),an.s_clipPoints2=Rt.MakeArray(2),an.s_edgeAxis=new nn,an.s_polygonAxis=new nn,an.s_n=new we,an.s_perp=new we;var on=new an;function un(e,t,i,n,r){on.Collide(e,t,i,n,r)}var hn,ln=function e(){n(this,e),this.mass=0,this.center=new we(0,0),this.I=0};(hn=e.b2ShapeType||(e.b2ShapeType={}))[hn.e_unknown=-1]="e_unknown",hn[hn.e_circleShape=0]="e_circleShape",hn[hn.e_edgeShape=1]="e_edgeShape",hn[hn.e_polygonShape=2]="e_polygonShape",hn[hn.e_chainShape=3]="e_chainShape",hn[hn.e_shapeTypeCount=4]="e_shapeTypeCount";var cn=function(){function t(i,r){n(this,t),this.m_type=e.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=i,this.m_radius=r}return s(t,[{key:"Copy",value:function(e){return this.m_radius=e.m_radius,this}},{key:"GetType",value:function(){return this.m_type}}]),t}(),_n=function(t){h(r,t);var i=v(r);function r(){var t,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return n(this,r),(t=i.call(this,e.b2ShapeType.e_circleShape,s)).m_p=new we,t}return s(r,[{key:"Set",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.m_radius;return this.m_p.Copy(e),this.m_radius=t,this}},{key:"Clone",value:function(){return(new r).Copy(this)}},{key:"Copy",value:function(e){return g(l(r.prototype),"Copy",this).call(this,e),this.m_p.Copy(e.m_p),this}},{key:"GetChildCount",value:function(){return 1}},{key:"TestPoint",value:function(e,t){var i=Oe.MulXV(e,this.m_p,r.TestPoint_s_center),n=we.SubVV(t,i,r.TestPoint_s_d);return we.DotVV(n,n)<=fe(this.m_radius)}},{key:"ComputeDistance",value:function(e,t,i){var n=Oe.MulXV(e,this.m_p,r.ComputeDistance_s_center);return we.SubVV(t,n,i),i.Normalize()-this.m_radius}},{key:"RayCast",value:function(e,t,i){var n=Oe.MulXV(i,this.m_p,r.RayCast_s_position),s=we.SubVV(t.p1,n,r.RayCast_s_s),o=we.DotVV(s,s)-fe(this.m_radius),u=we.SubVV(t.p2,t.p1,r.RayCast_s_r),h=we.DotVV(s,u),l=we.DotVV(u,u),c=h*h-l*o;if(c<0||l<a)return!1;var _=-(h+me(c));return 0<=_&&_<=t.maxFraction*l&&(_/=l,e.fraction=_,we.AddVMulSV(s,_,u,e.normal).SelfNormalize(),!0)}},{key:"ComputeAABB",value:function(e,t){var i=Oe.MulXV(t,this.m_p,r.ComputeAABB_s_p);e.lowerBound.Set(i.x-this.m_radius,i.y-this.m_radius),e.upperBound.Set(i.x+this.m_radius,i.y+this.m_radius)}},{key:"ComputeMass",value:function(e,t){var i=fe(this.m_radius);e.mass=t*u*i,e.center.Copy(this.m_p),e.I=e.mass*(.5*i+we.DotVV(this.m_p,this.m_p))}},{key:"SetupDistanceProxy",value:function(e){e.m_vertices=e.m_buffer,e.m_vertices[0].Copy(this.m_p),e.m_count=1,e.m_radius=this.m_radius}},{key:"ComputeSubmergedArea",value:function(e,t,i,n){var r=Oe.MulXV(i,this.m_p,new we),s=-(we.DotVV(e,r)-t);if(s<-this.m_radius+a)return 0;if(s>this.m_radius)return n.Copy(r),u*this.m_radius*this.m_radius;var o=this.m_radius*this.m_radius,h=s*s,l=o*(Te(s/this.m_radius)+u/2)+s*me(o-h),c=-2/3*pe(o-h,1.5)/l;return n.x=r.x+e.x*c,n.y=r.y+e.y*c,l}},{key:"Dump",value:function(e){e("    const shape: b2CircleShape = new b2CircleShape();\n"),e("    shape.m_radius = %.15f;\n",this.m_radius),e("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)}}]),r}(cn);_n.TestPoint_s_center=new we,_n.TestPoint_s_d=new we,_n.ComputeDistance_s_center=new we,_n.RayCast_s_position=new we,_n.RayCast_s_s=new we,_n.RayCast_s_r=new we,_n.ComputeAABB_s_p=new we;var fn=function(t){h(o,t);var i=v(o);function o(){var t;return n(this,o),(t=i.call(this,e.b2ShapeType.e_polygonShape,S)).m_centroid=new we(0,0),t.m_vertices=[],t.m_normals=[],t.m_count=0,t}return s(o,[{key:"Clone",value:function(){return(new o).Copy(this)}},{key:"Copy",value:function(e){g(l(o.prototype),"Copy",this).call(this,e),this.m_centroid.Copy(e.m_centroid),this.m_count=e.m_count,this.m_vertices=we.MakeArray(this.m_count),this.m_normals=we.MakeArray(this.m_count);for(var t=0;t<this.m_count;++t)this.m_vertices[t].Copy(e.m_vertices[t]),this.m_normals[t].Copy(e.m_normals[t]);return this}},{key:"GetChildCount",value:function(){return 1}},{key:"Set",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if("number"==typeof t[0][0]){var n=t[0];if(n.length%2!=0)throw new Error;return this._Set((function(e){return{x:n[2*e],y:n[2*e+1]}}),n.length/2)}var r=t[0],s=t[1]||r.length;return this._Set((function(e){return r[e]}),s)}},{key:"_Set",value:function(e,t){if(t<3)return this.SetAsBox(1,1);for(var i=t,n=[],r=0;r<i;++r){for(var s=e(r),a=!0,u=0;u<n.length;++u)if(we.DistanceSquaredVV(s,n[u])<.25*p*p){a=!1;break}a&&n.push(s)}if((i=n.length)<3)return this.SetAsBox(1,1);for(var h=0,l=n[0].x,c=1;c<i;++c){var _=n[c].x;(_>l||_===l&&n[c].y<n[h].y)&&(h=c,l=_)}for(var f=[],d=0,m=h;;){f[d]=m;for(var v=0,y=1;y<i;++y)if(v!==m){var g=we.SubVV(n[v],n[f[d]],o.Set_s_r),S=we.SubVV(n[y],n[f[d]],o.Set_s_v),A=we.CrossVV(g,S);A<0&&(v=y),0===A&&S.LengthSquared()>g.LengthSquared()&&(v=y)}else v=y;if(++d,m=v,v===h)break}this.m_count=d,this.m_vertices=we.MakeArray(this.m_count),this.m_normals=we.MakeArray(this.m_count);for(var T=0;T<d;++T)this.m_vertices[T].Copy(n[f[T]]);for(var E=0;E<d;++E){var b=this.m_vertices[E],C=this.m_vertices[(E+1)%d],R=we.SubVV(C,b,we.s_t0);we.CrossVOne(R,this.m_normals[E]).SelfNormalize()}return o.ComputeCentroid(this.m_vertices,d,this.m_centroid),this}},{key:"SetAsBox",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(this.m_count=4,this.m_vertices=we.MakeArray(this.m_count),this.m_normals=we.MakeArray(this.m_count),this.m_vertices[0].Set(-e,-t),this.m_vertices[1].Set(e,-t),this.m_vertices[2].Set(e,t),this.m_vertices[3].Set(-e,t),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);var r=new Oe;r.SetPosition(i),r.SetRotationAngle(n);for(var s=0;s<this.m_count;++s)Oe.MulXV(r,this.m_vertices[s],this.m_vertices[s]),Me.MulRV(r.q,this.m_normals[s],this.m_normals[s])}return this}},{key:"TestPoint",value:function(e,t){for(var i=Oe.MulTXV(e,t,o.TestPoint_s_pLocal),n=0;n<this.m_count;++n)if(we.DotVV(this.m_normals[n],we.SubVV(i,this.m_vertices[n],we.s_t0))>0)return!1;return!0}},{key:"ComputeDistance",value:function(e,t,i){for(var n=Oe.MulTXV(e,t,o.ComputeDistance_s_pLocal),s=-r,a=o.ComputeDistance_s_normalForMaxDistance.Copy(n),u=0;u<this.m_count;++u){var h=we.DotVV(this.m_normals[u],we.SubVV(n,this.m_vertices[u],we.s_t0));h>s&&(s=h,a.Copy(this.m_normals[u]))}if(s>0){for(var l=o.ComputeDistance_s_minDistance.Copy(a),c=s*s,_=0;_<this.m_count;++_){var f=we.SubVV(n,this.m_vertices[_],o.ComputeDistance_s_distance),d=f.LengthSquared();c>d&&(l.Copy(f),c=d)}return Me.MulRV(e.q,l,i),i.Normalize(),Math.sqrt(c)}return Me.MulRV(e.q,a,i),s}},{key:"RayCast",value:function(e,t,i){for(var n=Oe.MulTXV(i,t.p1,o.RayCast_s_p1),r=Oe.MulTXV(i,t.p2,o.RayCast_s_p2),s=we.SubVV(r,n,o.RayCast_s_d),a=0,u=t.maxFraction,h=-1,l=0;l<this.m_count;++l){var c=we.DotVV(this.m_normals[l],we.SubVV(this.m_vertices[l],n,we.s_t0)),_=we.DotVV(this.m_normals[l],s);if(0===_){if(c<0)return!1}else _<0&&c<a*_?(a=c/_,h=l):_>0&&c<u*_&&(u=c/_);if(u<a)return!1}return h>=0&&(e.fraction=a,Me.MulRV(i.q,this.m_normals[h],e.normal),!0)}},{key:"ComputeAABB",value:function(e,t){for(var i=Oe.MulXV(t,this.m_vertices[0],e.lowerBound),n=e.upperBound.Copy(i),r=0;r<this.m_count;++r){var s=Oe.MulXV(t,this.m_vertices[r],o.ComputeAABB_s_v);we.MinV(s,i,i),we.MaxV(s,n,n)}var a=this.m_radius;i.SelfSubXY(a,a),n.SelfAddXY(a,a)}},{key:"ComputeMass",value:function(e,t){for(var i=o.ComputeMass_s_center.SetZero(),n=0,r=0,s=o.ComputeMass_s_s.SetZero(),a=0;a<this.m_count;++a)s.SelfAdd(this.m_vertices[a]);s.SelfMul(1/this.m_count);for(var u=1/3,h=0;h<this.m_count;++h){var l=we.SubVV(this.m_vertices[h],s,o.ComputeMass_s_e1),c=we.SubVV(this.m_vertices[(h+1)%this.m_count],s,o.ComputeMass_s_e2),_=we.CrossVV(l,c),f=.5*_;n+=f,i.SelfAdd(we.MulSV(f*u,we.AddVV(l,c,we.s_t0),we.s_t1));var d=l.x,m=l.y,p=c.x,v=c.y;r+=.25*u*_*(d*d+p*d+p*p+m*m+v*m+v*v)}e.mass=t*n,i.SelfMul(1/n),we.AddVV(i,s,e.center),e.I=t*r,e.I+=e.mass*(we.DotVV(e.center,e.center)-we.DotVV(i,i))}},{key:"Validate",value:function(){for(var e=0;e<this.m_count;++e)for(var t=e,i=(e+1)%this.m_count,n=this.m_vertices[t],r=we.SubVV(this.m_vertices[i],n,o.Validate_s_e),s=0;s<this.m_count;++s)if(s!==t&&s!==i){var a=we.SubVV(this.m_vertices[s],n,o.Validate_s_v);if(we.CrossVV(r,a)<0)return!1}return!0}},{key:"SetupDistanceProxy",value:function(e){e.m_vertices=this.m_vertices,e.m_count=this.m_count,e.m_radius=this.m_radius}},{key:"ComputeSubmergedArea",value:function(e,t,i,n){for(var r=Me.MulTRV(i.q,e,o.ComputeSubmergedArea_s_normalL),s=t-we.DotVV(e,i.p),u=[],h=0,l=-1,c=-1,_=!1,f=0;f<this.m_count;++f){u[f]=we.DotVV(r,this.m_vertices[f])-s;var d=u[f]<-a;f>0&&(d?_||(l=f-1,h++):_&&(c=f-1,h++)),_=d}switch(h){case 0:if(_){var m=o.ComputeSubmergedArea_s_md;return this.ComputeMass(m,1),Oe.MulXV(i,m.center,n),m.mass}return 0;case 1:-1===l?l=this.m_count-1:c=this.m_count-1}for(var p,v=(l+1)%this.m_count,y=(c+1)%this.m_count,g=(0-u[l])/(u[v]-u[l]),S=(0-u[c])/(u[y]-u[c]),A=o.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[l].x*(1-g)+this.m_vertices[v].x*g,this.m_vertices[l].y*(1-g)+this.m_vertices[v].y*g),T=o.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[c].x*(1-S)+this.m_vertices[y].x*S,this.m_vertices[c].y*(1-S)+this.m_vertices[y].y*S),E=0,b=o.ComputeSubmergedArea_s_center.SetZero(),C=this.m_vertices[v],R=v;R!==y;){p=(R=(R+1)%this.m_count)===y?T:this.m_vertices[R];var x=.5*((C.x-A.x)*(p.y-A.y)-(C.y-A.y)*(p.x-A.x));E+=x,b.x+=x*(A.x+C.x+p.x)/3,b.y+=x*(A.y+C.y+p.y)/3,C=p}return b.SelfMul(1/E),Oe.MulXV(i,b,n),E}},{key:"Dump",value:function(e){e("    const shape: b2PolygonShape = new b2PolygonShape();\n"),e("    const vs: b2Vec2[] = [];\n");for(var t=0;t<this.m_count;++t)e("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",t,this.m_vertices[t].x,this.m_vertices[t].y);e("    shape.Set(vs, %d);\n",this.m_count)}}],[{key:"ComputeCentroid",value:function(e,t,i){var n=i;n.SetZero();for(var r=0,s=o.ComputeCentroid_s_pRef.SetZero(),a=1/3,u=0;u<t;++u){var h=s,l=e[u],c=e[(u+1)%t],_=we.SubVV(l,h,o.ComputeCentroid_s_e1),f=we.SubVV(c,h,o.ComputeCentroid_s_e2),d=.5*we.CrossVV(_,f);r+=d,n.x+=d*a*(h.x+l.x+c.x),n.y+=d*a*(h.y+l.y+c.y)}return n.SelfMul(1/r),n}}]),o}(cn);fn.Set_s_r=new we,fn.Set_s_v=new we,fn.TestPoint_s_pLocal=new we,fn.ComputeDistance_s_pLocal=new we,fn.ComputeDistance_s_normalForMaxDistance=new we,fn.ComputeDistance_s_minDistance=new we,fn.ComputeDistance_s_distance=new we,fn.RayCast_s_p1=new we,fn.RayCast_s_p2=new we,fn.RayCast_s_d=new we,fn.ComputeAABB_s_v=new we,fn.ComputeMass_s_center=new we,fn.ComputeMass_s_s=new we,fn.ComputeMass_s_e1=new we,fn.ComputeMass_s_e2=new we,fn.Validate_s_e=new we,fn.Validate_s_v=new we,fn.ComputeSubmergedArea_s_normalL=new we,fn.ComputeSubmergedArea_s_md=new ln,fn.ComputeSubmergedArea_s_intoVec=new we,fn.ComputeSubmergedArea_s_outoVec=new we,fn.ComputeSubmergedArea_s_center=new we,fn.ComputeCentroid_s_pRef=new we,fn.ComputeCentroid_s_e1=new we,fn.ComputeCentroid_s_e2=new we;var dn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2ShapeType.e_edgeShape,S)).m_vertex1=new we,t.m_vertex2=new we,t.m_vertex0=new we,t.m_vertex3=new we,t.m_hasVertex0=!1,t.m_hasVertex3=!1,t}return s(r,[{key:"Set",value:function(e,t){return this.m_vertex1.Copy(e),this.m_vertex2.Copy(t),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this}},{key:"Clone",value:function(){return(new r).Copy(this)}},{key:"Copy",value:function(e){return g(l(r.prototype),"Copy",this).call(this,e),this.m_vertex1.Copy(e.m_vertex1),this.m_vertex2.Copy(e.m_vertex2),this.m_vertex0.Copy(e.m_vertex0),this.m_vertex3.Copy(e.m_vertex3),this.m_hasVertex0=e.m_hasVertex0,this.m_hasVertex3=e.m_hasVertex3,this}},{key:"GetChildCount",value:function(){return 1}},{key:"TestPoint",value:function(){return!1}},{key:"ComputeDistance",value:function(e,t,i){var n=Oe.MulXV(e,this.m_vertex1,r.ComputeDistance_s_v1),s=Oe.MulXV(e,this.m_vertex2,r.ComputeDistance_s_v2),a=we.SubVV(t,n,r.ComputeDistance_s_d),o=we.SubVV(s,n,r.ComputeDistance_s_s),u=we.DotVV(a,o);if(u>0){var h=we.DotVV(o,o);u>h?we.SubVV(t,s,a):a.SelfMulSub(u/h,o)}return i.Copy(a),i.Normalize()}},{key:"RayCast",value:function(e,t,i){var n=Oe.MulTXV(i,t.p1,r.RayCast_s_p1),s=Oe.MulTXV(i,t.p2,r.RayCast_s_p2),a=we.SubVV(s,n,r.RayCast_s_d),o=this.m_vertex1,u=this.m_vertex2,h=we.SubVV(u,o,r.RayCast_s_e),l=e.normal.Set(h.y,-h.x).SelfNormalize(),c=we.DotVV(l,we.SubVV(o,n,we.s_t0)),_=we.DotVV(l,a);if(0===_)return!1;var f=c/_;if(f<0||t.maxFraction<f)return!1;var d=we.AddVMulSV(n,f,a,r.RayCast_s_q),m=we.SubVV(u,o,r.RayCast_s_r),p=we.DotVV(m,m);if(0===p)return!1;var v=we.DotVV(we.SubVV(d,o,we.s_t0),m)/p;return!(v<0||1<v||(e.fraction=f,Me.MulRV(i.q,e.normal,e.normal),c>0&&e.normal.SelfNeg(),0))}},{key:"ComputeAABB",value:function(e,t){var i=Oe.MulXV(t,this.m_vertex1,r.ComputeAABB_s_v1),n=Oe.MulXV(t,this.m_vertex2,r.ComputeAABB_s_v2);we.MinV(i,n,e.lowerBound),we.MaxV(i,n,e.upperBound);var s=this.m_radius;e.lowerBound.SelfSubXY(s,s),e.upperBound.SelfAddXY(s,s)}},{key:"ComputeMass",value:function(e){e.mass=0,we.MidVV(this.m_vertex1,this.m_vertex2,e.center),e.I=0}},{key:"SetupDistanceProxy",value:function(e){e.m_vertices=e.m_buffer,e.m_vertices[0].Copy(this.m_vertex1),e.m_vertices[1].Copy(this.m_vertex2),e.m_count=2,e.m_radius=this.m_radius}},{key:"ComputeSubmergedArea",value:function(e,t,i,n){return n.SetZero(),0}},{key:"Dump",value:function(e){e("    const shape: b2EdgeShape = new b2EdgeShape();\n"),e("    shape.m_radius = %.15f;\n",this.m_radius),e("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),e("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),e("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),e("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),e("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),e("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)}}]),r}(cn);dn.ComputeDistance_s_v1=new we,dn.ComputeDistance_s_v2=new we,dn.ComputeDistance_s_d=new we,dn.ComputeDistance_s_s=new we,dn.RayCast_s_p1=new we,dn.RayCast_s_p2=new we,dn.RayCast_s_d=new we,dn.RayCast_s_e=new we,dn.RayCast_s_q=new we,dn.RayCast_s_r=new we,dn.ComputeAABB_s_v1=new we,dn.ComputeAABB_s_v2=new we;var mn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2ShapeType.e_chainShape,S)).m_vertices=[],t.m_count=0,t.m_prevVertex=new we,t.m_nextVertex=new we,t.m_hasPrevVertex=!1,t.m_hasNextVertex=!1,t}return s(r,[{key:"CreateLoop",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if("number"==typeof t[0][0]){var n=t[0];if(n.length%2!=0)throw new Error;return this._CreateLoop((function(e){return{x:n[2*e],y:n[2*e+1]}}),n.length/2)}var r=t[0],s=t[1]||r.length;return this._CreateLoop((function(e){return r[e]}),s)}},{key:"_CreateLoop",value:function(e,t){if(t<3)return this;this.m_count=t+1,this.m_vertices=we.MakeArray(this.m_count);for(var i=0;i<t;++i)this.m_vertices[i].Copy(e(i));return this.m_vertices[t].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}},{key:"CreateChain",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if("number"==typeof t[0][0]){var n=t[0];if(n.length%2!=0)throw new Error;return this._CreateChain((function(e){return{x:n[2*e],y:n[2*e+1]}}),n.length/2)}var r=t[0],s=t[1]||r.length;return this._CreateChain((function(e){return r[e]}),s)}},{key:"_CreateChain",value:function(e,t){this.m_count=t,this.m_vertices=we.MakeArray(t);for(var i=0;i<t;++i)this.m_vertices[i].Copy(e(i));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this}},{key:"SetPrevVertex",value:function(e){return this.m_prevVertex.Copy(e),this.m_hasPrevVertex=!0,this}},{key:"SetNextVertex",value:function(e){return this.m_nextVertex.Copy(e),this.m_hasNextVertex=!0,this}},{key:"Clone",value:function(){return(new r).Copy(this)}},{key:"Copy",value:function(e){return g(l(r.prototype),"Copy",this).call(this,e),this._CreateChain((function(t){return e.m_vertices[t]}),e.m_count),this.m_prevVertex.Copy(e.m_prevVertex),this.m_nextVertex.Copy(e.m_nextVertex),this.m_hasPrevVertex=e.m_hasPrevVertex,this.m_hasNextVertex=e.m_hasNextVertex,this}},{key:"GetChildCount",value:function(){return this.m_count-1}},{key:"GetChildEdge",value:function(e,t){e.m_radius=this.m_radius,e.m_vertex1.Copy(this.m_vertices[t]),e.m_vertex2.Copy(this.m_vertices[t+1]),t>0?(e.m_vertex0.Copy(this.m_vertices[t-1]),e.m_hasVertex0=!0):(e.m_vertex0.Copy(this.m_prevVertex),e.m_hasVertex0=this.m_hasPrevVertex),t<this.m_count-2?(e.m_vertex3.Copy(this.m_vertices[t+2]),e.m_hasVertex3=!0):(e.m_vertex3.Copy(this.m_nextVertex),e.m_hasVertex3=this.m_hasNextVertex)}},{key:"TestPoint",value:function(){return!1}},{key:"ComputeDistance",value:function(e,t,i,n){var s=r.ComputeDistance_s_edgeShape;return this.GetChildEdge(s,n),s.ComputeDistance(e,t,i,0)}},{key:"RayCast",value:function(e,t,i,n){var s=r.RayCast_s_edgeShape;return s.m_vertex1.Copy(this.m_vertices[n]),s.m_vertex2.Copy(this.m_vertices[(n+1)%this.m_count]),s.RayCast(e,t,i,0)}},{key:"ComputeAABB",value:function(e,t,i){var n=this.m_vertices[i],s=this.m_vertices[(i+1)%this.m_count],a=Oe.MulXV(t,n,r.ComputeAABB_s_v1),o=Oe.MulXV(t,s,r.ComputeAABB_s_v2);we.MinV(a,o,e.lowerBound),we.MaxV(a,o,e.upperBound)}},{key:"ComputeMass",value:function(e){e.mass=0,e.center.SetZero(),e.I=0}},{key:"SetupDistanceProxy",value:function(e,t){e.m_vertices=e.m_buffer,e.m_vertices[0].Copy(this.m_vertices[t]),t+1<this.m_count?e.m_vertices[1].Copy(this.m_vertices[t+1]):e.m_vertices[1].Copy(this.m_vertices[0]),e.m_count=2,e.m_radius=this.m_radius}},{key:"ComputeSubmergedArea",value:function(e,t,i,n){return n.SetZero(),0}},{key:"Dump",value:function(e){e("    const shape: b2ChainShape = new b2ChainShape();\n"),e("    const vs: b2Vec2[] = [];\n");for(var t=0;t<this.m_count;++t)e("    vs[%d] = new bVec2(%.15f, %.15f);\n",t,this.m_vertices[t].x,this.m_vertices[t].y);e("    shape.CreateChain(vs, %d);\n",this.m_count),e("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),e("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),e("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),e("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")}}]),r}(cn);mn.ComputeDistance_s_edgeShape=new dn,mn.RayCast_s_edgeShape=new dn,mn.ComputeAABB_s_v1=new we,mn.ComputeAABB_s_v2=new we;var pn=function(){function e(){n(this,e),this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}return s(e,[{key:"Clone",value:function(){return(new e).Copy(this)}},{key:"Copy",value:function(e){return this.categoryBits=e.categoryBits,this.maskBits=e.maskBits,this.groupIndex=e.groupIndex||0,this}}]),e}();pn.DEFAULT=new pn;var vn=function e(){n(this,e),this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new pn},yn=function(){function e(t,i){n(this,e),this.aabb=new kt,this.childIndex=0,this.fixture=t,this.childIndex=i,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),i),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}return s(e,[{key:"Reset",value:function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)}},{key:"Touch",value:function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)}},{key:"Synchronize",value:function(t,i,n){if(t===i)this.fixture.m_shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,n);else{var r=e.Synchronize_s_aabb1,s=e.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(r,t,this.childIndex),this.fixture.m_shape.ComputeAABB(s,i,this.childIndex),this.aabb.Combine2(r,s),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,n)}}}]),e}();yn.Synchronize_s_aabb1=new kt,yn.Synchronize_s_aabb2=new kt;var gn,Sn=function(){function e(t,r){n(this,e),this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new pn,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=r.shape.Clone(),this.m_userData=i(r.userData,null),this.m_friction=i(r.friction,.2),this.m_restitution=i(r.restitution,0),this.m_filter.Copy(i(r.filter,pn.DEFAULT)),this.m_isSensor=i(r.isSensor,!1),this.m_density=i(r.density,0)}return s(e,[{key:"m_proxyCount",get:function(){return this.m_proxies.length}},{key:"Reset",value:function(){}},{key:"GetType",value:function(){return this.m_shape.GetType()}},{key:"GetShape",value:function(){return this.m_shape}},{key:"SetSensor",value:function(e){e!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=e)}},{key:"IsSensor",value:function(){return this.m_isSensor}},{key:"SetFilterData",value:function(e){this.m_filter.Copy(e),this.Refilter()}},{key:"GetFilterData",value:function(){return this.m_filter}},{key:"Refilter",value:function(){for(var e=this.m_body.GetContactList();e;){var t=e.contact,i=t.GetFixtureA(),n=t.GetFixtureB();i!==this&&n!==this||t.FlagForFiltering(),e=e.next}this.TouchProxies()}},{key:"GetBody",value:function(){return this.m_body}},{key:"GetNext",value:function(){return this.m_next}},{key:"GetUserData",value:function(){return this.m_userData}},{key:"SetUserData",value:function(e){this.m_userData=e}},{key:"TestPoint",value:function(e){return this.m_shape.TestPoint(this.m_body.GetTransform(),e)}},{key:"ComputeDistance",value:function(e,t,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),e,t,i)}},{key:"RayCast",value:function(e,t,i){return this.m_shape.RayCast(e,t,this.m_body.GetTransform(),i)}},{key:"GetMassData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new ln;return this.m_shape.ComputeMass(e,this.m_density),e}},{key:"SetDensity",value:function(e){this.m_density=e}},{key:"GetDensity",value:function(){return this.m_density}},{key:"GetFriction",value:function(){return this.m_friction}},{key:"SetFriction",value:function(e){this.m_friction=e}},{key:"GetRestitution",value:function(){return this.m_restitution}},{key:"SetRestitution",value:function(e){this.m_restitution=e}},{key:"GetAABB",value:function(e){return this.m_proxies[e].aabb}},{key:"Dump",value:function(e,t){e("    const fd: b2FixtureDef = new b2FixtureDef();\n"),e("    fd.friction = %.15f;\n",this.m_friction),e("    fd.restitution = %.15f;\n",this.m_restitution),e("    fd.density = %.15f;\n",this.m_density),e("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),e("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),e("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),e("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(e),e("\n"),e("    fd.shape = shape;\n"),e("\n"),e("    bodies[%d].CreateFixture(fd);\n",t)}},{key:"CreateProxies",value:function(){if(0!==this.m_proxies.length)throw new Error;for(var e=0;e<this.m_shape.GetChildCount();++e)this.m_proxies[e]=new yn(this,e)}},{key:"DestroyProxies",value:function(){for(var e,t=R(this.m_proxies);!(e=t()).done;)e.value.Reset();this.m_proxies.length=0}},{key:"TouchProxies",value:function(){for(var e,t=R(this.m_proxies);!(e=t()).done;)e.value.Touch()}},{key:"SynchronizeProxies",value:function(e,t,i){for(var n,r=R(this.m_proxies);!(n=r()).done;)n.value.Synchronize(e,t,i)}}]),e}();(gn=e.b2BodyType||(e.b2BodyType={}))[gn.b2_unknown=-1]="b2_unknown",gn[gn.b2_staticBody=0]="b2_staticBody",gn[gn.b2_kinematicBody=1]="b2_kinematicBody",gn[gn.b2_dynamicBody=2]="b2_dynamicBody";var An,Tn,En=function t(){n(this,t),this.type=e.b2BodyType.b2_staticBody,this.position=new we(0,0),this.angle=0,this.linearVelocity=new we(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1},bn=function(){function t(r,s){n(this,t),this.m_type=e.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new Oe,this.m_xf0=new Oe,this.m_sweep=new Le,this.m_linearVelocity=new we,this.m_angularVelocity=0,this.m_force=new we,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=i(r.bullet,!1),this.m_fixedRotationFlag=i(r.fixedRotation,!1),this.m_autoSleepFlag=i(r.allowSleep,!0),this.m_awakeFlag=i(r.awake,!0),this.m_activeFlag=i(r.active,!0),this.m_world=s,this.m_xf.p.Copy(i(r.position,we.ZERO)),this.m_xf.q.SetAngle(i(r.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(i(r.linearVelocity,we.ZERO)),this.m_angularVelocity=i(r.angularVelocity,0),this.m_linearDamping=i(r.linearDamping,0),this.m_angularDamping=i(r.angularDamping,0),this.m_gravityScale=i(r.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=i(r.type,e.b2BodyType.b2_staticBody),r.type===e.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=r.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}return s(t,[{key:"CreateFixture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e instanceof cn?this.CreateFixtureShapeDensity(e,t):this.CreateFixtureDef(e)}},{key:"CreateFixtureDef",value:function(e){if(this.m_world.IsLocked())throw new Error;var t=new Sn(this,e);return this.m_activeFlag&&t.CreateProxies(),t.m_next=this.m_fixtureList,this.m_fixtureList=t,++this.m_fixtureCount,t.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,t}},{key:"CreateFixtureShapeDensity",value:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=t.CreateFixtureShapeDensity_s_def;return n.shape=e,n.density=i,this.CreateFixtureDef(n)}},{key:"DestroyFixture",value:function(e){if(this.m_world.IsLocked())throw new Error;for(var t=this.m_fixtureList,i=null;null!==t;){if(t===e){i?i.m_next=e.m_next:this.m_fixtureList=e.m_next;break}i=t,t=t.m_next}for(var n=this.m_contactList;n;){var r=n.contact;n=n.next;var s=r.GetFixtureA(),a=r.GetFixtureB();e!==s&&e!==a||this.m_world.m_contactManager.Destroy(r)}this.m_activeFlag&&e.DestroyProxies(),e.m_next=null,e.Reset(),--this.m_fixtureCount,this.ResetMassData()}},{key:"SetTransformVec",value:function(e,t){this.SetTransformXY(e.x,e.y,t)}},{key:"SetTransformXY",value:function(e,t,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(e,t),this.m_xf0.Copy(this.m_xf),Oe.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(var n=this.m_fixtureList;n;n=n.m_next)n.SynchronizeProxies(this.m_xf,this.m_xf,we.ZERO);this.m_world.m_contactManager.FindNewContacts()}},{key:"SetTransform",value:function(e){this.SetTransformVec(e.p,e.GetAngle())}},{key:"GetTransform",value:function(){return this.m_xf}},{key:"GetPosition",value:function(){return this.m_xf.p}},{key:"SetPosition",value:function(e){this.SetTransformVec(e,this.GetAngle())}},{key:"SetPositionXY",value:function(e,t){this.SetTransformXY(e,t,this.GetAngle())}},{key:"GetAngle",value:function(){return this.m_sweep.a}},{key:"SetAngle",value:function(e){this.SetTransformVec(this.GetPosition(),e)}},{key:"GetWorldCenter",value:function(){return this.m_sweep.c}},{key:"GetLocalCenter",value:function(){return this.m_sweep.localCenter}},{key:"SetLinearVelocity",value:function(t){this.m_type!==e.b2BodyType.b2_staticBody&&(we.DotVV(t,t)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(t))}},{key:"GetLinearVelocity",value:function(){return this.m_linearVelocity}},{key:"SetAngularVelocity",value:function(t){this.m_type!==e.b2BodyType.b2_staticBody&&(t*t>0&&this.SetAwake(!0),this.m_angularVelocity=t)}},{key:"GetAngularVelocity",value:function(){return this.m_angularVelocity}},{key:"GetDefinition",value:function(e){return e.type=this.GetType(),e.allowSleep=this.m_autoSleepFlag,e.angle=this.GetAngle(),e.angularDamping=this.m_angularDamping,e.gravityScale=this.m_gravityScale,e.angularVelocity=this.m_angularVelocity,e.fixedRotation=this.m_fixedRotationFlag,e.bullet=this.m_bulletFlag,e.awake=this.m_awakeFlag,e.linearDamping=this.m_linearDamping,e.linearVelocity.Copy(this.GetLinearVelocity()),e.position.Copy(this.GetPosition()),e.userData=this.GetUserData(),e}},{key:"ApplyForce",value:function(t,i){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.m_type===e.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(i.x-this.m_sweep.c.x)*t.y-(i.y-this.m_sweep.c.y)*t.x))}},{key:"ApplyForceToCenter",value:function(t){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.m_type===e.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y))}},{key:"ApplyTorque",value:function(t){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.m_type===e.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))}},{key:"ApplyLinearImpulse",value:function(t,i){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.m_type===e.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((i.x-this.m_sweep.c.x)*t.y-(i.y-this.m_sweep.c.y)*t.x)))}},{key:"ApplyLinearImpulseToCenter",value:function(t){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.m_type===e.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y))}},{key:"ApplyAngularImpulse",value:function(t){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.m_type===e.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))}},{key:"GetMass",value:function(){return this.m_mass}},{key:"GetInertia",value:function(){return this.m_I+this.m_mass*we.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)}},{key:"GetMassData",value:function(e){return e.mass=this.m_mass,e.I=this.m_I+this.m_mass*we.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),e.center.Copy(this.m_sweep.localCenter),e}},{key:"SetMassData",value:function(i){if(this.m_world.IsLocked())throw new Error;if(this.m_type===e.b2BodyType.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=i.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,i.I>0&&!this.m_fixedRotationFlag&&(this.m_I=i.I-this.m_mass*we.DotVV(i.center,i.center),this.m_invI=1/this.m_I);var n=t.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(i.center),Oe.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),we.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,we.SubVV(this.m_sweep.c,n,we.s_t0),this.m_linearVelocity)}}},{key:"ResetMassData",value:function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===e.b2BodyType.b2_staticBody||this.m_type===e.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);for(var i=t.ResetMassData_s_localCenter.SetZero(),n=this.m_fixtureList;n;n=n.m_next)if(0!==n.m_density){var r=n.GetMassData(t.ResetMassData_s_massData);this.m_mass+=r.mass,i.x+=r.center.x*r.mass,i.y+=r.center.y*r.mass,this.m_I+=r.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,i.x*=this.m_invMass,i.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*we.DotVV(i,i),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var s=t.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(i),Oe.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),we.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,we.SubVV(this.m_sweep.c,s,we.s_t0),this.m_linearVelocity)}},{key:"GetWorldPoint",value:function(e,t){return Oe.MulXV(this.m_xf,e,t)}},{key:"GetWorldVector",value:function(e,t){return Me.MulRV(this.m_xf.q,e,t)}},{key:"GetLocalPoint",value:function(e,t){return Oe.MulTXV(this.m_xf,e,t)}},{key:"GetLocalVector",value:function(e,t){return Me.MulTRV(this.m_xf.q,e,t)}},{key:"GetLinearVelocityFromWorldPoint",value:function(e,t){return we.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,we.SubVV(e,this.m_sweep.c,we.s_t0),t)}},{key:"GetLinearVelocityFromLocalPoint",value:function(e,t){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(e,t),t)}},{key:"GetLinearDamping",value:function(){return this.m_linearDamping}},{key:"SetLinearDamping",value:function(e){this.m_linearDamping=e}},{key:"GetAngularDamping",value:function(){return this.m_angularDamping}},{key:"SetAngularDamping",value:function(e){this.m_angularDamping=e}},{key:"GetGravityScale",value:function(){return this.m_gravityScale}},{key:"SetGravityScale",value:function(e){this.m_gravityScale=e}},{key:"SetType",value:function(t){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==t){this.m_type=t,this.ResetMassData(),this.m_type===e.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var i=this.m_contactList;i;){var n=i;i=i.next,this.m_world.m_contactManager.Destroy(n.contact)}this.m_contactList=null;for(var r=this.m_fixtureList;r;r=r.m_next)r.TouchProxies()}}},{key:"GetType",value:function(){return this.m_type}},{key:"SetBullet",value:function(e){this.m_bulletFlag=e}},{key:"IsBullet",value:function(){return this.m_bulletFlag}},{key:"SetSleepingAllowed",value:function(e){this.m_autoSleepFlag=e,e||this.SetAwake(!0)}},{key:"IsSleepingAllowed",value:function(){return this.m_autoSleepFlag}},{key:"SetAwake",value:function(e){e?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)}},{key:"IsAwake",value:function(){return this.m_awakeFlag}},{key:"SetActive",value:function(e){if(this.m_world.IsLocked())throw new Error;if(e!==this.IsActive())if(this.m_activeFlag=e,e)for(var t=this.m_fixtureList;t;t=t.m_next)t.CreateProxies();else{for(var i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxies();for(var n=this.m_contactList;n;){var r=n;n=n.next,this.m_world.m_contactManager.Destroy(r.contact)}this.m_contactList=null}}},{key:"IsActive",value:function(){return this.m_activeFlag}},{key:"SetFixedRotation",value:function(e){this.m_fixedRotationFlag!==e&&(this.m_fixedRotationFlag=e,this.m_angularVelocity=0,this.ResetMassData())}},{key:"IsFixedRotation",value:function(){return this.m_fixedRotationFlag}},{key:"GetFixtureList",value:function(){return this.m_fixtureList}},{key:"GetJointList",value:function(){return this.m_jointList}},{key:"GetContactList",value:function(){return this.m_contactList}},{key:"GetNext",value:function(){return this.m_next}},{key:"GetUserData",value:function(){return this.m_userData}},{key:"SetUserData",value:function(e){this.m_userData=e}},{key:"GetWorld",value:function(){return this.m_world}},{key:"Dump",value:function(t){var i=this.m_islandIndex;t("{\n"),t("  const bd: b2BodyDef = new b2BodyDef();\n");var n="";switch(this.m_type){case e.b2BodyType.b2_staticBody:n="b2BodyType.b2_staticBody";break;case e.b2BodyType.b2_kinematicBody:n="b2BodyType.b2_kinematicBody";break;case e.b2BodyType.b2_dynamicBody:n="b2BodyType.b2_dynamicBody"}t("  bd.type = %s;\n",n),t("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),t("  bd.angle = %.15f;\n",this.m_sweep.a),t("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),t("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),t("  bd.linearDamping = %.15f;\n",this.m_linearDamping),t("  bd.angularDamping = %.15f;\n",this.m_angularDamping),t("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),t("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),t("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),t("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),t("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),t("  bd.gravityScale = %.15f;\n",this.m_gravityScale),t("\n"),t("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),t("\n");for(var r=this.m_fixtureList;r;r=r.m_next)t("  {\n"),r.Dump(t,i),t("  }\n");t("}\n")}},{key:"SynchronizeFixtures",value:function(){var e=t.SynchronizeFixtures_s_xf1;e.q.SetAngle(this.m_sweep.a0),Me.MulRV(e.q,this.m_sweep.localCenter,e.p),we.SubVV(this.m_sweep.c0,e.p,e.p);for(var i=we.SubVV(this.m_sweep.c,this.m_sweep.c0,t.SynchronizeFixtures_s_displacement),n=this.m_fixtureList;n;n=n.m_next)n.SynchronizeProxies(e,this.m_xf,i)}},{key:"SynchronizeTransform",value:function(){this.m_xf.q.SetAngle(this.m_sweep.a),Me.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),we.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}},{key:"ShouldCollide",value:function(t){return(this.m_type!==e.b2BodyType.b2_staticBody||t.m_type!==e.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(t)}},{key:"ShouldCollideConnected",value:function(e){for(var t=this.m_jointList;t;t=t.next)if(t.other===e&&!t.joint.m_collideConnected)return!1;return!0}},{key:"Advance",value:function(e){this.m_sweep.Advance(e),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),Me.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),we.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}},{key:"GetControllerList",value:function(){return this.m_controllerList}},{key:"GetControllerCount",value:function(){return this.m_controllerCount}}]),t}();bn.CreateFixtureShapeDensity_s_def=new vn,bn.SetMassData_s_oldCenter=new we,bn.ResetMassData_s_localCenter=new we,bn.ResetMassData_s_oldCenter=new we,bn.ResetMassData_s_massData=new ln,bn.SynchronizeFixtures_s_xf1=new Oe,bn.SynchronizeFixtures_s_displacement=new we,(Tn=e.b2JointType||(e.b2JointType={}))[Tn.e_unknownJoint=0]="e_unknownJoint",Tn[Tn.e_revoluteJoint=1]="e_revoluteJoint",Tn[Tn.e_prismaticJoint=2]="e_prismaticJoint",Tn[Tn.e_distanceJoint=3]="e_distanceJoint",Tn[Tn.e_pulleyJoint=4]="e_pulleyJoint",Tn[Tn.e_mouseJoint=5]="e_mouseJoint",Tn[Tn.e_gearJoint=6]="e_gearJoint",Tn[Tn.e_wheelJoint=7]="e_wheelJoint",Tn[Tn.e_weldJoint=8]="e_weldJoint",Tn[Tn.e_frictionJoint=9]="e_frictionJoint",Tn[Tn.e_ropeJoint=10]="e_ropeJoint",Tn[Tn.e_motorJoint=11]="e_motorJoint",Tn[Tn.e_areaJoint=12]="e_areaJoint",(An=e.b2LimitState||(e.b2LimitState={}))[An.e_inactiveLimit=0]="e_inactiveLimit",An[An.e_atLowerLimit=1]="e_atLowerLimit",An[An.e_atUpperLimit=2]="e_atUpperLimit",An[An.e_equalLimits=3]="e_equalLimits";var Cn=function(){function e(){n(this,e),this.linear=new we,this.angularA=0,this.angularB=0}return s(e,[{key:"SetZero",value:function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this}},{key:"Set",value:function(e,t,i){return this.linear.Copy(e),this.angularA=t,this.angularB=i,this}}]),e}(),Rn=function(){function e(t){n(this,e),this._other=null,this.prev=null,this.next=null,this.joint=t}return s(e,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(e){if(null!==this._other)throw new Error;this._other=e}},{key:"Reset",value:function(){this._other=null,this.prev=null,this.next=null}}]),e}(),xn=function t(i){n(this,t),this.type=e.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=i},wn=function(){function t(r){n(this,t),this.m_type=e.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new Rn(this),this.m_edgeB=new Rn(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=r.type,this.m_edgeA.other=r.bodyB,this.m_edgeB.other=r.bodyA,this.m_bodyA=r.bodyA,this.m_bodyB=r.bodyB,this.m_collideConnected=i(r.collideConnected,!1),this.m_userData=i(r.userData,null)}return s(t,[{key:"GetType",value:function(){return this.m_type}},{key:"GetBodyA",value:function(){return this.m_bodyA}},{key:"GetBodyB",value:function(){return this.m_bodyB}},{key:"GetNext",value:function(){return this.m_next}},{key:"GetUserData",value:function(){return this.m_userData}},{key:"SetUserData",value:function(e){this.m_userData=e}},{key:"IsActive",value:function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()}},{key:"GetCollideConnected",value:function(){return this.m_collideConnected}},{key:"Dump",value:function(e){e("// Dump is not supported for this joint type.\n")}},{key:"ShiftOrigin",value:function(){}}]),t}(),kn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_distanceJoint)).localAnchorA=new we,t.localAnchorB=new we,t.length=1,t.frequencyHz=0,t.dampingRatio=0,t}return s(r,[{key:"Initialize",value:function(e,t,i,n){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.length=we.DistanceVV(i,n),this.frequencyHz=0,this.dampingRatio=0}}]),r}(xn),In=function(e){h(r,e);var t=v(r);function r(e){var s;return n(this,r),(s=t.call(this,e)).m_frequencyHz=0,s.m_dampingRatio=0,s.m_bias=0,s.m_localAnchorA=new we,s.m_localAnchorB=new we,s.m_gamma=0,s.m_impulse=0,s.m_length=0,s.m_indexA=0,s.m_indexB=0,s.m_u=new we,s.m_rA=new we,s.m_rB=new we,s.m_localCenterA=new we,s.m_localCenterB=new we,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_mass=0,s.m_qA=new Me,s.m_qB=new Me,s.m_lalcA=new we,s.m_lalcB=new we,s.m_frequencyHz=i(e.frequencyHz,0),s.m_dampingRatio=i(e.dampingRatio,0),s.m_localAnchorA.Copy(e.localAnchorA),s.m_localAnchorB.Copy(e.localAnchorB),s.m_length=e.length,s}return s(r,[{key:"GetAnchorA",value:function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return t.x=e*this.m_impulse*this.m_u.x,t.y=e*this.m_impulse*this.m_u.y,t}},{key:"GetReactionTorque",value:function(){return 0}},{key:"GetLocalAnchorA",value:function(){return this.m_localAnchorA}},{key:"GetLocalAnchorB",value:function(){return this.m_localAnchorB}},{key:"SetLength",value:function(e){this.m_length=e}},{key:"Length",value:function(){return this.m_length}},{key:"SetFrequency",value:function(e){this.m_frequencyHz=e}},{key:"GetFrequency",value:function(){return this.m_frequencyHz}},{key:"SetDampingRatio",value:function(e){this.m_dampingRatio=e}},{key:"GetDampingRatio",value:function(){return this.m_dampingRatio}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;e("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.length = %.15f;\n",this.m_length),e("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),e("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}},{key:"InitVelocityConstraints",value:function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var t=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v,s=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].c,o=e.positions[this.m_indexB].a,h=e.velocities[this.m_indexB].v,l=e.velocities[this.m_indexB].w,c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(o);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Me.MulRV(c,this.m_lalcA,this.m_rA),we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Me.MulRV(_,this.m_lalcB,this.m_rB),this.m_u.x=a.x+this.m_rB.x-t.x-this.m_rA.x,this.m_u.y=a.y+this.m_rB.y-t.y-this.m_rA.y;var f=this.m_u.Length();f>p?this.m_u.SelfMul(1/f):this.m_u.SetZero();var d=we.CrossVV(this.m_rA,this.m_u),m=we.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,this.m_frequencyHz>0){var y=f-this.m_length,g=2*u*this.m_frequencyHz,S=2*this.m_mass*this.m_dampingRatio*g,A=this.m_mass*g*g,T=e.step.dt;this.m_gamma=T*(S+T*A),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=y*T*A*this.m_gamma,v+=this.m_gamma,this.m_mass=0!==v?1/v:0}else this.m_gamma=0,this.m_bias=0;if(e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var E=we.MulSV(this.m_impulse,this.m_u,r.InitVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,E),s-=this.m_invIA*we.CrossVV(this.m_rA,E),h.SelfMulAdd(this.m_invMassB,E),l+=this.m_invIB*we.CrossVV(this.m_rB,E)}else this.m_impulse=0;e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=l}},{key:"SolveVelocityConstraints",value:function(e){var t=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,n=e.velocities[this.m_indexB].v,s=e.velocities[this.m_indexB].w,a=we.AddVCrossSV(t,i,this.m_rA,r.SolveVelocityConstraints_s_vpA),o=we.AddVCrossSV(n,s,this.m_rB,r.SolveVelocityConstraints_s_vpB),u=we.DotVV(this.m_u,we.SubVV(o,a,we.s_t0)),h=-this.m_mass*(u+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=h;var l=we.MulSV(h,this.m_u,r.SolveVelocityConstraints_s_P);t.SelfMulSub(this.m_invMassA,l),i-=this.m_invIA*we.CrossVV(this.m_rA,l),n.SelfMulAdd(this.m_invMassB,l),s+=this.m_invIB*we.CrossVV(this.m_rB,l),e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=s}},{key:"SolvePositionConstraints",value:function(e){if(this.m_frequencyHz>0)return!0;var t=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,n=e.positions[this.m_indexB].c,s=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),u=Me.MulRV(a,this.m_lalcA,this.m_rA),h=Me.MulRV(o,this.m_lalcB,this.m_rB),l=this.m_u;l.x=n.x+h.x-t.x-u.x,l.y=n.y+h.y-t.y-u.y;var c=this.m_u.Normalize()-this.m_length;c=le(c,-b,b);var _=-this.m_mass*c,f=we.MulSV(_,l,r.SolvePositionConstraints_s_P);return t.SelfMulSub(this.m_invMassA,f),i-=this.m_invIA*we.CrossVV(u,f),n.SelfMulAdd(this.m_invMassB,f),s+=this.m_invIB*we.CrossVV(h,f),e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=s,oe(c)<p}}]),r}(wn);In.InitVelocityConstraints_s_P=new we,In.SolveVelocityConstraints_s_vpA=new we,In.SolveVelocityConstraints_s_vpB=new we,In.SolveVelocityConstraints_s_P=new we,In.SolvePositionConstraints_s_P=new we;var Bn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_areaJoint)).bodies=[],t.frequencyHz=0,t.dampingRatio=0,t}return s(r,[{key:"AddBody",value:function(e){this.bodies.push(e),1===this.bodies.length?this.bodyA=e:2===this.bodies.length&&(this.bodyB=e)}}]),r}(xn),Pn=function(e){h(r,e);var t=v(r);function r(e){var s;n(this,r),(s=t.call(this,e)).m_frequencyHz=0,s.m_dampingRatio=0,s.m_impulse=0,s.m_targetArea=0,s.m_delta=new we,s.m_bodies=e.bodies,s.m_frequencyHz=i(e.frequencyHz,0),s.m_dampingRatio=i(e.dampingRatio,0),s.m_targetLengths=ne(e.bodies.length),s.m_normals=we.MakeArray(e.bodies.length),s.m_joints=[],s.m_deltas=we.MakeArray(e.bodies.length);var a=new kn;a.frequencyHz=s.m_frequencyHz,a.dampingRatio=s.m_dampingRatio,s.m_targetArea=0;for(var o=0;o<s.m_bodies.length;++o){var u=s.m_bodies[o],h=s.m_bodies[(o+1)%s.m_bodies.length],l=u.GetWorldCenter(),c=h.GetWorldCenter();s.m_targetLengths[o]=we.DistanceVV(l,c),s.m_targetArea+=we.CrossVV(l,c),a.Initialize(u,h,l,c),s.m_joints[o]=u.GetWorld().CreateJoint(a)}return s.m_targetArea*=.5,s}return s(r,[{key:"GetAnchorA",value:function(e){return e}},{key:"GetAnchorB",value:function(e){return e}},{key:"GetReactionForce",value:function(e,t){return t}},{key:"GetReactionTorque",value:function(){return 0}},{key:"SetFrequency",value:function(e){this.m_frequencyHz=e;for(var t=0;t<this.m_joints.length;++t)this.m_joints[t].SetFrequency(e)}},{key:"GetFrequency",value:function(){return this.m_frequencyHz}},{key:"SetDampingRatio",value:function(e){this.m_dampingRatio=e;for(var t=0;t<this.m_joints.length;++t)this.m_joints[t].SetDampingRatio(e)}},{key:"GetDampingRatio",value:function(){return this.m_dampingRatio}},{key:"Dump",value:function(e){e("Area joint dumping is not supported.\n")}},{key:"InitVelocityConstraints",value:function(e){for(var t=0;t<this.m_bodies.length;++t){var i=this.m_bodies[(t+this.m_bodies.length-1)%this.m_bodies.length],n=this.m_bodies[(t+1)%this.m_bodies.length],r=e.positions[i.m_islandIndex].c,s=e.positions[n.m_islandIndex].c,a=this.m_deltas[t];we.SubVV(s,r,a)}if(e.step.warmStarting){this.m_impulse*=e.step.dtRatio;for(var o=0;o<this.m_bodies.length;++o){var u=this.m_bodies[o],h=e.velocities[u.m_islandIndex].v,l=this.m_deltas[o];h.x+=u.m_invMass*l.y*.5*this.m_impulse,h.y+=u.m_invMass*-l.x*.5*this.m_impulse}}else this.m_impulse=0}},{key:"SolveVelocityConstraints",value:function(e){for(var t=0,i=0,n=0;n<this.m_bodies.length;++n){var r=this.m_bodies[n],s=e.velocities[r.m_islandIndex].v,a=this.m_deltas[n];t+=a.LengthSquared()/r.GetMass(),i+=we.CrossVV(s,a)}var o=-2*i/t;this.m_impulse+=o;for(var u=0;u<this.m_bodies.length;++u){var h=this.m_bodies[u],l=e.velocities[h.m_islandIndex].v,c=this.m_deltas[u];l.x+=h.m_invMass*c.y*.5*o,l.y+=h.m_invMass*-c.x*.5*o}}},{key:"SolvePositionConstraints",value:function(e){for(var t=0,i=0,n=0;n<this.m_bodies.length;++n){var r=this.m_bodies[n],s=this.m_bodies[(n+1)%this.m_bodies.length],o=e.positions[r.m_islandIndex].c,u=e.positions[s.m_islandIndex].c,h=we.SubVV(u,o,this.m_delta),l=h.Length();l<a&&(l=1),this.m_normals[n].x=h.y/l,this.m_normals[n].y=-h.x/l,t+=l,i+=we.CrossVV(o,u)}i*=.5;for(var c=.5*(this.m_targetArea-i)/t,_=!0,f=0;f<this.m_bodies.length;++f){var d=this.m_bodies[f],m=e.positions[d.m_islandIndex].c,v=(f+1)%this.m_bodies.length,y=we.AddVV(this.m_normals[f],this.m_normals[v],this.m_delta);y.SelfMul(c);var g=y.LengthSquared();g>fe(b)&&y.SelfMul(b/me(g)),g>fe(p)&&(_=!1),m.x+=y.x,m.y+=y.y}return _}}]),r}(wn),Mn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_frictionJoint)).localAnchorA=new we,t.localAnchorB=new we,t.maxForce=0,t.maxTorque=0,t}return s(r,[{key:"Initialize",value:function(e,t,i){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)}}]),r}(xn),On=function(e){h(r,e);var t=v(r);function r(e){var s;return n(this,r),(s=t.call(this,e)).m_localAnchorA=new we,s.m_localAnchorB=new we,s.m_linearImpulse=new we,s.m_angularImpulse=0,s.m_maxForce=0,s.m_maxTorque=0,s.m_indexA=0,s.m_indexB=0,s.m_rA=new we,s.m_rB=new we,s.m_localCenterA=new we,s.m_localCenterB=new we,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_linearMass=new Be,s.m_angularMass=0,s.m_qA=new Me,s.m_qB=new Me,s.m_lalcA=new we,s.m_lalcB=new we,s.m_K=new Be,s.m_localAnchorA.Copy(e.localAnchorA),s.m_localAnchorB.Copy(e.localAnchorB),s.m_linearImpulse.SetZero(),s.m_maxForce=i(e.maxForce,0),s.m_maxTorque=i(e.maxTorque,0),s.m_linearMass.SetZero(),s}return s(r,[{key:"InitVelocityConstraints",value:function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var t=e.positions[this.m_indexA].a,i=e.velocities[this.m_indexA].v,n=e.velocities[this.m_indexA].w,r=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,o=this.m_qA.SetAngle(t),u=this.m_qB.SetAngle(r);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var h=Me.MulRV(o,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=Me.MulRV(u,this.m_lalcB,this.m_rB),c=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,m=this.m_K;if(m.ex.x=c+_+f*h.y*h.y+d*l.y*l.y,m.ex.y=-f*h.x*h.y-d*l.x*l.y,m.ey.x=m.ex.y,m.ey.y=c+_+f*h.x*h.x+d*l.x*l.x,m.GetInverse(this.m_linearMass),this.m_angularMass=f+d,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),e.step.warmStarting){this.m_linearImpulse.SelfMul(e.step.dtRatio),this.m_angularImpulse*=e.step.dtRatio;var p=this.m_linearImpulse;i.SelfMulSub(c,p),n-=f*(we.CrossVV(this.m_rA,p)+this.m_angularImpulse),s.SelfMulAdd(_,p),a+=d*(we.CrossVV(this.m_rB,p)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=a}},{key:"SolveVelocityConstraints",value:function(e){var t=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,n=e.velocities[this.m_indexB].v,s=e.velocities[this.m_indexB].w,a=this.m_invMassA,o=this.m_invMassB,u=this.m_invIA,h=this.m_invIB,l=e.step.dt,c=s-i,_=-this.m_angularMass*c,f=this.m_angularImpulse,d=l*this.m_maxTorque;this.m_angularImpulse=le(this.m_angularImpulse+_,-d,d),i-=u*(_=this.m_angularImpulse-f),s+=h*_;var m=we.SubVV(we.AddVCrossSV(n,s,this.m_rB,we.s_t0),we.AddVCrossSV(t,i,this.m_rA,we.s_t1),r.SolveVelocityConstraints_s_Cdot_v2),p=Be.MulMV(this.m_linearMass,m,r.SolveVelocityConstraints_s_impulseV).SelfNeg(),v=r.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(p);var y=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>y*y&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(y)),we.SubVV(this.m_linearImpulse,v,p),t.SelfMulSub(a,p),i-=u*we.CrossVV(this.m_rA,p),n.SelfMulAdd(o,p),s+=h*we.CrossVV(this.m_rB,p),e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=s}},{key:"SolvePositionConstraints",value:function(){return!0}},{key:"GetAnchorA",value:function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return t.x=e*this.m_linearImpulse.x,t.y=e*this.m_linearImpulse.y,t}},{key:"GetReactionTorque",value:function(e){return e*this.m_angularImpulse}},{key:"GetLocalAnchorA",value:function(){return this.m_localAnchorA}},{key:"GetLocalAnchorB",value:function(){return this.m_localAnchorB}},{key:"SetMaxForce",value:function(e){this.m_maxForce=e}},{key:"GetMaxForce",value:function(){return this.m_maxForce}},{key:"SetMaxTorque",value:function(e){this.m_maxTorque=e}},{key:"GetMaxTorque",value:function(){return this.m_maxTorque}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;e("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.maxForce = %.15f;\n",this.m_maxForce),e("  jd.maxTorque = %.15f;\n",this.m_maxTorque),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}]),r}(wn);On.SolveVelocityConstraints_s_Cdot_v2=new we,On.SolveVelocityConstraints_s_impulseV=new we,On.SolveVelocityConstraints_s_oldImpulseV=new we;var Dn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_gearJoint)).ratio=1,t}return r}(xn),Ln=function(t){h(a,t);var r=v(a);function a(t){var s,o,u;n(this,a),(s=r.call(this,t)).m_typeA=e.b2JointType.e_unknownJoint,s.m_typeB=e.b2JointType.e_unknownJoint,s.m_localAnchorA=new we,s.m_localAnchorB=new we,s.m_localAnchorC=new we,s.m_localAnchorD=new we,s.m_localAxisC=new we,s.m_localAxisD=new we,s.m_referenceAngleA=0,s.m_referenceAngleB=0,s.m_constant=0,s.m_ratio=0,s.m_impulse=0,s.m_indexA=0,s.m_indexB=0,s.m_indexC=0,s.m_indexD=0,s.m_lcA=new we,s.m_lcB=new we,s.m_lcC=new we,s.m_lcD=new we,s.m_mA=0,s.m_mB=0,s.m_mC=0,s.m_mD=0,s.m_iA=0,s.m_iB=0,s.m_iC=0,s.m_iD=0,s.m_JvAC=new we,s.m_JvBD=new we,s.m_JwA=0,s.m_JwB=0,s.m_JwC=0,s.m_JwD=0,s.m_mass=0,s.m_qA=new Me,s.m_qB=new Me,s.m_qC=new Me,s.m_qD=new Me,s.m_lalcA=new we,s.m_lalcB=new we,s.m_lalcC=new we,s.m_lalcD=new we,s.m_joint1=t.joint1,s.m_joint2=t.joint2,s.m_typeA=s.m_joint1.GetType(),s.m_typeB=s.m_joint2.GetType(),s.m_bodyC=s.m_joint1.GetBodyA(),s.m_bodyA=s.m_joint1.GetBodyB();var h=s.m_bodyA.m_xf,l=s.m_bodyA.m_sweep.a,c=s.m_bodyC.m_xf,_=s.m_bodyC.m_sweep.a;if(s.m_typeA===e.b2JointType.e_revoluteJoint){var f=t.joint1;s.m_localAnchorC.Copy(f.m_localAnchorA),s.m_localAnchorA.Copy(f.m_localAnchorB),s.m_referenceAngleA=f.m_referenceAngle,s.m_localAxisC.SetZero(),o=l-_-s.m_referenceAngleA}else{var d=t.joint1;s.m_localAnchorC.Copy(d.m_localAnchorA),s.m_localAnchorA.Copy(d.m_localAnchorB),s.m_referenceAngleA=d.m_referenceAngle,s.m_localAxisC.Copy(d.m_localXAxisA);var m=s.m_localAnchorC,p=Me.MulTRV(c.q,we.AddVV(Me.MulRV(h.q,s.m_localAnchorA,we.s_t0),we.SubVV(h.p,c.p,we.s_t1),we.s_t0),we.s_t0);o=we.DotVV(we.SubVV(p,m,we.s_t0),s.m_localAxisC)}s.m_bodyD=s.m_joint2.GetBodyA(),s.m_bodyB=s.m_joint2.GetBodyB();var v=s.m_bodyB.m_xf,y=s.m_bodyB.m_sweep.a,g=s.m_bodyD.m_xf,S=s.m_bodyD.m_sweep.a;if(s.m_typeB===e.b2JointType.e_revoluteJoint){var A=t.joint2;s.m_localAnchorD.Copy(A.m_localAnchorA),s.m_localAnchorB.Copy(A.m_localAnchorB),s.m_referenceAngleB=A.m_referenceAngle,s.m_localAxisD.SetZero(),u=y-S-s.m_referenceAngleB}else{var T=t.joint2;s.m_localAnchorD.Copy(T.m_localAnchorA),s.m_localAnchorB.Copy(T.m_localAnchorB),s.m_referenceAngleB=T.m_referenceAngle,s.m_localAxisD.Copy(T.m_localXAxisA);var E=s.m_localAnchorD,b=Me.MulTRV(g.q,we.AddVV(Me.MulRV(v.q,s.m_localAnchorB,we.s_t0),we.SubVV(v.p,g.p,we.s_t1),we.s_t0),we.s_t0);u=we.DotVV(we.SubVV(b,E,we.s_t0),s.m_localAxisD)}return s.m_ratio=i(t.ratio,1),s.m_constant=o+s.m_ratio*u,s.m_impulse=0,s}return s(a,[{key:"InitVelocityConstraints",value:function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v,u=t.velocities[this.m_indexB].w,h=t.positions[this.m_indexC].a,l=t.velocities[this.m_indexC].v,c=t.velocities[this.m_indexC].w,_=t.positions[this.m_indexD].a,f=t.velocities[this.m_indexD].v,d=t.velocities[this.m_indexD].w,m=this.m_qA.SetAngle(i),p=this.m_qB.SetAngle(s),v=this.m_qC.SetAngle(h),y=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===e.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var g=Me.MulRV(v,this.m_localAxisC,a.InitVelocityConstraints_s_u);we.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);var S=Me.MulRV(v,this.m_lalcC,a.InitVelocityConstraints_s_rC);we.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);var A=Me.MulRV(m,this.m_lalcA,a.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(g),this.m_JwC=we.CrossVV(S,g),this.m_JwA=we.CrossVV(A,g),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===e.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var T=Me.MulRV(y,this.m_localAxisD,a.InitVelocityConstraints_s_u);we.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);var E=Me.MulRV(y,this.m_lalcD,a.InitVelocityConstraints_s_rD);we.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);var b=Me.MulRV(p,this.m_lalcB,a.InitVelocityConstraints_s_rB);we.MulSV(this.m_ratio,T,this.m_JvBD),this.m_JwD=this.m_ratio*we.CrossVV(E,T),this.m_JwB=this.m_ratio*we.CrossVV(b,T),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,t.step.warmStarting?(n.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),r+=this.m_iA*this.m_impulse*this.m_JwA,o.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),u+=this.m_iB*this.m_impulse*this.m_JwB,l.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),c-=this.m_iC*this.m_impulse*this.m_JwC,f.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),d-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=u,t.velocities[this.m_indexC].w=c,t.velocities[this.m_indexD].w=d}},{key:"SolveVelocityConstraints",value:function(e){var t=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,n=e.velocities[this.m_indexB].v,r=e.velocities[this.m_indexB].w,s=e.velocities[this.m_indexC].v,a=e.velocities[this.m_indexC].w,o=e.velocities[this.m_indexD].v,u=e.velocities[this.m_indexD].w,h=we.DotVV(this.m_JvAC,we.SubVV(t,s,we.s_t0))+we.DotVV(this.m_JvBD,we.SubVV(n,o,we.s_t0));h+=this.m_JwA*i-this.m_JwC*a+(this.m_JwB*r-this.m_JwD*u);var l=-this.m_mass*h;this.m_impulse+=l,t.SelfMulAdd(this.m_mA*l,this.m_JvAC),i+=this.m_iA*l*this.m_JwA,n.SelfMulAdd(this.m_mB*l,this.m_JvBD),r+=this.m_iB*l*this.m_JwB,s.SelfMulSub(this.m_mC*l,this.m_JvAC),a-=this.m_iC*l*this.m_JwC,o.SelfMulSub(this.m_mD*l,this.m_JvBD),u-=this.m_iD*l*this.m_JwD,e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=r,e.velocities[this.m_indexC].w=a,e.velocities[this.m_indexD].w=u}},{key:"SolvePositionConstraints",value:function(t){var i,n,r,s,o,u,h=t.positions[this.m_indexA].c,l=t.positions[this.m_indexA].a,c=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,f=t.positions[this.m_indexC].c,d=t.positions[this.m_indexC].a,m=t.positions[this.m_indexD].c,v=t.positions[this.m_indexD].a,y=this.m_qA.SetAngle(l),g=this.m_qB.SetAngle(_),S=this.m_qC.SetAngle(d),A=this.m_qD.SetAngle(v),T=0,E=this.m_JvAC,b=this.m_JvBD,C=0;if(this.m_typeA===e.b2JointType.e_revoluteJoint)E.SetZero(),r=1,o=1,C+=this.m_iA+this.m_iC,i=l-d-this.m_referenceAngleA;else{var R=Me.MulRV(S,this.m_localAxisC,a.SolvePositionConstraints_s_u),x=Me.MulRV(S,this.m_lalcC,a.SolvePositionConstraints_s_rC),w=Me.MulRV(y,this.m_lalcA,a.SolvePositionConstraints_s_rA);E.Copy(R),o=we.CrossVV(x,R),r=we.CrossVV(w,R),C+=this.m_mC+this.m_mA+this.m_iC*o*o+this.m_iA*r*r;var k=this.m_lalcC,I=Me.MulTRV(S,we.AddVV(w,we.SubVV(h,f,we.s_t0),we.s_t0),we.s_t0);i=we.DotVV(we.SubVV(I,k,we.s_t0),this.m_localAxisC)}if(this.m_typeB===e.b2JointType.e_revoluteJoint)b.SetZero(),s=this.m_ratio,u=this.m_ratio,C+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),n=_-v-this.m_referenceAngleB;else{var B=Me.MulRV(A,this.m_localAxisD,a.SolvePositionConstraints_s_u),P=Me.MulRV(A,this.m_lalcD,a.SolvePositionConstraints_s_rD),M=Me.MulRV(g,this.m_lalcB,a.SolvePositionConstraints_s_rB);we.MulSV(this.m_ratio,B,b),u=this.m_ratio*we.CrossVV(P,B),s=this.m_ratio*we.CrossVV(M,B),C+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*u*u+this.m_iB*s*s;var O=this.m_lalcD,D=Me.MulTRV(A,we.AddVV(M,we.SubVV(c,m,we.s_t0),we.s_t0),we.s_t0);n=we.DotVV(we.SubVV(D,O,we.s_t0),this.m_localAxisD)}var L=i+this.m_ratio*n-this.m_constant,N=0;return C>0&&(N=-L/C),h.SelfMulAdd(this.m_mA*N,E),l+=this.m_iA*N*r,c.SelfMulAdd(this.m_mB*N,b),_+=this.m_iB*N*s,f.SelfMulSub(this.m_mC*N,E),d-=this.m_iC*N*o,m.SelfMulSub(this.m_mD*N,b),v-=this.m_iD*N*u,t.positions[this.m_indexA].a=l,t.positions[this.m_indexB].a=_,t.positions[this.m_indexC].a=d,t.positions[this.m_indexD].a=v,T<p}},{key:"GetAnchorA",value:function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return we.MulSV(e*this.m_impulse,this.m_JvAC,t)}},{key:"GetReactionTorque",value:function(e){return e*this.m_impulse*this.m_JwA}},{key:"GetJoint1",value:function(){return this.m_joint1}},{key:"GetJoint2",value:function(){return this.m_joint2}},{key:"GetRatio",value:function(){return this.m_ratio}},{key:"SetRatio",value:function(e){this.m_ratio=e}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,n=this.m_joint1.m_index,r=this.m_joint2.m_index;e("  const jd: b2GearJointDef = new b2GearJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.joint1 = joints[%d];\n",n),e("  jd.joint2 = joints[%d];\n",r),e("  jd.ratio = %.15f;\n",this.m_ratio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}]),a}(wn);Ln.InitVelocityConstraints_s_u=new we,Ln.InitVelocityConstraints_s_rA=new we,Ln.InitVelocityConstraints_s_rB=new we,Ln.InitVelocityConstraints_s_rC=new we,Ln.InitVelocityConstraints_s_rD=new we,Ln.SolvePositionConstraints_s_u=new we,Ln.SolvePositionConstraints_s_rA=new we,Ln.SolvePositionConstraints_s_rB=new we,Ln.SolvePositionConstraints_s_rC=new we,Ln.SolvePositionConstraints_s_rD=new we;var Nn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_motorJoint)).linearOffset=new we(0,0),t.angularOffset=0,t.maxForce=1,t.maxTorque=1,t.correctionFactor=.3,t}return s(r,[{key:"Initialize",value:function(e,t){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var i=this.bodyA.GetAngle(),n=this.bodyB.GetAngle();this.angularOffset=n-i}}]),r}(xn),Fn=function(e){h(r,e);var t=v(r);function r(e){var s;return n(this,r),(s=t.call(this,e)).m_linearOffset=new we,s.m_angularOffset=0,s.m_linearImpulse=new we,s.m_angularImpulse=0,s.m_maxForce=0,s.m_maxTorque=0,s.m_correctionFactor=.3,s.m_indexA=0,s.m_indexB=0,s.m_rA=new we,s.m_rB=new we,s.m_localCenterA=new we,s.m_localCenterB=new we,s.m_linearError=new we,s.m_angularError=0,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_linearMass=new Be,s.m_angularMass=0,s.m_qA=new Me,s.m_qB=new Me,s.m_K=new Be,s.m_linearOffset.Copy(i(e.linearOffset,we.ZERO)),s.m_linearImpulse.SetZero(),s.m_maxForce=i(e.maxForce,0),s.m_maxTorque=i(e.maxTorque,0),s.m_correctionFactor=i(e.correctionFactor,.3),s}return s(r,[{key:"GetAnchorA",value:function(e){var t=this.m_bodyA.GetPosition();return e.x=t.x,e.y=t.y,e}},{key:"GetAnchorB",value:function(e){var t=this.m_bodyB.GetPosition();return e.x=t.x,e.y=t.y,e}},{key:"GetReactionForce",value:function(e,t){return we.MulSV(e,this.m_linearImpulse,t)}},{key:"GetReactionTorque",value:function(e){return e*this.m_angularImpulse}},{key:"SetLinearOffset",value:function(e){we.IsEqualToV(e,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(e))}},{key:"GetLinearOffset",value:function(){return this.m_linearOffset}},{key:"SetAngularOffset",value:function(e){e!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=e)}},{key:"GetAngularOffset",value:function(){return this.m_angularOffset}},{key:"SetMaxForce",value:function(e){this.m_maxForce=e}},{key:"GetMaxForce",value:function(){return this.m_maxForce}},{key:"SetMaxTorque",value:function(e){this.m_maxTorque=e}},{key:"GetMaxTorque",value:function(){return this.m_maxTorque}},{key:"InitVelocityConstraints",value:function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var t=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,o=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,h=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(a),c=Me.MulRV(h,we.SubVV(this.m_linearOffset,this.m_localCenterA,we.s_t0),this.m_rA),_=Me.MulRV(l,we.NegV(this.m_localCenterB,we.s_t0),this.m_rB),f=this.m_invMassA,d=this.m_invMassB,m=this.m_invIA,p=this.m_invIB,v=this.m_K;if(v.ex.x=f+d+m*c.y*c.y+p*_.y*_.y,v.ex.y=-m*c.x*c.y-p*_.x*_.y,v.ey.x=v.ex.y,v.ey.y=f+d+m*c.x*c.x+p*_.x*_.x,v.GetInverse(this.m_linearMass),this.m_angularMass=m+p,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),we.SubVV(we.AddVV(s,_,we.s_t0),we.AddVV(t,c,we.s_t1),this.m_linearError),this.m_angularError=a-i-this.m_angularOffset,e.step.warmStarting){this.m_linearImpulse.SelfMul(e.step.dtRatio),this.m_angularImpulse*=e.step.dtRatio;var y=this.m_linearImpulse;n.SelfMulSub(f,y),r-=m*(we.CrossVV(c,y)+this.m_angularImpulse),o.SelfMulAdd(d,y),u+=p*(we.CrossVV(_,y)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=u}},{key:"SolveVelocityConstraints",value:function(e){var t=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,n=e.velocities[this.m_indexB].v,s=e.velocities[this.m_indexB].w,a=this.m_invMassA,o=this.m_invMassB,u=this.m_invIA,h=this.m_invIB,l=e.step.dt,c=e.step.inv_dt,_=s-i+c*this.m_correctionFactor*this.m_angularError,f=-this.m_angularMass*_,d=this.m_angularImpulse,m=l*this.m_maxTorque;this.m_angularImpulse=le(this.m_angularImpulse+f,-m,m),i-=u*(f=this.m_angularImpulse-d),s+=h*f;var p=this.m_rA,v=this.m_rB,y=we.AddVV(we.SubVV(we.AddVV(n,we.CrossSV(s,v,we.s_t0),we.s_t0),we.AddVV(t,we.CrossSV(i,p,we.s_t1),we.s_t1),we.s_t2),we.MulSV(c*this.m_correctionFactor,this.m_linearError,we.s_t3),r.SolveVelocityConstraints_s_Cdot_v2),g=Be.MulMV(this.m_linearMass,y,r.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),S=r.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(g);var A=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>A*A&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(A)),we.SubVV(this.m_linearImpulse,S,g),t.SelfMulSub(a,g),i-=u*we.CrossVV(p,g),n.SelfMulAdd(o,g),s+=h*we.CrossVV(v,g),e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=s}},{key:"SolvePositionConstraints",value:function(){return!0}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;e("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),e("  jd.angularOffset = %.15f;\n",this.m_angularOffset),e("  jd.maxForce = %.15f;\n",this.m_maxForce),e("  jd.maxTorque = %.15f;\n",this.m_maxTorque),e("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}]),r}(wn);Fn.SolveVelocityConstraints_s_Cdot_v2=new we,Fn.SolveVelocityConstraints_s_impulse_v2=new we,Fn.SolveVelocityConstraints_s_oldImpulse_v2=new we;var Gn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_mouseJoint)).target=new we,t.maxForce=0,t.frequencyHz=5,t.dampingRatio=.7,t}return r}(xn),Vn=function(e){h(r,e);var t=v(r);function r(e){var s;return n(this,r),(s=t.call(this,e)).m_localAnchorB=new we,s.m_targetA=new we,s.m_frequencyHz=0,s.m_dampingRatio=0,s.m_beta=0,s.m_impulse=new we,s.m_maxForce=0,s.m_gamma=0,s.m_indexA=0,s.m_indexB=0,s.m_rB=new we,s.m_localCenterB=new we,s.m_invMassB=0,s.m_invIB=0,s.m_mass=new Be,s.m_C=new we,s.m_qB=new Me,s.m_lalcB=new we,s.m_K=new Be,s.m_targetA.Copy(i(e.target,we.ZERO)),Oe.MulTXV(s.m_bodyB.GetTransform(),s.m_targetA,s.m_localAnchorB),s.m_maxForce=i(e.maxForce,0),s.m_impulse.SetZero(),s.m_frequencyHz=i(e.frequencyHz,0),s.m_dampingRatio=i(e.dampingRatio,0),s.m_beta=0,s.m_gamma=0,s}return s(r,[{key:"SetTarget",value:function(e){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(e)}},{key:"GetTarget",value:function(){return this.m_targetA}},{key:"SetMaxForce",value:function(e){this.m_maxForce=e}},{key:"GetMaxForce",value:function(){return this.m_maxForce}},{key:"SetFrequency",value:function(e){this.m_frequencyHz=e}},{key:"GetFrequency",value:function(){return this.m_frequencyHz}},{key:"SetDampingRatio",value:function(e){this.m_dampingRatio=e}},{key:"GetDampingRatio",value:function(){return this.m_dampingRatio}},{key:"InitVelocityConstraints",value:function(e){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var t=e.positions[this.m_indexB].c,i=e.positions[this.m_indexB].a,n=e.velocities[this.m_indexB].v,r=e.velocities[this.m_indexB].w,s=this.m_qB.SetAngle(i),a=this.m_bodyB.GetMass(),o=2*u*this.m_frequencyHz,h=2*a*this.m_dampingRatio*o,l=a*o*o,c=e.step.dt;this.m_gamma=c*(h+c*l),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=c*l*this.m_gamma,we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Me.MulRV(s,this.m_lalcB,this.m_rB);var _=this.m_K;_.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,_.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,_.ey.x=_.ex.y,_.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,_.GetInverse(this.m_mass),this.m_C.x=t.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=t.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),r*=.98,e.step.warmStarting?(this.m_impulse.SelfMul(e.step.dtRatio),n.x+=this.m_invMassB*this.m_impulse.x,n.y+=this.m_invMassB*this.m_impulse.y,r+=this.m_invIB*we.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),e.velocities[this.m_indexB].w=r}},{key:"SolveVelocityConstraints",value:function(e){var t=e.velocities[this.m_indexB].v,i=e.velocities[this.m_indexB].w,n=we.AddVCrossSV(t,i,this.m_rB,r.SolveVelocityConstraints_s_Cdot),s=Be.MulMV(this.m_mass,we.AddVV(n,we.AddVV(this.m_C,we.MulSV(this.m_gamma,this.m_impulse,we.s_t0),we.s_t0),we.s_t0).SelfNeg(),r.SolveVelocityConstraints_s_impulse),a=r.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(s);var o=e.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>o*o&&this.m_impulse.SelfMul(o/this.m_impulse.Length()),we.SubVV(this.m_impulse,a,s),t.SelfMulAdd(this.m_invMassB,s),i+=this.m_invIB*we.CrossVV(this.m_rB,s),e.velocities[this.m_indexB].w=i}},{key:"SolvePositionConstraints",value:function(){return!0}},{key:"GetAnchorA",value:function(e){return e.x=this.m_targetA.x,e.y=this.m_targetA.y,e}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return we.MulSV(e,this.m_impulse,t)}},{key:"GetReactionTorque",value:function(){return 0}},{key:"Dump",value:function(e){e("Mouse joint dumping is not supported.\n")}},{key:"ShiftOrigin",value:function(e){this.m_targetA.SelfSub(e)}}]),r}(wn);Vn.SolveVelocityConstraints_s_Cdot=new we,Vn.SolveVelocityConstraints_s_impulse=new we,Vn.SolveVelocityConstraints_s_oldImpulse=new we;var Un=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_prismaticJoint)).localAnchorA=new we,t.localAnchorB=new we,t.localAxisA=new we(1,0),t.referenceAngle=0,t.enableLimit=!1,t.lowerTranslation=0,t.upperTranslation=0,t.enableMotor=!1,t.maxMotorForce=0,t.motorSpeed=0,t}return s(r,[{key:"Initialize",value:function(e,t,i,n){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}]),r}(xn),Hn=function(t){h(a,t);var r=v(a);function a(t){var s;return n(this,a),(s=r.call(this,t)).m_localAnchorA=new we,s.m_localAnchorB=new we,s.m_localXAxisA=new we,s.m_localYAxisA=new we,s.m_referenceAngle=0,s.m_impulse=new Ie(0,0,0),s.m_motorImpulse=0,s.m_lowerTranslation=0,s.m_upperTranslation=0,s.m_maxMotorForce=0,s.m_motorSpeed=0,s.m_enableLimit=!1,s.m_enableMotor=!1,s.m_limitState=e.b2LimitState.e_inactiveLimit,s.m_indexA=0,s.m_indexB=0,s.m_localCenterA=new we,s.m_localCenterB=new we,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_axis=new we(0,0),s.m_perp=new we(0,0),s.m_s1=0,s.m_s2=0,s.m_a1=0,s.m_a2=0,s.m_K=new Pe,s.m_K3=new Pe,s.m_K2=new Be,s.m_motorMass=0,s.m_qA=new Me,s.m_qB=new Me,s.m_lalcA=new we,s.m_lalcB=new we,s.m_rA=new we,s.m_rB=new we,s.m_localAnchorA.Copy(i(t.localAnchorA,we.ZERO)),s.m_localAnchorB.Copy(i(t.localAnchorB,we.ZERO)),s.m_localXAxisA.Copy(i(t.localAxisA,new we(1,0))).SelfNormalize(),we.CrossOneV(s.m_localXAxisA,s.m_localYAxisA),s.m_referenceAngle=i(t.referenceAngle,0),s.m_lowerTranslation=i(t.lowerTranslation,0),s.m_upperTranslation=i(t.upperTranslation,0),s.m_maxMotorForce=i(t.maxMotorForce,0),s.m_motorSpeed=i(t.motorSpeed,0),s.m_enableLimit=i(t.enableLimit,!1),s.m_enableMotor=i(t.enableMotor,!1),s}return s(a,[{key:"InitVelocityConstraints",value:function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].c,u=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,c=this.m_qA.SetAngle(n),_=this.m_qB.SetAngle(u);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var f=Me.MulRV(c,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var d=Me.MulRV(_,this.m_lalcB,this.m_rB),m=we.AddVV(we.SubVV(o,i,we.s_t0),we.SubVV(d,f,we.s_t1),a.InitVelocityConstraints_s_d),v=this.m_invMassA,y=this.m_invMassB,g=this.m_invIA,S=this.m_invIB;if(Me.MulRV(c,this.m_localXAxisA,this.m_axis),this.m_a1=we.CrossVV(we.AddVV(m,f,we.s_t0),this.m_axis),this.m_a2=we.CrossVV(d,this.m_axis),this.m_motorMass=v+y+g*this.m_a1*this.m_a1+S*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),Me.MulRV(c,this.m_localYAxisA,this.m_perp),this.m_s1=we.CrossVV(we.AddVV(m,f,we.s_t0),this.m_perp),this.m_s2=we.CrossVV(d,this.m_perp),this.m_K.ex.x=v+y+g*this.m_s1*this.m_s1+S*this.m_s2*this.m_s2,this.m_K.ex.y=g*this.m_s1+S*this.m_s2,this.m_K.ex.z=g*this.m_s1*this.m_a1+S*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=g+S,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=g*this.m_a1+S*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=v+y+g*this.m_a1*this.m_a1+S*this.m_a2*this.m_a2,this.m_enableLimit){var A=we.DotVV(this.m_axis,m);oe(this.m_upperTranslation-this.m_lowerTranslation)<2*p?this.m_limitState=e.b2LimitState.e_equalLimits:A<=this.m_lowerTranslation?this.m_limitState!==e.b2LimitState.e_atLowerLimit&&(this.m_limitState=e.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):A>=this.m_upperTranslation?this.m_limitState!==e.b2LimitState.e_atUpperLimit&&(this.m_limitState=e.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=e.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=e.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;var T=we.AddVV(we.MulSV(this.m_impulse.x,this.m_perp,we.s_t0),we.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,we.s_t1),a.InitVelocityConstraints_s_P),E=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,b=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;r.SelfMulSub(v,T),s-=g*E,h.SelfMulAdd(y,T),l+=S*b}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l}},{key:"SolveVelocityConstraints",value:function(t){var i=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,s=t.velocities[this.m_indexB].w,o=this.m_invMassA,u=this.m_invMassB,h=this.m_invIA,l=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==e.b2LimitState.e_equalLimits){var c=we.DotVV(this.m_axis,we.SubVV(r,i,we.s_t0))+this.m_a2*s-this.m_a1*n,_=this.m_motorMass*(this.m_motorSpeed-c),f=this.m_motorImpulse,d=t.step.dt*this.m_maxMotorForce;this.m_motorImpulse=le(this.m_motorImpulse+_,-d,d),_=this.m_motorImpulse-f;var m=we.MulSV(_,this.m_axis,a.SolveVelocityConstraints_s_P),p=_*this.m_a1,v=_*this.m_a2;i.SelfMulSub(o,m),n-=h*p,r.SelfMulAdd(u,m),s+=l*v}var y=we.DotVV(this.m_perp,we.SubVV(r,i,we.s_t0))+this.m_s2*s-this.m_s1*n,g=s-n;if(this.m_enableLimit&&this.m_limitState!==e.b2LimitState.e_inactiveLimit){var S=we.DotVV(this.m_axis,we.SubVV(r,i,we.s_t0))+this.m_a2*s-this.m_a1*n,A=a.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),T=this.m_K.Solve33(-y,-g,-S,a.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(T),this.m_limitState===e.b2LimitState.e_atLowerLimit?this.m_impulse.z=he(this.m_impulse.z,0):this.m_limitState===e.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=ue(this.m_impulse.z,0));var E=-y-(this.m_impulse.z-A.z)*this.m_K.ez.x,b=-g-(this.m_impulse.z-A.z)*this.m_K.ez.y,C=this.m_K.Solve22(E,b,a.SolveVelocityConstraints_s_f2r);C.x+=A.x,C.y+=A.y,this.m_impulse.x=C.x,this.m_impulse.y=C.y,T.x=this.m_impulse.x-A.x,T.y=this.m_impulse.y-A.y,T.z=this.m_impulse.z-A.z;var R=we.AddVV(we.MulSV(T.x,this.m_perp,we.s_t0),we.MulSV(T.z,this.m_axis,we.s_t1),a.SolveVelocityConstraints_s_P),x=T.x*this.m_s1+T.y+T.z*this.m_a1,w=T.x*this.m_s2+T.y+T.z*this.m_a2;i.SelfMulSub(o,R),n-=h*x,r.SelfMulAdd(u,R),s+=l*w}else{var k=this.m_K.Solve22(-y,-g,a.SolveVelocityConstraints_s_df2);this.m_impulse.x+=k.x,this.m_impulse.y+=k.y;var I=we.MulSV(k.x,this.m_perp,a.SolveVelocityConstraints_s_P),B=k.x*this.m_s1+k.y,P=k.x*this.m_s2+k.y;i.SelfMulSub(o,I),n-=h*B,r.SelfMulAdd(u,I),s+=l*P}t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=s}},{key:"SolvePositionConstraints",value:function(e){var t=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,n=e.positions[this.m_indexB].c,r=e.positions[this.m_indexB].a,s=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(r),u=this.m_invMassA,h=this.m_invMassB,l=this.m_invIA,c=this.m_invIB,_=Me.MulRV(s,this.m_lalcA,this.m_rA),f=Me.MulRV(o,this.m_lalcB,this.m_rB),d=we.SubVV(we.AddVV(n,f,we.s_t0),we.AddVV(t,_,we.s_t1),a.SolvePositionConstraints_s_d),m=Me.MulRV(s,this.m_localXAxisA,this.m_axis),v=we.CrossVV(we.AddVV(d,_,we.s_t0),m),g=we.CrossVV(f,m),S=Me.MulRV(s,this.m_localYAxisA,this.m_perp),A=we.CrossVV(we.AddVV(d,_,we.s_t0),S),T=we.CrossVV(f,S),E=a.SolvePositionConstraints_s_impulse,C=we.DotVV(S,d),R=r-i-this.m_referenceAngle,x=oe(C),w=oe(R),k=!1,I=0;if(this.m_enableLimit){var B=we.DotVV(m,d);oe(this.m_upperTranslation-this.m_lowerTranslation)<2*p?(I=le(B,-b,b),x=he(x,oe(B)),k=!0):B<=this.m_lowerTranslation?(I=le(B-this.m_lowerTranslation+p,-b,0),x=he(x,this.m_lowerTranslation-B),k=!0):B>=this.m_upperTranslation&&(I=le(B-this.m_upperTranslation-p,0,b),x=he(x,B-this.m_upperTranslation),k=!0)}if(k){var P=u+h+l*A*A+c*T*T,M=l*A+c*T,O=l*A*v+c*T*g,D=l+c;0===D&&(D=1);var L=l*v+c*g,N=u+h+l*v*v+c*g*g,F=this.m_K3;F.ex.SetXYZ(P,M,O),F.ey.SetXYZ(M,D,L),F.ez.SetXYZ(O,L,N),E=F.Solve33(-C,-R,-I,E)}else{var G=u+h+l*A*A+c*T*T,V=l*A+c*T,U=l+c;0===U&&(U=1);var H=this.m_K2;H.ex.Set(G,V),H.ey.Set(V,U);var z=H.Solve(-C,-R,a.SolvePositionConstraints_s_impulse1);E.x=z.x,E.y=z.y,E.z=0}var W=we.AddVV(we.MulSV(E.x,S,we.s_t0),we.MulSV(E.z,m,we.s_t1),a.SolvePositionConstraints_s_P),X=E.x*A+E.y+E.z*v,j=E.x*T+E.y+E.z*g;return t.SelfMulSub(u,W),i-=l*X,n.SelfMulAdd(h,W),r+=c*j,e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=r,x<=p&&w<=y}},{key:"GetAnchorA",value:function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return t.x=e*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),t.y=e*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),t}},{key:"GetReactionTorque",value:function(e){return e*this.m_impulse.y}},{key:"GetLocalAnchorA",value:function(){return this.m_localAnchorA}},{key:"GetLocalAnchorB",value:function(){return this.m_localAnchorB}},{key:"GetLocalAxisA",value:function(){return this.m_localXAxisA}},{key:"GetReferenceAngle",value:function(){return this.m_referenceAngle}},{key:"GetJointTranslation",value:function(){var e=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,a.GetJointTranslation_s_pA),t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,a.GetJointTranslation_s_pB),i=we.SubVV(t,e,a.GetJointTranslation_s_d),n=this.m_bodyA.GetWorldVector(this.m_localXAxisA,a.GetJointTranslation_s_axis);return we.DotVV(i,n)}},{key:"GetJointSpeed",value:function(){var e=this.m_bodyA,t=this.m_bodyB;we.SubVV(this.m_localAnchorA,e.m_sweep.localCenter,this.m_lalcA);var i=Me.MulRV(e.m_xf.q,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,t.m_sweep.localCenter,this.m_lalcB);var n=Me.MulRV(t.m_xf.q,this.m_lalcB,this.m_rB),r=we.AddVV(e.m_sweep.c,i,we.s_t0),s=we.AddVV(t.m_sweep.c,n,we.s_t1),a=we.SubVV(s,r,we.s_t2),o=e.GetWorldVector(this.m_localXAxisA,this.m_axis),u=e.m_linearVelocity,h=t.m_linearVelocity,l=e.m_angularVelocity,c=t.m_angularVelocity;return we.DotVV(a,we.CrossSV(l,o,we.s_t0))+we.DotVV(o,we.SubVV(we.AddVCrossSV(h,c,n,we.s_t0),we.AddVCrossSV(u,l,i,we.s_t1),we.s_t0))}},{key:"IsLimitEnabled",value:function(){return this.m_enableLimit}},{key:"EnableLimit",value:function(e){e!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)}},{key:"GetLowerLimit",value:function(){return this.m_lowerTranslation}},{key:"GetUpperLimit",value:function(){return this.m_upperTranslation}},{key:"SetLimits",value:function(e,t){e===this.m_lowerTranslation&&t===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=e,this.m_upperTranslation=t,this.m_impulse.z=0)}},{key:"IsMotorEnabled",value:function(){return this.m_enableMotor}},{key:"EnableMotor",value:function(e){e!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=e)}},{key:"SetMotorSpeed",value:function(e){e!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=e)}},{key:"GetMotorSpeed",value:function(){return this.m_motorSpeed}},{key:"SetMaxMotorForce",value:function(e){e!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=e)}},{key:"GetMaxMotorForce",value:function(){return this.m_maxMotorForce}},{key:"GetMotorForce",value:function(e){return e*this.m_motorImpulse}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;e("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),e("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),e("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),e("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),e("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),e("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),e("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),e("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}]),a}(wn);Hn.InitVelocityConstraints_s_d=new we,Hn.InitVelocityConstraints_s_P=new we,Hn.SolveVelocityConstraints_s_P=new we,Hn.SolveVelocityConstraints_s_f2r=new we,Hn.SolveVelocityConstraints_s_f1=new Ie,Hn.SolveVelocityConstraints_s_df3=new Ie,Hn.SolveVelocityConstraints_s_df2=new we,Hn.SolvePositionConstraints_s_d=new we,Hn.SolvePositionConstraints_s_impulse=new Ie,Hn.SolvePositionConstraints_s_impulse1=new we,Hn.SolvePositionConstraints_s_P=new we,Hn.GetJointTranslation_s_pA=new we,Hn.GetJointTranslation_s_pB=new we,Hn.GetJointTranslation_s_d=new we,Hn.GetJointTranslation_s_axis=new we;var zn=2,Wn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_pulleyJoint)).groundAnchorA=new we(-1,1),t.groundAnchorB=new we(1,1),t.localAnchorA=new we(-1,0),t.localAnchorB=new we(1,0),t.lengthA=0,t.lengthB=0,t.ratio=1,t.collideConnected=!0,t}return s(r,[{key:"Initialize",value:function(e,t,i,n,r,s,a){this.bodyA=e,this.bodyB=t,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(n),this.bodyA.GetLocalPoint(r,this.localAnchorA),this.bodyB.GetLocalPoint(s,this.localAnchorB),this.lengthA=we.DistanceVV(r,i),this.lengthB=we.DistanceVV(s,n),this.ratio=a}}]),r}(xn),Xn=function(e){h(r,e);var t=v(r);function r(e){var s;return n(this,r),(s=t.call(this,e)).m_groundAnchorA=new we,s.m_groundAnchorB=new we,s.m_lengthA=0,s.m_lengthB=0,s.m_localAnchorA=new we,s.m_localAnchorB=new we,s.m_constant=0,s.m_ratio=0,s.m_impulse=0,s.m_indexA=0,s.m_indexB=0,s.m_uA=new we,s.m_uB=new we,s.m_rA=new we,s.m_rB=new we,s.m_localCenterA=new we,s.m_localCenterB=new we,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_mass=0,s.m_qA=new Me,s.m_qB=new Me,s.m_lalcA=new we,s.m_lalcB=new we,s.m_groundAnchorA.Copy(i(e.groundAnchorA,new we(-1,1))),s.m_groundAnchorB.Copy(i(e.groundAnchorB,new we(1,0))),s.m_localAnchorA.Copy(i(e.localAnchorA,new we(-1,0))),s.m_localAnchorB.Copy(i(e.localAnchorB,new we(1,0))),s.m_lengthA=i(e.lengthA,0),s.m_lengthB=i(e.lengthB,0),s.m_ratio=i(e.ratio,1),s.m_constant=i(e.lengthA,0)+s.m_ratio*i(e.lengthB,0),s.m_impulse=0,s}return s(r,[{key:"InitVelocityConstraints",value:function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var t=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v,s=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].c,o=e.positions[this.m_indexB].a,u=e.velocities[this.m_indexB].v,h=e.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(i),c=this.m_qB.SetAngle(o);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Me.MulRV(l,this.m_lalcA,this.m_rA),we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Me.MulRV(c,this.m_lalcB,this.m_rB),this.m_uA.Copy(t).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(a).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);var _=this.m_uA.Length(),f=this.m_uB.Length();_>10*p?this.m_uA.SelfMul(1/_):this.m_uA.SetZero(),f>10*p?this.m_uB.SelfMul(1/f):this.m_uB.SetZero();var d=we.CrossVV(this.m_rA,this.m_uA),m=we.CrossVV(this.m_rB,this.m_uB),v=this.m_invMassA+this.m_invIA*d*d,y=this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=v+this.m_ratio*this.m_ratio*y,this.m_mass>0&&(this.m_mass=1/this.m_mass),e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var g=we.MulSV(-this.m_impulse,this.m_uA,r.InitVelocityConstraints_s_PA),S=we.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,r.InitVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,g),s+=this.m_invIA*we.CrossVV(this.m_rA,g),u.SelfMulAdd(this.m_invMassB,S),h+=this.m_invIB*we.CrossVV(this.m_rB,S)}else this.m_impulse=0;e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=h}},{key:"SolveVelocityConstraints",value:function(e){var t=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,n=e.velocities[this.m_indexB].v,s=e.velocities[this.m_indexB].w,a=we.AddVCrossSV(t,i,this.m_rA,r.SolveVelocityConstraints_s_vpA),o=we.AddVCrossSV(n,s,this.m_rB,r.SolveVelocityConstraints_s_vpB),u=-we.DotVV(this.m_uA,a)-this.m_ratio*we.DotVV(this.m_uB,o),h=-this.m_mass*u;this.m_impulse+=h;var l=we.MulSV(-h,this.m_uA,r.SolveVelocityConstraints_s_PA),c=we.MulSV(-this.m_ratio*h,this.m_uB,r.SolveVelocityConstraints_s_PB);t.SelfMulAdd(this.m_invMassA,l),i+=this.m_invIA*we.CrossVV(this.m_rA,l),n.SelfMulAdd(this.m_invMassB,c),s+=this.m_invIB*we.CrossVV(this.m_rB,c),e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=s}},{key:"SolvePositionConstraints",value:function(e){var t=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,n=e.positions[this.m_indexB].c,s=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var u=Me.MulRV(a,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h=Me.MulRV(o,this.m_lalcB,this.m_rB),l=this.m_uA.Copy(t).SelfAdd(u).SelfSub(this.m_groundAnchorA),c=this.m_uB.Copy(n).SelfAdd(h).SelfSub(this.m_groundAnchorB),_=l.Length(),f=c.Length();_>10*p?l.SelfMul(1/_):l.SetZero(),f>10*p?c.SelfMul(1/f):c.SetZero();var d=we.CrossVV(u,l),m=we.CrossVV(h,c),v=this.m_invMassA+this.m_invIA*d*d,y=this.m_invMassB+this.m_invIB*m*m,g=v+this.m_ratio*this.m_ratio*y;g>0&&(g=1/g);var S=this.m_constant-_-this.m_ratio*f,A=oe(S),T=-g*S,E=we.MulSV(-T,l,r.SolvePositionConstraints_s_PA),b=we.MulSV(-this.m_ratio*T,c,r.SolvePositionConstraints_s_PB);return t.SelfMulAdd(this.m_invMassA,E),i+=this.m_invIA*we.CrossVV(u,E),n.SelfMulAdd(this.m_invMassB,b),s+=this.m_invIB*we.CrossVV(h,b),e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=s,A<p}},{key:"GetAnchorA",value:function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return t.x=e*this.m_impulse*this.m_uB.x,t.y=e*this.m_impulse*this.m_uB.y,t}},{key:"GetReactionTorque",value:function(){return 0}},{key:"GetGroundAnchorA",value:function(){return this.m_groundAnchorA}},{key:"GetGroundAnchorB",value:function(){return this.m_groundAnchorB}},{key:"GetLengthA",value:function(){return this.m_lengthA}},{key:"GetLengthB",value:function(){return this.m_lengthB}},{key:"GetRatio",value:function(){return this.m_ratio}},{key:"GetCurrentLengthA",value:function(){var e=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,r.GetCurrentLengthA_s_p),t=this.m_groundAnchorA;return we.DistanceVV(e,t)}},{key:"GetCurrentLengthB",value:function(){var e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,r.GetCurrentLengthB_s_p),t=this.m_groundAnchorB;return we.DistanceVV(e,t)}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;e("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),e("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.lengthA = %.15f;\n",this.m_lengthA),e("  jd.lengthB = %.15f;\n",this.m_lengthB),e("  jd.ratio = %.15f;\n",this.m_ratio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}},{key:"ShiftOrigin",value:function(e){this.m_groundAnchorA.SelfSub(e),this.m_groundAnchorB.SelfSub(e)}}]),r}(wn);Xn.InitVelocityConstraints_s_PA=new we,Xn.InitVelocityConstraints_s_PB=new we,Xn.SolveVelocityConstraints_s_vpA=new we,Xn.SolveVelocityConstraints_s_vpB=new we,Xn.SolveVelocityConstraints_s_PA=new we,Xn.SolveVelocityConstraints_s_PB=new we,Xn.SolvePositionConstraints_s_PA=new we,Xn.SolvePositionConstraints_s_PB=new we,Xn.GetCurrentLengthA_s_p=new we,Xn.GetCurrentLengthB_s_p=new we;var jn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_revoluteJoint)).localAnchorA=new we(0,0),t.localAnchorB=new we(0,0),t.referenceAngle=0,t.enableLimit=!1,t.lowerAngle=0,t.upperAngle=0,t.enableMotor=!1,t.motorSpeed=0,t.maxMotorTorque=0,t}return s(r,[{key:"Initialize",value:function(e,t,i){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}]),r}(xn),qn=function(t){h(a,t);var r=v(a);function a(t){var s;return n(this,a),(s=r.call(this,t)).m_localAnchorA=new we,s.m_localAnchorB=new we,s.m_impulse=new Ie,s.m_motorImpulse=0,s.m_enableMotor=!1,s.m_maxMotorTorque=0,s.m_motorSpeed=0,s.m_enableLimit=!1,s.m_referenceAngle=0,s.m_lowerAngle=0,s.m_upperAngle=0,s.m_indexA=0,s.m_indexB=0,s.m_rA=new we,s.m_rB=new we,s.m_localCenterA=new we,s.m_localCenterB=new we,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_mass=new Pe,s.m_motorMass=0,s.m_limitState=e.b2LimitState.e_inactiveLimit,s.m_qA=new Me,s.m_qB=new Me,s.m_lalcA=new we,s.m_lalcB=new we,s.m_K=new Be,s.m_localAnchorA.Copy(i(t.localAnchorA,we.ZERO)),s.m_localAnchorB.Copy(i(t.localAnchorB,we.ZERO)),s.m_referenceAngle=i(t.referenceAngle,0),s.m_impulse.SetZero(),s.m_motorImpulse=0,s.m_lowerAngle=i(t.lowerAngle,0),s.m_upperAngle=i(t.upperAngle,0),s.m_maxMotorTorque=i(t.maxMotorTorque,0),s.m_motorSpeed=i(t.motorSpeed,0),s.m_enableLimit=i(t.enableLimit,!1),s.m_enableMotor=i(t.enableMotor,!1),s.m_limitState=e.b2LimitState.e_inactiveLimit,s}return s(a,[{key:"InitVelocityConstraints",value:function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v,u=t.velocities[this.m_indexB].w,h=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(s);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Me.MulRV(h,this.m_lalcA,this.m_rA),we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Me.MulRV(l,this.m_lalcB,this.m_rB);var c=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,m=f+d===0;if(this.m_mass.ex.x=c+_+this.m_rA.y*this.m_rA.y*f+this.m_rB.y*this.m_rB.y*d,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*f-this.m_rB.y*this.m_rB.x*d,this.m_mass.ez.x=-this.m_rA.y*f-this.m_rB.y*d,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=c+_+this.m_rA.x*this.m_rA.x*f+this.m_rB.x*this.m_rB.x*d,this.m_mass.ez.y=this.m_rA.x*f+this.m_rB.x*d,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=f+d,this.m_motorMass=f+d,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!m||(this.m_motorImpulse=0),this.m_enableLimit&&!m){var p=s-i-this.m_referenceAngle;oe(this.m_upperAngle-this.m_lowerAngle)<2*y?this.m_limitState=e.b2LimitState.e_equalLimits:p<=this.m_lowerAngle?(this.m_limitState!==e.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=e.b2LimitState.e_atLowerLimit):p>=this.m_upperAngle?(this.m_limitState!==e.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=e.b2LimitState.e_atUpperLimit):(this.m_limitState=e.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=e.b2LimitState.e_inactiveLimit;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;var v=a.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);n.SelfMulSub(c,v),r-=f*(we.CrossVV(this.m_rA,v)+this.m_motorImpulse+this.m_impulse.z),o.SelfMulAdd(_,v),u+=d*(we.CrossVV(this.m_rB,v)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=u}},{key:"SolveVelocityConstraints",value:function(t){var i=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,s=t.velocities[this.m_indexB].w,o=this.m_invMassA,u=this.m_invMassB,h=this.m_invIA,l=this.m_invIB,c=h+l===0;if(this.m_enableMotor&&this.m_limitState!==e.b2LimitState.e_equalLimits&&!c){var _=s-n-this.m_motorSpeed,f=-this.m_motorMass*_,d=this.m_motorImpulse,m=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=le(this.m_motorImpulse+f,-m,m),n-=h*(f=this.m_motorImpulse-d),s+=l*f}if(this.m_enableLimit&&this.m_limitState!==e.b2LimitState.e_inactiveLimit&&!c){var p=we.SubVV(we.AddVCrossSV(r,s,this.m_rB,we.s_t0),we.AddVCrossSV(i,n,this.m_rA,we.s_t1),a.SolveVelocityConstraints_s_Cdot1),v=s-n,y=this.m_mass.Solve33(p.x,p.y,v,a.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===e.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(y);else if(this.m_limitState===e.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+y.z<0){var g=-p.x+this.m_impulse.z*this.m_mass.ez.x,S=-p.y+this.m_impulse.z*this.m_mass.ez.y,A=this.m_mass.Solve22(g,S,a.SolveVelocityConstraints_s_reduced_v2);y.x=A.x,y.y=A.y,y.z=-this.m_impulse.z,this.m_impulse.x+=A.x,this.m_impulse.y+=A.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(y);else if(this.m_limitState===e.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+y.z>0){var T=-p.x+this.m_impulse.z*this.m_mass.ez.x,E=-p.y+this.m_impulse.z*this.m_mass.ez.y,b=this.m_mass.Solve22(T,E,a.SolveVelocityConstraints_s_reduced_v2);y.x=b.x,y.y=b.y,y.z=-this.m_impulse.z,this.m_impulse.x+=b.x,this.m_impulse.y+=b.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(y);var C=a.SolveVelocityConstraints_s_P.Set(y.x,y.y);i.SelfMulSub(o,C),n-=h*(we.CrossVV(this.m_rA,C)+y.z),r.SelfMulAdd(u,C),s+=l*(we.CrossVV(this.m_rB,C)+y.z)}else{var R=we.SubVV(we.AddVCrossSV(r,s,this.m_rB,we.s_t0),we.AddVCrossSV(i,n,this.m_rA,we.s_t1),a.SolveVelocityConstraints_s_Cdot_v2),x=this.m_mass.Solve22(-R.x,-R.y,a.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=x.x,this.m_impulse.y+=x.y,i.SelfMulSub(o,x),n-=h*we.CrossVV(this.m_rA,x),r.SelfMulAdd(u,x),s+=l*we.CrossVV(this.m_rB,x)}t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=s}},{key:"SolvePositionConstraints",value:function(t){var i=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,s=t.positions[this.m_indexB].a,o=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(s),h=0,l=0,c=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==e.b2LimitState.e_inactiveLimit&&!c){var _=s-n-this.m_referenceAngle,f=0;if(this.m_limitState===e.b2LimitState.e_equalLimits){var d=le(_-this.m_lowerAngle,-C,C);f=-this.m_motorMass*d,h=oe(d)}else if(this.m_limitState===e.b2LimitState.e_atLowerLimit){var m=_-this.m_lowerAngle;h=-m,m=le(m+y,-C,0),f=-this.m_motorMass*m}else if(this.m_limitState===e.b2LimitState.e_atUpperLimit){var v=_-this.m_upperAngle;h=v,v=le(v-y,0,C),f=-this.m_motorMass*v}n-=this.m_invIA*f,s+=this.m_invIB*f}o.SetAngle(n),u.SetAngle(s),we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var g=Me.MulRV(o,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var S=Me.MulRV(u,this.m_lalcB,this.m_rB),A=we.SubVV(we.AddVV(r,S,we.s_t0),we.AddVV(i,g,we.s_t1),a.SolvePositionConstraints_s_C_v2);l=A.Length();var T=this.m_invMassA,E=this.m_invMassB,b=this.m_invIA,R=this.m_invIB,x=this.m_K;x.ex.x=T+E+b*g.y*g.y+R*S.y*S.y,x.ex.y=-b*g.x*g.y-R*S.x*S.y,x.ey.x=x.ex.y,x.ey.y=T+E+b*g.x*g.x+R*S.x*S.x;var w=x.Solve(A.x,A.y,a.SolvePositionConstraints_s_impulse).SelfNeg();return i.SelfMulSub(T,w),n-=b*we.CrossVV(g,w),r.SelfMulAdd(E,w),s+=R*we.CrossVV(S,w),t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=s,l<=p&&h<=y}},{key:"GetAnchorA",value:function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return t.x=e*this.m_impulse.x,t.y=e*this.m_impulse.y,t}},{key:"GetReactionTorque",value:function(e){return e*this.m_impulse.z}},{key:"GetLocalAnchorA",value:function(){return this.m_localAnchorA}},{key:"GetLocalAnchorB",value:function(){return this.m_localAnchorB}},{key:"GetReferenceAngle",value:function(){return this.m_referenceAngle}},{key:"GetJointAngle",value:function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}},{key:"GetJointSpeed",value:function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}},{key:"IsMotorEnabled",value:function(){return this.m_enableMotor}},{key:"EnableMotor",value:function(e){e!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=e)}},{key:"GetMotorTorque",value:function(e){return e*this.m_motorImpulse}},{key:"GetMotorSpeed",value:function(){return this.m_motorSpeed}},{key:"SetMaxMotorTorque",value:function(e){e!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=e)}},{key:"GetMaxMotorTorque",value:function(){return this.m_maxMotorTorque}},{key:"IsLimitEnabled",value:function(){return this.m_enableLimit}},{key:"EnableLimit",value:function(e){e!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)}},{key:"GetLowerLimit",value:function(){return this.m_lowerAngle}},{key:"GetUpperLimit",value:function(){return this.m_upperAngle}},{key:"SetLimits",value:function(e,t){e===this.m_lowerAngle&&t===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=e,this.m_upperAngle=t)}},{key:"SetMotorSpeed",value:function(e){e!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=e)}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;e("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),e("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),e("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),e("  jd.upperAngle = %.15f;\n",this.m_upperAngle),e("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),e("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),e("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}]),a}(wn);qn.InitVelocityConstraints_s_P=new we,qn.SolveVelocityConstraints_s_P=new we,qn.SolveVelocityConstraints_s_Cdot_v2=new we,qn.SolveVelocityConstraints_s_Cdot1=new we,qn.SolveVelocityConstraints_s_impulse_v3=new Ie,qn.SolveVelocityConstraints_s_reduced_v2=new we,qn.SolveVelocityConstraints_s_impulse_v2=new we,qn.SolvePositionConstraints_s_C_v2=new we,qn.SolvePositionConstraints_s_impulse=new we;var Yn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_ropeJoint)).localAnchorA=new we(-1,0),t.localAnchorB=new we(1,0),t.maxLength=0,t}return r}(xn),Kn=function(t){h(a,t);var r=v(a);function a(t){var s;return n(this,a),(s=r.call(this,t)).m_localAnchorA=new we,s.m_localAnchorB=new we,s.m_maxLength=0,s.m_length=0,s.m_impulse=0,s.m_indexA=0,s.m_indexB=0,s.m_u=new we,s.m_rA=new we,s.m_rB=new we,s.m_localCenterA=new we,s.m_localCenterB=new we,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_mass=0,s.m_state=e.b2LimitState.e_inactiveLimit,s.m_qA=new Me,s.m_qB=new Me,s.m_lalcA=new we,s.m_lalcB=new we,s.m_localAnchorA.Copy(i(t.localAnchorA,new we(-1,0))),s.m_localAnchorB.Copy(i(t.localAnchorB,new we(1,0))),s.m_maxLength=i(t.maxLength,0),s}return s(a,[{key:"InitVelocityConstraints",value:function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].c,u=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,c=this.m_qA.SetAngle(n),_=this.m_qB.SetAngle(u);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Me.MulRV(c,this.m_lalcA,this.m_rA),we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Me.MulRV(_,this.m_lalcB,this.m_rB),this.m_u.Copy(o).SelfAdd(this.m_rB).SelfSub(i).SelfSub(this.m_rA),this.m_length=this.m_u.Length();var f=this.m_length-this.m_maxLength;if(this.m_state=f>0?e.b2LimitState.e_atUpperLimit:e.b2LimitState.e_inactiveLimit,!(this.m_length>p))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);var d=we.CrossVV(this.m_rA,this.m_u),m=we.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var y=we.MulSV(this.m_impulse,this.m_u,a.InitVelocityConstraints_s_P);r.SelfMulSub(this.m_invMassA,y),s-=this.m_invIA*we.CrossVV(this.m_rA,y),h.SelfMulAdd(this.m_invMassB,y),l+=this.m_invIB*we.CrossVV(this.m_rB,y)}else this.m_impulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l}},{key:"SolveVelocityConstraints",value:function(e){var t=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,n=e.velocities[this.m_indexB].v,r=e.velocities[this.m_indexB].w,s=we.AddVCrossSV(t,i,this.m_rA,a.SolveVelocityConstraints_s_vpA),o=we.AddVCrossSV(n,r,this.m_rB,a.SolveVelocityConstraints_s_vpB),u=this.m_length-this.m_maxLength,h=we.DotVV(this.m_u,we.SubVV(o,s,we.s_t0));u<0&&(h+=e.step.inv_dt*u);var l=-this.m_mass*h,c=this.m_impulse;this.m_impulse=ue(0,this.m_impulse+l),l=this.m_impulse-c;var _=we.MulSV(l,this.m_u,a.SolveVelocityConstraints_s_P);t.SelfMulSub(this.m_invMassA,_),i-=this.m_invIA*we.CrossVV(this.m_rA,_),n.SelfMulAdd(this.m_invMassB,_),r+=this.m_invIB*we.CrossVV(this.m_rB,_),e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=r}},{key:"SolvePositionConstraints",value:function(e){var t=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,n=e.positions[this.m_indexB].c,r=e.positions[this.m_indexB].a,s=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(r);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var u=Me.MulRV(s,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h=Me.MulRV(o,this.m_lalcB,this.m_rB),l=this.m_u.Copy(n).SelfAdd(h).SelfSub(t).SelfSub(u),c=l.Normalize(),_=c-this.m_maxLength;_=le(_,0,b);var f=-this.m_mass*_,d=we.MulSV(f,l,a.SolvePositionConstraints_s_P);return t.SelfMulSub(this.m_invMassA,d),i-=this.m_invIA*we.CrossVV(u,d),n.SelfMulAdd(this.m_invMassB,d),r+=this.m_invIB*we.CrossVV(h,d),e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=r,c-this.m_maxLength<p}},{key:"GetAnchorA",value:function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return we.MulSV(e*this.m_impulse,this.m_u,t)}},{key:"GetReactionTorque",value:function(){return 0}},{key:"GetLocalAnchorA",value:function(){return this.m_localAnchorA}},{key:"GetLocalAnchorB",value:function(){return this.m_localAnchorB}},{key:"SetMaxLength",value:function(e){this.m_maxLength=e}},{key:"GetMaxLength",value:function(){return this.m_maxLength}},{key:"GetLimitState",value:function(){return this.m_state}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;e("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.maxLength = %.15f;\n",this.m_maxLength),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}]),a}(wn);Kn.InitVelocityConstraints_s_P=new we,Kn.SolveVelocityConstraints_s_vpA=new we,Kn.SolveVelocityConstraints_s_vpB=new we,Kn.SolveVelocityConstraints_s_P=new we,Kn.SolvePositionConstraints_s_P=new we;var Qn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_weldJoint)).localAnchorA=new we,t.localAnchorB=new we,t.referenceAngle=0,t.frequencyHz=0,t.dampingRatio=0,t}return s(r,[{key:"Initialize",value:function(e,t,i){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}]),r}(xn),Jn=function(e){h(r,e);var t=v(r);function r(e){var s;return n(this,r),(s=t.call(this,e)).m_frequencyHz=0,s.m_dampingRatio=0,s.m_bias=0,s.m_localAnchorA=new we,s.m_localAnchorB=new we,s.m_referenceAngle=0,s.m_gamma=0,s.m_impulse=new Ie(0,0,0),s.m_indexA=0,s.m_indexB=0,s.m_rA=new we,s.m_rB=new we,s.m_localCenterA=new we,s.m_localCenterB=new we,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_mass=new Pe,s.m_qA=new Me,s.m_qB=new Me,s.m_lalcA=new we,s.m_lalcB=new we,s.m_K=new Pe,s.m_frequencyHz=i(e.frequencyHz,0),s.m_dampingRatio=i(e.dampingRatio,0),s.m_localAnchorA.Copy(i(e.localAnchorA,we.ZERO)),s.m_localAnchorB.Copy(i(e.localAnchorB,we.ZERO)),s.m_referenceAngle=i(e.referenceAngle,0),s.m_impulse.SetZero(),s}return s(r,[{key:"InitVelocityConstraints",value:function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var t=e.positions[this.m_indexA].a,i=e.velocities[this.m_indexA].v,n=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].a,a=e.velocities[this.m_indexB].v,o=e.velocities[this.m_indexB].w,h=this.m_qA.SetAngle(t),l=this.m_qB.SetAngle(s);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Me.MulRV(h,this.m_lalcA,this.m_rA),we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Me.MulRV(l,this.m_lalcB,this.m_rB);var c=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,m=this.m_K;if(m.ex.x=c+_+this.m_rA.y*this.m_rA.y*f+this.m_rB.y*this.m_rB.y*d,m.ey.x=-this.m_rA.y*this.m_rA.x*f-this.m_rB.y*this.m_rB.x*d,m.ez.x=-this.m_rA.y*f-this.m_rB.y*d,m.ex.y=m.ey.x,m.ey.y=c+_+this.m_rA.x*this.m_rA.x*f+this.m_rB.x*this.m_rB.x*d,m.ez.y=this.m_rA.x*f+this.m_rB.x*d,m.ex.z=m.ez.x,m.ey.z=m.ez.y,m.ez.z=f+d,this.m_frequencyHz>0){m.GetInverse22(this.m_mass);var p=f+d,v=p>0?1/p:0,y=s-t-this.m_referenceAngle,g=2*u*this.m_frequencyHz,S=2*v*this.m_dampingRatio*g,A=v*g*g,T=e.step.dt;this.m_gamma=T*(S+T*A),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=y*T*A*this.m_gamma,p+=this.m_gamma,this.m_mass.ez.z=0!==p?1/p:0}else m.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio);var E=r.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(c,E),n-=f*(we.CrossVV(this.m_rA,E)+this.m_impulse.z),a.SelfMulAdd(_,E),o+=d*(we.CrossVV(this.m_rB,E)+this.m_impulse.z)}else this.m_impulse.SetZero();e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=o}},{key:"SolveVelocityConstraints",value:function(e){var t=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,n=e.velocities[this.m_indexB].v,s=e.velocities[this.m_indexB].w,a=this.m_invMassA,o=this.m_invMassB,u=this.m_invIA,h=this.m_invIB;if(this.m_frequencyHz>0){var l=s-i,c=-this.m_mass.ez.z*(l+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=c,i-=u*c,s+=h*c;var _=we.SubVV(we.AddVCrossSV(n,s,this.m_rB,we.s_t0),we.AddVCrossSV(t,i,this.m_rA,we.s_t1),r.SolveVelocityConstraints_s_Cdot1),f=Pe.MulM33XY(this.m_mass,_.x,_.y,r.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=f.x,this.m_impulse.y+=f.y;var d=f;t.SelfMulSub(a,d),i-=u*we.CrossVV(this.m_rA,d),n.SelfMulAdd(o,d),s+=h*we.CrossVV(this.m_rB,d)}else{var m=we.SubVV(we.AddVCrossSV(n,s,this.m_rB,we.s_t0),we.AddVCrossSV(t,i,this.m_rA,we.s_t1),r.SolveVelocityConstraints_s_Cdot1),p=s-i,v=Pe.MulM33XYZ(this.m_mass,m.x,m.y,p,r.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(v);var y=r.SolveVelocityConstraints_s_P.Set(v.x,v.y);t.SelfMulSub(a,y),i-=u*(we.CrossVV(this.m_rA,y)+v.z),n.SelfMulAdd(o,y),s+=h*(we.CrossVV(this.m_rB,y)+v.z)}e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=s}},{key:"SolvePositionConstraints",value:function(e){var t=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,n=e.positions[this.m_indexB].c,s=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),u=this.m_invMassA,h=this.m_invMassB,l=this.m_invIA,c=this.m_invIB;we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var _=Me.MulRV(a,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var f,d,m=Me.MulRV(o,this.m_lalcB,this.m_rB),v=this.m_K;if(v.ex.x=u+h+_.y*_.y*l+m.y*m.y*c,v.ey.x=-_.y*_.x*l-m.y*m.x*c,v.ez.x=-_.y*l-m.y*c,v.ex.y=v.ey.x,v.ey.y=u+h+_.x*_.x*l+m.x*m.x*c,v.ez.y=_.x*l+m.x*c,v.ex.z=v.ez.x,v.ey.z=v.ez.y,v.ez.z=l+c,this.m_frequencyHz>0){var g=we.SubVV(we.AddVV(n,m,we.s_t0),we.AddVV(t,_,we.s_t1),r.SolvePositionConstraints_s_C1);f=g.Length(),d=0;var S=v.Solve22(g.x,g.y,r.SolvePositionConstraints_s_P).SelfNeg();t.SelfMulSub(u,S),i-=l*we.CrossVV(_,S),n.SelfMulAdd(h,S),s+=c*we.CrossVV(m,S)}else{var A=we.SubVV(we.AddVV(n,m,we.s_t0),we.AddVV(t,_,we.s_t1),r.SolvePositionConstraints_s_C1),T=s-i-this.m_referenceAngle;f=A.Length(),d=oe(T);var E=v.Solve33(A.x,A.y,T,r.SolvePositionConstraints_s_impulse).SelfNeg(),b=r.SolvePositionConstraints_s_P.Set(E.x,E.y);t.SelfMulSub(u,b),i-=l*(we.CrossVV(this.m_rA,b)+E.z),n.SelfMulAdd(h,b),s+=c*(we.CrossVV(this.m_rB,b)+E.z)}return e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=s,f<=p&&d<=y}},{key:"GetAnchorA",value:function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return t.x=e*this.m_impulse.x,t.y=e*this.m_impulse.y,t}},{key:"GetReactionTorque",value:function(e){return e*this.m_impulse.z}},{key:"GetLocalAnchorA",value:function(){return this.m_localAnchorA}},{key:"GetLocalAnchorB",value:function(){return this.m_localAnchorB}},{key:"GetReferenceAngle",value:function(){return this.m_referenceAngle}},{key:"SetFrequency",value:function(e){this.m_frequencyHz=e}},{key:"GetFrequency",value:function(){return this.m_frequencyHz}},{key:"SetDampingRatio",value:function(e){this.m_dampingRatio=e}},{key:"GetDampingRatio",value:function(){return this.m_dampingRatio}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;e("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),e("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),e("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}]),r}(wn);Jn.InitVelocityConstraints_s_P=new we,Jn.SolveVelocityConstraints_s_Cdot1=new we,Jn.SolveVelocityConstraints_s_impulse1=new we,Jn.SolveVelocityConstraints_s_impulse=new Ie,Jn.SolveVelocityConstraints_s_P=new we,Jn.SolvePositionConstraints_s_C1=new we,Jn.SolvePositionConstraints_s_P=new we,Jn.SolvePositionConstraints_s_impulse=new Ie;var Zn=function(t){h(r,t);var i=v(r);function r(){var t;return n(this,r),(t=i.call(this,e.b2JointType.e_wheelJoint)).localAnchorA=new we(0,0),t.localAnchorB=new we(0,0),t.localAxisA=new we(1,0),t.enableMotor=!1,t.maxMotorTorque=0,t.motorSpeed=0,t.frequencyHz=2,t.dampingRatio=.7,t}return s(r,[{key:"Initialize",value:function(e,t,i,n){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA)}}]),r}(xn),$n=function(e){h(r,e);var t=v(r);function r(e){var s;return n(this,r),(s=t.call(this,e)).m_frequencyHz=0,s.m_dampingRatio=0,s.m_localAnchorA=new we,s.m_localAnchorB=new we,s.m_localXAxisA=new we,s.m_localYAxisA=new we,s.m_impulse=0,s.m_motorImpulse=0,s.m_springImpulse=0,s.m_maxMotorTorque=0,s.m_motorSpeed=0,s.m_enableMotor=!1,s.m_indexA=0,s.m_indexB=0,s.m_localCenterA=new we,s.m_localCenterB=new we,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_ax=new we,s.m_ay=new we,s.m_sAx=0,s.m_sBx=0,s.m_sAy=0,s.m_sBy=0,s.m_mass=0,s.m_motorMass=0,s.m_springMass=0,s.m_bias=0,s.m_gamma=0,s.m_qA=new Me,s.m_qB=new Me,s.m_lalcA=new we,s.m_lalcB=new we,s.m_rA=new we,s.m_rB=new we,s.m_frequencyHz=i(e.frequencyHz,2),s.m_dampingRatio=i(e.dampingRatio,.7),s.m_localAnchorA.Copy(i(e.localAnchorA,we.ZERO)),s.m_localAnchorB.Copy(i(e.localAnchorB,we.ZERO)),s.m_localXAxisA.Copy(i(e.localAxisA,we.UNITX)),we.CrossOneV(s.m_localXAxisA,s.m_localYAxisA),s.m_maxMotorTorque=i(e.maxMotorTorque,0),s.m_motorSpeed=i(e.motorSpeed,0),s.m_enableMotor=i(e.enableMotor,!1),s.m_ax.SetZero(),s.m_ay.SetZero(),s}return s(r,[{key:"GetMotorSpeed",value:function(){return this.m_motorSpeed}},{key:"GetMaxMotorTorque",value:function(){return this.m_maxMotorTorque}},{key:"SetSpringFrequencyHz",value:function(e){this.m_frequencyHz=e}},{key:"GetSpringFrequencyHz",value:function(){return this.m_frequencyHz}},{key:"SetSpringDampingRatio",value:function(e){this.m_dampingRatio=e}},{key:"GetSpringDampingRatio",value:function(){return this.m_dampingRatio}},{key:"InitVelocityConstraints",value:function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var t=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,s=this.m_invIB,a=e.positions[this.m_indexA].c,o=e.positions[this.m_indexA].a,h=e.velocities[this.m_indexA].v,l=e.velocities[this.m_indexA].w,c=e.positions[this.m_indexB].c,_=e.positions[this.m_indexB].a,f=e.velocities[this.m_indexB].v,d=e.velocities[this.m_indexB].w,m=this.m_qA.SetAngle(o),p=this.m_qB.SetAngle(_);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var v=Me.MulRV(m,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var y=Me.MulRV(p,this.m_lalcB,this.m_rB),g=we.SubVV(we.AddVV(c,y,we.s_t0),we.AddVV(a,v,we.s_t1),r.InitVelocityConstraints_s_d);if(Me.MulRV(m,this.m_localYAxisA,this.m_ay),this.m_sAy=we.CrossVV(we.AddVV(g,v,we.s_t0),this.m_ay),this.m_sBy=we.CrossVV(y,this.m_ay),this.m_mass=t+i+n*this.m_sAy*this.m_sAy+s*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){Me.MulRV(m,this.m_localXAxisA,this.m_ax),this.m_sAx=we.CrossVV(we.AddVV(g,v,we.s_t0),this.m_ax),this.m_sBx=we.CrossVV(y,this.m_ax);var S=t+i+n*this.m_sAx*this.m_sAx+s*this.m_sBx*this.m_sBx;if(S>0){this.m_springMass=1/S;var A=we.DotVV(g,this.m_ax),T=2*u*this.m_frequencyHz,E=2*this.m_springMass*this.m_dampingRatio*T,b=this.m_springMass*T*T,C=e.step.dt;this.m_gamma=C*(E+C*b),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=A*C*b*this.m_gamma,this.m_springMass=S+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=n+s,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse*=e.step.dtRatio,this.m_springImpulse*=e.step.dtRatio,this.m_motorImpulse*=e.step.dtRatio;var R=we.AddVV(we.MulSV(this.m_impulse,this.m_ay,we.s_t0),we.MulSV(this.m_springImpulse,this.m_ax,we.s_t1),r.InitVelocityConstraints_s_P),x=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,w=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;h.SelfMulSub(this.m_invMassA,R),l-=this.m_invIA*x,f.SelfMulAdd(this.m_invMassB,R),d+=this.m_invIB*w}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;e.velocities[this.m_indexA].w=l,e.velocities[this.m_indexB].w=d}},{key:"SolveVelocityConstraints",value:function(e){var t=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,s=this.m_invIB,a=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,u=e.velocities[this.m_indexB].v,h=e.velocities[this.m_indexB].w,l=we.DotVV(this.m_ax,we.SubVV(u,a,we.s_t0))+this.m_sBx*h-this.m_sAx*o,c=-this.m_springMass*(l+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=c;var _=we.MulSV(c,this.m_ax,r.SolveVelocityConstraints_s_P),f=c*this.m_sAx,d=c*this.m_sBx;a.SelfMulSub(t,_),o-=n*f,u.SelfMulAdd(i,_);var m=(h+=s*d)-o-this.m_motorSpeed,p=-this.m_motorMass*m,v=this.m_motorImpulse,y=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=le(this.m_motorImpulse+p,-y,y),o-=n*(p=this.m_motorImpulse-v),h+=s*p;var g=we.DotVV(this.m_ay,we.SubVV(u,a,we.s_t0))+this.m_sBy*h-this.m_sAy*o,S=-this.m_mass*g;this.m_impulse+=S;var A=we.MulSV(S,this.m_ay,r.SolveVelocityConstraints_s_P),T=S*this.m_sAy,E=S*this.m_sBy;a.SelfMulSub(t,A),o-=n*T,u.SelfMulAdd(i,A),h+=s*E,e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=h}},{key:"SolvePositionConstraints",value:function(e){var t=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,n=e.positions[this.m_indexB].c,s=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);we.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var u=Me.MulRV(a,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h,l=Me.MulRV(o,this.m_lalcB,this.m_rB),c=we.AddVV(we.SubVV(n,t,we.s_t0),we.SubVV(l,u,we.s_t1),r.SolvePositionConstraints_s_d),_=Me.MulRV(a,this.m_localYAxisA,this.m_ay),f=we.CrossVV(we.AddVV(c,u,we.s_t0),_),d=we.CrossVV(l,_),m=we.DotVV(c,this.m_ay),v=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;h=0!==v?-m/v:0;var y=we.MulSV(h,_,r.SolvePositionConstraints_s_P),g=h*f,S=h*d;return t.SelfMulSub(this.m_invMassA,y),i-=this.m_invIA*g,n.SelfMulAdd(this.m_invMassB,y),s+=this.m_invIB*S,e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=s,oe(m)<=p}},{key:"GetDefinition",value:function(e){return e}},{key:"GetAnchorA",value:function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)}},{key:"GetAnchorB",value:function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)}},{key:"GetReactionForce",value:function(e,t){return t.x=e*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),t.y=e*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),t}},{key:"GetReactionTorque",value:function(e){return e*this.m_motorImpulse}},{key:"GetLocalAnchorA",value:function(){return this.m_localAnchorA}},{key:"GetLocalAnchorB",value:function(){return this.m_localAnchorB}},{key:"GetLocalAxisA",value:function(){return this.m_localXAxisA}},{key:"GetJointTranslation",value:function(){return this.GetPrismaticJointTranslation()}},{key:"GetJointLinearSpeed",value:function(){return this.GetPrismaticJointSpeed()}},{key:"GetJointAngle",value:function(){return this.GetRevoluteJointAngle()}},{key:"GetJointAngularSpeed",value:function(){return this.GetRevoluteJointSpeed()}},{key:"GetPrismaticJointTranslation",value:function(){var e=this.m_bodyA,t=this.m_bodyB,i=e.GetWorldPoint(this.m_localAnchorA,new we),n=t.GetWorldPoint(this.m_localAnchorB,new we),r=we.SubVV(n,i,new we),s=e.GetWorldVector(this.m_localXAxisA,new we);return we.DotVV(r,s)}},{key:"GetPrismaticJointSpeed",value:function(){var e=this.m_bodyA,t=this.m_bodyB;we.SubVV(this.m_localAnchorA,e.m_sweep.localCenter,this.m_lalcA);var i=Me.MulRV(e.m_xf.q,this.m_lalcA,this.m_rA);we.SubVV(this.m_localAnchorB,t.m_sweep.localCenter,this.m_lalcB);var n=Me.MulRV(t.m_xf.q,this.m_lalcB,this.m_rB),r=we.AddVV(e.m_sweep.c,i,we.s_t0),s=we.AddVV(t.m_sweep.c,n,we.s_t1),a=we.SubVV(s,r,we.s_t2),o=e.GetWorldVector(this.m_localXAxisA,new we),u=e.m_linearVelocity,h=t.m_linearVelocity,l=e.m_angularVelocity,c=t.m_angularVelocity;return we.DotVV(a,we.CrossSV(l,o,we.s_t0))+we.DotVV(o,we.SubVV(we.AddVCrossSV(h,c,n,we.s_t0),we.AddVCrossSV(u,l,i,we.s_t1),we.s_t0))}},{key:"GetRevoluteJointAngle",value:function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}},{key:"GetRevoluteJointSpeed",value:function(){var e=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-e}},{key:"IsMotorEnabled",value:function(){return this.m_enableMotor}},{key:"EnableMotor",value:function(e){e!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=e)}},{key:"SetMotorSpeed",value:function(e){e!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=e)}},{key:"SetMaxMotorTorque",value:function(e){e!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=e)}},{key:"GetMotorTorque",value:function(e){return e*this.m_motorImpulse}},{key:"Dump",value:function(e){var t=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;e("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",i),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),e("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),e("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),e("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),e("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),e("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}]),r}(wn);function er(e,t){return me(e*t)}function tr(e,t){return e>t?e:t}$n.InitVelocityConstraints_s_d=new we,$n.InitVelocityConstraints_s_P=new we,$n.SolveVelocityConstraints_s_P=new we,$n.SolvePositionConstraints_s_d=new we,$n.SolvePositionConstraints_s_P=new we;var ir=function(){function e(t){n(this,e),this._other=null,this.prev=null,this.next=null,this.contact=t}return s(e,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(e){if(null!==this._other)throw new Error;this._other=e}},{key:"Reset",value:function(){this._other=null,this.prev=null,this.next=null}}]),e}(),nr=function(){function e(){n(this,e),this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new ir(this),this.m_nodeB=new ir(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new Et,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new Et}return s(e,[{key:"GetManifold",value:function(){return this.m_manifold}},{key:"GetWorldManifold",value:function(e){var t=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.GetShapeA(),r=this.GetShapeB();e.Initialize(this.m_manifold,t.GetTransform(),n.m_radius,i.GetTransform(),r.m_radius)}},{key:"IsTouching",value:function(){return this.m_touchingFlag}},{key:"SetEnabled",value:function(e){this.m_enabledFlag=e}},{key:"IsEnabled",value:function(){return this.m_enabledFlag}},{key:"GetNext",value:function(){return this.m_next}},{key:"GetFixtureA",value:function(){return this.m_fixtureA}},{key:"GetChildIndexA",value:function(){return this.m_indexA}},{key:"GetShapeA",value:function(){return this.m_fixtureA.GetShape()}},{key:"GetFixtureB",value:function(){return this.m_fixtureB}},{key:"GetChildIndexB",value:function(){return this.m_indexB}},{key:"GetShapeB",value:function(){return this.m_fixtureB.GetShape()}},{key:"FlagForFiltering",value:function(){this.m_filterFlag=!0}},{key:"SetFriction",value:function(e){this.m_friction=e}},{key:"GetFriction",value:function(){return this.m_friction}},{key:"ResetFriction",value:function(){this.m_friction=er(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}},{key:"SetRestitution",value:function(e){this.m_restitution=e}},{key:"GetRestitution",value:function(){return this.m_restitution}},{key:"ResetRestitution",value:function(){this.m_restitution=tr(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}},{key:"SetTangentSpeed",value:function(e){this.m_tangentSpeed=e}},{key:"GetTangentSpeed",value:function(){return this.m_tangentSpeed}},{key:"Reset",value:function(e,t,i,n){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=e,this.m_fixtureB=i,this.m_indexA=t,this.m_indexB=n,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=er(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=tr(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}},{key:"Update",value:function(e){var t=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=t,this.m_enabledFlag=!0;var i=!1,n=this.m_touchingFlag,r=this.m_fixtureA.IsSensor(),s=this.m_fixtureB.IsSensor(),a=r||s,o=this.m_fixtureA.GetBody(),u=this.m_fixtureB.GetBody(),h=o.GetTransform(),l=u.GetTransform();if(a){var c=this.GetShapeA(),_=this.GetShapeB();i=Dt(c,this.m_indexA,_,this.m_indexB,h,l),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,h,l),i=this.m_manifold.pointCount>0;for(var f=0;f<this.m_manifold.pointCount;++f){var d=this.m_manifold.points[f];d.normalImpulse=0,d.tangentImpulse=0;for(var m=d.id,p=0;p<this.m_oldManifold.pointCount;++p){var v=this.m_oldManifold.points[p];if(v.id.key===m.key){d.normalImpulse=v.normalImpulse,d.tangentImpulse=v.tangentImpulse;break}}}i!==n&&(o.SetAwake(!0),u.SetAwake(!0))}this.m_touchingFlag=i,!n&&i&&e&&e.BeginContact(this),n&&!i&&e&&e.EndContact(this),!a&&i&&e&&e.PreSolve(this,this.m_oldManifold)}},{key:"ComputeTOI",value:function(t,i){var n=e.ComputeTOI_s_input;n.proxyA.SetShape(this.GetShapeA(),this.m_indexA),n.proxyB.SetShape(this.GetShapeB(),this.m_indexB),n.sweepA.Copy(t),n.sweepB.Copy(i),n.tMax=p;var r=e.ComputeTOI_s_output;return fi(r,n),r.t}}]),e}();nr.ComputeTOI_s_input=new ei,nr.ComputeTOI_s_output=new ii;var rr=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"Evaluate",value:function(e,t,i){pi(e,this.GetShapeA(),t,this.GetShapeB(),i)}}],[{key:"Create",value:function(){return new i}},{key:"Destroy",value:function(){}}]),i}(nr),sr=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"Evaluate",value:function(e,t,i){Wi(e,this.GetShapeA(),t,this.GetShapeB(),i)}}],[{key:"Create",value:function(){return new i}},{key:"Destroy",value:function(){}}]),i}(nr),ar=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"Evaluate",value:function(e,t,i){Si(e,this.GetShapeA(),t,this.GetShapeB(),i)}}],[{key:"Create",value:function(){return new i}},{key:"Destroy",value:function(){}}]),i}(nr),or=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"Evaluate",value:function(e,t,i){en(e,this.GetShapeA(),t,this.GetShapeB(),i)}}],[{key:"Create",value:function(){return new i}},{key:"Destroy",value:function(){}}]),i}(nr),ur=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"Evaluate",value:function(e,t,i){un(e,this.GetShapeA(),t,this.GetShapeB(),i)}}],[{key:"Create",value:function(){return new i}},{key:"Destroy",value:function(){}}]),i}(nr),hr=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"Evaluate",value:function(e,t,n){var r=i.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),en(e,r,t,this.GetShapeB(),n)}}],[{key:"Create",value:function(){return new i}},{key:"Destroy",value:function(){}}]),i}(nr);hr.Evaluate_s_edge=new dn;var lr=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"Evaluate",value:function(e,t,n){var r=i.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),un(e,r,t,this.GetShapeB(),n)}}],[{key:"Create",value:function(){return new i}},{key:"Destroy",value:function(){}}]),i}(nr);lr.Evaluate_s_edge=new dn;var cr=function e(){n(this,e),this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1},_r=function(){function t(){n(this,t),this.m_registers=[],this.InitializeRegisters()}return s(t,[{key:"AddType",value:function(e,t,i,n){var r=[];function s(){return r.pop()||e()}function a(e){r.push(e)}this.m_registers[i][n].pool=r,this.m_registers[i][n].createFcn=s,this.m_registers[i][n].destroyFcn=a,this.m_registers[i][n].primary=!0,i!==n&&(this.m_registers[n][i].pool=r,this.m_registers[n][i].createFcn=s,this.m_registers[n][i].destroyFcn=a,this.m_registers[n][i].primary=!1)}},{key:"InitializeRegisters",value:function(){for(var t=0;t<e.b2ShapeType.e_shapeTypeCount;t++){this.m_registers[t]=[];for(var i=0;i<e.b2ShapeType.e_shapeTypeCount;i++)this.m_registers[t][i]=new cr}this.AddType(rr.Create,rr.Destroy,e.b2ShapeType.e_circleShape,e.b2ShapeType.e_circleShape),this.AddType(ar.Create,ar.Destroy,e.b2ShapeType.e_polygonShape,e.b2ShapeType.e_circleShape),this.AddType(sr.Create,sr.Destroy,e.b2ShapeType.e_polygonShape,e.b2ShapeType.e_polygonShape),this.AddType(or.Create,or.Destroy,e.b2ShapeType.e_edgeShape,e.b2ShapeType.e_circleShape),this.AddType(ur.Create,ur.Destroy,e.b2ShapeType.e_edgeShape,e.b2ShapeType.e_polygonShape),this.AddType(hr.Create,hr.Destroy,e.b2ShapeType.e_chainShape,e.b2ShapeType.e_circleShape),this.AddType(lr.Create,lr.Destroy,e.b2ShapeType.e_chainShape,e.b2ShapeType.e_polygonShape)}},{key:"Create",value:function(e,t,i,n){var r=e.GetType(),s=i.GetType(),a=this.m_registers[r][s];if(a.createFcn){var o=a.createFcn();return a.primary?o.Reset(e,t,i,n):o.Reset(i,n,e,t),o}return null}},{key:"Destroy",value:function(e){var t=e.m_fixtureA.GetType(),i=e.m_fixtureB.GetType(),n=this.m_registers[t][i];n.destroyFcn&&n.destroyFcn(e)}}]),t}(),fr=function(){function e(){n(this,e)}return s(e,[{key:"SayGoodbyeJoint",value:function(){}},{key:"SayGoodbyeFixture",value:function(){}},{key:"SayGoodbyeParticleGroup",value:function(){}},{key:"SayGoodbyeParticle",value:function(){}}]),e}(),dr=function(){function t(){n(this,t)}return s(t,[{key:"ShouldCollide",value:function(t,i){var n=t.GetBody(),r=i.GetBody();if(r.GetType()===e.b2BodyType.b2_staticBody&&n.GetType()===e.b2BodyType.b2_staticBody)return!1;if(!r.ShouldCollideConnected(n))return!1;var s=t.GetFilterData(),a=i.GetFilterData();return s.groupIndex===a.groupIndex&&0!==s.groupIndex?s.groupIndex>0:0!=(s.maskBits&a.categoryBits)&&0!=(s.categoryBits&a.maskBits)}},{key:"ShouldCollideFixtureParticle",value:function(){return!0}},{key:"ShouldCollideParticleParticle",value:function(){return!0}}]),t}();dr.b2_defaultFilter=new dr;var mr=function e(){n(this,e),this.normalImpulses=ne(c),this.tangentImpulses=ne(c),this.count=0},pr=function(){function e(){n(this,e)}return s(e,[{key:"BeginContact",value:function(){}},{key:"EndContact",value:function(){}},{key:"BeginContactFixtureParticle",value:function(){}},{key:"EndContactFixtureParticle",value:function(){}},{key:"BeginContactParticleParticle",value:function(){}},{key:"EndContactParticleParticle",value:function(){}},{key:"PreSolve",value:function(){}},{key:"PostSolve",value:function(){}}]),e}();pr.b2_defaultListener=new pr;var vr=function(){function e(){n(this,e)}return s(e,[{key:"ReportFixture",value:function(){return!0}},{key:"ReportParticle",value:function(){return!1}},{key:"ShouldQueryParticleSystem",value:function(){return!0}}]),e}(),yr=function(){function e(){n(this,e)}return s(e,[{key:"ReportFixture",value:function(e,t,i,n){return n}},{key:"ReportParticle",value:function(){return 0}},{key:"ShouldQueryParticleSystem",value:function(){return!0}}]),e}(),gr=function(){function t(){n(this,t),this.m_broadPhase=new zt,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=dr.b2_defaultFilter,this.m_contactListener=pr.b2_defaultListener,this.m_contactFactory=new _r}return s(t,[{key:"AddPair",value:function(e,t){var i=e.fixture,n=t.fixture,r=e.childIndex,s=t.childIndex,a=i.GetBody(),o=n.GetBody();if(a!==o){for(var u=o.GetContactList();u;){if(u.other===a){var h=u.contact.GetFixtureA(),l=u.contact.GetFixtureB(),c=u.contact.GetChildIndexA(),_=u.contact.GetChildIndexB();if(h===i&&l===n&&c===r&&_===s)return;if(h===n&&l===i&&c===s&&_===r)return}u=u.next}if(!this.m_contactFilter||this.m_contactFilter.ShouldCollide(i,n)){var f=this.m_contactFactory.Create(i,r,n,s);null!==f&&(i=f.GetFixtureA(),n=f.GetFixtureB(),r=f.GetChildIndexA(),s=f.GetChildIndexB(),a=i.m_body,o=n.m_body,f.m_prev=null,f.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=f),this.m_contactList=f,f.m_nodeA.other=o,f.m_nodeA.prev=null,f.m_nodeA.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=f.m_nodeA),a.m_contactList=f.m_nodeA,f.m_nodeB.other=a,f.m_nodeB.prev=null,f.m_nodeB.next=o.m_contactList,null!==o.m_contactList&&(o.m_contactList.prev=f.m_nodeB),o.m_contactList=f.m_nodeB,i.IsSensor()||n.IsSensor()||(a.SetAwake(!0),o.SetAwake(!0)),++this.m_contactCount)}}}},{key:"FindNewContacts",value:function(){var e=this;this.m_broadPhase.UpdatePairs((function(t,i){e.AddPair(t,i)}))}},{key:"Destroy",value:function(e){var t=e.GetFixtureA(),i=e.GetFixtureB(),n=t.GetBody(),r=i.GetBody();this.m_contactListener&&e.IsTouching()&&this.m_contactListener.EndContact(e),e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_contactList&&(this.m_contactList=e.m_next),e.m_nodeA.prev&&(e.m_nodeA.prev.next=e.m_nodeA.next),e.m_nodeA.next&&(e.m_nodeA.next.prev=e.m_nodeA.prev),e.m_nodeA===n.m_contactList&&(n.m_contactList=e.m_nodeA.next),e.m_nodeB.prev&&(e.m_nodeB.prev.next=e.m_nodeB.next),e.m_nodeB.next&&(e.m_nodeB.next.prev=e.m_nodeB.prev),e.m_nodeB===r.m_contactList&&(r.m_contactList=e.m_nodeB.next),e.m_manifold.pointCount>0&&!t.IsSensor()&&!i.IsSensor()&&(t.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(e),--this.m_contactCount}},{key:"Collide",value:function(){for(var t=this.m_contactList;t;){var i=t.GetFixtureA(),n=t.GetFixtureB(),r=t.GetChildIndexA(),s=t.GetChildIndexB(),a=i.GetBody(),o=n.GetBody();if(t.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n)){var u=t;t=u.m_next,this.Destroy(u);continue}t.m_filterFlag=!1}var h=a.IsAwake()&&a.m_type!==e.b2BodyType.b2_staticBody,l=o.IsAwake()&&o.m_type!==e.b2BodyType.b2_staticBody;if(h||l){var c=i.m_proxies[r].treeNode,_=n.m_proxies[s].treeNode;if(It(c.aabb,_.aabb))t.Update(this.m_contactListener),t=t.m_next;else{var f=t;t=f.m_next,this.Destroy(f)}}else t=t.m_next}}}]),t}(),Sr=function(){function e(){n(this,e),this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}return s(e,[{key:"Reset",value:function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}]),e}(),Ar=function(){function e(){n(this,e),this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}return s(e,[{key:"Copy",value:function(e){return this.dt=e.dt,this.inv_dt=e.inv_dt,this.dtRatio=e.dtRatio,this.positionIterations=e.positionIterations,this.velocityIterations=e.velocityIterations,this.particleIterations=e.particleIterations,this.warmStarting=e.warmStarting,this}}]),e}(),Tr=function(){function e(){n(this,e),this.c=new we,this.a=0}return s(e,null,[{key:"MakeArray",value:function(t){return te(t,(function(){return new e}))}}]),e}(),Er=function(){function e(){n(this,e),this.v=new we,this.w=0}return s(e,null,[{key:"MakeArray",value:function(t){return te(t,(function(){return new e}))}}]),e}(),br=function e(){n(this,e),this.step=new Ar},Cr=!1,Rr=function(){function e(){n(this,e),this.rA=new we,this.rB=new we,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return s(e,null,[{key:"MakeArray",value:function(t){return te(t,(function(){return new e}))}}]),e}(),xr=function(){function e(){n(this,e),this.points=Rr.MakeArray(c),this.normal=new we,this.tangent=new we,this.normalMass=new Be,this.K=new Be,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}return s(e,null,[{key:"MakeArray",value:function(t){return te(t,(function(){return new e}))}}]),e}(),wr=function(){function t(){n(this,t),this.localPoints=we.MakeArray(c),this.localNormal=new we,this.localPoint=new we,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new we,this.localCenterB=new we,this.invIA=0,this.invIB=0,this.type=e.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}return s(t,null,[{key:"MakeArray",value:function(e){return te(e,(function(){return new t}))}}]),t}(),kr=function e(){n(this,e),this.step=new Ar,this.count=0},Ir=function(){function t(){n(this,t),this.normal=new we,this.point=new we,this.separation=0}return s(t,[{key:"Initialize",value:function(i,n,r,s){var a=t.Initialize_s_pointA,o=t.Initialize_s_pointB,u=t.Initialize_s_planePoint,h=t.Initialize_s_clipPoint;switch(i.type){case e.b2ManifoldType.e_circles:Oe.MulXV(n,i.localPoint,a),Oe.MulXV(r,i.localPoints[0],o),we.SubVV(o,a,this.normal).SelfNormalize(),we.MidVV(a,o,this.point),this.separation=we.DotVV(we.SubVV(o,a,we.s_t0),this.normal)-i.radiusA-i.radiusB;break;case e.b2ManifoldType.e_faceA:Me.MulRV(n.q,i.localNormal,this.normal),Oe.MulXV(n,i.localPoint,u),Oe.MulXV(r,i.localPoints[s],h),this.separation=we.DotVV(we.SubVV(h,u,we.s_t0),this.normal)-i.radiusA-i.radiusB,this.point.Copy(h);break;case e.b2ManifoldType.e_faceB:Me.MulRV(r.q,i.localNormal,this.normal),Oe.MulXV(r,i.localPoint,u),Oe.MulXV(n,i.localPoints[s],h),this.separation=we.DotVV(we.SubVV(h,u,we.s_t0),this.normal)-i.radiusA-i.radiusB,this.point.Copy(h),this.normal.SelfNeg()}}}]),t}();Ir.Initialize_s_pointA=new we,Ir.Initialize_s_pointB=new we,Ir.Initialize_s_planePoint=new we,Ir.Initialize_s_clipPoint=new we;var Br=function(){function e(){n(this,e),this.m_step=new Ar,this.m_positionConstraints=wr.MakeArray(1024),this.m_velocityConstraints=xr.MakeArray(1024),this.m_count=0}return s(e,[{key:"Initialize",value:function(e){if(this.m_step.Copy(e.step),this.m_count=e.count,this.m_positionConstraints.length<this.m_count)for(var t=he(2*this.m_positionConstraints.length,this.m_count);this.m_positionConstraints.length<t;)this.m_positionConstraints[this.m_positionConstraints.length]=new wr;if(this.m_velocityConstraints.length<this.m_count)for(var i=he(2*this.m_velocityConstraints.length,this.m_count);this.m_velocityConstraints.length<i;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new xr;this.m_positions=e.positions,this.m_velocities=e.velocities,this.m_contacts=e.contacts;for(var n=0;n<this.m_count;++n){var r=this.m_contacts[n],s=r.m_fixtureA,a=r.m_fixtureB,o=s.GetShape(),u=a.GetShape(),h=o.m_radius,l=u.m_radius,c=s.GetBody(),_=a.GetBody(),f=r.GetManifold(),d=f.pointCount,m=this.m_velocityConstraints[n];m.friction=r.m_friction,m.restitution=r.m_restitution,m.tangentSpeed=r.m_tangentSpeed,m.indexA=c.m_islandIndex,m.indexB=_.m_islandIndex,m.invMassA=c.m_invMass,m.invMassB=_.m_invMass,m.invIA=c.m_invI,m.invIB=_.m_invI,m.contactIndex=n,m.pointCount=d,m.K.SetZero(),m.normalMass.SetZero();var p=this.m_positionConstraints[n];p.indexA=c.m_islandIndex,p.indexB=_.m_islandIndex,p.invMassA=c.m_invMass,p.invMassB=_.m_invMass,p.localCenterA.Copy(c.m_sweep.localCenter),p.localCenterB.Copy(_.m_sweep.localCenter),p.invIA=c.m_invI,p.invIB=_.m_invI,p.localNormal.Copy(f.localNormal),p.localPoint.Copy(f.localPoint),p.pointCount=d,p.radiusA=h,p.radiusB=l,p.type=f.type;for(var v=0;v<d;++v){var y=f.points[v],g=m.points[v];this.m_step.warmStarting?(g.normalImpulse=this.m_step.dtRatio*y.normalImpulse,g.tangentImpulse=this.m_step.dtRatio*y.tangentImpulse):(g.normalImpulse=0,g.tangentImpulse=0),g.rA.SetZero(),g.rB.SetZero(),g.normalMass=0,g.tangentMass=0,g.velocityBias=0,p.localPoints[v].Copy(y.localPoint)}}return this}},{key:"InitializeVelocityConstraints",value:function(){for(var t=e.InitializeVelocityConstraints_s_xfA,i=e.InitializeVelocityConstraints_s_xfB,n=e.InitializeVelocityConstraints_s_worldManifold,r=1e3,s=0;s<this.m_count;++s){var a=this.m_velocityConstraints[s],o=this.m_positionConstraints[s],u=o.radiusA,h=o.radiusB,l=this.m_contacts[a.contactIndex].GetManifold(),c=a.indexA,_=a.indexB,f=a.invMassA,d=a.invMassB,m=a.invIA,p=a.invIB,v=o.localCenterA,y=o.localCenterB,g=this.m_positions[c].c,S=this.m_positions[c].a,A=this.m_velocities[c].v,T=this.m_velocities[c].w,b=this.m_positions[_].c,C=this.m_positions[_].a,R=this.m_velocities[_].v,x=this.m_velocities[_].w;t.q.SetAngle(S),i.q.SetAngle(C),we.SubVV(g,Me.MulRV(t.q,v,we.s_t0),t.p),we.SubVV(b,Me.MulRV(i.q,y,we.s_t0),i.p),n.Initialize(l,t,u,i,h),a.normal.Copy(n.normal),we.CrossVOne(a.normal,a.tangent);for(var w=a.pointCount,k=0;k<w;++k){var I=a.points[k];we.SubVV(n.points[k],g,I.rA),we.SubVV(n.points[k],b,I.rB);var B=we.CrossVV(I.rA,a.normal),P=we.CrossVV(I.rB,a.normal),M=f+d+m*B*B+p*P*P;I.normalMass=M>0?1/M:0;var O=a.tangent,D=we.CrossVV(I.rA,O),L=we.CrossVV(I.rB,O),N=f+d+m*D*D+p*L*L;I.tangentMass=N>0?1/N:0,I.velocityBias=0;var F=we.DotVV(a.normal,we.SubVV(we.AddVCrossSV(R,x,I.rB,we.s_t0),we.AddVCrossSV(A,T,I.rA,we.s_t1),we.s_t0));F<-E&&(I.velocityBias+=-a.restitution*F)}if(2===a.pointCount&&Cr){var G=a.points[0],V=a.points[1],U=we.CrossVV(G.rA,a.normal),H=we.CrossVV(G.rB,a.normal),z=we.CrossVV(V.rA,a.normal),W=we.CrossVV(V.rB,a.normal),X=f+d+m*U*U+p*H*H,j=f+d+m*z*z+p*W*W,q=f+d+m*U*z+p*H*W;X*X<r*(X*j-q*q)?(a.K.ex.Set(X,q),a.K.ey.Set(q,j),a.K.GetInverse(a.normalMass)):a.pointCount=1}}}},{key:"WarmStart",value:function(){for(var t=e.WarmStart_s_P,i=0;i<this.m_count;++i){for(var n=this.m_velocityConstraints[i],r=n.indexA,s=n.indexB,a=n.invMassA,o=n.invIA,u=n.invMassB,h=n.invIB,l=n.pointCount,c=this.m_velocities[r].v,_=this.m_velocities[r].w,f=this.m_velocities[s].v,d=this.m_velocities[s].w,m=n.normal,p=n.tangent,v=0;v<l;++v){var y=n.points[v];we.AddVV(we.MulSV(y.normalImpulse,m,we.s_t0),we.MulSV(y.tangentImpulse,p,we.s_t1),t),_-=o*we.CrossVV(y.rA,t),c.SelfMulSub(a,t),d+=h*we.CrossVV(y.rB,t),f.SelfMulAdd(u,t)}this.m_velocities[r].w=_,this.m_velocities[s].w=d}}},{key:"SolveVelocityConstraints",value:function(){for(var t=e.SolveVelocityConstraints_s_dv,i=e.SolveVelocityConstraints_s_dv1,n=e.SolveVelocityConstraints_s_dv2,r=e.SolveVelocityConstraints_s_P,s=e.SolveVelocityConstraints_s_a,a=e.SolveVelocityConstraints_s_b,o=e.SolveVelocityConstraints_s_x,u=e.SolveVelocityConstraints_s_d,h=e.SolveVelocityConstraints_s_P1,l=e.SolveVelocityConstraints_s_P2,c=e.SolveVelocityConstraints_s_P1P2,_=0;_<this.m_count;++_){for(var f=this.m_velocityConstraints[_],d=f.indexA,m=f.indexB,p=f.invMassA,v=f.invIA,y=f.invMassB,g=f.invIB,S=f.pointCount,A=this.m_velocities[d].v,T=this.m_velocities[d].w,E=this.m_velocities[m].v,b=this.m_velocities[m].w,C=f.normal,R=f.tangent,x=f.friction,w=0;w<S;++w){var k=f.points[w];we.SubVV(we.AddVCrossSV(E,b,k.rB,we.s_t0),we.AddVCrossSV(A,T,k.rA,we.s_t1),t);var I=we.DotVV(t,R)-f.tangentSpeed,B=k.tangentMass*-I,P=x*k.normalImpulse,M=le(k.tangentImpulse+B,-P,P);B=M-k.tangentImpulse,k.tangentImpulse=M,we.MulSV(B,R,r),A.SelfMulSub(p,r),T-=v*we.CrossVV(k.rA,r),E.SelfMulAdd(y,r),b+=g*we.CrossVV(k.rB,r)}if(1===f.pointCount||!1===Cr)for(var O=0;O<S;++O){var D=f.points[O];we.SubVV(we.AddVCrossSV(E,b,D.rB,we.s_t0),we.AddVCrossSV(A,T,D.rA,we.s_t1),t);var L=we.DotVV(t,C),N=-D.normalMass*(L-D.velocityBias),F=he(D.normalImpulse+N,0);N=F-D.normalImpulse,D.normalImpulse=F,we.MulSV(N,C,r),A.SelfMulSub(p,r),T-=v*we.CrossVV(D.rA,r),E.SelfMulAdd(y,r),b+=g*we.CrossVV(D.rB,r)}else{var G=f.points[0],V=f.points[1];s.Set(G.normalImpulse,V.normalImpulse),we.SubVV(we.AddVCrossSV(E,b,G.rB,we.s_t0),we.AddVCrossSV(A,T,G.rA,we.s_t1),i),we.SubVV(we.AddVCrossSV(E,b,V.rB,we.s_t0),we.AddVCrossSV(A,T,V.rA,we.s_t1),n);var U=we.DotVV(i,C),H=we.DotVV(n,C);for(a.x=U-G.velocityBias,a.y=H-V.velocityBias,a.SelfSub(Be.MulMV(f.K,s,we.s_t0));;){if(Be.MulMV(f.normalMass,a,o).SelfNeg(),o.x>=0&&o.y>=0){we.SubVV(o,s,u),we.MulSV(u.x,C,h),we.MulSV(u.y,C,l),we.AddVV(h,l,c),A.SelfMulSub(p,c),T-=v*(we.CrossVV(G.rA,h)+we.CrossVV(V.rA,l)),E.SelfMulAdd(y,c),b+=g*(we.CrossVV(G.rB,h)+we.CrossVV(V.rB,l)),G.normalImpulse=o.x,V.normalImpulse=o.y;break}if(o.x=-G.normalMass*a.x,o.y=0,U=0,H=f.K.ex.y*o.x+a.y,o.x>=0&&H>=0){we.SubVV(o,s,u),we.MulSV(u.x,C,h),we.MulSV(u.y,C,l),we.AddVV(h,l,c),A.SelfMulSub(p,c),T-=v*(we.CrossVV(G.rA,h)+we.CrossVV(V.rA,l)),E.SelfMulAdd(y,c),b+=g*(we.CrossVV(G.rB,h)+we.CrossVV(V.rB,l)),G.normalImpulse=o.x,V.normalImpulse=o.y;break}if(o.x=0,o.y=-V.normalMass*a.y,U=f.K.ey.x*o.y+a.x,H=0,o.y>=0&&U>=0){we.SubVV(o,s,u),we.MulSV(u.x,C,h),we.MulSV(u.y,C,l),we.AddVV(h,l,c),A.SelfMulSub(p,c),T-=v*(we.CrossVV(G.rA,h)+we.CrossVV(V.rA,l)),E.SelfMulAdd(y,c),b+=g*(we.CrossVV(G.rB,h)+we.CrossVV(V.rB,l)),G.normalImpulse=o.x,V.normalImpulse=o.y;break}if(o.x=0,o.y=0,U=a.x,H=a.y,U>=0&&H>=0){we.SubVV(o,s,u),we.MulSV(u.x,C,h),we.MulSV(u.y,C,l),we.AddVV(h,l,c),A.SelfMulSub(p,c),T-=v*(we.CrossVV(G.rA,h)+we.CrossVV(V.rA,l)),E.SelfMulAdd(y,c),b+=g*(we.CrossVV(G.rB,h)+we.CrossVV(V.rB,l)),G.normalImpulse=o.x,V.normalImpulse=o.y;break}break}}this.m_velocities[d].w=T,this.m_velocities[m].w=b}}},{key:"StoreImpulses",value:function(){for(var e=0;e<this.m_count;++e)for(var t=this.m_velocityConstraints[e],i=this.m_contacts[t.contactIndex].GetManifold(),n=0;n<t.pointCount;++n)i.points[n].normalImpulse=t.points[n].normalImpulse,i.points[n].tangentImpulse=t.points[n].tangentImpulse}},{key:"SolvePositionConstraints",value:function(){for(var t=e.SolvePositionConstraints_s_xfA,i=e.SolvePositionConstraints_s_xfB,n=e.SolvePositionConstraints_s_psm,r=e.SolvePositionConstraints_s_rA,s=e.SolvePositionConstraints_s_rB,a=e.SolvePositionConstraints_s_P,o=0,u=0;u<this.m_count;++u){for(var h=this.m_positionConstraints[u],l=h.indexA,c=h.indexB,_=h.localCenterA,f=h.invMassA,d=h.invIA,m=h.localCenterB,v=h.invMassB,y=h.invIB,g=h.pointCount,S=this.m_positions[l].c,A=this.m_positions[l].a,T=this.m_positions[c].c,E=this.m_positions[c].a,C=0;C<g;++C){t.q.SetAngle(A),i.q.SetAngle(E),we.SubVV(S,Me.MulRV(t.q,_,we.s_t0),t.p),we.SubVV(T,Me.MulRV(i.q,m,we.s_t0),i.p),n.Initialize(h,t,i,C);var R=n.normal,x=n.point,w=n.separation;we.SubVV(x,S,r),we.SubVV(x,T,s),o=ue(o,w);var k=le(B*(w+p),-b,0),I=we.CrossVV(r,R),P=we.CrossVV(s,R),M=f+v+d*I*I+y*P*P,O=M>0?-k/M:0;we.MulSV(O,R,a),S.SelfMulSub(f,a),A-=d*we.CrossVV(r,a),T.SelfMulAdd(v,a),E+=y*we.CrossVV(s,a)}this.m_positions[l].a=A,this.m_positions[c].a=E}return o>-3*p}},{key:"SolveTOIPositionConstraints",value:function(t,i){for(var n=e.SolveTOIPositionConstraints_s_xfA,r=e.SolveTOIPositionConstraints_s_xfB,s=e.SolveTOIPositionConstraints_s_psm,a=e.SolveTOIPositionConstraints_s_rA,o=e.SolveTOIPositionConstraints_s_rB,u=e.SolveTOIPositionConstraints_s_P,h=0,l=0;l<this.m_count;++l){var c=this.m_positionConstraints[l],_=c.indexA,f=c.indexB,d=c.localCenterA,m=c.localCenterB,v=c.pointCount,y=0,g=0;_!==t&&_!==i||(y=c.invMassA,g=c.invIA);var S=0,A=0;f!==t&&f!==i||(S=c.invMassB,A=c.invIB);for(var T=this.m_positions[_].c,E=this.m_positions[_].a,C=this.m_positions[f].c,R=this.m_positions[f].a,x=0;x<v;++x){n.q.SetAngle(E),r.q.SetAngle(R),we.SubVV(T,Me.MulRV(n.q,d,we.s_t0),n.p),we.SubVV(C,Me.MulRV(r.q,m,we.s_t0),r.p),s.Initialize(c,n,r,x);var w=s.normal,k=s.point,I=s.separation;we.SubVV(k,T,a),we.SubVV(k,C,o),h=ue(h,I);var B=le(P*(I+p),-b,0),M=we.CrossVV(a,w),O=we.CrossVV(o,w),D=y+S+g*M*M+A*O*O,L=D>0?-B/D:0;we.MulSV(L,w,u),T.SelfMulSub(y,u),E-=g*we.CrossVV(a,u),C.SelfMulAdd(S,u),R+=A*we.CrossVV(o,u)}this.m_positions[_].a=E,this.m_positions[f].a=R}return h>=-1.5*p}}]),e}();Br.InitializeVelocityConstraints_s_xfA=new Oe,Br.InitializeVelocityConstraints_s_xfB=new Oe,Br.InitializeVelocityConstraints_s_worldManifold=new bt,Br.WarmStart_s_P=new we,Br.SolveVelocityConstraints_s_dv=new we,Br.SolveVelocityConstraints_s_dv1=new we,Br.SolveVelocityConstraints_s_dv2=new we,Br.SolveVelocityConstraints_s_P=new we,Br.SolveVelocityConstraints_s_a=new we,Br.SolveVelocityConstraints_s_b=new we,Br.SolveVelocityConstraints_s_x=new we,Br.SolveVelocityConstraints_s_d=new we,Br.SolveVelocityConstraints_s_P1=new we,Br.SolveVelocityConstraints_s_P2=new we,Br.SolveVelocityConstraints_s_P1P2=new we,Br.SolvePositionConstraints_s_xfA=new Oe,Br.SolvePositionConstraints_s_xfB=new Oe,Br.SolvePositionConstraints_s_psm=new Ir,Br.SolvePositionConstraints_s_rA=new we,Br.SolvePositionConstraints_s_rB=new we,Br.SolvePositionConstraints_s_P=new we,Br.SolveTOIPositionConstraints_s_xfA=new Oe,Br.SolveTOIPositionConstraints_s_xfB=new Oe,Br.SolveTOIPositionConstraints_s_psm=new Ir,Br.SolveTOIPositionConstraints_s_rA=new we,Br.SolveTOIPositionConstraints_s_rB=new we,Br.SolveTOIPositionConstraints_s_P=new we;var Pr,Mr=function(){function t(){n(this,t),this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=Tr.MakeArray(1024),this.m_velocities=Er.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}return s(t,[{key:"Initialize",value:function(e,t,i,n){if(this.m_bodyCapacity=e,this.m_contactCapacity=t,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=n,this.m_positions.length<e)for(var r=he(2*this.m_positions.length,e);this.m_positions.length<r;)this.m_positions[this.m_positions.length]=new Tr;if(this.m_velocities.length<e)for(var s=he(2*this.m_velocities.length,e);this.m_velocities.length<s;)this.m_velocities[this.m_velocities.length]=new Er}},{key:"Clear",value:function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}},{key:"AddBody",value:function(e){e.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=e}},{key:"AddContact",value:function(e){this.m_contacts[this.m_contactCount++]=e}},{key:"AddJoint",value:function(e){this.m_joints[this.m_jointCount++]=e}},{key:"Solve",value:function(i,n,s,a){for(var o=t.s_timer.Reset(),u=n.dt,h=0;h<this.m_bodyCount;++h){var l=this.m_bodies[h];this.m_positions[h].c.Copy(l.m_sweep.c);var c=l.m_sweep.a,_=this.m_velocities[h].v.Copy(l.m_linearVelocity),f=l.m_angularVelocity;l.m_sweep.c0.Copy(l.m_sweep.c),l.m_sweep.a0=l.m_sweep.a,l.m_type===e.b2BodyType.b2_dynamicBody&&(_.x+=u*(l.m_gravityScale*s.x+l.m_invMass*l.m_force.x),_.y+=u*(l.m_gravityScale*s.y+l.m_invMass*l.m_force.y),f+=u*l.m_invI*l.m_torque,_.SelfMul(1/(1+u*l.m_linearDamping)),f*=1/(1+u*l.m_angularDamping)),this.m_positions[h].a=c,this.m_velocities[h].w=f}o.Reset();var d=t.s_solverData;d.step.Copy(n),d.positions=this.m_positions,d.velocities=this.m_velocities;var m=t.s_contactSolverDef;m.step.Copy(n),m.contacts=this.m_contacts,m.count=this.m_contactCount,m.positions=this.m_positions,m.velocities=this.m_velocities;var p=t.s_contactSolver.Initialize(m);p.InitializeVelocityConstraints(),n.warmStarting&&p.WarmStart();for(var v=0;v<this.m_jointCount;++v)this.m_joints[v].InitVelocityConstraints(d);i.solveInit=o.GetMilliseconds(),o.Reset();for(var y=0;y<n.velocityIterations;++y){for(var g=0;g<this.m_jointCount;++g)this.m_joints[g].SolveVelocityConstraints(d);p.SolveVelocityConstraints()}p.StoreImpulses(),i.solveVelocity=o.GetMilliseconds();for(var S=0;S<this.m_bodyCount;++S){var A=this.m_positions[S].c,T=this.m_positions[S].a,E=this.m_velocities[S].v,b=this.m_velocities[S].w,C=we.MulSV(u,E,t.s_translation);if(we.DotVV(C,C)>w){var R=x/C.Length();E.SelfMul(R)}var B=u*b;B*B>I&&(b*=k/oe(B)),A.x+=u*E.x,A.y+=u*E.y,T+=u*b,this.m_positions[S].a=T,this.m_velocities[S].w=b}o.Reset();for(var P=!1,M=0;M<n.positionIterations;++M){for(var O=p.SolvePositionConstraints(),D=!0,L=0;L<this.m_jointCount;++L){var N=this.m_joints[L].SolvePositionConstraints(d);D=D&&N}if(O&&D){P=!0;break}}for(var F=0;F<this.m_bodyCount;++F){var G=this.m_bodies[F];G.m_sweep.c.Copy(this.m_positions[F].c),G.m_sweep.a=this.m_positions[F].a,G.m_linearVelocity.Copy(this.m_velocities[F].v),G.m_angularVelocity=this.m_velocities[F].w,G.SynchronizeTransform()}if(i.solvePosition=o.GetMilliseconds(),this.Report(p.m_velocityConstraints),a){for(var V=r,U=W*W,H=X*X,j=0;j<this.m_bodyCount;++j){var q=this.m_bodies[j];q.GetType()!==e.b2BodyType.b2_staticBody&&(!q.m_autoSleepFlag||q.m_angularVelocity*q.m_angularVelocity>H||we.DotVV(q.m_linearVelocity,q.m_linearVelocity)>U?(q.m_sleepTime=0,V=0):(q.m_sleepTime+=u,V=ue(V,q.m_sleepTime)))}if(V>=z&&P)for(var Y=0;Y<this.m_bodyCount;++Y)this.m_bodies[Y].SetAwake(!1)}}},{key:"SolveTOI",value:function(e,i,n){for(var r=0;r<this.m_bodyCount;++r){var s=this.m_bodies[r];this.m_positions[r].c.Copy(s.m_sweep.c),this.m_positions[r].a=s.m_sweep.a,this.m_velocities[r].v.Copy(s.m_linearVelocity),this.m_velocities[r].w=s.m_angularVelocity}var a=t.s_contactSolverDef;a.contacts=this.m_contacts,a.count=this.m_contactCount,a.step.Copy(e),a.positions=this.m_positions,a.velocities=this.m_velocities;for(var o=t.s_contactSolver.Initialize(a),u=0;u<e.positionIterations&&!o.SolveTOIPositionConstraints(i,n);++u);this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,this.m_bodies[n].m_sweep.c0.Copy(this.m_positions[n].c),this.m_bodies[n].m_sweep.a0=this.m_positions[n].a,o.InitializeVelocityConstraints();for(var h=0;h<e.velocityIterations;++h)o.SolveVelocityConstraints();for(var l=e.dt,c=0;c<this.m_bodyCount;++c){var _=this.m_positions[c].c,f=this.m_positions[c].a,d=this.m_velocities[c].v,m=this.m_velocities[c].w,p=we.MulSV(l,d,t.s_translation);if(we.DotVV(p,p)>w){var v=x/p.Length();d.SelfMul(v)}var y=l*m;y*y>I&&(m*=k/oe(y)),_.SelfMulAdd(l,d),f+=l*m,this.m_positions[c].a=f,this.m_velocities[c].w=m;var g=this.m_bodies[c];g.m_sweep.c.Copy(_),g.m_sweep.a=f,g.m_linearVelocity.Copy(d),g.m_angularVelocity=m,g.SynchronizeTransform()}this.Report(o.m_velocityConstraints)}},{key:"Report",value:function(e){if(null!==this.m_listener)for(var i=0;i<this.m_contactCount;++i){var n=this.m_contacts[i];if(n){var r=e[i],s=t.s_impulse;s.count=r.pointCount;for(var a=0;a<r.pointCount;++a)s.normalImpulses[a]=r.points[a].normalImpulse,s.tangentImpulses[a]=r.points[a].tangentImpulse;this.m_listener.PostSolve(n,s)}}}}]),t}();Mr.s_timer=new Ge,Mr.s_solverData=new br,Mr.s_contactSolverDef=new kr,Mr.s_contactSolver=new Br,Mr.s_translation=new we,Mr.s_impulse=new mr,(Pr=e.b2ParticleFlag||(e.b2ParticleFlag={}))[Pr.b2_waterParticle=0]="b2_waterParticle",Pr[Pr.b2_zombieParticle=2]="b2_zombieParticle",Pr[Pr.b2_wallParticle=4]="b2_wallParticle",Pr[Pr.b2_springParticle=8]="b2_springParticle",Pr[Pr.b2_elasticParticle=16]="b2_elasticParticle",Pr[Pr.b2_viscousParticle=32]="b2_viscousParticle",Pr[Pr.b2_powderParticle=64]="b2_powderParticle",Pr[Pr.b2_tensileParticle=128]="b2_tensileParticle",Pr[Pr.b2_colorMixingParticle=256]="b2_colorMixingParticle",Pr[Pr.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",Pr[Pr.b2_barrierParticle=1024]="b2_barrierParticle",Pr[Pr.b2_staticPressureParticle=2048]="b2_staticPressureParticle",Pr[Pr.b2_reactiveParticle=4096]="b2_reactiveParticle",Pr[Pr.b2_repulsiveParticle=8192]="b2_repulsiveParticle",Pr[Pr.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",Pr[Pr.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",Pr[Pr.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",Pr[Pr.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";var Or=function e(){n(this,e),this.flags=0,this.position=new we,this.velocity=new we,this.color=new Ne(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null};function Dr(e,t,i){var n=8,r=.01;return le(Math.ceil(Math.sqrt(e/(r*t))*i),1,n)}var Lr,Nr=function(){function e(){n(this,e),this.m_index=M}return s(e,[{key:"GetIndex",value:function(){return this.m_index}},{key:"SetIndex",value:function(e){this.m_index=e}}]),e}();(Lr=e.b2ParticleGroupFlag||(e.b2ParticleGroupFlag={}))[Lr.b2_solidParticleGroup=1]="b2_solidParticleGroup",Lr[Lr.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",Lr[Lr.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",Lr[Lr.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",Lr[Lr.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",Lr[Lr.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";var Fr=function e(){n(this,e),this.flags=0,this.groupFlags=0,this.position=new we,this.angle=0,this.linearVelocity=new we,this.angularVelocity=0,this.color=new Ne,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null},Gr=function(){function t(e){n(this,t),this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new we,this.m_linearVelocity=new we,this.m_angularVelocity=0,this.m_transform=new Oe,this.m_userData=null,this.m_system=e}return s(t,[{key:"GetNext",value:function(){return this.m_next}},{key:"GetParticleSystem",value:function(){return this.m_system}},{key:"GetParticleCount",value:function(){return this.m_lastIndex-this.m_firstIndex}},{key:"GetBufferIndex",value:function(){return this.m_firstIndex}},{key:"ContainsParticle",value:function(e){return this.m_firstIndex<=e&&e<this.m_lastIndex}},{key:"GetAllParticleFlags",value:function(){if(!this.m_system.m_flagsBuffer.data)throw new Error;for(var e=0,t=this.m_firstIndex;t<this.m_lastIndex;t++)e|=this.m_system.m_flagsBuffer.data[t];return e}},{key:"GetGroupFlags",value:function(){return this.m_groupFlags}},{key:"SetGroupFlags",value:function(t){t|=this.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,t)}},{key:"GetMass",value:function(){return this.UpdateStatistics(),this.m_mass}},{key:"GetInertia",value:function(){return this.UpdateStatistics(),this.m_inertia}},{key:"GetCenter",value:function(){return this.UpdateStatistics(),this.m_center}},{key:"GetLinearVelocity",value:function(){return this.UpdateStatistics(),this.m_linearVelocity}},{key:"GetAngularVelocity",value:function(){return this.UpdateStatistics(),this.m_angularVelocity}},{key:"GetTransform",value:function(){return this.m_transform}},{key:"GetPosition",value:function(){return this.m_transform.p}},{key:"GetAngle",value:function(){return this.m_transform.q.GetAngle()}},{key:"GetLinearVelocityFromWorldPoint",value:function(e,i){var n=t.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),we.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,we.SubVV(e,this.m_center,n),i)}},{key:"GetUserData",value:function(){return this.m_userData}},{key:"SetUserData",value:function(e){this.m_userData=e}},{key:"ApplyForce",value:function(e){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,e)}},{key:"ApplyLinearImpulse",value:function(e){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,e)}},{key:"DestroyParticles",value:function(e){if(this.m_system.m_world.IsLocked())throw new Error;for(var t=this.m_firstIndex;t<this.m_lastIndex;t++)this.m_system.DestroyParticle(t,e)}},{key:"UpdateStatistics",value:function(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;var e=new we,t=new we;if(this.m_timestamp!==this.m_system.m_timestamp){var i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(var n=this.m_firstIndex;n<this.m_lastIndex;n++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[n]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[n]);if(this.m_mass>0){var r=1/this.m_mass;this.m_center.SelfMul(r),this.m_linearVelocity.SelfMul(r)}this.m_inertia=0,this.m_angularVelocity=0;for(var s=this.m_firstIndex;s<this.m_lastIndex;s++)we.SubVV(this.m_system.m_positionBuffer.data[s],this.m_center,e),we.SubVV(this.m_system.m_velocityBuffer.data[s],this.m_linearVelocity,t),this.m_inertia+=i*we.DotVV(e,e),this.m_angularVelocity+=i*we.CrossVV(e,t);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}}}]),t}();Gr.GetLinearVelocityFromWorldPoint_s_t0=new we;var Vr=function(){function e(t){n(this,e),this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}return s(e,[{key:"m_capacity",get:function(){return this.m_buffer.length}},{key:"Push",value:function(e){if(this.m_back>=this.m_capacity){for(var t=this.m_front;t<this.m_back;t++)this.m_buffer[t-this.m_front]=this.m_buffer[t];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=e,this.m_back++}},{key:"Pop",value:function(){this.m_buffer[this.m_front]=null,this.m_front++}},{key:"Empty",value:function(){return this.m_front===this.m_back}},{key:"Front",value:function(){var e=this.m_buffer[this.m_front];if(!e)throw new Error;return e}}]),e}(),Ur=function(){function e(t){n(this,e),this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=te(t,(function(){return new Hr})),this.m_generatorCapacity=t}return s(e,[{key:"AddGenerator",value:function(e,t,i){var n=this.m_generatorBuffer[this.m_generatorCount++];n.center.Copy(e),n.tag=t,n.necessary=i}},{key:"Generate",value:function(e,t){for(var i=1/e,n=new we(+r,+r),s=new we(-r,-r),a=0,o=0;o<this.m_generatorCount;o++){var u=this.m_generatorBuffer[o];u.necessary&&(we.MinV(n,u.center,n),we.MaxV(s,u.center,s),++a)}if(0===a)return this.m_countX=0,void(this.m_countY=0);n.x-=t,n.y-=t,s.x+=t,s.y+=t,this.m_countX=1+Math.floor(i*(s.x-n.x)),this.m_countY=1+Math.floor(i*(s.y-n.y)),this.m_diagram=[];for(var h=new Vr(4*this.m_countX*this.m_countY),l=0;l<this.m_generatorCount;l++){var c=this.m_generatorBuffer[l];c.center.SelfSub(n).SelfMul(i);var _=Math.floor(c.center.x),f=Math.floor(c.center.y);_>=0&&f>=0&&_<this.m_countX&&f<this.m_countY&&h.Push(new zr(_,f,_+f*this.m_countX,c))}for(;!h.Empty();){var d=h.Front(),m=d.m_x,p=d.m_y,v=d.m_i,y=d.m_generator;h.Pop(),this.m_diagram[v]||(this.m_diagram[v]=y,m>0&&h.Push(new zr(m-1,p,v-1,y)),p>0&&h.Push(new zr(m,p-1,v-this.m_countX,y)),m<this.m_countX-1&&h.Push(new zr(m+1,p,v+1,y)),p<this.m_countY-1&&h.Push(new zr(m,p+1,v+this.m_countX,y)))}for(var g=0;g<this.m_countY;g++)for(var S=0;S<this.m_countX-1;S++){var A=S+g*this.m_countX,T=this.m_diagram[A],E=this.m_diagram[A+1];T!==E&&(h.Push(new zr(S,g,A,E)),h.Push(new zr(S+1,g,A+1,T)))}for(var b=0;b<this.m_countY-1;b++)for(var C=0;C<this.m_countX;C++){var R=C+b*this.m_countX,x=this.m_diagram[R],w=this.m_diagram[R+this.m_countX];x!==w&&(h.Push(new zr(C,b,R,w)),h.Push(new zr(C,b+1,R+this.m_countX,x)))}for(;!h.Empty();){var k=h.Front(),I=k.m_x,B=k.m_y,P=k.m_i,M=k.m_generator;h.Pop();var O=this.m_diagram[P],D=M;if(O!==D){var L=O.center.x-I,N=O.center.y-B,F=D.center.x-I,G=D.center.y-B;L*L+N*N>F*F+G*G&&(this.m_diagram[P]=D,I>0&&h.Push(new zr(I-1,B,P-1,D)),B>0&&h.Push(new zr(I,B-1,P-this.m_countX,D)),I<this.m_countX-1&&h.Push(new zr(I+1,B,P+1,D)),B<this.m_countY-1&&h.Push(new zr(I,B+1,P+this.m_countX,D)))}}}},{key:"GetNodes",value:function(e){for(var t=0;t<this.m_countY-1;t++)for(var i=0;i<this.m_countX-1;i++){var n=i+t*this.m_countX,r=this.m_diagram[n],s=this.m_diagram[n+1],a=this.m_diagram[n+this.m_countX],o=this.m_diagram[n+1+this.m_countX];s!==a&&(r!==s&&r!==a&&(r.necessary||s.necessary||a.necessary)&&e(r.tag,s.tag,a.tag),o!==s&&o!==a&&(r.necessary||s.necessary||a.necessary)&&e(s.tag,o.tag,a.tag))}}}]),e}(),Hr=function e(){n(this,e),this.center=new we,this.tag=0,this.necessary=!1},zr=function e(t,i,r,s){n(this,e),this.m_x=t,this.m_y=i,this.m_i=r,this.m_generator=s};function Wr(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function Xr(e,t){return e<t}function jr(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length-t,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Xr,r=t,s=[],a=0;;){for(;r+1<i;i++){var o=e[r+Math.floor(Math.random()*(i-r))];s[a++]=i;for(var u=r-1;;){for(;n(e[++u],o););for(;n(o,e[--i]););if(u>=i)break;Wr(e,u,i)}}if(0===a)break;r=i,i=s[--a]}return e}function qr(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return jr(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length-t,arguments.length>3&&void 0!==arguments[3]?arguments[3]:Xr)}function Yr(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length,n=0,r=0;r<i;++r)t(e[r])||(r!==n?Wr(e,n++,r):++n);return n}function Kr(e,t,i,n,r){for(var s=i-t;s>0;){var a=Math.floor(s/2),o=t+a;r(e[o],n)?(t=++o,s-=a+1):s=a}return t}function Qr(e,t,i,n,r){for(var s=i-t;s>0;){var a=Math.floor(s/2),o=t+a;r(n,e[o])?s=a:(t=++o,s-=a+1)}return t}function Jr(e,t,i,n){for(var r=i;t!==r;)Wr(e,t++,r++),r===n?r=i:t===i&&(i=r)}function Zr(e,t,i,n){if(t===i)return i;for(var r=t;++t!==i;)n(e[r],e[t])||Wr(e,++r,t);return++r}var $r=function(){function e(t){n(this,e),this.data=[],this.count=0,this.capacity=0,this.allocator=t}return s(e,[{key:"Append",value:function(){return this.count>=this.capacity&&this.Grow(),this.count++}},{key:"Reserve",value:function(e){if(!(this.capacity>=e)){for(var t=this.capacity;t<e;++t)this.data[t]=this.allocator();this.capacity=e}}},{key:"Grow",value:function(){var e=this.capacity?2*this.capacity:U;this.Reserve(e)}},{key:"Free",value:function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)}},{key:"Shorten",value:function(){}},{key:"Data",value:function(){return this.data}},{key:"GetCount",value:function(){return this.count}},{key:"SetCount",value:function(e){this.count=e}},{key:"GetCapacity",value:function(){return this.capacity}},{key:"RemoveIf",value:function(e){this.count=Yr(this.data,e,this.count)}},{key:"Unique",value:function(e){this.count=Zr(this.data,0,this.count,e)}}]),e}(),es=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this)).m_system=e,r}return s(i,[{key:"ShouldQueryParticleSystem",value:function(){return!1}},{key:"ReportFixture",value:function(e){if(e.IsSensor())return!0;for(var t=e.GetShape().GetChildCount(),i=0;i<t;i++)for(var n=e.GetAABB(i),r=this.m_system.GetInsideBoundsEnumerator(n),s=void 0;(s=r.GetNext())>=0;)this.ReportFixtureAndParticle(e,i,s);return!0}},{key:"ReportParticle",value:function(){return!1}},{key:"ReportFixtureAndParticle",value:function(){}}]),i}(vr),ts=function(){function e(){n(this,e),this.indexA=0,this.indexB=0,this.weight=0,this.normal=new we,this.flags=0}return s(e,[{key:"SetIndices",value:function(e,t){this.indexA=e,this.indexB=t}},{key:"SetWeight",value:function(e){this.weight=e}},{key:"SetNormal",value:function(e){this.normal.Copy(e)}},{key:"SetFlags",value:function(e){this.flags=e}},{key:"GetIndexA",value:function(){return this.indexA}},{key:"GetIndexB",value:function(){return this.indexB}},{key:"GetWeight",value:function(){return this.weight}},{key:"GetNormal",value:function(){return this.normal}},{key:"GetFlags",value:function(){return this.flags}},{key:"IsEqual",value:function(e){return this.indexA===e.indexA&&this.indexB===e.indexB&&this.flags===e.flags&&this.weight===e.weight&&this.normal.x===e.normal.x&&this.normal.y===e.normal.y}},{key:"IsNotEqual",value:function(e){return!this.IsEqual(e)}},{key:"ApproximatelyEqual",value:function(e){var t=.01,i=1e-4;return this.indexA===e.indexA&&this.indexB===e.indexB&&this.flags===e.flags&&oe(this.weight-e.weight)<t&&we.DistanceSquaredVV(this.normal,e.normal)<i}}]),e}(),is=function e(){n(this,e),this.index=0,this.weight=0,this.normal=new we,this.mass=0},ns=function e(){n(this,e),this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0},rs=function e(){n(this,e),this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new we(0,0),this.pb=new we(0,0),this.pc=new we(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0},ss=function(){function e(){n(this,e),this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}return s(e,[{key:"Copy",value:function(e){return this.strictContactCheck=e.strictContactCheck,this.density=e.density,this.gravityScale=e.gravityScale,this.radius=e.radius,this.maxCount=e.maxCount,this.pressureStrength=e.pressureStrength,this.dampingStrength=e.dampingStrength,this.elasticStrength=e.elasticStrength,this.springStrength=e.springStrength,this.viscousStrength=e.viscousStrength,this.surfaceTensionPressureStrength=e.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=e.surfaceTensionNormalStrength,this.repulsiveStrength=e.repulsiveStrength,this.powderStrength=e.powderStrength,this.ejectionStrength=e.ejectionStrength,this.staticPressureStrength=e.staticPressureStrength,this.staticPressureRelaxation=e.staticPressureRelaxation,this.staticPressureIterations=e.staticPressureIterations,this.colorMixingStrength=e.colorMixingStrength,this.destroyByAge=e.destroyByAge,this.lifetimeGranularity=e.lifetimeGranularity,this}},{key:"Clone",value:function(){return(new e).Copy(this)}}]),e}(),as=function(){function t(e,i){n(this,t),this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new os,this.m_flagsBuffer=new os,this.m_positionBuffer=new os,this.m_velocityBuffer=new os,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new os,this.m_groupBuffer=[],this.m_userDataBuffer=new os,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new os,this.m_bodyContactCountBuffer=new os,this.m_consecutiveContactStepsBuffer=new os,this.m_stuckParticleBuffer=new $r((function(){return 0})),this.m_proxyBuffer=new $r((function(){return new us})),this.m_contactBuffer=new $r((function(){return new ts})),this.m_bodyContactBuffer=new $r((function(){return new is})),this.m_pairBuffer=new $r((function(){return new ns})),this.m_triadBuffer=new $r((function(){return new rs})),this.m_expirationTimeBuffer=new os,this.m_indexByExpirationTimeBuffer=new os,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new ss,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(e.strictContactCheck),this.SetDensity(e.density),this.SetGravityScale(e.gravityScale),this.SetRadius(e.radius),this.SetMaxParticleCount(e.maxCount),this.m_def=e.Clone(),this.m_world=i,this.SetDestructionByAge(this.m_def.destroyByAge)}return s(t,[{key:"Drop",value:function(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)}},{key:"CreateParticle",value:function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){var t=this.m_count?2*this.m_count:U;this.ReallocateInternalAllocatedBuffers(t)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return M;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var n=this.m_count++;this.m_flagsBuffer.data[n]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=0),this.m_positionBuffer.data[n]=(this.m_positionBuffer.data[n]||new we).Copy(i(e.position,we.ZERO)),this.m_velocityBuffer.data[n]=(this.m_velocityBuffer.data[n]||new we).Copy(i(e.velocity,we.ZERO)),this.m_weightBuffer[n]=0,this.m_forceBuffer[n]=(this.m_forceBuffer[n]||new we).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=0),this.m_depthBuffer&&(this.m_depthBuffer[n]=0);var r=(new Ne).Copy(i(e.color,Ne.ZERO));!this.m_colorBuffer.data&&r.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[n]=(this.m_colorBuffer.data[n]||new Ne).Copy(r)),(this.m_userDataBuffer.data||e.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[n]=e.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[n]=null);var s=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],a=i(e.lifetime,0),o=a>0;(this.m_expirationTimeBuffer.data||o)&&(this.SetParticleLifetime(n,o?a:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[n]=n),s.index=n;var u=i(e.group,null);return this.m_groupBuffer[n]=u,u&&(u.m_firstIndex<u.m_lastIndex?(this.RotateBuffer(u.m_firstIndex,u.m_lastIndex,n),u.m_lastIndex=n+1):(u.m_firstIndex=n,u.m_lastIndex=n+1)),this.SetParticleFlags(n,i(e.flags,0)),n}},{key:"GetParticleHandleFromIndex",value:function(e){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);var t=this.m_handleIndexBuffer.data[e];return t||((t=new Nr).SetIndex(e),this.m_handleIndexBuffer.data[e]=t,t)}},{key:"DestroyParticle",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e.b2ParticleFlag.b2_zombieParticle;i&&(n|=e.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(t,this.m_flagsBuffer.data[t]|n)}},{key:"DestroyOldestParticle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.GetParticleCount(),n=this.m_indexByExpirationTimeBuffer.data[i-(e+1)],r=this.m_indexByExpirationTimeBuffer.data[e];this.DestroyParticle(this.m_expirationTimeBuffer.data[n]>0?n:r,t)}},{key:"DestroyParticlesInShape",value:function(e,i){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=t.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;var s=new vs(this,e,i,n),a=r;return e.ComputeAABB(a,i,0),this.m_world.QueryAABB(s,a),s.Destroyed()}},{key:"CreateParticleGroup",value:function(e){var n=t.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;var r=n;r.SetPositionAngle(i(e.position,we.ZERO),i(e.angle,0));var s=this.m_count;if(e.shape&&this.CreateParticlesWithShapeForGroup(e.shape,e,r),e.shapes&&this.CreateParticlesWithShapesForGroup(e.shapes,i(e.shapeCount,e.shapes.length),e,r),e.positionData)for(var a=i(e.particleCount,e.positionData.length),o=0;o<a;o++){var u=e.positionData[o];this.CreateParticleForGroup(e,r,u)}var h=this.m_count,l=new Gr(this);l.m_firstIndex=s,l.m_lastIndex=h,l.m_strength=i(e.strength,1),l.m_userData=e.userData,l.m_transform.Copy(r),l.m_prev=null,l.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=l),this.m_groupList=l,++this.m_groupCount;for(var c=s;c<h;c++)this.m_groupBuffer[c]=l;this.SetGroupFlags(l,i(e.groupFlags,0));var _=new ps;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(s,h,_),e.group&&(this.JoinParticleGroups(e.group,l),l=e.group),l}},{key:"JoinParticleGroups",value:function(e,t){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,this.m_count),this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,t.m_firstIndex);var i=new ys(t.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(e.m_firstIndex,t.m_lastIndex,i);for(var n=t.m_firstIndex;n<t.m_lastIndex;n++)this.m_groupBuffer[n]=e;var r=e.m_groupFlags|t.m_groupFlags;this.SetGroupFlags(e,r),e.m_lastIndex=t.m_lastIndex,t.m_firstIndex=t.m_lastIndex,this.DestroyParticleGroup(t)}},{key:"SplitParticleGroup",value:function(e){this.UpdateContacts(!0);var i=te(e.GetParticleCount(),(function(){return new ls}));t.InitializeParticleLists(e,i),this.MergeParticleListsInContact(e,i);var n=t.FindLongestParticleList(e,i);this.MergeZombieParticleListNodes(e,i,n),this.CreateParticleGroupsFromParticleList(e,i,n),this.UpdatePairsAndTriadsWithParticleList(e,i)}},{key:"GetParticleGroupList",value:function(){return this.m_groupList}},{key:"GetParticleGroupCount",value:function(){return this.m_groupCount}},{key:"GetParticleCount",value:function(){return this.m_count}},{key:"GetMaxParticleCount",value:function(){return this.m_def.maxCount}},{key:"SetMaxParticleCount",value:function(e){this.m_def.maxCount=e}},{key:"GetAllParticleFlags",value:function(){return this.m_allParticleFlags}},{key:"GetAllGroupFlags",value:function(){return this.m_allGroupFlags}},{key:"SetPaused",value:function(e){this.m_paused=e}},{key:"GetPaused",value:function(){return this.m_paused}},{key:"SetDensity",value:function(e){this.m_def.density=e,this.m_inverseDensity=1/this.m_def.density}},{key:"GetDensity",value:function(){return this.m_def.density}},{key:"SetGravityScale",value:function(e){this.m_def.gravityScale=e}},{key:"GetGravityScale",value:function(){return this.m_def.gravityScale}},{key:"SetDamping",value:function(e){this.m_def.dampingStrength=e}},{key:"GetDamping",value:function(){return this.m_def.dampingStrength}},{key:"SetStaticPressureIterations",value:function(e){this.m_def.staticPressureIterations=e}},{key:"GetStaticPressureIterations",value:function(){return this.m_def.staticPressureIterations}},{key:"SetRadius",value:function(e){this.m_particleDiameter=2*e,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter}},{key:"GetRadius",value:function(){return this.m_particleDiameter/2}},{key:"GetPositionBuffer",value:function(){return this.m_positionBuffer.data}},{key:"GetVelocityBuffer",value:function(){return this.m_velocityBuffer.data}},{key:"GetColorBuffer",value:function(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data}},{key:"GetGroupBuffer",value:function(){return this.m_groupBuffer}},{key:"GetWeightBuffer",value:function(){return this.m_weightBuffer}},{key:"GetUserDataBuffer",value:function(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data}},{key:"GetFlagsBuffer",value:function(){return this.m_flagsBuffer.data}},{key:"SetParticleFlags",value:function(t,i){this.m_flagsBuffer.data[t]&~i&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&i&&(i&e.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),i&e.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=i),this.m_flagsBuffer.data[t]=i}},{key:"GetParticleFlags",value:function(e){return this.m_flagsBuffer.data[e]}},{key:"SetFlagsBuffer",value:function(e){this.SetUserOverridableBuffer(this.m_flagsBuffer,e)}},{key:"SetPositionBuffer",value:function(e){if(e instanceof Float32Array){if(e.length%2!=0)throw new Error;for(var t=e.length/2,i=new Array(t),n=0;n<t;++n)i[n]=new we(e.subarray(2*n,2*n+2));e=i}this.SetUserOverridableBuffer(this.m_positionBuffer,e)}},{key:"SetVelocityBuffer",value:function(e){if(e instanceof Float32Array){if(e.length%2!=0)throw new Error;for(var t=e.length/2,i=new Array(t),n=0;n<t;++n)i[n]=new we(e.subarray(2*n,2*n+2));e=i}this.SetUserOverridableBuffer(this.m_velocityBuffer,e)}},{key:"SetColorBuffer",value:function(e){if(e instanceof Float32Array){if(e.length%4!=0)throw new Error;for(var t=e.length/4,i=new Array(t),n=0;n<t;++n)i[n]=new Ne(e.subarray(4*n,4*n+4));e=i}this.SetUserOverridableBuffer(this.m_colorBuffer,e)}},{key:"SetUserDataBuffer",value:function(e){this.SetUserOverridableBuffer(this.m_userDataBuffer,e)}},{key:"GetContacts",value:function(){return this.m_contactBuffer.data}},{key:"GetContactCount",value:function(){return this.m_contactBuffer.count}},{key:"GetBodyContacts",value:function(){return this.m_bodyContactBuffer.data}},{key:"GetBodyContactCount",value:function(){return this.m_bodyContactBuffer.count}},{key:"GetPairs",value:function(){return this.m_pairBuffer.data}},{key:"GetPairCount",value:function(){return this.m_pairBuffer.count}},{key:"GetTriads",value:function(){return this.m_triadBuffer.data}},{key:"GetTriadCount",value:function(){return this.m_triadBuffer.count}},{key:"SetStuckThreshold",value:function(e){this.m_stuckThreshold=e,e>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))}},{key:"GetStuckCandidates",value:function(){return this.m_stuckParticleBuffer.Data()}},{key:"GetStuckCandidateCount",value:function(){return this.m_stuckParticleBuffer.GetCount()}},{key:"ComputeCollisionEnergy",value:function(){for(var e=t.ComputeCollisionEnergy_s_v,i=this.m_velocityBuffer.data,n=0,r=0;r<this.m_contactBuffer.count;r++){var s=this.m_contactBuffer.data[r],a=s.indexA,o=s.indexB,u=s.normal,h=we.SubVV(i[o],i[a],e),l=we.DotVV(h,u);l<0&&(n+=l*l)}return.5*this.GetParticleMass()*n}},{key:"SetStrictContactCheck",value:function(e){this.m_def.strictContactCheck=e}},{key:"GetStrictContactCheck",value:function(){return this.m_def.strictContactCheck}},{key:"SetParticleLifetime",value:function(e,t){var i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i)for(var n=this.GetParticleCount(),r=0;r<n;++r)this.m_indexByExpirationTimeBuffer.data[r]=r;var s=t/this.m_def.lifetimeGranularity,a=s>0?this.GetQuantizedTimeElapsed()+s:s;a!==this.m_expirationTimeBuffer.data[e]&&(this.m_expirationTimeBuffer.data[e]=a,this.m_expirationTimeBufferRequiresSorting=!0)}},{key:"GetParticleLifetime",value:function(e){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[e])}},{key:"SetDestructionByAge",value:function(e){e&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=e}},{key:"GetDestructionByAge",value:function(){return this.m_def.destroyByAge}},{key:"GetExpirationTimeBuffer",value:function(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data}},{key:"ExpirationTimeToLifetime",value:function(e){return(e>0?e-this.GetQuantizedTimeElapsed():e)*this.m_def.lifetimeGranularity}},{key:"GetIndexByExpirationTimeBuffer",value:function(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data}},{key:"ParticleApplyLinearImpulse",value:function(e,t){this.ApplyLinearImpulse(e,e+1,t)}},{key:"ApplyLinearImpulse",value:function(e,t,i){for(var n=this.m_velocityBuffer.data,r=(t-e)*this.GetParticleMass(),s=(new we).Copy(i).SelfMul(1/r),a=e;a<t;a++)n[a].SelfAdd(s)}},{key:"ParticleApplyForce",value:function(e,i){t.IsSignificantForce(i)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[e])&&(this.PrepareForceBuffer(),this.m_forceBuffer[e].SelfAdd(i))}},{key:"ApplyForce",value:function(e,i,n){var r=(new we).Copy(n).SelfMul(1/(i-e));if(t.IsSignificantForce(r)){this.PrepareForceBuffer();for(var s=e;s<i;s++)this.m_forceBuffer[s].SelfAdd(r)}}},{key:"GetNext",value:function(){return this.m_next}},{key:"QueryAABB",value:function(e,i){if(0!==this.m_proxyBuffer.count)for(var n=0,r=this.m_proxyBuffer.count,s=Kr(this.m_proxyBuffer.data,n,r,t.computeTag(this.m_inverseDiameter*i.lowerBound.x,this.m_inverseDiameter*i.lowerBound.y),us.CompareProxyTag),a=Qr(this.m_proxyBuffer.data,s,r,t.computeTag(this.m_inverseDiameter*i.upperBound.x,this.m_inverseDiameter*i.upperBound.y),us.CompareTagProxy),o=this.m_positionBuffer.data,u=s;u<a;++u){var h=this.m_proxyBuffer.data[u].index,l=o[h];if(i.lowerBound.x<l.x&&l.x<i.upperBound.x&&i.lowerBound.y<l.y&&l.y<i.upperBound.y&&!e.ReportParticle(this,h))break}}},{key:"QueryShapeAABB",value:function(e,i,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=t.QueryShapeAABB_s_aabb;i.ComputeAABB(s,n,r),this.QueryAABB(e,s)}},{key:"QueryPointAABB",value:function(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:p,r=t.QueryPointAABB_s_aabb;r.lowerBound.Set(i.x-n,i.y-n),r.upperBound.Set(i.x+n,i.y+n),this.QueryAABB(e,r)}},{key:"RayCast",value:function(e,i,n){var r=t.RayCast_s_aabb,s=t.RayCast_s_p,a=t.RayCast_s_v,o=t.RayCast_s_n,u=t.RayCast_s_point;if(0!==this.m_proxyBuffer.count){var h=this.m_positionBuffer.data,l=r;we.MinV(i,n,l.lowerBound),we.MaxV(i,n,l.upperBound);for(var c,_=1,f=we.SubVV(n,i,a),d=we.DotVV(f,f),m=this.GetInsideBoundsEnumerator(l);(c=m.GetNext())>=0;){var p=we.SubVV(i,h[c],s),v=we.DotVV(p,f),y=v*v-d*(we.DotVV(p,p)-this.m_squaredDiameter);if(y>=0){var g=me(y),S=(-v-g)/d;if(S>_)continue;if(S<0&&((S=(-v+g)/d)<0||S>_))continue;var A=we.AddVMulSV(p,S,f,o);if(A.Normalize(),(_=ue(_,e.ReportParticle(this,c,we.AddVMulSV(i,S,f,u),A,S)))<=0)break}}}}},{key:"ComputeAABB",value:function(e){var t=this.GetParticleCount();e.lowerBound.x=+r,e.lowerBound.y=+r,e.upperBound.x=-r,e.upperBound.y=-r;for(var i=this.m_positionBuffer.data,n=0;n<t;n++){var s=i[n];we.MinV(e.lowerBound,s,e.lowerBound),we.MaxV(e.upperBound,s,e.upperBound)}e.lowerBound.x-=this.m_particleDiameter,e.lowerBound.y-=this.m_particleDiameter,e.upperBound.x+=this.m_particleDiameter,e.upperBound.y+=this.m_particleDiameter}},{key:"FreeBuffer",value:function(e){null!==e&&(e.length=0)}},{key:"FreeUserOverridableBuffer",value:function(e){0===e.userSuppliedCapacity&&this.FreeBuffer(e.data,this.m_internalAllocatedCapacity)}},{key:"ReallocateBuffer3",value:function(e,t,i){if(i<=t)throw new Error;var n=e?e.slice():[];return n.length=i,n}},{key:"ReallocateBuffer5",value:function(e,t,i,n,r){if(n<=i)throw new Error;if(t&&!(n<=t))throw new Error;return r&&!e||t||(e=this.ReallocateBuffer3(e,i,n)),e}},{key:"ReallocateBuffer4",value:function(e,t,i,n){return this.ReallocateBuffer5(e.data,e.userSuppliedCapacity,t,i,n)}},{key:"RequestBuffer",value:function(e){return e||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(U),(e=[]).length=this.m_internalAllocatedCapacity),e}},{key:"ReallocateHandleBuffers",value:function(e){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,e,!0)}},{key:"ReallocateInternalAllocatedBuffers",value:function(e){function t(e,t){return t&&e>t?t:e}if(e=t(e,this.m_def.maxCount),e=t(e,this.m_flagsBuffer.userSuppliedCapacity),e=t(e,this.m_positionBuffer.userSuppliedCapacity),e=t(e,this.m_velocityBuffer.userSuppliedCapacity),e=t(e,this.m_colorBuffer.userSuppliedCapacity),e=t(e,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<e){this.ReallocateHandleBuffers(e),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,e,!1);var i=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,e,i),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,e,i),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,e,i),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,e,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,e,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,e,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,e,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,e,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,e,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,e,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,e,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,e,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,e,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,e,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,e,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,e,!1),this.m_internalAllocatedCapacity=e}}},{key:"CreateParticleForGroup",value:function(e,t,n){var r=new Or;r.flags=i(e.flags,0),Oe.MulXV(t,n,r.position),we.AddVV(i(e.linearVelocity,we.ZERO),we.CrossSV(i(e.angularVelocity,0),we.SubVV(r.position,i(e.position,we.ZERO),we.s_t0),we.s_t0),r.velocity),r.color.Copy(i(e.color,Ne.ZERO)),r.lifetime=i(e.lifetime,0),r.userData=e.userData,this.CreateParticle(r)}},{key:"CreateParticlesStrokeShapeForGroup",value:function(n,r,s){var a=t.CreateParticlesStrokeShapeForGroup_s_edge,o=t.CreateParticlesStrokeShapeForGroup_s_d,u=t.CreateParticlesStrokeShapeForGroup_s_p,h=i(r.stride,0);0===h&&(h=this.GetParticleStride());for(var l=0,c=n.GetChildCount(),_=0;_<c;_++){var f=null;n.GetType()===e.b2ShapeType.e_edgeShape?f=n:(f=a,n.GetChildEdge(f,_));for(var d=we.SubVV(f.m_vertex2,f.m_vertex1,o),m=d.Length();l<m;){var p=we.AddVMulSV(f.m_vertex1,l/m,d,u);this.CreateParticleForGroup(r,s,p),l+=h}l-=m}}},{key:"CreateParticlesFillShapeForGroup",value:function(e,n,r){var s=t.CreateParticlesFillShapeForGroup_s_aabb,a=t.CreateParticlesFillShapeForGroup_s_p,o=i(n.stride,0);0===o&&(o=this.GetParticleStride());var u=Oe.IDENTITY,h=s;e.ComputeAABB(h,u,0);for(var l=Math.floor(h.lowerBound.y/o)*o;l<h.upperBound.y;l+=o)for(var c=Math.floor(h.lowerBound.x/o)*o;c<h.upperBound.x;c+=o){var _=a.Set(c,l);e.TestPoint(u,_)&&this.CreateParticleForGroup(n,r,_)}}},{key:"CreateParticlesWithShapeForGroup",value:function(t,i,n){switch(t.GetType()){case e.b2ShapeType.e_edgeShape:case e.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(t,i,n);break;case e.b2ShapeType.e_polygonShape:case e.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(t,i,n)}}},{key:"CreateParticlesWithShapesForGroup",value:function(e,t,i,n){var r=new gs(e,t);this.CreateParticlesFillShapeForGroup(r,i,n)}},{key:"CloneParticle",value:function(e,t){var i=new Or;i.flags=this.m_flagsBuffer.data[e],i.position.Copy(this.m_positionBuffer.data[e]),i.velocity.Copy(this.m_velocityBuffer.data[e]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[e]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[e]),i.group=t;var n=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){var r=this.m_handleIndexBuffer.data[e];r&&r.SetIndex(n),this.m_handleIndexBuffer.data[n]=r,this.m_handleIndexBuffer.data[e]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=this.m_lastBodyContactStepBuffer.data[e]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=this.m_bodyContactCountBuffer.data[e]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=this.m_consecutiveContactStepsBuffer.data[e]),this.m_hasForce&&this.m_forceBuffer[n].Copy(this.m_forceBuffer[e]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=this.m_staticPressureBuffer[e]),this.m_depthBuffer&&(this.m_depthBuffer[n]=this.m_depthBuffer[e]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[n]=this.m_expirationTimeBuffer.data[e]),n}},{key:"DestroyParticlesInGroup",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=e.m_firstIndex;i<e.m_lastIndex;i++)this.DestroyParticle(i,t)}},{key:"DestroyParticleGroup",value:function(e){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(e),this.SetGroupFlags(e,0);for(var t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_groupBuffer[t]=null;e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_groupList&&(this.m_groupList=e.m_next),--this.m_groupCount}},{key:"UpdatePairsAndTriads",value:function(i,n,r){for(var s=t.UpdatePairsAndTriads_s_dab,a=t.UpdatePairsAndTriads_s_dbc,o=t.UpdatePairsAndTriads_s_dca,u=this.m_positionBuffer.data,h=0,l=i;l<n;l++)h|=this.m_flagsBuffer.data[l];if(h&t.k_pairFlags)for(var c=0;c<this.m_contactBuffer.count;c++){var _=this.m_contactBuffer.data[c],f=_.indexA,d=_.indexB,m=this.m_flagsBuffer.data[f],p=this.m_flagsBuffer.data[d],v=this.m_groupBuffer[f],y=this.m_groupBuffer[d];if(f>=i&&f<n&&d>=i&&d<n&&!((m|p)&e.b2ParticleFlag.b2_zombieParticle)&&(m|p)&t.k_pairFlags&&(r.IsNecessary(f)||r.IsNecessary(d))&&t.ParticleCanBeConnected(m,v)&&t.ParticleCanBeConnected(p,y)&&r.ShouldCreatePair(f,d)){var g=this.m_pairBuffer.data[this.m_pairBuffer.Append()];g.indexA=f,g.indexB=d,g.flags=_.flags,g.strength=ue(v?v.m_strength:1,y?y.m_strength:1),g.distance=we.DistanceVV(u[f],u[d])}qr(this.m_pairBuffer.data,0,this.m_pairBuffer.count,t.ComparePairIndices),this.m_pairBuffer.Unique(t.MatchPairIndices)}if(h&t.k_triadFlags){for(var S=new Ur(n-i),A=i;A<n;A++){var T=this.m_flagsBuffer.data[A],E=this.m_groupBuffer[A];T&e.b2ParticleFlag.b2_zombieParticle||!t.ParticleCanBeConnected(T,E)||S.AddGenerator(u[A],A,r.IsNecessary(A))}var b=this.GetParticleStride();S.Generate(b/2,2*b);var C=this,R=function(e,i,n){var h=C.m_flagsBuffer.data[e],l=C.m_flagsBuffer.data[i],c=C.m_flagsBuffer.data[n];if((h|l|c)&t.k_triadFlags&&r.ShouldCreateTriad(e,i,n)){var _=u[e],f=u[i],d=u[n],m=we.SubVV(_,f,s),p=we.SubVV(f,d,a),v=we.SubVV(d,_,o),y=V*C.m_squaredDiameter;if(we.DotVV(m,m)>y||we.DotVV(p,p)>y||we.DotVV(v,v)>y)return;var g=C.m_groupBuffer[e],S=C.m_groupBuffer[i],A=C.m_groupBuffer[n],T=C.m_triadBuffer.data[C.m_triadBuffer.Append()];T.indexA=e,T.indexB=i,T.indexC=n,T.flags=h|l|c,T.strength=ue(ue(g?g.m_strength:1,S?S.m_strength:1),A?A.m_strength:1);var E=(_.x+f.x+d.x)/3,b=(_.y+f.y+d.y)/3;T.pa.x=_.x-E,T.pa.y=_.y-b,T.pb.x=f.x-E,T.pb.y=f.y-b,T.pc.x=d.x-E,T.pc.y=d.y-b,T.ka=-we.DotVV(v,m),T.kb=-we.DotVV(m,p),T.kc=-we.DotVV(p,v),T.s=we.CrossVV(_,f)+we.CrossVV(f,d)+we.CrossVV(d,_)}};S.GetNodes(R),qr(this.m_triadBuffer.data,0,this.m_triadBuffer.count,t.CompareTriadIndices),this.m_triadBuffer.Unique(t.MatchTriadIndices)}}},{key:"UpdatePairsAndTriadsWithReactiveParticles",value:function(){var t=new Ss(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,t);for(var i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&=~e.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~e.b2ParticleFlag.b2_reactiveParticle}},{key:"MergeParticleListsInContact",value:function(e,i){for(var n=e.GetBufferIndex(),r=0;r<this.m_contactBuffer.count;r++){var s=this.m_contactBuffer.data[r],a=s.indexA,o=s.indexB;if(e.ContainsParticle(a)&&e.ContainsParticle(o)){var u=i[a-n].list,h=i[o-n].list;if(u!==h){if(u.count<h.count){var l=u;u=h,h=l}t.MergeParticleLists(u,h)}}}}},{key:"MergeZombieParticleListNodes",value:function(i,n,r){for(var s=i.GetParticleCount(),a=0;a<s;a++){var o=n[a];o!==r&&this.m_flagsBuffer.data[o.index]&e.b2ParticleFlag.b2_zombieParticle&&t.MergeParticleListAndNode(r,o)}}},{key:"CreateParticleGroupsFromParticleList",value:function(t,i,n){var r=t.GetParticleCount(),s=new Fr;s.groupFlags=t.GetGroupFlags(),s.userData=t.GetUserData();for(var a=0;a<r;a++){var o=i[a];if(o.count&&o!==n)for(var u=this.CreateParticleGroup(s),h=o;h;h=h.next){var l=h.index,c=this.CloneParticle(l,u);this.m_flagsBuffer.data[l]|=e.b2ParticleFlag.b2_zombieParticle,h.index=c}}}},{key:"UpdatePairsAndTriadsWithParticleList",value:function(e,t){for(var i=e.GetBufferIndex(),n=0;n<this.m_pairBuffer.count;n++){var r=this.m_pairBuffer.data[n],s=r.indexA,a=r.indexB;e.ContainsParticle(s)&&(r.indexA=t[s-i].index),e.ContainsParticle(a)&&(r.indexB=t[a-i].index)}for(var o=0;o<this.m_triadBuffer.count;o++){var u=this.m_triadBuffer.data[o],h=u.indexA,l=u.indexB,c=u.indexC;e.ContainsParticle(h)&&(u.indexA=t[h-i].index),e.ContainsParticle(l)&&(u.indexB=t[l-i].index),e.ContainsParticle(c)&&(u.indexC=t[c-i].index)}}},{key:"ComputeDepth",value:function(){for(var t=[],i=0,n=0;n<this.m_contactBuffer.count;n++){var s=this.m_contactBuffer.data[n],a=s.indexA,o=s.indexB,u=this.m_groupBuffer[a],h=this.m_groupBuffer[o];u&&u===h&&u.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(t[i++]=s)}for(var l=[],c=0,_=this.m_groupList;_;_=_.GetNext())if(_.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){l[c++]=_,this.SetGroupFlags(_,_.m_groupFlags&~e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(var f=_.m_firstIndex;f<_.m_lastIndex;f++)this.m_accumulationBuffer[f]=0}for(var d=0;d<i;d++){var m=t[d],p=m.indexA,v=m.indexB,y=m.weight;this.m_accumulationBuffer[p]+=y,this.m_accumulationBuffer[v]+=y}for(var g=0;g<c;g++)for(var S=l[g],A=S.m_firstIndex;A<S.m_lastIndex;A++){var T=this.m_accumulationBuffer[A];this.m_depthBuffer[A]=T<.8?0:r}for(var E=me(this.m_count)>>0,b=0;b<E;b++){for(var C=!1,R=0;R<i;R++){var x=t[R],w=x.indexA,k=x.indexB,I=1-x.weight,B=this.m_depthBuffer[w],P=this.m_depthBuffer[k],M=P+I,O=B+I;B>M&&(this.m_depthBuffer[w]=M,C=!0),P>O&&(this.m_depthBuffer[k]=O,C=!0)}if(!C)break}for(var D=0;D<c;D++)for(var L=l[D],N=L.m_firstIndex;N<L.m_lastIndex;N++)this.m_depthBuffer[N]<r?this.m_depthBuffer[N]*=this.m_particleDiameter:this.m_depthBuffer[N]=0}},{key:"GetInsideBoundsEnumerator",value:function(e){var i=t.computeTag(this.m_inverseDiameter*e.lowerBound.x-1,this.m_inverseDiameter*e.lowerBound.y-1),n=t.computeTag(this.m_inverseDiameter*e.upperBound.x+1,this.m_inverseDiameter*e.upperBound.y+1),r=0,s=this.m_proxyBuffer.count,a=Kr(this.m_proxyBuffer.data,r,s,i,us.CompareProxyTag),o=Qr(this.m_proxyBuffer.data,r,s,n,us.CompareTagProxy);return new hs(this,i,n,a,o)}},{key:"UpdateAllParticleFlags",value:function(){this.m_allParticleFlags=0;for(var e=0;e<this.m_count;e++)this.m_allParticleFlags|=this.m_flagsBuffer.data[e];this.m_needsUpdateAllParticleFlags=!1}},{key:"UpdateAllGroupFlags",value:function(){this.m_allGroupFlags=0;for(var e=this.m_groupList;e;e=e.GetNext())this.m_allGroupFlags|=e.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1}},{key:"AddContact",value:function(e,i){var n=this.m_flagsBuffer.data,r=this.m_positionBuffer.data,s=we.SubVV(r[i],r[e],t.AddContact_s_d),a=we.DotVV(s,s);if(0<a&&a<this.m_squaredDiameter){var o=de(a),u=this.m_contactBuffer.data[this.m_contactBuffer.Append()];u.indexA=e,u.indexB=i,u.flags=n[e]|n[i],u.weight=1-a*o*this.m_inverseDiameter,u.normal.x=o*s.x,u.normal.y=o*s.y}}},{key:"FindContacts_Reference",value:function(){var e=0,i=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(var n=e,r=e;n<i;n++){for(var s=t.computeRelativeTag(this.m_proxyBuffer.data[n].tag,1,0),a=n+1;a<i&&!(s<this.m_proxyBuffer.data[a].tag);a++)this.AddContact(this.m_proxyBuffer.data[n].index,this.m_proxyBuffer.data[a].index,this.m_contactBuffer);for(var o=t.computeRelativeTag(this.m_proxyBuffer.data[n].tag,-1,1);r<i&&!(o<=this.m_proxyBuffer.data[r].tag);r++);for(var u=t.computeRelativeTag(this.m_proxyBuffer.data[n].tag,1,1),h=r;h<i&&!(u<this.m_proxyBuffer.data[h].tag);h++)this.AddContact(this.m_proxyBuffer.data[n].index,this.m_proxyBuffer.data[h].index,this.m_contactBuffer)}}},{key:"FindContacts",value:function(e){this.FindContacts_Reference(e)}},{key:"UpdateProxies_Reference",value:function(){for(var e=this.m_positionBuffer.data,i=this.m_inverseDiameter,n=0;n<this.m_proxyBuffer.count;++n){var r=this.m_proxyBuffer.data[n],s=e[r.index];r.tag=t.computeTag(i*s.x,i*s.y)}}},{key:"UpdateProxies",value:function(e){this.UpdateProxies_Reference(e)}},{key:"SortProxies",value:function(){jr(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,us.CompareProxyProxy)}},{key:"FilterContacts",value:function(){var t=this.GetParticleContactFilter();if(null!==t){var i=this,n=function(n){return 0!=(n.flags&e.b2ParticleFlag.b2_particleContactFilterParticle)&&!t.ShouldCollideParticleParticle(i,n.indexA,n.indexB)};this.m_contactBuffer.RemoveIf(n)}}},{key:"NotifyContactListenerPreContact",value:function(e){if(null!==this.GetParticleContactListener())throw e.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error}},{key:"NotifyContactListenerPostContact",value:function(){var e=this.GetParticleContactListener();if(null!==e){for(var t=0;t<this.m_contactBuffer.count;++t){var i=this.m_contactBuffer.data[t];e.BeginContactParticleParticle(this,i)}throw new Error}}},{key:"UpdateContacts",value:function(e){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);var i=new ms;this.NotifyContactListenerPreContact(i),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(i),e&&this.m_contactBuffer.RemoveIf(t.b2ParticleContactIsZombie)}},{key:"NotifyBodyContactListenerPreContact",value:function(e){if(null!==this.GetFixtureContactListener())throw e.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error}},{key:"NotifyBodyContactListenerPostContact",value:function(){var e=this.GetFixtureContactListener();if(null!==e){for(var t=0;t<this.m_bodyContactBuffer.count;t++){var i=this.m_bodyContactBuffer.data[t];e.BeginContactFixtureParticle(this,i)}throw new Error}}},{key:"UpdateBodyContacts",value:function(){var e=t.UpdateBodyContacts_s_aabb,i=new fs;if(this.NotifyBodyContactListenerPreContact(i),this.m_stuckThreshold>0)for(var n=this.GetParticleCount(),r=0;r<n;r++)this.m_bodyContactCountBuffer.data[r]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[r]+1&&(this.m_consecutiveContactStepsBuffer.data[r]=0);this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);var s=e;this.ComputeAABB(s),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new As(this));var a=this.UpdateBodyContacts_callback;a.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(a,s),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(i)}},{key:"Solve",value:function(i){var n=t.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(i),this.m_allParticleFlags&e.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<i.particleIterations;this.m_iterationIndex++){++this.m_timestamp;var r=n.Copy(i);r.dt/=i.particleIterations,r.inv_dt*=i.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&e.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&e.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(r),this.m_allGroupFlags&e.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(r),this.SolvePressure(r),this.SolveDamping(r),this.m_allParticleFlags&t.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&e.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_springParticle&&this.SolveSpring(r),this.LimitVelocity(r),this.m_allGroupFlags&e.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&e.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(r),this.SolveCollision(r),this.m_allGroupFlags&e.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(var s=0;s<this.m_count;s++)this.m_positionBuffer.data[s].SelfMulAdd(r.dt,this.m_velocityBuffer.data[s])}}},{key:"SolveCollision",value:function(e){var i=t.SolveCollision_s_aabb,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,a=i;a.lowerBound.x=+r,a.lowerBound.y=+r,a.upperBound.x=-r,a.upperBound.y=-r;for(var o=0;o<this.m_count;o++){var u=s[o],h=n[o],l=h.x+e.dt*u.x,c=h.y+e.dt*u.y;a.lowerBound.x=ue(a.lowerBound.x,ue(h.x,l)),a.lowerBound.y=ue(a.lowerBound.y,ue(h.y,c)),a.upperBound.x=he(a.upperBound.x,he(h.x,l)),a.upperBound.y=he(a.upperBound.y,he(h.y,c))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new Ts(this,e));var _=this.SolveCollision_callback;_.m_step=e,this.m_world.QueryAABB(_,a)}},{key:"LimitVelocity",value:function(e){for(var t=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(e),n=0;n<this.m_count;n++){var r=t[n],s=we.DotVV(r,r);s>i&&r.SelfMul(me(i/s))}}},{key:"SolveGravity",value:function(e){for(var i=t.SolveGravity_s_gravity,n=this.m_velocityBuffer.data,r=we.MulSV(e.dt*this.m_def.gravityScale,this.m_world.GetGravity(),i),s=0;s<this.m_count;s++)n[s].SelfAdd(r)}},{key:"SolveBarrier",value:function(i){for(var n=t.SolveBarrier_s_aabb,r=t.SolveBarrier_s_va,s=t.SolveBarrier_s_vb,a=t.SolveBarrier_s_pba,o=t.SolveBarrier_s_vba,u=t.SolveBarrier_s_vc,h=t.SolveBarrier_s_pca,l=t.SolveBarrier_s_vca,c=t.SolveBarrier_s_qba,_=t.SolveBarrier_s_qca,f=t.SolveBarrier_s_dv,d=t.SolveBarrier_s_f,m=this.m_positionBuffer.data,p=this.m_velocityBuffer.data,v=0;v<this.m_count;v++)0!=(this.m_flagsBuffer.data[v]&t.k_barrierWallFlags)&&p[v].SetZero();for(var y=H*i.dt,g=this.GetParticleMass(),S=0;S<this.m_pairBuffer.count;S++){var A=this.m_pairBuffer.data[S];if(A.flags&e.b2ParticleFlag.b2_barrierParticle){var T=A.indexA,E=A.indexB,b=m[T],C=m[E],R=n;we.MinV(b,C,R.lowerBound),we.MaxV(b,C,R.upperBound);for(var x=this.m_groupBuffer[T],w=this.m_groupBuffer[E],k=this.GetLinearVelocity(x,T,b,r),I=this.GetLinearVelocity(w,E,C,s),B=we.SubVV(C,b,a),P=we.SubVV(I,k,o),M=this.GetInsideBoundsEnumerator(R),O=void 0;(O=M.GetNext())>=0;){var D=m[O],L=this.m_groupBuffer[O];if(x!==L&&w!==L){var N=this.GetLinearVelocity(L,O,D,u),F=we.SubVV(D,b,h),G=we.SubVV(N,k,l),V=we.CrossVV(P,G),U=we.CrossVV(B,G)-we.CrossVV(F,P),z=we.CrossVV(B,F),W=void 0,X=void 0,j=c,q=_;if(0===V){if(0===U)continue;if(!((X=-z/U)>=0&&X<y))continue;if(we.AddVMulSV(B,X,P,j),we.AddVMulSV(F,X,G,q),!((W=we.DotVV(j,q)/we.DotVV(j,j))>=0&&W<=1))continue}else{var Y=U*U-4*z*V;if(Y<0)continue;var K=me(Y),Q=(-U-K)/(2*V),J=(-U+K)/(2*V);if(Q>J){var Z=Q;Q=J,J=Z}if(X=Q,we.AddVMulSV(B,X,P,j),we.AddVMulSV(F,X,G,q),W=we.DotVV(j,q)/we.DotVV(j,j),!(X>=0&&X<y&&W>=0&&W<=1)){if(!((X=J)>=0&&X<y))continue;if(we.AddVMulSV(B,X,P,j),we.AddVMulSV(F,X,G,q),!((W=we.DotVV(j,q)/we.DotVV(j,j))>=0&&W<=1))continue}}var $=f;$.x=k.x+W*P.x-N.x,$.y=k.y+W*P.y-N.y;var ee=we.MulSV(g,$,d);if(L&&this.IsRigidGroup(L)){var te=L.GetMass(),ie=L.GetInertia();te>0&&L.m_linearVelocity.SelfMulAdd(1/te,ee),ie>0&&(L.m_angularVelocity+=we.CrossVV(we.SubVV(D,L.GetCenter(),we.s_t0),ee)/ie)}else p[O].SelfAdd($);this.ParticleApplyForce(O,ee.SelfMul(-i.inv_dt))}}}}}},{key:"SolveStaticPressure",value:function(t){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);for(var i=this.GetCriticalPressure(t),n=this.m_def.staticPressureStrength*i,r=N*i,s=this.m_def.staticPressureRelaxation,a=0;a<this.m_def.staticPressureIterations;a++){for(var o=0;o<this.m_count;o++)this.m_accumulationBuffer[o]=0;for(var u=0;u<this.m_contactBuffer.count;u++){var h=this.m_contactBuffer.data[u];if(h.flags&e.b2ParticleFlag.b2_staticPressureParticle){var l=h.indexA,c=h.indexB,_=h.weight;this.m_accumulationBuffer[l]+=_*this.m_staticPressureBuffer[c],this.m_accumulationBuffer[c]+=_*this.m_staticPressureBuffer[l]}}for(var f=0;f<this.m_count;f++){var d=this.m_weightBuffer[f];if(this.m_flagsBuffer.data[f]&e.b2ParticleFlag.b2_staticPressureParticle){var m=(this.m_accumulationBuffer[f]+n*(d-L))/(d+s);this.m_staticPressureBuffer[f]=le(m,0,r)}else this.m_staticPressureBuffer[f]=0}}}},{key:"ComputeWeight",value:function(){for(var e=0;e<this.m_count;e++)this.m_weightBuffer[e]=0;for(var t=0;t<this.m_bodyContactBuffer.count;t++){var i=this.m_bodyContactBuffer.data[t],n=i.index,r=i.weight;this.m_weightBuffer[n]+=r}for(var s=0;s<this.m_contactBuffer.count;s++){var a=this.m_contactBuffer.data[s],o=a.indexA,u=a.indexB,h=a.weight;this.m_weightBuffer[o]+=h,this.m_weightBuffer[u]+=h}}},{key:"SolvePressure",value:function(i){for(var n=t.SolvePressure_s_f,r=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,a=this.GetCriticalPressure(i),o=this.m_def.pressureStrength*a,u=N*a,h=0;h<this.m_count;h++){var l=o*he(0,this.m_weightBuffer[h]-L);this.m_accumulationBuffer[h]=ue(l,u)}if(this.m_allParticleFlags&t.k_noPressureFlags)for(var c=0;c<this.m_count;c++)this.m_flagsBuffer.data[c]&t.k_noPressureFlags&&(this.m_accumulationBuffer[c]=0);if(this.m_allParticleFlags&e.b2ParticleFlag.b2_staticPressureParticle)for(var _=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&e.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[_]+=this.m_staticPressureBuffer[_]);for(var f=i.dt/(this.m_def.density*this.m_particleDiameter),d=this.GetParticleInvMass(),m=0;m<this.m_bodyContactBuffer.count;m++){var p=this.m_bodyContactBuffer.data[m],v=p.index,y=p.body,g=p.weight,S=p.mass,A=p.normal,T=r[v],E=this.m_accumulationBuffer[v]+o*g,b=we.MulSV(f*g*S*E,A,n);s[v].SelfMulSub(d,b),y.ApplyLinearImpulse(b,T,!0)}for(var C=0;C<this.m_contactBuffer.count;C++){var R=this.m_contactBuffer.data[C],x=R.indexA,w=R.indexB,k=R.weight,I=R.normal,B=this.m_accumulationBuffer[x]+this.m_accumulationBuffer[w],P=we.MulSV(f*k*B,I,n);s[x].SelfSub(P),s[w].SelfAdd(P)}}},{key:"SolveDamping",value:function(e){for(var i=t.SolveDamping_s_v,n=t.SolveDamping_s_f,r=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,a=this.m_def.dampingStrength,o=1/this.GetCriticalVelocity(e),u=this.GetParticleInvMass(),h=0;h<this.m_bodyContactBuffer.count;h++){var l=this.m_bodyContactBuffer.data[h],c=l.index,_=l.body,f=l.weight,d=l.mass,m=l.normal,p=r[c],v=we.SubVV(_.GetLinearVelocityFromWorldPoint(p,we.s_t0),s[c],i),y=we.DotVV(v,m);if(y<0){var g=he(a*f,ue(-o*y,.5)),S=we.MulSV(g*d*y,m,n);s[c].SelfMulAdd(u,S),_.ApplyLinearImpulse(S.SelfNeg(),p,!0)}}for(var A=0;A<this.m_contactBuffer.count;A++){var T=this.m_contactBuffer.data[A],E=T.indexA,b=T.indexB,C=T.weight,R=T.normal,x=we.SubVV(s[b],s[E],i),w=we.DotVV(x,R);if(w<0){var k=he(a*C,ue(-o*w,.5)),I=we.MulSV(k*w,R,n);s[E].SelfAdd(I),s[b].SelfSub(I)}}}},{key:"SolveRigidDamping",value:function(){for(var e=t.SolveRigidDamping_s_t0,i=t.SolveRigidDamping_s_t1,n=t.SolveRigidDamping_s_p,r=t.SolveRigidDamping_s_v,s=[0],a=[0],o=[0],u=[0],h=[0],l=[0],c=this.m_positionBuffer.data,_=this.m_def.dampingStrength,f=0;f<this.m_bodyContactBuffer.count;f++){var d=this.m_bodyContactBuffer.data[f],m=d.index,p=this.m_groupBuffer[m];if(p&&this.IsRigidGroup(p)){var v=d.body,y=d.normal,g=d.weight,S=c[m],A=we.SubVV(v.GetLinearVelocityFromWorldPoint(S,e),p.GetLinearVelocityFromWorldPoint(S,i),r),T=we.DotVV(A,y);if(T<0){this.InitDampingParameterWithRigidGroupOrParticle(s,a,o,!0,p,m,S,y),this.InitDampingParameter(u,h,l,v.GetMass(),v.GetInertia()-v.GetMass()*v.GetLocalCenter().LengthSquared(),v.GetWorldCenter(),S,y);var E=_*ue(g,1)*this.ComputeDampingImpulse(s[0],a[0],o[0],u[0],h[0],l[0],T);this.ApplyDamping(s[0],a[0],o[0],!0,p,m,E,y),v.ApplyLinearImpulse(we.MulSV(-E,y,we.s_t0),S,!0)}}}for(var b=0;b<this.m_contactBuffer.count;b++){var C=this.m_contactBuffer.data[b],R=C.indexA,x=C.indexB,w=C.normal,k=C.weight,I=this.m_groupBuffer[R],B=this.m_groupBuffer[x],P=this.IsRigidGroup(I),M=this.IsRigidGroup(B);if(I!==B&&(P||M)){var O=we.MidVV(c[R],c[x],n),D=we.SubVV(this.GetLinearVelocity(B,x,O,e),this.GetLinearVelocity(I,R,O,i),r),L=we.DotVV(D,w);if(L<0){this.InitDampingParameterWithRigidGroupOrParticle(s,a,o,P,I,R,O,w),this.InitDampingParameterWithRigidGroupOrParticle(u,h,l,M,B,x,O,w);var N=_*k*this.ComputeDampingImpulse(s[0],a[0],o[0],u[0],h[0],l[0],L);this.ApplyDamping(s[0],a[0],o[0],P,I,R,N,w),this.ApplyDamping(u[0],h[0],l[0],M,B,x,-N,w)}}}}},{key:"SolveExtraDamping",value:function(){for(var e=t.SolveExtraDamping_s_v,i=t.SolveExtraDamping_s_f,n=this.m_velocityBuffer.data,r=this.m_positionBuffer.data,s=this.GetParticleInvMass(),a=0;a<this.m_bodyContactBuffer.count;a++){var o=this.m_bodyContactBuffer.data[a],u=o.index;if(this.m_flagsBuffer.data[u]&t.k_extraDampingFlags){var h=o.body,l=o.mass,c=o.normal,_=r[u],f=we.SubVV(h.GetLinearVelocityFromWorldPoint(_,we.s_t0),n[u],e),d=we.DotVV(f,c);if(d<0){var m=we.MulSV(.5*l*d,c,i);n[u].SelfMulAdd(s,m),h.ApplyLinearImpulse(m.SelfNeg(),_,!0)}}}}},{key:"SolveWall",value:function(){for(var t=this.m_velocityBuffer.data,i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&e.b2ParticleFlag.b2_wallParticle&&t[i].SetZero()}},{key:"SolveRigid",value:function(i){for(var n=t.SolveRigid_s_position,r=t.SolveRigid_s_rotation,s=t.SolveRigid_s_transform,a=t.SolveRigid_s_velocityTransform,o=this.m_positionBuffer.data,u=this.m_velocityBuffer.data,h=this.m_groupList;h;h=h.GetNext())if(h.m_groupFlags&e.b2ParticleGroupFlag.b2_rigidParticleGroup){h.UpdateStatistics();var l=r;l.SetAngle(i.dt*h.m_angularVelocity);var c=we.AddVV(h.m_center,we.SubVV(we.MulSV(i.dt,h.m_linearVelocity,we.s_t0),Me.MulRV(l,h.m_center,we.s_t1),we.s_t0),n),_=s;_.SetPositionRotation(c,l),Oe.MulXX(_,h.m_transform,h.m_transform);var f=a;f.p.x=i.inv_dt*_.p.x,f.p.y=i.inv_dt*_.p.y,f.q.s=i.inv_dt*_.q.s,f.q.c=i.inv_dt*(_.q.c-1);for(var d=h.m_firstIndex;d<h.m_lastIndex;d++)Oe.MulXV(f,o[d],u[d])}}},{key:"SolveElastic",value:function(i){for(var n=t.SolveElastic_s_pa,r=t.SolveElastic_s_pb,s=t.SolveElastic_s_pc,a=t.SolveElastic_s_r,o=t.SolveElastic_s_t0,u=this.m_positionBuffer.data,h=this.m_velocityBuffer.data,l=i.inv_dt*this.m_def.elasticStrength,c=0;c<this.m_triadBuffer.count;c++){var _=this.m_triadBuffer.data[c];if(_.flags&e.b2ParticleFlag.b2_elasticParticle){var f=_.indexA,d=_.indexB,m=_.indexC,p=_.pa,v=_.pb,y=_.pc,g=n.Copy(u[f]),S=r.Copy(u[d]),A=s.Copy(u[m]),T=h[f],E=h[d],b=h[m];g.SelfMulAdd(i.dt,T),S.SelfMulAdd(i.dt,E),A.SelfMulAdd(i.dt,b);var C=(g.x+S.x+A.x)/3,R=(g.y+S.y+A.y)/3;g.x-=C,g.y-=R,S.x-=C,S.y-=R,A.x-=C,A.y-=R;var x=a;x.s=we.CrossVV(p,g)+we.CrossVV(v,S)+we.CrossVV(y,A),x.c=we.DotVV(p,g)+we.DotVV(v,S)+we.DotVV(y,A);var w=de(x.s*x.s+x.c*x.c);isFinite(w)||(w=198177537e11),x.s*=w,x.c*=w;var k=l*_.strength;Me.MulRV(x,p,o),we.SubVV(o,g,o),we.MulSV(k,o,o),T.SelfAdd(o),Me.MulRV(x,v,o),we.SubVV(o,S,o),we.MulSV(k,o,o),E.SelfAdd(o),Me.MulRV(x,y,o),we.SubVV(o,A,o),we.MulSV(k,o,o),b.SelfAdd(o)}}}},{key:"SolveSpring",value:function(i){for(var n=t.SolveSpring_s_pa,r=t.SolveSpring_s_pb,s=t.SolveSpring_s_d,a=t.SolveSpring_s_f,o=this.m_positionBuffer.data,u=this.m_velocityBuffer.data,h=i.inv_dt*this.m_def.springStrength,l=0;l<this.m_pairBuffer.count;l++){var c=this.m_pairBuffer.data[l];if(c.flags&e.b2ParticleFlag.b2_springParticle){var _=c.indexA,f=c.indexB,d=n.Copy(o[_]),m=r.Copy(o[f]),p=u[_],v=u[f];d.SelfMulAdd(i.dt,p),m.SelfMulAdd(i.dt,v);var y=we.SubVV(m,d,s),g=c.distance,S=y.Length(),A=h*c.strength,T=we.MulSV(A*(g-S)/S,y,a);p.SelfSub(T),v.SelfAdd(T)}}}},{key:"SolveTensile",value:function(i){for(var n=t.SolveTensile_s_weightedNormal,r=t.SolveTensile_s_s,s=t.SolveTensile_s_f,a=this.m_velocityBuffer.data,o=0;o<this.m_count;o++)this.m_accumulation2Buffer[o]=new we,this.m_accumulation2Buffer[o].SetZero();for(var u=0;u<this.m_contactBuffer.count;u++){var h=this.m_contactBuffer.data[u];if(h.flags&e.b2ParticleFlag.b2_tensileParticle){var l=h.indexA,c=h.indexB,_=h.weight,f=h.normal,d=we.MulSV((1-_)*_,f,n);this.m_accumulation2Buffer[l].SelfSub(d),this.m_accumulation2Buffer[c].SelfAdd(d)}}for(var m=this.GetCriticalVelocity(i),p=this.m_def.surfaceTensionPressureStrength*m,v=this.m_def.surfaceTensionNormalStrength*m,y=F*m,g=0;g<this.m_contactBuffer.count;g++){var S=this.m_contactBuffer.data[g];if(S.flags&e.b2ParticleFlag.b2_tensileParticle){var A=S.indexA,T=S.indexB,E=S.weight,b=S.normal,C=this.m_weightBuffer[A]+this.m_weightBuffer[T],R=we.SubVV(this.m_accumulation2Buffer[T],this.m_accumulation2Buffer[A],r),x=ue(p*(C-2)+v*we.DotVV(R,b),y)*E,w=we.MulSV(x,b,s);a[A].SelfSub(w),a[T].SelfAdd(w)}}}},{key:"SolveViscous",value:function(){for(var i=t.SolveViscous_s_v,n=t.SolveViscous_s_f,r=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,a=this.m_def.viscousStrength,o=this.GetParticleInvMass(),u=0;u<this.m_bodyContactBuffer.count;u++){var h=this.m_bodyContactBuffer.data[u],l=h.index;if(this.m_flagsBuffer.data[l]&e.b2ParticleFlag.b2_viscousParticle){var c=h.body,_=h.weight,f=h.mass,d=r[l],m=we.SubVV(c.GetLinearVelocityFromWorldPoint(d,we.s_t0),s[l],i),p=we.MulSV(a*f*_,m,n);s[l].SelfMulAdd(o,p),c.ApplyLinearImpulse(p.SelfNeg(),d,!0)}}for(var v=0;v<this.m_contactBuffer.count;v++){var y=this.m_contactBuffer.data[v];if(y.flags&e.b2ParticleFlag.b2_viscousParticle){var g=y.indexA,S=y.indexB,A=y.weight,T=we.SubVV(s[S],s[g],i),E=we.MulSV(a*A,T,n);s[g].SelfAdd(E),s[S].SelfSub(E)}}}},{key:"SolveRepulsive",value:function(i){for(var n=t.SolveRepulsive_s_f,r=this.m_velocityBuffer.data,s=this.m_def.repulsiveStrength*this.GetCriticalVelocity(i),a=0;a<this.m_contactBuffer.count;a++){var o=this.m_contactBuffer.data[a];if(o.flags&e.b2ParticleFlag.b2_repulsiveParticle){var u=o.indexA,h=o.indexB;if(this.m_groupBuffer[u]!==this.m_groupBuffer[h]){var l=o.weight,c=o.normal,_=we.MulSV(s*l,c,n);r[u].SelfSub(_),r[h].SelfAdd(_)}}}}},{key:"SolvePowder",value:function(i){for(var n=t.SolvePowder_s_f,r=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,a=this.m_def.powderStrength*this.GetCriticalVelocity(i),o=1-D,u=this.GetParticleInvMass(),h=0;h<this.m_bodyContactBuffer.count;h++){var l=this.m_bodyContactBuffer.data[h],c=l.index;if(this.m_flagsBuffer.data[c]&e.b2ParticleFlag.b2_powderParticle){var _=l.weight;if(_>o){var f=l.body,d=l.mass,m=r[c],p=l.normal,v=we.MulSV(a*d*(_-o),p,n);s[c].SelfMulSub(u,v),f.ApplyLinearImpulse(v,m,!0)}}}for(var y=0;y<this.m_contactBuffer.count;y++){var g=this.m_contactBuffer.data[y];if(g.flags&e.b2ParticleFlag.b2_powderParticle){var S=g.weight;if(S>o){var A=g.indexA,T=g.indexB,E=g.normal,b=we.MulSV(a*(S-o),E,n);s[A].SelfSub(b),s[T].SelfAdd(b)}}}}},{key:"SolveSolid",value:function(e){var i=t.SolveSolid_s_f,n=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);for(var r=e.inv_dt*this.m_def.ejectionStrength,s=0;s<this.m_contactBuffer.count;s++){var a=this.m_contactBuffer.data[s],o=a.indexA,u=a.indexB;if(this.m_groupBuffer[o]!==this.m_groupBuffer[u]){var h=a.weight,l=a.normal,c=this.m_depthBuffer[o]+this.m_depthBuffer[u],_=we.MulSV(r*c*h,l,i);n[o].SelfSub(_),n[u].SelfAdd(_)}}}},{key:"SolveForce",value:function(e){for(var t=this.m_velocityBuffer.data,i=e.dt*this.GetParticleInvMass(),n=0;n<this.m_count;n++)t[n].SelfMulAdd(i,this.m_forceBuffer[n]);this.m_hasForce=!1}},{key:"SolveColorMixing",value:function(){var t=.5*this.m_def.colorMixingStrength;if(t)for(var i=0;i<this.m_contactBuffer.count;i++){var n=this.m_contactBuffer.data[i],r=n.indexA,s=n.indexB;if(this.m_flagsBuffer.data[r]&this.m_flagsBuffer.data[s]&e.b2ParticleFlag.b2_colorMixingParticle){var a=this.m_colorBuffer.data[r],o=this.m_colorBuffer.data[s];Ne.MixColors(a,o,t)}}}},{key:"SolveZombie",value:function(){for(var t=0,i=[],n=0;n<this.m_count;n++)i[n]=M;for(var r=0,s=0;s<this.m_count;s++){var a=this.m_flagsBuffer.data[s];if(a&e.b2ParticleFlag.b2_zombieParticle){var o=this.m_world.m_destructionListener;if(a&e.b2ParticleFlag.b2_destructionListenerParticle&&o&&o.SayGoodbyeParticle(this,s),this.m_handleIndexBuffer.data){var u=this.m_handleIndexBuffer.data[s];u&&(u.SetIndex(M),this.m_handleIndexBuffer.data[s]=null)}i[s]=M}else{if(i[s]=t,s!==t){if(this.m_handleIndexBuffer.data){var h=this.m_handleIndexBuffer.data[s];h&&h.SetIndex(t),this.m_handleIndexBuffer.data[t]=h}this.m_flagsBuffer.data[t]=this.m_flagsBuffer.data[s],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[t]=this.m_lastBodyContactStepBuffer.data[s]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[t]=this.m_bodyContactCountBuffer.data[s]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[t]=this.m_consecutiveContactStepsBuffer.data[s]),this.m_positionBuffer.data[t].Copy(this.m_positionBuffer.data[s]),this.m_velocityBuffer.data[t].Copy(this.m_velocityBuffer.data[s]),this.m_groupBuffer[t]=this.m_groupBuffer[s],this.m_hasForce&&this.m_forceBuffer[t].Copy(this.m_forceBuffer[s]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[t]=this.m_staticPressureBuffer[s]),this.m_depthBuffer&&(this.m_depthBuffer[t]=this.m_depthBuffer[s]),this.m_colorBuffer.data&&this.m_colorBuffer.data[t].Copy(this.m_colorBuffer.data[s]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[t]=this.m_userDataBuffer.data[s]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[t]=this.m_expirationTimeBuffer.data[s])}t++,r|=a}}for(var l={IsProxyInvalid:function(e){return e.index<0},IsContactInvalid:function(e){return e.indexA<0||e.indexB<0},IsBodyContactInvalid:function(e){return e.index<0},IsPairInvalid:function(e){return e.indexA<0||e.indexB<0},IsTriadInvalid:function(e){return e.indexA<0||e.indexB<0||e.indexC<0}},c=0;c<this.m_proxyBuffer.count;c++){var _=this.m_proxyBuffer.data[c];_.index=i[_.index]}this.m_proxyBuffer.RemoveIf(l.IsProxyInvalid);for(var f=0;f<this.m_contactBuffer.count;f++){var d=this.m_contactBuffer.data[f];d.indexA=i[d.indexA],d.indexB=i[d.indexB]}this.m_contactBuffer.RemoveIf(l.IsContactInvalid);for(var m=0;m<this.m_bodyContactBuffer.count;m++){var p=this.m_bodyContactBuffer.data[m];p.index=i[p.index]}this.m_bodyContactBuffer.RemoveIf(l.IsBodyContactInvalid);for(var v=0;v<this.m_pairBuffer.count;v++){var y=this.m_pairBuffer.data[v];y.indexA=i[y.indexA],y.indexB=i[y.indexB]}this.m_pairBuffer.RemoveIf(l.IsPairInvalid);for(var g=0;g<this.m_triadBuffer.count;g++){var S=this.m_triadBuffer.data[g];S.indexA=i[S.indexA],S.indexB=i[S.indexB],S.indexC=i[S.indexC]}if(this.m_triadBuffer.RemoveIf(l.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data)for(var A=0,T=0;T<this.m_count;T++){var E=i[this.m_indexByExpirationTimeBuffer.data[T]];E!==M&&(this.m_indexByExpirationTimeBuffer.data[A++]=E)}for(var b=this.m_groupList;b;b=b.GetNext()){for(var C=t,R=0,x=!1,w=b.m_firstIndex;w<b.m_lastIndex;w++){var k=i[w];k>=0?(C=ue(C,k),R=he(R,k+1)):x=!0}C<R?(b.m_firstIndex=C,b.m_lastIndex=R,x&&b.m_groupFlags&e.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(b,b.m_groupFlags|e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(b.m_firstIndex=0,b.m_lastIndex=0,b.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(b,b.m_groupFlags|e.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=t,this.m_allParticleFlags=r,this.m_needsUpdateAllParticleFlags=!1;for(var I=this.m_groupList;I;){var B=I.GetNext();I.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(I),I=B}}},{key:"SolveLifetimes",value:function(e){this.m_timeElapsed=this.LifetimeToExpirationTime(e.dt);var t=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,n=this.m_indexByExpirationTimeBuffer.data,r=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(jr(n,0,r,(function(e,t){var n=i[e],r=i[t],s=n<=0;return s===r<=0?n>r:s})),this.m_expirationTimeBufferRequiresSorting=!1);for(var s=r-1;s>=0;--s){var a=n[s],o=i[a];if(t<o||o<=0)break;this.DestroyParticle(a)}}},{key:"RotateBuffer",value:function(e,t,i){if(e!==t&&t!==i){if(Jr(this.m_flagsBuffer.data,e,t,i),this.m_lastBodyContactStepBuffer.data&&Jr(this.m_lastBodyContactStepBuffer.data,e,t,i),this.m_bodyContactCountBuffer.data&&Jr(this.m_bodyContactCountBuffer.data,e,t,i),this.m_consecutiveContactStepsBuffer.data&&Jr(this.m_consecutiveContactStepsBuffer.data,e,t,i),Jr(this.m_positionBuffer.data,e,t,i),Jr(this.m_velocityBuffer.data,e,t,i),Jr(this.m_groupBuffer,e,t,i),this.m_hasForce&&Jr(this.m_forceBuffer,e,t,i),this.m_staticPressureBuffer&&Jr(this.m_staticPressureBuffer,e,t,i),this.m_depthBuffer&&Jr(this.m_depthBuffer,e,t,i),this.m_colorBuffer.data&&Jr(this.m_colorBuffer.data,e,t,i),this.m_userDataBuffer.data&&Jr(this.m_userDataBuffer.data,e,t,i),this.m_handleIndexBuffer.data){Jr(this.m_handleIndexBuffer.data,e,t,i);for(var n=e;n<i;++n){var r=this.m_handleIndexBuffer.data[n];r&&r.SetIndex(g(r.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Jr(this.m_expirationTimeBuffer.data,e,t,i);for(var s=this.GetParticleCount(),a=this.m_indexByExpirationTimeBuffer.data,o=0;o<s;++o)a[o]=g(a[o])}for(var u=0;u<this.m_proxyBuffer.count;u++){var h=this.m_proxyBuffer.data[u];h.index=g(h.index)}for(var l=0;l<this.m_contactBuffer.count;l++){var c=this.m_contactBuffer.data[l];c.indexA=g(c.indexA),c.indexB=g(c.indexB)}for(var _=0;_<this.m_bodyContactBuffer.count;_++){var f=this.m_bodyContactBuffer.data[_];f.index=g(f.index)}for(var d=0;d<this.m_pairBuffer.count;d++){var m=this.m_pairBuffer.data[d];m.indexA=g(m.indexA),m.indexB=g(m.indexB)}for(var p=0;p<this.m_triadBuffer.count;p++){var v=this.m_triadBuffer.data[p];v.indexA=g(v.indexA),v.indexB=g(v.indexB),v.indexC=g(v.indexC)}for(var y=this.m_groupList;y;y=y.GetNext())y.m_firstIndex=g(y.m_firstIndex),y.m_lastIndex=g(y.m_lastIndex-1)+1}function g(n){return n<e?n:n<t?n+i-t:n<i?n+e-t:n}}},{key:"GetCriticalVelocity",value:function(e){return this.m_particleDiameter*e.inv_dt}},{key:"GetCriticalVelocitySquared",value:function(e){var t=this.GetCriticalVelocity(e);return t*t}},{key:"GetCriticalPressure",value:function(e){return this.m_def.density*this.GetCriticalVelocitySquared(e)}},{key:"GetParticleStride",value:function(){return D*this.m_particleDiameter}},{key:"GetParticleMass",value:function(){var e=this.GetParticleStride();return this.m_def.density*e*e}},{key:"GetParticleInvMass",value:function(){var e=this.m_inverseDiameter*(1/D);return this.m_inverseDensity*e*e}},{key:"GetFixtureContactFilter",value:function(){return this.m_allParticleFlags&e.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}},{key:"GetParticleContactFilter",value:function(){return this.m_allParticleFlags&e.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}},{key:"GetFixtureContactListener",value:function(){return this.m_allParticleFlags&e.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}},{key:"GetParticleContactListener",value:function(){return this.m_allParticleFlags&e.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}},{key:"SetUserOverridableBuffer",value:function(e,t){e.data=t,e.userSuppliedCapacity=t.length}},{key:"SetGroupFlags",value:function(t,i){var n=t.m_groupFlags;(n^i)&e.b2ParticleGroupFlag.b2_solidParticleGroup&&(i|=e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),n&~i&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&i&&(i&e.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=i),t.m_groupFlags=i}},{key:"RemoveSpuriousBodyContacts",value:function(){jr(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,t.BodyContactCompare);var e=t.RemoveSpuriousBodyContacts_s_n,i=t.RemoveSpuriousBodyContacts_s_pos,n=t.RemoveSpuriousBodyContacts_s_normal,r=3,s=this,a=-1,o=0,u=function(t){if(t.index!==a&&(o=0,a=t.index),o++>r)return!0;var u=e.Copy(t.normal);u.SelfMul(s.m_particleDiameter*(1-t.weight));var h=we.AddVV(s.m_positionBuffer.data[t.index],u,i);if(!t.fixture.TestPoint(h)){for(var l=t.fixture.GetShape().GetChildCount(),c=0;c<l;c++){var _=n;if(t.fixture.ComputeDistance(h,_,c)<p)return!1}return!0}return!1};this.m_bodyContactBuffer.count=Yr(this.m_bodyContactBuffer.data,u,this.m_bodyContactBuffer.count)}},{key:"DetectStuckParticle",value:function(e){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[e],2===this.m_bodyContactCountBuffer.data[e]&&(++this.m_consecutiveContactStepsBuffer.data[e],this.m_consecutiveContactStepsBuffer.data[e]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=e)),this.m_lastBodyContactStepBuffer.data[e]=this.m_timestamp)}},{key:"ValidateParticleIndex",value:function(e){return e>=0&&e<this.GetParticleCount()&&e!==M}},{key:"GetQuantizedTimeElapsed",value:function(){return Math.floor(this.m_timeElapsed/4294967296)}},{key:"LifetimeToExpirationTime",value:function(e){return this.m_timeElapsed+Math.floor(e/this.m_def.lifetimeGranularity*4294967296)}},{key:"ForceCanBeApplied",value:function(t){return!(t&e.b2ParticleFlag.b2_wallParticle)}},{key:"PrepareForceBuffer",value:function(){if(!this.m_hasForce){for(var e=0;e<this.m_count;e++)this.m_forceBuffer[e].SetZero();this.m_hasForce=!0}}},{key:"IsRigidGroup",value:function(t){return null!==t&&0!=(t.m_groupFlags&e.b2ParticleGroupFlag.b2_rigidParticleGroup)}},{key:"GetLinearVelocity",value:function(e,t,i,n){return e&&this.IsRigidGroup(e)?e.GetLinearVelocityFromWorldPoint(i,n):n.Copy(this.m_velocityBuffer.data[t])}},{key:"InitDampingParameter",value:function(e,t,i,n,r,s,a,o){e[0]=n>0?1/n:0,t[0]=r>0?1/r:0,i[0]=we.CrossVV(we.SubVV(a,s,we.s_t0),o)}},{key:"InitDampingParameterWithRigidGroupOrParticle",value:function(t,i,n,r,s,a,o,u){if(s&&r)this.InitDampingParameter(t,i,n,s.GetMass(),s.GetInertia(),s.GetCenter(),o,u);else{var h=this.m_flagsBuffer.data[a];this.InitDampingParameter(t,i,n,h&e.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,o,o,u)}}},{key:"ComputeDampingImpulse",value:function(e,t,i,n,r,s,a){var o=e+t*i*i+n+r*s*s;return o>0?a/o:0}},{key:"ApplyDamping",value:function(e,t,i,n,r,s,a,o){r&&n?(r.m_linearVelocity.SelfMulAdd(a*e,o),r.m_angularVelocity+=a*i*t):this.m_velocityBuffer.data[s].SelfMulAdd(a*e,o)}}],[{key:"computeTag",value:function(e,i){return(i+t.yOffset>>>0<<t.yShift)+(t.xScale*e+t.xOffset>>>0)>>>0}},{key:"computeRelativeTag",value:function(e,i,n){return e+(n<<t.yShift)+(i<<t.xShift)>>>0}},{key:"IsSignificantForce",value:function(e){return 0!==e.x||0!==e.y}},{key:"ParticleCanBeConnected",value:function(t,i){return 0!=(t&(e.b2ParticleFlag.b2_wallParticle|e.b2ParticleFlag.b2_springParticle|e.b2ParticleFlag.b2_elasticParticle))||null!==i&&0!=(i.GetGroupFlags()&e.b2ParticleGroupFlag.b2_rigidParticleGroup)}},{key:"ComparePairIndices",value:function(e,t){var i=e.indexA-t.indexA;return 0!==i?i<0:e.indexB<t.indexB}},{key:"MatchPairIndices",value:function(e,t){return e.indexA===t.indexA&&e.indexB===t.indexB}},{key:"CompareTriadIndices",value:function(e,t){var i=e.indexA-t.indexA;if(0!==i)return i<0;var n=e.indexB-t.indexB;return 0!==n?n<0:e.indexC<t.indexC}},{key:"MatchTriadIndices",value:function(e,t){return e.indexA===t.indexA&&e.indexB===t.indexB&&e.indexC===t.indexC}},{key:"InitializeParticleLists",value:function(e,t){for(var i=e.GetBufferIndex(),n=e.GetParticleCount(),r=0;r<n;r++){var s=t[r];s.list=s,s.next=null,s.count=1,s.index=r+i}}},{key:"MergeParticleLists",value:function(e,t){for(var i=t;;){i.list=e;var n=i.next;if(!n){i.next=e.next;break}i=n}e.next=t,e.count+=t.count,t.count=0}},{key:"FindLongestParticleList",value:function(e,t){for(var i=e.GetParticleCount(),n=t[0],r=0;r<i;r++){var s=t[r];n.count<s.count&&(n=s)}return n}},{key:"MergeParticleListAndNode",value:function(e,t){t.list=e,t.next=e.next,e.next=t,e.count++,t.count=0}},{key:"b2ParticleContactIsZombie",value:function(t){return(t.flags&e.b2ParticleFlag.b2_zombieParticle)===e.b2ParticleFlag.b2_zombieParticle}},{key:"BodyContactCompare",value:function(e,t){return e.index===t.index?e.weight>t.weight:e.index<t.index}}]),t}();as.xTruncBits=12,as.yTruncBits=12,as.tagBits=32,as.yOffset=1<<as.yTruncBits-1,as.yShift=as.tagBits-as.yTruncBits,as.xShift=as.tagBits-as.yTruncBits-as.xTruncBits,as.xScale=1<<as.xShift,as.xOffset=as.xScale*(1<<as.xTruncBits-1),as.yMask=(1<<as.yTruncBits)-1<<as.yShift,as.xMask=~as.yMask,as.DestroyParticlesInShape_s_aabb=new kt,as.CreateParticleGroup_s_transform=new Oe,as.ComputeCollisionEnergy_s_v=new we,as.QueryShapeAABB_s_aabb=new kt,as.QueryPointAABB_s_aabb=new kt,as.RayCast_s_aabb=new kt,as.RayCast_s_p=new we,as.RayCast_s_v=new we,as.RayCast_s_n=new we,as.RayCast_s_point=new we,as.k_pairFlags=e.b2ParticleFlag.b2_springParticle,as.k_triadFlags=e.b2ParticleFlag.b2_elasticParticle,as.k_noPressureFlags=e.b2ParticleFlag.b2_powderParticle|e.b2ParticleFlag.b2_tensileParticle,as.k_extraDampingFlags=e.b2ParticleFlag.b2_staticPressureParticle,as.k_barrierWallFlags=e.b2ParticleFlag.b2_barrierParticle|e.b2ParticleFlag.b2_wallParticle,as.CreateParticlesStrokeShapeForGroup_s_edge=new dn,as.CreateParticlesStrokeShapeForGroup_s_d=new we,as.CreateParticlesStrokeShapeForGroup_s_p=new we,as.CreateParticlesFillShapeForGroup_s_aabb=new kt,as.CreateParticlesFillShapeForGroup_s_p=new we,as.UpdatePairsAndTriads_s_dab=new we,as.UpdatePairsAndTriads_s_dbc=new we,as.UpdatePairsAndTriads_s_dca=new we,as.AddContact_s_d=new we,as.UpdateBodyContacts_s_aabb=new kt,as.Solve_s_subStep=new Ar,as.SolveCollision_s_aabb=new kt,as.SolveGravity_s_gravity=new we,as.SolveBarrier_s_aabb=new kt,as.SolveBarrier_s_va=new we,as.SolveBarrier_s_vb=new we,as.SolveBarrier_s_pba=new we,as.SolveBarrier_s_vba=new we,as.SolveBarrier_s_vc=new we,as.SolveBarrier_s_pca=new we,as.SolveBarrier_s_vca=new we,as.SolveBarrier_s_qba=new we,as.SolveBarrier_s_qca=new we,as.SolveBarrier_s_dv=new we,as.SolveBarrier_s_f=new we,as.SolvePressure_s_f=new we,as.SolveDamping_s_v=new we,as.SolveDamping_s_f=new we,as.SolveRigidDamping_s_t0=new we,as.SolveRigidDamping_s_t1=new we,as.SolveRigidDamping_s_p=new we,as.SolveRigidDamping_s_v=new we,as.SolveExtraDamping_s_v=new we,as.SolveExtraDamping_s_f=new we,as.SolveRigid_s_position=new we,as.SolveRigid_s_rotation=new Me,as.SolveRigid_s_transform=new Oe,as.SolveRigid_s_velocityTransform=new Oe,as.SolveElastic_s_pa=new we,as.SolveElastic_s_pb=new we,as.SolveElastic_s_pc=new we,as.SolveElastic_s_r=new Me,as.SolveElastic_s_t0=new we,as.SolveSpring_s_pa=new we,as.SolveSpring_s_pb=new we,as.SolveSpring_s_d=new we,as.SolveSpring_s_f=new we,as.SolveTensile_s_weightedNormal=new we,as.SolveTensile_s_s=new we,as.SolveTensile_s_f=new we,as.SolveViscous_s_v=new we,as.SolveViscous_s_f=new we,as.SolveRepulsive_s_f=new we,as.SolvePowder_s_f=new we,as.SolveSolid_s_f=new we,as.RemoveSpuriousBodyContacts_s_n=new we,as.RemoveSpuriousBodyContacts_s_pos=new we,as.RemoveSpuriousBodyContacts_s_normal=new we;var os=function(){function e(){n(this,e),this._data=null,this.userSuppliedCapacity=0}return s(e,[{key:"data",get:function(){return this._data},set:function(e){this._data=e}}]),e}(),us=function(){function e(){n(this,e),this.index=M,this.tag=0}return s(e,null,[{key:"CompareProxyProxy",value:function(e,t){return e.tag<t.tag}},{key:"CompareTagProxy",value:function(e,t){return e<t.tag}},{key:"CompareProxyTag",value:function(e,t){return e.tag<t}}]),e}(),hs=function(){function e(t,i,r,s,a){n(this,e),this.m_system=t,this.m_xLower=(i&as.xMask)>>>0,this.m_xUpper=(r&as.xMask)>>>0,this.m_yLower=(i&as.yMask)>>>0,this.m_yUpper=(r&as.yMask)>>>0,this.m_first=s,this.m_last=a}return s(e,[{key:"GetNext",value:function(){for(;this.m_first<this.m_last;){var e=(this.m_system.m_proxyBuffer.data[this.m_first].tag&as.xMask)>>>0;if(e>=this.m_xLower&&e<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return M}}]),e}(),ls=function e(){n(this,e),this.next=null,this.count=0,this.index=0},cs=function(){function e(){n(this,e)}return s(e,[{key:"Allocate",value:function(e,t){return t}},{key:"Clear",value:function(){}},{key:"GetCount",value:function(){return 0}},{key:"Invalidate",value:function(){}},{key:"GetValidBuffer",value:function(){return[]}},{key:"GetBuffer",value:function(){return[]}},{key:"SetCount",value:function(){}}]),e}(),_s=function e(t,i){n(this,e),this.second=M,this.first=t,this.second=i},fs=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"Initialize",value:function(){}},{key:"Find",value:function(){return M}}]),i}(cs),ds=function e(t,i){n(this,e),this.first=M,this.second=M,this.first=t,this.second=i},ms=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"Initialize",value:function(){}},{key:"Find",value:function(){return M}}]),i}(cs),ps=function(){function e(){n(this,e)}return s(e,[{key:"IsNecessary",value:function(){return!0}},{key:"ShouldCreatePair",value:function(){return!0}},{key:"ShouldCreateTriad",value:function(){return!0}}]),e}(),vs=function(e){h(i,e);var t=v(i);function i(e,r,s,a){var o;return n(this,i),(o=t.call(this)).m_callDestructionListener=!1,o.m_destroyed=0,o.m_system=e,o.m_shape=r,o.m_xf=s,o.m_callDestructionListener=a,o.m_destroyed=0,o}return s(i,[{key:"ReportFixture",value:function(){return!1}},{key:"ReportParticle",value:function(e,t){return e===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[t])&&(this.m_system.DestroyParticle(t,this.m_callDestructionListener),this.m_destroyed++),!0)}},{key:"Destroyed",value:function(){return this.m_destroyed}}]),i}(vr),ys=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this)).m_threshold=0,r.m_threshold=e,r}return s(i,[{key:"ShouldCreatePair",value:function(e,t){return e<this.m_threshold&&this.m_threshold<=t||t<this.m_threshold&&this.m_threshold<=e}},{key:"ShouldCreateTriad",value:function(e,t,i){return(e<this.m_threshold||t<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=e||this.m_threshold<=t||this.m_threshold<=i)}}]),i}(ps),gs=function(t){h(a,t);var i=v(a);function a(t){var r,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.length;return n(this,a),(r=i.call(this,e.b2ShapeType.e_unknown,0)).m_shapeCount=0,r.m_shapes=t,r.m_shapeCount=s,r}return s(a,[{key:"Clone",value:function(){throw new Error}},{key:"GetChildCount",value:function(){return 1}},{key:"TestPoint",value:function(e,t){for(var i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(e,t))return!0;return!1}},{key:"ComputeDistance",value:function(){return 0}},{key:"RayCast",value:function(){return!1}},{key:"ComputeAABB",value:function(e,t){var i=new kt;e.lowerBound.x=+r,e.lowerBound.y=+r,e.upperBound.x=-r,e.upperBound.y=-r;for(var n=0;n<this.m_shapeCount;n++)for(var s=this.m_shapes[n].GetChildCount(),a=0;a<s;a++){var o=i;this.m_shapes[n].ComputeAABB(o,t,a),e.Combine1(o)}}},{key:"ComputeMass",value:function(){}},{key:"SetupDistanceProxy",value:function(){}},{key:"ComputeSubmergedArea",value:function(){return 0}},{key:"Dump",value:function(){}}]),a}(cn),Ss=function(t){h(r,t);var i=v(r);function r(e){var t;return n(this,r),(t=i.call(this)).m_flagsBuffer=e,t}return s(r,[{key:"IsNecessary",value:function(t){return 0!=(this.m_flagsBuffer.data[t]&e.b2ParticleFlag.b2_reactiveParticle)}}]),r}(ps),As=function(t){h(r,t);var i=v(r);function r(e){var t,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return n(this,r),(t=i.call(this,e)).m_contactFilter=null,t.m_contactFilter=s,t}return s(r,[{key:"ShouldCollideFixtureParticle",value:function(t,i,n){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[n]&e.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(t,this.m_system,n)}},{key:"ReportFixtureAndParticle",value:function(t,i,n){var s=r.ReportFixtureAndParticle_s_n,a=r.ReportFixtureAndParticle_s_rp,o=this.m_system.m_positionBuffer.data[n],u=s,h=t.ComputeDistance(o,u,i);if(h<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(t,this.m_system,n)){var l=t.GetBody(),c=l.GetWorldCenter(),_=l.GetMass(),f=l.GetInertia()-_*l.GetLocalCenter().LengthSquared(),d=_>0?1/_:0,m=f>0?1/f:0,p=this.m_system.m_flagsBuffer.data[n]&e.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),v=we.SubVV(o,c,a),y=we.CrossVV(v,u),g=p+d+m*y*y,S=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];S.index=n,S.body=l,S.fixture=t,S.weight=1-h*this.m_system.m_inverseDiameter,S.normal.Copy(u.SelfNeg()),S.mass=g>0?1/g:0,this.m_system.DetectStuckParticle(n)}}}]),r}(es);As.ReportFixtureAndParticle_s_n=new we,As.ReportFixtureAndParticle_s_rp=new we;var Ts=function(t){h(r,t);var i=v(r);function r(e,t){var s;return n(this,r),(s=i.call(this,e)).m_step=t,s}return s(r,[{key:"ReportFixtureAndParticle",value:function(t,i,n){var s=r.ReportFixtureAndParticle_s_p1,a=r.ReportFixtureAndParticle_s_output,o=r.ReportFixtureAndParticle_s_input,u=r.ReportFixtureAndParticle_s_p,h=r.ReportFixtureAndParticle_s_v,l=r.ReportFixtureAndParticle_s_f,c=t.GetBody(),_=this.m_system.m_positionBuffer.data[n],f=this.m_system.m_velocityBuffer.data[n],d=a,m=o;if(0===this.m_system.m_iterationIndex){var v=Oe.MulTXV(c.m_xf0,_,s);t.GetShape().GetType()===e.b2ShapeType.e_circleShape&&(v.SelfSub(c.GetLocalCenter()),Me.MulRV(c.m_xf0.q,v,v),Me.MulTRV(c.m_xf.q,v,v),v.SelfAdd(c.GetLocalCenter())),Oe.MulXV(c.m_xf,v,m.p1)}else m.p1.Copy(_);if(we.AddVMulSV(_,this.m_step.dt,f,m.p2),m.maxFraction=1,t.RayCast(d,m,i)){var y=d.normal,g=u;g.x=(1-d.fraction)*m.p1.x+d.fraction*m.p2.x+p*y.x,g.y=(1-d.fraction)*m.p1.y+d.fraction*m.p2.y+p*y.y;var S=h;S.x=this.m_step.inv_dt*(g.x-_.x),S.y=this.m_step.inv_dt*(g.y-_.y),this.m_system.m_velocityBuffer.data[n].Copy(S);var A=l;A.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(f.x-S.x),A.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(f.y-S.y),this.m_system.ParticleApplyForce(n,A)}}},{key:"ReportParticle",value:function(){return!1}}]),r}(es);Ts.ReportFixtureAndParticle_s_p1=new we,Ts.ReportFixtureAndParticle_s_output=new wt,Ts.ReportFixtureAndParticle_s_input=new xt,Ts.ReportFixtureAndParticle_s_p=new we,Ts.ReportFixtureAndParticle_s_v=new we,Ts.ReportFixtureAndParticle_s_f=new we;var Es=function(){function t(e){n(this,t),this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new gr,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new we,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new Sr,this.m_island=new Mr,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(e)}return s(t,[{key:"SetDestructionListener",value:function(e){this.m_destructionListener=e}},{key:"SetContactFilter",value:function(e){this.m_contactManager.m_contactFilter=e}},{key:"SetContactListener",value:function(e){this.m_contactManager.m_contactListener=e}},{key:"SetDebugDraw",value:function(e){this.m_debugDraw=e}},{key:"CreateBody",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.IsLocked())throw new Error;var t=new bn(e,this);return t.m_prev=null,t.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=t),this.m_bodyList=t,++this.m_bodyCount,t}},{key:"DestroyBody",value:function(e){if(this.IsLocked())throw new Error;for(var t=e.m_jointList;t;){var i=t;t=t.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),e.m_jointList=t}e.m_jointList=null;for(var n=e.m_controllerList;n;){var r=n;n=n.nextController,r.controller.RemoveBody(e)}for(var s=e.m_contactList;s;){var a=s;s=s.next,this.m_contactManager.Destroy(a.contact)}e.m_contactList=null;for(var o=e.m_fixtureList;o;){var u=o;o=o.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(u),u.DestroyProxies(),u.Reset(),e.m_fixtureList=o,e.m_fixtureCount-=1}e.m_fixtureList=null,e.m_fixtureCount=0,e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_bodyList&&(this.m_bodyList=e.m_next),--this.m_bodyCount}},{key:"CreateJoint",value:function(e){if(this.IsLocked())throw new Error;var i=t._Joint_Create(e);i.m_prev=null,i.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=i),this.m_jointList=i,++this.m_jointCount,i.m_edgeA.prev=null,i.m_edgeA.next=i.m_bodyA.m_jointList,i.m_bodyA.m_jointList&&(i.m_bodyA.m_jointList.prev=i.m_edgeA),i.m_bodyA.m_jointList=i.m_edgeA,i.m_edgeB.prev=null,i.m_edgeB.next=i.m_bodyB.m_jointList,i.m_bodyB.m_jointList&&(i.m_bodyB.m_jointList.prev=i.m_edgeB),i.m_bodyB.m_jointList=i.m_edgeB;var n=i.m_bodyA,r=i.m_bodyB;if(!i.m_collideConnected)for(var s=r.GetContactList();s;)s.other===n&&s.contact.FlagForFiltering(),s=s.next;return i}},{key:"DestroyJoint",value:function(e){if(this.IsLocked())throw new Error;e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_jointList&&(this.m_jointList=e.m_next);var i=e.m_bodyA,n=e.m_bodyB,r=e.m_collideConnected;if(i.SetAwake(!0),n.SetAwake(!0),e.m_edgeA.prev&&(e.m_edgeA.prev.next=e.m_edgeA.next),e.m_edgeA.next&&(e.m_edgeA.next.prev=e.m_edgeA.prev),e.m_edgeA===i.m_jointList&&(i.m_jointList=e.m_edgeA.next),e.m_edgeA.Reset(),e.m_edgeB.prev&&(e.m_edgeB.prev.next=e.m_edgeB.next),e.m_edgeB.next&&(e.m_edgeB.next.prev=e.m_edgeB.prev),e.m_edgeB===n.m_jointList&&(n.m_jointList=e.m_edgeB.next),e.m_edgeB.Reset(),t._Joint_Destroy(e),--this.m_jointCount,!r)for(var s=n.GetContactList();s;)s.other===i&&s.contact.FlagForFiltering(),s=s.next}},{key:"CreateParticleSystem",value:function(e){if(this.IsLocked())throw new Error;var t=new as(e,this);return t.m_prev=null,t.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=t),this.m_particleSystemList=t,t}},{key:"DestroyParticleSystem",value:function(e){if(this.IsLocked())throw new Error;e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_particleSystemList&&(this.m_particleSystemList=e.m_next)}},{key:"CalculateReasonableParticleIterations",value:function(e){if(null===this.m_particleSystemList)return 1;function t(e){for(var t=r,i=e.GetParticleSystemList();null!==i;i=i.m_next)t=ue(t,i.GetRadius());return t}return Dr(this.m_gravity.Length(),t(this),e)}},{key:"Step",value:function(e,i,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.CalculateReasonableParticleIterations(e),s=t.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;var a=t.Step_s_step;a.dt=e,a.velocityIterations=i,a.positionIterations=n,a.particleIterations=r,a.inv_dt=e>0?1/e:0,a.dtRatio=this.m_inv_dt0*e,a.warmStarting=this.m_warmStarting;var o=t.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=o.GetMilliseconds(),this.m_stepComplete&&a.dt>0){for(var u=t.Step_s_timer.Reset(),h=this.m_particleSystemList;h;h=h.m_next)h.Solve(a);this.Solve(a),this.m_profile.solve=u.GetMilliseconds()}if(this.m_continuousPhysics&&a.dt>0){var l=t.Step_s_timer.Reset();this.SolveTOI(a),this.m_profile.solveTOI=l.GetMilliseconds()}a.dt>0&&(this.m_inv_dt0=a.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=s.GetMilliseconds()}},{key:"ClearForces",value:function(){for(var e=this.m_bodyList;e;e=e.m_next)e.m_force.SetZero(),e.m_torque=0}},{key:"DrawParticleSystem",value:function(e){if(null!==this.m_debugDraw){var t=e.GetParticleCount();if(t){var i=e.GetRadius(),n=e.GetPositionBuffer();if(e.m_colorBuffer.data){var r=e.GetColorBuffer();this.m_debugDraw.DrawParticles(n,i,r,t)}else this.m_debugDraw.DrawParticles(n,i,null,t)}}}},{key:"DrawDebugData",value:function(){if(null!==this.m_debugDraw){var i=this.m_debugDraw.GetFlags(),n=t.DrawDebugData_s_color.SetRGB(0,0,0);if(i&e.b2DrawFlags.e_shapeBit)for(var r=this.m_bodyList;r;r=r.m_next){var s=r.m_xf;this.m_debugDraw.PushTransform(s);for(var a=r.GetFixtureList();a;a=a.m_next)r.IsActive()?r.GetType()===e.b2BodyType.b2_staticBody?(n.SetRGB(.5,.9,.5),this.DrawShape(a,n)):r.GetType()===e.b2BodyType.b2_kinematicBody?(n.SetRGB(.5,.5,.9),this.DrawShape(a,n)):r.IsAwake()?(n.SetRGB(.9,.7,.7),this.DrawShape(a,n)):(n.SetRGB(.6,.6,.6),this.DrawShape(a,n)):(n.SetRGB(.5,.5,.3),this.DrawShape(a,n));this.m_debugDraw.PopTransform(s)}if(i&e.b2DrawFlags.e_particleBit)for(var o=this.m_particleSystemList;o;o=o.m_next)this.DrawParticleSystem(o);if(i&e.b2DrawFlags.e_jointBit)for(var u=this.m_jointList;u;u=u.m_next)this.DrawJoint(u);if(i&e.b2DrawFlags.e_aabbBit){n.SetRGB(.9,.3,.9);for(var h=t.DrawDebugData_s_vs,l=this.m_bodyList;l;l=l.m_next)if(l.IsActive())for(var c=l.GetFixtureList();c;c=c.m_next)for(var _=0;_<c.m_proxyCount;++_){var f=c.m_proxies[_].treeNode.aabb;h[0].Set(f.lowerBound.x,f.lowerBound.y),h[1].Set(f.upperBound.x,f.lowerBound.y),h[2].Set(f.upperBound.x,f.upperBound.y),h[3].Set(f.lowerBound.x,f.upperBound.y),this.m_debugDraw.DrawPolygon(h,4,n)}}if(i&e.b2DrawFlags.e_centerOfMassBit)for(var d=this.m_bodyList;d;d=d.m_next){var m=t.DrawDebugData_s_xf;m.q.Copy(d.m_xf.q),m.p.Copy(d.GetWorldCenter()),this.m_debugDraw.DrawTransform(m)}if(i&e.b2DrawFlags.e_controllerBit)for(var p=this.m_controllerList;p;p=p.m_next)p.Draw(this.m_debugDraw)}}},{key:"QueryAABB",value:function(){(arguments.length<=0?void 0:arguments[0])instanceof vr?this._QueryAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])}},{key:"_QueryAABB",value:function(e,t,i){if(this.m_contactManager.m_broadPhase.Query(t,(function(t){var n=t.userData.fixture;return e?e.ReportFixture(n):!i||i(n)})),e instanceof vr)for(var n=this.m_particleSystemList;n;n=n.m_next)e.ShouldQueryParticleSystem(n)&&n.QueryAABB(e,t)}},{key:"QueryAllAABB",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this.QueryAABB(e,(function(e){return t.push(e),!0})),t}},{key:"QueryPointAABB",value:function(){(arguments.length<=0?void 0:arguments[0])instanceof vr?this._QueryPointAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryPointAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])}},{key:"_QueryPointAABB",value:function(e,t,i){if(this.m_contactManager.m_broadPhase.QueryPoint(t,(function(t){var n=t.userData.fixture;return e?e.ReportFixture(n):!i||i(n)})),e instanceof vr)for(var n=this.m_particleSystemList;n;n=n.m_next)e.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(e,t)}},{key:"QueryAllPointAABB",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this.QueryPointAABB(e,(function(e){return t.push(e),!0})),t}},{key:"QueryFixtureShape",value:function(){(arguments.length<=0?void 0:arguments[0])instanceof vr?this._QueryFixtureShape(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3]):this._QueryFixtureShape(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3])}},{key:"_QueryFixtureShape",value:function(e,i,n,r,s){var a=t.QueryFixtureShape_s_aabb;if(i.ComputeAABB(a,r,n),this.m_contactManager.m_broadPhase.Query(a,(function(t){var a=t.userData,o=a.fixture;if(Dt(i,n,o.GetShape(),a.childIndex,r,o.GetBody().GetTransform())){if(e)return e.ReportFixture(o);if(s)return s(o)}return!0})),e instanceof vr)for(var o=this.m_particleSystemList;o;o=o.m_next)e.ShouldQueryParticleSystem(o)&&o.QueryAABB(e,a)}},{key:"QueryAllFixtureShape",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return this.QueryFixtureShape(e,t,i,(function(e){return n.push(e),!0})),n}},{key:"QueryFixturePoint",value:function(){(arguments.length<=0?void 0:arguments[0])instanceof vr?this._QueryFixturePoint(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryFixturePoint(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])}},{key:"_QueryFixturePoint",value:function(e,t,i){if(this.m_contactManager.m_broadPhase.QueryPoint(t,(function(n){var r=n.userData.fixture;if(r.TestPoint(t)){if(e)return e.ReportFixture(r);if(i)return i(r)}return!0})),e)for(var n=this.m_particleSystemList;n;n=n.m_next)e.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(e,t)}},{key:"QueryAllFixturePoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this.QueryFixturePoint(e,(function(e){return t.push(e),!0})),t}},{key:"RayCast",value:function(){(arguments.length<=0?void 0:arguments[0])instanceof yr?this._RayCast(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2]):this._RayCast(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2])}},{key:"_RayCast",value:function(e,i,n,r){var s=t.RayCast_s_input;if(s.maxFraction=1,s.p1.Copy(i),s.p2.Copy(n),this.m_contactManager.m_broadPhase.RayCast(s,(function(s,a){var o=a.userData,u=o.fixture,h=o.childIndex,l=t.RayCast_s_output;if(u.RayCast(l,s,h)){var c=l.fraction,_=t.RayCast_s_point;if(_.Set((1-c)*i.x+c*n.x,(1-c)*i.y+c*n.y),e)return e.ReportFixture(u,_,l.normal,c);if(r)return r(u,_,l.normal,c)}return s.maxFraction})),e)for(var a=this.m_particleSystemList;a;a=a.m_next)e.ShouldQueryParticleSystem(a)&&a.RayCast(e,i,n)}},{key:"RayCastOne",value:function(e,t){var i=null,n=1;return this.RayCast(e,t,(function(e,t,r,s){return s<n&&(n=s,i=e),n})),i}},{key:"RayCastAll",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return this.RayCast(e,t,(function(e){return i.push(e),1})),i}},{key:"GetBodyList",value:function(){return this.m_bodyList}},{key:"GetJointList",value:function(){return this.m_jointList}},{key:"GetParticleSystemList",value:function(){return this.m_particleSystemList}},{key:"GetContactList",value:function(){return this.m_contactManager.m_contactList}},{key:"SetAllowSleeping",value:function(e){if(e!==this.m_allowSleep&&(this.m_allowSleep=e,!this.m_allowSleep))for(var t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}},{key:"GetAllowSleeping",value:function(){return this.m_allowSleep}},{key:"SetWarmStarting",value:function(e){this.m_warmStarting=e}},{key:"GetWarmStarting",value:function(){return this.m_warmStarting}},{key:"SetContinuousPhysics",value:function(e){this.m_continuousPhysics=e}},{key:"GetContinuousPhysics",value:function(){return this.m_continuousPhysics}},{key:"SetSubStepping",value:function(e){this.m_subStepping=e}},{key:"GetSubStepping",value:function(){return this.m_subStepping}},{key:"GetProxyCount",value:function(){return this.m_contactManager.m_broadPhase.GetProxyCount()}},{key:"GetBodyCount",value:function(){return this.m_bodyCount}},{key:"GetJointCount",value:function(){return this.m_jointCount}},{key:"GetContactCount",value:function(){return this.m_contactManager.m_contactCount}},{key:"GetTreeHeight",value:function(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}},{key:"GetTreeBalance",value:function(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}},{key:"GetTreeQuality",value:function(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}},{key:"SetGravity",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!we.IsEqualToV(this.m_gravity,e)&&(this.m_gravity.Copy(e),t))for(var i=this.m_bodyList;i;i=i.m_next)i.SetAwake(!0)}},{key:"GetGravity",value:function(){return this.m_gravity}},{key:"IsLocked",value:function(){return this.m_locked}},{key:"SetAutoClearForces",value:function(e){this.m_clearForces=e}},{key:"GetAutoClearForces",value:function(){return this.m_clearForces}},{key:"ShiftOrigin",value:function(e){if(this.IsLocked())throw new Error;for(var t=this.m_bodyList;t;t=t.m_next)t.m_xf.p.SelfSub(e),t.m_sweep.c0.SelfSub(e),t.m_sweep.c.SelfSub(e);for(var i=this.m_jointList;i;i=i.m_next)i.ShiftOrigin(e);this.m_contactManager.m_broadPhase.ShiftOrigin(e)}},{key:"GetContactManager",value:function(){return this.m_contactManager}},{key:"GetProfile",value:function(){return this.m_profile}},{key:"Dump",value:function(t){if(!this.m_locked){t("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),t("this.m_world.SetGravity(g);\n"),t("const bodies: b2Body[] = [];\n"),t("const joints: b2Joint[] = [];\n");for(var i=0,n=this.m_bodyList;n;n=n.m_next)n.m_islandIndex=i,n.Dump(t),++i;i=0;for(var r=this.m_jointList;r;r=r.m_next)r.m_index=i,++i;for(var s=this.m_jointList;s;s=s.m_next)s.m_type!==e.b2JointType.e_gearJoint&&(t("{\n"),s.Dump(t),t("}\n"));for(var a=this.m_jointList;a;a=a.m_next)a.m_type===e.b2JointType.e_gearJoint&&(t("{\n"),a.Dump(t),t("}\n"))}}},{key:"DrawJoint",value:function(i){if(null!==this.m_debugDraw){var n=i.GetBodyA(),r=i.GetBodyB(),s=n.m_xf,a=r.m_xf,o=s.p,u=a.p,h=i.GetAnchorA(t.DrawJoint_s_p1),l=i.GetAnchorB(t.DrawJoint_s_p2),c=t.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(i.m_type){case e.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(h,l,c);break;case e.b2JointType.e_pulleyJoint:var _=i,f=_.GetGroundAnchorA(),d=_.GetGroundAnchorB();this.m_debugDraw.DrawSegment(f,h,c),this.m_debugDraw.DrawSegment(d,l,c),this.m_debugDraw.DrawSegment(f,d,c);break;case e.b2JointType.e_mouseJoint:var m=t.DrawJoint_s_c;m.Set(0,1,0),this.m_debugDraw.DrawPoint(h,4,m),this.m_debugDraw.DrawPoint(l,4,m),m.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(h,l,m);break;default:this.m_debugDraw.DrawSegment(o,h,c),this.m_debugDraw.DrawSegment(h,l,c),this.m_debugDraw.DrawSegment(u,l,c)}}}},{key:"DrawShape",value:function(i,n){if(null!==this.m_debugDraw){var r=i.GetShape();switch(r.m_type){case e.b2ShapeType.e_circleShape:var s=r,a=s.m_p,o=s.m_radius,u=we.UNITX;this.m_debugDraw.DrawSolidCircle(a,o,u,n);break;case e.b2ShapeType.e_edgeShape:var h=r,l=h.m_vertex1,c=h.m_vertex2;this.m_debugDraw.DrawSegment(l,c,n);break;case e.b2ShapeType.e_chainShape:var _=r,f=_.m_count,d=_.m_vertices,m=t.DrawShape_s_ghostColor.SetRGBA(.75*n.r,.75*n.g,.75*n.b,n.a),p=d[0];if(this.m_debugDraw.DrawPoint(p,4,n),_.m_hasPrevVertex){var v=_.m_prevVertex;this.m_debugDraw.DrawSegment(v,p,m),this.m_debugDraw.DrawCircle(v,.1,m)}for(var y=1;y<f;++y){var g=d[y];this.m_debugDraw.DrawSegment(p,g,n),this.m_debugDraw.DrawPoint(g,4,n),p=g}if(_.m_hasNextVertex){var S=_.m_nextVertex;this.m_debugDraw.DrawSegment(S,p,m),this.m_debugDraw.DrawCircle(S,.1,m)}break;case e.b2ShapeType.e_polygonShape:var A=r,T=A.m_count,E=A.m_vertices;this.m_debugDraw.DrawSolidPolygon(E,T,n)}}}},{key:"Solve",value:function(t){for(var i=this.m_bodyList;i;i=i.m_next)i.m_xf0.Copy(i.m_xf);for(var n=this.m_controllerList;n;n=n.m_next)n.Step(t);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;var r=this.m_island;r.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(var s=this.m_bodyList;s;s=s.m_next)s.m_islandFlag=!1;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_islandFlag=!1;for(var o=this.m_jointList;o;o=o.m_next)o.m_islandFlag=!1;for(var u=this.s_stack,h=this.m_bodyList;h;h=h.m_next)if(!h.m_islandFlag&&h.IsAwake()&&h.IsActive()&&h.GetType()!==e.b2BodyType.b2_staticBody){r.Clear();var l=0;for(u[l++]=h,h.m_islandFlag=!0;l>0;){var c=u[--l];if(!c)throw new Error;if(r.AddBody(c),c.m_awakeFlag=!0,c.GetType()!==e.b2BodyType.b2_staticBody){for(var _=c.m_contactList;_;_=_.next){var f=_.contact;if(!f.m_islandFlag&&f.IsEnabled()&&f.IsTouching()){var d=f.m_fixtureA.m_isSensor,m=f.m_fixtureB.m_isSensor;if(!d&&!m){r.AddContact(f),f.m_islandFlag=!0;var p=_.other;p.m_islandFlag||(u[l++]=p,p.m_islandFlag=!0)}}}for(var v=c.m_jointList;v;v=v.next)if(!v.joint.m_islandFlag){var y=v.other;y.IsActive()&&(r.AddJoint(v.joint),v.joint.m_islandFlag=!0,y.m_islandFlag||(u[l++]=y,y.m_islandFlag=!0))}}}var g=new Sr;r.Solve(g,t,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=g.solveInit,this.m_profile.solveVelocity+=g.solveVelocity,this.m_profile.solvePosition+=g.solvePosition;for(var S=0;S<r.m_bodyCount;++S){var A=r.m_bodies[S];A.GetType()===e.b2BodyType.b2_staticBody&&(A.m_islandFlag=!1)}}for(var T=0;T<u.length&&u[T];++T)u[T]=null;for(var E=new Ge,b=this.m_bodyList;b;b=b.m_next)b.m_islandFlag&&b.GetType()!==e.b2BodyType.b2_staticBody&&b.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=E.GetMilliseconds()}},{key:"SolveTOI",value:function(i){var n=this.m_island;if(n.Initialize(2*T,T,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(var r=this.m_bodyList;r;r=r.m_next)r.m_islandFlag=!1,r.m_sweep.alpha0=0;for(var s=this.m_contactManager.m_contactList;s;s=s.m_next)s.m_toiFlag=!1,s.m_islandFlag=!1,s.m_toiCount=0,s.m_toi=1}for(;;){for(var o=null,u=1,h=this.m_contactManager.m_contactList;h;h=h.m_next)if(h.IsEnabled()&&!(h.m_toiCount>A)){var l=1;if(h.m_toiFlag)l=h.m_toi;else{var c=h.GetFixtureA(),_=h.GetFixtureB();if(c.IsSensor()||_.IsSensor())continue;var f=c.GetBody(),d=_.GetBody(),m=f.m_type,p=d.m_type,v=f.IsAwake()&&m!==e.b2BodyType.b2_staticBody,y=d.IsAwake()&&p!==e.b2BodyType.b2_staticBody;if(!v&&!y)continue;var g=f.IsBullet()||m!==e.b2BodyType.b2_dynamicBody,S=d.IsBullet()||p!==e.b2BodyType.b2_dynamicBody;if(!g&&!S)continue;var E=f.m_sweep.alpha0;f.m_sweep.alpha0<d.m_sweep.alpha0?(E=d.m_sweep.alpha0,f.m_sweep.Advance(E)):d.m_sweep.alpha0<f.m_sweep.alpha0&&(E=f.m_sweep.alpha0,d.m_sweep.Advance(E));var b=h.GetChildIndexA(),C=h.GetChildIndexB(),R=t.SolveTOI_s_toi_input;R.proxyA.SetShape(c.GetShape(),b),R.proxyB.SetShape(_.GetShape(),C),R.sweepA.Copy(f.m_sweep),R.sweepB.Copy(d.m_sweep),R.tMax=1;var x=t.SolveTOI_s_toi_output;fi(x,R);var w=x.t;l=x.state===e.b2TOIOutputState.e_touching?ue(E+(1-E)*w,1):1,h.m_toi=l,h.m_toiFlag=!0}l<u&&(o=h,u=l)}if(null===o||1-10*a<u){this.m_stepComplete=!0;break}var k=o.GetFixtureA(),I=o.GetFixtureB(),B=k.GetBody(),P=I.GetBody(),M=t.SolveTOI_s_backup1.Copy(B.m_sweep),O=t.SolveTOI_s_backup2.Copy(P.m_sweep);if(B.Advance(u),P.Advance(u),o.Update(this.m_contactManager.m_contactListener),o.m_toiFlag=!1,++o.m_toiCount,o.IsEnabled()&&o.IsTouching()){B.SetAwake(!0),P.SetAwake(!0),n.Clear(),n.AddBody(B),n.AddBody(P),n.AddContact(o),B.m_islandFlag=!0,P.m_islandFlag=!0,o.m_islandFlag=!0;for(var D=0;D<2;++D){var L=0===D?B:P;if(L.m_type===e.b2BodyType.b2_dynamicBody)for(var N=L.m_contactList;N&&n.m_bodyCount!==n.m_bodyCapacity&&n.m_contactCount!==n.m_contactCapacity;N=N.next){var F=N.contact;if(!F.m_islandFlag){var G=N.other;if(G.m_type!==e.b2BodyType.b2_dynamicBody||L.IsBullet()||G.IsBullet()){var V=F.m_fixtureA.m_isSensor,U=F.m_fixtureB.m_isSensor;if(!V&&!U){var H=t.SolveTOI_s_backup.Copy(G.m_sweep);G.m_islandFlag||G.Advance(u),F.Update(this.m_contactManager.m_contactListener),F.IsEnabled()&&F.IsTouching()?(F.m_islandFlag=!0,n.AddContact(F),G.m_islandFlag||(G.m_islandFlag=!0,G.m_type!==e.b2BodyType.b2_staticBody&&G.SetAwake(!0),n.AddBody(G))):(G.m_sweep.Copy(H),G.SynchronizeTransform())}}}}}var z=t.SolveTOI_s_subStep;z.dt=(1-u)*i.dt,z.inv_dt=1/z.dt,z.dtRatio=1,z.positionIterations=20,z.velocityIterations=i.velocityIterations,z.particleIterations=i.particleIterations,z.warmStarting=!1,n.SolveTOI(z,B.m_islandIndex,P.m_islandIndex);for(var W=0;W<n.m_bodyCount;++W){var X=n.m_bodies[W];if(X.m_islandFlag=!1,X.m_type===e.b2BodyType.b2_dynamicBody){X.SynchronizeFixtures();for(var j=X.m_contactList;j;j=j.next)j.contact.m_toiFlag=!1,j.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}else o.SetEnabled(!1),B.m_sweep.Copy(M),P.m_sweep.Copy(O),B.SynchronizeTransform(),P.SynchronizeTransform()}}},{key:"AddController",value:function(e){return e.m_next=this.m_controllerList,e.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=e),this.m_controllerList=e,++this.m_controllerCount,e}},{key:"RemoveController",value:function(e){return e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),this.m_controllerList===e&&(this.m_controllerList=e.m_next),--this.m_controllerCount,e.m_prev=null,e.m_next=null,e}}],[{key:"_Joint_Create",value:function(t){switch(t.type){case e.b2JointType.e_distanceJoint:return new In(t);case e.b2JointType.e_mouseJoint:return new Vn(t);case e.b2JointType.e_prismaticJoint:return new Hn(t);case e.b2JointType.e_revoluteJoint:return new qn(t);case e.b2JointType.e_pulleyJoint:return new Xn(t);case e.b2JointType.e_gearJoint:return new Ln(t);case e.b2JointType.e_wheelJoint:return new $n(t);case e.b2JointType.e_weldJoint:return new Jn(t);case e.b2JointType.e_frictionJoint:return new On(t);case e.b2JointType.e_ropeJoint:return new Kn(t);case e.b2JointType.e_motorJoint:return new Fn(t);case e.b2JointType.e_areaJoint:return new Pn(t)}throw new Error}},{key:"_Joint_Destroy",value:function(){}}]),t}();Es.Step_s_step=new Ar,Es.Step_s_stepTimer=new Ge,Es.Step_s_timer=new Ge,Es.DrawDebugData_s_color=new Ne(0,0,0),Es.DrawDebugData_s_vs=we.MakeArray(4),Es.DrawDebugData_s_xf=new Oe,Es.QueryFixtureShape_s_aabb=new kt,Es.RayCast_s_input=new xt,Es.RayCast_s_output=new wt,Es.RayCast_s_point=new we,Es.DrawJoint_s_p1=new we,Es.DrawJoint_s_p2=new we,Es.DrawJoint_s_color=new Ne(.5,.8,.8),Es.DrawJoint_s_c=new Ne,Es.DrawShape_s_ghostColor=new Ne,Es.SolveTOI_s_subStep=new Ar,Es.SolveTOI_s_backup=new Le,Es.SolveTOI_s_backup1=new Le,Es.SolveTOI_s_backup2=new Le,Es.SolveTOI_s_toi_input=new ei,Es.SolveTOI_s_toi_output=new ii;var bs=function e(t,i){n(this,e),this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=i},Cs=function(){function e(){n(this,e),this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}return s(e,[{key:"GetNext",value:function(){return this.m_next}},{key:"GetPrev",value:function(){return this.m_prev}},{key:"GetBodyList",value:function(){return this.m_bodyList}},{key:"AddBody",value:function(e){var t=new bs(this,e);t.nextBody=this.m_bodyList,t.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=t),this.m_bodyList=t,++this.m_bodyCount,t.nextController=e.m_controllerList,t.prevController=null,e.m_controllerList&&(e.m_controllerList.prevController=t),e.m_controllerList=t,++e.m_controllerCount}},{key:"RemoveBody",value:function(e){if(this.m_bodyCount<=0)throw new Error;for(var t=this.m_bodyList;t&&t.body!==e;)t=t.nextBody;if(null===t)throw new Error;t.prevBody&&(t.prevBody.nextBody=t.nextBody),t.nextBody&&(t.nextBody.prevBody=t.prevBody),this.m_bodyList===t&&(this.m_bodyList=t.nextBody),--this.m_bodyCount,t.nextController&&(t.nextController.prevController=t.prevController),t.prevController&&(t.prevController.nextController=t.nextController),e.m_controllerList===t&&(e.m_controllerList=t.nextController),--e.m_controllerCount}},{key:"Clear",value:function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0}}]),e}(),Rs=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments)).normal=new we(0,1),e.offset=0,e.density=0,e.velocity=new we(0,0),e.linearDrag=0,e.angularDrag=0,e.useDensity=!1,e.useWorldGravity=!0,e.gravity=new we(0,0),e}return s(i,[{key:"Step",value:function(){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(var e=this.m_bodyList;e;e=e.nextBody){var t=e.body;if(t.IsAwake()){for(var i=new we,n=new we,r=0,s=0,o=t.GetFixtureList();o;o=o.m_next){var u=new we,h=o.GetShape().ComputeSubmergedArea(this.normal,this.offset,t.GetTransform(),u);r+=h,i.x+=h*u.x,i.y+=h*u.y;var l=0;s+=h*(l=this.useDensity?o.GetDensity():1),n.x+=h*u.x*l,n.y+=h*u.y*l}if(i.x/=r,i.y/=r,n.x/=s,n.y/=s,!(r<a)){var c=this.gravity.Clone().SelfNeg();c.SelfMul(this.density*r),t.ApplyForce(c,n);var _=t.GetLinearVelocityFromWorldPoint(i,new we);_.SelfSub(this.velocity),_.SelfMul(-this.linearDrag*r),t.ApplyForce(_,i),t.ApplyTorque(-t.GetInertia()/t.GetMass()*r*t.GetAngularVelocity()*this.angularDrag)}}}}}},{key:"Draw",value:function(e){var t=100,i=new we,n=new we;i.x=this.normal.x*this.offset+this.normal.y*t,i.y=this.normal.y*this.offset-this.normal.x*t,n.x=this.normal.x*this.offset-this.normal.y*t,n.y=this.normal.y*this.offset+this.normal.x*t;var r=new Ne(0,0,.8);e.DrawSegment(i,n,r)}}]),i}(Cs),xs=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments)).A=new we(0,0),e}return s(i,[{key:"Step",value:function(e){for(var t=we.MulSV(e.dt,this.A,i.Step_s_dtA),n=this.m_bodyList;n;n=n.nextBody){var r=n.body;r.IsAwake()&&r.SetLinearVelocity(we.AddVV(r.GetLinearVelocity(),t,we.s_t0))}}},{key:"Draw",value:function(){}}]),i}(Cs);xs.Step_s_dtA=new we;var ws=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments)).F=new we(0,0),e}return s(i,[{key:"Step",value:function(){for(var e=this.m_bodyList;e;e=e.nextBody){var t=e.body;t.IsAwake()&&t.ApplyForce(this.F,t.GetWorldCenter())}}},{key:"Draw",value:function(){}}]),i}(Cs),ks=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments)).G=1,e.invSqr=!0,e}return s(i,[{key:"Step",value:function(){if(this.invSqr)for(var e=this.m_bodyList;e;e=e.nextBody)for(var t=e.body,n=t.GetWorldCenter(),r=t.GetMass(),s=this.m_bodyList;s&&s!==e;s=s.nextBody){var o=s.body,u=o.GetWorldCenter(),h=o.GetMass(),l=u.x-n.x,c=u.y-n.y,_=l*l+c*c;if(!(_<a)){var f=i.Step_s_f.Set(l,c);f.SelfMul(this.G/_/me(_)*r*h),t.IsAwake()&&t.ApplyForce(f,n),o.IsAwake()&&o.ApplyForce(f.SelfMul(-1),u)}}else for(var d=this.m_bodyList;d;d=d.nextBody)for(var m=d.body,p=m.GetWorldCenter(),v=m.GetMass(),y=this.m_bodyList;y&&y!==d;y=y.nextBody){var g=y.body,S=g.GetWorldCenter(),A=g.GetMass(),T=S.x-p.x,E=S.y-p.y,b=T*T+E*E;if(!(b<a)){var C=i.Step_s_f.Set(T,E);C.SelfMul(this.G/b*v*A),m.IsAwake()&&m.ApplyForce(C,p),g.IsAwake()&&g.ApplyForce(C.SelfMul(-1),S)}}}},{key:"Draw",value:function(){}}]),i}(Cs);ks.Step_s_f=new we;var Is=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments)).T=new Be,e.maxTimestep=0,e}return s(i,[{key:"Step",value:function(e){var t=e.dt;if(!(t<=a)){t>this.maxTimestep&&this.maxTimestep>0&&(t=this.maxTimestep);for(var n=this.m_bodyList;n;n=n.nextBody){var r=n.body;if(r.IsAwake()){var s=r.GetWorldVector(Be.MulMV(this.T,r.GetLocalVector(r.GetLinearVelocity(),we.s_t0),we.s_t1),i.Step_s_damping);r.SetLinearVelocity(we.AddVV(r.GetLinearVelocity(),we.MulSV(t,s,we.s_t0),we.s_t1))}}}}},{key:"Draw",value:function(){}},{key:"SetAxisAligned",value:function(e,t){this.T.ex.x=-e,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-t,this.maxTimestep=e>0||t>0?1/he(e,t):0}}]),i}(Cs);Is.Step_s_damping=new we;var Bs=function e(){n(this,e),this.vertices=[],this.count=0,this.masses=[],this.gravity=new we(0,0),this.damping=.1,this.k2=.9,this.k3=.1},Ps=function(){function e(){n(this,e),this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new we,this.m_damping=0,this.m_k2=1,this.m_k3=.1}return s(e,[{key:"GetVertexCount",value:function(){return this.m_count}},{key:"GetVertices",value:function(){return this.m_ps}},{key:"Initialize",value:function(e){this.m_count=e.count,this.m_ps=we.MakeArray(this.m_count),this.m_p0s=we.MakeArray(this.m_count),this.m_vs=we.MakeArray(this.m_count),this.m_ims=ne(this.m_count);for(var t=0;t<this.m_count;++t){this.m_ps[t].Copy(e.vertices[t]),this.m_p0s[t].Copy(e.vertices[t]),this.m_vs[t].SetZero();var i=e.masses[t];this.m_ims[t]=i>0?1/i:0}var n=this.m_count-1,r=this.m_count-2;this.m_Ls=ne(n),this.m_as=ne(r);for(var s=0;s<n;++s){var a=this.m_ps[s],o=this.m_ps[s+1];this.m_Ls[s]=we.DistanceVV(a,o)}for(var u=0;u<r;++u){var h=this.m_ps[u],l=this.m_ps[u+1],c=this.m_ps[u+2],_=we.SubVV(l,h,we.s_t0),f=we.SubVV(c,l,we.s_t1),d=we.CrossVV(_,f),m=we.DotVV(_,f);this.m_as[u]=Ee(d,m)}this.m_gravity.Copy(e.gravity),this.m_damping=e.damping,this.m_k2=e.k2,this.m_k3=e.k3}},{key:"Step",value:function(e,t){if(0!==e){for(var i=Math.exp(-e*this.m_damping),n=0;n<this.m_count;++n)this.m_p0s[n].Copy(this.m_ps[n]),this.m_ims[n]>0&&this.m_vs[n].SelfMulAdd(e,this.m_gravity),this.m_vs[n].SelfMul(i),this.m_ps[n].SelfMulAdd(e,this.m_vs[n]);for(var r=0;r<t;++r)this.SolveC2(),this.SolveC3(),this.SolveC2();for(var s=1/e,a=0;a<this.m_count;++a)we.MulSV(s,we.SubVV(this.m_ps[a],this.m_p0s[a],we.s_t0),this.m_vs[a])}}},{key:"SolveC2",value:function(){for(var t=this.m_count-1,i=0;i<t;++i){var n=this.m_ps[i],r=this.m_ps[i+1],s=we.SubVV(r,n,e.s_d),a=s.Normalize(),o=this.m_ims[i],u=this.m_ims[i+1];if(o+u!==0){var h=o/(o+u),l=u/(o+u);n.SelfMulSub(this.m_k2*h*(this.m_Ls[i]-a),s),r.SelfMulAdd(this.m_k2*l*(this.m_Ls[i]-a),s)}}}},{key:"SetAngle",value:function(e){for(var t=this.m_count-2,i=0;i<t;++i)this.m_as[i]=e}},{key:"SolveC3",value:function(){for(var t=this.m_count-2,i=0;i<t;++i){var n=this.m_ps[i],r=this.m_ps[i+1],s=this.m_ps[i+2],a=this.m_ims[i],o=this.m_ims[i+1],h=this.m_ims[i+2],l=we.SubVV(r,n,e.s_d1),c=we.SubVV(s,r,e.s_d2),_=l.LengthSquared(),f=c.LengthSquared();if(_*f!=0){var d=we.CrossVV(l,c),m=we.DotVV(l,c),p=Ee(d,m),v=we.MulSV(-1/_,l.SelfSkew(),e.s_Jd1),y=we.MulSV(1/f,c.SelfSkew(),e.s_Jd2),g=we.NegV(v,e.s_J1),S=we.SubVV(v,y,e.s_J2),A=y,T=a*we.DotVV(g,g)+o*we.DotVV(S,S)+h*we.DotVV(A,A);if(0!==T){T=1/T;for(var E=p-this.m_as[i];E>u;)E=(p-=2*u)-this.m_as[i];for(;E<-u;)E=(p+=2*u)-this.m_as[i];var b=-this.m_k3*T*E;n.SelfMulAdd(a*b,g),r.SelfMulAdd(o*b,S),s.SelfMulAdd(h*b,A)}}}}},{key:"Draw",value:function(e){for(var t=new Ne(.4,.5,.7),i=0;i<this.m_count-1;++i)e.DrawSegment(this.m_ps[i],this.m_ps[i+1],t)}}]),e}();Ps.s_d=new we,Ps.s_d1=new we,Ps.s_d2=new we,Ps.s_Jd1=new we,Ps.s_Jd2=new we,Ps.s_J1=new we,Ps.s_J2=new we,e.b2AABB=kt,e.b2Abs=oe,e.b2Acos=Ae,e.b2Alloc=j,e.b2AreaJoint=Pn,e.b2AreaJointDef=Bn,e.b2Asin=Te,e.b2Assert=t,e.b2Atan2=Ee,e.b2BlockAllocator=He,e.b2Body=bn,e.b2BodyDef=En,e.b2BroadPhase=zt,e.b2BuoyancyController=Rs,e.b2CalculateParticleIterations=Dr,e.b2ChainAndCircleContact=hr,e.b2ChainAndPolygonContact=lr,e.b2ChainShape=mn,e.b2CircleContact=rr,e.b2CircleShape=_n,e.b2Clamp=le,e.b2ClipSegmentToLine=Bt,e.b2ClipVertex=Rt,e.b2CollideCircles=pi,e.b2CollideEdgeAndCircle=en,e.b2CollideEdgeAndPolygon=un,e.b2CollidePolygonAndCircle=Si,e.b2CollidePolygons=Wi,e.b2Color=Ne,e.b2ConstantAccelController=xs,e.b2ConstantForceController=ws,e.b2Contact=nr,e.b2ContactEdge=ir,e.b2ContactFactory=_r,e.b2ContactFeature=gt,e.b2ContactFilter=dr,e.b2ContactID=St,e.b2ContactImpulse=mr,e.b2ContactListener=pr,e.b2ContactManager=gr,e.b2ContactPositionConstraint=wr,e.b2ContactRegister=cr,e.b2ContactSolver=Br,e.b2ContactSolverDef=kr,e.b2ContactVelocityConstraint=xr,e.b2Controller=Cs,e.b2ControllerEdge=bs,e.b2Cos=ge,e.b2Counter=Ve,e.b2DegToRad=ve,e.b2DestructionListener=fr,e.b2Distance=ot,e.b2DistanceInput=je,e.b2DistanceJoint=In,e.b2DistanceJointDef=kn,e.b2DistanceOutput=qe,e.b2DistanceProxy=We,e.b2Draw=Fe,e.b2DynamicTree=Ft,e.b2EdgeAndCircleContact=or,e.b2EdgeAndPolygonContact=ur,e.b2EdgeShape=dn,e.b2Filter=pn,e.b2Fixture=Sn,e.b2FixtureDef=vn,e.b2FixtureParticleQueryCallback=es,e.b2FixtureProxy=yn,e.b2Free=q,e.b2FrictionJoint=On,e.b2FrictionJointDef=Mn,e.b2GearJoint=Ln,e.b2GearJointDef=Dn,e.b2GetPointStates=Ct,e.b2GravityController=ks,e.b2GrowableBuffer=$r,e.b2GrowableStack=Ue,e.b2InvSqrt=de,e.b2IsPowerOfTwo=Ce,e.b2IsValid=_e,e.b2Island=Mr,e.b2Jacobian=Cn,e.b2Joint=wn,e.b2JointDef=xn,e.b2JointEdge=Rn,e.b2Log=Y,e.b2MakeArray=te,e.b2MakeNullArray=ie,e.b2MakeNumberArray=ne,e.b2Manifold=Et,e.b2ManifoldPoint=At,e.b2MassData=ln,e.b2Mat22=Be,e.b2Mat33=Pe,e.b2Max=he,e.b2Maybe=i,e.b2Min=ue,e.b2MixFriction=er,e.b2MixRestitution=tr,e.b2MotorJoint=Fn,e.b2MotorJointDef=Nn,e.b2MouseJoint=Vn,e.b2MouseJointDef=Gn,e.b2NextPowerOfTwo=be,e.b2Pair=Ht,e.b2PairLessThan=Wt,e.b2ParseInt=$,e.b2ParseUInt=ee,e.b2ParticleBodyContact=is,e.b2ParticleContact=ts,e.b2ParticleDef=Or,e.b2ParticleGroup=Gr,e.b2ParticleGroupDef=Fr,e.b2ParticleHandle=Nr,e.b2ParticlePair=ns,e.b2ParticlePairSet=ms,e.b2ParticleSystem=as,e.b2ParticleSystemDef=ss,e.b2ParticleSystem_CompositeShape=gs,e.b2ParticleSystem_ConnectionFilter=ps,e.b2ParticleSystem_DestroyParticlesInShapeCallback=vs,e.b2ParticleSystem_FixedSetAllocator=cs,e.b2ParticleSystem_FixtureParticle=_s,e.b2ParticleSystem_FixtureParticleSet=fs,e.b2ParticleSystem_InsideBoundsEnumerator=hs,e.b2ParticleSystem_JoinParticleGroupsFilter=ys,e.b2ParticleSystem_ParticleListNode=ls,e.b2ParticleSystem_ParticlePair=ds,e.b2ParticleSystem_Proxy=us,e.b2ParticleSystem_ReactiveFilter=Ss,e.b2ParticleSystem_SolveCollisionCallback=Ts,e.b2ParticleSystem_UpdateBodyContactsCallback=As,e.b2ParticleSystem_UserOverridableBuffer=os,e.b2ParticleTriad=rs,e.b2PolygonAndCircleContact=ar,e.b2PolygonContact=sr,e.b2PolygonShape=fn,e.b2Position=Tr,e.b2PositionSolverManifold=Ir,e.b2Pow=pe,e.b2PrismaticJoint=Hn,e.b2PrismaticJointDef=Un,e.b2Profile=Sr,e.b2PulleyJoint=Xn,e.b2PulleyJointDef=Wn,e.b2QueryCallback=vr,e.b2RadToDeg=ye,e.b2Random=Re,e.b2RandomRange=xe,e.b2RayCastCallback=yr,e.b2RayCastInput=xt,e.b2RayCastOutput=wt,e.b2RevoluteJoint=qn,e.b2RevoluteJointDef=jn,e.b2Rope=Ps,e.b2RopeDef=Bs,e.b2RopeJoint=Kn,e.b2RopeJointDef=Yn,e.b2Rot=Me,e.b2SeparationFunction=ni,e.b2Shape=cn,e.b2ShapeCast=vt,e.b2ShapeCastInput=Ye,e.b2ShapeCastOutput=Ke,e.b2Simplex=Ze,e.b2SimplexCache=Xe,e.b2SimplexVertex=Je,e.b2Sin=Se,e.b2SolverData=br,e.b2Sq=fe,e.b2Sqrt=me,e.b2StackAllocator=ze,e.b2Swap=ce,e.b2Sweep=Le,e.b2TOIInput=ei,e.b2TOIOutput=ii,e.b2TensorDampingController=Is,e.b2TestOverlapAABB=It,e.b2TestOverlapShape=Dt,e.b2TimeOfImpact=fi,e.b2TimeStep=Ar,e.b2Timer=Ge,e.b2Transform=Oe,e.b2TreeNode=Nt,e.b2Vec2=we,e.b2Vec2_zero=ke,e.b2Vec3=Ie,e.b2Velocity=Er,e.b2VelocityConstraintPoint=Rr,e.b2Version=K,e.b2WeldJoint=Jn,e.b2WeldJointDef=Qn,e.b2WheelJoint=$n,e.b2WheelJointDef=Zn,e.b2World=Es,e.b2WorldManifold=bt,e.b2_180_over_pi=se,e.b2_aabbExtension=d,e.b2_aabbMultiplier=m,e.b2_angularSleepTolerance=X,e.b2_angularSlop=y,e.b2_barrierCollisionTime=H,e.b2_baumgarte=B,e.b2_branch=J,e.b2_commit=Z,e.b2_epsilon=a,e.b2_epsilon_sq=o,e.b2_gjk_reset=Qe,e.b2_invalidParticleIndex=M,e.b2_linearSleepTolerance=W,e.b2_linearSlop=p,e.b2_maxAngularCorrection=C,e.b2_maxFloat=r,e.b2_maxLinearCorrection=b,e.b2_maxManifoldPoints=c,e.b2_maxParticleForce=F,e.b2_maxParticleIndex=O,e.b2_maxParticlePressure=N,e.b2_maxPolygonVertices=_,e.b2_maxRotation=k,e.b2_maxRotationSquared=I,e.b2_maxSubSteps=A,e.b2_maxTOIContacts=T,e.b2_maxTranslation=x,e.b2_maxTranslationSquared=w,e.b2_maxTriadDistance=G,e.b2_maxTriadDistanceSquared=V,e.b2_minParticleSystemBufferCapacity=U,e.b2_minParticleWeight=L,e.b2_minPulleyLength=zn,e.b2_particleStride=D,e.b2_pi=u,e.b2_pi_over_180=re,e.b2_polygonRadius=S,e.b2_timeToSleep=z,e.b2_toiBaumgarte=P,e.b2_toi_reset=Xt,e.b2_two_pi=ae,e.b2_velocityThreshold=E,e.b2_version=Q,e.g_blockSolve=Cr,Object.defineProperty(e,"__esModule",{value:!0})}(t)}(t={exports:{}},t.exports),t.exports}();(j5=q5)&&j5.__esModule&&Object.prototype.hasOwnProperty.call(j5,"default")&&j5.default;var Y5={};for(var K5 in q5)-1===K5.indexOf("b2_")&&(Y5[K5.replace("b2","")]=q5[K5]);var Q5=Y5;function J5(e,t){var i=t.length;return t[e<0?i- -e%i:e%i]}function Z5(e,t,i){for(var n=[];t<e;)t+=i.length;for(;e<=t;++e)n.push(J5(e,i));return n}function $5(e,t,i){if(e4(e,i)){if(n4(J5(e,i),J5(e-1,i),J5(t,i))&&r4(J5(e,i),J5(e+1,i),J5(t,i)))return!1}else if(r4(J5(e,i),J5(e+1,i),J5(t,i))||n4(J5(e,i),J5(e-1,i),J5(t,i)))return!1;if(e4(t,i)){if(n4(J5(t,i),J5(t-1,i),J5(e,i))&&r4(J5(t,i),J5(t+1,i),J5(e,i)))return!1}else if(r4(J5(t,i),J5(t+1,i),J5(e,i))||n4(J5(t,i),J5(t-1,i),J5(e,i)))return!1;for(var n=0;n<i.length;++n)if((n+1)%i.length!=e&&n!=e&&(n+1)%i.length!=t&&n!=t){var r=new In;if(h4(J5(e,i),J5(t,i),J5(n,i),J5(n+1,i),r))return!1}return!0}function e4(e,t){return t4(e,t)}function t4(e,t,i){if(void 0===i){var n=e,r=t;e=J5(n-1,r),t=J5(n,r),void 0===e&&(e=t),void 0===(i=J5(n+1,r))&&(i=t)}return l4(e,t,i)<0}function i4(e,t,i){return l4(e,t,i)>0}function n4(e,t,i){return l4(e,t,i)>=0}function r4(e,t,i){return l4(e,t,i)<=0}function s4(e,t){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n}function a4(e){o4(e)||e.reverse()}function o4(e){return e.length<3||function(e){var t,i=0;for(t=0;t<e.length;t++){var n=(t+1)%e.length;i+=e[t].x*e[n].y,i-=e[t].y*e[n].x}return i/2}(e)>0}function u4(e,t,i,n){var r,s=new In,a=t.y-e.y,o=e.x-t.x,u=a*e.x+o*e.y,h=n.y-i.y,l=i.x-n.x,c=h*i.x+l*i.y,_=a*l-h*o;return r=_,0,Math.abs(r-0)<=1e-6||(s.x=(l*u-o*c)/_,s.y=(a*c-h*u)/_),s}function h4(e,t,i,n,r){if(e==i||e==n||t==i||t==n)return!1;var s=e.x,a=e.y,o=t.x,u=t.y,h=i.x,l=i.y,c=n.x,_=n.y;if(Math.max(s,o)<Math.min(h,c)||Math.max(h,c)<Math.min(s,o))return!1;if(Math.max(a,u)<Math.min(l,_)||Math.max(l,_)<Math.min(a,u))return!1;var f=(c-h)*(a-l)-(_-l)*(s-h),d=(o-s)*(a-l)-(u-a)*(s-h),m=(_-l)*(o-s)-(c-h)*(u-a);return!(Math.abs(m)<1e-6)&&(d/=m,(f/=m)>0&&f<1&&d>0&&d<1&&(r.x=s+f*(o-s),r.y=a+f*(u-a),!0))}function l4(e,t,i){return e.x*(t.y-i.y)+t.x*(i.y-e.y)+i.x*(e.y-t.y)}var c4=Object.freeze({__proto__:null,ConvexPartition:function e(t){a4(t);for(var i,n,r,s,a,o,u=[],h=new In,l=new In,c=0,_=0,f=0;f<t.length;++f)if(e4(f,t)){n=r=1e8;for(var d=0;d<t.length;++d)i4(J5(f-1,t),J5(f,t),J5(d,t))&&r4(J5(f-1,t),J5(f,t),J5(d-1,t))&&(s=u4(J5(f-1,t),J5(f,t),J5(d,t),J5(d-1,t)),t4(J5(f+1,t),J5(f,t),s)&&(i=s4(J5(f,t),s))<n&&(n=i,h=s,c=d)),i4(J5(f+1,t),J5(f,t),J5(d+1,t))&&r4(J5(f+1,t),J5(f,t),J5(d,t))&&(s=u4(J5(f+1,t),J5(f,t),J5(d,t),J5(d+1,t)),i4(J5(f-1,t),J5(f,t),s)&&(i=s4(J5(f,t),s))<r&&(r=i,_=d,l=s));if(c==(_+1)%t.length){var m=h.add(l).multiplyScalar(.5);(a=Z5(f,_,t)).push(m),(o=Z5(c,f,t)).push(m)}else{for(var p=0,v=c;_<c;)_+=t.length;for(var y=c;y<=_;++y)if($5(f,y,t)){var g=1/(s4(J5(f,t),J5(y,t))+1);e4(y,t)?r4(J5(y-1,t),J5(y,t),J5(f,t))&&n4(J5(y+1,t),J5(y,t),J5(f,t))?g+=3:g+=2:g+=1,g>p&&(v=y,p=g)}a=Z5(f,v,t),o=Z5(v,f,t)}return(u=u.concat(e(a))).concat(e(o))}u.push(t);for(var S=u.length-1;S>=0;S--)0==u[S].length&&u.splice(S,0);return u},ForceCounterClockWise:a4,IsCounterClockWise:o4});function _4(e){v4(e);for(var t=!0,i=0,n=e.length;i<n;++i)if(!m4(e[(i+n-1)%n],e[i],e[(i+1)%n])){t=!1;break}if(t)return[e];var r=[],s=function(e){if(v4(e),e.length<4)return[e];for(var t=e.length,i=[],n=[],r=0;r<t;++r){var s=new f4;s.isActive=!0,s.isConvex=!1,s.isEar=!1,s.point=e[r],s.angleCos=0,s.shouldUpdate=!0,s.index=r,i.push(s)}for(var a=0;a<t;++a){var o=i[a];o.prev=i[(a+t-1)%t],o.next=i[(a+1)%t]}i.forEach((function(e){return y4(e,i)}));for(var u=0;u<t-3;++u){for(var h=void 0,l=0;l<t;++l){var c=i[l];c.isActive&&c.isEar&&(h?c.angleCos>h.angleCos&&(h=c):h=c)}if(!h){for(var _=0;_<t;++_){var f=i[_];if(f.isActive){var d=f.prev.point,m=f.point,p=f.next.point;if(Math.abs(d4(d,m,p))>1e-5)return console.log("Failed to find ear. There might be self-intersection in the polygon."),null}}break}if(n.push([h.prev.point,h.point,h.next.point]),h.isActive=!1,h.prev.next=h.next,h.next.prev=h.prev,h.prev.shouldUpdate=!0,h.next.shouldUpdate=!0,g4(h.next),u===t-4)break;for(var v=0;v<t;++v)y4(i[v],i)}for(var y=0;y<t;++y){var g=i[y];if(g.isActive){g.prev.isActive=!1,g.next.isActive=!1;var S=g.prev.point,A=g.point,T=g.next.point;Math.abs(d4(S,A,T))>1e-5&&n.push([S,A,T])}}return n}(e);if(!s)return null;for(;s.length;){for(var a=s.splice(0,1)[0],o=0,u=a.length;o<u;++o){for(var h=a[o],l=a[(o+1)%u],c=null,_=0;_<s.length;++_){for(var f=s[_],d=0;d<3;++d){var m=f[d];if(p4(h,f[(d+1)%3])&&p4(l,m)){c=f[(d+2)%3];break}}if(c)break}if(c&&!(d4(a[(o+u-1)%u],h,c)>0||d4(c,l,a[(o+2)%u])>0)){for(var p=[],v=(o+1)%u;v!==o;v=(v+1)%u)p.push(a[v]);p.push(h,c),a=p,u=p.length,o=-1,s.splice(_,1)}}r.push(a)}return r}var f4=function e(){n(this,e),this.isActive=!1,this.isConvex=!1,this.isEar=!1,this.point=null,this.angleCos=0,this.shouldUpdate=!1,this.index=0,this.prev=null,this.next=null};function d4(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function m4(e,t,i){return d4(e,t,i)<0}function p4(e,t){return e.x===t.x&&e.y===t.y}function v4(e){(function(e){for(var t=0,i=0,n=e.length;i<n;++i){var r=e[i],s=e[(i+1)%n];t+=(s.x-r.x)*(s.y+r.y)}return t>0})(e)&&e.reverse()}function y4(e,t){if(e.shouldUpdate){e.shouldUpdate=!1;var i=e.prev.point,n=e.point,r=e.next.point;e.isConvex=m4(i,n,r);var s=i.x-n.x,a=i.y-n.y,o=Math.sqrt(s*s+a*a);s/=o,a/=o;var u=r.x-n.x,h=r.y-n.y,l=Math.sqrt(u*u+h*h);if(u/=l,h/=l,e.angleCos=s*u+a*h,e.isConvex){e.isEar=!0;for(var c=0,_=t.length;c<_;++c){var f=t[c];if(f.isActive&&f!==e){var d=f.point;if(!(p4(i,d)||p4(n,d)||p4(r,d))){var m=d4(i,d,n),p=d4(n,d,r),v=d4(r,d,i);if(m>0&&p>0&&v>0){e.isEar=!1;break}if(0===m&&p>=0&&v>=0&&(d4(i,f.prev.point,n)>0||d4(i,f.next.point,n)>0)){e.isEar=!1;break}if(0===p&&m>=0&&v>=0&&(d4(n,f.prev.point,r)>0||d4(n,f.next.point,r)>0)){e.isEar=!1;break}if(0===v&&m>=0&&p>=0&&(d4(r,f.prev.point,i)>0||d4(r,f.next.point,i)>0)){e.isEar=!1;break}}}}}else e.isEar=!1}}function g4(e){for(var t=e,i=e;;)if(p4(t.point,t.next.point)||0===d4(t.prev.point,t.point,t.next.point)){if(t.prev.next=t.next,t.next.prev=t.prev,t.prev.shouldUpdate=!0,t.next.shouldUpdate=!0,t===t.next)break;i=t.prev,t=t.next}else if((t=t.next)===i)break}var S4,A4,T4,E4,b4,C4,R4=Object.freeze({__proto__:null,ConvexPartition:_4});!function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(S4||(S4={})),wt(S4),function(e){e[e.X_AXIS=0]="X_AXIS",e[e.Y_AXIS=1]="Y_AXIS",e[e.Z_AXIS=2]="Z_AXIS"}(A4||(A4={})),wt(A4),function(e){e[e.VERTEX=1]="VERTEX",e[e.LINE=2]="LINE",e[e.TRIANGLE=3]="TRIANGLE",e[e.TETRAHEDRON=4]="TETRAHEDRON"}(T4||(T4={})),wt(T4),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.MESH=5]="MESH",e[e.PLANE=6]="PLANE",e[e.SIMPLEX=7]="SIMPLEX",e[e.TERRAIN=8]="TERRAIN"}(E4||(E4={})),wt(E4),function(e){e[e.POINT_TO_POINT=0]="POINT_TO_POINT",e[e.HINGE=1]="HINGE",e[e.CONE_TWIST=2]="CONE_TWIST",e[e.FIXED=3]="FIXED"}(b4||(b4={})),wt(b4),function(e){e[e.DEFAULT=1]="DEFAULT"}(C4||(C4={})),wt(C4);var x4=function e(t){if(n(this,e),1===t){for(var i=this,r=function(e){var t="_".concat(1<<e);i[t]=0,i.updateArray=[],Object.defineProperty(i,1<<e,{get:function(){return this[t]},set:function(i){this[t]!==i&&(this[t]=i,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})},s=0;s<32;s++)r(s);this._1=C4.DEFAULT}else{for(var a=0;a<32;a++)this["".concat(1<<a)]=0;this[1]=C4.DEFAULT}},w4=null;B.internal.PhysicsGroup2D=P5;var k4,I4,B4,P4,M4,O4,D4,L4,N4,F4,G4,V4,U4,H4,z4,W4,X4,j4,q4,Y4,K4,Q4,J4,Z4,$4,e8=e("PhysicsSystem2D",function(e){h(i,e);var t=v(i);function i(){var e,r,s,a,o;n(this,i),(o=t.call(this)).velocityIterations=10,o.positionIterations=10,o.collisionMatrix=new x4,o._enable=!0,o._allowSleep=!0,o._maxSubSteps=1,o._fixedTimeStep=1/60,o._autoSimulation=!0,o._accumulator=0,o._steping=!1,o._gravity=new In(0,-10*F5),o._delayEvents=[];var u=Dt.querySettings(Ot.Category.PHYSICS,"gravity");u&&(In.copy(o._gravity,u),o._gravity.multiplyScalar(F5)),o._allowSleep=null!==(e=Dt.querySettings(Ot.Category.PHYSICS,"allowSleep"))&&void 0!==e?e:o._allowSleep,o._fixedTimeStep=null!==(r=Dt.querySettings(Ot.Category.PHYSICS,"fixedTimeStep"))&&void 0!==r?r:o._fixedTimeStep,o._maxSubSteps=null!==(s=Dt.querySettings(Ot.Category.PHYSICS,"maxSubSteps"))&&void 0!==s?s:o._maxSubSteps,o._autoSimulation=null!==(a=Dt.querySettings(Ot.Category.PHYSICS,"autoSimulation"))&&void 0!==a?a:o._autoSimulation;var h=Dt.querySettings(Ot.Category.PHYSICS,"collisionMatrix");if(h)for(var l in h){var c=parseInt(l),_=1<<parseInt(l);o.collisionMatrix["".concat(_)]=h[c]}var f=Dt.querySettings(Ot.Category.PHYSICS,"collisionGroups");return f&&f instanceof Array&&(f.forEach((function(e){P5[e.name]=1<<e.index})),wt.update(P5)),G5.physicsWorld=U5(),o.gravity=o._gravity,o.allowSleep=o._allowSleep,o}return s(i,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.physicsWorld.setAllowSleep(e)}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e),this.physicsWorld.setGravity(new In(e.x/F5,e.y/F5))}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(e){this._maxSubSteps=e}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(e){this._fixedTimeStep=e}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(e){this._autoSimulation=e}},{key:"debugDrawFlags",get:function(){return this.physicsWorld.debugDrawFlags},set:function(e){this.physicsWorld.debugDrawFlags=e}},{key:"physicsWorld",get:function(){return G5.physicsWorld}},{key:"stepping",get:function(){return this._steping}},{key:"postUpdate",value:function(e){if(this._enable&&this._autoSimulation){DN.emit(PN.EVENT_BEFORE_PHYSICS),this.physicsWorld.syncSceneToPhysics(),this._steping=!0;var t=this._fixedTimeStep,i=this.velocityIterations,n=this.positionIterations;this._accumulator+=e;for(var r=0;r++<this._maxSubSteps&&this._accumulator>t;)this.physicsWorld.step(t,i,n),this._accumulator-=t;for(var s=this._delayEvents,a=0,o=s.length;a<o;a++){var u=s[a];u.func.call(u.target)}s.length=0,this.physicsWorld.syncPhysicsToScene(),this.physicsWorld.finalizeContactEvent(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,DN.emit(PN.EVENT_AFTER_PHYSICS)}}},{key:"_callAfterStep",value:function(e,t){this._steping?this._delayEvents.push({target:e,func:t}):t.call(e)}},{key:"resetAccumulator",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._accumulator=e}},{key:"step",value:function(e){this.physicsWorld.step(e,this.velocityIterations,this.positionIterations)}},{key:"raycast",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:M5.Closest,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4294967295;return this.physicsWorld.raycast(e,t,i,n)}},{key:"testPoint",value:function(e){return this.physicsWorld.testPoint(e)}},{key:"testAABB",value:function(e){return this.physicsWorld.testAABB(e)}},{key:"on",value:function(e,t,n,r){return e!==N5.PRE_SOLVE&&e!==N5.POST_SOLVE||ae(16002,e,"3.7.1"),g(l(i.prototype),"on",this).call(this,e,t,n,r)}}],[{key:"PHYSICS_NONE",get:function(){return!G5.id}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===G5.id}},{key:"PHYSICS_BOX2D",get:function(){return"box2d"===G5.id}},{key:"PhysicsGroup",get:function(){return P5}},{key:"instance",get:function(){return w4||(w4=new i),w4}}]),i}(Uh(Rh)));e8.ID="PHYSICS_2D",DN.once(PN.EVENT_INIT,(function(){DN.registerSystem(e8.ID,e8.instance,Rh.Priority.LOW)})),function(e){e[e.Circles=0]="Circles",e[e.FaceA=1]="FaceA",e[e.FaceB=2]="FaceB"}(k4||(k4=e("Physics2DManifoldType",{})));var t8,i8,n8,r8,s8,a8,o8,u8,h8,l8,c8,_8,f8,d8,m8,p8,v8,y8,g8,S8,A8,T8,E8,b8,C8,R8,x8,w8,k8,I8,B8,P8,M8,O8,D8,L8,N8,F8,G8,V8,U8,H8,z8,W8,X8,j8,q8,Y8,K8,Q8,J8,Z8,$8,e6,t6,i6,n6,r6,s6,a6,o6,u6,h6,l6,c6,_6,f6,d6,m6,p6,v6,y6,g6,S6,A6,T6,E6,b6,C6,R6,x6,w6,k6,I6,B6,P6,M6,O6,D6,L6,N6,F6,G6,V6,U6,H6,z6,W6,X6,j6,q6,Y6,K6,Q6,J6,Z6,$6,e7,t7,i7,n7,r7,s7,a7,o7,u7,h7,l7,c7,_7,f7,d7,m7,p7,v7,y7,g7,S7,A7,T7,E7,b7,C7,R7,x7,w7,k7,I7,B7,P7,M7=Aa,O7=e("RigidBody2D",(I4=Hs("cc.RigidBody2D"),B4=M7(C4),P4=M7(k5),M4=M7(ai),O4=M7(si),D4=M7(si),L4=M7(si),N4=M7(In),F4=M7(si),G4=M7(ai),I4((x((U4=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).enabledContactListener=H4&&H4(),e.bullet=z4&&z4(),e.awakeOnLoad=W4&&W4(),e._body=null,e._group=X4&&X4(),e._type=j4&&j4(),e._allowSleep=q4&&q4(),e._gravityScale=Y4&&Y4(),e._linearDamping=K4&&K4(),e._angularDamping=Q4&&Q4(),e._linearVelocity=J4&&J4(),e._angularVelocity=Z4&&Z4(),e._fixedRotation=$4&&$4(),e}return s(i,[{key:"group",get:function(){return this._group},set:function(e){this._group=e}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._body&&(e===k5.Animated?this._body.setType(k5.Kinematic):this._body.setType(e))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}},{key:"gravityScale",get:function(){return this._gravityScale},set:function(e){this._gravityScale=e,this._body&&this._body.setGravityScale(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}},{key:"linearVelocity",get:function(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity},set:function(e){this._linearVelocity=e,this._body&&this._body.setLinearVelocity(e)}},{key:"angularVelocity",get:function(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity},set:function(e){this._angularVelocity=e,this._body&&this._body.setAngularVelocity(e)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e,this._body&&this._body.setFixedRotation(e)}},{key:"isAwake",value:function(){return!!this._body&&this._body.isAwake}},{key:"wakeUp",value:function(){this._body&&this._body.wakeUp()}},{key:"sleep",value:function(){this._body&&this._body.sleep()}},{key:"getMass",value:function(){return this._body?this._body.getMass():0}},{key:"applyForce",value:function(e,t,i){this._body&&this._body.applyForce(e,t,i)}},{key:"applyForceToCenter",value:function(e,t){this._body&&this._body.applyForceToCenter(e,t)}},{key:"applyTorque",value:function(e,t){this._body&&this._body.applyTorque(e,t)}},{key:"applyLinearImpulse",value:function(e,t,i){this._body&&this._body.applyLinearImpulse(e,t,i)}},{key:"applyLinearImpulseToCenter",value:function(e,t){this._body&&this._body.applyLinearImpulseToCenter(e,t)}},{key:"applyAngularImpulse",value:function(e,t){this._body&&this._body.applyAngularImpulse(e,t)}},{key:"getLinearVelocityFromWorldPoint",value:function(e,t){return this._body?this._body.getLinearVelocityFromWorldPoint(e,t):t}},{key:"getLocalVector",value:function(e,t){return this._body?this._body.getLocalVector(e,t):t}},{key:"getWorldVector",value:function(e,t){return this._body?this._body.getWorldVector(e,t):t}},{key:"getLocalPoint",value:function(e,t){return this._body?this._body.getLocalPoint(e,t):t}},{key:"getWorldPoint",value:function(e,t){return this._body?this._body.getWorldPoint(e,t):t}},{key:"getLocalCenter",value:function(e){return this._body?this._body.getLocalCenter(e):e}},{key:"getWorldCenter",value:function(e){return this._body?this._body.getWorldCenter(e):e}},{key:"getInertia",value:function(){return this._body&&this._body.getInertia(),0}},{key:"onLoad",value:function(){this._body="builtin"===G5.id?H5:new G5.wrapper.RigidBody,this._body.initialize(this)}},{key:"onEnable",value:function(){this._body&&this._body.onEnable()}},{key:"onDisable",value:function(){this._body&&this._body.onDisable()}},{key:"onDestroy",value:function(){this._body&&this._body.onDestroy()}},{key:"impl",get:function(){return this._body}}]),i}(tm)).prototype,"group",[B4],Object.getOwnPropertyDescriptor(U4.prototype,"group"),U4.prototype),H4=Ms(U4.prototype,"enabledContactListener",[Js],(function(){return!1})),z4=Ms(U4.prototype,"bullet",[Js],(function(){return!1})),x(U4.prototype,"type",[P4],Object.getOwnPropertyDescriptor(U4.prototype,"type"),U4.prototype),x(U4.prototype,"allowSleep",[M4],Object.getOwnPropertyDescriptor(U4.prototype,"allowSleep"),U4.prototype),x(U4.prototype,"gravityScale",[O4],Object.getOwnPropertyDescriptor(U4.prototype,"gravityScale"),U4.prototype),x(U4.prototype,"linearDamping",[D4],Object.getOwnPropertyDescriptor(U4.prototype,"linearDamping"),U4.prototype),x(U4.prototype,"angularDamping",[L4],Object.getOwnPropertyDescriptor(U4.prototype,"angularDamping"),U4.prototype),x(U4.prototype,"linearVelocity",[N4],Object.getOwnPropertyDescriptor(U4.prototype,"linearVelocity"),U4.prototype),x(U4.prototype,"angularVelocity",[F4],Object.getOwnPropertyDescriptor(U4.prototype,"angularVelocity"),U4.prototype),x(U4.prototype,"fixedRotation",[G4],Object.getOwnPropertyDescriptor(U4.prototype,"fixedRotation"),U4.prototype),W4=Ms(U4.prototype,"awakeOnLoad",[Js],(function(){return!0})),X4=Ms(U4.prototype,"_group",[Js],(function(){return C4.DEFAULT})),j4=Ms(U4.prototype,"_type",[Js],(function(){return k5.Dynamic})),q4=Ms(U4.prototype,"_allowSleep",[Js],(function(){return!0})),Y4=Ms(U4.prototype,"_gravityScale",[Js],(function(){return 1})),K4=Ms(U4.prototype,"_linearDamping",[Js],(function(){return 0})),Q4=Ms(U4.prototype,"_angularDamping",[Js],(function(){return 0})),J4=Ms(U4.prototype,"_linearVelocity",[Js],(function(){return new In})),Z4=Ms(U4.prototype,"_angularVelocity",[Js],(function(){return 0})),$4=Ms(U4.prototype,"_fixedRotation",[Js],(function(){return!1})),V4=U4))||V4)),D7=Aa,L7=e("Collider2D",(t8=Hs("cc.Collider2D"),i8=D7(si),n8=D7(C4),r8=D7(si),s8=D7(ai),a8=D7(si),o8=D7(si),u8=D7(In),t8((l8=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).editing=!1,e.tag=c8&&c8(),e.TYPE=I5.None,e._shape=null,e._body=null,e._group=_8&&_8(),e._density=f8&&f8(),e._sensor=d8&&d8(),e._friction=m8&&m8(),e._restitution=p8&&p8(),e._offset=v8&&v8(),e}return s(i,[{key:"group",get:function(){return this._group},set:function(e){this._group=e,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}},{key:"density",get:function(){return this._density},set:function(e){this._density=e}},{key:"sensor",get:function(){return this._sensor},set:function(e){this._sensor=e}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction=e}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution=e}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e}},{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._shape}},{key:"onLoad",value:function(){this._shape=function(e){return z5.INITED||(z5.INITED=!0,z5[I5.BOX]=function(){return new G5.wrapper.BoxShape},z5[I5.CIRCLE]=function(){return new G5.wrapper.CircleShape},z5[I5.POLYGON]=function(){return new G5.wrapper.PolygonShape}),z5[e]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(O7)}},{key:"onEnable",value:function(){this._shape&&this._shape.onEnable()}},{key:"onDisable",value:function(){this._shape&&this._shape.onDisable&&this._shape.onDisable()}},{key:"onDestroy",value:function(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()}},{key:"apply",value:function(){this._shape&&this._shape.apply&&this._shape.apply()}},{key:"worldAABB",get:function(){return this._shape?this._shape.worldAABB:new Dn}},{key:"on",value:function(e,t,n,r){return e!==N5.PRE_SOLVE&&e!==N5.POST_SOLVE||ae(16002,e,"3.7.1"),g(l(i.prototype),"on",this).call(this,e,t,n,r)}}]),i}(Uh(tm)),c8=Ms(l8.prototype,"tag",[i8,Js],(function(){return 0})),x(l8.prototype,"group",[n8],Object.getOwnPropertyDescriptor(l8.prototype,"group"),l8.prototype),x(l8.prototype,"density",[r8],Object.getOwnPropertyDescriptor(l8.prototype,"density"),l8.prototype),x(l8.prototype,"sensor",[s8],Object.getOwnPropertyDescriptor(l8.prototype,"sensor"),l8.prototype),x(l8.prototype,"friction",[a8],Object.getOwnPropertyDescriptor(l8.prototype,"friction"),l8.prototype),x(l8.prototype,"restitution",[o8],Object.getOwnPropertyDescriptor(l8.prototype,"restitution"),l8.prototype),x(l8.prototype,"offset",[u8],Object.getOwnPropertyDescriptor(l8.prototype,"offset"),l8.prototype),_8=Ms(l8.prototype,"_group",[Js],(function(){return C4.DEFAULT})),f8=Ms(l8.prototype,"_density",[Js],(function(){return 1})),d8=Ms(l8.prototype,"_sensor",[Js],(function(){return!1})),m8=Ms(l8.prototype,"_friction",[Js],(function(){return.2})),p8=Ms(l8.prototype,"_restitution",[Js],(function(){return 0})),v8=Ms(l8.prototype,"_offset",[Js],(function(){return new In})),h8=l8))||h8)),N7=(e("BoxCollider2D",(y8=Hs("cc.BoxCollider2D"),g8=Aa(Mn),y8((A8=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._size=T8&&T8(),e.TYPE=I5.BOX,e}return s(i,[{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),i}(L7),T8=Ms(A8.prototype,"_size",[Js],(function(){return new Mn(1,1)})),x(A8.prototype,"size",[g8],Object.getOwnPropertyDescriptor(A8.prototype,"size"),A8.prototype),S8=A8))||S8)),e("CircleCollider2D",(E8=Hs("cc.CircleCollider2D"),b8=Aa(si),E8((R8=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._radius=x8&&x8(),e.TYPE=I5.CIRCLE,e}return s(i,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e<0?0:e}},{key:"worldPosition",get:function(){return this._shape?this._shape.worldPosition:new In}},{key:"worldRadius",get:function(){return this._shape?this._shape.worldRadius:0}}]),i}(L7),x8=Ms(R8.prototype,"_radius",[Js],(function(){return 1})),x(R8.prototype,"radius",[b8],Object.getOwnPropertyDescriptor(R8.prototype,"radius"),R8.prototype),C8=R8))||C8)),e("PolygonCollider2D",(w8=Hs("cc.PolygonCollider2D"),k8=Aa(si),I8=Aa([In]),w8((P8=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).threshold=M8&&M8(),e._points=O8&&O8(),e.TYPE=I5.POLYGON,e}return s(i,[{key:"points",get:function(){return this._points},set:function(e){this._points=e}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),i}(L7),M8=Ms(P8.prototype,"threshold",[k8],(function(){return 1})),O8=Ms(P8.prototype,"_points",[Js],(function(){return[new In(-1,-1),new In(1,-1),new In(1,1),new In(-1,1)]})),x(P8.prototype,"points",[I8],Object.getOwnPropertyDescriptor(P8.prototype,"points"),P8.prototype),B8=P8))||B8)),Aa),F7=e("Joint2D",(D8=Hs("cc.Joint2D"),L8=N7(O7),D8((F8=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).anchor=G8&&G8(),e.connectedAnchor=V8&&V8(),e.collideConnected=U8&&U8(),e.connectedBody=H8&&H8(),e._body=null,e._joint=null,e.TYPE=B5.None,e}return s(i,[{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._joint}},{key:"onLoad",value:function(){this._joint=function(e){return function(){if(!W5.INITED){W5.INITED=!0;var e="builtin"===G5.id;W5[B5.SPRING]=function(){return e?X5:new G5.wrapper.SpringJoint},W5[B5.DISTANCE]=function(){return e?X5:new G5.wrapper.DistanceJoint},W5[B5.FIXED]=function(){return e?X5:new G5.wrapper.FixedJoint},W5[B5.MOUSE]=function(){return e?X5:new G5.wrapper.MouseJoint},W5[B5.RELATIVE]=function(){return e?X5:new G5.wrapper.RelativeJoint},W5[B5.SLIDER]=function(){return e?X5:new G5.wrapper.SliderJoint},W5[B5.WHEEL]=function(){return e?X5:new G5.wrapper.WheelJoint},W5[B5.HINGE]=function(){return e?X5:new G5.wrapper.HingeJoint}}}(),W5[e]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(O7)}},{key:"onEnable",value:function(){this._joint&&this._joint.onEnable&&this._joint.onEnable()}},{key:"onDisable",value:function(){this._joint&&this._joint.onDisable&&this._joint.onDisable()}},{key:"start",value:function(){this._joint&&this._joint.start&&this._joint.start()}},{key:"onDestroy",value:function(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()}}]),i}(tm),G8=Ms(F8.prototype,"anchor",[Js],(function(){return new In})),V8=Ms(F8.prototype,"connectedAnchor",[Js],(function(){return new In})),U8=Ms(F8.prototype,"collideConnected",[Js],(function(){return!1})),H8=Ms(F8.prototype,"connectedBody",[L8,Js],(function(){return null})),N8=F8))||N8)),G7=(e("DistanceJoint2D",(z8=Hs("cc.DistanceJoint2D"),W8=Aa(si),X8=Aa(ai),z8((x((q8=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).TYPE=B5.DISTANCE,e._maxLength=Y8&&Y8(),e._autoCalcDistance=K8&&K8(),e}return s(i,[{key:"maxLength",get:function(){return this._autoCalcDistance?this.connectedBody?an.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):an.len(this.node.worldPosition):this._maxLength},set:function(e){this._maxLength=e,this._joint&&this._joint.setMaxLength(e)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(e){this._autoCalcDistance=e}}]),i}(F7)).prototype,"maxLength",[W8],Object.getOwnPropertyDescriptor(q8.prototype,"maxLength"),q8.prototype),x(q8.prototype,"autoCalcDistance",[X8],Object.getOwnPropertyDescriptor(q8.prototype,"autoCalcDistance"),q8.prototype),Y8=Ms(q8.prototype,"_maxLength",[Js],(function(){return 5})),K8=Ms(q8.prototype,"_autoCalcDistance",[Js],(function(){return!0})),j8=q8))||j8)),e("SpringJoint2D",(Q8=Hs("cc.SpringJoint2D"),J8=Aa(si),Z8=Aa(si),$8=Aa(si),e6=Aa(ai),Q8((x((i6=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).TYPE=B5.SPRING,e._frequency=n6&&n6(),e._dampingRatio=r6&&r6(),e._distance=s6&&s6(),e._autoCalcDistance=a6&&a6(),e}return s(i,[{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}},{key:"distance",get:function(){return this._autoCalcDistance?this.connectedBody?an.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):an.len(this.node.worldPosition):this._distance},set:function(e){this._distance=e,this._joint&&this._joint.setDistance(e)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(e){this._autoCalcDistance=e}}]),i}(F7)).prototype,"frequency",[J8],Object.getOwnPropertyDescriptor(i6.prototype,"frequency"),i6.prototype),x(i6.prototype,"dampingRatio",[Z8],Object.getOwnPropertyDescriptor(i6.prototype,"dampingRatio"),i6.prototype),x(i6.prototype,"distance",[$8],Object.getOwnPropertyDescriptor(i6.prototype,"distance"),i6.prototype),x(i6.prototype,"autoCalcDistance",[e6],Object.getOwnPropertyDescriptor(i6.prototype,"autoCalcDistance"),i6.prototype),n6=Ms(i6.prototype,"_frequency",[Js],(function(){return 5})),r6=Ms(i6.prototype,"_dampingRatio",[Js],(function(){return.7})),s6=Ms(i6.prototype,"_distance",[Js],(function(){return 10})),a6=Ms(i6.prototype,"_autoCalcDistance",[Js],(function(){return!0})),t6=i6))||t6)),e("MouseJoint2D",(o6=Hs("cc.MouseJoint2D"),u6=Aa(si),h6=Aa(si),l6=Aa(si),o6((x((_6=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).TYPE=B5.MOUSE,e._maxForce=f6&&f6(),e._dampingRatio=d6&&d6(),e._frequency=m6&&m6(),e._target=new In,e}return s(i,[{key:"target",get:function(){return this._target},set:function(e){this._target=e,this._joint&&this._joint.setTarget(e)}},{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}},{key:"maxForce",get:function(){return this._maxForce},set:function(e){this._maxForce=e,this._joint&&this._joint.setMaxForce(e)}},{key:"update",value:function(e){this._joint.update(e)}}]),i}(F7)).prototype,"frequency",[u6],Object.getOwnPropertyDescriptor(_6.prototype,"frequency"),_6.prototype),x(_6.prototype,"dampingRatio",[h6],Object.getOwnPropertyDescriptor(_6.prototype,"dampingRatio"),_6.prototype),x(_6.prototype,"maxForce",[l6],Object.getOwnPropertyDescriptor(_6.prototype,"maxForce"),_6.prototype),f6=Ms(_6.prototype,"_maxForce",[Js],(function(){return 1e3})),d6=Ms(_6.prototype,"_dampingRatio",[Js],(function(){return.7})),m6=Ms(_6.prototype,"_frequency",[Js],(function(){return 5})),c6=_6))||c6)),new an),V7=new an,U7=(e("RelativeJoint2D",(p6=Hs("cc.RelativeJoint2D"),v6=Aa(si),y6=Aa(si),g6=Aa(si),S6=Aa(In),A6=Aa(si),T6=Aa(ai),p6((x((b6=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).TYPE=B5.RELATIVE,e._maxForce=C6&&C6(),e._maxTorque=R6&&R6(),e._correctionFactor=x6&&x6(),e._angularOffset=w6&&w6(),e._linearOffset=k6&&k6(),e._autoCalcOffset=I6&&I6(),e}return s(i,[{key:"maxForce",get:function(){return this._maxForce},set:function(e){this._maxForce=e,this._joint&&this._joint.setMaxForce(e)}},{key:"maxTorque",get:function(){return this._maxTorque},set:function(e){this._maxTorque=e,this._joint&&this._joint.setMaxTorque(e)}},{key:"correctionFactor",get:function(){return this._correctionFactor},set:function(e){this._correctionFactor=e,this._joint&&this._joint.setCorrectionFactor(e)}},{key:"linearOffset",get:function(){return this._autoCalcOffset?this.connectedBody?In.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):In.subtract(this._linearOffset,new In(0,0),this.node.worldPosition):this._linearOffset},set:function(e){this._linearOffset.set(e),this._joint&&this._joint.setLinearOffset(e)}},{key:"angularOffset",get:function(){return this._autoCalcOffset&&(vn.toEuler(G7,this.node.worldRotation),this.connectedBody?vn.toEuler(V7,this.connectedBody.node.worldRotation):vn.toEuler(V7,new vn),this._angularOffset=V7.z-G7.z),this._angularOffset},set:function(e){this._angularOffset=e,this._joint&&this._joint.setAngularOffset(e)}},{key:"autoCalcOffset",get:function(){return this._autoCalcOffset},set:function(e){this._autoCalcOffset=e}}]),i}(F7)).prototype,"maxForce",[v6],Object.getOwnPropertyDescriptor(b6.prototype,"maxForce"),b6.prototype),x(b6.prototype,"maxTorque",[y6],Object.getOwnPropertyDescriptor(b6.prototype,"maxTorque"),b6.prototype),x(b6.prototype,"correctionFactor",[g6],Object.getOwnPropertyDescriptor(b6.prototype,"correctionFactor"),b6.prototype),x(b6.prototype,"linearOffset",[S6],Object.getOwnPropertyDescriptor(b6.prototype,"linearOffset"),b6.prototype),x(b6.prototype,"angularOffset",[A6],Object.getOwnPropertyDescriptor(b6.prototype,"angularOffset"),b6.prototype),x(b6.prototype,"autoCalcOffset",[T6],Object.getOwnPropertyDescriptor(b6.prototype,"autoCalcOffset"),b6.prototype),C6=Ms(b6.prototype,"_maxForce",[Js],(function(){return 5})),R6=Ms(b6.prototype,"_maxTorque",[Js],(function(){return.7})),x6=Ms(b6.prototype,"_correctionFactor",[Js],(function(){return.3})),w6=Ms(b6.prototype,"_angularOffset",[Js],(function(){return 0})),k6=Ms(b6.prototype,"_linearOffset",[Js],(function(){return new In})),I6=Ms(b6.prototype,"_autoCalcOffset",[Js],(function(){return!0})),E6=b6))||E6)),new In);e("SliderJoint2D",(B6=Hs("cc.SliderJoint2D"),P6=Aa(si),M6=Aa(ai),O6=Aa(ai),D6=Aa(si),L6=Aa(si),N6=Aa(ai),F6=Aa(si),G6=Aa(si),B6((x((U6=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).TYPE=B5.SLIDER,e._angle=H6&&H6(),e._autoCalcAngle=z6&&z6(),e._enableMotor=W6&&W6(),e._maxMotorForce=X6&&X6(),e._motorSpeed=j6&&j6(),e._enableLimit=q6&&q6(),e._lowerLimit=Y6&&Y6(),e._upperLimit=K6&&K6(),e}return s(i,[{key:"angle",get:function(){return this._autoCalcAngle&&(this.connectedBody?In.subtract(U7,this.connectedBody.node.worldPosition,this.node.worldPosition):In.subtract(U7,new In(0,0),this.node.worldPosition),this._angle=Vi(Math.atan2(U7.y,U7.x))),this._angle},set:function(e){this._angle=e}},{key:"autoCalcAngle",get:function(){return this._autoCalcAngle},set:function(e){this._autoCalcAngle=e}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(e){this._enableMotor=e}},{key:"maxMotorForce",get:function(){return this._maxMotorForce},set:function(e){this._maxMotorForce=e,this._joint&&this._joint.setMaxMotorForce(e)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(e){this._motorSpeed=e,this._joint&&this._joint.setMotorSpeed(e)}},{key:"enableLimit",get:function(){return this._enableLimit},set:function(e){this._enableLimit=e}},{key:"lowerLimit",get:function(){return this._lowerLimit},set:function(e){this._lowerLimit=e,this._joint&&this._joint.setLowerLimit(e)}},{key:"upperLimit",get:function(){return this._upperLimit},set:function(e){this._upperLimit=e,this._joint&&this._joint.setUpperLimit(e)}}]),i}(F7)).prototype,"angle",[P6],Object.getOwnPropertyDescriptor(U6.prototype,"angle"),U6.prototype),x(U6.prototype,"autoCalcAngle",[M6],Object.getOwnPropertyDescriptor(U6.prototype,"autoCalcAngle"),U6.prototype),x(U6.prototype,"enableMotor",[O6],Object.getOwnPropertyDescriptor(U6.prototype,"enableMotor"),U6.prototype),x(U6.prototype,"maxMotorForce",[D6],Object.getOwnPropertyDescriptor(U6.prototype,"maxMotorForce"),U6.prototype),x(U6.prototype,"motorSpeed",[L6],Object.getOwnPropertyDescriptor(U6.prototype,"motorSpeed"),U6.prototype),x(U6.prototype,"enableLimit",[N6],Object.getOwnPropertyDescriptor(U6.prototype,"enableLimit"),U6.prototype),x(U6.prototype,"lowerLimit",[F6],Object.getOwnPropertyDescriptor(U6.prototype,"lowerLimit"),U6.prototype),x(U6.prototype,"upperLimit",[G6],Object.getOwnPropertyDescriptor(U6.prototype,"upperLimit"),U6.prototype),H6=Ms(U6.prototype,"_angle",[Js],(function(){return 0})),z6=Ms(U6.prototype,"_autoCalcAngle",[Js],(function(){return!0})),W6=Ms(U6.prototype,"_enableMotor",[Js],(function(){return!1})),X6=Ms(U6.prototype,"_maxMotorForce",[Js],(function(){return 1e3})),j6=Ms(U6.prototype,"_motorSpeed",[Js],(function(){return 1e3})),q6=Ms(U6.prototype,"_enableLimit",[Js],(function(){return!1})),Y6=Ms(U6.prototype,"_lowerLimit",[Js],(function(){return 0})),K6=Ms(U6.prototype,"_upperLimit",[Js],(function(){return 0})),V6=U6))||V6)),e("FixedJoint2D",(Q6=Hs("cc.FixedJoint2D"),J6=Aa(si),Z6=Aa(si),Q6((x((e7=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).TYPE=B5.FIXED,e._frequency=t7&&t7(),e._dampingRatio=i7&&i7(),e}return s(i,[{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}}]),i}(F7)).prototype,"frequency",[J6],Object.getOwnPropertyDescriptor(e7.prototype,"frequency"),e7.prototype),x(e7.prototype,"dampingRatio",[Z6],Object.getOwnPropertyDescriptor(e7.prototype,"dampingRatio"),e7.prototype),t7=Ms(e7.prototype,"_frequency",[Js],(function(){return.7})),i7=Ms(e7.prototype,"_dampingRatio",[Js],(function(){return.5})),$6=e7))||$6)),e("WheelJoint2D",(n7=Hs("cc.WheelJoint2D"),r7=Aa(si),s7=Aa(ai),a7=Aa(si),o7=Aa(si),u7=Aa(si),h7=Aa(si),n7((x((c7=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).TYPE=B5.WHEEL,e._angle=_7&&_7(),e._enableMotor=f7&&f7(),e._maxMotorTorque=d7&&d7(),e._motorSpeed=m7&&m7(),e._frequency=p7&&p7(),e._dampingRatio=v7&&v7(),e}return s(i,[{key:"angle",get:function(){return this._angle},set:function(e){this._angle=e}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(e){this._enableMotor=e,this._joint&&this._joint.enableMotor(e)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(e){this._maxMotorTorque=e,this._joint&&this._joint.setMaxMotorTorque(e)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(e){this._motorSpeed=e,this._joint&&this._joint.setMotorSpeed(e)}},{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}}]),i}(F7)).prototype,"angle",[r7],Object.getOwnPropertyDescriptor(c7.prototype,"angle"),c7.prototype),x(c7.prototype,"enableMotor",[s7],Object.getOwnPropertyDescriptor(c7.prototype,"enableMotor"),c7.prototype),x(c7.prototype,"maxMotorTorque",[a7],Object.getOwnPropertyDescriptor(c7.prototype,"maxMotorTorque"),c7.prototype),x(c7.prototype,"motorSpeed",[o7],Object.getOwnPropertyDescriptor(c7.prototype,"motorSpeed"),c7.prototype),x(c7.prototype,"frequency",[u7],Object.getOwnPropertyDescriptor(c7.prototype,"frequency"),c7.prototype),x(c7.prototype,"dampingRatio",[h7],Object.getOwnPropertyDescriptor(c7.prototype,"dampingRatio"),c7.prototype),_7=Ms(c7.prototype,"_angle",[Js],(function(){return 90})),f7=Ms(c7.prototype,"_enableMotor",[Js],(function(){return!1})),d7=Ms(c7.prototype,"_maxMotorTorque",[Js],(function(){return 1e3})),m7=Ms(c7.prototype,"_motorSpeed",[Js],(function(){return 0})),p7=Ms(c7.prototype,"_frequency",[Js],(function(){return 5})),v7=Ms(c7.prototype,"_dampingRatio",[Js],(function(){return.7})),l7=c7))||l7)),e("HingeJoint2D",(y7=Hs("cc.HingeJoint2D"),g7=Aa(ai),S7=Aa(si),A7=Aa(si),T7=Aa(ai),E7=Aa(si),b7=Aa(si),y7((x((R7=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).TYPE=B5.HINGE,e._enableLimit=x7&&x7(),e._lowerAngle=w7&&w7(),e._upperAngle=k7&&k7(),e._enableMotor=I7&&I7(),e._maxMotorTorque=B7&&B7(),e._motorSpeed=P7&&P7(),e}return s(i,[{key:"enableLimit",get:function(){return this._enableLimit},set:function(e){this._enableLimit=e}},{key:"lowerAngle",get:function(){return this._lowerAngle},set:function(e){this._lowerAngle=e,this._joint&&this._joint.setLowerAngle(e)}},{key:"upperAngle",get:function(){return this._upperAngle},set:function(e){this._upperAngle=e,this._joint&&this._joint.setUpperAngle(e)}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(e){this._enableMotor=e,this._joint&&this._joint.enableMotor(e)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(e){this._maxMotorTorque=e,this._joint&&this._joint.setMaxMotorTorque(e)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(e){this._motorSpeed=e,this._joint&&this._joint.setMotorSpeed(e)}}]),i}(F7)).prototype,"enableLimit",[g7],Object.getOwnPropertyDescriptor(R7.prototype,"enableLimit"),R7.prototype),x(R7.prototype,"lowerAngle",[S7],Object.getOwnPropertyDescriptor(R7.prototype,"lowerAngle"),R7.prototype),x(R7.prototype,"upperAngle",[A7],Object.getOwnPropertyDescriptor(R7.prototype,"upperAngle"),R7.prototype),x(R7.prototype,"enableMotor",[T7],Object.getOwnPropertyDescriptor(R7.prototype,"enableMotor"),R7.prototype),x(R7.prototype,"maxMotorTorque",[E7],Object.getOwnPropertyDescriptor(R7.prototype,"maxMotorTorque"),R7.prototype),x(R7.prototype,"motorSpeed",[b7],Object.getOwnPropertyDescriptor(R7.prototype,"motorSpeed"),R7.prototype),x7=Ms(R7.prototype,"_enableLimit",[Js],(function(){return!1})),w7=Ms(R7.prototype,"_lowerAngle",[Js],(function(){return 0})),k7=Ms(R7.prototype,"_upperAngle",[Js],(function(){return 0})),I7=Ms(R7.prototype,"_enableMotor",[Js],(function(){return!1})),B7=Ms(R7.prototype,"_maxMotorTorque",[Js],(function(){return 1e3})),P7=Ms(R7.prototype,"_motorSpeed",[Js],(function(){return 0})),C7=R7))||C7)),e("Physics2DUtils",{PolygonSeparator:c4,PolygonPartition:R4}),B.internal.physics2d={selector:G5};var H7=[new In,new In],z7=new Q5.WorldManifold,W7={points:[],separations:[],normal:new In},X7=function e(){n(this,e),this.localPoint=new In,this.normalImpulse=0,this.tangentImpulse=0},j7=[new X7,new X7],q7={type:0,localPoint:new In,localNormal:new In,points:[]},Y7={normalImpulses:[],tangentImpulses:[]},K7=function(){function e(t){n(this,e),this.ref=0,this.status=N5.None,this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null,this.ref=1,this.init(t)}return s(e,[{key:"_setImpulse",value:function(e){this._impulse=e}},{key:"init",value:function(e){this.colliderA=e.m_fixtureA.m_userData.collider,this.colliderB=e.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=e}},{key:"reset",value:function(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact=null}},{key:"getWorldManifold",value:function(){var e=W7.points,t=W7.separations,i=W7.normal;this._b2contact.GetWorldManifold(z7);var n=z7.points,r=z7.separations,s=this._b2contact.GetManifold().pointCount;e.length=t.length=s;for(var a=0;a<s;a++){var o=H7[a];o.x=n[a].x*F5,o.y=n[a].y*F5,e[a]=o,t[a]=r[a]*F5}return i.x=z7.normal.x,i.y=z7.normal.y,this._inverted&&(i.x*=-1,i.y*=-1),W7}},{key:"getManifold",value:function(){for(var e=q7.points,t=q7.localNormal,i=q7.localPoint,n=this._b2contact.GetManifold(),r=n.points,s=e.length=n.pointCount,a=0;a<s;a++){var o=j7[a],u=r[a];o.localPoint.x=u.localPoint.x*F5,o.localPoint.y=u.localPoint.y*F5,o.normalImpulse=u.normalImpulse*F5,o.tangentImpulse=u.tangentImpulse,e[a]=o}return i.x=n.localPoint.x*F5,i.y=n.localPoint.y*F5,t.x=n.localNormal.x,t.y=n.localNormal.y,q7.type=n.type,this._inverted&&(t.x*=-1,t.y*=-1),q7}},{key:"getImpulse",value:function(){var e=this._impulse;if(!e)return null;for(var t=Y7.normalImpulses,i=Y7.tangentImpulses,n=e.count,r=0;r<n;r++)t[r]=e.normalImpulses[r]*F5,i[r]=e.tangentImpulses[r];return i.length=t.length=n,Y7}},{key:"setEnabled",value:function(e){this._b2contact.SetEnabled(e)}},{key:"isTouching",value:function(){return this._b2contact.IsTouching()}},{key:"setTangentSpeed",value:function(e){this._b2contact.SetTangentSpeed(e)}},{key:"getTangentSpeed",value:function(){return this._b2contact.GetTangentSpeed()}},{key:"setFriction",value:function(e){this._b2contact.SetFriction(e)}},{key:"getFriction",value:function(){return this._b2contact.GetFriction()}},{key:"resetFriction",value:function(){return this._b2contact.ResetFriction()}},{key:"setRestitution",value:function(e){this._b2contact.SetRestitution(e)}},{key:"getRestitution",value:function(){return this._b2contact.GetRestitution()}},{key:"resetRestitution",value:function(){return this._b2contact.ResetRestitution()}}]),e}(),Q7=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"getContactKey",value:function(e){var t=e.m_fixtureA.m_userData.collider,i=e.m_fixtureB.m_userData.collider,n=t.uuid+i.uuid;return t.uuid>i.uuid&&(n=i.uuid+t.uuid),n}},{key:"BeginContact",value:function(e){var t=this.getContactKey(e);if(i._contactMap.has(t)){var n=i._contactMap.get(t);n.ref++,n.status===N5.END_CONTACT?n.status=N5.STAY_CONTACT:n.status!==N5.STAY_CONTACT&&(n.status=N5.BEGIN_CONTACT)}else{var r=new K7(e);i._contactMap.set(t,r),r.status=N5.BEGIN_CONTACT}}},{key:"EndContact",value:function(e){var t=this.getContactKey(e),n=i._contactMap.get(t);Z(n),n.ref--,n.ref<=0&&(n.status=N5.END_CONTACT)}},{key:"PreSolve",value:function(){}},{key:"PostSolve",value:function(){}},{key:"finalizeContactEvent",value:function(){var e=this;i._contactMap.forEach((function(t,n){t.status===N5.END_CONTACT?(i._contactMap.delete(n),e.emit(N5.END_CONTACT,t)):t.status===N5.BEGIN_CONTACT?(t.status=N5.STAY_CONTACT,e.emit(N5.BEGIN_CONTACT,t)):t.status===N5.STAY_CONTACT&&e.emit(N5.STAY_CONTACT,t)}))}},{key:"emit",value:function(e,t){var i=t.colliderA,n=t.colliderB;if(i&&n){var r=i.body,s=n.body;r&&!r.enabledInHierarchy||s&&!s.enabledInHierarchy||!r&&!s||((r&&r.enabledContactListener||!r)&&(null==i||i.emit(e,i,n,t)),(s&&s.enabledContactListener||!s)&&(null==n||n.emit(e,n,i,t)),(r&&r.enabledContactListener||s&&s.enabledContactListener||!r||!s)&&e8.instance.emit(e,i,n,t),(t.disabled||t.disabledOnce)&&(t.setEnabled(!1),t.disabledOnce=!1))}}}]),i}(Q5.ContactListener);Q7._contactMap=new Map;var J7=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._point=new Q5.Vec2,e._isPoint=!1,e._fixtures=[],e}return s(i,[{key:"init",value:function(e){e?(this._isPoint=!0,this._point.x=e.x,this._point.y=e.y):this._isPoint=!1,this._fixtures.length=0}},{key:"ReportFixture",value:function(e){return this._isPoint?e.TestPoint(this._point)&&this._fixtures.push(e):this._fixtures.push(e),!0}},{key:"getFixture",value:function(){return this._fixtures[0]}},{key:"getFixtures",value:function(){return this._fixtures}}]),i}(Q5.QueryCallback),Z7=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._type=M5.Closest,e._fixtures=[],e._points=[],e._normals=[],e._fractions=[],e._mask=4294967295,e}return s(i,[{key:"init",value:function(e,t){this._type=e,this._mask=t,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0}},{key:"ReportFixture",value:function(e,t,i,n){return 0==(e.GetFilterData().categoryBits&this._mask)?0:this._type===M5.Closest?(this._fixtures[0]=e,this._points[0]=t,this._normals[0]=i,this._fractions[0]=n,n):(this._fixtures.push(e),this._points.push(new In(t.x,t.y)),this._normals.push(new In(i.x,i.y)),this._fractions.push(n),this._type===M5.Any?0:this._type>=M5.All?1:n)}},{key:"getFixtures",value:function(){return this._fixtures}},{key:"getPoints",value:function(){return this._points}},{key:"getNormals",value:function(){return this._normals}},{key:"getFractions",value:function(){return this._fractions}}]),i}(Q5.RayCastCallback),$7=new Q5.Vec2,e9=new cn,t9=cn.GREEN,i9=cn.RED,n9=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this))._drawer=null,r._xf=new Q5.Transform,r._dxf=new Q5.Transform,r._drawer=e,r}return s(i,[{key:"_DrawPolygon",value:function(e,t){for(var i=this._drawer,n=0;n<t;n++){Q5.Transform.MulXV(this._xf,e[n],$7);var r=$7.x*F5,s=$7.y*F5;0===n?i.moveTo(r,s):i.lineTo(r,s)}i.close()}},{key:"DrawPolygon",value:function(e,t,i){this._applyStrokeColor(i),this._DrawPolygon(e,t),this._drawer.stroke()}},{key:"DrawSolidPolygon",value:function(e,t,i){this._applyFillColor(i),this._DrawPolygon(e,t),this._drawer.fill(),this._drawer.stroke()}},{key:"_DrawCircle",value:function(e,t){var i=this._xf.p;this._drawer.circle((e.x+i.x)*F5,(e.y+i.y)*F5,t*F5)}},{key:"DrawCircle",value:function(e,t,i){this._applyStrokeColor(i),this._DrawCircle(e,t),this._drawer.stroke()}},{key:"DrawSolidCircle",value:function(e,t,i,n){this._applyFillColor(n),this._DrawCircle(e,t),this._drawer.fill()}},{key:"DrawSegment",value:function(e,t,i){var n=this._drawer;if(e.x===t.x&&e.y===t.y)return this._applyFillColor(i),this._DrawCircle(e,2/F5),void n.fill();this._applyStrokeColor(i),Q5.Transform.MulXV(this._xf,e,$7),n.moveTo($7.x*F5,$7.y*F5),Q5.Transform.MulXV(this._xf,t,$7),n.lineTo($7.x*F5,$7.y*F5),n.stroke()}},{key:"DrawTransform",value:function(e){var t=this._drawer;t.strokeColor=i9,$7.x=$7.y=0,Q5.Transform.MulXV(e,$7,$7),t.moveTo($7.x*F5,$7.y*F5),$7.x=1,$7.y=0,Q5.Transform.MulXV(e,$7,$7),t.lineTo($7.x*F5,$7.y*F5),t.stroke(),t.strokeColor=t9,$7.x=$7.y=0,Q5.Transform.MulXV(e,$7,$7),t.moveTo($7.x*F5,$7.y*F5),$7.x=0,$7.y=1,Q5.Transform.MulXV(e,$7,$7),t.lineTo($7.x*F5,$7.y*F5),t.stroke()}},{key:"DrawPoint",value:function(){}},{key:"DrawParticles",value:function(){}},{key:"_applyStrokeColor",value:function(e){this._drawer.strokeColor=e9.set(255*e.r,255*e.g,255*e.b,150)}},{key:"_applyFillColor",value:function(e){this._drawer.fillColor=e9.set(255*e.r,255*e.g,255*e.b,150)}},{key:"PushTransform",value:function(e){this._xf=e}},{key:"PopTransform",value:function(){this._xf=this._dxf}}]),i}(Q5.Draw),r9=new an,s9=new In,a9=new In,o9=new Q5.BodyDef,u9=new Q5.AABB,h9=[],l9=function(){function e(){n(this,e),this._world=void 0,this._bodies=[],this._animatedBodies=[],this._rotationAxis=new an,this._physicsGroundBody=void 0,this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new Q5.World(new Q5.Vec2(0,-10));var t=new Q5.BodyDef;this._physicsGroundBody=this._world.CreateBody(t);var i=new Q7;this._world.SetContactListener(i),this._contactListener=i,this._aabbQueryCallback=new J7,this._raycastQueryCallback=new Z7}return s(e,[{key:"impl",get:function(){return this._world}},{key:"groundBodyImpl",get:function(){return this._physicsGroundBody}},{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(e){e||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=e}},{key:"_checkDebugDrawValid",value:function(){if(!this._debugGraphics||!this._debugGraphics.isValid){var e=uD("Canvas");if(!e){var t=DN.getScene();if(!t)return;(e=new Jp("Canvas")).addComponent(Ez),e.parent=t}var i=new Jp("PHYSICS_2D_DEBUG_DRAW");i.hideFlags|=Ga.Flags.DontSave,i.parent=e,i.worldPosition=an.ZERO,i.layer=ep.Enum.UI_2D,this._debugGraphics=i.addComponent(HU),this._debugGraphics.lineWidth=2;var n=new n9(this._debugGraphics);this._b2DebugDrawer=n,this._world.SetDebugDraw(n)}var r=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(r.children.length-1),this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)}},{key:"setGravity",value:function(e){this._world.SetGravity(e)}},{key:"setAllowSleep",value:function(){this._world.SetAllowSleeping(!0)}},{key:"step",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,n=this._animatedBodies,r=0,s=n.length;r<s;r++)n[r].animate(e);this._world.Step(e,t,i)}},{key:"raycast",value:function(e,t,i,n){if(e.equals(t))return[];i=i||M5.Closest,s9.x=e.x/F5,s9.y=e.y/F5,a9.x=t.x/F5,a9.y=t.y/F5;var r=this._raycastQueryCallback;r.init(i,n),this._world.RayCast(r,s9,a9);var s=r.getFixtures();if(s.length>0){for(var a=r.getPoints(),o=r.getNormals(),u=r.getFractions(),h=[],l=0,c=s.length;l<c;l++){var _=s[l],f=_.m_userData,d=f.collider;if(i===M5.AllClosest){for(var m=void 0,p=0;p<h.length;p++)h[p].collider===d&&(m=h[p]);if(m){u[l]<m.fraction&&(m.fixtureIndex=f.getFixtureIndex(_),m.point.x=a[l].x*F5,m.point.y=a[l].y*F5,m.normal.x=o[l].x,m.normal.y=o[l].y,m.fraction=u[l]);continue}}h.push({collider:d,fixtureIndex:f.getFixtureIndex(_),point:new In(a[l].x*F5,a[l].y*F5),normal:new In(o[l].x,o[l].y),fraction:u[l]})}return h}return[]}},{key:"syncPhysicsToScene",value:function(){for(var e=this._bodies,t=0,i=e.length;t<i;t++){var n=e[t],r=n.rigidBody;if(r.type!==k5.Animated){var s=r.node,a=n.impl,o=a.GetPosition();r9.x=o.x*F5,r9.y=o.y*F5,r9.z=0,s.worldPosition=r9;var u=Vi(a.GetAngle());s.setWorldRotationFromEuler(0,0,u)}else n.resetVelocity()}}},{key:"syncSceneToPhysics",value:function(){for(var e=this._bodies,t=0;t<e.length;t++)e[t].syncSceneToPhysics()}},{key:"addBody",value:function(e){if(!this._bodies.includes(e)){var t=o9,i=e.rigidBody;t.allowSleep=i.allowSleep,t.gravityScale=i.gravityScale,t.linearDamping=i.linearDamping,t.angularDamping=i.angularDamping,t.fixedRotation=i.fixedRotation,t.bullet=i.bullet;var n=i.node,r=n.worldPosition;t.position.Set(r.x/F5,r.y/F5),r9.z=vn.getAxisAngle(this._rotationAxis,n.worldRotation),this._rotationAxis.z<0&&(r9.z=2*Math.PI-r9.z),t.angle=r9.z,t.awake=i.awakeOnLoad,i.type===k5.Animated?(t.type=k5.Kinematic,this._animatedBodies.push(e),e._animatedPos.set(t.position.x,t.position.y),e._animatedAngle=t.angle):t.type=i.type;var s=i,a=s._linearVelocity;t.linearVelocity.Set(a.x,a.y),t.angularVelocity=Gi(s._angularVelocity);var o=this._world.CreateBody(t);o.m_userData=e,e._imp=o,this._bodies.push(e)}}},{key:"removeBody",value:function(e){this._bodies.includes(e)&&(e.impl&&(e.impl.m_userData=null,this._world.DestroyBody(e.impl),e._imp=null),St(this._bodies,e),e.rigidBody.type===k5.Animated&&St(this._animatedBodies,e))}},{key:"testPoint",value:function(e){var t=s9.x=e.x/F5,i=s9.y=e.y/F5,n=.2/F5;u9.lowerBound.x=t-n,u9.lowerBound.y=i-n,u9.upperBound.x=t+n,u9.upperBound.y=i+n;var r=this._aabbQueryCallback;r.init(s9),this._world.QueryAABB(r,u9);var s=r.getFixtures();h9.length=0;for(var a=0;a<s.length;a++){var o=s[a].m_userData.collider;h9.includes(o)||h9.push(o)}return h9}},{key:"testAABB",value:function(e){u9.lowerBound.x=e.xMin/F5,u9.lowerBound.y=e.yMin/F5,u9.upperBound.x=e.xMax/F5,u9.upperBound.y=e.yMax/F5;var t=this._aabbQueryCallback;t.init(),this._world.QueryAABB(t,u9);var i=t.getFixtures();h9.length=0;for(var n=0;n<i.length;n++){var r=i[n].m_userData.collider;h9.includes(r)||h9.push(r)}return h9}},{key:"drawDebug",value:function(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())}},{key:"finalizeContactEvent",value:function(){this._contactListener.finalizeContactEvent()}}]),e}(),c9=new an,_9=new Q5.Vec2,f9=function(){function e(){n(this,e),this._animatedPos=new In,this._animatedAngle=0,this._body=null,this._inited=!1}return s(e,[{key:"impl",get:function(){return this._body}},{key:"_imp",set:function(e){this._body=e}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"isAwake",get:function(){return this._body.IsAwake()}},{key:"isSleeping",get:function(){return!this._body.IsAwake()}},{key:"initialize",value:function(e){this._rigidBody=e,e8.instance._callAfterStep(this,this._init)}},{key:"onDestroy",value:function(){e8.instance._callAfterStep(this,this._destroy)}},{key:"onEnable",value:function(){this.setActive(!0)}},{key:"onDisable",value:function(){this.setActive(!1)}},{key:"nodeTransformChanged",value:function(e){if(!e8.instance.stepping){if(e&Jp.TransformBit.SCALE)for(var t=this.rigidBody.getComponents(L7),i=0;i<t.length;i++)t[i].apply();e&Jp.TransformBit.POSITION&&this.syncPositionToPhysics(!0),e&Jp.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}}},{key:"_init",value:function(){this._inited||(e8.instance.physicsWorld.addBody(this),this.setActive(!1),this._inited=!0)}},{key:"_destroy",value:function(){this._inited&&(e8.instance.physicsWorld.removeBody(this),this._inited=!1)}},{key:"animate",value:function(e){var t=this._body;if(t){var i=t.GetPosition();t.SetAwake(!0);var n=1/e;_9.x=(this._animatedPos.x-i.x)*n,_9.y=(this._animatedPos.y-i.y)*n,t.SetLinearVelocity(_9);var r=t.GetAngle()%Pi;r>Math.PI&&(r-=Pi);var s=(this._animatedAngle-r)*n;this._animatedAngle<-Bi&&r>Bi&&(s=(this._animatedAngle+Pi-r)*n),this._animatedAngle>Bi&&r<-Bi&&(s=(this._animatedAngle-Pi-r)*n),t.SetAngularVelocity(s)}}},{key:"syncSceneToPhysics",value:function(){var e=this._rigidBody.node.hasChangedFlags;e&&this.nodeTransformChanged(e)}},{key:"syncPositionToPhysics",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this._body;if(t){var i,n=this._rigidBody.node.worldPosition,r=this._rigidBody.type;(i=r===k5.Animated?t.GetLinearVelocity():t.GetPosition()).x=n.x/F5,i.y=n.y/F5,r===k5.Animated&&e?this._animatedPos.set(i.x,i.y):t.SetTransformVec(i,t.GetAngle())}}},{key:"syncRotationToPhysics",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this._body;if(t){var i=this._rigidBody.node.worldRotation,n=c9;vn.toEulerInYXZOrder(n,i);var r=Gi(n.z),s=this._rigidBody.type;s===k5.Animated&&e?this._animatedAngle=r:t.SetTransformVec(t.GetPosition(),r)}}},{key:"resetVelocity",value:function(){var e=this._body;if(e){var t=e.m_linearVelocity;t.Set(0,0),e.SetLinearVelocity(t),e.SetAngularVelocity(0)}}},{key:"setType",value:function(e){this._body.SetType(e)}},{key:"setLinearDamping",value:function(e){this._body.SetLinearDamping(e)}},{key:"setAngularDamping",value:function(e){this._body.SetAngularDamping(e)}},{key:"setGravityScale",value:function(e){this._body.SetGravityScale(e)}},{key:"setFixedRotation",value:function(e){this._body.SetFixedRotation(e)}},{key:"setAllowSleep",value:function(e){this._body.SetSleepingAllowed(e)}},{key:"isActive",value:function(){return this._body.IsActive()}},{key:"setActive",value:function(e){this._body.SetActive(e)}},{key:"wakeUp",value:function(){this._body.SetAwake(!0)}},{key:"sleep",value:function(){this._body.SetAwake(!1)}},{key:"getMass",value:function(){return this._body.GetMass()}},{key:"setLinearVelocity",value:function(e){this._body.SetLinearVelocity(e)}},{key:"getLinearVelocity",value:function(e){var t=this._body.GetLinearVelocity();return e.x=t.x,e.y=t.y,e}},{key:"getLinearVelocityFromWorldPoint",value:function(e,t){return _9.Set(e.x/F5,e.y/F5),this._body.GetLinearVelocityFromWorldPoint(_9,t),t.x*=F5,t.y*=F5,t}},{key:"setAngularVelocity",value:function(e){this._body.SetAngularVelocity(e)}},{key:"getAngularVelocity",value:function(){return Vi(this._body.GetAngularVelocity())}},{key:"getLocalVector",value:function(e,t){return t=t||new In,_9.Set(e.x/F5,e.y/F5),this._body.GetLocalVector(_9,t),t.x*=F5,t.y*=F5,t}},{key:"getWorldVector",value:function(e,t){return _9.Set(e.x/F5,e.y/F5),this._body.GetWorldVector(_9,t),t.x*=F5,t.y*=F5,t}},{key:"getLocalPoint",value:function(e,t){return t=t||new In,_9.Set(e.x/F5,e.y/F5),this._body.GetLocalPoint(_9,t),t.x*=F5,t.y*=F5,t}},{key:"getWorldPoint",value:function(e,t){return t=t||new In,_9.Set(e.x/F5,e.y/F5),this._body.GetWorldPoint(_9,t),t.x*=F5,t.y*=F5,t}},{key:"getLocalCenter",value:function(e){e=e||new In;var t=this._body.GetLocalCenter();return e.x=t.x*F5,e.y=t.y*F5,e}},{key:"getWorldCenter",value:function(e){e=e||new In;var t=this._body.GetWorldCenter();return e.x=t.x*F5,e.y=t.y*F5,e}},{key:"getInertia",value:function(){return this._body.GetInertia()}},{key:"applyForce",value:function(e,t,i){this._body&&(_9.Set(t.x/F5,t.y/F5),this._body.ApplyForce(e,_9,i))}},{key:"applyForceToCenter",value:function(e,t){this._body&&this._body.ApplyForceToCenter(e,t)}},{key:"applyTorque",value:function(e,t){this._body&&this._body.ApplyTorque(e,t)}},{key:"applyLinearImpulse",value:function(e,t,i){this._body&&(_9.Set(t.x/F5,t.y/F5),this._body.ApplyLinearImpulse(e,_9,i))}},{key:"applyLinearImpulseToCenter",value:function(e,t){this._body&&this._body.ApplyLinearImpulse(e,this._body.GetPosition(),t)}},{key:"applyAngularImpulse",value:function(e,t){this._body&&this._body.ApplyAngularImpulse(e,t)}}]),e}(),d9=new Q5.Filter;function m9(e){var t=e.collider;return t.body?d9.categoryBits=t.group===C4.DEFAULT?t.body.group:t.group:d9.categoryBits=t.group,d9.maskBits=e8.instance.collisionMatrix[d9.categoryBits],d9}var p9=function(){function e(){n(this,e),this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new Dn}return s(e,[{key:"impl",get:function(){return this._shapes}},{key:"collider",get:function(){return this._collider}},{key:"initialize",value:function(e){this._collider=e}},{key:"onLoad",value:function(){}},{key:"onEnable",value:function(){e8.instance._callAfterStep(this,this._init)}},{key:"onDisable",value:function(){e8.instance._callAfterStep(this,this._destroy)}},{key:"start",value:function(){}},{key:"onGroupChanged",value:function(){var e=m9(this);this._fixtures.forEach((function(t){t.SetFilterData(e)}))}},{key:"apply",value:function(){this._destroy(),this.collider.enabledInHierarchy&&this._init()}},{key:"worldAABB",get:function(){for(var e=1e7,t=e,i=e,n=-e,r=-e,s=this._fixtures,a=0;a<s.length;a++)for(var o=s[a],u=o.GetShape().GetChildCount(),h=0;h<u;h++){var l=o.GetAABB(h);2===o.GetShape().m_type&&(l.lowerBound.SelfAddXY(o.GetShape().m_radius,o.GetShape().m_radius),l.upperBound.SelfSubXY(o.GetShape().m_radius,o.GetShape().m_radius)),l.lowerBound.x<t&&(t=l.lowerBound.x),l.lowerBound.y<i&&(i=l.lowerBound.y),l.upperBound.x>n&&(n=l.upperBound.x),l.upperBound.y>r&&(r=l.upperBound.y)}t*=F5,i*=F5,n*=F5,r*=F5;var c=this._rect;return c.x=t,c.y=i,c.width=n-t,c.height=r-i,c}},{key:"getFixtureIndex",value:function(e){return this._fixtures.indexOf(e)}},{key:"_createShapes",value:function(){return[]}},{key:"_init",value:function(){if(!this._inited){var e=this.collider,t=e.node.worldScale,i=an.ZERO,n=e.getComponent(O7);n&&n.impl&&n.impl.impl?this._body=n.impl.impl:(this._body=e8.instance.physicsWorld.groundBodyImpl,i=e.node.worldPosition);for(var r=0===t.x&&0===t.y?[]:this._createShapes(t.x,t.y,i.x,i.y),s=m9(this),a=0;a<r.length;a++){var o=r[a],u={density:e.density,isSensor:e.sensor,friction:e.friction,restitution:e.restitution,shape:o,filter:s},h=this._body.CreateFixture(u);h.m_userData=this,this._shapes.push(o),this._fixtures.push(h)}this._inited=!0}}},{key:"_destroy",value:function(){if(this._inited){for(var e=this._fixtures,t=this._body,i=e.length-1;i>=0;i--){var n=e[i];t&&t.DestroyFixture(n)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}}}]),e}(),v9=new Dn,y9=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._worldPoints=[new In,new In,new In,new In],e}return s(i,[{key:"worldPoints",get:function(){var e=v9,t=this.collider,i=t.size,n=t.offset;e.x=n.x-i.width/2,e.y=n.y-i.height/2,e.width=i.width,e.height=i.height;var r=this._worldPoints,s=r[0],a=r[1],o=r[2],u=r[3];return e.transformMat4ToPoints(t.node.worldMatrix,s,a,o,u),r}},{key:"_createShapes",value:function(e,t,i,n){e=Math.abs(e),t=Math.abs(t);var r=this.collider,s=r.size.width/2/F5*e,a=r.size.height/2/F5*t,o=(i+r.offset.x*e)/F5,u=(n+r.offset.y*t)/F5,h=new Q5.PolygonShape;return h.SetAsBox(s,a,new Q5.Vec2(o,u),0),[h]}}]),i}(p9),g9=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._worldPosition=new In,e}return s(i,[{key:"worldRadius",get:function(){return this._shapes[0].m_radius*F5}},{key:"worldPosition",get:function(){var e=this._shapes[0].m_p;return this._worldPosition.set(e.x*F5,e.y*F5)}},{key:"_createShapes",value:function(e,t,i,n){e=Math.abs(e),t=Math.abs(t);var r=this.collider,s=(i+r.offset.x*e)/F5,a=(n+r.offset.y*t)/F5,o=new Q5.CircleShape;return o.m_radius=r.radius/F5*e,o.m_p.Set(s,a),[o]}}]),i}(p9),S9=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._worldPoints=[],e}return s(i,[{key:"worldPoints",get:function(){for(var e=this.collider,t=e.points,i=this._worldPoints,n=e.node.worldMatrix,r=0;r<t.length;r++)i[r]||(i[r]=new In),In.transformMat4(i[r],t[r],n);return i.length=t.length,this._worldPoints}},{key:"_createShapes",value:function(e,t,i,n){var r=[],s=this.collider,a=s.points;a.length>0&&a[0].equals(a[a.length-1])&&(a.length-=1);var o=_4(a);if(!o)return console.log("[Physics2D] b2PolygonShape failed to decompose polygon into convex polygons, node name: ",s.node.name),r;for(var u=s.offset,h=0;h<o.length;h++){for(var l=o[h],c=null,_=[],f=null,d=0,m=l.length;d<m;d++){c||(c=new Q5.PolygonShape);var p=l[d],v=(i+(p.x+u.x)*e)/F5,y=(n+(p.y+u.y)*t)/F5,g=new Q5.Vec2(v,y);_.push(g),f||(f=g),_.length===Q5.maxPolygonVertices&&(c.Set(_,_.length),r.push(c),c=null,d<m-1&&(_=[f,_[_.length-1]]))}c&&(c.Set(_,_.length),r.push(c))}return r}}]),i}(p9),A9=function(){function e(){n(this,e),this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}return s(e,[{key:"impl",get:function(){return this._b2joint}},{key:"comp",get:function(){return this._jointComp}},{key:"body",get:function(){return this._body}},{key:"initialize",value:function(e){this._jointComp=e}},{key:"onEnable",value:function(){e8.instance._callAfterStep(this,this._init)}},{key:"onDisable",value:function(){e8.instance._callAfterStep(this,this._destroy)}},{key:"start",value:function(){e8.instance._callAfterStep(this,this._init)}},{key:"_init",value:function(){if(!this._inited){var e=this._jointComp;if(e.isValid){this._body=e.getComponent(O7);var t=this._createJointDef();if(t){t.bodyA=this._body.impl.impl;var i=e.connectedBody;i&&!i.enabledInHierarchy||(t.bodyB=i?i.impl.impl:e8.instance.physicsWorld.groundBodyImpl,t.collideConnected=e.collideConnected,this._b2joint=e8.instance.physicsWorld.impl.CreateJoint(t),this._inited=!0)}}}}},{key:"_destroy",value:function(){this._inited&&(e8.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)}},{key:"_createJointDef",value:function(){return null}},{key:"isValid",value:function(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp}}]),e}(),T9=new Q5.Vec2,E9=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._touchPoint=new In,e._isTouched=!1,e}return s(i,[{key:"setTarget",value:function(e){this._b2joint&&(T9.x=e.x/F5,T9.y=e.y/F5,this._b2joint.SetTarget(T9))}},{key:"setDampingRatio",value:function(e){this._b2joint&&this._b2joint.SetDampingRatio(e)}},{key:"setFrequency",value:function(e){this._b2joint&&this._b2joint.SetFrequency(e)}},{key:"setMaxForce",value:function(e){this._b2joint&&this._b2joint.SetMaxForce(e)}},{key:"_createJointDef",value:function(){var e=new Q5.MouseJointDef,t=this._jointComp;return e.target.Set(this._touchPoint.x/F5,this._touchPoint.y/F5),e.maxForce=t.maxForce,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e}},{key:"initialize",value:function(e){g(l(i.prototype),"initialize",this).call(this,e);var t=uD("Canvas");t&&(t.on(rp.TOUCH_START,this.onTouchBegan,this),t.on(rp.TOUCH_MOVE,this.onTouchMove,this),t.on(rp.TOUCH_END,this.onTouchEnd,this),t.on(rp.TOUCH_CANCEL,this.onTouchEnd,this))}},{key:"onEnable",value:function(){}},{key:"start",value:function(){}},{key:"onTouchBegan",value:function(e){this._isTouched=!0;var t=this._touchPoint.set(e.getUILocation()),i=e8.instance.physicsWorld.testPoint(t);if(!(i.length<=0)){var n=i[0].body;n.wakeUp();var r=this._jointComp;r.connectedBody=n,this._init(),this.setMaxForce(r.maxForce*n.getMass()),this.setTarget(t)}}},{key:"onTouchMove",value:function(e){this._touchPoint=e.getUILocation()}},{key:"onTouchEnd",value:function(){this._destroy(),this._isTouched=!1}},{key:"update",value:function(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)}}]),i}(A9),b9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"setMaxLength",value:function(e){this._b2joint&&this._b2joint.SetMaxLength(e)}},{key:"_createJointDef",value:function(){var e=this._jointComp,t=new Q5.RopeJointDef;return t.localAnchorA.Set(e.anchor.x/F5,e.anchor.y/F5),t.localAnchorB.Set(e.connectedAnchor.x/F5,e.connectedAnchor.y/F5),t.maxLength=e.maxLength/F5,t}}]),i}(A9),C9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"setDampingRatio",value:function(e){this._b2joint&&this._b2joint.SetDampingRatio(e)}},{key:"setFrequency",value:function(e){this._b2joint&&this._b2joint.SetFrequency(e)}},{key:"setDistance",value:function(e){this._b2joint&&this._b2joint.SetLength(e)}},{key:"_createJointDef",value:function(){var e=this._jointComp,t=new Q5.DistanceJointDef;return t.localAnchorA.Set(e.anchor.x/F5,e.anchor.y/F5),t.localAnchorB.Set(e.connectedAnchor.x/F5,e.connectedAnchor.y/F5),t.length=e.distance/F5,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t}}]),i}(A9),R9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"setMaxForce",value:function(e){this._b2joint&&this._b2joint.SetMaxForce(e)}},{key:"setAngularOffset",value:function(e){this._b2joint&&this._b2joint.SetAngularOffset(Gi(e))}},{key:"setLinearOffset",value:function(e){this._b2joint&&this._b2joint.SetLinearOffset(new Q5.Vec2(e.x/F5,e.y/F5))}},{key:"setCorrectionFactor",value:function(e){this._b2joint&&(this._b2joint.m_correctionFactor=e)}},{key:"setMaxTorque",value:function(e){this._b2joint&&this._b2joint.SetMaxTorque(e)}},{key:"_createJointDef",value:function(){var e=this._jointComp,t=new Q5.MotorJointDef;return t.linearOffset.Set(e.linearOffset.x/F5,e.linearOffset.y/F5),t.angularOffset=Gi(e.angularOffset),t.maxForce=e.maxForce,t.maxTorque=e.maxTorque,t.correctionFactor=e.correctionFactor,t}}]),i}(A9),x9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"enableLimit",value:function(e){this._b2joint&&this._b2joint.EnableLimit(e)}},{key:"setLowerLimit",value:function(){this.updateLimits()}},{key:"setUpperLimit",value:function(){this.updateLimits()}},{key:"updateLimits",value:function(){if(this._b2joint){var e=this._jointComp;this._b2joint.SetLimits(e.lowerLimit/F5,e.upperLimit/F5)}}},{key:"enableMotor",value:function(e){this._b2joint&&this._b2joint.EnableMotor(e)}},{key:"setMaxMotorForce",value:function(e){this._b2joint&&this._b2joint.SetMaxMotorForce(e)}},{key:"setMotorSpeed",value:function(e){this._b2joint&&this._b2joint.SetMotorSpeed(e)}},{key:"_createJointDef",value:function(){var e=this._jointComp,t=new Q5.PrismaticJointDef;t.localAnchorA.Set(e.anchor.x/F5,e.anchor.y/F5),t.localAnchorB.Set(e.connectedAnchor.x/F5,e.connectedAnchor.y/F5);var i=Gi(e.angle);return t.localAxisA.Set(Math.cos(i),Math.sin(i)),t.referenceAngle=0,t.enableLimit=e.enableLimit,t.lowerTranslation=e.lowerLimit/F5,t.upperTranslation=e.upperLimit/F5,t.enableMotor=e.enableMotor,t.maxMotorForce=e.maxMotorForce,t.motorSpeed=e.motorSpeed,t}}]),i}(A9),w9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"setFrequency",value:function(e){this._b2joint&&this._b2joint.SetFrequency(e)}},{key:"setDampingRatio",value:function(e){this._b2joint&&this._b2joint.SetDampingRatio(e)}},{key:"_createJointDef",value:function(){var e=this._jointComp,t=new Q5.WeldJointDef;return t.localAnchorA.Set(e.anchor.x/F5,e.anchor.y/F5),t.localAnchorB.Set(e.connectedAnchor.x/F5,e.connectedAnchor.y/F5),t.referenceAngle=0,t.frequencyHz=e.frequency,t.dampingRatio=e.dampingRatio,t}}]),i}(A9),k9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"setDampingRatio",value:function(e){this._b2joint&&this._b2joint.SetSpringDampingRatio(e)}},{key:"setFrequency",value:function(e){this._b2joint&&this._b2joint.SetSpringFrequencyHz(e)}},{key:"enableMotor",value:function(e){this._b2joint&&this._b2joint.EnableMotor(e)}},{key:"setMaxMotorTorque",value:function(e){this._b2joint&&this._b2joint.SetMaxMotorTorque(e)}},{key:"setMotorSpeed",value:function(e){this._b2joint&&this._b2joint.SetMotorSpeed(e)}},{key:"_createJointDef",value:function(){var e=this._jointComp,t=new Q5.WheelJointDef;t.localAnchorA.Set(e.anchor.x/F5,e.anchor.y/F5),t.localAnchorB.Set(e.connectedAnchor.x/F5,e.connectedAnchor.y/F5);var i=Gi(e.angle);return t.localAxisA.Set(Math.cos(i),Math.sin(i)),t.maxMotorTorque=e.maxMotorTorque,t.motorSpeed=Gi(e.motorSpeed),t.enableMotor=e.enableMotor,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t}}]),i}(A9),I9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"enableLimit",value:function(e){this._b2joint&&this._b2joint.EnableLimit(e)}},{key:"setLowerAngle",value:function(){this.updateLimits()}},{key:"setUpperAngle",value:function(){this.updateLimits()}},{key:"updateLimits",value:function(){if(this._b2joint){var e=this._jointComp;this._b2joint.SetLimits(Gi(e.lowerAngle),Gi(e.upperAngle))}}},{key:"enableMotor",value:function(e){this._b2joint&&this._b2joint.EnableMotor(e)}},{key:"setMaxMotorTorque",value:function(e){this._b2joint&&this._b2joint.SetMaxMotorTorque(e)}},{key:"setMotorSpeed",value:function(e){this._b2joint&&this._b2joint.SetMotorSpeed(e)}},{key:"_createJointDef",value:function(){var e=this._jointComp,t=new Q5.RevoluteJointDef;return t.localAnchorA.Set(e.anchor.x/F5,e.anchor.y/F5),t.localAnchorB.Set(e.connectedAnchor.x/F5,e.connectedAnchor.y/F5),t.enableMotor=e.enableMotor,t.maxMotorTorque=e.maxMotorTorque,t.motorSpeed=Gi(e.motorSpeed),t.enableLimit=e.enableLimit,t.lowerAngle=Gi(e.lowerAngle),t.upperAngle=Gi(e.upperAngle),t}}]),i}(A9);UN.once(VN.EVENT_PRE_SUBSYSTEM_INIT,(function(){G5.register("box2d",{PhysicsWorld:l9,RigidBody:f9,BoxShape:y9,CircleShape:g9,PolygonShape:S9,MouseJoint:E9,DistanceJoint:b9,SpringJoint:C9,RelativeJoint:R9,SliderJoint:x9,FixedJoint:w9,WheelJoint:k9,HingeJoint:I9})}));var B9,P9=function(){function e(t,i,r){n(this,e),this._opts=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=i,this._accumStart=r}return s(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}},{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(){var e=this._opts,t=e.average,i=e.isInteger,n=t?this._averageValue:this._value;return i?Math.round(n):Math.round(100*n)/100}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var i=t;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}]),e}(),M9=Hs("cc.PerfCounter")(B9=function(e){h(i,e);var t=v(i);function i(e,r,s){var a;return n(this,i),(a=t.call(this,e,r,s))._time=s,a}return s(i,[{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._time=e}},{key:"end",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._value=e-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),i}(P9))||B9,O9="0123456789. ",D9=500,L9={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},N9={fps:{desc:"Framerate (FPS)",below:30,average:D9,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:D9},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:D9,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:D9},render:{desc:"Renderer (ms)",min:0,max:50,average:D9,color:"#f90"},present:{desc:"Present (ms)",min:0,max:50,average:D9,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},F9=e("Profiler",function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._stats=null,e._showFPS=!1,e._rootNode=null,e._device=null,e._swapchain=null,e._meshRenderer=null,e._canvas=null,e._ctx=null,e._texture=null,e._region=new Mc,e._canvasArr=[],e._regionArr=[e._region],e.digitsData=null,e.offsetData=null,e.pass=null,e._canvasDone=!1,e._statsDone=!1,e._inited=!1,e._lineHeight=280/(Object.keys(N9).length+1),e._wordHeight=0,e._eachNumWidth=0,e._totalLines=0,e.lastTime=0,e._canvas=M.document.createElement("canvas"),e._ctx=e._canvas.getContext("2d"),e._canvasArr.push(e._canvas),e}return s(i,[{key:"init",value:function(){Dt.querySettings(Ot.Category.PROFILING,"showFPS")?this.showStats():this.hideStats()}},{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),B.director.off(B.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),B.director.off(B.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),B.director.off(B.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),B.director.off(B.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),B.director.off(B.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),B.director.off(B.Director.EVENT_AFTER_RENDER,this.afterRender,this),B.director.off(B.Director.EVENT_AFTER_DRAW,this.afterPresent,this),this._showFPS=!1,DN.root.pipeline.profiler=null,B.game.config.showFPS=!1)}},{key:"showStats",value:function(){if(!this._showFPS){if(!this._device){var e=B.director.root;this._device=yf.gfxDevice,this._swapchain=e.mainWindow.swapchain}this.generateCanvas(),this.generateStats(),B.game.once(B.Game.EVENT_ENGINE_INITED,this.generateNode,this),B.game.on(B.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),B.director.on(B.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),B.director.on(B.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),B.director.on(B.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),B.director.on(B.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),B.director.on(B.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),B.director.on(B.Director.EVENT_AFTER_RENDER,this.afterRender,this),B.director.on(B.Director.EVENT_AFTER_DRAW,this.afterPresent,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,B.game.config.showFPS=!0}}},{key:"generateCanvas",value:function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=280,this._canvas.height=280,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx.font="".concat(23,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new Wc(zl.TEX2D,Wl.SAMPLED|Wl.TRANSFER_DST,Ll.RGBA8,280,280)),this._region.texExtent.width=280,this._region.texExtent.height=280)}}},{key:"generateStats",value:function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var i in N9){var n=N9[i];this._ctx.fillText(n.desc,0,t*this._lineHeight),n.counter=new M9(i,n,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<O9.length;++r){var s=this._ctx.measureText(O9[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,s)}for(var a=0;a<O9.length;++a)this._ctx.fillText(O9[a],a*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=N9,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new Jp("PROFILER_NODE"),this._rootNode._objFlags=B.Object.Flags.DontSave|B.Object.Flags.HideInHierarchy,B.game.addPersistRootNode(this._rootNode);var e=new Jp("Profiler_Root");e.parent=this._rootNode;for(var t=.4,i=t/this._totalLines,n=t/this._wordHeight,r=i/23,s=this._eachNumWidth*this._canvas.width*r,a=[0,t,0,n,t,0,n,0,0,0,0,0],o=[0,2,1,0,3,2],u=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],h=0,l=0;l<this._totalLines;l++)for(var c=0;c<8;c++){a.push(n+c*s,t-l*i,0),a.push(n+(c+1)*s,t-l*i,0),a.push(n+(c+1)*s,t-(l+1)*i,0),a.push(n+c*s,t-(l+1)*i,0),h=4*(8*l+c+1),o.push(0+h,2+h,1+h,0+h,3+h,2+h);var _=8*l+c,f=Math.floor(_/4),d=_-4*f;u.push(0,this._wordHeight,f,d),u.push(this._eachNumWidth,this._wordHeight,f,d),u.push(this._eachNumWidth,1,f,d),u.push(0,1,f,d)}this._meshRenderer=e.addComponent(mN),this._meshRenderer.mesh=qN({positions:a,indices:o,colors:u});var m=new dA;m.initialize({effectName:"util/profiler"});var p=this.pass=m.passes[0],v=p.getBinding("mainTexture"),y=p.getBinding("digits"),g=p.getBinding("offset");p.bindTexture(v,this._texture),this.digitsData=p.blocks[y],this.offsetData=p.blocks[g],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=ep.Enum.PROFILER,this._inited=!0}}},{key:"beforeUpdate",value:function(){if(this._stats){var e=performance.now();this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=performance.now();B.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=performance.now();this._stats.physics.counter.start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=performance.now();this._stats.physics.counter.end(e)}}},{key:"beforeDraw",value:function(){if(this._stats&&this._inited){var e=this._swapchain.surfaceTransform,t=this._device.capabilities.clipSpaceSignY;if(e!==this.offsetData[3]){var i=bn[e],n=-.9,r=-.9*t;Sl.isXR&&(n=-.5,r=-.5*t),this.offsetData[0]=n*i[0]+r*i[2],this.offsetData[1]=n*i[1]+r*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=e}this.pass._rootBufferDirty=!0,this._meshRenderer.model?DN.root.pipeline.profiler=this._meshRenderer.model:DN.root.pipeline.profiler=null;var s=performance.now();this._stats.render.counter.start(s)}}},{key:"afterRender",value:function(){if(this._stats&&this._inited){var e=performance.now();this._stats.render.counter.end(e),this._stats.present.counter.start(e)}}},{key:"afterPresent",value:function(){if(this._stats&&this._inited){var e=performance.now();if(this._stats.frame.counter.end(e),this._stats.fps.counter.frame(e),this._stats.present.counter.end(e),!(e-this.lastTime<D9)){this.lastTime=e;var t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;var i=0,n=this.digitsData;for(var r in this._stats){var s=this._stats[r];s.counter.sample(e);for(var a=s.counter.human().toString(),o=7;o>=0;o--){var u=8*i+o,h=a[a.length-(8-o)],l=L9[h];void 0===l&&(l=11),n[u]=l}i++}}}}}]),i}(Rh)),G9=e("profiler",new F9);DN.registerSystem("profiler",G9,0),B.profiler=G9;var V9=function(){function e(){n(this,e),this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}return s(e,[{key:"clone",value:function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t}},{key:"isDone",value:function(){return!0}},{key:"startWithTarget",value:function(e){this.originalTarget=e,this.target=e}},{key:"stop",value:function(){this.target=null}},{key:"step",value:function(){re(1006)}},{key:"update",value:function(){re(1007)}},{key:"getTarget",value:function(){return this.target}},{key:"setTarget",value:function(e){this.target=e}},{key:"getOriginalTarget",value:function(){return this.originalTarget}},{key:"setOriginalTarget",value:function(e){this.originalTarget=e}},{key:"getTag",value:function(){return this.tag}},{key:"setTag",value:function(e){this.tag=e}},{key:"reverse",value:function(){return re(1008),null}},{key:"retain",value:function(){}},{key:"release",value:function(){}}]),e}();V9.TAG_INVALID=-1;var U9=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._duration=0,e._timesForRepeat=1,e}return s(i,[{key:"getDuration",value:function(){return this._duration*(this._timesForRepeat||1)}},{key:"setDuration",value:function(e){this._duration=e}},{key:"clone",value:function(){return new i}}]),i}(V9),H9=(function(e){h(i,e);var t=v(i);function i(e){var r,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return n(this,i),(r=t.call(this))._speed=0,r._innerAction=null,e&&r.initWithAction(e,s),r}s(i,[{key:"getSpeed",value:function(){return this._speed}},{key:"setSpeed",value:function(e){this._speed=e}},{key:"initWithAction",value:function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(ue(1021),!1)}},{key:"clone",value:function(){var e=new i;return e.initWithAction(this._innerAction.clone(),this._speed),e}},{key:"startWithTarget",value:function(e){V9.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}},{key:"stop",value:function(){this._innerAction.stop(),V9.prototype.stop.call(this)}},{key:"step",value:function(e){this._innerAction.step(e*this._speed)}},{key:"isDone",value:function(){return this._innerAction.isDone()}},{key:"reverse",value:function(){return new i(this._innerAction.reverse(),this._speed)}},{key:"setInnerAction",value:function(e){this._innerAction!==e&&(this._innerAction=e)}},{key:"getInnerAction",value:function(){return this._innerAction}}])}(V9),0),z9=function e(){n(this,e),this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},W9=function(){function e(){n(this,e),this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}return s(e,[{key:"_searchElementByTarget",value:function(e,t){for(var i=0;i<e.length;i++)if(t===e[i].target)return e[i];return null}},{key:"_getElement",value:function(e,t){var i=this._elementPool.pop();return i||(i=new z9),i.target=e,i.paused=!!t,i}},{key:"_putElement",value:function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)}},{key:"addAction",value:function(e,t,i){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_".concat(H9++));var n=this._hashTargets.get(t);n?n.actions||(n.actions=[]):(n=this._getElement(t,i),this._hashTargets.set(t,n),this._arrayTargets.push(n)),n.target=t,n.actions.push(e),e.startWithTarget(t)}else ue(1e3)}},{key:"removeAllActions",value:function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var i=e[t];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=new Map}},{key:"removeAllActionsFromTarget",value:function(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}}},{key:"removeAction",value:function(e){if(null!=e){var t=e.getOriginalTarget(),i=this._hashTargets.get(t);if(i)for(var n=0;n<i.actions.length;n++)if(i.actions[n]===e){i.actions.splice(n,1),i.actionIndex>=n&&i.actionIndex--;break}}}},{key:"_removeActionByTag",value:function(e,t,i){for(var n=0,r=t.actions.length;n<r;++n){var s=t.actions[n];if(s&&s.getTag()===e){if(i&&s.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,t);break}}}},{key:"_removeAllActionsByTag",value:function(e,t,i){for(var n=t.actions.length-1;n>=0;--n){var r=t.actions[n];if(r&&r.getTag()===e){if(i&&r.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,t)}}}},{key:"removeActionByTag",value:function(e,t){var i=this;e===V9.TAG_INVALID&&re(1002);var n=this._hashTargets;if(t){var r=n.get(t);r&&this._removeActionByTag(e,r,t)}else n.forEach((function(t){i._removeActionByTag(e,t)}))}},{key:"removeAllActionsByTag",value:function(e,t){var i=this;e===V9.TAG_INVALID&&re(1002);var n=this._hashTargets;if(t){var r=n.get(t);r&&this._removeAllActionsByTag(e,r,t)}else n.forEach((function(t){i._removeAllActionsByTag(e,t)}))}},{key:"getActionByTag",value:function(e,t){e===V9.TAG_INVALID&&re(1004);var i=this._hashTargets.get(t);if(i){if(null!=i.actions)for(var n=0;n<i.actions.length;++n){var r=i.actions[n];if(r&&r.getTag()===e)return r}re(1005,e)}return null}},{key:"getNumberOfRunningActionsInTarget",value:function(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0}},{key:"pauseTarget",value:function(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)}},{key:"resumeTarget",value:function(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)}},{key:"pauseAllRunningActions",value:function(){for(var e=[],t=this._arrayTargets,i=0;i<t.length;i++){var n=t[i];n&&!n.paused&&(n.paused=!0,e.push(n.target))}return e}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])}},{key:"pauseTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])}},{key:"purgeSharedManager",value:function(){B.director.getScheduler().unscheduleUpdate(this)}},{key:"_removeActionAtIndex",value:function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)}},{key:"_deleteHashElement",value:function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var i=this._arrayTargets,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}this._putElement(e),t=!0}return t}},{key:"update",value:function(e){for(var t,i=this._arrayTargets,n=0;n<i.length;n++){this._currentTarget=i[n];var r=(t=this._currentTarget).target;if(!Ua(r)||r.isValid){if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var s=t.currentAction;t.currentAction=null,this.removeAction(s)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&n--}else this.removeAllActionsFromTarget(r),n--}}}]),e}(),X9=e("TweenSystem",function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).actionMgr=new W9,e}return s(i,[{key:"ActionManager",get:function(){return this.actionMgr}},{key:"update",value:function(e){this.actionMgr.update(e)}}]),i}(Rh));X9.ID="TWEEN",X9.instance=void 0,DN.on(PN.EVENT_INIT,(function(){var e=new X9;X9.instance=e,DN.registerSystem(X9.ID,e,Rh.Priority.MEDIUM)}));var j9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"isDone",value:function(){return!0}},{key:"step",value:function(){this.update(1)}},{key:"update",value:function(){}},{key:"reverse",value:function(){return this.clone()}},{key:"clone",value:function(){return new i}}]),i}(U9),q9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"update",value:function(){for(var e=this.target.getComponentsInChildren(rN),t=0;t<e.length;++t)e[t].enabled=!0}},{key:"reverse",value:function(){return new Y9}},{key:"clone",value:function(){return new i}}]),i}(j9),Y9=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"update",value:function(){for(var e=this.target.getComponentsInChildren(rN),t=0;t<e.length;++t)e[t].enabled=!1}},{key:"reverse",value:function(){return new q9}},{key:"clone",value:function(){return new i}}]),i}(j9);!function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}s(i,[{key:"update",value:function(){for(var e=this.target.getComponentsInChildren(rN),t=0;t<e.length;++t){var i=e[t];i.enabled=!i.enabled}}},{key:"reverse",value:function(){return new i}},{key:"clone",value:function(){return new i}}])}(j9);var K9=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this))._isNeedCleanUp=!0,void 0!==e&&r.init(e),r}return s(i,[{key:"update",value:function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()}},{key:"init",value:function(e){return this._isNeedCleanUp=e,!0}},{key:"reverse",value:function(){return new i(this._isNeedCleanUp)}},{key:"clone",value:function(){return new i(this._isNeedCleanUp)}}]),i}(j9);function Q9(e){return new K9(e)}var J9=function(e){h(i,e);var t=v(i);function i(e,r,s){var a;return n(this,i),(a=t.call(this))._selectorTarget=null,a._function=null,a._data=null,a.initWithFunction(e,r,s),a}return s(i,[{key:"initWithFunction",value:function(e,t,i){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==i&&(this._data=i),!0}},{key:"execute",value:function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)}},{key:"update",value:function(){this.execute()}},{key:"getTargetCallback",value:function(){return this._selectorTarget}},{key:"setTargetCallback",value:function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)}},{key:"clone",value:function(){var e=new i;return e.initWithFunction(this._function,this._selectorTarget,this._data),e}}]),i}(j9),Z9=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this)).MAX_VALUE=2,r._elapsed=0,r._firstTick=!1,r._easeList=[],r._speed=1,r._repeatForever=!1,r._repeatMethod=!1,r._speedMethod=!1,void 0===e||isNaN(e)||r.initWithDuration(e),r}return s(i,[{key:"getElapsed",value:function(){return this._elapsed}},{key:"initWithDuration",value:function(e){return this._duration=0===e?Lt.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0}},{key:"isDone",value:function(){return this._elapsed>=this._duration}},{key:"_cloneDecoration",value:function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod}},{key:"_reverseEaseList",value:function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}}},{key:"clone",value:function(){var e=new i(this._duration);return this._cloneDecoration(e),e}},{key:"easing",value:function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this}},{key:"_computeEaseTime",value:function(e){return e}},{key:"step",value:function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))}},{key:"startWithTarget",value:function(e){V9.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0}},{key:"reverse",value:function(){return re(1010),this}},{key:"setAmplitudeRate",value:function(){re(1011)}},{key:"getAmplitudeRate",value:function(){return re(1012),0}},{key:"speed",value:function(e){return e<=0?(re(1013),this):(this._speedMethod=!0,this._speed*=e,this)}},{key:"getSpeed",value:function(){return this._speed}},{key:"setSpeed",value:function(e){return this._speed=e,this}},{key:"repeat",value:function(e){return e=Math.round(e),isNaN(e)||e<1?(re(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)}},{key:"repeatForever",value:function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this}}]),i}(U9),$9=function(e){h(i,e);var t=v(i);function i(e){var r;n(this,i),(r=t.call(this))._actions=[],r._split=0,r._last=0,r._reversed=!1;var s=e instanceof Array?e:arguments;if(1===s.length)return ue(1019),p(r);var a=s.length-1;if(a>=0&&null==s[a]&&re(1015),a>=0){for(var o,u=s[0],h=1;h<a;h++)s[h]&&(o=u,u=i._actionOneTwo(o,s[h]));r.initWithTwoActions(u,s[a])}return r}return s(i,[{key:"initWithTwoActions",value:function(e,t){if(!e||!t)return ue(1025),!1;var i=e._duration,n=t._duration,r=(i*=e._repeatMethod?e._timesForRepeat:1)+(n*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0}},{key:"clone",value:function(){var e=new i;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e}},{key:"startWithTarget",value:function(e){Z9.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1}},{key:"stop",value:function(){-1!==this._last&&this._actions[this._last].stop(),V9.prototype.stop.call(this)}},{key:"update",value:function(e){var t,i,n=0,r=this._split,s=this._actions,a=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===n&&1===a&&this._reversed&&(s[1].update(0),s[1].stop())):(n=1,t=1===r?1:(e-r)/(1-r),-1===a&&(s[0].startWithTarget(this.target),s[0].update(1),s[0].stop()),0===a&&(s[0].update(1),s[0].stop())),i=s[n],a===n&&i.isDone()||(a!==n&&i.startWithTarget(this.target),t*=i._timesForRepeat,i.update(t>1?t%1:t),this._last=n)}},{key:"reverse",value:function(){var e=i._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e}}]),i}(Z9);function eee(e){var t=e instanceof Array?e:arguments;if(1===t.length)return ue(1019),null;var i=t.length-1;i>=0&&null==t[i]&&re(1015);var n=null;if(i>=0){n=t[0];for(var r=1;r<=i;r++)t[r]&&(n=$9._actionOneTwo(n,t[r]))}return n}$9._actionOneTwo=function(e,t){var i=new $9;return i.initWithTwoActions(e,t),i};var tee=function(e){h(i,e);var t=v(i);function i(e,r){var s;return n(this,i),(s=t.call(this))._times=0,s._total=0,s._nextDt=0,s._actionInstant=!1,s._innerAction=null,void 0!==r&&s.initWithAction(e,r),s}return s(i,[{key:"initWithAction",value:function(e,t){var i=e._duration*t;return!!this.initWithDuration(i)&&(this._times=t,this._innerAction=e,e instanceof j9&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}},{key:"clone",value:function(){var e=new i;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e}},{key:"startWithTarget",value:function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,Z9.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}},{key:"stop",value:function(){this._innerAction.stop(),V9.prototype.stop.call(this)}},{key:"update",value:function(e){e=this._computeEaseTime(e);var t=this._innerAction,i=this._duration,n=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<n;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/i,this._nextDt=r>1?1:r;e>=1&&this._total<n&&(t.update(1),this._total++),this._actionInstant||(this._total===n?t.stop():t.update(e-(r-t._duration/i)))}else t.update(e*n%1)}},{key:"isDone",value:function(){return this._total===this._times}},{key:"reverse",value:function(){var e=new i(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e}},{key:"setInnerAction",value:function(e){this._innerAction!==e&&(this._innerAction=e)}},{key:"getInnerAction",value:function(){return this._innerAction}}]),i}(Z9),iee=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this))._innerAction=null,e&&r.initWithAction(e),r}return s(i,[{key:"initWithAction",value:function(e){return e?(this._innerAction=e,!0):(ue(1026),!1)}},{key:"clone",value:function(){var e=new i;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e}},{key:"startWithTarget",value:function(e){Z9.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}},{key:"step",value:function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))}},{key:"isDone",value:function(){return!1}},{key:"reverse",value:function(){var e=new i(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}},{key:"setInnerAction",value:function(e){this._innerAction!==e&&(this._innerAction=e)}},{key:"getInnerAction",value:function(){return this._innerAction}}]),i}(Z9),nee=function(e){h(i,e);var t=v(i);function i(e){var r;n(this,i),(r=t.call(this))._one=null,r._two=null;var s=e instanceof Array?e:arguments;if(1===s.length)return ue(1020),p(r);var a=s.length-1;if(a>=0&&null==s[a]&&re(1015),a>=0){for(var o,u=s[0],h=1;h<a;h++)s[h]&&(o=u,u=i._actionOneTwo(o,s[h]));r.initWithTwoActions(u,s[a])}return r}return s(i,[{key:"initWithTwoActions",value:function(e,t){if(!e||!t)return ue(1027),!1;var i=!1,n=e._duration,r=t._duration;return this.initWithDuration(Math.max(n,r))&&(this._one=e,this._two=t,n>r?this._two=$9._actionOneTwo(t,aee(n-r)):n<r&&(this._one=$9._actionOneTwo(e,aee(r-n))),i=!0),i}},{key:"clone",value:function(){var e=new i;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e}},{key:"startWithTarget",value:function(e){Z9.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)}},{key:"stop",value:function(){this._one.stop(),this._two.stop(),V9.prototype.stop.call(this)}},{key:"update",value:function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)}},{key:"reverse",value:function(){var e=i._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}}]),i}(Z9);function ree(e){var t=e instanceof Array?e:arguments;if(1===t.length)return ue(1020),null;t.length>0&&null==t[t.length-1]&&re(1015);for(var i=t[0],n=1;n<t.length;n++)null!=t[n]&&(i=nee._actionOneTwo(i,t[n]));return i}nee._actionOneTwo=function(e,t){var i=new nee;return i.initWithTwoActions(e,t),i};var see=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"update",value:function(){}},{key:"reverse",value:function(){var e=new i(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e}},{key:"clone",value:function(){var e=new i;return this._cloneDecoration(e),e.initWithDuration(this._duration),e}}]),i}(Z9);function aee(e){return new see(e)}var oee,uee,hee,lee=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this))._other=null,e&&r.initWithAction(e),r}return s(i,[{key:"initWithAction",value:function(e){return e?e===this._other?(ue(1029),!1):!!Z9.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(ue(1028),!1)}},{key:"clone",value:function(){var e=new i;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e}},{key:"startWithTarget",value:function(e){Z9.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)}},{key:"update",value:function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)}},{key:"reverse",value:function(){return this._other.clone()}},{key:"stop",value:function(){this._other.stop(),V9.prototype.stop.call(this)}}]),i}(Z9),cee=e("TweenAction",function(e){h(r,e);var t=v(r);function r(e,i,s){var a;if(n(this,r),(a=t.call(this))._opts=void 0,a._props=void 0,a._originProps=void 0,null==s)s=Object.create(null);else if(function(e){var t=" [Tween:] ",i=" option is not support in v + ".concat(P),n=e;n.delay&&Q("".concat(t,"delay").concat(i)),n.repeat&&Q("".concat(t,"repeat").concat(i)),n.repeatDelay&&Q("".concat(t,"repeatDelay").concat(i)),n.interpolation&&Q("".concat(t,"interpolation").concat(i)),n.onStop&&Q("".concat(t,"onStop").concat(i))}(s),s.easing&&"string"==typeof s.easing&&(s.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var i=(e=e.replace(t,t.toLowerCase())).split("-");if(2===i.length){var n=i[0];if("linear"===n)e="linear";else{var r=i[1];switch(n){case"quadratic":e="quad".concat(r);break;case"quartic":e="quart".concat(r);break;case"quintic":e="quint".concat(r);break;case"sinusoidal":e="sine".concat(r);break;case"exponential":e="expo".concat(r);break;case"circular":e="circ".concat(r);break;default:e=n+r}}}}return e}(s.easing)),s.progress||(s.progress=a.progress),s.easing&&"string"==typeof s.easing){var o=s.easing;s.easing=zo[o],s.easing||ae(1031,o)}for(var u in a._opts=s,a._props=Object.create(null),i)if(i.hasOwnProperty(u)){var h=i[u];if("function"==typeof h&&(h=h()),null!=h&&"string"!=typeof h){var l=void 0,c=void 0;void 0!==h.value&&(h.easing||h.progress)&&("string"==typeof h.easing?(l=zo[h.easing])||ae(1031,h.easing):l=h.easing,c=h.progress,h=h.value);var _=Object.create(null);_.value=h,_.easing=l,_.progress=c,a._props[u]=_}}return a._originProps=i,a.initWithDuration(e),a}return s(r,[{key:"clone",value:function(){var e=new r(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e}},{key:"startWithTarget",value:function(e){Z9.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,n=this._props;for(var r in n){var s=e[r];if(void 0!==s){var a=n[r],o=a.value;if("number"==typeof s)a.start=s,a.current=s,a.end=t?s+o:o;else if("object"===i(s))for(var u in null==a.start&&(a.start={},a.current={},a.end={}),o)isNaN(s[u])||(a.start[u]=s[u],a.current[u]=s[u],a.end[u]=t?s[u]+o[u]:o[u])}}this._opts.onStart&&this._opts.onStart(this.target)}},{key:"update",value:function(e){var t=this.target;if(t){var n=this._props,r=this._opts,s=e;r.easing&&(s=r.easing(e));var a=r.progress;for(var o in n){var u=n[o],h=u.easing?u.easing(e):s,l=u.progress?u.progress:a,c=u.start,_=u.end;if("number"==typeof c)u.current=l(c,_,u.current,h);else if("object"===i(c))for(var f in c)u.current[f]=l(c[f],_[f],u.current[f],h);t[o]=u.current}r.onUpdate&&r.onUpdate(this.target,e),1===e&&r.onComplete&&r.onComplete(this.target)}}},{key:"progress",value:function(e,t,i,n){return e+(t-e)*n}}]),r}(Z9)),_ee=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this))._props=void 0,r._props={},void 0!==e&&r.init(e),r}return s(i,[{key:"init",value:function(e){for(var t in e)this._props[t]=e[t];return!0}},{key:"update",value:function(){var e=this._props,t=this.target;for(var i in e)t[i]=e[i]}},{key:"clone",value:function(){var e=new i;return e.init(this._props),e}}]),i}(j9),fee=e("Tween",function(){function e(t){n(this,e),this._actions=[],this._finalAction=null,this._target=null,this._tag=V9.TAG_INVALID,this._target=void 0===t?null:t}return s(e,[{key:"tag",value:function(e){return this._tag=e,this}},{key:"then",value:function(e){return e instanceof V9?this._actions.push(e.clone()):this._actions.push(e._union()),this}},{key:"target",value:function(e){return this._target=e,this}},{key:"start",value:function(){return this._target?(this._finalAction&&X9.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),X9.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(Q("Please set target to tween first"),this)}},{key:"stop",value:function(){return this._finalAction&&X9.instance.ActionManager.removeAction(this._finalAction),this}},{key:"clone",value:function(e){var t=this._union();return dee(e).then(t.clone())}},{key:"union",value:function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this}},{key:"to",value:function(e,t,i){(i=i||Object.create(null)).relative=!1;var n=new cee(e,t,i);return this._actions.push(n),this}},{key:"by",value:function(e,t,i){(i=i||Object.create(null)).relative=!0;var n=new cee(e,t,i);return this._actions.push(n),this}},{key:"set",value:function(e){var t=new _ee(e);return this._actions.push(t),this}},{key:"delay",value:function(e){var t=aee(e);return this._actions.push(t),this}},{key:"call",value:function(e){var t=function(e){return new J9(e,void 0,void 0)}(e);return this._actions.push(t),this}},{key:"sequence",value:function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this}},{key:"parallel",value:function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this}},{key:"repeat",value:function(t,i){if(t===1/0)return this.repeatForever(i);var n,r=this._actions;return n=i instanceof e?i._union():r.pop(),r.push(function(e,t){return new tee(e,t)}(n,t)),this}},{key:"repeatForever",value:function(t){var i,n=this._actions;return i=t instanceof e?t._union():n.pop(),n.push(function(e){return new iee(e)}(i)),this}},{key:"reverseTime",value:function(t){var i,n=this._actions;return i=t instanceof e?t._union():n.pop(),n.push(function(e){return new lee(e)}(i)),this}},{key:"hide",value:function(){var e=new Y9;return this._actions.push(e),this}},{key:"show",value:function(){var e=new q9;return this._actions.push(e),this}},{key:"removeSelf",value:function(){var e=Q9(!1);return this._actions.push(e),this}},{key:"destroySelf",value:function(){var e=Q9(!0);return this._actions.push(e),this}},{key:"_union",value:function(){var e=this._actions;return 1===e.length?e[0]:eee(e)}},{key:"_destroy",value:function(){this.stop()}}],[{key:"stopAll",value:function(){X9.instance.ActionManager.removeAllActions()}},{key:"stopAllByTag",value:function(e,t){X9.instance.ActionManager.removeAllActionsByTag(e,t)}},{key:"stopAllByTarget",value:function(e){X9.instance.ActionManager.removeAllActionsFromTarget(e)}},{key:"_wrappedSequence",value:function(){var t=e._tmp_args;t.length=0;for(var i=arguments.length,n=0;n<i;n++){var r=t[n]=n<0||arguments.length<=n?void 0:arguments[n];r instanceof e&&(t[n]=r._union())}return eee.apply(eee,t)}},{key:"_wrappedParallel",value:function(){var t=e._tmp_args;t.length=0;for(var i=arguments.length,n=0;n<i;n++){var r=t[n]=n<0||arguments.length<=n?void 0:arguments[n];r instanceof e&&(t[n]=r._union())}return ree.apply(ree,t)}}]),e}());function dee(e){return new fee(e)}function mee(e){return Q("tweenUtil' is deprecated, please use 'tween' instead "),new fee(e)}fee._tmp_args=[],B.Tween=fee,B.tween=dee,B.tweenUtil=mee,function(e){e[e.Other=0]="Other",e[e.Left=1]="Left",e[e.Right=2]="Right"}(oee||(oee={})),function(e){e.XRUI_HOVER_ENTERED="xrui-hover-entered",e.XRUI_HOVER_EXITED="xrui-hover-exited",e.XRUI_HOVER_STAY="xrui-hover-stay",e.XRUI_CLICK="xrui-click",e.XRUI_UNCLICK="xrui-unclick"}(uee||(uee={})),function(e){e.XR_CAPS_LOCK="xr-caps-lock",e.XR_KEYBOARD_INIT="xr-keyboard-init",e.XR_KEYBOARD_INPUT="xr-keyboard-input",e.TO_LATIN="to-latin",e.TO_SYMBOL="to-symbol",e.TO_MATH_SYMBOL="to-math-symbol"}(hee||(hee={})),function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).deviceType=oee.Other,e.hitPoint=new an,e}}(VC);var pee,vee,yee,gee,See,Aee,Tee,Eee,bee,Cee,Ree,xee,wee,kee,Iee,Bee,Pee,Mee,Oee,Dee,Lee,Nee,Fee,Gee,Vee,Uee,Hee,zee,Wee,Xee,jee,qee=new cn;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(Wee||(Wee={})),Bt(Wee),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(Xee||(Xee={})),function(e){e.CLICK="click"}(jee||(jee={}));var Yee=function(t){return e({Button:t,ButtonComponent:t}),t}((pee=Hs("cc.Button"),vee=Ws(110),yee=zs(nV),gee=Aa(Jp),See=Aa(Wee),Aee=Aa(sF),Tee=Aa(sF),Eee=Aa(sF),bee=Aa(sF),Cee=Aa([Zd]),pee(Ree=vee(Ree=yee((zee=Hee=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).clickEvents=wee&&wee(),e._interactable=kee&&kee(),e._transition=Iee&&Iee(),e._normalColor=Bee&&Bee(),e._hoverColor=Pee&&Pee(),e._pressedColor=Mee&&Mee(),e._disabledColor=Oee&&Oee(),e._normalSprite=Dee&&Dee(),e._hoverSprite=Lee&&Lee(),e._pressedSprite=Nee&&Nee(),e._disabledSprite=Fee&&Fee(),e._duration=Gee&&Gee(),e._zoomScale=Vee&&Vee(),e._target=Uee&&Uee(),e._pressed=!1,e._hovered=!1,e._fromColor=new cn,e._toColor=new cn,e._time=0,e._transitionFinished=!0,e._fromScale=new an,e._toScale=new an,e._originalScale=null,e._sprite=null,e._targetScale=new an,e}return s(i,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable!==e&&(this._interactable=e,this._updateState(),this._interactable||this._resetState())}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===Wee.COLOR?this._updateColorTransition(Xee.NORMAL):this._transition===Wee.SPRITE&&this._updateSpriteTransition(Xee.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(eH);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}},{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(eH);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()}},{key:"onEnable",value:function(){this._registerNodeEvent()}},{key:"onDisable",value:function(){this._resetState(),this._unregisterNodeEvent()}},{key:"onDestroy",value:function(){this.target.isValid&&this._unregisterTargetEvent(this.target)}},{key:"update",value:function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===Wee.COLOR||this._transition===Wee.SCALE)){this._time+=e;var i=1;if(this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1),this._transition===Wee.COLOR){var n=t._uiProps.uiComp;cn.lerp(qee,this._fromColor,this._toColor,i),n&&(n.color=qee)}else this.transition===Wee.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=Fi(this._fromScale.x,this._toScale.x,i),this._targetScale.y=Fi(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale));1===i&&(this._transitionFinished=!0)}}},{key:"_resizeNodeToTargetNode",value:function(){this.target&&this.target._uiProps.uiTransformComp}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===Wee.COLOR&&this._interactable){var i=e.getComponent(LV);i&&(i.color=this._normalColor)}else t===Wee.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}}},{key:"_registerNodeEvent",value:function(){this.node.on(rp.TOUCH_START,this._onTouchBegan,this),this.node.on(rp.TOUCH_MOVE,this._onTouchMove,this),this.node.on(rp.TOUCH_END,this._onTouchEnded,this),this.node.on(rp.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(rp.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(rp.MOUSE_LEAVE,this._onMouseMoveOut,this),this.node.on(uee.XRUI_HOVER_ENTERED,this._xrHoverEnter,this),this.node.on(uee.XRUI_HOVER_EXITED,this._xrHoverExit,this),this.node.on(uee.XRUI_CLICK,this._xrClick,this),this.node.on(uee.XRUI_UNCLICK,this._xrUnClick,this)}},{key:"_registerTargetEvent",value:function(e){e.on(rp.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off(rp.TOUCH_START,this._onTouchBegan,this),this.node.off(rp.TOUCH_MOVE,this._onTouchMove,this),this.node.off(rp.TOUCH_END,this._onTouchEnded,this),this.node.off(rp.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(rp.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(rp.MOUSE_LEAVE,this._onMouseMoveOut,this),this.node.off(uee.XRUI_HOVER_ENTERED,this._xrHoverEnter,this),this.node.off(uee.XRUI_HOVER_EXITED,this._xrHoverExit,this),this.node.off(uee.XRUI_CLICK,this._xrClick,this),this.node.off(uee.XRUI_UNCLICK,this._xrUnClick,this)}},{key:"_unregisterTargetEvent",value:function(e){e.off(rp.TRANSFORM_CHANGED)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(eH)),t}},{key:"_applyTarget",value:function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new an),an.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))}},{key:"_onTargetSpriteFrameChanged",value:function(e){this._transition===Wee.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)}},{key:"_setCurrentStateSpriteFrame",value:function(e){if(e)switch(this._getButtonState()){case Xee.NORMAL:this._normalSprite=e;break;case Xee.HOVER:this._hoverSprite=e;break;case Xee.PRESSED:this._pressedSprite=e;break;case Xee.DISABLED:this._disabledSprite=e}}},{key:"_onTargetColorChanged",value:function(e){this._transition===Wee.COLOR&&this._setCurrentStateColor(e)}},{key:"_setCurrentStateColor",value:function(e){switch(this._getButtonState()){case Xee.NORMAL:this._normalColor=e;break;case Xee.HOVER:this._hoverColor=e;break;case Xee.PRESSED:this._pressedColor=e;break;case Xee.DISABLED:this._disabledColor=e}}},{key:"_onTargetTransformChanged",value:function(e){e&ip.SCALE&&this._originalScale&&this._transition===Wee.SCALE&&this._transitionFinished&&an.copy(this._originalScale,this.target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var i,n=this.node._uiProps.uiTransformComp.hitTest(t.getLocation());this._transition===Wee.SCALE&&this.target&&this._originalScale?n?(an.copy(this._fromScale,this._originalScale),an.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(i=n?Xee.PRESSED:Xee.NORMAL,this._applyTransition(i)),e&&(e.propagationStopped=!0)}}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(Zd.emitEvents(this.clickEvents,e),this.node.emit(jee.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==Wee.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=Xee.NORMAL;return this._interactable?this._pressed?e=Xee.PRESSED:this._hovered&&(e=Xee.HOVER):e=Xee.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t,i=this["".concat(e,"Color")],n=null===(t=this.target)||void 0===t?void 0:t.getComponent(LV);n&&(e===Xee.DISABLED?n.color=i:(this._fromColor=n.color.clone(),this._toColor=i,this._time=0,this._transitionFinished=!1))}},{key:"_updateSpriteTransition",value:function(e){var t=this["".concat(e,"Sprite")];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===Xee.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){this._originalScale&&(an.copy(this._fromScale,this._originalScale),an.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}},{key:"_zoomBack",value:function(){this.target&&this._originalScale&&(an.copy(this._fromScale,this.target.getScale()),an.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===Wee.COLOR?this._updateColorTransition(e):t===Wee.SPRITE?this._updateSpriteTransition(e):t===Wee.SCALE&&this._updateScaleTransition(e)}},{key:"_xrHoverEnter",value:function(){this._onMouseMoveIn(),this._updateState()}},{key:"_xrHoverExit",value:function(){this._onMouseMoveOut(),this._pressed&&(this._pressed=!1,this._updateState())}},{key:"_xrClick",value:function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState())}},{key:"_xrUnClick",value:function(){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(Zd.emitEvents(this.clickEvents,this),this.node.emit(jee.CLICK,this)),this._pressed=!1,this._updateState())}}]),i}(tm),Hee.Transition=Wee,Hee.EventType=jee,x((xee=zee).prototype,"target",[gee],Object.getOwnPropertyDescriptor(xee.prototype,"target"),xee.prototype),x(xee.prototype,"transition",[See],Object.getOwnPropertyDescriptor(xee.prototype,"transition"),xee.prototype),x(xee.prototype,"normalSprite",[Aee],Object.getOwnPropertyDescriptor(xee.prototype,"normalSprite"),xee.prototype),x(xee.prototype,"pressedSprite",[Tee],Object.getOwnPropertyDescriptor(xee.prototype,"pressedSprite"),xee.prototype),x(xee.prototype,"hoverSprite",[Eee],Object.getOwnPropertyDescriptor(xee.prototype,"hoverSprite"),xee.prototype),x(xee.prototype,"disabledSprite",[bee],Object.getOwnPropertyDescriptor(xee.prototype,"disabledSprite"),xee.prototype),wee=Ms(xee.prototype,"clickEvents",[Cee,Js],(function(){return[]})),kee=Ms(xee.prototype,"_interactable",[Js],(function(){return!0})),Iee=Ms(xee.prototype,"_transition",[Js],(function(){return Wee.NONE})),Bee=Ms(xee.prototype,"_normalColor",[Js],(function(){return cn.WHITE.clone()})),Pee=Ms(xee.prototype,"_hoverColor",[Js],(function(){return new cn(211,211,211,255)})),Mee=Ms(xee.prototype,"_pressedColor",[Js],(function(){return cn.WHITE.clone()})),Oee=Ms(xee.prototype,"_disabledColor",[Js],(function(){return new cn(124,124,124,255)})),Dee=Ms(xee.prototype,"_normalSprite",[Js],(function(){return null})),Lee=Ms(xee.prototype,"_hoverSprite",[Js],(function(){return null})),Nee=Ms(xee.prototype,"_pressedSprite",[Js],(function(){return null})),Fee=Ms(xee.prototype,"_disabledSprite",[Js],(function(){return null})),Gee=Ms(xee.prototype,"_duration",[Js],(function(){return.1})),Vee=Ms(xee.prototype,"_zoomScale",[Js],(function(){return 1.2})),Uee=Ms(xee.prototype,"_target",[Js],(function(){return null})),Ree=xee))||Ree)||Ree)||Ree));B.Button=Yee;var Kee,Qee,Jee,Zee=function(){function e(){n(this,e)}return s(e,null,[{key:"add",value:function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)}},{key:"remove",value:function(e){var t=this._tabIndexList,i=t.indexOf(e);-1!==i&&t.splice(i,1)}},{key:"resort",value:function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))}},{key:"next",value:function(e){var t=this._tabIndexList,i=t.indexOf(e);if(e.setFocus(!1),-1!==i){var n=t[i+1];n&&n._delegate.tabIndex>=0&&n.setFocus(!0)}}}]),e}();Zee._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(Kee||(Kee={})),wt(Kee),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(Qee||(Qee={})),wt(Qee),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(Jee||(Jee={})),wt(Jee);var $ee,ete,tte,ite,nte,rte,ste,ate,ote,ute,hte,lte,cte,_te,fte,dte,mte,pte,vte,yte,gte,Ste,Ate,Tte,Ete,bte,Cte,Rte,xte,wte,kte,Ite=function(){function e(){n(this,e),this._editing=!1,this._delegate=null}return s(e,[{key:"init",value:function(){}},{key:"onEnable",value:function(){}},{key:"update",value:function(){}},{key:"onDisable",value:function(){this._editing&&this.endEditing()}},{key:"clear",value:function(){this._delegate=null}},{key:"setTabIndex",value:function(){}},{key:"setSize",value:function(){}},{key:"setFocus",value:function(e){e?this.beginEditing():this.endEditing()}},{key:"isFocused",value:function(){return this._editing}},{key:"beginEditing",value:function(){}},{key:"endEditing",value:function(){}}]),e}(),Bte=M.document,Pte=new Cn,Mte=new Cn,Ote=new an,Dte=null,Lte=0,Nte=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._delegate=null,e._inputMode=-1,e._inputFlag=-1,e._returnType=-1,e.__eventListeners={},e.__autoResize=!1,e.__orientationChanged=void 0,e._edTxt=null,e._isTextArea=!1,e._textLabelFont=null,e._textLabelFontSize=null,e._textLabelFontColor=null,e._textLabelAlign=null,e._placeholderLabelFont=null,e._placeholderLabelFontSize=null,e._placeholderLabelFontColor=null,e._placeholderLabelAlign=null,e._placeholderLineHeight=null,e._placeholderStyleSheet=null,e._domId="EditBoxId_".concat(++Lte),e}return s(i,[{key:"init",value:function(e){e&&(this._delegate=e,e.inputMode===Qee.ANY?this._createTextArea():this._createInput(),Zee.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())}},{key:"clear",value:function(){this._removeEventListeners(),this._removeDomFromGameContainer(),Zee.remove(this),Dte===this&&(Dte=null),this._delegate=null}},{key:"update",value:function(){this._updateMatrix()}},{key:"setTabIndex",value:function(e){this._edTxt.tabIndex=e,Zee.resort()}},{key:"setSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width="".concat(e,"px"),i.style.height="".concat(t,"px"))}},{key:"beginEditing",value:function(){Dte&&Dte!==this&&Dte.setFocus(!1),this._editing=!0,Dte=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()}},{key:"endEditing",value:function(){this._edTxt.blur()}},{key:"_createInput",value:function(){this._isTextArea=!1,this._edTxt=Bte.createElement("input")}},{key:"_createTextArea",value:function(){this._isTextArea=!0,this._edTxt=Bte.createElement("textarea")}},{key:"_addDomToGameContainer",value:function(){UN.container&&this._edTxt&&(UN.container.appendChild(this._edTxt),Bte.head.appendChild(this._placeholderStyleSheet))}},{key:"_removeDomFromGameContainer",value:function(){Wt(UN.container,this._edTxt)&&this._edTxt&&UN.container.removeChild(this._edTxt),Wt(Bte.head,this._placeholderStyleSheet)&&Bte.head.removeChild(this._placeholderStyleSheet),this._edTxt=null,this._placeholderStyleSheet=null}},{key:"_showDom",value:function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),Sl.isMobile&&this._showDomOnMobile()}},{key:"_hideDom",value:function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),Sl.isMobile&&this._hideDomOnMobile()}},{key:"_showDomOnMobile",value:function(){Sl.os!==jh.ANDROID&&Sl.os!==jh.OHOS||(vl.handleResizeEvent=!1,this._adjustWindowScroll())}},{key:"_hideDomOnMobile",value:function(){Sl.os!==jh.ANDROID&&Sl.os!==jh.OHOS||(vl.handleResizeEvent=!0),this._scrollBackWindow()}},{key:"_adjustWindowScroll",value:function(){var e=this;setTimeout((function(){M.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)}},{key:"_scrollBackWindow",value:function(){setTimeout((function(){Sl.browserType!==zh.WECHAT||Sl.os!==jh.IOS?M.scrollTo(0,0):M.top&&M.top.scrollTo(0,0)}),400)}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._delegate.node,t=lz.getScaleX(),i=lz.getScaleY(),n=lz.getViewportRect(),r=vl.devicePixelRatio;e.getWorldMatrix(Pte);var s=e._uiProps.uiTransformComp;if(s&&an.set(Ote,-s.anchorX*s.width,-s.anchorY*s.height,Ote.z),Cn.transform(Pte,Pte,Ote),e._uiProps.uiTransformComp){var a=DN.root.batcher2D.getFirstRenderCamera(e);if(a){a.node.getWorldRT(Mte);var o=Mte.m12,u=Mte.m13,h=Al.center;Mte.m12=h.x-(Mte.m00*o+Mte.m04*u),Mte.m13=h.y-(Mte.m01*o+Mte.m05*u),Cn.multiply(Mte,Mte,Pte),t/=r,i/=r;var l=UN.container,c=Mte.m00*t,_=Pte.m01,f=Pte.m04,d=Mte.m05*i,m=parseInt(l&&l.style.paddingLeft||"0");m+=n.x/r;var p=parseInt(l&&l.style.paddingBottom||"0");p+=n.y/r;var v=Mte.m12*t+m,y=Mte.m13*i+p,g="matrix(".concat(c,",").concat(-_,",").concat(-f,",").concat(d,",").concat(v,",").concat(-y,")");this._edTxt.style.transform=g,this._edTxt.style["-webkit-transform"]=g,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}}},{key:"_updateInputType",value:function(){var e=this._delegate,t=e.inputMode,i=e.inputFlag,n=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==i||this._returnType!==n){if(this._inputMode=t,this._inputFlag=i,this._returnType=n,this._isTextArea){var s="none";return i===Jee.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":i===Jee.INITIAL_CAPS_WORD&&(s="capitalize"),void(r.style.textTransform=s)}if(r=r,i===Jee.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;t===Qee.EMAIL_ADDR?a="email":t===Qee.NUMERIC||t===Qee.DECIMAL?a="number":t===Qee.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===Qee.URL?a="url":(a="text",n===Kee.SEARCH&&(a="search")),r.type=a;var o="none";i===Jee.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":i===Jee.INITIAL_CAPS_WORD&&(o="capitalize"),r.style.textTransform=o}}},{key:"_updateMaxLength",value:function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e}},{key:"_initStyleSheet",value:function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="".concat(2,"px"),e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=Bte.createElement("style")}}},{key:"_updateStyleSheet",value:function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,this._updateTextLabel(e.textLabel))}},{key:"_updateTextLabel",value:function(e){if(e){var t=e.font;t=!t||t instanceof bF?e.fontFamily:t._fontFamily;var i=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==i||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=i,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var n=this._edTxt;switch(n.style.fontSize="".concat(i,"px"),n.style.color=e.color.toCSS(),n.style.fontFamily=t,e.horizontalAlign){case VV.HorizontalAlign.LEFT:n.style.textAlign="left";break;case VV.HorizontalAlign.CENTER:n.style.textAlign="center";break;case VV.HorizontalAlign.RIGHT:n.style.textAlign="right"}}}}},{key:"_updatePlaceholderLabel",value:function(e){if(e){var t=e.font;t=!t||t instanceof bF?e.fontFamily:e.font._fontFamily;var i=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==i||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=i,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var n=this._placeholderStyleSheet,r=e.color.toCSS(),s=e.fontSize,a="";switch(e.horizontalAlign){case VV.HorizontalAlign.LEFT:a="left";break;case VV.HorizontalAlign.CENTER:a="center";break;case VV.HorizontalAlign.RIGHT:a="right"}n.innerHTML="#".concat(this._domId,"::-webkit-input-placeholder{text-transform: initial;-family: ").concat(t,";font-size: ").concat(i,"px;color: ").concat(r,";line-height: ").concat(s,"px;text-align: ").concat(a,";}")+"#".concat(this._domId,"::-moz-placeholder{text-transform: initial;-family: ").concat(t,";font-size: ").concat(i,"px;color: ").concat(r,";line-height: ").concat(s,"px;text-align: ").concat(a,";}")+"#".concat(this._domId,"::-ms-input-placeholder{text-transform: initial;-family: ").concat(t,";font-size: ").concat(i,"px;color: ").concat(r,";line-height: ").concat(s,"px;text-align: ").concat(a,";}"),Sl.browserType===zh.EDGE&&(n.innerHTML+="#".concat(this._domId,"::-ms-clear{display: none;}"))}}}},{key:"_registerEventListeners",value:function(){var e=this;if(this._edTxt){var t=this._edTxt,i=!1,n=this.__eventListeners;n.compositionStart=function(){i=!0},n.compositionEnd=function(){i=!1,e._delegate._editBoxTextChanged(t.value)},n.onInput=function(){if(!i){var n=e._delegate,r=n.maxLength;r>=0&&(t.value=t.value.slice(0,r)),n._editBoxTextChanged(t.value)}},n.onClick=function(){e._editing&&Sl.isMobile&&e._adjustWindowScroll()},n.onKeydown=function(i){i.keyCode===jC.ENTER?(i.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):i.keyCode===jC.TAB&&(i.propagationStopped=!0,i.preventDefault(),Zee.next(e))},n.onBlur=function(){Sl.isMobile&&i&&n.compositionEnd(),e._editing=!1,Dte=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",n.compositionStart),t.addEventListener("compositionend",n.compositionEnd),t.addEventListener("input",n.onInput),t.addEventListener("keydown",n.onKeydown),t.addEventListener("blur",n.onBlur),t.addEventListener("touchstart",n.onClick)}}},{key:"_removeEventListeners",value:function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}}}]),i}(Ite);function Fte(e){return e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()}))}function Gte(e){return e.charAt(0).toUpperCase()+e.slice(1)}!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return",e.XR_EDITING_DID_BEGAN="xr-editing-did-began",e.XR_EDITING_DID_ENDED="xr-editing-did-ended"}(kte||(kte={}));var Vte,Ute,Hte,zte,Wte,Xte,jte,qte,Yte,Kte,Qte,Jte,Zte,$te,eie,tie,iie,nie,rie,sie,aie,oie,uie,hie,lie,cie,_ie,fie,die,mie,pie,vie,yie,gie,Sie,Aie=function(t){return e({EditBox:t,EditBoxComponent:t}),t}(($ee=Hs("cc.EditBox"),ete=Ws(110),tte=zs(nV),ite=Aa(VV),nte=Aa(VV),rte=Aa(sF),ste=Aa(Jee),ate=Aa(Qee),ote=Aa(Kee),ute=Aa([Zd]),hte=Aa([Zd]),lte=Aa([Zd]),cte=Aa([Zd]),$ee(_te=ete(_te=tte((wte=xte=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).editingDidBegan=dte&&dte(),e.textChanged=mte&&mte(),e.editingDidEnded=pte&&pte(),e.editingReturn=vte&&vte(),e._impl=null,e._background=null,e._textLabel=yte&&yte(),e._placeholderLabel=gte&&gte(),e._returnType=Ste&&Ste(),e._string=Ate&&Ate(),e._tabIndex=Tte&&Tte(),e._backgroundImage=Ete&&Ete(),e._inputFlag=bte&&bte(),e._inputMode=Cte&&Cte(),e._maxLength=Rte&&Rte(),e._isLabelVisible=!1,e}return s(i,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string!==e&&(this._string=e,this._updateString(e))}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag!==e&&(this._inputFlag=e,this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}},{key:"__preload",value:function(){this._init()}},{key:"onEnable",value:function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"onDisable",value:function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"focus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"blur",value:function(){this._impl&&this._impl.setFocus(!1)}},{key:"isFocused",value:function(){return!!this._impl&&this._impl.isFocused()}},{key:"_editBoxEditingDidBegan",value:function(){Zd.emitEvents(this.editingDidBegan,this),this.node.emit(kte.EDITING_DID_BEGAN,this)}},{key:"_editBoxEditingDidEnded",value:function(e){Zd.emitEvents(this.editingDidEnded,this),this.node.emit(kte.EDITING_DID_ENDED,this,e)}},{key:"_editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,Zd.emitEvents(this.textChanged,e,this),this.node.emit(kte.TEXT_CHANGED,this)}},{key:"_editBoxEditingReturn",value:function(e){Zd.emitEvents(this.editingReturn,this),this.node.emit(kte.EDITING_RETURN,this,e)}},{key:"_showLabels",value:function(){this._isLabelVisible=!0,this._updateLabels()}},{key:"_hideLabels",value:function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_onTouchBegan",value:function(e){e.propagationStopped=!0}},{key:"_onTouchCancel",value:function(e){e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0}},{key:"_init",value:function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(rp.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new i._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}},{key:"_ensureBackgroundSprite",value:function(){if(!this._background){var e=this.node.getComponent(eH);e||(e=this.node.addComponent(eH)),e!==this._background&&(e.type=eH.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}}},{key:"_updateTextLabel",value:function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||((t=new Jp("TEXT_LABEL")).layer=this.node.layer),(e=t.getComponent(VV))||(e=t.addComponent(VV)),t.parent=this.node,this._textLabel=e}this._inputMode===Qee.ANY?(e.verticalAlign=MV.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)}},{key:"_updatePlaceholderLabel",value:function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||((t=new Jp("PLACEHOLDER_LABEL")).layer=this.node.layer),(e=t.getComponent(VV))||(e=t.addComponent(VV)),t.parent=this.node,this._placeholderLabel=e}this._inputMode===Qee.ANY?e.enableWrapText=!0:e.enableWrapText=!1,e.string=this.placeholder}},{key:"_syncSize",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var i=this._background.node._uiProps.uiTransformComp;i.anchorPoint=e.anchorPoint,i.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)}},{key:"_updateLabels",value:function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i&&(i=this._updateLabelStringStyle(i)),t.string=i,this._updateLabels()}}},{key:"_updateLabelStringStyle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this._inputFlag;if(t||i!==Jee.PASSWORD)i===Jee.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===Jee.INITIAL_CAPS_WORD?e=Fte(e):i===Jee.INITIAL_CAPS_SENTENCE&&(e=Gte(e));else{for(var n="",r=e.length,s=0;s<r;++s)n+="●";e=n}return e}},{key:"_registerEvent",value:function(){this.node.on(rp.TOUCH_START,this._onTouchBegan,this),this.node.on(rp.TOUCH_END,this._onTouchEnded,this),this.node.on(uee.XRUI_UNCLICK,this._xrUnClick,this),this.node.on(hee.XR_KEYBOARD_INPUT,this._xrKeyBoardInput,this)}},{key:"_unregisterEvent",value:function(){this.node.off(rp.TOUCH_START,this._onTouchBegan,this),this.node.off(rp.TOUCH_END,this._onTouchEnded,this),this.node.off(uee.XRUI_UNCLICK,this._xrUnClick,this),this.node.off(hee.XR_KEYBOARD_INPUT,this._xrKeyBoardInput,this)}},{key:"_onBackgroundSpriteFrameChanged",value:function(){this._background&&(this.backgroundImage=this._background.spriteFrame)}},{key:"_registerBackgroundEvent",value:function(){var e=this._background&&this._background.node;null==e||e.on(eH.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)}},{key:"_unregisterBackgroundEvent",value:function(){var e=this._background&&this._background.node;null==e||e.off(eH.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)}},{key:"_updateLabelPosition",value:function(e){var t=this.node._uiProps.uiTransformComp,i=-t.anchorX*t.width,n=-t.anchorY*t.height,r=this._placeholderLabel,s=this._textLabel;s&&(s.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),s.node.setPosition(i+2,n+e.height,s.node.position.z),this._inputMode===Qee.ANY&&(s.verticalAlign=MV.TOP),s.enableWrapText=this._inputMode===Qee.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(i+2,n+e.height,r.node.position.z),r.enableWrapText=this._inputMode===Qee.ANY)}},{key:"_resizeChildNodes",value:function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._placeholderLabel&&this._placeholderLabel.node;i&&(i.setPosition(-e.width/2,e.height/2,i.position.z),i._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._background&&this._background.node;n&&n._uiProps.uiTransformComp.setContentSize(e.contentSize),this._syncSize()}},{key:"_xrUnClick",value:function(){this.node.emit(kte.XR_EDITING_DID_BEGAN,this._maxLength,this.string)}},{key:"_xrKeyBoardInput",value:function(e){this.string=e}}]),i}(tm),xte._EditBoxImpl=Ite,xte.KeyboardReturnType=Kee,xte.InputFlag=Jee,xte.InputMode=Qee,xte.EventType=kte,x((fte=wte).prototype,"textLabel",[ite],Object.getOwnPropertyDescriptor(fte.prototype,"textLabel"),fte.prototype),x(fte.prototype,"placeholderLabel",[nte],Object.getOwnPropertyDescriptor(fte.prototype,"placeholderLabel"),fte.prototype),x(fte.prototype,"backgroundImage",[rte],Object.getOwnPropertyDescriptor(fte.prototype,"backgroundImage"),fte.prototype),x(fte.prototype,"inputFlag",[ste],Object.getOwnPropertyDescriptor(fte.prototype,"inputFlag"),fte.prototype),x(fte.prototype,"inputMode",[ate],Object.getOwnPropertyDescriptor(fte.prototype,"inputMode"),fte.prototype),x(fte.prototype,"returnType",[ote],Object.getOwnPropertyDescriptor(fte.prototype,"returnType"),fte.prototype),dte=Ms(fte.prototype,"editingDidBegan",[ute,Js],(function(){return[]})),mte=Ms(fte.prototype,"textChanged",[hte,Js],(function(){return[]})),pte=Ms(fte.prototype,"editingDidEnded",[lte,Js],(function(){return[]})),vte=Ms(fte.prototype,"editingReturn",[cte,Js],(function(){return[]})),yte=Ms(fte.prototype,"_textLabel",[Js],(function(){return null})),gte=Ms(fte.prototype,"_placeholderLabel",[Js],(function(){return null})),Ste=Ms(fte.prototype,"_returnType",[Js],(function(){return Kee.DEFAULT})),Ate=Ms(fte.prototype,"_string",[Js],(function(){return""})),Tte=Ms(fte.prototype,"_tabIndex",[Js],(function(){return 0})),Ete=Ms(fte.prototype,"_backgroundImage",[Js],(function(){return null})),bte=Ms(fte.prototype,"_inputFlag",[Js],(function(){return Jee.DEFAULT})),Cte=Ms(fte.prototype,"_inputMode",[Js],(function(){return Qee.ANY})),Rte=Ms(fte.prototype,"_maxLength",[Js],(function(){return 20})),_te=fte))||_te)||_te)||_te));"object"===("undefined"==typeof window?"undefined":i(window))&&"object"===("undefined"==typeof document?"undefined":i(document))&&(Aie._EditBoxImpl=Nte),B.internal.EditBox=Aie,function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(mie||(mie={})),Bt(mie),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(pie||(pie={})),Bt(pie),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(vie||(vie={})),Bt(vie),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(yie||(yie={})),Bt(yie),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(gie||(gie={})),Bt(gie),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(Sie||(Sie={})),Bt(Sie);var Tie,Eie,bie,Cie,Rie,xie,wie,kie,Iie,Bie,Pie,Mie,Oie,Die,Lie,Nie=new an,Fie=function(t){return e({Layout:t,LayoutComponent:t}),t}((Vte=Hs("cc.Layout"),Ute=Ws(110),Hte=zs(nV),zte=Aa(mie),Wte=Aa(pie),Xte=Aa(vie),jte=Aa(yie),qte=Aa(gie),Yte=Aa(Sie),Vte(Kte=Ute(Kte=Hte((die=fie=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._resizeMode=Jte&&Jte(),e._layoutType=Zte&&Zte(),e._cellSize=$te&&$te(),e._startAxis=eie&&eie(),e._paddingLeft=tie&&tie(),e._paddingRight=iie&&iie(),e._paddingTop=nie&&nie(),e._paddingBottom=rie&&rie(),e._spacingX=sie&&sie(),e._spacingY=aie&&aie(),e._verticalDirection=oie&&oie(),e._horizontalDirection=uie&&uie(),e._constraint=hie&&hie(),e._constraintNum=lie&&lie(),e._affectedByScale=cie&&cie(),e._isAlign=_ie&&_ie(),e._layoutSize=new Mn(300,200),e._layoutDirty=!0,e._childrenDirty=!1,e._usefulLayoutObj=[],e._init=!1,e}return s(i,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===mie.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===mie.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==mie.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==mie.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==Sie.NONE&&this._constraintNum!==e&&(e<=0&&Q("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}},{key:"updateLayout",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];(this._layoutDirty||e)&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(Mn.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()}},{key:"onDisable",value:function(){this._usefulLayoutObj.length=0,this._removeEventListeners()}},{key:"_checkUsefulObj",value:function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var i=e[t],n=i._uiProps.uiTransformComp;i.activeInHierarchy&&n&&this._usefulLayoutObj.push(n)}}},{key:"_addEventListeners",value:function(){DN.on(PN.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(rp.SIZE_CHANGED,this._resized,this),this.node.on(rp.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(rp.CHILD_ADDED,this._childAdded,this),this.node.on(rp.CHILD_REMOVED,this._childRemoved,this),this.node.on(rp.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){DN.off(PN.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(rp.SIZE_CHANGED,this._resized,this),this.node.off(rp.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(rp.CHILD_ADDED,this._childAdded,this),this.node.off(rp.CHILD_REMOVED,this._childRemoved,this),this.node.off(rp.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){for(var e=this.node.children,t=0;t<e.length;++t){var i=e[t];i.on(rp.SIZE_CHANGED,this._doLayoutDirty,this),i.on(rp.TRANSFORM_CHANGED,this._transformDirty,this),i.on(rp.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on(rp.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}}},{key:"_removeChildrenEventListeners",value:function(){for(var e=this.node.children,t=0;t<e.length;++t){var i=e[t];i.off(rp.SIZE_CHANGED,this._doLayoutDirty,this),i.off(rp.TRANSFORM_CHANGED,this._transformDirty,this),i.off(rp.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off(rp.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}}},{key:"_childAdded",value:function(e){e.on(rp.SIZE_CHANGED,this._doLayoutDirty,this),e.on(rp.TRANSFORM_CHANGED,this._transformDirty,this),e.on(rp.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(rp.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()}},{key:"_childRemoved",value:function(e){e.off(rp.SIZE_CHANGED,this._doLayoutDirty,this),e.off(rp.TRANSFORM_CHANGED,this._transformDirty,this),e.off(rp.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(rp.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()}},{key:"_resized",value:function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,n){var r=this.node._uiProps.uiTransformComp.anchorPoint,s=this._getFixedBreakingNum(),a=1,o=this._paddingLeft;this._horizontalDirection===gie.RIGHT_TO_LEFT&&(a=-1,o=this._paddingRight);var u=(this._horizontalDirection-r.x)*e+a*o,h=u-a*this._spacingX,l=0,c=0,_=0,f=0,d=!1,m=this._usefulLayoutObj.length,p=this._cellSize.width,v=this._getPaddingH();this._layoutType!==mie.GRID&&this._resizeMode===pie.CHILDREN&&(p=(e-v-(m-1)*this._spacingX)/m);for(var y=this._usefulLayoutObj,g=0;g<y.length;++g){var S=y[g],A=S.node,T=A.scale,E=this._getUsedScaleValue(T.x),b=this._getUsedScaleValue(T.y);this._resizeMode===pie.CHILDREN&&(S.width=p/E,this._layoutType===mie.GRID&&(S.height=this._cellSize.height/b));var C=Math.abs(this._horizontalDirection-S.anchorX),R=S.width*E,x=S.height*b;x>_&&(f=Math.max(_,f),c=_||x,_=x),h+=a*(C*R+this._spacingX);var w=a*(1-C)*R;if(t){if(s>0)(d=g/s>0&&g%s==0)&&(c=_>x?_:c);else if(R>e-v)h>u+a*C*R&&(d=!0);else{var k=(1-this._horizontalDirection-r.x)*e,I=h+w+a*(a>0?this._paddingRight:this._paddingLeft);d=Math.abs(I)>Math.abs(k)}d&&(h=u+a*C*R,x!==_&&(c=_),l+=c+this._spacingY,c=_=x)}var B=i(A,S,l);n&&A.setPosition(h,B),h+=w}return c=Math.max(c,_),Math.max(f,l+c)+this._getPaddingV()}},{key:"_doLayoutVertically",value:function(e,t,i,n){var r=this.node._uiProps.uiTransformComp.anchorPoint,s=this._getFixedBreakingNum(),a=1,o=this._paddingBottom;this._verticalDirection===yie.TOP_TO_BOTTOM&&(a=-1,o=this._paddingTop);var u=(this._verticalDirection-r.y)*e+a*o,h=u-a*this._spacingY,l=0,c=0,_=0,f=0,d=!1,m=this._usefulLayoutObj.length,p=this._cellSize.height,v=this._getPaddingV();this._layoutType!==mie.GRID&&this._resizeMode===pie.CHILDREN&&(p=(e-v-(m-1)*this._spacingY)/m);for(var y=this._usefulLayoutObj,g=0;g<y.length;++g){var S=y[g],A=S.node,T=A.scale,E=this._getUsedScaleValue(T.x),b=this._getUsedScaleValue(T.y);this._resizeMode===pie.CHILDREN&&(S.height=p/b,this._layoutType===mie.GRID&&(S.width=this._cellSize.width/E));var C=Math.abs(this._verticalDirection-S.anchorY),R=S.width*E,x=S.height*b;R>l&&(c=Math.max(l,c),_=l||R,l=R),h+=a*(C*x+this._spacingY);var w=a*(1-C)*x;if(t){if(s>0)(d=g/s>0&&g%s==0)&&(_=l>x?l:_);else if(x>e-v)h>u+a*C*x&&(d=!0);else{var k=(1-this._verticalDirection-r.y)*e,I=h+w+a*(a>0?this._paddingTop:this._paddingBottom);d=Math.abs(I)>Math.abs(k)}d&&(h=u+a*C*x,R!==l&&(_=l),f+=_+this._spacingX,_=l=R)}var B=i(A,S,f);n&&(A.getPosition(Nie),A.setPosition(B,h,Nie.z)),h+=w}return _=Math.max(_,l),Math.max(c,f+_)+this._getPaddingH()}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var i=this,n=t.width,r=1,s=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===yie.TOP_TO_BOTTOM&&(r=-1,s=(1-e.y)*t.height,a=this._paddingTop);var o=function(e,t,n){return s+r*(n+(1-t.anchorY)*t.height*i._getUsedScaleValue(e.scale.y)+a)},u=0;this._resizeMode===pie.CONTAINER&&(u=this._doLayoutHorizontally(n,!0,o,!1),s=-e.y*u,this._verticalDirection===yie.TOP_TO_BOTTOM&&(r=-1,s=(1-e.y)*u)),this._doLayoutHorizontally(n,!0,o,!0),this._resizeMode===pie.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(n,u)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var i=this,n=t.height,r=1,s=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===gie.RIGHT_TO_LEFT&&(r=-1,s=(1-e.x)*t.width,a=this._paddingRight);var o=function(e,t,n){return s+r*(n+(1-t.anchorX)*t.width*i._getUsedScaleValue(e.scale.x)+a)},u=0;this._resizeMode===pie.CONTAINER&&(u=this._doLayoutVertically(n,!0,o,!1),s=-e.x*u,this._horizontalDirection===gie.RIGHT_TO_LEFT&&(r=-1,s=(1-e.x)*u)),this._doLayoutVertically(n,!0,o,!0),this._resizeMode===pie.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(u,n)}},{key:"_doLayoutGrid",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,i=e.contentSize;this.startAxis===vie.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,i):this.startAxis===vie.VERTICAL&&this._doLayoutGridAxisVertical(t,i)}},{key:"_getHorizontalBaseWidth",value:function(){var e=this._usefulLayoutObj,t=0,i=e.length;if(this._resizeMode===pie.CONTAINER){for(var n=0;n<e.length;++n){var r=e[n],s=r.node.scale;t+=r.width*this._getUsedScaleValue(s.x)}t+=(i-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t}},{key:"_getVerticalBaseHeight",value:function(){var e=this._usefulLayoutObj,t=0,i=e.length;if(this._resizeMode===pie.CONTAINER){for(var n=0;n<e.length;++n){var r=e[n],s=r.node.scale;t+=r.height*this._getUsedScaleValue(s.y)}t+=(i-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t}},{key:"_doLayout",value:function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===mie.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?an.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===mie.VERTICAL){var i=this._getVerticalBaseHeight();this._doLayoutVertically(i,!1,(function(t){return(e._isAlign?an.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=i}else this._layoutType===mie.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e&ip.SCALE&&e&ip.POSITION&&this._affectedByScale&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_childrenChanged",value:function(){this._childrenDirty=!0,this._doLayoutDirty()}},{key:"_getPaddingH",value:function(){return this._paddingLeft+this._paddingRight}},{key:"_getPaddingV",value:function(){return this._paddingTop+this._paddingBottom}},{key:"_getFixedBreakingNum",value:function(){if(this._layoutType!==mie.GRID||this._constraint===Sie.NONE||this._constraintNum<=0)return 0;var e=this._constraint===Sie.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===vie.VERTICAL&&(e=this._constraint===Sie.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e}}]),i}(tm),fie.Type=mie,fie.VerticalDirection=yie,fie.HorizontalDirection=gie,fie.ResizeMode=pie,fie.AxisDirection=vie,fie.Constraint=Sie,x((Qte=die).prototype,"type",[zte],Object.getOwnPropertyDescriptor(Qte.prototype,"type"),Qte.prototype),x(Qte.prototype,"resizeMode",[Wte],Object.getOwnPropertyDescriptor(Qte.prototype,"resizeMode"),Qte.prototype),x(Qte.prototype,"startAxis",[Xte],Object.getOwnPropertyDescriptor(Qte.prototype,"startAxis"),Qte.prototype),x(Qte.prototype,"verticalDirection",[jte],Object.getOwnPropertyDescriptor(Qte.prototype,"verticalDirection"),Qte.prototype),x(Qte.prototype,"horizontalDirection",[qte],Object.getOwnPropertyDescriptor(Qte.prototype,"horizontalDirection"),Qte.prototype),x(Qte.prototype,"constraint",[Yte],Object.getOwnPropertyDescriptor(Qte.prototype,"constraint"),Qte.prototype),Jte=Ms(Qte.prototype,"_resizeMode",[Js],(function(){return pie.NONE})),Zte=Ms(Qte.prototype,"_layoutType",[Js],(function(){return mie.NONE})),$te=Ms(Qte.prototype,"_cellSize",[Js],(function(){return new Mn(40,40)})),eie=Ms(Qte.prototype,"_startAxis",[Js],(function(){return vie.HORIZONTAL})),tie=Ms(Qte.prototype,"_paddingLeft",[Js],(function(){return 0})),iie=Ms(Qte.prototype,"_paddingRight",[Js],(function(){return 0})),nie=Ms(Qte.prototype,"_paddingTop",[Js],(function(){return 0})),rie=Ms(Qte.prototype,"_paddingBottom",[Js],(function(){return 0})),sie=Ms(Qte.prototype,"_spacingX",[Js],(function(){return 0})),aie=Ms(Qte.prototype,"_spacingY",[Js],(function(){return 0})),oie=Ms(Qte.prototype,"_verticalDirection",[Js],(function(){return yie.TOP_TO_BOTTOM})),uie=Ms(Qte.prototype,"_horizontalDirection",[Js],(function(){return gie.LEFT_TO_RIGHT})),hie=Ms(Qte.prototype,"_constraint",[Js],(function(){return Sie.NONE})),lie=Ms(Qte.prototype,"_constraintNum",[Js],(function(){return 2})),cie=Ms(Qte.prototype,"_affectedByScale",[Js],(function(){return!1})),_ie=Ms(Qte.prototype,"_isAlign",[Js],(function(){return!1})),Kte=Qte))||Kte)||Kte)||Kte));B.Layout=Fie,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(Lie||(Lie={})),wt(Lie);var Gie,Vie,Uie,Hie,zie,Wie,Xie,jie,qie,Yie,Kie,Qie,Jie,Zie,$ie=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((Tie=Hs("cc.ProgressBar"),Eie=Ws(110),bie=zs(nV),Cie=Aa(eH),Rie=Aa(Lie),Tie(xie=Eie(xie=bie((Die=Oie=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._barSprite=kie&&kie(),e._mode=Iie&&Iie(),e._totalLength=Bie&&Bie(),e._progress=Pie&&Pie(),e._reverse=Mie&&Mie(),e}return s(i,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t._uiProps.uiTransformComp.contentSize;this._mode===Lie.HORIZONTAL?this.totalLength=i.width:this._mode===Lie.VERTICAL?this.totalLength=i.height:this._mode===Lie.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===Lie.FILLED&&(e=Ni(e)),this._totalLength!==e&&(this._totalLength=e,this._updateBarStatus())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}},{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===eH.FillType.RADIAL&&(this._mode=Lie.FILLED),this._mode===Lie.HORIZONTAL?this.totalLength=r.width:this._mode===Lie.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var s=-i.width*n.x;e.setPosition(s,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,i=t.anchorPoint,n=t.contentSize,r=e.getPosition(),s=new In(0,.5),a=Ni(this._progress),o=this._totalLength*a,u=n,h=0,l=0;switch(this._mode){case Lie.HORIZONTAL:this._reverse&&(s=new In(1,.5)),u=new Mn(o,n.height),h=this._totalLength,l=n.height;break;case Lie.VERTICAL:s=this._reverse?new In(.5,1):new In(.5,0),u=new Mn(n.width,o),h=n.width,l=this._totalLength}if(this._mode===Lie.FILLED)this._barSprite.type!==eH.Type.FILLED?Q("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(o*=-1),this._barSprite.fillRange=o);else if(this._barSprite.type!==eH.Type.FILLED){var c=s.x-i.x,_=s.y-i.y,f=new an(h*c,l*_,0);e.setPosition(r.x+f.x,r.y+f.y,r.z),t.setAnchorPoint(s),t.setContentSize(u)}else Q("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}}]),i}(tm),Oie.Mode=Lie,x((wie=Die).prototype,"barSprite",[Cie],Object.getOwnPropertyDescriptor(wie.prototype,"barSprite"),wie.prototype),x(wie.prototype,"mode",[Rie],Object.getOwnPropertyDescriptor(wie.prototype,"mode"),wie.prototype),kie=Ms(wie.prototype,"_barSprite",[Js],(function(){return null})),Iie=Ms(wie.prototype,"_mode",[Js],(function(){return Lie.HORIZONTAL})),Bie=Ms(wie.prototype,"_totalLength",[Js],(function(){return 1})),Pie=Ms(wie.prototype,"_progress",[Js],(function(){return.1})),Mie=Ms(wie.prototype,"_reverse",[Js],(function(){return!1})),xie=wie))||xie)||xie)||xie));B.ProgressBar=$ie;var ene,tne=new an,ine=new an,nne=new an,rne=new In,sne=new cn,ane=new In;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(ene||(ene={})),Bt(ene);var one,une=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((Gie=Hs("cc.ScrollBar"),Vie=Ws(110),Uie=zs(nV),Hie=Aa(eH),zie=Aa(ene),Gie(Wie=Vie(Wie=Uie((Zie=Jie=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._scrollView=jie&&jie(),e._handle=qie&&qie(),e._direction=Yie&&Yie(),e._enableAutoHide=Kie&&Kie(),e._autoHideTime=Qie&&Qie(),e._touching=!1,e._opacity=255,e._autoHideRemainingTime=0,e}return s(i,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(In.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(In.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}},{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._opacity=255,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var s=0,a=0,o=0,u=0,h=0,l=ane;l.set(0,0),this._direction===ene.HORIZONTAL?(s=i.width,a=n.width,h=r.width,o=e.x,this._convertToScrollViewSpace(l,t),u=-l.x):this._direction===ene.VERTICAL&&(s=i.height,a=n.height,h=r.height,o=e.y,this._convertToScrollViewSpace(l,t),u=-l.y);var c=this._calculateLength(s,a,h,o),_=ane;this._calculatePosition(_,s,a,h,u,o,c),this._updateLength(c),this._updateHandlerPosition(_)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(eH);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e,t){var i=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp;if(i&&n){tne.set(-n.anchorX*n.width,-n.anchorY*n.height,0),n.convertToWorldSpaceAR(tne,ine);var r=i.convertToNodeSpaceAR(ine);r.x+=i.anchorX*i.width,r.y+=i.anchorY*i.height,e.set(r.x,r.y)}else e.set(In.ZERO)}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(eH);t&&(sne.set(t.color),sne.a=e,t.color=sne),(t=this._handle.getComponent(eH))&&(sne.set(t.color),sne.a=e,t.color=sne)}}},{key:"_updateHandlerPosition",value:function(e){if(this._handle){var t=nne;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(e){var t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,s=this.handle.node.parent;an.set(tne,-i.width*n.x,-i.height*n.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(tne,ine),o=e;o.set(0,0,0),s._uiProps.uiTransformComp.convertToNodeSpaceAR(a,o),this.direction===ene.HORIZONTAL?o.set(o.x,o.y+(i.height-r.height)/2,o.z):this.direction===ene.VERTICAL&&o.set(o.x+(i.width-r.width)/2,o.y,o.z),this.handle.node.setPosition(o)}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===ene.HORIZONTAL||e.height<=t.height&&this._direction===ene.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,n){var r=e;return n&&(r+=20*(n>0?n:-n)),i*(t/r)}},{key:"_calculatePosition",value:function(e,t,i,n,r,s,a){var o=t-i;s&&(o+=Math.abs(s));var u=0;o&&(u=Ni(u=r/o));var h=(n-a)*u;this._direction===ene.VERTICAL?e.set(0,h):e.set(h,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint;n.x===rne.x&&n.y===rne.y||t.setAnchorPoint(rne),this._direction===ene.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}}]),i}(tm),Jie.Direction=ene,x((Xie=Zie).prototype,"handle",[Hie],Object.getOwnPropertyDescriptor(Xie.prototype,"handle"),Xie.prototype),x(Xie.prototype,"direction",[zie],Object.getOwnPropertyDescriptor(Xie.prototype,"direction"),Xie.prototype),jie=Ms(Xie.prototype,"_scrollView",[Js],(function(){return null})),qie=Ms(Xie.prototype,"_handle",[Js],(function(){return null})),Yie=Ms(Xie.prototype,"_direction",[Js],(function(){return ene.HORIZONTAL})),Kie=Ms(Xie.prototype,"_enableAutoHide",[Js],(function(){return!1})),Qie=Ms(Xie.prototype,"_autoHideTime",[Js],(function(){return 1})),Wie=Xie))||Wie)||Wie)||Wie));B.ScrollBar=une;var hne,lne,cne,_ne,fne,dne,mne,pne,vne,yne,gne,Sne,Ane,Tne,Ene,bne,Cne,Rne,xne,wne,kne,Ine,Bne=e("ViewGroup",Hs("cc.ViewGroup")(one=Ws(110)(one=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(tm))||one)||one);B.ViewGroup=Bne;var Pne,Mne,One=1e-4,Dne=new an,Lne=new an,Nne=new In,Fne=new In,Gne=function(){return(new Date).getMilliseconds()},Vne={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(Pne||(Pne={})),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT"}(Mne||(Mne={}));var Une,Hne,zne,Wne,Xne,jne,qne,Yne,Kne,Qne,Jne,Zne,$ne,ere,tre=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((hne=Hs("cc.ScrollView"),lne=Ws(110),cne=zs(nV),_ne=Aa(Jp),fne=Aa(une),dne=Aa(une),mne=Aa([Zd]),hne(pne=lne(pne=cne((Ine=kne=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).bounceDuration=yne&&yne(),e.brake=gne&&gne(),e.elastic=Sne&&Sne(),e.inertia=Ane&&Ane(),e.horizontal=Tne&&Tne(),e.vertical=Ene&&Ene(),e.cancelInnerEvents=bne&&bne(),e.scrollEvents=Cne&&Cne(),e._autoScrolling=!1,e._scrolling=!1,e._content=Rne&&Rne(),e._horizontalScrollBar=xne&&xne(),e._verticalScrollBar=wne&&wne(),e._topBoundary=0,e._bottomBoundary=0,e._leftBoundary=0,e._rightBoundary=0,e._touchMoveDisplacements=[],e._touchMoveTimeDeltas=[],e._touchMovePreviousTimestamp=0,e._touchMoved=!1,e._autoScrollAttenuate=!1,e._autoScrollStartPosition=new an,e._autoScrollTargetDelta=new an,e._autoScrollTotalTime=0,e._autoScrollAccumulatedTime=0,e._autoScrollCurrentlyOutOfBoundary=!1,e._autoScrollBraking=!1,e._autoScrollBrakingStartPosition=new an,e._outOfBoundaryAmount=new an,e._outOfBoundaryAmountDirty=!0,e._stopMouseWheel=!1,e._mouseWheelEventElapsedTime=0,e._isScrollEndedWithThresholdEventFired=!1,e._scrollEventEmitMask=0,e._isBouncing=!1,e._contentPos=new an,e._deltaPos=new an,e._hoverIn=Mne.NONE,e}return s(i,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):re(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar&&!this._horizontalScrollBar.isValid&&ue(4303,"horizontal",this.node.name),this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(In.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar&&!this._verticalScrollBar.isValid&&ue(4303,"vertical",this.node.name),this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(In.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}},{key:"scrollToBottom",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new In(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new In(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new In(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new In(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new In(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new In(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new In(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new In(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=this.getMaxScrollOffset(),r=new In(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new In(t,e)}},{key:"getMaxScrollOffset",value:function(){if(!this._content||!this.view)return In.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,i=e.height-this.view.height;return new In(t=t>=0?t:0,i=i>=0?i:0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new In(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}},{key:"scrollTo",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new In(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"scrollToPercentVertical",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new In(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){this._setContentPosition(e)}},{key:"_setContentPosition",value:function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<One&&Math.abs(e.y-t.y)<One||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}}},{key:"getContentPosition",value:function(){return this._getContentPosition()}},{key:"_getContentPosition",value:function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):an.ZERO.clone()}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return One}},{key:"start",value:function(){this._calculateBoundary(),this._content&&DN.once(PN.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this._content&&(this._content.on(rp.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(rp.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(rp.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(rp.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this._content&&(this._content.off(rp.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(rp.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(rp.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(rp.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(rp.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(rp.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(rp.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(rp.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(rp.MOUSE_WHEEL,this._onMouseWheel,this,!0),this.node.on(uee.XRUI_HOVER_ENTERED,this._xrHoverEnter,this),this.node.on(uee.XRUI_HOVER_EXITED,this._xrHoverExit,this),IR.on(kR.EventType.HANDLE_INPUT,this._dispatchEventHandleInput,this),IR.on(kR.EventType.GAMEPAD_INPUT,this._dispatchEventHandleInput,this)}},{key:"_unregisterEvent",value:function(){this.node.off(rp.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(rp.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(rp.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(rp.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(rp.MOUSE_WHEEL,this._onMouseWheel,this,!0),this.node.off(uee.XRUI_HOVER_ENTERED,this._xrHoverEnter,this),this.node.off(uee.XRUI_HOVER_EXITED,this._xrHoverExit,this),IR.off(kR.EventType.HANDLE_INPUT,this._dispatchEventHandleInput,this),IR.off(kR.EventType.GAMEPAD_INPUT,this._dispatchEventHandleInput,this)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new an,n=e.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var i=e.touch;if(this._handleMoveLogic(i),this.cancelInnerEvents){var n=i.getUILocation(Nne);if(n.subtract(i.getUIStartLocation(Fne)),n.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new XC(e.getTouches(),e.bubbles,FC.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(Pne.TOUCH_UP);var i=e.touch;this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this._content&&this.view){var e=this._content.getComponent(Fie);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,i=t.width*t.anchorX,n=t.height*t.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(!e||e.eventPhase!==VC.CAPTURING_PHASE)return!1;if(t)for(var i,n=R(t);!(i=n()).done;){var r=i.value;if(this.node===r)return!(!e.target||!e.target.getComponent(Bne));if(r.getComponent(Bne))return!0}return!1}},{key:"_startInertiaScroll",value:function(e){var t=new an(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=e.clone();if(i.normalize(),this._content&&this.view){var n=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,s=n.width-r.width,a=n.height-r.height,o=this._calculateAttenuatedFactor(s),u=this._calculateAttenuatedFactor(a);i.x=i.x*s*(1-this.brake)*o,i.y=i.y*a*u*(1-this.brake),i.z=0}var h=e.length(),l=i.length()/h;if(i.add(e),this.brake>0&&l>7){l=Math.sqrt(l);var c=e.clone();c.multiplyScalar(l),i.set(c),i.add(e)}var _=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&l>3&&(_*=l=3),0===this.brake&&l>1&&(_*=l),this._startAutoScroll(i,_,!0)}},{key:"_calculateAutoScrollTimeByInitialSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,an.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0);var r=this._getHowMuchOutOfBoundary();r.equals(an.ZERO,One)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=new an,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(an.ZERO);else{var i=new an;i=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),i),e.set(i.x*(1-this.brake)/t,i.y*(1-this.brake)/t,i.z)}return e}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);Dne.set(this._getContentPosition()),Dne.add(i),Dne.set(Math.round(1e4*Dne.x)*One,Math.round(1e4*Dne.y)*One,Dne.z),this._setContentPosition(Dne);var n=this._getHowMuchOutOfBoundary();Nne.set(n.x,n.y),this._updateScrollBar(Nne),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width}},{key:"_getContentRightBoundary",value:function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width}},{key:"_getContentTopBoundary",value:function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height}},{key:"_getContentBottomBoundary",value:function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new an).equals(an.ZERO,One)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new an,i=this._getContentLeftBoundary(),n=this._getContentRightBoundary();i+e.x>this._leftBoundary?t.x=this._leftBoundary-(i+e.x):n+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(n+e.x));var r=this._getContentTopBoundary(),s=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):s+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(s+e.y)),e.equals(an.ZERO,One)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.isValid&&this._horizontalScrollBar.onScroll(e),this._verticalScrollBar&&this._verticalScrollBar.isValid&&this._verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.isValid&&this._horizontalScrollBar.onTouchBegan(),this._verticalScrollBar&&this._verticalScrollBar.isValid&&this._verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.isValid&&this._horizontalScrollBar.onTouchEnded(),this._verticalScrollBar&&this._verticalScrollBar.isValid&&this._verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if(e===Pne.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===Pne.SCROLL_TO_TOP||e===Pne.SCROLL_TO_BOTTOM||e===Pne.SCROLL_TO_LEFT||e===Pne.SCROLL_TO_RIGHT){var t=1<<Vne[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}Zd.emitEvents(this.scrollEvents,this,Vne[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();Dne.set(this._getContentPosition()),Dne.add(e),this._setContentPosition(Dne),this._updateScrollBar(In.ZERO)}}},{key:"_hideScrollBar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.isValid&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.isValid&&this._verticalScrollBar.hide()}},{key:"_updateScrollBarState",value:function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this._verticalScrollBar&&this._verticalScrollBar.isValid&&(t.height<e.height?this._verticalScrollBar.hide():this._verticalScrollBar.show()),this._horizontalScrollBar&&this._horizontalScrollBar.isValid&&(t.width<e.width?this._horizontalScrollBar.hide():this._horizontalScrollBar.show())}}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e.eventPhase===VC.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)}},{key:"_handleReleaseLogic",value:function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(Pne.SCROLL_ENDED))}},{key:"_getLocalAxisAlignDelta",value:function(e,t){var i=this.node._uiProps.uiTransformComp,n=new an;i&&(t.getUILocation(Nne),t.getUIPreviousLocation(Fne),Dne.set(Nne.x,Nne.y,0),Lne.set(Fne.x,Fne.y,0),i.convertToNodeSpaceAR(Dne,Dne),i.convertToNodeSpaceAR(Lne,Lne),an.subtract(n,Dne,Lne)),e.set(n)}},{key:"_scrollChildren",value:function(e){this._clampDelta(e);var t,i=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),i.x*=0===t.x?1:.5,i.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(i),i.add(t));var n="",r="";if(this._content){var s=this._content._uiProps.uiTransformComp,a=s.anchorX,o=s.anchorY,u=s.width,h=s.height,l=this._content.position||an.ZERO;this.vertical&&(i.y>0?l.y-o*h+i.y>=this._bottomBoundary&&(n=Pne.SCROLL_TO_BOTTOM):i.y<0&&l.y-o*h+h+i.y<=this._topBoundary&&(n=Pne.SCROLL_TO_TOP)),this.horizontal&&(i.x<0?l.x-a*u+u+i.x<=this._rightBoundary&&(r=Pne.SCROLL_TO_RIGHT):i.x>0&&l.x-a*u+i.x>=this._leftBoundary&&(r=Pne.SCROLL_TO_LEFT))}this._moveContent(i,!1),(this.horizontal&&0!==i.x||this.vertical&&0!==i.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(Pne.SCROLL_BEGAN)),this._dispatchEvent(Pne.SCROLLING)),""!==n&&this._dispatchEvent(n),""!==r&&this._dispatchEvent(r)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent(Pne.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=Gne(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){if(this._content&&this.view){var t=this.view.contentSize,i=this._content._uiProps.uiTransformComp;i.width<t.width&&(e.x=0),i.height<t.height&&(e.y=0)}}},{key:"_gatherTouchMove",value:function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var i=Gne();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(an.ZERO,One))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(Pne.BOUNCE_TOP),e.y<0&&this._dispatchEvent(Pne.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(Pne.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(Pne.BOUNCE_LEFT),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(Dne,One)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals(an.ZERO,One)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,an.copy(this._autoScrollBrakingStartPosition,this._getContentPosition()),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var n,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=r,r=(n-=1)*n*n*n*n+1);var s=this._autoScrollTargetDelta.clone();s.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(s);var o=Math.abs(r-1)<=One;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(Pne.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var u=a.clone();u.subtract(this._autoScrollBrakingStartPosition),t&&u.multiplyScalar(i),a.set(this._autoScrollBrakingStartPosition),a.add(u)}else{var h=a.clone();h.subtract(this.getContentPosition());var l=this._getHowMuchOutOfBoundary(h);l.equals(an.ZERO,One)||(a.add(l),o=!0)}o&&(this._autoScrolling=!1);var c=a.clone();c.subtract(this._getContentPosition()),this._clampDelta(c),this._moveContent(c,o),this._dispatchEvent(Pne.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(Pne.SCROLL_ENDED))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals(an.ZERO,One))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Pne.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Pne.SCROLL_ENDED),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(In.ZERO,In.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var s=this._getContentLeftBoundary()-this._leftBoundary;s=-s;var a=new an;if(this._content&&this.view){var o=0,u=this._content._uiProps.uiTransformComp.contentSize,h=this.view.contentSize;i&&(o=u.width-h.width,a.x=s-o*t.x),n&&(o=u.height-h.height,a.y=r-o*t.y)}return a}},{key:"_moveContentToTopLeft",value:function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var i=new an,n=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var s=this._content._uiProps.uiTransformComp.contentSize;s.height<e.height&&(n=s.height-e.height,i.y=t-n),s.width<e.width&&(n=s.width-e.width,i.x=r)}this._updateScrollBarState(),this._moveContent(i),this._adjustContentOutOfBoundary()}},{key:"_scaleChanged",value:function(e){e===ip.SCALE&&this._calculateBoundary()}},{key:"_xrHoverEnter",value:function(e){e.deviceType===oee.Left?this._hoverIn=Mne.LEFT:e.deviceType===oee.Right&&(this._hoverIn=Mne.RIGHT)}},{key:"_xrHoverExit",value:function(){this._hoverIn=Mne.NONE}},{key:"_dispatchEventHandleInput",value:function(e){var t,i;e instanceof qC?t=e.gamepad:e instanceof YC&&(t=e.handleInputDevice),this.enabledInHierarchy&&this._hoverIn!==Mne.NONE&&(this._hoverIn===Mne.LEFT?(i=t.leftStick.getValue()).equals(In.ZERO)||this._xrThumbStickMove(i):this._hoverIn===Mne.RIGHT&&((i=t.rightStick.getValue()).equals(In.ZERO)||this._xrThumbStickMove(i)))}},{key:"_xrThumbStickMove",value:function(e){if(this.enabledInHierarchy){var t=new an,i=e.y;this.vertical?t.set(0,-62.5*i,0):this.horizontal&&t.set(-62.5*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(t),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0)}}}]),i}(Bne),kne.EventType=Pne,yne=Ms((vne=Ine).prototype,"bounceDuration",[Js],(function(){return 1})),gne=Ms(vne.prototype,"brake",[Js],(function(){return.5})),Sne=Ms(vne.prototype,"elastic",[Js],(function(){return!0})),Ane=Ms(vne.prototype,"inertia",[Js],(function(){return!0})),x(vne.prototype,"content",[_ne],Object.getOwnPropertyDescriptor(vne.prototype,"content"),vne.prototype),Tne=Ms(vne.prototype,"horizontal",[Js],(function(){return!0})),x(vne.prototype,"horizontalScrollBar",[fne],Object.getOwnPropertyDescriptor(vne.prototype,"horizontalScrollBar"),vne.prototype),Ene=Ms(vne.prototype,"vertical",[Js],(function(){return!0})),x(vne.prototype,"verticalScrollBar",[dne],Object.getOwnPropertyDescriptor(vne.prototype,"verticalScrollBar"),vne.prototype),bne=Ms(vne.prototype,"cancelInnerEvents",[Js],(function(){return!0})),Cne=Ms(vne.prototype,"scrollEvents",[mne,Js],(function(){return[]})),Rne=Ms(vne.prototype,"_content",[Js],(function(){return null})),xne=Ms(vne.prototype,"_horizontalScrollBar",[Js],(function(){return null})),wne=Ms(vne.prototype,"_verticalScrollBar",[Js],(function(){return null})),pne=vne))||pne)||pne)||pne));B.ScrollView=tre;var ire,nre=new an;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(ire||(ire={})),Bt(ire);var rre,sre,are,ore,ure,hre,lre,cre,_re,fre,dre,mre,pre,vre=function(t){return e({Slider:t,SliderComponent:t}),t}((Une=Hs("cc.Slider"),Hne=Ws(110),zne=zs(nV),Wne=Aa(eH),Xne=Aa(ire),jne=Aa([Zd]),Une(qne=Hne(qne=zne((ere=$ne=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).slideEvents=Kne&&Kne(),e._handle=Qne&&Qne(),e._direction=Jne&&Jne(),e._progress=Zne&&Zne(),e._offset=new an,e._dragging=!1,e._touchHandle=!1,e._handleLocalPos=new an,e._touchPos=new an,e}return s(i,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}},{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(rp.TOUCH_START,this._onTouchBegan,this),this.node.on(rp.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(rp.TOUCH_END,this._onTouchEnded,this),this.node.on(rp.TOUCH_CANCEL,this._onTouchCancelled,this),this.node.on(uee.XRUI_HOVER_STAY,this._xrHoverStay,this),this.node.on(uee.XRUI_CLICK,this._xrClick,this),this.node.on(uee.XRUI_UNCLICK,this._xrUnClick,this),this._handle&&this._handle.isValid&&(this._handle.node.on(rp.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(rp.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(rp.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(rp.TOUCH_START,this._onTouchBegan,this),this.node.off(rp.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(rp.TOUCH_END,this._onTouchEnded,this),this.node.off(rp.TOUCH_CANCEL,this._onTouchCancelled,this),this.node.off(uee.XRUI_HOVER_STAY,this._xrHoverStay,this),this.node.off(uee.XRUI_CLICK,this._xrClick,this),this.node.off(uee.XRUI_UNCLICK,this._xrUnClick,this),this._handle&&this._handle.isValid&&(this._handle.node.off(rp.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(rp.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(rp.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();an.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new an,e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){Zd.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();an.set(this._touchPos,t.x,t.y,0);var i=this.node._uiProps.uiTransformComp,n=i.convertToNodeSpaceAR(this._touchPos,nre);this.direction===ire.Horizontal?this.progress=Ni(.5+(n.x-this._offset.x)/i.width):this.progress=Ni(.5+(n.y-this._offset.y)/i.height)}}},{key:"_updateHandlePosition",value:function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===ire.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}}},{key:"_changeLayout",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var i=this._handle.node.position;this._direction===ire.Horizontal?this._handle.node.setPosition(i.x,0,i.z):this._handle.node.setPosition(0,i.y,i.z),this._updateHandlePosition()}}},{key:"_xrHandleProgress",value:function(e){if(!this._touchHandle){var t=this.node._uiProps.uiTransformComp;t.convertToNodeSpaceAR(e,nre),this.direction===ire.Horizontal?this.progress=Ni(.5+(nre.x-this.node.position.x)/t.width):this.progress=Ni(.5+(nre.y-this.node.position.y)/t.height)}}},{key:"_xrClick",value:function(e){this._handle&&(this._dragging=!0,this._xrHandleProgress(e.hitPoint),this._emitSlideEvent())}},{key:"_xrUnClick",value:function(){this._dragging=!1,this._touchHandle=!1}},{key:"_xrHoverStay",value:function(e){this._dragging&&(this._xrHandleProgress(e.hitPoint),this._emitSlideEvent())}}]),i}(tm),$ne.Direction=ire,x((Yne=ere).prototype,"handle",[Wne],Object.getOwnPropertyDescriptor(Yne.prototype,"handle"),Yne.prototype),x(Yne.prototype,"direction",[Xne],Object.getOwnPropertyDescriptor(Yne.prototype,"direction"),Yne.prototype),Kne=Ms(Yne.prototype,"slideEvents",[jne,Js],(function(){return[]})),Qne=Ms(Yne.prototype,"_handle",[Js],(function(){return null})),Jne=Ms(Yne.prototype,"_direction",[Js],(function(){return ire.Horizontal})),Zne=Ms(Yne.prototype,"_progress",[Js],(function(){return.1})),qne=Yne))||qne)||qne)||qne));function yre(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return Object.assign.apply(Object,[{}].concat(t))}B.Slider=vre,function(e){e.TOGGLE="toggle"}(pre||(pre={}));var gre,Sre,Are,Tre,Ere,bre,Cre,Rre=function(t){return e({Toggle:t,ToggleComponent:t}),t}((rre=Hs("cc.Toggle"),sre=Ws(110),are=zs(nV),ore=Aa(eH),ure=Aa([Zd]),rre(hre=sre(hre=are((mre=dre=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).checkEvents=cre&&cre(),e._isChecked=_re&&_re(),e._checkMark=fre&&fre(),e}return s(i,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return B.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}},{key:"_internalToggle",value:function(){this.isChecked=!this.isChecked}},{key:"_set",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._isChecked!=e){this._isChecked=e;var i=this._toggleContainer;i&&i.enabled&&this.enabled&&(e||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}}},{key:"playEffect",value:function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}},{key:"setIsCheckedWithoutNotify",value:function(e){this._set(e,!1)}},{key:"onEnable",value:function(){g(l(i.prototype),"onEnable",this).call(this),this.playEffect(),this.node.on(i.EventType.CLICK,this._internalToggle,this)}},{key:"onDisable",value:function(){g(l(i.prototype),"onDisable",this).call(this),this.node.off(i.EventType.CLICK,this._internalToggle,this)}},{key:"_emitToggleEvents",value:function(){this.node.emit(i.EventType.TOGGLE,this),this.checkEvents&&Zd.emitEvents(this.checkEvents,this)}}]),i}(Yee),dre.EventType=yre(pre,jee),x((lre=mre).prototype,"checkMark",[ore],Object.getOwnPropertyDescriptor(lre.prototype,"checkMark"),lre.prototype),cre=Ms(lre.prototype,"checkEvents",[ure,Js],(function(){return[]})),_re=Ms(lre.prototype,"_isChecked",[Js],(function(){return!0})),fre=Ms(lre.prototype,"_checkMark",[Js],(function(){return null})),hre=lre))||hre)||hre)||hre));B.Toggle=Rre;var xre,wre,kre,Ire,Bre,Pre,Mre,Ore,Dre,Lre,Nre,Fre,Gre,Vre,Ure,Hre,zre,Wre,Xre,jre,qre,Yre,Kre,Qre,Jre,Zre,$re,ese=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((gre=Hs("cc.ToggleContainer"),Sre=Ws(110),Are=Aa([Zd]),gre(Tre=Sre((Ere=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._allowSwitchOff=bre&&bre(),e.checkEvents=Cre&&Cre(),e}return s(i,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}},{key:"onEnable",value:function(){this.ensureValidState(),this.node.on(rp.CHILD_ADDED,this.ensureValidState,this),this.node.on(rp.CHILD_REMOVED,this.ensureValidState,this)}},{key:"onDisable",value:function(){this.node.off(rp.CHILD_ADDED,this.ensureValidState,this),this.node.off(rp.CHILD_REMOVED,this.ensureValidState,this)}},{key:"activeToggles",value:function(){return this.toggleItems.filter((function(e){return e.isChecked}))}},{key:"anyTogglesChecked",value:function(){return!!this.toggleItems.find((function(e){return e.isChecked}))}},{key:"notifyToggleCheck",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.enabledInHierarchy){for(var i=0;i<this.toggleItems.length;i++){var n=this.toggleItems[i];n!==e&&(t?n.isChecked=!1:n.setIsCheckedWithoutNotify(!1))}this.checkEvents&&B.Component.EventHandler.emitEvents(this.checkEvents,e)}}},{key:"ensureValidState",value:function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var i=this.activeToggles();if(i.length>1)for(var n=i[0],r=0;r<i.length;++r){var s=i[r];s!==n&&(s.isChecked=!1)}}}]),i}(tm),bre=Ms(Ere.prototype,"_allowSwitchOff",[Js],(function(){return!1})),Cre=Ms(Ere.prototype,"checkEvents",[Are,Js],(function(){return[]})),Tre=Ere))||Tre)||Tre));B.ToggleContainer=ese;var tse,ise,nse=new In;function rse(e){return e instanceof LC?Al:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:Mn.ZERO}function sse(e,t,i,n){e.parent?nse.set(e.parent.getScale().x,e.parent.getScale().y):nse.set(0,0);for(var r=nse.x,s=nse.y,a=0,o=0,u=e.parent;;){if(!u)return i.x=i.y=0,void(n.x=n.y=1);var h=u.getPosition();if(a+=h.x,o+=h.y,(u=u.parent)===t)break;u?nse.set(u.getScale().x,u.getScale().y):nse.set(0,0);var l=nse.x,c=nse.y;a*=l,o*=c,r*=l,s*=c}n.x=0!==r?1/r:1,n.y=0!==s?1/s:1,i.x=-a,i.y=-o}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(tse||(tse={})),Bt(tse),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(ise||(ise={}));var ase,ose,use,hse,lse,cse,_se,fse,dse,mse,pse,vse,yse,gse=ise.TOP|ise.BOT,Sse=ise.LEFT|ise.RIGHT,Ase=function(t){return e({Widget:t,WidgetComponent:t}),t}((xre=Hs("cc.Widget"),wre=Ws(110),kre=zs(nV),Ire=Aa(Jp),Bre=Aa(tse),xre(Pre=wre(Pre=kre(($re=Zre=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._lastPos=new an,e._lastSize=new Mn,e._dirty=!0,e._hadAlignOnce=!1,e._alignFlags=Ore&&Ore(),e._target=Dre&&Dre(),e._left=Lre&&Lre(),e._right=Nre&&Nre(),e._top=Fre&&Fre(),e._bottom=Gre&&Gre(),e._horizontalCenter=Vre&&Vre(),e._verticalCenter=Ure&&Ure(),e._isAbsLeft=Hre&&Hre(),e._isAbsRight=zre&&zre(),e._isAbsTop=Wre&&Wre(),e._isAbsBottom=Xre&&Xre(),e._isAbsHorizontalCenter=jre&&jre(),e._isAbsVerticalCenter=qre&&qre(),e._originalWidth=Yre&&Yre(),e._originalHeight=Kre&&Kre(),e._alignMode=Qre&&Qre(),e._lockFlags=Jre&&Jre(),e}return s(i,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&ise.TOP)>0},set:function(e){this._setAlign(ise.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&ise.BOT)>0},set:function(e){this._setAlign(ise.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&ise.LEFT)>0},set:function(e){this._setAlign(ise.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&ise.RIGHT)>0},set:function(e){this._setAlign(ise.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&ise.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=ise.MID):this._alignFlags&=~ise.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&ise.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=ise.CENTER):this._alignFlags&=~ise.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&Sse)===Sse}},{key:"isStretchHeight",get:function(){return(this._alignFlags&gse)===gse}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(ise.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(ise.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(ise.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(ise.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(ise.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(ise.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}},{key:"updateAlignment",value:function(){B._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),B._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()}},{key:"onDisable",value:function(){B._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}},{key:"onDestroy",value:function(){this._removeParentEvent()}},{key:"_adjustWidgetToAllowMovingInEditor",value:function(){}},{key:"_adjustWidgetToAllowResizingInEditor",value:function(){}},{key:"_adjustWidgetToAnchorChanged",value:function(){this.setDirty()}},{key:"_adjustTargetToParentChanged",value:function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()}},{key:"_registerEvent",value:function(){this.node.on(rp.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(rp.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(rp.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(rp.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_unregisterEvent",value:function(){this.node.off(rp.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(rp.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(rp.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}},{key:"_removeParentEvent",value:function(){this.node.off(rp.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_autoChangedValue",value:function(e,t){if((this._alignFlags&e)>0){var i=this.node.parent&&this.node.parent._uiProps,n=i&&i.uiTransformComp,r=n?n.contentSize:Al;this.isAlignLeft&&e===ise.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===ise.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===ise.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===ise.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===ise.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===ise.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;e&&e.getComponent(nV)&&(e.on(rp.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(rp.SIZE_CHANGED,this._setDirtyByMode,this),e.on(rp.ANCHOR_CHANGED,this._setDirtyByMode,this))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off(rp.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(rp.SIZE_CHANGED,this._setDirtyByMode,this),e.off(rp.ANCHOR_CHANGED,this._setDirtyByMode,this))}},{key:"_unregisterOldParentEvents",value:function(e){var t=this._target||e;t&&(t.off(rp.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(rp.SIZE_CHANGED,this._setDirtyByMode,this))}},{key:"_setDirtyByMode",value:function(){this.alignMode===tse.ALWAYS&&this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==(this._alignFlags&e)>0){var i=(e&Sse)>0,n=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=n.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=n.height))):(i?this.isStretchWidth&&(n.width=this._originalWidth):this.isStretchHeight&&(n.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||(this._dirty=!0)}}]),i}(tm),Zre.AlignMode=tse,x((Mre=$re).prototype,"target",[Ire],Object.getOwnPropertyDescriptor(Mre.prototype,"target"),Mre.prototype),x(Mre.prototype,"alignMode",[Bre],Object.getOwnPropertyDescriptor(Mre.prototype,"alignMode"),Mre.prototype),Ore=Ms(Mre.prototype,"_alignFlags",[Js],(function(){return 0})),Dre=Ms(Mre.prototype,"_target",[Js],(function(){return null})),Lre=Ms(Mre.prototype,"_left",[Js],(function(){return 0})),Nre=Ms(Mre.prototype,"_right",[Js],(function(){return 0})),Fre=Ms(Mre.prototype,"_top",[Js],(function(){return 0})),Gre=Ms(Mre.prototype,"_bottom",[Js],(function(){return 0})),Vre=Ms(Mre.prototype,"_horizontalCenter",[Js],(function(){return 0})),Ure=Ms(Mre.prototype,"_verticalCenter",[Js],(function(){return 0})),Hre=Ms(Mre.prototype,"_isAbsLeft",[Js],(function(){return!0})),zre=Ms(Mre.prototype,"_isAbsRight",[Js],(function(){return!0})),Wre=Ms(Mre.prototype,"_isAbsTop",[Js],(function(){return!0})),Xre=Ms(Mre.prototype,"_isAbsBottom",[Js],(function(){return!0})),jre=Ms(Mre.prototype,"_isAbsHorizontalCenter",[Js],(function(){return!0})),qre=Ms(Mre.prototype,"_isAbsVerticalCenter",[Js],(function(){return!0})),Yre=Ms(Mre.prototype,"_originalWidth",[Js],(function(){return 0})),Kre=Ms(Mre.prototype,"_originalHeight",[Js],(function(){return 0})),Qre=Ms(Mre.prototype,"_alignMode",[Js],(function(){return tse.ON_WINDOW_RESIZE})),Jre=Ms(Mre.prototype,"_lockFlags",[Js,$s],(function(){return 0})),Pre=Mre))||Pre)||Pre)||Pre));B.internal.computeInverseTransForTarget=sse,B.internal.getReadonlyNodeSize=rse,B.Widget=Ase;var Tse,Ese=new cn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Tse||(Tse={})),Bt(Tse);var bse,Cse,Rse,xse,wse,kse,Ise,Bse,Pse,Mse,Ose,Dse,Lse,Nse,Fse,Gse,Vse,Use,Hse,zse,Wse,Xse,jse,qse,Yse,Kse=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((ase=Hs("cc.PageViewIndicator"),ose=Ws(110),use=Aa(sF),hse=Aa(Tse),lse=Aa(Mn),ase(cse=ose((yse=vse=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).spacing=fse&&fse(),e._spriteFrame=dse&&dse(),e._direction=mse&&mse(),e._cellSize=pse&&pse(),e._layout=null,e._pageView=null,e._indicators=[],e}return s(i,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}},{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(Fie),this._layout||(this._layout=this.addComponent(Fie));var e=this._layout;this.direction===Tse.HORIZONTAL?(e.type=Fie.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===Tse.VERTICAL&&(e.type=Fie.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=Fie.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new Jp;e.layer=this.node.layer;var t=e.addComponent(eH);return t.spriteFrame=this.spriteFrame,t.sizeMode=eH.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var n=e[i];if(n._uiProps.uiComp){var r=n._uiProps.uiComp;Ese.set(r.color),Ese.a=127.5,r.color=Ese}}if(e[t]._uiProps.uiComp){var s=e[t]._uiProps.uiComp;Ese.set(s.color),Ese.a=255,s.color=Ese}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;i>0;--i){var n=e[i-1];this.node.removeChild(n),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}}]),i}(tm),vse.Direction=Tse,x((_se=yse).prototype,"spriteFrame",[use],Object.getOwnPropertyDescriptor(_se.prototype,"spriteFrame"),_se.prototype),x(_se.prototype,"direction",[hse],Object.getOwnPropertyDescriptor(_se.prototype,"direction"),_se.prototype),x(_se.prototype,"cellSize",[lse],Object.getOwnPropertyDescriptor(_se.prototype,"cellSize"),_se.prototype),fse=Ms(_se.prototype,"spacing",[Js],(function(){return 0})),dse=Ms(_se.prototype,"_spriteFrame",[Js],(function(){return null})),mse=Ms(_se.prototype,"_direction",[Js],(function(){return Tse.HORIZONTAL})),pse=Ms(_se.prototype,"_cellSize",[Js],(function(){return new Mn(20,20)})),cse=_se))||cse)||cse));B.PageViewIndicator=Kse;var Qse,Jse,Zse,$se=new In;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(Qse||(Qse={})),Bt(Qse),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Jse||(Jse={})),Bt(Jse),function(e){e.PAGE_TURNING="page-turning"}(Zse||(Zse={}));var eae=function(t){return e({PageView:t,PageViewComponent:t}),t}((bse=Hs("cc.PageView"),Cse=Ws(110),Rse=Aa(Qse),xse=Aa(Jse),wse=Aa(Kse),kse=Aa(une),Ise=Aa(une),Bse=Aa([Zd]),Pse=Aa([Zd]),bse(Mse=Cse((Yse=qse=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).autoPageTurningThreshold=Dse&&Dse(),e.horizontal=Lse&&Lse(),e.vertical=Nse&&Nse(),e.cancelInnerEvents=Fse&&Fse(),e.scrollEvents=Gse&&Gse(),e.pageTurningSpeed=Vse&&Vse(),e.pageEvents=Use&&Use(),e._sizeMode=Hse&&Hse(),e._direction=zse&&zse(),e._scrollThreshold=Wse&&Wse(),e._pageTurningEventTiming=Xse&&Xse(),e._indicator=jse&&jse(),e._curPageIdx=0,e._lastPageIdx=0,e._pages=[],e._initContentPos=new an,e._scrollCenterOffsetX=[],e._scrollCenterOffsetY=[],e._touchBeganPosition=new In,e._touchEndPosition=new In,e}return s(i,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return g(l(i.prototype),"verticalScrollBar",this)},set:function(e){A(l(i.prototype),"verticalScrollBar",e,this,!0)}},{key:"horizontalScrollBar",get:function(){return g(l(i.prototype),"horizontalScrollBar",this)},set:function(e){A(l(i.prototype),"horizontalScrollBar",e,this,!0)}},{key:"onEnable",value:function(){g(l(i.prototype),"onEnable",this).call(this),this.node.on(rp.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(i.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){g(l(i.prototype),"onDisable",this).call(this),this.node.off(rp.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(i.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):re(4301))}},{key:"insertPage",value:function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void re(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):ae(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3;e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){if(this.content){var e=this.content.getComponent(Fie);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<t;++n){var r=this._pages[n].position;this.direction===Jse.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}}},{key:"_updateAllPagesSize",value:function(){var e=this.view;if(this.content&&e&&this._sizeMode===Qse.Unified)for(var t=this._pages,i=e.contentSize,n=0,r=t.length;n<r;n++)t[n]._uiProps.uiTransformComp.setContentSize(i)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(i.EventType.SCROLL_ENDED))}},{key:"_onTouchBegan",value:function(e,t){e.touch.getUILocation($se),In.set(this._touchBeganPosition,$se.x,$se.y),g(l(i.prototype),"_onTouchBegan",this).call(this,e,t)}},{key:"_onTouchMoved",value:function(e,t){g(l(i.prototype),"_onTouchMoved",this).call(this,e,t)}},{key:"_onTouchEnded",value:function(e,t){e.touch.getUILocation($se),In.set(this._touchEndPosition,$se.x,$se.y),g(l(i.prototype),"_onTouchEnded",this).call(this,e,t)}},{key:"_onTouchCancelled",value:function(e,t){e.touch.getUILocation($se),In.set(this._touchEndPosition,$se.x,$se.y),g(l(i.prototype),"_onTouchCancelled",this).call(this,e,t)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===Jse.Horizontal,this.vertical=this.direction===Jse.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(Fie);if(t){if(this._sizeMode===Qse.Free&&this._pages.length>0){var i=this._pages[0]._uiProps.uiTransformComp,n=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===Jse.Horizontal?(t.paddingLeft=(e.width-i.width)/2,t.paddingRight=(e.width-n.width)/2):this.direction===Jse.Vertical&&(t.paddingTop=(e.height-i.height)/2,t.paddingBottom=(e.height-n.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,Zd.emitEvents(this.pageEvents,this,Zse.PAGE_TURNING),this.node.emit(Zse.PAGE_TURNING,this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===Jse.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===Jse.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new In;if(this._sizeMode===Qse.Free)this.direction===Jse.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===Jse.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===Jse.Horizontal?t.x=e*i.width:this.direction===Jse.Vertical&&(t.y=e*i.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===Jse.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,i){if(this._sizeMode===Qse.Free){var n=0,r=0;if(this.direction===Jse.Horizontal)return n=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===Jse.Vertical)return n=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-r)*this.scrollThreshold}else{var s=this.view;if(!s)return!1;if(this.direction===Jse.Horizontal)return Math.abs(e.x)>=s.width*this.scrollThreshold;if(this.direction===Jse.Vertical)return Math.abs(e.y)>=s.height*this.scrollThreshold}return!1}},{key:"_autoScrollToPage",value:function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new In;In.subtract(t,this._touchBeganPosition,this._touchEndPosition);var i=this._curPageIdx,n=i+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(i-n);if(n<this._pages.length){if(this._isScrollable(t,i,n))return void this.scrollToPage(n,r);var s=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(s))return void this.scrollToPage(n,r)}this.scrollToPage(i,r)}}}]),i}(tre),qse.SizeMode=Qse,qse.Direction=Jse,qse.EventType=yre(Zse,Pne),x((Ose=Yse).prototype,"sizeMode",[Rse],Object.getOwnPropertyDescriptor(Ose.prototype,"sizeMode"),Ose.prototype),x(Ose.prototype,"direction",[xse],Object.getOwnPropertyDescriptor(Ose.prototype,"direction"),Ose.prototype),x(Ose.prototype,"indicator",[wse],Object.getOwnPropertyDescriptor(Ose.prototype,"indicator"),Ose.prototype),Dse=Ms(Ose.prototype,"autoPageTurningThreshold",[Js],(function(){return 100})),x(Ose.prototype,"verticalScrollBar",[kse,Ta],Object.getOwnPropertyDescriptor(Ose.prototype,"verticalScrollBar"),Ose.prototype),x(Ose.prototype,"horizontalScrollBar",[Ise,Ta],Object.getOwnPropertyDescriptor(Ose.prototype,"horizontalScrollBar"),Ose.prototype),Lse=Ms(Ose.prototype,"horizontal",[Ta,Js],(function(){return!0})),Nse=Ms(Ose.prototype,"vertical",[Ta,Js],(function(){return!0})),Fse=Ms(Ose.prototype,"cancelInnerEvents",[Ta,Js],(function(){return!0})),Gse=Ms(Ose.prototype,"scrollEvents",[Bse,Js,Ta],(function(){return[]})),Vse=Ms(Ose.prototype,"pageTurningSpeed",[Js],(function(){return.3})),Use=Ms(Ose.prototype,"pageEvents",[Pse,Js],(function(){return[]})),Hse=Ms(Ose.prototype,"_sizeMode",[Js],(function(){return Qse.Unified})),zse=Ms(Ose.prototype,"_direction",[Js],(function(){return Jse.Horizontal})),Wse=Ms(Ose.prototype,"_scrollThreshold",[Js],(function(){return.5})),Xse=Ms(Ose.prototype,"_pageTurningEventTiming",[Js],(function(){return.1})),jse=Ms(Ose.prototype,"_indicator",[Js],(function(){return null})),Mse=Ose))||Mse)||Mse));B.PageView=eae;var tae=new an,iae=new In,nae=new In,rae=new In(1,1),sae=new In,aae=new In;function oae(e,t){if(!t._hadAlignOnce){t.alignMode===tse.ONCE&&(t._hadAlignOnce=!0);var i,n=t.target,r=nae,s=rae;n?sse(e,i=n,r,s):i=e.parent;var a=rse(i),o=i instanceof LC||!i.getComponent(nV),u=o?iae:i.getComponent(nV).anchorPoint,h=o;e.getPosition(tae);var l=e._uiProps.uiTransformComp,c=tae.x,_=tae.y,f=l.anchorPoint,d=e.getScale();if(t.alignFlags&ise.HORIZONTAL){var m=0,p=0,v=a.width;h?(m=Al.left.x,p=Al.right.x):p=(m=-u.x*v)+v,m+=t.isAbsoluteLeft?t.left:t.left*v,p-=t.isAbsoluteRight?t.right:t.right*v,n&&(m+=r.x,m*=s.x,p+=r.x,p*=s.x);var y=0,g=f.x,S=d.x;if(S<0&&(g=1-g,S=-S),t.isStretchWidth)y=p-m,0!==S&&(l.width=y/S),c=m+g*y;else if(y=l.width*S,t.isAlignHorizontalCenter){var A=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,T=(.5-u.x)*a.width;n&&(A*=s.x,T+=r.x,T*=s.x),c=T+(g-.5)*y+A}else c=t.isAlignLeft?m+g*y:p+(g-1)*y;t._lastSize.width=y}if(t.alignFlags&ise.VERTICAL){var E=0,b=0,C=a.height;h?(b=Al.bottom.y,E=Al.top.y):E=(b=-u.y*C)+C,b+=t.isAbsoluteBottom?t.bottom:t.bottom*C,E-=t.isAbsoluteTop?t.top:t.top*C,n&&(b+=r.y,b*=s.y,E+=r.y,E*=s.y);var R=0,x=f.y,w=d.y;if(w<0&&(x=1-x,w=-w),t.isStretchHeight)R=E-b,0!==w&&(l.height=R/w),_=b+x*R;else if(R=l.height*w,t.isAlignVerticalCenter){var k=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*C,I=(.5-u.y)*a.height;n&&(k*=s.y,I+=r.y,I*=s.y),_=I+(x-.5)*R+k}else _=t.isAlignBottom?b+x*R:E+(x-1)*R;t._lastSize.height=R}e.setPosition(c,_,tae.z),an.set(t._lastPos,c,_,tae.z)}}function uae(e){var t=e.getComponent(Ase);if(t&&t.enabled){if(!B.isValid(e,!0))return;cae.push(t)}for(var i,n=R(e.children);!(i=n()).done;){var r=i.value;r.active&&uae(r)}}function hae(){var e=DN.getScene();if(e){_ae.isAligning=!0,_ae._nodesOrderDirty&&(cae.length=0,uae(e),_ae._nodesOrderDirty=!1);var t=null,i=_ae._activeWidgetsIterator;for(i.i=0;i.i<cae.length;++i.i)(t=cae[i.i])._dirty&&(oae(t.node,t),t._dirty=!1);_ae.isAligning=!1}}var lae,cae=[],_ae=e("widgetManager",B._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new vt(cae),animationState:null,init:function(){DN.on(PN.EVENT_AFTER_SCENE_LAUNCH,hae),DN.on(PN.EVENT_AFTER_UPDATE,hae),sz.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);sz.instance.on("canvas-resize",e),vl.on("window-resize",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=DN.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=Jp.isNode(e)&&e.getComponent(Ase);t&&t.enabled&&(t.alignMode===tse.ON_WINDOW_RESIZE||t.alignMode===tse.ALWAYS)&&t.setDirty();for(var i,n=R(e.children);!(i=n()).done;){var r=i.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return Math.abs(e-t)>1e-10?t:e}var n=e.node,r=n.parent;if(r){var s=sae;s.set(0,0);var a=aae;if(a.set(1,1),e.target&&sse(n,r=e.target,s,a),!t)return;var o=r._uiProps&&r._uiProps.uiTransformComp,u=o?o.anchorPoint:iae,h=n._uiProps.uiTransformComp,l=rse(r),c=h.anchorPoint,_=n.getPosition(),f=ise,d=n.getScale(),m=0;if(t&f.LEFT){var p=-u.x*l.width;p+=s.x,p*=a.x,m=_.x-c.x*h.width*Math.abs(d.x)-p,e.isAbsoluteLeft||(m/=l.width),m/=a.x,e.left=i(e.left,m)}if(t&f.RIGHT){var v=(1-u.x)*l.width;v+=s.x,m=(v*=a.x)-(_.x+(1-c.x)*h.width*Math.abs(d.x)),e.isAbsoluteRight||(m/=l.width),m/=a.x,e.right=i(e.right,m)}if(t&f.TOP){var y=(1-u.y)*l.height;y+=s.y,m=(y*=a.y)-(_.y+(1-c.y)*h.height*Math.abs(d.y)),e.isAbsoluteTop||(m/=l.height),m/=a.y,e.top=i(e.top,m)}if(t&f.BOT){var g=-u.y*l.height;g+=s.y,g*=a.y,m=_.y-c.y*h.height*Math.abs(d.y)-g,e.isAbsoluteBottom||(m/=l.height),m/=a.y,e.bottom=i(e.bottom,m)}}},updateAlignment:function e(t){var i=t.parent;i&&Jp.isNode(i)&&e(i);var n=t.getComponent(Ase);n&&i&&oae(t,n)},AlignMode:tse,AlignFlags:ise});DN.on(PN.EVENT_INIT,(function(){_ae.init()}));var fae,dae,mae,pae,vae,yae,gae,Sae,Aae,Tae,Eae,bae,Cae=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(Hs("cc.SafeArea")(lae=Ws(110)(lae=zs(Ase)(lae=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"onEnable",value:function(){this.updateArea(),vl.on("window-resize",this.updateArea,this),vl.on("orientation-change",this.updateArea,this)}},{key:"onDisable",value:function(){vl.off("window-resize",this.updateArea,this),vl.off("orientation-change",this.updateArea,this)}},{key:"updateArea",value:function(){var e=this.node.getComponent(Ase),t=this.node.getComponent(nV);if(e&&t){e.updateAlignment();var i=this.node.position.clone(),n=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=lz.getVisibleSize(),s=r.width,a=r.height,o=Sl.getSafeAreaRect();e.top=a-o.y-o.height,e.bottom=o.y,e.left=o.x,e.right=s-o.x-o.width,e.updateAlignment();var u=this.node.position.clone(),h=n.x-(u.x-i.x)/t.width,l=n.y-(u.y-i.y)/t.height;t.setAnchorPoint(h,l),_ae.add(e)}}}]),i}(tm))||lae)||lae)||lae);B.SafeArea=Cae;var Rae,xae=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((fae=Hs("cc.UICoordinateTracker"),dae=Ws(110),mae=Aa(Jp),pae=Aa(iz),vae=Aa([Zd]),fae(yae=dae((x((gae=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).syncEvents=Sae&&Sae(),e._target=Aae&&Aae(),e._camera=Tae&&Tae(),e._useScale=Eae&&Eae(),e._distance=bae&&bae(),e._transformPos=new an,e._viewPos=new an,e._canMove=!0,e._lastWPos=new an,e._lastCameraPos=new an,e}return s(i,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}},{key:"onEnable",value:function(){this._checkCanMove()}},{key:"update",value:function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&an.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var i=this._distance/Math.abs(this._viewPos.z);Zd.emitEvents(this.syncEvents,this._transformPos,i)}}},{key:"_checkCanMove",value:function(){this._canMove=!(!this._camera||!this._target)}}]),i}(tm)).prototype,"target",[mae],Object.getOwnPropertyDescriptor(gae.prototype,"target"),gae.prototype),x(gae.prototype,"camera",[pae],Object.getOwnPropertyDescriptor(gae.prototype,"camera"),gae.prototype),Sae=Ms(gae.prototype,"syncEvents",[vae,Js],(function(){return[]})),Aae=Ms(gae.prototype,"_target",[Js],(function(){return null})),Tae=Ms(gae.prototype,"_camera",[Js],(function(){return null})),Eae=Ms(gae.prototype,"_useScale",[Js],(function(){return!0})),bae=Ms(gae.prototype,"_distance",[Js],(function(){return 1})),yae=gae))||yae)||yae)),wae=[rp.TOUCH_START,rp.TOUCH_END,rp.TOUCH_MOVE,rp.MOUSE_DOWN,rp.MOUSE_MOVE,rp.MOUSE_UP,rp.MOUSE_ENTER,rp.MOUSE_LEAVE,rp.MOUSE_WHEEL];function kae(e){e.propagationStopped=!0}var Iae,Bae,Pae,Mae,Oae,Dae=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(Hs("cc.BlockInputEvents")(Rae=function(e){h(i,e);var t=v(i);function i(){return n(this,i),t.apply(this,arguments)}return s(i,[{key:"onEnable",value:function(){for(var e=0;e<wae.length;e++)this.node.on(wae[e],kae,this)}},{key:"onDisable",value:function(){for(var e=0;e<wae.length;e++)this.node.off(wae[e],kae,this)}}]),i}(tm))||Rae),Lae=e("SubContextView",Hs("cc.SubContextView")(Iae=Ws(110)(Iae=zs(nV)((Bae=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._fps=Pae&&Pae(),e._sprite=void 0,e._imageAsset=void 0,e._texture=void 0,e._updatedTime=0,e._updateInterval=0,e._openDataContext=void 0,e._content=void 0,e._designResolutionSize=Mae&&Mae(),e._content=new Jp("content"),e._content.hideFlags|=Ga.Flags.DontSave|Ga.Flags.HideInHierarchy,e._sprite=null,e._imageAsset=new bd,e._openDataContext=null,e._updatedTime=performance.now(),e._texture=new Qm,e}return s(i,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}},{key:"onLoad",value:function(){Tf.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=Tf.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1}},{key:"onEnable",value:function(){this._registerNodeEvent()}},{key:"onDisable",value:function(){this._unregisterNodeEvent()}},{key:"_initSharedCanvas",value:function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._designResolutionSize.width,i=this._designResolutionSize.height;e.width=t,e.height=i}}},{key:"_initContentNode",value:function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(eH),this._sprite||(this._sprite=this._content.addComponent(eH)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var i=new sF;i.texture=this._texture,this._sprite.spriteFrame=i}this._content.parent=this.node}}},{key:"_updateSubContextView",value:function(){if(this._openDataContext){var e=this.node.getComponent(nV),t=this._content.getComponent(nV),i=e.width/t.width,n=e.height/t.height,r=i>n?n:i;t.width*=r,t.height*=r;var s=lz.getViewportRect(),a=t.getBoundingBoxToWorld(),o=lz.getVisibleSize(),u=vl.devicePixelRatio,h=(s.width*(a.x/o.width)+s.x)/u,l=(s.height*(a.y/o.height)+s.y)/u,c=s.width*(a.width/o.width)/u,_=s.height*(a.height/o.height)/u;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:h,y:l,width:c,height:_})}}},{key:"_updateSubContextTexture",value:function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}}},{key:"_registerNodeEvent",value:function(){this.node.on(rp.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(rp.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(rp.LAYER_CHANGED,this._updateContentLayer,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off(rp.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(rp.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(rp.LAYER_CHANGED,this._updateContentLayer,this)}},{key:"_updateContentLayer",value:function(){this._content.layer=this.node.layer}},{key:"update",value:function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())}},{key:"onDestroy",value:function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null}}]),i}(tm),Pae=Ms(Bae.prototype,"_fps",[Js],(function(){return 60})),Mae=Ms(Bae.prototype,"_designResolutionSize",[Js],(function(){return new Mn(640,960)})),Iae=Bae))||Iae)||Iae)||Iae);B.SubContextView=Lae,xe({ButtonComponent:{newName:"Button",since:"1.2.0",removed:!1},EditBoxComponent:{newName:"EditBox",since:"1.2.0",removed:!1},LayoutComponent:{newName:"Layout",since:"1.2.0",removed:!1},ProgressBarComponent:{newName:"ProgressBar",since:"1.2.0",removed:!1},ScrollViewComponent:{newName:"ScrollView",since:"1.2.0",removed:!1},ScrollBarComponent:{newName:"ScrollBar",since:"1.2.0",removed:!1},SliderComponent:{newName:"Slider",since:"1.2.0",removed:!1},ToggleComponent:{newName:"Toggle",since:"1.2.0",removed:!1},ToggleContainerComponent:{newName:"ToggleContainer",since:"1.2.0",removed:!1},WidgetComponent:{newName:"Widget",since:"1.2.0",removed:!1},PageViewComponent:{newName:"PageView",since:"1.2.0",removed:!1},PageViewIndicatorComponent:{newName:"PageViewIndicator",since:"1.2.0",removed:!1},SafeAreaComponent:{newName:"SafeArea",since:"1.2.0",removed:!1},UICoordinateTrackerComponent:{newName:"UICoordinateTracker",since:"1.2.0",removed:!1},BlockInputEventsComponent:{newName:"BlockInputEvents",since:"1.2.0",removed:!1}});var Nae,Fae,Gae,Vae=e("UIReorderComponent",Hs("cc.UIReorderComponent")(Oae=function e(){n(this,e),ae(1408,"UIReorderComponent")})||Oae);B.UIReorderComponent=Vae,B.ButtonComponent=Yee,ht(Yee,"cc.ButtonComponent"),B.EditBoxComponent=Aie,ht(Aie,"cc.EditBoxComponent"),B.LayoutComponent=Fie,ht(Fie,"cc.LayoutComponent"),B.ProgressBarComponent=$ie,ht($ie,"cc.ProgressBarComponent"),B.ScrollViewComponent=tre,ht(tre,"cc.ScrollViewComponent"),B.ScrollBarComponent=une,ht(une,"cc.ScrollBarComponent"),B.SliderComponent=vre,ht(vre,"cc.SliderComponent"),B.ToggleComponent=Rre,ht(Rre,"cc.ToggleComponent"),B.ToggleContainerComponent=ese,ht(ese,"cc.ToggleContainerComponent"),B.WidgetComponent=Ase,ht(Ase,"cc.WidgetComponent"),B.PageViewComponent=eae,ht(eae,"cc.PageViewComponent"),B.PageViewIndicatorComponent=Kse,ht(Kse,"cc.PageViewIndicatorComponent"),B.SafeAreaComponent=Cae,ht(Cae,"cc.SafeAreaComponent"),ht(xae,"cc.UICoordinateTrackerComponent"),B.BlockInputEventsComponent=Dae,ht(Dae,"cc.BlockInputEventsComponent"),pe(sz.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),ve(sz.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"},{name:"setRealPixelResolution"}]);var Uae=e("VideoClip",Hs("cc.VideoClip")((Fae=function(e){h(i,e);var t=v(i);function i(){var e;return n(this,i),(e=t.call(this))._duration=Gae&&Gae(),e._video=null,e}return s(i,[{key:"_nativeAsset",get:function(){return this._video},set:function(e){this._video=e,this._duration=e?e.duration:0}}]),i}(ed),Gae=Ms(Fae.prototype,"_duration",[Js],(function(){return 0})),Nae=Fae))||Nae),Hae=M.document;function zae(e,t,i){var n=Hae.createElement("video"),r=Hae.createElement("source");n.appendChild(r);var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="blob",s.onload=function(){200===this.status||0===this.status?(r.src=URL.createObjectURL(this.response),i(null,n)):i(new Error("".concat(s.status,"(no response)")))},s.onerror=function(){var t="load video failure - ".concat(e);K(t),i(new Error(t))},s.send()}function Wae(e,t,i,n){var r=new Uae;r._nativeUrl=e,r._nativeAsset=t,n(null,r)}hS.register({".mp4":zae,".avi":zae,".mov":zae,".mpg":zae,".mpeg":zae,".rm":zae,".rmvb":zae}),AS.register({".mp4":Wae,".avi":Wae,".mov":Wae,".mpg":Wae,".mpeg":Wae,".rm":Wae,".rmvb":Wae});var Xae,jae,qae=wt({REMOTE:0,LOCAL:1});!function(e){e.NONE="none",e.PLAYING="playing",e.PAUSED="paused",e.STOPPED="stopped",e.COMPLETED="completed",e.META_LOADED="meta-loaded",e.READY_TO_PLAY="ready-to-play",e.ERROR="error",e.CLICKED="clicked"}(Xae||(Xae={})),function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(jae||(jae={}));var Yae=function(){function e(t){var i=this;n(this,e),this._componentEventList=new Map,this._state=Xae.NONE,this._video=null,this._onInterruptedBegin=void 0,this._onInterruptedEnd=void 0,this._interrupted=!1,this._loaded=!1,this._loadedMeta=!1,this._ignorePause=!1,this._fullScreenOnAwake=!1,this._visible=!0,this._playing=!1,this._cachedCurrentTime=-1,this._waitingFullscreen=!1,this._waitingPlay=!1,this._keepAspectRatio=!1,this._component=null,this._uiTrans=null,this._node=null,this._stayOnBottom=!1,this._dirty=!1,this._forceUpdate=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(nV),this._onInterruptedBegin=function(){i.video&&i._state===Xae.PLAYING&&(i.video.pause(),i._interrupted=!0)},this._onInterruptedEnd=function(){i._interrupted&&i.video&&(i.video.play(),i._interrupted=!1)},B.game.on(B.Game.EVENT_PAUSE,this._onInterruptedBegin),B.game.on(B.Game.EVENT_RESUME,this._onInterruptedEnd)}return s(e,[{key:"fullScreenOnAwake",get:function(){return this._fullScreenOnAwake}},{key:"loaded",get:function(){return this._loaded}},{key:"componentEventList",get:function(){return this._componentEventList}},{key:"video",get:function(){return this._video}},{key:"state",get:function(){return this._state}},{key:"isPlaying",get:function(){return this._playing}},{key:"UICamera",get:function(){return DN.root.batcher2D.getFirstRenderCamera(this._node)}},{key:"onLoadedMetadata",value:function(e){this._loadedMeta=!0,this._forceUpdate=!0,this._visible?this.enable():this.disable(),this.dispatchEvent(Xae.META_LOADED);var t=e.target;this._keepAspectRatio&&t&&this.syncUITransform(t.videoWidth,t.videoHeight),this.delayedFullScreen(),this.delayedPlay()}},{key:"onCanPlay",value:function(){this._loaded=!0,this.dispatchEvent(Xae.READY_TO_PLAY)}},{key:"onPlay",value:function(){this._playing=!0,this.dispatchEvent(Xae.PLAYING)}},{key:"onPlaying",value:function(){this.dispatchEvent(Xae.PLAYING)}},{key:"onPause",value:function(){this._ignorePause?this._ignorePause=!1:(this._playing=!1,this.dispatchEvent(Xae.PAUSED))}},{key:"onStoped",value:function(){this._playing=!1,this._ignorePause=!1,this.dispatchEvent(Xae.STOPPED)}},{key:"onEnded",value:function(){this.dispatchEvent(Xae.COMPLETED)}},{key:"onClick",value:function(){this.dispatchEvent(Xae.CLICKED)}},{key:"onError",value:function(e){this.dispatchEvent(Xae.ERROR);var t=e.target;t&&t.error&&J("Error ".concat(t.error.code,"; details: ").concat(t.error.message))}},{key:"play",value:function(){this._loadedMeta||this._loaded?this.canPlay():this._waitingPlay=!0}},{key:"delayedPlay",value:function(){this._waitingPlay&&(this.canPlay(),this._waitingPlay=!1)}},{key:"syncFullScreenOnAwake",value:function(e){this._fullScreenOnAwake=e,this._loadedMeta||this._loaded?this.canFullScreen(e):this._waitingFullscreen=!0}},{key:"delayedFullScreen",value:function(){this._waitingFullscreen&&(this.canFullScreen(this._fullScreenOnAwake),this._waitingFullscreen=!1)}},{key:"dispatchEvent",value:function(e){var t=this._componentEventList.get(e);t&&(this._state=e,t.call(this))}},{key:"syncUITransform",value:function(e,t){this._uiTrans&&(this._uiTrans.width=e,this._uiTrans.height=t)}},{key:"syncCurrentTime",value:function(){this.video&&-1!==this._cachedCurrentTime&&this.video.currentTime!==this._cachedCurrentTime&&(this.seekTo(this._cachedCurrentTime),this._cachedCurrentTime=-1)}},{key:"destroy",value:function(){this.removeVideoPlayer(),this._componentEventList.clear(),B.game.off(B.Game.EVENT_PAUSE,this._onInterruptedBegin),B.game.off(B.Game.EVENT_RESUME,this._onInterruptedEnd)}}]),e}();B.internal.VideoPlayerImpl=Yae;var Kae,Qae,Jae,Zae,$ae,eoe,toe,ioe,noe,roe,soe,aoe,ooe,uoe,hoe,loe,coe,_oe,foe,doe,moe,poe,voe=M.document,yoe=-Math.pow(2,15),goe=wn(),Soe=function(e){h(i,e);var t=v(i);function i(e){var r;return n(this,i),(r=t.call(this,e))._eventList=new Map,r._clearColorA=-1,r._clearFlag=void 0,r}return s(i,[{key:"addListener",value:function(e,t){this._video&&(this._eventList.set(e,t),this._video.addEventListener(e,t))}},{key:"removeAllListeners",value:function(){var e=this;this._eventList.forEach((function(t,i){e._video&&e._video.removeEventListener(i,t)})),this._eventList.clear()}},{key:"canPlay",value:function(){var e=this;if(this.video){var t=this.video.play();M.Promise&&t instanceof Promise&&t.catch((function(){})).then((function(){e.syncCurrentTime()}))}}},{key:"pause",value:function(){this.video&&(this.video.pause(),this._cachedCurrentTime=this.video.currentTime)}},{key:"resume",value:function(){this.play()}},{key:"stop",value:function(){var e=this;this.video&&(this._ignorePause=!0,this.video.currentTime=0,this.video.pause(),this._cachedCurrentTime=0,setTimeout((function(){e._ignorePause=!1,e.dispatchEvent(Xae.STOPPED)}),0))}},{key:"syncClip",value:function(e){this.removeVideoPlayer(),e&&this.createVideoPlayer(e.nativeUrl)}},{key:"syncURL",value:function(e){this.removeVideoPlayer(),e&&this.createVideoPlayer(e)}},{key:"syncPlaybackRate",value:function(e){Sl.browserType!==zh.UC?this.video&&(this.video.playbackRate=e):Q("playbackRate is not supported by the uc mobile browser.")}},{key:"syncVolume",value:function(e){this.video&&(this.video.volume=e)}},{key:"syncMute",value:function(e){this.video&&(this.video.muted=e)}},{key:"syncLoop",value:function(e){this.video&&(this.video.loop=e)}},{key:"getDuration",value:function(){return this.video?this.video.duration:0}},{key:"getCurrentTime",value:function(){return this.video?this.video.currentTime:-1}},{key:"seekTo",value:function(e){this.video&&(this.video.currentTime=e)}},{key:"canFullScreen",value:function(e){var t=this,i=this._video;if(i&&i.readyState===jae.HAVE_ENOUGH_DATA)return Sl.os===jh.IOS&&Sl.isBrowser?(e?i.webkitEnterFullscreen&&i.webkitEnterFullscreen():i.webkitExitFullscreen&&i.webkitExitFullscreen(),void(this._fullScreenOnAwake=i.webkitDisplayingFullscreen)):gl.supportsFullScreen?void(e?(Sl.browserType===zh.IE&&(i.style.transform=""),i.setAttribute("x5-video-player-fullscreen","true"),gl.requestFullScreen(i,(function(e){var n=Sl.browserType===zh.IE?e.msFullscreenElement:e.fullscreenElement;t._fullScreenOnAwake=n===i}),(function(){t._fullScreenOnAwake=!1}))):(i.removeAttribute("x5-video-player-fullscreen"),gl.exitFullScreen())):(this._fullScreenOnAwake=e,this._forceUpdate=!0,void this.syncMatrix())}},{key:"syncStayOnBottom",value:function(e){this._video&&(this._video.style["z-index"]=e?yoe:0,this._stayOnBottom=e),this._dirty=!0}},{key:"syncKeepAspectRatio",value:function(e){this._keepAspectRatio=e,e&&this._loadedMeta&&this._video&&this.syncUITransform(this._video.videoWidth,this._video.videoHeight)}},{key:"removeVideoPlayer",value:function(){var e=this._video;e&&Wt(UN.container,e)&&(UN.container.removeChild(e),this.removeAllListeners()),this._cachedCurrentTime=0,this._playing=!1,this._loaded=!1,this._loadedMeta=!1,this._video=null}},{key:"createVideoPlayer",value:function(e){var t=this._video=voe.createElement("video");t.className="cocosVideo",t.style.visibility="hidden",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style["transform-origin"]="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",t.setAttribute("preload","auto"),t.setAttribute("webkit-playsinline",""),t.setAttribute("x5-playsinline",""),t.setAttribute("playsinline",""),this._bindDomEvent(),UN.container.appendChild(t);var i=voe.createElement("source");t.appendChild(i),i.src=e}},{key:"_bindDomEvent",value:function(){this._video,this.addListener("loadedmetadata",this.onLoadedMetadata.bind(this)),this.addListener("canplay",this.onCanPlay.bind(this)),this.addListener("canplaythrough",this.onCanPlay.bind(this)),this.addListener("play",this.onPlay.bind(this)),this.addListener("playing",this.onPlaying.bind(this)),this.addListener("pause",this.onPause.bind(this)),this.addListener("click",this.onClick.bind(this)),this.addListener("ended",this.onEnded.bind(this)),this.addListener("error",this.onError.bind(this))}},{key:"onCanPlay",value:function(e){var t=e.target;if(!this._loaded||!t)switch(t.readyState){case jae.HAVE_METADATA:case jae.HAVE_ENOUGH_DATA:g(l(i.prototype),"onCanPlay",this).call(this,e)}}},{key:"enable",value:function(){if(this._video){if(this._visible=!0,"visible"===this._video.style.visibility)return;this._video.style.visibility="visible"}}},{key:"disable",value:function(e){if(this._video){if(!e&&this._playing&&this._video.pause(),this._visible=!1,"hidden"===this._video.style.visibility)return;this._video.style.visibility="hidden"}}},{key:"syncMatrix",value:function(){if(this._video&&this._visible&&this._component){var e=this.UICamera;if(e&&!gl.fullScreen()){this._dirty&&(this._dirty=!1,this._stayOnBottom?(this._clearColorA=e.clearColor.w,this._clearFlag=e.clearFlag,e.clearColor.w=0,e.clearFlag=yc.ALL):this._clearFlag&&(e.clearColor.w=this._clearColorA,e.clearFlag=this._clearFlag,this._clearColorA=-1,this._clearFlag=null)),this._component.node.getWorldMatrix(goe),e.update(!0),e.worldMatrixToScreen(goe,goe,UN.canvas.width,UN.canvas.height);var t=0,i=0;if(this._fullScreenOnAwake?(t=Al.width,i=Al.height):(t=this._uiTrans.contentSize.width,i=this._uiTrans.contentSize.height),this._forceUpdate||this._m00!==goe.m00||this._m01!==goe.m01||this._m04!==goe.m04||this._m05!==goe.m05||this._m12!==goe.m12||this._m13!==goe.m13||this._w!==t||this._h!==i){this._m00=goe.m00,this._m01=goe.m01,this._m04=goe.m04,this._m05=goe.m05,this._m12=goe.m12,this._m13=goe.m13,this._w=t,this._h=i;var n=vl.devicePixelRatio,r=1/n,s=1/n,a=UN.container,o=goe.m00*r,u=goe.m01,h=goe.m04,l=goe.m05*s;this._video.style.width="".concat(this._w,"px"),this._video.style.height="".concat(this._h,"px"),Sl.browserType!==zh.MOBILE_QQ?this._video.style.objectFit=this._keepAspectRatio?"none":"fill":Q("keepAspectRatio is not supported by the qq mobile browser.");var c=this._w*r,_=this._h*s,f=this._uiTrans.anchorPoint,d=f.x,m=f.y,p=c*goe.m00*d,v=_*goe.m05*m,y=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,g=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0,S=goe.m12*r-p+y,A=goe.m13*s-v+g,T="matrix(".concat(o,",").concat(-u,",").concat(-h,",").concat(l,",").concat(S,",").concat(-A,")");this._video.style.transform=T,this._video.style["-webkit-transform"]=T,Sl.browserType!==zh.IE&&(this._forceUpdate=!1)}}}}}]),i}(Yae),Aoe=function(){function e(){n(this,e)}return s(e,null,[{key:"getImpl",value:function(e){return new Soe(e)}}]),e}();B.internal.VideoPlayerImplManager=Aoe;var Toe,Eoe=e("VideoPlayer",(Kae=Hs("cc.VideoPlayer"),Qae=zs(nV),Jae=Aa(Uae),Zae=Aa(qae),$ae=Aa(Uae),eoe=Aa([Zd]),Kae(toe=Qae((poe=moe=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._resourceType=noe&&noe(),e._remoteURL=roe&&roe(),e._clip=soe&&soe(),e._playOnAwake=aoe&&aoe(),e._volume=ooe&&ooe(),e._mute=uoe&&uoe(),e._playbackRate=hoe&&hoe(),e._loop=loe&&loe(),e._fullScreenOnAwake=coe&&coe(),e._stayOnBottom=_oe&&_oe(),e._keepAspectRatio=foe&&foe(),e._impl=null,e._cachedCurrentTime=0,e.videoPlayerEvent=doe&&doe(),e}return s(i,[{key:"resourceType",get:function(){return this._resourceType},set:function(e){this._resourceType!==e&&(this._resourceType=e,this.syncSource())}},{key:"remoteURL",get:function(){return this._remoteURL},set:function(e){this._remoteURL!==e&&(this._remoteURL=e,this.syncSource())}},{key:"clip",get:function(){return this._clip},set:function(e){this._clip!==e&&(this._clip=e,this.syncSource())}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"playbackRate",get:function(){return this._playbackRate},set:function(e){this._playbackRate=e,this._impl&&this._impl.syncPlaybackRate(e)}},{key:"volume",get:function(){return this._volume},set:function(e){this._volume=e,this._impl&&this._impl.syncVolume(e)}},{key:"mute",get:function(){return this._mute},set:function(e){this._mute=e,this._impl&&this._impl.syncMute(e)}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._impl&&this._impl.syncLoop(e)}},{key:"keepAspectRatio",get:function(){return this._keepAspectRatio},set:function(e){this._keepAspectRatio!==e&&(this._keepAspectRatio=e,this._impl&&this._impl.syncKeepAspectRatio(e))}},{key:"fullScreenOnAwake",get:function(){return this._impl?(this._fullScreenOnAwake=this._impl.fullScreenOnAwake,this._fullScreenOnAwake):this._fullScreenOnAwake},set:function(e){this._fullScreenOnAwake!==e&&(this._fullScreenOnAwake=e,this._impl&&this._impl.syncFullScreenOnAwake(e))}},{key:"stayOnBottom",get:function(){return this._stayOnBottom},set:function(e){this._stayOnBottom!==e&&(this._stayOnBottom=e,this._impl&&this._impl.syncStayOnBottom(e))}},{key:"nativeVideo",get:function(){return this._impl&&this._impl.video||null}},{key:"currentTime",get:function(){return this._impl?this._impl.getCurrentTime():this._cachedCurrentTime},set:function(e){Number.isNaN(e)?Q("illegal video time! value:".concat(e)):(e=Li(e,0,this.duration),this._cachedCurrentTime=e,this._impl&&this._impl.seekTo(e))}},{key:"duration",get:function(){return this._impl?this._impl.getDuration():0}},{key:"state",get:function(){return this._impl?this._impl.state:Xae.NONE}},{key:"isPlaying",get:function(){return!!this._impl&&this._impl.isPlaying}},{key:"syncSource",value:function(){this._impl&&(this._resourceType===qae.REMOTE?this._impl.syncURL(this._remoteURL):this._impl.syncClip(this._clip))}},{key:"__preload",value:function(){this._impl=Aoe.getImpl(this),this.syncSource(),this._impl.syncLoop(this._loop),this._impl.syncVolume(this._volume),this._impl.syncMute(this._mute),this._impl.seekTo(this._cachedCurrentTime),this._impl.syncPlaybackRate(this._playbackRate),this._impl.syncStayOnBottom(this._stayOnBottom),this._impl.syncKeepAspectRatio(this._keepAspectRatio),this._impl.syncFullScreenOnAwake(this._fullScreenOnAwake),this._impl.componentEventList.set(Xae.META_LOADED,this.onMetaLoaded.bind(this)),this._impl.componentEventList.set(Xae.READY_TO_PLAY,this.onReadyToPlay.bind(this)),this._impl.componentEventList.set(Xae.PLAYING,this.onPlaying.bind(this)),this._impl.componentEventList.set(Xae.PAUSED,this.onPaused.bind(this)),this._impl.componentEventList.set(Xae.STOPPED,this.onStopped.bind(this)),this._impl.componentEventList.set(Xae.COMPLETED,this.onCompleted.bind(this)),this._impl.componentEventList.set(Xae.ERROR,this.onError.bind(this)),this._impl.componentEventList.set(Xae.CLICKED,this.onClicked.bind(this)),this._playOnAwake&&this._impl.loaded&&this.play()}},{key:"onEnable",value:function(){this._impl&&this._impl.enable()}},{key:"onDisable",value:function(){this._impl&&this._impl.disable()}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(){this._impl&&this._impl.syncMatrix()}},{key:"onMetaLoaded",value:function(){Zd.emitEvents(this.videoPlayerEvent,this,Xae.META_LOADED),this.node.emit("meta-loaded",this)}},{key:"onReadyToPlay",value:function(){this._playOnAwake&&!this.isPlaying&&this.play(),Zd.emitEvents(this.videoPlayerEvent,this,Xae.READY_TO_PLAY),this.node.emit(Xae.READY_TO_PLAY,this)}},{key:"onPlaying",value:function(){Zd.emitEvents(this.videoPlayerEvent,this,Xae.PLAYING),this.node.emit(Xae.PLAYING,this)}},{key:"onPaused",value:function(){Zd.emitEvents(this.videoPlayerEvent,this,Xae.PAUSED),this.node.emit(Xae.PAUSED,this)}},{key:"onStopped",value:function(){Zd.emitEvents(this.videoPlayerEvent,this,Xae.STOPPED),this.node.emit(Xae.STOPPED,this)}},{key:"onCompleted",value:function(){Zd.emitEvents(this.videoPlayerEvent,this,Xae.COMPLETED),this.node.emit(Xae.COMPLETED,this)}},{key:"onError",value:function(){Zd.emitEvents(this.videoPlayerEvent,this,Xae.ERROR),this.node.emit(Xae.ERROR,this)}},{key:"onClicked",value:function(){Zd.emitEvents(this.videoPlayerEvent,this,Xae.CLICKED),this.node.emit(Xae.CLICKED,this)}},{key:"play",value:function(){this._impl&&this._impl.play()}},{key:"resume",value:function(){this._impl&&this._impl.resume()}},{key:"pause",value:function(){this._impl&&this._impl.pause()}},{key:"stop",value:function(){this._impl&&this._impl.stop()}}]),i}(tm),moe.EventType=Xae,moe.ResourceType=qae,noe=Ms((ioe=poe).prototype,"_resourceType",[Js],(function(){return qae.LOCAL})),roe=Ms(ioe.prototype,"_remoteURL",[Js],(function(){return""})),soe=Ms(ioe.prototype,"_clip",[Jae,Js],(function(){return null})),aoe=Ms(ioe.prototype,"_playOnAwake",[Js],(function(){return!0})),ooe=Ms(ioe.prototype,"_volume",[Js],(function(){return 1})),uoe=Ms(ioe.prototype,"_mute",[Js],(function(){return!1})),hoe=Ms(ioe.prototype,"_playbackRate",[Js],(function(){return 1})),loe=Ms(ioe.prototype,"_loop",[Js],(function(){return!1})),coe=Ms(ioe.prototype,"_fullScreenOnAwake",[Js],(function(){return!1})),_oe=Ms(ioe.prototype,"_stayOnBottom",[Js],(function(){return!1})),foe=Ms(ioe.prototype,"_keepAspectRatio",[Js],(function(){return!0})),x(ioe.prototype,"resourceType",[Zae],Object.getOwnPropertyDescriptor(ioe.prototype,"resourceType"),ioe.prototype),x(ioe.prototype,"clip",[$ae],Object.getOwnPropertyDescriptor(ioe.prototype,"clip"),ioe.prototype),doe=Ms(ioe.prototype,"videoPlayerEvent",[Js,eoe],(function(){return[]})),toe=ioe))||toe)||toe));B.internal.VideoPlayer=Eoe,me(Eoe.prototype,"VideoPlayer.prototype",[{name:"onPasued",newName:"onPaused"}]),function(e){e.NONE="none",e.LOADING="loading",e.LOADED="loaded",e.ERROR="error"}(Toe||(Toe={}));var boe=function(){function e(t){n(this,e),this._componentEventList=new Map,this._state=Toe.NONE,this._wrapper=void 0,this._webview=null,this._loaded=!1,this._forceUpdate=!1,this._component=null,this._uiTrans=null,this._node=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(nV),this.reset(),this.createWebView()}return s(e,[{key:"reset",value:function(){this._wrapper=null,this._webview=null,this._loaded=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._state=Toe.NONE,this._forceUpdate=!1}},{key:"loaded",get:function(){return this._loaded}},{key:"componentEventList",get:function(){return this._componentEventList}},{key:"webview",get:function(){return this._webview}},{key:"state",get:function(){return this._state}},{key:"UICamera",get:function(){return DN.root.batcher2D.getFirstRenderCamera(this._node)}},{key:"dispatchEvent",value:function(e){var t=this._componentEventList.get(e);if(t){this._state=e;for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t.call(this,n)}}},{key:"destroy",value:function(){this.removeWebView(),this._wrapper=null,this._webview=null,this._loaded=!1,this._component=null,this._uiTrans=null,this._forceUpdate=!1,this._componentEventList.clear()}}]),e}();B.internal.WebViewImpl=boe;var Coe,Roe,xoe,woe,koe,Ioe,Boe,Poe,Moe,Ooe=M.document,Doe=wn(),Loe=function(e){h(i,e);var t=v(i);function i(e){return n(this,i),t.call(this,e)}return s(i,[{key:"_bindDomEvent",value:function(){var e=this;this.webview&&this.webview.addEventListener("load",(function(t){e._forceUpdate=!0,e.dispatchEvent(Toe.LOADED);var i=t.target,n=i.contentDocument&&i.contentDocument.body;n&&n.innerHTML.includes("404")&&e.dispatchEvent(Toe.ERROR,n.innerHTML)}))}},{key:"loadURL",value:function(e){this.webview&&(this.webview.src=e,this.dispatchEvent(Toe.LOADING))}},{key:"createWebView",value:function(){var e=Ooe.createElement("div");this._wrapper=e,e.id="webview-wrapper",e.style["-webkit-overflow"]="auto",e.style["-webkit-overflow-scrolling"]="touch",e.style.position="absolute",e.style.bottom="0px",e.style.left="0px",e.style.transformOrigin="0px 100% 0px",e.style["-webkit-transform-origin"]="0px 100% 0px",UN.container.appendChild(e);var t=Ooe.createElement("iframe");this._webview=t,t.id="webview",t.style.border="none",t.style.width="100%",t.style.height="100%",e.appendChild(t),this._bindDomEvent()}},{key:"removeWebView",value:function(){var e=this._wrapper;Wt(UN.container,e)&&UN.container.removeChild(e),this.reset()}},{key:"enable",value:function(){this._wrapper&&(this._wrapper.style.visibility="visible")}},{key:"disable",value:function(){this._wrapper&&(this._wrapper.style.visibility="hidden")}},{key:"evaluateJS",value:function(e){if(this.webview){var t=this.webview.contentWindow;if(t)try{t.eval(e)}catch(e){this.dispatchEvent(Toe.ERROR,e),J(e)}}}},{key:"setOnJSCallback",value:function(){Q("The platform does not support")}},{key:"setJavascriptInterfaceScheme",value:function(){Q("The platform does not support")}},{key:"syncMatrix",value:function(){if(this._wrapper&&this._uiTrans&&this._component&&"hidden"!==this._wrapper.style.visibility){var e=this.UICamera;if(e){this._component.node.getWorldMatrix(Doe),e.update(!0),e.worldMatrixToScreen(Doe,Doe,UN.canvas.width,UN.canvas.height);var t=this._uiTrans.contentSize,i=t.width,n=t.height;if(this._forceUpdate||this._m00!==Doe.m00||this._m01!==Doe.m01||this._m04!==Doe.m04||this._m05!==Doe.m05||this._m12!==Doe.m12||this._m13!==Doe.m13||this._w!==i||this._h!==n){this._m00=Doe.m00,this._m01=Doe.m01,this._m04=Doe.m04,this._m05=Doe.m05,this._m12=Doe.m12,this._m13=Doe.m13,this._w=i,this._h=n;var r=vl.devicePixelRatio,s=1/r,a=1/r,o=UN.container,u=Doe.m00*s,h=Doe.m01,l=Doe.m04,c=Doe.m05*a;this._wrapper.style.width="".concat(i,"px"),this._wrapper.style.height="".concat(n,"px");var _=this._w*s,f=this._h*a,d=_*Doe.m00*this._uiTrans.anchorX,m=f*Doe.m05*this._uiTrans.anchorY,p=o&&o.style.paddingLeft?parseInt(o.style.paddingLeft):0,v=o&&o.style.paddingBottom?parseInt(o.style.paddingBottom):0,y=Doe.m12*s-d+p,g=Doe.m13*a-m+v,S="matrix(".concat(u,",").concat(-h,",").concat(-l,",").concat(c,",").concat(y,",").concat(-g,")");this._wrapper.style.transform=S,this._wrapper.style["-webkit-transform"]=S,this._forceUpdate=!1}}}}}]),i}(boe),Noe=function(){function e(){n(this,e)}return s(e,null,[{key:"getImpl",value:function(e){return new Loe(e)}}]),e}();B.internal.WebViewImplManager=Noe;var Foe=e("WebView",(Coe=Hs("cc.WebView"),Roe=zs(nV),xoe=Aa([Zd]),Coe(woe=Roe((Moe=Poe=function(e){h(i,e);var t=v(i);function i(){var e;n(this,i);for(var r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s)))._url=Ioe&&Ioe(),e._impl=null,e.webviewEvents=Boe&&Boe(),e}return s(i,[{key:"url",get:function(){return this._url},set:function(e){this._url=e,this._impl&&this._impl.loadURL(e)}},{key:"nativeWebView",get:function(){return this._impl&&this._impl.webview||null}},{key:"state",get:function(){return this._impl?this._impl.state:Toe.NONE}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"__preload",value:function(){this._impl=Noe.getImpl(this),this._impl.componentEventList.set(Toe.LOADING,this.onLoading.bind(this)),this._impl.componentEventList.set(Toe.LOADED,this.onLoaded.bind(this)),this._impl.componentEventList.set(Toe.ERROR,this.onError.bind(this)),this._impl.loadURL(this._url)}},{key:"onLoading",value:function(){Zd.emitEvents(this.webviewEvents,this,Toe.LOADING),this.node.emit(Toe.LOADING,this)}},{key:"onLoaded",value:function(){Zd.emitEvents(this.webviewEvents,this,Toe.LOADED),this.node.emit(Toe.LOADED,this)}},{key:"onError",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];Zd.emitEvents(this.webviewEvents,this,Toe.ERROR,t),this.node.emit(Toe.ERROR,this,t)}},{key:"onEnable",value:function(){this._impl&&this._impl.enable()}},{key:"onDisable",value:function(){this._impl&&this._impl.disable()}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(){this._impl&&this._impl.syncMatrix()}}]),i}(tm),Poe.EventType=Toe,Ioe=Ms((koe=Moe).prototype,"_url",[Js],(function(){return"https://cocos.com"})),Boe=Ms(koe.prototype,"webviewEvents",[Js,xoe],(function(){return[]})),woe=koe))||woe)||woe));B.internal.WebView=Foe}}}));
